<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- ALL CSS FROM PREVIOUS CORRECT RESPONSE GOES HERE --- */
        /* --- (Including original dashboard CSS + Employee Schedule CSS) --- */
        :root { --primary: #2563eb; /* ... باقي الستايلات ... */ }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        /* ... (كل الـ CSS الذي تم تقديمه في الرد السابق يجب وضعه هنا) ... */

        /* --- تأكيد إخفاء الأقسام غير النشطة --- */
        .content-section { display: none; } /* Hidden by default */
        .content-section.active { display: block; } /* Shown when active */
        #featureSectionsContainer { display: none; } /* Dynamic container hidden by default */

    </style>
</head>
<body class="blue-theme">
    <audio id="notificationSound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg"></audio>
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i><span id="successMessageText">Action successful!</span></div>
    <aside class="sidebar" id="sidebar">
        <!-- Sidebar Content -->
        <div class="sidebar-header"><div class="logo"><i class="fas fa-users-cog logo-icon"></i><span>TeamFlow</span></div></div>
        <div class="sidebar-menu">
            <div class="menu-title">Navigation</div>
            <!-- **** استخدم data-feature لتحديد القسم **** -->
            <a href="#" class="menu-item active" data-feature="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
            <a href="#" class="menu-item" data-feature="projects"><i class="fas fa-briefcase"></i><span>Projects</span></a>
            <a href="#" class="menu-item" data-feature="reports-analytics"><i class="fas fa-chart-line"></i><span>Reports & Analytics</span></a>
            <a href="#" class="menu-item" data-feature="team-members-view"><i class="fas fa-users"></i><span>Team Members</span></a>
            <div class="menu-title">Core Features</div>
            <a href="#" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
            <a href="#" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
            <a href="#" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
            <a href="#" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
            <div class="menu-title">Team Tools</div>
            <a href="#" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
            <a href="#" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
            <a href="#" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
            <a href="#" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
            <div class="menu-divider"></div>
            <!-- **** رابط الإعدادات والبروفايل يمكن أن يكونا data-feature أيضاً **** -->
            <a href="#" class="menu-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
            <a href="#" class="menu-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile (from Sidebar)</span></a>
        </div>
        <div class="connection-status"><div class="status-dot"></div><span>Online</span></div>
    </aside>
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav">
             <div class="search-bar"><i class="fas fa-search search-icon"></i><input type="text" placeholder="Search..." id="searchInput" autocomplete="off"><div class="search-results" id="searchResults"></div></div>
             <div class="user-menu"><div class="notification-icon" id="notificationIcon"><i class="fas fa-bell"></i><span class="notification-badge" style="display: none;">0</span></div><div class="user-profile"><div class="user-avatar" id="userAvatar">ME</div><div class="user-profile-details"><span class="user-name" id="userName">Mohamed Elmenisy</span><span class="user-status"> • Connected</span></div><div class="user-dropdown" id="userDropdown"><a href="#" class="dropdown-item" id="profileLink"><i class="fas fa-user"></i><span>Profile</span></a><a href="#" class="dropdown-item" id="settingsLink"><i class="fas fa-cog"></i><span>Settings</span></a><a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></div></div></div>
        </nav>
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- STATIC SECTIONS -->
            <div id="dashboardContent" class="content-section active"> <!-- يبدأ الداشبورد فعالاً -->
                 <!-- Dashboard content here -->
                 <div class="welcome-section"> <h2 class="welcome-title">Welcome, <span id="welcomeName">Mohamed</span>!</h2> <p class="welcome-subtitle">Here's what's happening with your team today.</p> <div class="user-info"> <div class="user-info-avatar" id="profileAvatar">ME</div> <div class="user-info-details"> <div class="user-info-name">Mohamed Elmenisy</div> <div class="user-info-title" id="userInfoRoleTitle">Administrator</div> <div class="user-info-email"> <i class="fas fa-envelope"></i> <span id="userEmail">m.elsayed@thechefz.co</span> </div> </div> </div> </div> <div class="stats-section"> <!-- Stats Cards --> </div> <div class="activity-section"> <!-- Activity List --> </div>
            </div>
            <div class="content-section" id="profileContent">
                <!-- Profile content here -->
                 <div class="section-main-header"><h2 class="section-main-title">Profile</h2></div> <!-- ... rest of profile form ... -->
            </div>
            <div class="content-section" id="settingsContent">
                 <!-- Settings content with tabs and panels here -->
                 <div class="section-main-header"><h2 class="section-main-title">System Settings</h2></div> <!-- ... rest of settings ... -->
            </div>

            <!-- CONTAINER FOR DYNAMICALLY LOADED FEATURES -->
            <div id="featureSectionsContainer" style="/* display: none; by default */">
                <div id="featureSections">
                    <!-- Placeholder shown during loading/error -->
                     <div class="placeholder-content content-section" id="featurePlaceholder">
                        <h2 id="featureTitle">Feature Content Area</h2>
                        <p id="featureDescription">Select a feature from the sidebar.</p>
                        <div class="loading-indicator" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div class="error-message" style="display: none;">Failed to load content.</div>
                    </div>
                    <!-- Dynamically loaded HTML content will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modals (Notifications, Confirm) -->
    <div class="notifications-modal" id="notificationsModal"> <!-- ... modal content ... --> </div>
    <div class="confirm-modal" id="confirmModal"> <!-- ... modal content ... --> </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item'); // Select all menu items
            const staticContentSections = document.querySelectorAll('.main-content > .content-area > .content-section'); // Static sections like dashboard, profile, settings
            const featureSectionsContainer = document.getElementById('featureSectionsContainer'); // Container for dynamic loads
            const featureSections = document.getElementById('featureSections'); // Where dynamic HTML is injected
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorMessage = featurePlaceholder.querySelector('.error-message');
            const backButton = document.getElementById('backButton');
            // ... (other DOM element selections remain the same) ...
            const profileLink = document.getElementById('profileLink'); // Link from dropdown
            const settingsLink = document.getElementById('settingsLink'); // Link from dropdown
            const logoutLink = document.getElementById('logoutLink');
            // ... (rest of the DOM elements)

            // --- State Variables ---
            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
            let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences'; let activityIntervalId = null;
            let confirmCallback = null; let cancelCallback = null;

            // --- Constants ---
             const MAX_ACTIVITIES_DISPLAYED = 5; const UPDATE_INTERVAL = 60000; const SIMULATED_DELAY = 500; // Reduced delay for testing
             const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500;
             const DEFAULT_USER = { /* ... (same as before) ... */ };

            // --- Initialization ---
            function initDashboard() { loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); handleInitialNavigation(); startActivityTimeUpdater(); setupEventListeners(); console.log("Dashboard Initialized."); }

            // --- Data Handling (LocalStorage) ---
            function loadData() { /* ... (same as before, loads user, team, activities, notifications) ... */
                const storedUser = JSON.parse(localStorage.getItem('currentUser')); currentUser = { ...DEFAULT_USER, ...storedUser }; currentUser.preferences = { ...DEFAULT_USER.preferences, ...(storedUser?.preferences || {}) }; currentUser.notificationPreferences = { ...DEFAULT_USER.notificationPreferences, ...(storedUser?.notificationPreferences || {}) }; currentUser.notificationPreferences.email = { ...DEFAULT_USER.notificationPreferences.email, ...(storedUser?.notificationPreferences?.email || {}) }; currentUser.notificationPreferences.push = { ...DEFAULT_USER.notificationPreferences.push, ...(storedUser?.notificationPreferences?.push || {}) }; currentUser.security = { ...DEFAULT_USER.security, ...(storedUser?.security || {}) }; currentUser.stats = { ...DEFAULT_USER.stats, ...(storedUser?.stats || {}) };
                teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [ { id: 1, name: 'Mohamed Elmenisy', email: 'mohamed@example.com', role: 'admin', initials: 'ME' }, { id: 2, name: 'Yousef', email: 'yousef@example.com', role: 'member', initials: 'YO' }, { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'member', initials: 'EL' }, { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'member', initials: 'BB' } ]; teamMembers.forEach((member, index) => { if (!member.id) member.id = index + 5; if (!member.initials) member.initials = (member.name || member.email || '??').substring(0,2).toUpperCase(); if (!member.role) member.role = 'member'; });
                activities = JSON.parse(localStorage.getItem('activities')) || []; notifications = JSON.parse(localStorage.getItem('notifications')) || [];
             }
            function saveData() { /* ... (same as before) ... */ }
            function clearUserData() { /* ... (same as before) ... */ }

            // --- UI Update Functions ---
            function updateUserUI() { /* ... (same as before) ... */ }
            function applyUserPreferences() { /* ... (same as before) ... */ }
            function applyRBAC() { /* ... (same as before) ... */ }
            function loadSettingsFormData() { /* ... (same as before) ... */ }
            function updateStats() { /* ... (same as before) ... */ }
            function updateTrendIndicator(element, trend) { /* ... (same as before) ... */ }
            function updateNotificationBadge() { /* ... (same as before) ... */ }

            // --- Feature/Section Loading (REVISED & SIMPLIFIED) ---
             function setActiveFeature(featureId, settingsTab = null) {
                console.log(`%c[NAV] === Activating Feature: ${featureId} ===`, "color: blue; font-weight: bold; font-size: 1.1em;");

                // --- 1. Update State ---
                currentFeature = featureId;
                currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);

                // --- 2. Update URL Hash ---
                let hash = `#${featureId}`;
                if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                if (window.location.hash !== hash) {
                    history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);
                    console.log(`%c[NAV] URL Hash updated to: ${hash}`, "color: gray;");
                }

                // --- 3. Update Sidebar Active Item ---
                menuItems.forEach(item => item.classList.remove('active'));
                const activeMenuItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`);
                if (activeMenuItem) activeMenuItem.classList.add('active');

                // --- 4. Hide ALL Content Sections ---
                // Hide static sections using explicit display style
                staticContentSections.forEach(section => {
                    // console.log(`%c[NAV] Hiding static section: #${section.id}`, "color: orange;");
                    section.style.display = 'none';
                    section.classList.remove('active'); // Also remove class if used elsewhere
                });
                // Hide the dynamic content container
                 // console.log(`%c[NAV] Hiding dynamic container: #featureSectionsContainer`, "color: orange;");
                featureSectionsContainer.style.display = 'none';
                 // Clear previous dynamic content immediately
                 featureSections.innerHTML = '';
                 console.log(`%c[NAV] All content areas hidden/cleared.`, "color: orange;");

                // --- 5. Show the Target Section / Load Dynamic Content ---
                let targetStaticElement = null;
                if (featureId === 'dashboard') targetStaticElement = document.getElementById('dashboardContent');
                else if (featureId === 'profile') targetStaticElement = document.getElementById('profileContent');
                else if (featureId === 'settings') targetStaticElement = document.getElementById('settingsContent');

                if (targetStaticElement) {
                    // --- Show Static Section ---
                    console.log(`%c[NAV] Showing static section: #${targetStaticElement.id}`, "color: green;");
                    targetStaticElement.style.display = 'block';
                    targetStaticElement.classList.add('active'); // Add class if needed for other logic/styling

                    // Refresh specific static content if needed
                    if (featureId === 'dashboard') { updateStats(); loadActivities(viewAllActivity.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); }
                    if (featureId === 'profile') { updateUserUI(); }
                    if (featureId === 'settings') { applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }

                } else {
                    // --- Load Dynamic Section ---
                    console.log(`%c[NAV] Loading dynamic feature: ${featureId}`, "color: purple;");
                    featureSectionsContainer.style.display = 'block'; // Show the container FIRST
                    featureSections.innerHTML = ''; // Ensure it's empty before placeholder
                    featureSections.appendChild(featurePlaceholder); // Add placeholder
                    featureTitle.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`;
                    featureDescription.textContent = '';
                    featureLoadingIndicator.style.display = 'block';
                    featureErrorMessage.style.display = 'none';
                    featurePlaceholder.style.display = 'flex'; // Make placeholder visible

                    const filePath = `sections/${featureId}.html`;
                    console.log(`%c[FETCH] Attempting to fetch: ${filePath}`, "color: #007acc;");

                    fetch(filePath)
                        .then(response => {
                            console.log(`%c[FETCH] Response for ${filePath}: ${response.status} ${response.statusText}`, "color: #007acc;");
                            if (!response.ok) { throw new Error(`HTTP ${response.status} - ${response.statusText} loading ${filePath}`); }
                            return response.text();
                        })
                        .then(htmlContent => {
                            console.log(`%c[FETCH] Success fetching ${featureId}. Injecting HTML (${htmlContent.length} chars).`, "color: green;");
                            featureSections.innerHTML = htmlContent; // Replace placeholder with loaded content

                            // --- Call Initializer ---
                            if (featureId === 'employee-scheduling') {
                                if (typeof initializeEmployeeSchedule === 'function') {
                                    try {
                                        console.log("%c[INIT] Calling initializeEmployeeSchedule...", "color: teal;");
                                        initializeEmployeeSchedule(
                                            JSON.parse(JSON.stringify(currentUser || DEFAULT_USER)),
                                            JSON.parse(JSON.stringify(teamMembers || []))
                                        );
                                        console.log("%c[INIT] initializeEmployeeSchedule executed.", "color: teal;");
                                    } catch (err) {
                                        console.error(`%c[INIT ERROR] initializeEmployeeSchedule failed:`, "color: red;", err);
                                        featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featureTitle.textContent = `Init Error: ${featureId}`; featureDescription.textContent = `Error: ${err.message}. Check console.`; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'block'; featurePlaceholder.style.display = 'flex';
                                    }
                                } else { console.warn(`%c[INIT WARN] initializeEmployeeSchedule not found.`, "color: orange;"); /* Show warning placeholder? */ }
                            }
                            // Add else if for other initializers
                        })
                        .catch(error => {
                            console.error(`%c[FETCH ERROR] Failed loading ${featureId}:`, "color: red;", error);
                            featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featureTitle.textContent = `Error Loading ${featureId}`; featureDescription.textContent = `Could not load: ${error.message}`; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'block'; featurePlaceholder.style.display = 'flex';
                        });
                }

                // --- 6. Show/Hide Back Button ---
                backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';

                // --- 7. Scroll to top ---
                window.scrollTo(0, 0);
                 console.log(`%c[NAV] === Feature Activation Complete: ${featureId} ===`, "color: blue; font-weight: bold;");
            }


            function activateSettingsTab(tabId) { /* ... (same as before) ... */ if (tabId === 'danger' && currentUser.role !== 'admin') { return; } currentSettingsTab = tabId; settingsTabs.forEach(t => { t.classList.remove('active'); if (!t.classList.contains('disabled') && t.dataset.tab === tabId) t.classList.add('active'); }); settingsPanels.forEach(p => p.classList.toggle('active', p.id === `${tabId}Panel`)); if (currentFeature === 'settings' && window.location.hash !== `#settings-${tabId}`) { history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`); } if (tabId === 'team') loadTeamMembers(); else if (tabId === 'account') updateUserUI(); else if (['preferences', 'security', 'notifications'].includes(tabId)) loadSettingsFormData(); }
            function handleInitialNavigation() { /* ... (same as before) ... */ const hash = window.location.hash.substring(1); let featureId = 'dashboard', settingsTab = null; if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences'; } else { const validFeature = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile'; if (validFeature) featureId = hash; } } setActiveFeature(featureId, settingsTab); }

            // --- Activity & Notification Loading ---
            function loadActivities(showAll = false) { /* ... (same as before) ... */ }
            function loadNotifications() { /* ... (same as before) ... */ }

            // --- Time Formatting ---
            function getTimeAgo(timestamp) { /* ... (same as before) ... */ }
            function updateActivityTimes() { /* ... (same as before) ... */ }
            function startActivityTimeUpdater() { /* ... (same as before) ... */ }

             // --- Team Management ---
             function loadTeamMembers() { /* ... (same as before) ... */ }

            // --- Modals ---
            function showConfirmModal(config) { /* ... (same as before) ... */ }
            function hideConfirmModal() { /* ... (same as before) ... */ }

             // --- Action Handlers ---
            function handleProfileSave(e) { /* ... (same as before) ... */ }
            function handleProfileCancel() { /* ... (same as before) ... */ }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... (same as before) ... */ }
            function handleSettingsCancel(panelId) { /* ... (same as before) ... */ }
            function handleInviteMember(e) { /* ... (same as before) ... */ }
            function handleEditMemberClick(e) { /* ... (same as before) ... */ }
            function handleDeleteMemberClick(e) { /* ... (same as before) ... */ }
            function handleDeleteActivityClick(e) { /* ... (same as before) ... */ }
            function handleDeleteAllActivities() { /* ... (same as before) ... */ }
            function markNotificationAsRead(notificationId, itemElement) { /* ... (same as before) ... */ }
            function handleMarkAllNotificationsRead() { /* ... (same as before) ... */ }
            function handleDeleteNotificationClick(notificationId) { /* ... (same as before) ... */ }
            function handleDeleteAllNotifications() { /* ... (same as before) ... */ }
            function handleAvatarUpload(e) { /* ... (same as before) ... */ }
            function handleLogout() { /* ... (same as before) ... */ }

            // --- Utility Functions ---
             function addActivity(icon, message) { /* ... (same as before) ... */ }
             function addNotification(icon, message) { /* ... (same as before) ... */ }
            function playNotificationSound() { /* ... (same as before) ... */ }
            function showSuccessMessage(message) { /* ... (same as before) ... */ }

            // --- Event Listener Setup (REVISED FOR MENU) ---
            function setupEventListeners() {
                // Sidebar Navigation (CRITICAL FOR NAVIGATION)
                sidebar.addEventListener('click', (e) => {
                    // Find the closest ancestor that is a menu item
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        const featureId = menuItem.dataset.feature;
                        if (featureId) {
                            e.preventDefault(); // Prevent default link behavior
                            console.log(`%c[EVENT] Menu item clicked: data-feature="${featureId}"`, "color: darkred;");
                            setActiveFeature(featureId);
                        } else {
                            console.log("%c[EVENT] Clicked menu item lacks data-feature.", "color: darkred;");
                        }
                    }
                });

                 // Dropdown Links (Profile & Settings)
                 profileLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     userDropdown.classList.remove('active');
                     console.log(`%c[EVENT] Profile dropdown link clicked.`, "color: darkred;");
                     setActiveFeature('profile'); // Activate the profile section
                 });
                 settingsLink.addEventListener('click', (e) => {
                     e.preventDefault();
                     userDropdown.classList.remove('active');
                     console.log(`%c[EVENT] Settings dropdown link clicked.`, "color: darkred;");
                     setActiveFeature('settings'); // Activate settings section
                 });
                 logoutLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); handleLogout(); });


                // --- Other listeners (remain the same) ---
                backButton.addEventListener('click', () => setActiveFeature('dashboard'));
                window.addEventListener('popstate', (event) => { console.log("%c[EVENT] Popstate triggered", "color: darkred;"); if (event.state) setActiveFeature(event.state.feature, event.state.tab); else handleInitialNavigation(); });
                searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch);
                document.addEventListener('click', (e) => { if (!e.target.closest('.search-bar')) { searchResults.classList.remove('active'); searchResults.innerHTML = ''; }});
                userAvatar.addEventListener('click', () => userDropdown.classList.toggle('active')); userProfileDetails.addEventListener('click', () => userDropdown.classList.toggle('active'));
                /* Removed profileLink/settingsLink listeners here as they are handled above now */
                document.addEventListener('click', (e) => { if (!e.target.closest('.user-profile')) userDropdown.classList.remove('active'); });
                notificationIcon.addEventListener('click', () => { notificationsModal.style.display = 'flex'; loadNotifications(); });
                closeNotifications.addEventListener('click', () => notificationsModal.style.display = 'none');
                notificationsModal.addEventListener('click', (e) => { if (e.target === notificationsModal) notificationsModal.style.display = 'none'; });
                markAllReadBtn.addEventListener('click', handleMarkAllNotificationsRead);
                deleteAllNotificationsBtn.addEventListener('click', handleDeleteAllNotifications);
                viewAllActivity.addEventListener('click', () => loadActivities(true));
                deleteAllActivity.addEventListener('click', handleDeleteAllActivities);
                profileForm.addEventListener('submit', handleProfileSave);
                cancelProfileBtn.addEventListener('click', handleProfileCancel);
                uploadPhotoButton.addEventListener('click', () => profileAvatarInput.click());
                profileAvatarInput.addEventListener('change', handleAvatarUpload);
                settingsTabs.forEach(tab => { tab.addEventListener('click', () => { if (!tab.classList.contains('disabled')) activateSettingsTab(tab.dataset.tab); }); });
                preferencesForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('preferencesForm', 'preferencesPanel', 'Preferences saved.'); });
                cancelPreferencesBtn.addEventListener('click', () => handleSettingsCancel('preferencesPanel'));
                accountForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('accountForm', 'accountPanel', 'Account settings saved.'); });
                cancelAccountBtn.addEventListener('click', () => handleSettingsCancel('accountPanel'));
                securityForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('securityForm', 'securityPanel', 'Security updated.'); });
                cancelSecurityBtn.addEventListener('click', () => handleSettingsCancel('securityPanel'));
                notificationsForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('notificationsForm', 'notificationsPanel', 'Notification settings saved.'); });
                cancelNotificationsBtn.addEventListener('click', () => handleSettingsCancel('notificationsPanel'));
                themeOptions.forEach(option => { option.addEventListener('click', function() { const theme = this.dataset.theme; document.getElementById('selectedTheme').value = theme; themeOptions.forEach(opt => opt.classList.remove('selected')); this.classList.add('selected'); document.body.className = ''; document.body.classList.add(`${theme}-theme`); document.body.classList.add(layoutDensitySelect.value || 'normal'); applyRBAC(); }); });
                layoutDensitySelect.addEventListener('change', function() { const density = this.value; document.body.classList.remove('compact', 'normal', 'spacious'); document.body.classList.add(density); const currentTheme = document.getElementById('selectedTheme').value || 'blue'; document.body.classList.add(`${currentTheme}-theme`); applyRBAC(); });
                inviteMemberForm.addEventListener('submit', handleInviteMember);
                confirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
                cancelConfirmBtn.addEventListener('click', () => { if (cancelCallback) cancelCallback(); hideConfirmModal(); });
                confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideConfirmModal(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && confirmModal.style.display === 'flex') hideConfirmModal(); });
            }

             // --- Placeholder Search Function ---
             function handleSearch() { /* ... (same as before) ... */ }

            // ==============================================================
            // == START: Initialization Function for Employee Scheduling =====
            // ==============================================================
            function initializeEmployeeSchedule(currentUserData, employeesData) {
                 // --- This function remains exactly the same as the previous response ---
                 // --- It should work correctly if the HTML is injected properly ---
                 console.log("initializeEmployeeSchedule called with:", currentUserData, employeesData);
                 const scheduleContainer = document.getElementById('featureSections'); if (!scheduleContainer) { console.error("Schedule Error: Could not find #featureSections container."); return; }
                 const employeeModal = scheduleContainer.querySelector('#employeeModal'); const shiftModal = scheduleContainer.querySelector('#shiftModal'); const addEmployeeBtn = scheduleContainer.querySelector('#addEmployeeBtn'); const sendRemindersBtn = scheduleContainer.querySelector('#sendRemindersBtn'); const closeEmployeeModal = scheduleContainer.querySelector('#closeEmployeeModal'); const closeShiftModal = scheduleContainer.querySelector('#closeShiftModal'); const cancelEmployeeBtn = scheduleContainer.querySelector('#cancelEmployeeBtn'); const cancelShiftBtn = scheduleContainer.querySelector('#cancelShiftBtn'); const employeeForm = scheduleContainer.querySelector('#employeeForm'); const shiftForm = scheduleContainer.querySelector('#shiftForm'); const shiftType = scheduleContainer.querySelector('#shiftType'); const customShiftGroup = scheduleContainer.querySelector('#customShiftGroup'); const deleteShiftBtn = scheduleContainer.querySelector('#deleteShiftBtn'); const prevWeekBtn = scheduleContainer.querySelector('#prevWeekBtn'); const nextWeekBtn = scheduleContainer.querySelector('#nextWeekBtn'); const weekDisplay = scheduleContainer.querySelector('#weekDisplay'); const saveScheduleBtn = scheduleContainer.querySelector('#saveScheduleBtn'); const additionalEmployeesRow = scheduleContainer.querySelector('#additionalEmployeesRow'); const shiftDateInput = scheduleContainer.querySelector('#shiftDate'); const toastNotification = scheduleContainer.querySelector('#toastNotification');
                 if (!weekDisplay || !prevWeekBtn || !nextWeekBtn || !shiftModal || !employeeModal || !toastNotification) { console.error("Schedule Error: Could not find essential DOM elements within #featureSections. Check IDs in sections/employee-scheduling.html"); const phError = document.getElementById('featureErrorMessage'); if(phError) { phError.textContent = "Error initializing schedule: Core elements missing in loaded content."; phError.style.display = 'block'; document.getElementById('featurePlaceholder')?.style.display = 'flex'; } return; }
                 const employees = employeesData || []; const currentUser = currentUserData || { role: 'employee' }; console.log("Schedule using currentUser:", currentUser); console.log("Schedule using employees:", employees); const isAdminOrSupervisor = currentUser.role === 'admin' || currentUser.role === 'supervisor'; console.log("Is Admin or Supervisor:", isAdminOrSupervisor);
                 scheduleContainer.querySelectorAll('.edit-shift').forEach(el => el.style.display = isAdminOrSupervisor ? 'inline' : 'none'); if (addEmployeeBtn) addEmployeeBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none'; if (sendRemindersBtn) sendRemindersBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none'; if (saveScheduleBtn) saveScheduleBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none';
                 let currentWeekStart = new Date(2025, 4, 5); const minDate = new Date(2025, 4, 1); const maxDate = new Date(2025, 4, 31);
                 function showToast(message, type = 'success') { toastNotification.textContent = message; toastNotification.style.backgroundColor = type === 'success' ? 'var(--primary)' : 'var(--danger)'; toastNotification.classList.add('show'); setTimeout(() => { toastNotification.classList.remove('show'); }, 3000); }
                 function updateWeekDisplay() { const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); const options = { month: 'short', day: 'numeric' }; const startStr = currentWeekStart.toLocaleDateString('en-US', options); const endStr = weekEnd.toLocaleDateString('en-US', options); const year = currentWeekStart.getFullYear(); weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`; const dateCells = scheduleContainer.querySelectorAll('.day-date'); if (dateCells.length > 0) { const tempDate = new Date(currentWeekStart); dateCells.forEach((cell) => { cell.textContent = tempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); tempDate.setDate(tempDate.getDate() + 1); }); } const prevWeek = new Date(currentWeekStart); prevWeek.setDate(prevWeek.getDate() - 7); if (prevWeekBtn) prevWeekBtn.disabled = prevWeek < minDate; const nextWeek = new Date(weekEnd); nextWeek.setDate(nextWeek.getDate() + 1); if (nextWeekBtn) nextWeekBtn.disabled = nextWeek > maxDate; }
                 if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); updateWeekDisplay(); }); if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); updateWeekDisplay(); });
                 if (shiftType && customShiftGroup) shiftType.addEventListener('change', function() { customShiftGroup.style.display = this.value === 'custom' ? 'block' : 'none'; });
                 if (addEmployeeBtn && employeeModal) addEmployeeBtn.addEventListener('click', () => { employeeModal.style.display = 'flex'; }); if (closeEmployeeModal && employeeModal) closeEmployeeModal.addEventListener('click', () => { employeeModal.style.display = 'none'; }); if (cancelEmployeeBtn && employeeModal) cancelEmployeeBtn.addEventListener('click', () => { employeeModal.style.display = 'none'; }); if (closeShiftModal && shiftModal) closeShiftModal.addEventListener('click', () => { shiftModal.style.display = 'none'; }); if (cancelShiftBtn && shiftModal) cancelShiftBtn.addEventListener('click', () => { shiftModal.style.display = 'none'; });
                 if (employeeModal) employeeModal.addEventListener('click', (e) => { if (e.target === employeeModal) employeeModal.style.display = 'none'; }); if (shiftModal) shiftModal.addEventListener('click', (e) => { if (e.target === shiftModal) shiftModal.style.display = 'none'; });
                 if (employeeForm) employeeForm.addEventListener('submit', function(e) { e.preventDefault(); const name = scheduleContainer.querySelector('#empName')?.value; const email = scheduleContainer.querySelector('#empEmail')?.value; if (!name || !email) { showToast("Name and Email required.", "danger"); return; } const visualEmployeeId = Date.now(); const newRow = document.createElement('tr'); newRow.innerHTML = `<td class="employee-name">${name}</td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="mon">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="tue">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="wed">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="thu">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="fri">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="sat">(edit)</span></td><td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="sun">(edit)</span></td>`; if (isAdminOrSupervisor) newRow.querySelectorAll('.edit-shift').forEach(el => el.style.display = 'inline'); newRow.querySelectorAll('.edit-shift').forEach(button => button.addEventListener('click', handleEditShiftClick)); const tbody = scheduleContainer.querySelector('.schedule-table tbody'); if (tbody) { const refRow = scheduleContainer.querySelector('#additionalEmployeesRow'); if (refRow) tbody.insertBefore(newRow, refRow); else tbody.appendChild(newRow); } else { console.error("Cannot add row: tbody not found."); showToast("Error adding employee.", "danger"); return; } employeeForm.reset(); if (employeeModal) employeeModal.style.display = 'none'; showToast(`Visually added ${name}.`); });
                 function handleEditShiftClick() { if (!isAdminOrSupervisor) return; const empId = parseInt(this.getAttribute('data-emp')); const day = this.getAttribute('data-day'); const currentCell = this.closest('td'); const employee = employees.find(e => e.id === empId); if (!employee) { const nameCell = this.closest('tr')?.querySelector('.employee-name'); const employeeName = nameCell ? nameCell.textContent : `Employee ID ${empId}`; console.warn(`Employee ID ${empId} not found in data. Using name: ${employeeName}`); populateShiftModal({ id: empId, name: employeeName }, day, currentCell); } else { populateShiftModal(employee, day, currentCell); } }
                 function populateShiftModal(employee, day, currentCell) { const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun']; const dayIndex = days.indexOf(day); if (dayIndex === -1) return; const date = new Date(currentWeekStart); date.setDate(date.getDate() + dayIndex); const shiftEmployeeInput = scheduleContainer.querySelector('#shiftEmployee'); if (shiftEmployeeInput) shiftEmployeeInput.value = employee.name; const formattedDate = date.toISOString().split('T')[0]; if (shiftDateInput) { shiftDateInput.value = formattedDate; shiftDateInput.min = '2025-05-01'; shiftDateInput.max = '2025-05-31'; } const shiftDiv = currentCell.querySelector('.shift'); if (shiftType) { if (shiftDiv) { if (shiftDiv.classList.contains('shift-morning')) shiftType.value = 'morning'; else if (shiftDiv.classList.contains('shift-afternoon')) shiftType.value = 'afternoon'; else if (shiftDiv.classList.contains('shift-night')) shiftType.value = 'night'; else if (shiftDiv.classList.contains('day-off')) shiftType.value = 'day-off'; else if (shiftDiv.classList.contains('sick-leave')) shiftType.value = 'sick-leave'; else if (shiftDiv.classList.contains('vacation')) shiftType.value = 'vacation'; else shiftType.value = 'custom'; } else { shiftType.value = ''; } if(customShiftGroup) customShiftGroup.style.display = shiftType.value === 'custom' ? 'block' : 'none'; const customShiftInput = scheduleContainer.querySelector('#customShift'); if(customShiftInput) customShiftInput.value = (shiftType.value === 'custom' && shiftDiv) ? shiftDiv.textContent : ''; } if (shiftModal) { const cellId = currentCell.id || `cell-${Date.now()}`; currentCell.id = cellId; shiftModal.dataset.currentCell = cellId; shiftModal.style.display = 'flex'; } }
                 scheduleContainer.querySelectorAll('.edit-shift').forEach(button => button.addEventListener('click', handleEditShiftClick));
                 if (shiftForm) shiftForm.addEventListener('submit', function(e) { e.preventDefault(); const employeeName = scheduleContainer.querySelector('#shiftEmployee')?.value; const shiftTypeValue = scheduleContainer.querySelector('#shiftType')?.value; const customShift = scheduleContainer.querySelector('#customShift')?.value; const currentCellId = shiftModal?.dataset.currentCell; if (!currentCellId) return; const currentCell = scheduleContainer.querySelector(`#${currentCellId}`); if (currentCell) { currentCell.querySelector('.shift')?.remove(); let shiftDiv = document.createElement('div'); shiftDiv.className = 'shift'; let shiftText = ''; switch (shiftTypeValue) { case 'morning': shiftDiv.classList.add('shift-morning'); shiftText = '9AM-5PM'; break; case 'afternoon': shiftDiv.classList.add('shift-afternoon'); shiftText = '12PM-8PM'; break; case 'night': shiftDiv.classList.add('shift-night'); shiftText = '5PM-1AM'; break; case 'day-off': shiftDiv.classList.add('day-off'); shiftText = 'OFF'; break; case 'sick-leave': shiftDiv.classList.add('sick-leave'); shiftText = 'SICK'; break; case 'vacation': shiftDiv.classList.add('vacation'); shiftText = 'VAC'; break; case 'custom': shiftDiv.classList.add('shift-morning'); shiftText = customShift || 'Custom'; break; case '': shiftText = ''; break; default: shiftText = 'N/A'; break; } if(shiftText) { shiftDiv.textContent = shiftText; const editLink = currentCell.querySelector('.edit-shift'); if(editLink) currentCell.insertBefore(shiftDiv, editLink); else currentCell.appendChild(shiftDiv); showToast(`Shift updated.`); } else { showToast(`Shift cleared.`, 'warning'); } } if (shiftModal) shiftModal.style.display = 'none'; });
                 if (deleteShiftBtn) deleteShiftBtn.addEventListener('click', function() { const employeeName = scheduleContainer.querySelector('#shiftEmployee')?.value; const currentCellId = shiftModal?.dataset.currentCell; if (!currentCellId) return; const currentCell = scheduleContainer.querySelector(`#${currentCellId}`); if (currentCell) { currentCell.querySelector('.shift')?.remove(); showToast(`Shift deleted.`, 'danger'); } if (shiftModal) shiftModal.style.display = 'none'; });
                 if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', () => { showToast('Schedule saved!'); });
                 if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', () => { const subject = encodeURIComponent('Schedule Reminder'); const body = encodeURIComponent(`Schedule for ${weekDisplay?.textContent || 'this week'}.\n\nBest,\n${currentUser.name}`); const recipientEmails = employees.map(e => e.email).filter(Boolean).join(','); if (recipientEmails) { window.open(`mailto:?bcc=${recipientEmails}&subject=${subject}&body=${body}`, '_blank'); showToast('Reminder email prepared.'); } else { showToast('No emails found.', 'warning'); } });
                 updateWeekDisplay(); console.log("Employee Schedule Initialized Successfully.");
            }
            // ============================================================
            // == END: Initialization Function for Employee Scheduling =====
            // ============================================================

            // --- Run Initialization ---
            initDashboard();
        });
    </script>
</body>
</html>

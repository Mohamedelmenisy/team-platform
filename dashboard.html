<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- ALL CSS FROM dash1.html --- */
        :root { /* ... variables ... */ }
        * { /* ... */ } body { /* ... */ }
        /* ... (Keep ALL original CSS from dash1.html) ... */

        /* --- CSS SPECIFIC TO EMPLOYEE SCHEDULING (Copied from original file) --- */
        /* Add the .employee-schedule-section scope */
        .employee-schedule-section .main-container { max-width: 100%; margin: 0; padding: 0; }
        .employee-schedule-section .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .employee-schedule-section .page-title { font-size: 1.5rem; color: var(--primary-dark); font-weight: 600; }
        .employee-schedule-section .page-header > div { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .employee-schedule-section .schedule-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background-color: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); flex-wrap: wrap; gap: 1rem; }
        .employee-schedule-section .week-navigation { display: flex; align-items: center; gap: 0.75rem; }
        .employee-schedule-section .week-display { font-weight: 600; min-width: 180px; text-align: center; color: var(--dark); }
        .employee-schedule-section .schedule-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); overflow-x: auto; border: 1px solid var(--light-gray); margin-top:1rem; }
        .employee-schedule-section .schedule-table { width: 100%; min-width: 700px; border-collapse: collapse; }
        .employee-schedule-section .schedule-table thead th { padding: 0.8rem 0.5rem; text-align: center; background-color: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark); border-left: 1px solid var(--primary-light); }
        .employee-schedule-section .schedule-table thead th:first-child { border-left: none; min-width: 150px; text-align: left; padding-left: 1rem; position: sticky; left: 0; z-index: 11; border-right: 1px solid var(--primary-dark); }
        .employee-schedule-section .schedule-table tbody td { padding: 0.75rem 0.5rem; text-align: center; background-color: var(--white); border-bottom: 1px solid var(--light-gray); border-left: 1px solid var(--light-gray); color: var(--dark); vertical-align: middle; height: 60px; }
        .employee-schedule-section .schedule-table tbody tr:last-child td { border-bottom: none; }
        .employee-schedule-section .schedule-table tbody td:first-child { position: sticky; left: 0; background-color: var(--white); border-right: 1px solid var(--dark-gray, #6b7280); z-index: 5; font-weight: 500; text-align: left; padding-left: 1rem; white-space: nowrap; border-left: none; }
        .employee-schedule-section .employee-1 { color: #3b82f6; } /* Add other employee colors */
        .employee-schedule-section .shift { padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; margin-bottom: 0.25rem; }
        .employee-schedule-section .shift-morning { background-color: #dbeafe; color: #1e40af; } /* Add other shift styles */
        .employee-schedule-section .day-header { display: flex; flex-direction: column; gap: 0.15rem; align-items: center; } .employee-schedule-section .day-name { font-weight: 600; font-size: 0.85rem; } .employee-schedule-section .day-date { font-size: 0.75rem; opacity: 0.8; }
        .employee-schedule-section .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; padding: 1rem; }
        .employee-schedule-section .modal-content { background-color: var(--white); width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); padding: 1.5rem; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .employee-schedule-section .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray); flex-shrink: 0; }
        .employee-schedule-section .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        .employee-schedule-section .close-modal { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--gray); line-height: 1; padding: 0; }
        .employee-schedule-section .modal-body { flex-grow: 1; overflow-y: auto; }
        .employee-schedule-section .form-group { margin-bottom: 1rem; } .employee-schedule-section .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; } .employee-schedule-section .form-control { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.95rem; } .employee-schedule-section .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; } .employee-schedule-section textarea.form-control { min-height: 80px; }
        .employee-schedule-section .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--light-gray); flex-shrink: 0; }
        .employee-schedule-section .edit-shift { cursor: pointer; color: var(--primary); font-size: 0.75rem; display: block; text-align: center; margin-top: 0.25rem; opacity: 0; transition: opacity 0.2s, height 0.2s; height: 0; overflow: hidden; }
        .employee-schedule-section td.admin-controls:hover .edit-shift.admin-visible { opacity: 0.7; height: auto; } .employee-schedule-section .edit-shift.admin-visible:hover { opacity: 1; text-decoration: underline; }
        /* ... (Responsive styles @media ... scoped with .employee-schedule-section) ... */
    </style>
</head>
<body class="blue-theme">
    <!-- ... (Audio, Success Message, Sidebar HTML, Main Content HTML, Top Nav HTML) ... -->

     <!-- Content Area -->
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="content-section active"> <!-- ... (Dashboard HTML) ... --> </div>
            <!-- Profile Content -->
            <div id="profileContent" class="content-section" style="display: none;"> <!-- ... (Profile HTML) ... --> </div>
            <!-- Settings Content -->
            <div id="settingsContent" class="content-section" style="display: none;"> <!-- ... (Settings HTML) ... --> </div>

            <!-- === Employee Scheduling Content (STATICALLY INCLUDED) === -->
            <div id="employeeSchedulingContent" class="content-section employee-schedule-section" style="display: none;">
                <!-- Main Content -->
                <div class="main-container">
                    <div class="page-header">
                        <h1 class="page-title">Employee Schedule</h1>
                        <div>
                            <button class="btn btn-primary" id="schedule-addEmployeeBtn" style="display: none;"><i class="fas fa-plus"></i> Add Employee</button>
                            <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="display: none;"><i class="fas fa-envelope"></i> Send Reminders</button>
                        </div>
                    </div>
                    <div class="schedule-controls">
                        <div class="week-navigation">
                            <button class="btn btn-outline" id="schedule-prevWeekBtn"><i class="fas fa-chevron-left"></i></button>
                            <div class="week-display" id="schedule-weekDisplay">Loading...</div>
                            <button class="btn btn-outline" id="schedule-nextWeekBtn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button class="btn btn-primary" id="schedule-saveScheduleBtn" style="display: none;"><i class="fas fa-save"></i> Save Schedule</button>
                    </div>
                    <div class="schedule-container">
                        <table class="schedule-table">
                            <thead>
                                <tr><th>Employee</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray);">Initializing Schedule...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Add Employee Modal -->
                <div class="modal" id="schedule-employeeModal"> <!-- ... (Modal HTML with prefixed IDs) ... --> </div>
                <!-- Edit Shift Modal -->
                <div class="modal" id="schedule-shiftModal"> <!-- ... (Modal HTML with prefixed IDs) ... --> </div>
            </div>
            <!-- === END Employee Scheduling Content === -->

            <!-- Container for other dynamic features (IF ANY) -->
            <div id="featureSectionsContainer" style="display: none;">
                 <div id="featureSections" class="content-section">
                      <div class="placeholder-content" id="featurePlaceholder">
                        <h2 id="featureTitle">Feature Loading...</h2><p id="featureDescription"></p>
                        <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div class="error-message" style="display: none;"></div>
                    </div>
                 </div>
            </div>

        </div>
    </main>
    <!-- Modals (Notifications, Confirm) -->
    <div class="notifications-modal" id="notificationsModal"> <!-- ... --> </div>
    <div class="confirm-modal" id="confirmModal"> <!-- ... --> </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CORE DASHBOARD ELEMENTS & STATE ---
             const sidebar = document.getElementById('sidebar');
             const menuItems = document.querySelectorAll('.menu-item');
             // Select ALL potential content sections now
             const allContentSections = document.querySelectorAll('.content-section');
             const dashboardContent = document.getElementById('dashboardContent');
             const profileContent = document.getElementById('profileContent');
             const settingsContent = document.getElementById('settingsContent');
             const employeeSchedulingContent = document.getElementById('employeeSchedulingContent'); // Get the new static section
             // Keep feature container elements if you might load OTHER features dynamically later
             const featureSectionsContainer = document.getElementById('featureSectionsContainer');
             const featureSections = document.getElementById('featureSections');
             const featurePlaceholder = document.getElementById('featurePlaceholder');
            // ... (Define ALL other element consts needed by core dashboard logic) ...
             const backButton = document.getElementById('backButton');
             let confirmBtn = document.getElementById('confirmBtn'); let cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
             // ... etc ...

            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
            let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences';
            let scheduleLogicInitialized = false; let scheduleCurrentWeekStart = null; let scheduleSavedData = {};
            const scheduleLocalStorageKey = 'employeeSchedule_May2025_integrated'; // Distinct key
            const DEFAULT_USER = { /* ... */ };

            // --- CORE DASHBOARD FUNCTIONS (Keep all needed ones) ---
             function setPlaceholderState(state, title = '', description = '') { /* ... */ }
             function showConfirmModal(config) { /* ... */ }
             function hideConfirmModal() { /* ... */ }
             function showSuccessMessage(message) { /* ... */ }
             function addActivity(icon, message) { /* ... */ }
             // Define dashboardGlobals AFTER core functions are defined
             const dashboardGlobals = { showConfirmModal, hideConfirmModal, showSuccessMessage, showErrorMessage: (msg) => showConfirmModal({title:"Error", message:msg, confirmText:"OK", confirmClass:"btn-warning", cancelText:""}), addActivity, getCurrentUser: () => JSON.parse(JSON.stringify(currentUser || {})), getTeamMembers: () => JSON.parse(JSON.stringify(teamMembers || [])), updateTeamMembers: (newTeam) => {if(Array.isArray(newTeam)){teamMembers=newTeam; saveData(); loadTeamMembers(); updateStats(); if(currentFeature === 'employee-scheduling') { renderScheduleTable_schedule(); }}} };
             window.dashboardApp = dashboardGlobals;
             function loadData() { /* ... */ }
             function saveData() { /* ... */ }
             function updateUserUI() { /* ... */ }
             function applyUserPreferences() { /* ... */ }
             function applyRBAC() { /* ... */ }
             function loadSettingsFormData() { /* ... */ }
             function updateStats() { /* ... */ }
             function updateTrendIndicator(element, trend) { /* ... */ }
             function updateNotificationBadge() { /* ... */ }
             function loadActivities(showAll = false) { /* ... */ }
             function loadNotifications() { /* ... */ }
             function getTimeAgo(timestamp) { /* ... */ }
             function updateActivityTimes() { /* ... */ }
             function startActivityTimeUpdater() { /* ... */ }
             function loadTeamMembers() { /* ... */ }
             // ... (All handle... functions for profile, settings, team, notifications, etc.) ...
             function activateSettingsTab(tabId) { /* ... */ }
             function handleInitialNavigation() { /* ... */ }


             // --- EMPLOYEE SCHEDULING LOGIC (Integrated, Define Functions First) ---
             function formatDateKey_schedule(date) { /* ... */ }
             function getLocalDateFromKey_schedule(dateKey) { /* ... */ }
             function updateWeekDisplay_schedule() { /* ... */ }
             function renderScheduleTable_schedule() { /* ... (Ensure it calls setupDynamicScheduleListeners_schedule) ... */ }
             function updateShiftDisplayUI_schedule(/*...*/) { /* ... */ }
             function handleWeekChange_schedule(direction) { /* ... */ }
             function handleAddEmployeeClick_schedule() { /* ... */ }
             function handleSendRemindersClick_schedule() { /* ... */ }
             function handleSaveScheduleClick_schedule() { /* ... */ }
             function handleEmployeeFormSubmit_schedule(e) { /* ... */ }
             function handleEditShiftClick_schedule(event) { /* ... */ }
             function handleShiftFormSubmit_schedule(e) { /* ... */ }
             function handleDeleteShiftClick_schedule() { /* ... */ }
             const shiftTypeChangeHandler_schedule = (e) => { /* ... */ };
             const editShiftKeydownHandler_schedule = (e) => { /* ... */ };
             function setupDynamicScheduleListeners_schedule() { /* ... */ }
             function setupScheduleEventListeners_schedule_static() { /* ... */ }

             // --- Schedule Initializer Function ---
             function initializeScheduleFeature_integrated() {
                  if (scheduleLogicInitialized) { console.log("Re-rendering schedule."); updateWeekDisplay_schedule(); renderScheduleTable_schedule(); return; }
                  console.log("--- Initializing Employee Scheduling Feature ---");
                  scheduleLogicInitialized = true;
                  const isAdmin = currentUser.role === 'admin' || currentUser.role === 'supervisor';
                  // Load saved data
                  const savedDataString = localStorage.getItem(scheduleLocalStorageKey); scheduleSavedData = savedDataString ? JSON.parse(savedDataString) : {}; if(typeof scheduleSavedData !== 'object') scheduleSavedData = {};
                  // Set initial week
                  if (!scheduleCurrentWeekStart) { const today=new Date(); const dow=today.getDay(); const diff=today.getDate()-dow+(dow===0?-6:1); scheduleCurrentWeekStart=new Date(today.getFullYear(),today.getMonth(),diff); /* Add clamping */ }
                  try {
                      updateWeekDisplay_schedule();
                      renderScheduleTable_schedule(); // Renders table & calls dynamic listener setup
                      setupScheduleEventListeners_schedule_static(); // Setup static listeners
                      // Show/hide admin buttons
                      const addEmpBtn=document.getElementById('schedule-addEmployeeBtn'); const sendRemBtn=document.getElementById('schedule-sendRemindersBtn'); const saveBtn=document.getElementById('schedule-saveScheduleBtn');
                      if(addEmpBtn) addEmpBtn.style.display = isAdmin ? 'inline-flex' : 'none'; if(sendRemBtn) sendRemBtn.style.display = isAdmin ? 'inline-flex' : 'none'; if(saveBtn) saveBtn.style.display = isAdmin ? 'inline-flex' : 'none';
                      console.log("--- Employee Scheduling Feature Initialized ---");
                  } catch(error) { console.error("Error during schedule init:", error); dashboardGlobals.showErrorMessage(`Schedule Init Error: ${error.message}`); }
             }

             // --- setActiveFeature (Simplified for Static Inclusion) ---
             function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`setActiveFeature: ${featureId}`);
                 currentFeature = featureId;
                 currentSettingsTab = settingsTab || (featureId === 'settings' ? currentSettingsTab : null);
                 let hash = `#${featureId}`; if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                 if (window.location.hash !== hash) history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);

                 menuItems.forEach(item => item.classList.remove('active'));
                 document.querySelector(`.menu-item[data-feature="${featureId}"]`)?.classList.add('active');

                 // Hide ALL content sections first
                 allContentSections.forEach(section => section.style.display = 'none');
                 featureSectionsContainer.style.display = 'none'; // Hide dynamic container too

                 // Show the target section based on featureId
                 let targetSection;
                 if (featureId === 'dashboard') targetSection = dashboardContent;
                 else if (featureId === 'profile') targetSection = profileContent;
                 else if (featureId === 'settings') targetSection = settingsContent;
                 else if (featureId === 'employee-scheduling') targetSection = employeeSchedulingContent; // Show schedule section
                 // Add else if for OTHER dynamic features if you load them later into featureSections
                 // else if (featureId === 'projects') { /* Load projects into featureSections... */ }

                 if (targetSection) {
                     targetSection.style.display = 'block'; // Show the target section
                     targetSection.classList.add('active'); // Add active class if needed by styles

                     // Run specific updates/initializers
                     if (featureId === 'dashboard') { updateStats(); loadActivities(); }
                     else if (featureId === 'profile') updateUserUI();
                     else if (featureId === 'settings') { applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }
                     else if (featureId === 'employee-scheduling') {
                         initializeScheduleFeature_integrated(); // Initialize schedule logic
                     }
                 } else {
                     console.warn(`No content section found for featureId: ${featureId}`);
                      // Optionally show the placeholder/error in featureSectionsContainer if no static match
                      // featureSectionsContainer.style.display = 'block';
                      // setPlaceholderState('error', 'Not Found', `Content for ${featureId} is not available.`);
                 }

                 backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';
                 window.scrollTo(0, 0);
             }


            // --- INIT DASHBOARD & LISTENERS ---
            function initDashboard() {
                 loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); setupEventListeners();
                 handleInitialNavigation(); // Calls setActiveFeature based on initial hash
                 startActivityTimeUpdater();
                 console.log("Dashboard Initialized");
             }
             function setupEventListeners() {
                 console.log("Setting up CORE dashboard listeners...");
                 const safeAddListener = (el, ev, h) => { if(el) el.addEventListener(ev, h); else console.warn(`Listener not added: Element for ${ev} not found.`); };
                 menuItems.forEach(item => safeAddListener(item, 'click', (e) => { e.preventDefault(); setActiveFeature(item.dataset.feature); }));
                 safeAddListener(backButton, 'click', () => setActiveFeature('dashboard'));
                 window.addEventListener('popstate', (event) => { if (event.state?.feature) setActiveFeature(event.state.feature, event.state.tab); else handleInitialNavigation(); });
                 // ... (ALL other safeAddListener calls for core dashboard elements) ...
                 console.log("CORE dashboard listeners attached.");
             }
            function handleInitialNavigation() {
                 const hash = window.location.hash.substring(1); let featureId = 'dashboard'; let settingsTab = null;
                 if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences'; } else { const vf=[...menuItems].some(i=>i.dataset.feature===hash)||hash==='profile'||hash==='employee-scheduling'; if(vf) featureId=hash; } }
                 console.log(`Initial navigation: feature='${featureId}', tab='${settingsTab}'`);
                 setActiveFeature(featureId, settingsTab);
             }


            // --- RUN INITIALIZATION ---
            initDashboard();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

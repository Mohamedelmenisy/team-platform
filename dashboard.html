<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- CORE DASHBOARD CSS --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b;
            --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444;
            --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem; --primary-rgb: 37, 99, 235;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Set default theme on body if needed, removed conflicting attributes */
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        body.blue-theme { /* Define blue theme colors or keep defaults */ }
        body.dark-theme { /* Define dark theme overrides */
            --primary-light: #1f2937; --dark: #f3f4f6; --light: #374151; --gray: #9ca3af;
            --light-gray: #4b5563; --white: #111827; --sidebar-bg: #111827; --sidebar-divider: rgba(255,255,255,0.05);
            --sidebar-text: rgba(255,255,255,0.8); --sidebar-hover: rgba(255,255,255,0.08); --sidebar-active: rgba(255,255,255,0.15);
            .welcome-section { background-color: #111827; box-shadow: 0 4px 6px rgba(255, 255, 255, 0.05); }
            .stat-card { background-color: #1f2937; box-shadow: 0 2px 5px rgba(255, 255, 255, 0.04); }
            .stat-card:hover { box-shadow: 0 6px 12px rgba(255, 255, 255, 0.08); }
            .activity-section { background-color: #1f2937; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.05); }
            .content-section { background-color: #1f2937; box-shadow: 0 1px 3px rgba(255, 255, 255, 0.05); }
            .top-nav { background-color: #1f2937; border-bottom-color: var(--light-gray); }
            .search-bar input { background-color: var(--light); color: var(--dark); border-color: var(--light-gray); }
            .search-results { background-color: var(--light); border-color: var(--light-gray); }
            .search-result-item { color: var(--dark); } .search-result-item:hover { background-color: var(--primary-light); }
            .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
            .dropdown-item { color: var(--dark); } .dropdown-item:hover { background-color: var(--primary-light); }
            .form-control { background-color: var(--light); color: var(--dark); border-color: var(--light-gray); }
            .form-control[readonly] { background-color: var(--light-gray); }
            .team-member-card { background-color: var(--light); border-color: var(--light-gray); }
            .member-name { color: var(--dark); }
            .schedule-controls { background-color: #1f2937; }
            .schedule-container { background-color: #1f2937; border-color: var(--light-gray); }
            .schedule-table thead th { background-color: #374151; color: var(--primary-light); border-color: #4b5563; }
            .schedule-table tbody td { background-color: #1f2937; border-color: var(--light-gray); color: var(--dark); }
             .schedule-table tbody td:first-child { background-color: #1f2937; border-right-color: var(--light-gray); }
             #employeeSchedulingContent .modal-content { background-color: #374151;}
             .modal-header { border-bottom-color: var(--light-gray); }
             .modal-title { color: var(--dark); }
             .form-control { background-color: #4b5563; border-color: #6b7280; color: #f3f4f6;}
             .form-control[readonly] { background-color: #374151; color: #9ca3af;}
             .form-actions { border-top-color: var(--light-gray); }
        }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; text-decoration: none;} /* Added text-decoration */
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; } body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; /* ... styles ... */ }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--dark); }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; } .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); } .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; } .user-name { font-weight: 500; color: var(--dark); }
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; padding: 0.5rem 0; /* Added padding */ }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--dark); text-decoration: none; transition: background-color 0.2s; cursor: pointer; /* Added cursor */}
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); /* Adjusted color */ }
        .dropdown-divider { height: 1px; background-color: var(--light-gray); margin: 0.5rem 0; } /* Added dropdown divider style */

        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; }
        /* ... other styles ... */
         #employeeSchedulingContent .schedule-table tbody td:first-child { background-color: var(--white); border-right: 1px solid var(--light-gray); /* Adjusted border color */ z-index: 5; font-weight: 500; text-align: left; padding-left: 1rem; white-space: nowrap; border-left: none; } /* Fixed sticky column background */
        /* ... rest of your styles ... */
    </style>
</head>
<!-- Apply theme class here if needed, removed aria-hidden and other external attributes -->
<body class="blue-theme">
    <!-- Sidebar (Placeholder - Add your actual sidebar HTML here) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo" data-feature="dashboard" data-section-id="dashboardContent">
                <i class="fas fa-tasks logo-icon"></i> TeamFlow
            </a>
            <!-- Add toggle button if needed -->
        </div>
        <nav class="sidebar-menu">
            <div class="menu-title">Navigation</div>
             <a href="#" class="menu-item active" data-feature="dashboard" data-section-id="dashboardContent"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
             <a href="#" class="menu-item" data-feature="employee-scheduling" data-section-id="employeeSchedulingContent"><i class="fas fa-calendar-alt"></i> Employee Schedule</a>
             <a href="#" class="menu-item" data-feature="projects" data-section-id="projectsContent"><i class="fas fa-project-diagram"></i> Projects</a>
             <a href="#" class="menu-item" data-feature="tasks" data-section-id="taskManagementContent"><i class="fas fa-tasks"></i> Tasks</a>
             <a href="#" class="menu-item" data-feature="reports" data-section-id="reportsAnalyticsContent"><i class="fas fa-chart-line"></i> Reports</a>
             <a href="#" class="menu-item" data-feature="team" data-section-id="teamMembersViewContent"><i class="fas fa-users"></i> Team</a>
            <div class="menu-divider"></div>
            <div class="menu-title">Account</div>
            <a href="#" class="menu-item" data-feature="profile" data-section-id="profileContent"><i class="fas fa-user"></i> Profile</a>
            <a href="#" class="menu-item" data-feature="settings" data-section-id="settingsContent"><i class="fas fa-cog"></i> Settings</a>
            <!-- Add other menu items matching your data-feature sections -->
        </nav>
        <!-- Sidebar footer if any -->
    </aside>

     <main class="main-content">
        <nav class="top-nav">
            <!-- Search Bar (Placeholder) -->
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search tasks, projects, team...">
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- User Menu -->
            <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon" role="button" aria-label="View Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span>
                 </div>
                <div class="user-profile">
                    <!-- Clickable element to toggle dropdown -->
                    <div class="user-profile-details" id="userProfileToggle" role="button" aria-haspopup="true" aria-expanded="false">
                         <div class="user-avatar" id="userAvatar">ME</div>
                         <span class="user-name" id="userNameDisplay">M. Elsayed</span> <!-- Added ID -->
                         <!-- <span class="user-status">Online</span> -->
                         <i class="fas fa-chevron-down" style="margin-left: 8px; font-size: 0.8em; color: var(--gray);"></i> <!-- Added caret -->
                    </div>
                    <!-- The Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" class="dropdown-item" id="profileLink">
                            <i class="fas fa-user-circle"></i> Profile
                        </a>
                        <a href="#" class="dropdown-item" id="settingsLink">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="logoutLink">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- Dashboard (Placeholder Content) -->
            <div id="dashboardContent" class="content-section active">
                <h2>Dashboard</h2>
                <p>Welcome to your dashboard. Stat cards and activity feed would go here.</p>
                <!-- Add placeholder stat cards and activity list structure if needed for layout -->
                <div class="stats-section" style="margin-top: 1.5rem;">
                     <div class="stat-card">Stat 1 Placeholder</div>
                     <div class="stat-card">Stat 2 Placeholder</div>
                     <div class="stat-card">Stat 3 Placeholder</div>
                     <div class="stat-card">Stat 4 Placeholder</div>
                </div>
                 <div class="activity-section" style="margin-top: 1.5rem;">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity</h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">View All</span>
                             <span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList"><li>No activity yet.</li></ul>
                 </div>
            </div>
            <!-- Profile (Placeholder) -->
            <div id="profileContent" class="content-section" style="display: none;">
                <h2>Profile</h2>
                <p>User profile editing form goes here.</p>
                 <!-- Add basic profile form structure if needed -->
                <div class="profile-avatar-section">
                     <div id="profileAvatarLarge">ME</div>
                     <button id="uploadPhotoButton" class="btn btn-outline">Upload Photo</button>
                     <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">
                </div>
                <form id="profileForm">
                     <div class="data-form">
                        <div class="form-group"> <label for="profileName">Full Name</label> <input type="text" id="profileName" class="form-control"> </div>
                        <div class="form-group"> <label for="profileEmail">Email</label> <input type="email" id="profileEmail" class="form-control" readonly> </div>
                        <div class="form-group"> <label for="profileTitle">Job Title</label> <input type="text" id="profileTitle" class="form-control"> </div>
                        <div class="form-group"> <label for="profilePhone">Phone</label> <input type="tel" id="profilePhone" class="form-control"> </div>
                     </div>
                     <div class="form-actions">
                         <button type="button" id="cancelProfileChanges" class="btn btn-outline">Cancel</button>
                         <button type="submit" id="saveProfileChanges" class="btn btn-primary">Save Changes</button>
                     </div>
                 </form>
            </div>
            <!-- Settings (Placeholder) -->
            <div id="settingsContent" class="content-section" style="display: none;">
                <h2>Settings</h2>
                 <div class="settings-tabs">
                     <span class="settings-tab active" data-tab="preferences">Preferences</span>
                     <span class="settings-tab" data-tab="notifications">Notifications</span>
                     <span class="settings-tab" data-tab="security">Security</span>
                     <span class="settings-tab" data-tab="team" id="settingsTeamTab">Team Management</span>
                 </div>
                 <div id="preferencesPanel" class="settings-panel active"><h3>Preferences Panel</h3><p>Theme, layout density, etc.</p></div>
                 <div id="notificationsPanel" class="settings-panel"><h3>Notifications Panel</h3><p>Email/Push preferences.</p></div>
                 <div id="securityPanel" class="settings-panel"><h3>Security Panel</h3><p>Password, 2FA.</p></div>
                 <div id="teamPanel" class="settings-panel"><h3>Team Panel</h3><p>Manage team members (list/add form).</p><div id="teamListContainer"><ul id="teamList"></ul></div></div>
            </div>

            <!-- Other static sections from original HTML -->
            <div id="projectsContent" class="content-section" style="display: none;"><h2>Projects</h2><p>Projects content goes here.</p></div>
            <div id="reportsAnalyticsContent" class="content-section" style="display: none;"><h2>Reports & Analytics</h2><p>Reports content goes here.</p></div>
            <div id="teamMembersViewContent" class="content-section" style="display: none;"><h2>Team Members</h2><p>Team Members view content goes here.</p></div>
            <div id="fileSharingContent" class="content-section" style="display: none;"><h2>File Sharing</h2><p>File Sharing content goes here.</p></div>
            <div id="dataManagementContent" class="content-section" style="display: none;"><h2>Data Management</h2><p>Data Management content goes here.</p></div>
            <div id="projectTrackingContent" class="content-section" style="display: none;"><h2>Project Tracking</h2><p>Project Tracking content goes here.</p></div>
            <div id="taskManagementContent" class="content-section" style="display: none;"><h2>Task Management</h2><p>Task Management content goes here.</p></div>
            <div id="teamCalendarContent" class="content-section" style="display: none;"><h2>Team Calendar</h2><p>Team Calendar content goes here.</p></div>
            <div id="deadlineTrackingContent" class="content-section" style="display: none;"><h2>Deadline Tracking</h2><p>Deadline Tracking content goes here.</p></div>
            <div id="innovationHubContent" class="content-section" style="display: none;"><h2>Innovation Hub</h2><p>Innovation Hub content goes here.</p></div>

            <!-- Employee Scheduling Content -->
            <div id="employeeSchedulingContent" class="content-section employee-schedule-section" style="display: none;">
                <div class="main-container">
                    <div class="page-header"> <h1 class="page-title">Employee Schedule</h1> <div> <button class="btn btn-primary" id="schedule-addEmployeeBtn" style="display: none;"><i class="fas fa-plus"></i> Add Employee</button> <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="display: none;"><i class="fas fa-envelope"></i> Send Reminders</button> </div> </div>
                    <div class="schedule-controls"> <div class="week-navigation"> <button class="btn btn-outline" id="schedule-prevWeekBtn"><i class="fas fa-chevron-left"></i></button> <div class="week-display" id="schedule-weekDisplay">Loading...</div> <button class="btn btn-outline" id="schedule-nextWeekBtn"><i class="fas fa-chevron-right"></i></button> </div> <button class="btn btn-primary" id="schedule-saveScheduleBtn" style="display: none;"><i class="fas fa-save"></i> Save Schedule</button> </div>
                    <div class="schedule-container"> <table class="schedule-table"> <thead> <tr><th>Employee</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr> </thead> <tbody id="schedule-table-body"> <tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray);">Initializing Schedule...</td></tr> </tbody> </table> </div>
                </div>
                <div class="modal" id="schedule-employeeModal" style="display: none;"> <div class="modal-content"> <div class="modal-header"><h2 class="modal-title">Add New Employee</h2><button class="close-modal" id="schedule-closeEmployeeModal">×</button></div> <form id="schedule-employeeForm"> <div class="modal-body"><div class="form-group"><label for="schedule-empName">Full Name</label><input type="text" id="schedule-empName" class="form-control" required></div><div class="form-group"><label for="schedule-empEmail">Email</label><input type="email" id="schedule-empEmail" class="form-control" required></div></div> <div class="form-actions"><button type="button" class="btn btn-outline" id="schedule-cancelEmployeeBtn">Cancel</button><button type="submit" class="btn btn-primary">Add Employee</button></div> </form> </div> </div>
                <div class="modal" id="schedule-shiftModal" style="display: none;"> <div class="modal-content"> <div class="modal-header"><h2 class="modal-title">Edit Shift</h2><button class="close-modal" id="schedule-closeShiftModal">×</button></div> <form id="schedule-shiftForm"> <div class="modal-body"> <input type="hidden" id="schedule-shiftEmpId"><input type="hidden" id="schedule-shiftDateKey"> <div class="form-group"><label for="schedule-shiftEmployee">Employee</label><input type="text" id="schedule-shiftEmployee" class="form-control" readonly></div><div class="form-group"><label for="schedule-shiftDate">Date</label><input type="text" id="schedule-shiftDateDisplay" class="form-control" readonly><input type="date" id="schedule-shiftDate" class="form-control" required style="display:none;"></div><div class="form-group"><label for="schedule-shiftType">Shift Type</label><select id="schedule-shiftType" class="form-control" required><option value="day-off">Day Off</option><option value="morning">Morning (9AM-5PM)</option><option value="afternoon">Afternoon (12PM-8PM)</option><option value="night">Night (5PM-1AM)</option><option value="sick-leave">Sick Leave</option><option value="vacation">Vacation</option><option value="custom">Custom</option></select></div><div class="form-group" id="schedule-customShiftGroup" style="display: none;"><label for="schedule-customShift">Custom Shift Times</label><input type="text" id="schedule-customShift" class="form-control" placeholder="e.g., 10AM-6PM"></div><div class="form-group"><label for="schedule-shiftNotes">Notes</label><textarea id="schedule-shiftNotes" class="form-control" rows="3"></textarea></div> </div> <div class="form-actions"><button type="button" class="btn btn-danger" id="schedule-deleteShiftBtn">Delete Shift</button><button type="button" class="btn btn-outline" id="schedule-cancelShiftBtn">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div> </form> </div> </div>
            </div>
            <!-- NO OTHER DYNAMIC SECTIONS NEEDED FOR NOW -->
             <!-- <div id="featureSectionsContainer" style="display: none;"></div> -->
        </div>
    </main>
     <!-- Modals (Placeholders - Add actual modal HTML structure) -->
    <div class="notifications-modal" id="notificationsModal" style="display: none;"> Notifications Modal Content... <button id="closeNotifications">Close</button> </div>
    <div class="confirm-modal" id="confirmModal" style="display: none;">
         <div class="confirm-container">
            <h3 id="confirmTitle">Confirm</h3>
            <p id="confirmMessage">Are you sure?</p>
            <div class="confirm-actions">
                <button id="cancelConfirmBtn" class="btn btn-outline">Cancel</button>
                <button id="confirmBtn" class="btn btn-danger">Confirm</button>
            </div>
         </div>
    </div>
    <!-- Success Message (Placeholder) -->
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> <span id="successMessageText">Success!</span></div>
    <!-- Audio Element (Placeholder) -->
    <audio id="notificationSound" src="path/to/notification.mp3" preload="auto"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CORE DASHBOARD ELEMENTS & STATE ---
             // Ensure all potentially null elements are handled gracefully
             const sidebar = document.getElementById('sidebar');
             const menuItems = document.querySelectorAll('.menu-item');
             const allContentSections = document.querySelectorAll('.content-section');
             const dashboardContent = document.getElementById('dashboardContent');
             const profileContent = document.getElementById('profileContent');
             const settingsContent = document.getElementById('settingsContent');
             const employeeSchedulingContent = document.getElementById('employeeSchedulingContent');
             const teamList = document.getElementById('teamList'); // Might be null if settings not visible initially
             const backButton = document.getElementById('backButton');
             const searchInput = document.getElementById('searchInput'); // Might be null
             const searchResults = document.getElementById('searchResults'); // Might be null
             const notificationIcon = document.getElementById('notificationIcon'); // Might be null
             const notificationBadge = document.querySelector('.notification-badge'); // Might be null
             const userAvatar = document.getElementById('userAvatar'); // Might be null
             const userProfileToggle = document.getElementById('userProfileToggle'); // Added this
             const userNameDisplay = document.getElementById('userNameDisplay'); // Added this
             // const userProfileDetails = document.querySelector('.user-profile-details'); // Replaced by userProfileToggle
             const userDropdown = document.getElementById('userDropdown'); // Might be null initially if HTML missing
             const profileLink = document.getElementById('profileLink'); // Should exist now
             const settingsLink = document.getElementById('settingsLink'); // Should exist now
             const logoutLink = document.getElementById('logoutLink'); // Should exist now
             const activityList = document.getElementById('activityList'); // Might be null
             const viewAllActivity = document.getElementById('viewAllActivity'); // Might be null
             const deleteAllActivity = document.getElementById('deleteAllActivity'); // Might be null
             const settingsTabs = document.querySelectorAll('.settings-tab'); // Might be empty
             const settingsPanels = document.querySelectorAll('.settings-panel'); // Might be empty
             // --- Elements below might be null depending on which sections are visible/populated ---
             const teamMembersCount = document.getElementById('teamMembersCount');
             const tasksCompleted = document.getElementById('tasksCompleted');
             const activeProjects = document.getElementById('activeProjects');
             const upcomingDeadlines = document.getElementById('upcomingDeadlines');
             const userInfoRoleTitle = document.getElementById('userInfoRoleTitle');
             const notificationSound = document.getElementById('notificationSound');
             const successMessage = document.getElementById('successMessage');
             const successMessageText = document.getElementById('successMessageText');
             const teamMembersTrend = document.getElementById('teamMembersTrend');
             const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
             const activeProjectsTrend = document.getElementById('activeProjectsTrend');
             const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
             let confirmBtn = document.getElementById('confirmBtn'); // Might be null
             let cancelConfirmBtn = document.getElementById('cancelConfirmBtn'); // Might be null
             const profileNameInput = document.getElementById('profileName');
             const profileEmailInput = document.getElementById('profileEmail');
             const profileTitleInput = document.getElementById('profileTitle');
             const profilePhoneInput = document.getElementById('profilePhone');
             const profileAvatarLarge = document.getElementById('profileAvatarLarge');
             const uploadPhotoButton = document.getElementById('uploadPhotoButton');
             const avatarUploadInput = document.getElementById('avatarUploadInput');
             const profileForm = document.getElementById('profileForm');
             const saveProfileChangesBtn = document.getElementById('saveProfileChanges');
             const cancelProfileChangesBtn = document.getElementById('cancelProfileChanges');
             const welcomeName = document.getElementById('welcomeName'); // NOTE: No element with this ID in provided HTML
             const userEmail = document.getElementById('userEmail'); // NOTE: No element with this ID in provided HTML (use profileEmailInput)

             let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
             let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences';
             let scheduleLogicInitialized = false; let scheduleCurrentWeekStart = null; let scheduleSavedData = {};
             const scheduleLocalStorageKey = 'employeeSchedule_May2025_integrated_v3'; // New distinct key
             const DEFAULT_USER = { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', password: 'password123', preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' }, notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } }, security: { twoFactorEnabled: true }, stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' } };

             // --- CORE DASHBOARD FUNCTIONS ---
             function showConfirmModal(config) {
                 const confirmModal=document.getElementById('confirmModal');
                 const confirmTitle=document.getElementById('confirmTitle');
                 const confirmMessage=document.getElementById('confirmMessage');
                 // Re-fetch buttons inside the function to ensure they exist if modal was hidden/recreated
                 let confirmBtnInstance = document.getElementById('confirmBtn');
                 let cancelConfirmBtnInstance = document.getElementById('cancelConfirmBtn');

                 if(!confirmModal||!confirmTitle||!confirmMessage||!confirmBtnInstance||!cancelConfirmBtnInstance) {
                     console.error("Confirm modal elements missing!"); return;
                 }

                 confirmTitle.textContent=config.title||'Confirm';
                 confirmMessage.innerHTML=config.message||'Are you sure?';
                 confirmBtnInstance.textContent=config.confirmText||'Confirm';
                 cancelConfirmBtnInstance.textContent=config.cancelText||'Cancel';
                 confirmBtnInstance.className=`btn ${config.confirmClass||'btn-danger'}`;
                 cancelConfirmBtnInstance.className='btn btn-outline';

                 // Clone and replace to remove previous listeners reliably
                 const newConfirmBtn=confirmBtnInstance.cloneNode(true);
                 confirmBtnInstance.parentNode.replaceChild(newConfirmBtn,confirmBtnInstance);
                 confirmBtnInstance=newConfirmBtn; // Use the new node

                 const newCancelBtn=cancelConfirmBtnInstance.cloneNode(true);
                 cancelConfirmBtnInstance.parentNode.replaceChild(newCancelBtn,cancelConfirmBtnInstance);
                 cancelConfirmBtnInstance=newCancelBtn; // Use the new node


                 const confirmHandler=()=>{ if(config.onConfirm)config.onConfirm(); hideConfirmModal(); };
                 const cancelHandler=()=>{ if(config.onCancel)config.onCancel(); hideConfirmModal(); };

                 confirmBtnInstance.addEventListener('click',confirmHandler,{once:true});
                 if (cancelConfirmBtnInstance.textContent) { // Only add listener if there's cancel text
                     cancelConfirmBtnInstance.addEventListener('click',cancelHandler,{once:true});
                 } else {
                     cancelConfirmBtnInstance.style.display = 'none'; // Hide if no text
                 }


                 confirmModal.style.display='flex';
                 confirmBtnInstance.focus();
             }
             function hideConfirmModal() { const m=document.getElementById('confirmModal'); if(m) m.style.display='none'; }
             function showSuccessMessage(message) { if(successMessage&&successMessageText){ successMessageText.textContent=message; successMessage.classList.add('show'); setTimeout(()=>{ successMessage.classList.remove('show'); },3000); } else { console.log("Success:", message); } }
             function addActivity(icon, message) { /* ... (Keep original logic, ensure activityList exists before manipulating) ... */ console.log("Activity:", icon, message); }
             const dashboardGlobals = { showConfirmModal, hideConfirmModal, showSuccessMessage, showErrorMessage: (msg) => showConfirmModal({title:"Error", message:msg, confirmText:"OK", confirmClass:"btn-warning", cancelText:""}), addActivity, getCurrentUser: () => JSON.parse(JSON.stringify(currentUser || {})), getTeamMembers: () => JSON.parse(JSON.stringify(teamMembers || [])), updateTeamMembers: (newTeam) => {if(Array.isArray(newTeam)){teamMembers=newTeam; saveData(); if(teamList) loadTeamMembers(); /*updateStats();*/ if(currentFeature === 'employee-scheduling' && scheduleLogicInitialized) { try { renderScheduleTable_schedule(); } catch(e){ console.error("Error rendering schedule after team update:", e);}} }} };
             window.dashboardApp = dashboardGlobals;
             function loadData() { try { const storedUser = JSON.parse(localStorage.getItem('currentUser')); currentUser = { ...DEFAULT_USER, ...storedUser }; currentUser.preferences = { ...DEFAULT_USER.preferences, ...(storedUser?.preferences || {}) }; currentUser.notificationPreferences = { ...DEFAULT_USER.notificationPreferences, ...(storedUser?.notificationPreferences || {}) }; currentUser.notificationPreferences.email = { ...DEFAULT_USER.notificationPreferences.email, ...(storedUser?.notificationPreferences?.email || {}) }; currentUser.notificationPreferences.push = { ...DEFAULT_USER.notificationPreferences.push, ...(storedUser?.notificationPreferences?.push || {}) }; currentUser.security = { ...DEFAULT_USER.security, ...(storedUser?.security || {}) }; currentUser.stats = { ...DEFAULT_USER.stats, ...(storedUser?.stats || {}) }; teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || []; activities = JSON.parse(localStorage.getItem('activities')) || []; notifications = JSON.parse(localStorage.getItem('notifications')) || []; console.log("Data loaded. Team members:", teamMembers.length); } catch (e) { console.error("Failed to load data from localStorage:", e); currentUser = {...DEFAULT_USER}; teamMembers = []; activities = []; notifications = []; } }
             function saveData() { try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); localStorage.setItem('teamMembers', JSON.stringify(teamMembers)); localStorage.setItem('activities', JSON.stringify(activities)); localStorage.setItem('notifications', JSON.stringify(notifications)); } catch (e) { console.error("Failed to save data to localStorage:", e); }}
             function updateUserUI() {
                if (!currentUser) return;
                if (userNameDisplay) userNameDisplay.textContent = currentUser.name || 'User';
                if (userAvatar) {
                     if (currentUser.avatar) { userAvatar.style.backgroundImage = `url(${currentUser.avatar})`; userAvatar.textContent = ''; }
                     else { userAvatar.style.backgroundImage = ''; userAvatar.textContent = currentUser.initials || 'U'; }
                }
                 if (profileAvatarLarge) {
                     if (currentUser.avatar) { profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`; profileAvatarLarge.textContent = ''; }
                     else { profileAvatarLarge.style.backgroundImage = ''; profileAvatarLarge.textContent = currentUser.initials || 'U'; }
                 }
                 // Populate profile form if elements exist
                 if (profileNameInput) profileNameInput.value = currentUser.name || '';
                 if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
                 if (profileTitleInput) profileTitleInput.value = currentUser.title || '';
                 if (profilePhoneInput) profilePhoneInput.value = currentUser.phone || '';

                 // Example for welcome message (if element existed)
                 // if (welcomeName) welcomeName.textContent = currentUser.name || 'User';
                 // if (userInfoRoleTitle) userInfoRoleTitle.textContent = currentUser.title || 'Member';
             }
             function applyUserPreferences() {
                 if (!currentUser || !currentUser.preferences) return;
                 document.body.classList.remove('light-theme', 'dark-theme', 'blue-theme'); // Remove existing
                 document.body.classList.add(currentUser.preferences.theme + '-theme'); // Add current
                 document.body.classList.remove('compact', 'normal', 'spacious');
                 document.body.classList.add(currentUser.preferences.layoutDensity || 'normal');
                 // Apply other preferences like language, timezone if needed
             }
             function applyRBAC() {
                 const isAdmin = currentUser?.role === 'admin';
                 const isSupervisor = currentUser?.role === 'supervisor'; // Example role
                 // Show/hide elements based on role
                 const teamMgmtTab = document.getElementById('settingsTeamTab');
                 if (teamMgmtTab) teamMgmtTab.style.display = isAdmin ? 'inline-block' : 'none';
                 const teamPanel = document.getElementById('teamPanel');
                 if (teamPanel) teamPanel.style.display = isAdmin ? 'block' : 'none'; // Also hide panel if tab hidden
                 // Example: Make certain form fields read-only for non-admins
                 // if (profileTitleInput && !isAdmin) profileTitleInput.readOnly = true;
             }
             function loadSettingsFormData() { /* ... Original logic ... Check elements exist ... */ }
             function updateStats() { /* ... Original logic ... Check elements exist ... */ console.log("UpdateStats called (implementation skipped as elements might be missing)"); }
             function updateTrendIndicator(element, trend) { /* ... Original logic ... Check element exists ... */ }
             function updateNotificationBadge() { /* ... Original logic ... Check elements exist ... */ }
             function loadActivities(showAll = false) { /* ... Original logic ... Check activityList exists ... */ console.log("loadActivities called (implementation skipped as elements might be missing)"); }
             function loadNotifications() { /* ... Original logic ... Check elements exist ... */ console.log("loadNotifications called (implementation skipped as elements might be missing)"); }
             function getTimeAgo(timestamp) { /* ... Original logic ... */ return new Date(timestamp).toLocaleTimeString(); /* Simplified */ }
             function updateActivityTimes() { /* ... Original logic ... */ }
             function startActivityTimeUpdater() { /* ... Original logic ... */ }
             function loadTeamMembers() { /* ... Original logic ... Check teamList exists ... */ console.log("loadTeamMembers called (implementation skipped as elements might be missing)"); }
             function handleProfileSave(e) { e.preventDefault(); /* ... Original logic ... Check elements exist ... */ showSuccessMessage("Profile changes saved (simulated)."); updateUserUI(); setActiveFeature('profile');}
             function handleProfileCancel() { /* ... Original logic ... */ updateUserUI(); /* Revert UI */ setActiveFeature('profile');}
             function handleSettingsSave(formId, panelId, successMsg) { /* ... Original logic ... */ showSuccessMessage(successMsg || "Settings saved (simulated)."); }
             function handleSettingsCancel(panelId) { /* ... Original logic ... */ loadSettingsFormData(); /* Revert */ }
             function handleInviteMember(e) { e.preventDefault(); /* ... Original logic ... */ showSuccessMessage("Member invited (simulated)."); }
             function handleEditMemberClick(e) { /* ... Original logic ... */ }
             function handleDeleteMemberClick(e) { /* ... Original logic ... */ }
             function handleDeleteActivityClick(e) { /* ... Original logic ... */ }
             function handleDeleteAllActivities() { /* ... Original logic ... */ }
             function markNotificationAsRead(notificationId, itemElement) { /* ... Original logic ... */ }
             function handleMarkAllNotificationsRead() { /* ... Original logic ... */ }
             function handleDeleteNotificationClick(notificationId) { /* ... Original logic ... */ }
             function handleDeleteAllNotifications() { /* ... Original logic ... */ }
             function handleAvatarUpload(e) { /* ... Original logic ... Check elements exist ... */ showSuccessMessage("Avatar updated (simulated).");}
             function handleLogout() { /* ... Original logic ... */ showConfirmModal({title: "Logout", message: "Are you sure you want to logout?", confirmText: "Logout", onConfirm: () => { console.log("Logging out..."); localStorage.clear(); location.reload(); }});}
             function addNotification(icon, message) { /* ... Original logic ... */ }
             function playNotificationSound() { /* ... Original logic ... */ }
             function handleSearch() { /* ... Original logic ... */ }
             function activateSettingsTab(tabId) {
                 if (!tabId) tabId = 'preferences'; // Default tab
                 currentSettingsTab = tabId;
                 settingsTabs.forEach(tab => {
                     tab.classList.toggle('active', tab.dataset.tab === tabId);
                 });
                 settingsPanels.forEach(panel => {
                     // Assuming panel IDs match `tabId + 'Panel'` pattern
                     panel.classList.toggle('active', panel.id === tabId + 'Panel');
                     panel.style.display = panel.classList.contains('active') ? 'block' : 'none'; // Ensure display style matches
                 });
                  // Update hash for settings
                  if (currentFeature === 'settings') {
                      const hash = `#settings-${currentSettingsTab}`;
                      if (window.location.hash !== hash) {
                          history.pushState({ feature: 'settings', tab: currentSettingsTab }, '', hash);
                      }
                  }
                 console.log("Activated settings tab:", tabId);
             }

            // --- EMPLOYEE SCHEDULING LOGIC (Integrated) ---
            // ... (Keep the entire Employee Scheduling Logic block as it was) ...
             function formatDateKey_schedule(date) { if (!date?.getTime) return null; const y=date.getFullYear(); const m=(date.getMonth()+1).toString().padStart(2,'0'); const d=date.getDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
            function getLocalDateFromKey_schedule(dateKey) { if (!dateKey?.match) return null; const p=dateKey.split('-'); return new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2])); }

            function updateWeekDisplay_schedule() {
                 const weekDisplay = document.getElementById('schedule-weekDisplay'); const prevWeekBtn = document.getElementById('schedule-prevWeekBtn'); const nextWeekBtn = document.getElementById('schedule-nextWeekBtn');
                 if (!weekDisplay || !prevWeekBtn || !nextWeekBtn) {console.warn("Missing schedule nav elements for week update"); return;}
                 const scheduleMinDate = new Date(2025, 4, 1); const scheduleMaxDate = new Date(2025, 4, 31);
                 if (!scheduleCurrentWeekStart) { const today=new Date(); const dow=today.getDay(); const diff=today.getDate()-dow+(dow===0?-6:1); scheduleCurrentWeekStart=new Date(today.getFullYear(),today.getMonth(),diff); if (scheduleCurrentWeekStart < scheduleMinDate) scheduleCurrentWeekStart = new Date(scheduleMinDate); if (scheduleCurrentWeekStart > scheduleMaxDate) { scheduleCurrentWeekStart = new Date(scheduleMaxDate); scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate() - 6); } }
                 const weekEnd = new Date(scheduleCurrentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); const options = { month: 'short', day: 'numeric' };
                 weekDisplay.textContent = `${scheduleCurrentWeekStart.toLocaleDateString('en-US', options)} - ${weekEnd.toLocaleDateString('en-US', options)}, ${scheduleCurrentWeekStart.getFullYear()}`;
                 const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; const headerRow = document.querySelector('#employeeSchedulingContent .schedule-table thead tr');
                 if (!headerRow) return; headerRow.innerHTML = '<th>Employee</th>'; const tempDate = new Date(scheduleCurrentWeekStart);
                 days.forEach(dayName => { const th=document.createElement('th'); const ds=tempDate.toLocaleDateString('en-US',{day:'numeric'}); const ms=tempDate.toLocaleDateString('en-US',{month:'short'}); th.innerHTML=`<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${ms} ${ds}</span></div>`; headerRow.appendChild(th); tempDate.setDate(tempDate.getDate()+1); });
                 const prevT=new Date(scheduleCurrentWeekStart); prevT.setDate(prevT.getDate()-1); prevWeekBtn.disabled=prevT<scheduleMinDate; const nextT=new Date(scheduleCurrentWeekStart); nextT.setDate(nextT.getDate()+7); nextWeekBtn.disabled=nextT>scheduleMaxDate;
            }

            function renderScheduleTable_schedule() {
                const scheduleTableBody = document.getElementById('schedule-table-body');
                if (!scheduleTableBody) { console.error("renderScheduleTable_schedule: Cannot find table body!"); return; }
                console.log(`Rendering schedule table. Employees: ${teamMembers.length}`);
                scheduleTableBody.innerHTML = '';
                if (!Array.isArray(teamMembers) || teamMembers.length === 0) { scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray);">No employees defined. Add in Settings > Team Management.</td></tr>`; return; }
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; const isAdmin = currentUser.role === 'admin' || currentUser.role === 'supervisor';
                teamMembers.forEach((employee, index) => {
                    if (!employee?.id || !employee?.name) { console.warn("Skipping invalid employee in render:", employee); return; }
                    const tr = document.createElement('tr'); tr.dataset.empId = employee.id;
                    const nameTd = document.createElement('td'); nameTd.className = `employee-name employee-${(index % 6) + 1}`; nameTd.textContent = employee.name; tr.appendChild(nameTd);
                    const tempDate = new Date(scheduleCurrentWeekStart);
                    days.forEach((day, dayIndex) => {
                        const td = document.createElement('td'); td.classList.add('admin-controls'); const dateKey = formatDateKey_schedule(tempDate);
                        if (!dateKey) { td.textContent='ERR'; tr.appendChild(td); tempDate.setDate(tempDate.getDate()+1); return; }
                        const mobileLabel = `${days[dayIndex]} (${tempDate.toLocaleDateString('en-us',{month:'short',day:'numeric'})})`; td.dataset.label = mobileLabel; td.dataset.dateKey = dateKey;
                        const empKey = `emp-${employee.id}`; const shiftData = scheduleSavedData[empKey]?.[dateKey];
                        if (shiftData?.text && shiftData?.class) { const div=document.createElement('div'); div.className=`shift ${shiftData.class}`; div.textContent=shiftData.text; div.title=shiftData.notes||''; td.appendChild(div); }
                        if (isAdmin) { const es=document.createElement('span'); es.className='edit-shift admin-visible'; es.dataset.empId=employee.id; es.dataset.dateKey=dateKey; es.textContent=shiftData?'(edit)':'(add)'; es.setAttribute('role','button'); es.setAttribute('tabindex','0'); es.onclick=handleEditShiftClick_schedule; es.onkeydown=editShiftKeydownHandler_schedule; td.appendChild(es); }
                        tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1);
                    });
                    scheduleTableBody.appendChild(tr);
                });
                setupDynamicScheduleListeners_schedule();
            }

            function updateShiftDisplayUI_schedule(empId, dateKey, shiftText, shiftClass, notes = '') { const sBody = document.getElementById('schedule-table-body'); if(!sBody) return; const sel=`tr[data-emp-id="${empId}"] td[data-date-key="${dateKey}"]`; const cell=sBody.querySelector(sel); if(!cell) return; const es=cell.querySelector('.edit-shift'); const ex=shiftText&&shiftClass; const os=cell.querySelector('.shift'); if(os)os.remove(); if(ex){const div=document.createElement('div'); div.className=`shift ${shiftClass}`; div.textContent=shiftText; div.title=notes||''; if(es)cell.insertBefore(div,es); else cell.appendChild(div);} if(es)es.textContent=ex?'(edit)':'(add)'; }
            function handleWeekChange_schedule(direction) { if(!scheduleCurrentWeekStart) return; const min=new Date(2025,4,1); const max=new Date(2025,4,31); const newW=new Date(scheduleCurrentWeekStart); newW.setDate(newW.getDate()+(direction*7)); if(newW<min||newW>max) return; scheduleCurrentWeekStart=newW; updateWeekDisplay_schedule(); renderScheduleTable_schedule(); }
            function handleAddEmployeeClick_schedule() { const m=document.getElementById('schedule-employeeModal'); const f=document.getElementById('schedule-employeeForm'); if(m&&f){f.reset(); m.style.display='flex'; m.querySelector('#schedule-empName')?.focus();} }
            function handleSendRemindersClick_schedule() { const wd=document.getElementById('schedule-weekDisplay'); const wt=wd?.textContent||"Current Week"; const subj=encodeURIComponent(`Reminder: ${wt}`); let body=`Hi Team,\nSchedule for ${wt}:\n\n`; teamMembers.forEach(e=>{body+=`${e.name}:\n`; let s=''; const tmp=new Date(scheduleCurrentWeekStart); for(let i=0;i<7;i++){const dk=formatDateKey_schedule(tmp); const sd=scheduleSavedData[`emp-${e.id}`]?.[dk]; if(sd&&sd.type!=='day-off')s+=` ${tmp.toLocaleDateString('en-US',{weekday:'short'})}: ${sd.text}`; tmp.setDate(tmp.getDate()+1);} body+=s||' (No shifts)\n'; body+='\n';}); body+='Thanks'; const emails=teamMembers.map(e=>e.email).filter(Boolean).join(','); if(!emails){dashboardGlobals.showErrorMessage("No emails."); return;} window.open(`mailto:${emails}?subject=${subj}&body=${encodeURIComponent(body)}`, '_blank'); }
            function handleSaveScheduleClick_schedule() { localStorage.setItem(scheduleLocalStorageKey, JSON.stringify(scheduleSavedData)); dashboardGlobals.showSuccessMessage("Schedule saved."); dashboardGlobals.addActivity('fa-calendar-check', `Schedule saved`); }
            function handleEmployeeFormSubmit_schedule(e) { e.preventDefault(); const m=document.getElementById('schedule-employeeModal'); const f=document.getElementById('schedule-employeeForm'); if(!m||!f) return; const ni=f.querySelector('#schedule-empName'); const ei=f.querySelector('#schedule-empEmail'); const name=ni?.value.trim(); const email=ei?.value.trim(); if(!name||!email||!/^\S+@\S+\.\S+$/.test(email)){dashboardGlobals.showErrorMessage("Valid name/email needed."); return;} if(teamMembers.some(em=>em.email.toLowerCase()===email.toLowerCase())){dashboardGlobals.showErrorMessage(`Email ${email} exists.`); return;} const ne={id:Date.now(), name, email, role:'member', initials:name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase(), avatar:''}; dashboardGlobals.updateTeamMembers([...teamMembers, ne]); m.style.display='none'; dashboardGlobals.addActivity('fa-user-plus', `Added ${name}`); dashboardGlobals.showSuccessMessage(`${name} added.`); }
            function handleEditShiftClick_schedule(event) { const target=event.currentTarget||event.target; const empId=parseInt(target?.dataset.empId); const dateKey=target?.dataset.dateKey; const m=document.getElementById('schedule-shiftModal'); const f=document.getElementById('schedule-shiftForm'); const sEmp=document.getElementById('schedule-shiftEmployee'); const sDateD=document.getElementById('schedule-shiftDateDisplay'); const sDate=document.getElementById('schedule-shiftDate'); const sType=document.getElementById('schedule-shiftType'); const cInput=document.getElementById('schedule-customShift'); const sNotes=document.getElementById('schedule-shiftNotes'); const sEmpId=document.getElementById('schedule-shiftEmpId'); const sDateKey=document.getElementById('schedule-shiftDateKey'); if(!empId||!dateKey||!m||!f||!sEmp||!sDateD||!sDate||!sType||!cInput||!sNotes||!sEmpId||!sDateKey){dashboardGlobals.showErrorMessage("Edit modal error."); return;} const emp=teamMembers.find(e=>e.id===empId); const shiftD=getLocalDateFromKey_schedule(dateKey); if(!emp||!shiftD){dashboardGlobals.showErrorMessage("Invalid edit data."); return;} f.reset(); sEmpId.value=empId; sDateKey.value=dateKey; f.dataset.empId=empId; f.dataset.dateKey=dateKey; sEmp.value=emp.name; const dfOpts={weekday:'long',year:'numeric',month:'long',day:'numeric'}; sDateD.value=shiftD.toLocaleDateString(currentUser?.preferences?.language||'en-US',dfOpts); sDate.value=dateKey; sDate.min='2025-05-01'; sDate.max='2025-05-31'; const ek=`emp-${empId}`; const savedS=scheduleSavedData[ek]?.[dateKey]; if(savedS){sType.value=savedS.type||'day-off'; cInput.value=savedS.type==='custom'?savedS.text:''; sNotes.value=savedS.notes||'';}else{sType.value='day-off'; cInput.value=''; sNotes.value='';} sType.dispatchEvent(new Event('change')); m.style.display='flex'; sType.focus(); }
            function handleShiftFormSubmit_schedule(e) { e.preventDefault(); const m=document.getElementById('schedule-shiftModal'); const f=document.getElementById('schedule-shiftForm'); if(!m||!f) return; const empId=parseInt(document.getElementById('schedule-shiftEmpId')?.value||f.dataset.empId); const dateKey=document.getElementById('schedule-shiftDateKey')?.value||f.dataset.dateKey; const emp=teamMembers.find(e=>e.id===empId); if(!emp||!dateKey){dashboardGlobals.showErrorMessage("Save error."); m.style.display='none'; return;} const typeV=document.getElementById('schedule-shiftType')?.value; const customT=document.getElementById('schedule-customShift')?.value.trim(); const notes=document.getElementById('schedule-shiftNotes')?.value.trim(); let txt='',cls=''; switch(typeV){ case 'morning':txt='9AM-5PM';cls='shift-morning';break; case 'afternoon':txt='12PM-8PM';cls='shift-afternoon';break; case 'night':txt='5PM-1AM';cls='shift-night';break; case 'day-off':txt='OFF';cls='day-off';break; case 'sick-leave':txt='SICK';cls='sick-leave';break; case 'vacation':txt='VAC';cls='vacation';break; case 'custom':if(!customT){dashboardGlobals.showErrorMessage('Enter custom times.');return;}txt=customT;cls='shift-morning';break; default:dashboardGlobals.showErrorMessage('Invalid shift.');m.style.display='none';return; } const ek=`emp-${empId}`; if(!scheduleSavedData[ek])scheduleSavedData[ek]={}; scheduleSavedData[ek][dateKey]={type:typeV,text:txt,class:cls,notes:notes}; localStorage.setItem(scheduleLocalStorageKey, JSON.stringify(scheduleSavedData)); updateShiftDisplayUI_schedule(empId,dateKey,txt,cls,notes); m.style.display='none'; const dDate=getLocalDateFromKey_schedule(dateKey); dashboardGlobals.addActivity('fa-clock', `Updated shift for ${emp.name}`); dashboardGlobals.showSuccessMessage(`Shift updated.`); }
            function handleDeleteShiftClick_schedule() { const m=document.getElementById('schedule-shiftModal'); const f=document.getElementById('schedule-shiftForm'); if(!m||!f) return; const empId=parseInt(document.getElementById('schedule-shiftEmpId')?.value||f.dataset.empId); const dateKey=document.getElementById('schedule-shiftDateKey')?.value||f.dataset.dateKey; const emp=teamMembers.find(e=>e.id===empId); const dDate=getLocalDateFromKey_schedule(dateKey); if(!emp||!dDate||!dateKey){dashboardGlobals.showErrorMessage("Delete error."); m.style.display='none'; return;} const fDate=dDate.toLocaleDateString(); dashboardGlobals.showConfirmModal({ title:'Delete Shift?', message:`Delete shift for <strong>${emp.name}</strong> on ${fDate}?`, confirmText:'Delete', confirmClass:'btn-danger', onConfirm:()=>{const ek=`emp-${empId}`; let del=false; if(scheduleSavedData[ek]?.[dateKey]){delete scheduleSavedData[ek][dateKey]; del=true;} if(del){localStorage.setItem(scheduleLocalStorageKey, JSON.stringify(scheduleSavedData)); updateShiftDisplayUI_schedule(empId,dateKey,'','',''); dashboardGlobals.addActivity('fa-calendar-minus', `Deleted shift for ${emp.name}`); dashboardGlobals.showSuccessMessage(`Shift deleted.`);}else{dashboardGlobals.showSuccessMessage(`No shift found.`);} m.style.display='none';}}); }
            const shiftTypeChangeHandler_schedule = (e) => { const cg=document.getElementById('schedule-customShiftGroup'); const ci=document.getElementById('schedule-customShift'); if(!cg||!ci)return; const iC=e.target.value==='custom'; cg.style.display=iC?'block':'none'; ci.required=iC; if(iC)ci.focus(); };
            const editShiftKeydownHandler_schedule = (e) => { if (e.key === 'Enter' || e.key === ' ') handleEditShiftClick_schedule(e); };
            function setupDynamicScheduleListeners_schedule() { document.querySelectorAll('#schedule-table-body .edit-shift').forEach(b=>{b.removeEventListener('click',handleEditShiftClick_schedule);b.removeEventListener('keydown',editShiftKeydownHandler_schedule);b.addEventListener('click',handleEditShiftClick_schedule);b.addEventListener('keydown',editShiftKeydownHandler_schedule);}); console.log("Dynamic schedule listeners attached."); }
            function setupScheduleEventListeners_schedule_static() {
                 console.log("Setting up STATIC schedule listeners...");
                 const safeAddListener = (id, ev, h) => { const el=document.getElementById(id); if(el) el.addEventListener(ev, h); else console.warn(`Listener not added: Element #${id} not found for STATIC schedule setup.`); }; // Added context to warn
                 safeAddListener('schedule-prevWeekBtn', 'click', () => handleWeekChange_schedule(-1)); safeAddListener('schedule-nextWeekBtn', 'click', () => handleWeekChange_schedule(1)); safeAddListener('schedule-addEmployeeBtn', 'click', handleAddEmployeeClick_schedule); safeAddListener('schedule-sendRemindersBtn', 'click', handleSendRemindersClick_schedule); safeAddListener('schedule-saveScheduleBtn', 'click', handleSaveScheduleClick_schedule);
                 safeAddListener('schedule-closeEmployeeModal', 'click', () => { const m=document.getElementById('schedule-employeeModal'); if(m) m.style.display = 'none'; }); safeAddListener('schedule-cancelEmployeeBtn', 'click', () => { const m=document.getElementById('schedule-employeeModal'); if(m) m.style.display = 'none'; }); safeAddListener('schedule-employeeForm', 'submit', handleEmployeeFormSubmit_schedule); safeAddListener('schedule-employeeModal', 'click', (e)=>{if(e.target.id==='schedule-employeeModal')e.target.style.display='none';});
                 safeAddListener('schedule-closeShiftModal', 'click', () => { const m=document.getElementById('schedule-shiftModal'); if(m) m.style.display = 'none'; }); safeAddListener('schedule-cancelShiftBtn', 'click', () => { const m=document.getElementById('schedule-shiftModal'); if(m) m.style.display = 'none'; }); safeAddListener('schedule-shiftForm', 'submit', handleShiftFormSubmit_schedule); safeAddListener('schedule-deleteShiftBtn', 'click', handleDeleteShiftClick_schedule); safeAddListener('schedule-shiftType', 'change', shiftTypeChangeHandler_schedule); safeAddListener('schedule-shiftModal', 'click', (e)=>{if(e.target.id==='schedule-shiftModal')e.target.style.display='none';});
                 console.log("STATIC schedule listeners attached.");
            }

            // --- Integrated Initialization Function for Schedule ---
             function initializeScheduleFeature_integrated() {
                 if (scheduleLogicInitialized) { console.log("Re-rendering schedule."); updateWeekDisplay_schedule(); renderScheduleTable_schedule(); return; }
                 console.log("--- Initializing Employee Scheduling Feature (Integrated) ---");
                 scheduleLogicInitialized = true;
                 const isAdmin = currentUser?.role === 'admin' || currentUser?.role === 'supervisor'; // Use optional chaining
                 const savedDataString = localStorage.getItem(scheduleLocalStorageKey); try { scheduleSavedData = savedDataString ? JSON.parse(savedDataString) : {}; if(typeof scheduleSavedData !== 'object' || scheduleSavedData === null) scheduleSavedData = {}; } catch (e) { console.error("Error parsing schedule data:", e); scheduleSavedData = {}; } // Handle parsing error
                 if (!scheduleCurrentWeekStart) { const today=new Date(); const dow=today.getDay(); const diff=today.getDate()-dow+(dow===0?-6:1); scheduleCurrentWeekStart=new Date(today.getFullYear(),today.getMonth(),diff); const minD=new Date(2025,4,1),maxD=new Date(2025,4,31); if(scheduleCurrentWeekStart<minD)scheduleCurrentWeekStart=new Date(minD); if(scheduleCurrentWeekStart>maxD){scheduleCurrentWeekStart=new Date(maxD); scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate()-6);}}
                 try {
                     updateWeekDisplay_schedule(); renderScheduleTable_schedule(); setupScheduleEventListeners_schedule_static(); // Setup static listeners here
                     const addBtn=document.getElementById('schedule-addEmployeeBtn'); const sendBtn=document.getElementById('schedule-sendRemindersBtn'); const saveBtn=document.getElementById('schedule-saveScheduleBtn');
                     if(addBtn) addBtn.style.display=isAdmin?'inline-flex':'none'; if(sendBtn) sendBtn.style.display=isAdmin?'inline-flex':'none'; if(saveBtn) saveBtn.style.display=isAdmin?'inline-flex':'none';
                     console.log("--- Employee Scheduling Feature Initialized (Integrated) ---");
                 } catch(error) { console.error("Error during integrated schedule init:", error); dashboardGlobals.showErrorMessage(`Schedule Init Error: ${error.message}`); scheduleLogicInitialized = false; } // Reset flag on error
            }

            // --- setActiveFeature (Revised) ---
            function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`setActiveFeature: feature='${featureId}', tab='${settingsTab}'`);
                 if (currentFeature === 'employee-scheduling' && featureId !== 'employee-scheduling' && scheduleLogicInitialized) {
                    // Optional: Add cleanup logic for schedule if needed when navigating away
                    scheduleLogicInitialized = false; console.log("Reset schedule flag.");
                 }

                 currentFeature = featureId || 'dashboard'; // Default to dashboard if null/undefined
                 currentSettingsTab = settingsTab || (featureId === 'settings' ? 'preferences' : null); // Default settings tab

                 let hash = `#${currentFeature}`;
                 if (currentFeature === 'settings' && currentSettingsTab) { hash += `-${currentSettingsTab}`; }

                 // Update URL only if it changed
                 if (window.location.hash !== hash) {
                    try {
                         history.pushState({ feature: currentFeature, tab: currentSettingsTab }, '', hash);
                    } catch (e) {
                        // Handle potential security errors with pushState on file:// protocol etc.
                        console.warn("Could not update history state:", e);
                        // Fallback or alternative URL update method if needed
                        // window.location.hash = hash; // Less ideal as it causes page jump/reload history entry
                    }
                 }

                 // Update sidebar active state
                 menuItems.forEach(item => {
                     if(item) item.classList.toggle('active', item.dataset.feature === currentFeature);
                 });

                 // Hide ALL content sections first
                 allContentSections.forEach(section => {
                     if(section) {
                         section.style.display = 'none';
                         section.classList.remove('active');
                     }
                 });

                 // Determine the target section ID
                 let targetSectionId;
                 if (currentFeature === 'dashboard') {
                     targetSectionId = 'dashboardContent';
                 } else if (currentFeature === 'profile') {
                     targetSectionId = 'profileContent';
                 } else if (currentFeature === 'settings') {
                     targetSectionId = 'settingsContent';
                 } else if (currentFeature === 'employee-scheduling') {
                    targetSectionId = 'employeeSchedulingContent';
                 } else {
                     // Generic mapping based on data-feature attribute
                     targetSectionId = `${currentFeature}Content`;
                 }

                 const targetSection = document.getElementById(targetSectionId);

                 if (targetSection) {
                     targetSection.style.display = 'block';
                     targetSection.classList.add('active');

                     // Run specific updates/initializers AFTER showing the section
                     if (targetSectionId === 'dashboardContent') { updateStats(); loadActivities(); }
                     else if (targetSectionId === 'profileContent') { updateUserUI(); /* Load profile data if needed */ }
                     else if (targetSectionId === 'settingsContent') { applyRBAC(); activateSettingsTab(currentSettingsTab); }
                     else if (targetSectionId === 'employeeSchedulingContent') { initializeScheduleFeature_integrated(); }
                     // Add initializers for other sections if needed
                     // else if (targetSectionId === 'projectsContent') { initializeProjects(); }

                 } else {
                     console.error(`Target section with ID ${targetSectionId} not found for feature ${currentFeature}! Defaulting to dashboard.`);
                     // Fallback to show dashboard if target not found
                     const dashSection = document.getElementById('dashboardContent');
                     if (dashSection) {
                         dashSection.style.display = 'block';
                         dashSection.classList.add('active');
                         updateStats();
                         loadActivities();
                         // Update menu/hash back to dashboard state
                         if (currentFeature !== 'dashboard') {
                            currentFeature = 'dashboard';
                            menuItems.forEach(item => item.classList.toggle('active', item.dataset.feature === 'dashboard'));
                             if (window.location.hash !== '#dashboard') {
                                 try { history.pushState({ feature: 'dashboard', tab: null }, '', '#dashboard'); } catch (e) { console.warn("Could not update history state:", e); }
                             }
                         }
                     } else {
                         console.error("Fallback dashboardContent section also not found!");
                     }
                 }

                 // Show/hide back button
                 if (backButton) {
                    backButton.style.display = currentFeature !== 'dashboard' ? 'inline-flex' : 'none';
                 }
                 window.scrollTo(0, 0); // Scroll to top
            }

            // --- handleInitialNavigation ---
            function handleInitialNavigation() {
                 const hash = window.location.hash.substring(1);
                 let featureId = 'dashboard';
                 let settingsTab = null;

                 if (hash) {
                     if (hash.startsWith('settings-')) {
                         featureId = 'settings';
                         const potentialTab = hash.split('-')[1];
                         // Validate potentialTab against known tabs if necessary
                         settingsTab = potentialTab || 'preferences';
                     } else {
                         // Check if hash corresponds to a known feature (sidebar item or profile)
                         const isValidFeature = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile';
                         if (isValidFeature) {
                             featureId = hash;
                         }
                         // else: keep default 'dashboard' if hash is unrecognized
                     }
                 }
                 console.log(`Initial navigation: feature='${featureId}', tab='${settingsTab}'`);
                 setActiveFeature(featureId, settingsTab);
            }


             // --- INIT DASHBOARD ---
             function initDashboard() {
                 loadData();
                 applyUserPreferences(); // Apply theme etc. early
                 updateUserUI(); // Populate user-specific elements
                 loadTeamMembers(); // Load team data (might be needed by RBAC or other sections)
                 applyRBAC(); // Apply role-based access control
                 // Load initial data for default view (dashboard) - these check if elements exist
                 loadActivities();
                 loadNotifications();
                 updateStats();
                 // Setup listeners AFTER essential data/UI is ready
                 setupEventListeners();
                 handleInitialNavigation(); // Set the active view based on URL or default
                 startActivityTimeUpdater();
                 console.log("Dashboard Initialized");
             }

             // --- Setup Core Event Listeners (Safe version, Revised) ---
             function setupEventListeners() {
                  console.log("Setting up CORE dashboard listeners...");
                  // Helper for adding listeners safely
                  const safeAddListener = (el, ev, h, capture = false) => {
                      if(el) {
                          el.addEventListener(ev, h, capture);
                      } else {
                          // Try to identify the element based on the handler or context if possible
                          // Avoid logging warnings for elements expected to be sometimes null (e.g., inside modals)
                          // unless it's critical like navigation.
                          // For this specific fix, we focus on the critical navigation links.
                          const isCritical = ['profileLink', 'settingsLink', 'logoutLink'].some(id => h.toString().includes(id)) || ev === 'popstate';
                          if (isCritical) {
                              console.warn(`Listener not added: Element missing for event '${ev}'. Check HTML structure or element ID.`);
                          }
                      }
                  };

                  // Sidebar Navigation
                  menuItems.forEach(item => safeAddListener(item, 'click', (e) => {
                      e.preventDefault();
                      const feature = item.dataset.feature;
                      if (feature) {
                          setActiveFeature(feature, null); // Use feature name for setActiveFeature
                      } else {
                          console.error("Menu item missing data-feature attribute:", item);
                      }
                  }));

                  // Back Button
                  safeAddListener(backButton, 'click', () => setActiveFeature('dashboard'));

                  // Browser Back/Forward
                  window.addEventListener('popstate', (event) => {
                      if (event.state?.feature) {
                          setActiveFeature(event.state.feature, event.state.tab);
                      } else {
                          // Fallback if state is missing (e.g., initial load or manual hash change)
                          handleInitialNavigation();
                      }
                  });

                  // User Dropdown Toggle
                   safeAddListener(userProfileToggle, 'click', (e) => {
                       e.stopPropagation(); // Prevent click from immediately closing dropdown via document listener
                       if (userDropdown) {
                           userDropdown.classList.toggle('active');
                           userProfileToggle.setAttribute('aria-expanded', userDropdown.classList.contains('active'));
                       }
                   });

                   // Close dropdown when clicking outside
                   safeAddListener(document, 'click', (e) => {
                       if (userDropdown && userDropdown.classList.contains('active')) {
                           // Check if the click was outside the dropdown and its toggle
                           if (!userDropdown.contains(e.target) && !userProfileToggle?.contains(e.target)) {
                               userDropdown.classList.remove('active');
                               userProfileToggle?.setAttribute('aria-expanded', 'false');
                           }
                       }
                   }, true); // Use capture phase to catch clicks early


                  // Dropdown Links (Now target elements should exist)
                  safeAddListener(profileLink, 'click', (e)=>{
                      e.preventDefault();
                      if (userDropdown) userDropdown.classList.remove('active');
                      setActiveFeature('profile');
                  });
                  safeAddListener(settingsLink, 'click', (e)=>{
                      e.preventDefault();
                      if (userDropdown) userDropdown.classList.remove('active');
                      setActiveFeature('settings');
                  });
                  safeAddListener(logoutLink, 'click', (e)=>{
                      e.preventDefault();
                      if (userDropdown) userDropdown.classList.remove('active');
                      handleLogout();
                  });

                 // Settings Tabs
                  settingsTabs.forEach(tab => {
                      safeAddListener(tab, 'click', () => {
                          if (!tab.classList.contains('disabled') && !tab.classList.contains('active')) {
                              activateSettingsTab(tab.dataset.tab);
                          }
                      });
                  });

                   // Profile Form Actions (Ensure elements exist before adding)
                   if (profileForm) safeAddListener(profileForm, 'submit', handleProfileSave);
                   if (cancelProfileChangesBtn) safeAddListener(cancelProfileChangesBtn, 'click', handleProfileCancel);
                   if (uploadPhotoButton) safeAddListener(uploadPhotoButton, 'click', () => avatarUploadInput?.click());
                   if (avatarUploadInput) safeAddListener(avatarUploadInput, 'change', handleAvatarUpload);


                  // Add other core listeners using safeAddListener as needed
                  // e.g., searchInput, notificationIcon, deleteAllActivity, etc.
                  // safeAddListener(searchInput, 'input', handleSearch);
                  // safeAddListener(notificationIcon, 'click', () => document.getElementById('notificationsModal')?.style.display = 'flex');
                  // safeAddListener(document.getElementById('closeNotifications'), 'click', () => document.getElementById('notificationsModal')?.style.display = 'none');
                  // safeAddListener(deleteAllActivity, 'click', handleDeleteAllActivities);


                  console.log("CORE dashboard listeners attached.");
             }


            // --- RUN INITIALIZATION ---
            initDashboard();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

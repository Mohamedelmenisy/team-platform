```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- ALL CSS FROM dashboard.txt REMAINS HERE --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a; /* Dark blue */
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a; /* Dark blue */
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Used for admin role title color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-light);
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--sidebar-divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            color: var(--white);
            font-size: 1.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .menu-title {
            padding: 0.75rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.5px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
        }

        .menu-item:hover {
            background-color: var(--sidebar-hover);
            color: var(--white);
        }

        .menu-item.active {
            background-color: var(--sidebar-active);
            color: var(--white);
            border-left-color: var(--white);
        }

        .menu-item i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .menu-divider {
            height: 1px;
            background-color: var(--sidebar-divider);
            margin: 1rem 1.5rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
        }

        /* Top Navigation */
        .top-nav {
            background-color: var(--white);
            padding: var(--normal-padding) 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 90;
            transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }

        .search-bar { position: relative; width: 400px; }
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background-color: var(--white);
            color: var(--dark);
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results {
            position: absolute; top: 100%; left: 0; width: 100%;
            background-color: var(--white); border: 1px solid var(--light-gray);
            border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100; display: none; max-height: 300px; overflow-y: auto;
        }
        .search-results.active { display: block; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); }
        .search-result-item:hover { background-color: var(--primary-light); }

        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge {
            position: absolute; top: -5px; right: -5px; background-color: var(--danger);
            color: white; border-radius: 50%; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 600;
        }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: 600; cursor: pointer; background-size: cover; background-position: center;
        }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--dark); }
        .user-status {
            font-size: 0.8rem;
            color: var(--success);
            margin-left: 0.5rem;
            font-weight: 600;
            text-shadow: 0 0 4px rgba(16, 185, 129, 0.4);
        }

        .user-dropdown {
            position: absolute; top: 100%; right: 0; background-color: var(--white);
            border: 1px solid var(--light-gray); border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none;
        }
        .user-dropdown.active { display: block; }
        .dropdown-item {
            padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem;
            color: var(--dark); text-decoration: none; transition: background-color 0.2s;
        }
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; }

        /* Content Area */
        .content-area {
            padding: 2rem;
            min-height: calc(100vh - 70px);
            transition: padding 0.3s ease;
        }
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }

        /* Welcome Section */
        .welcome-section {
            background-color: var(--primary-dark);
            color: var(--white); padding: 2rem;
            border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background-color 0.3s ease;
        }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }

        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        body.compact .welcome-title { font-size: 1.25rem; }

        .welcome-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.25rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}

        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }

        .user-info-avatar {
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center;
            position: relative; cursor: default;
        }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }

        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; }
        body.compact .user-info-name { font-size: 1rem; }

        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; }
        .user-info-title.role-admin { color: var(--team-manager); }
        body.compact .user-info-title { font-size: 0.8rem; }

        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }

        /* Stats Section */
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }

        .stat-card {
            background-color: var(--white); border-radius: 8px; padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative; overflow: hidden;
        }
        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0.9;
        }

        .stat-title { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { color: var(--primary); }

        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        body.compact .stat-value { font-size: 1.5rem; }

        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }

        /* Activity Section */
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }

        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        body.compact .section-title { font-size: 1.1rem; }

        .live-badge {
            display: inline-flex; align-items: center; background-color: var(--danger); color: white;
            padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;
            margin-left: 0.5rem; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }

        .activity-list { list-style: none; padding-left: 0; } /* Ensure no default padding */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity {
             background-color: rgba(37, 99, 235, 0.08);
             animation: highlightNewActivity 2.5s ease-out forwards;
        }
        @keyframes highlightNewActivity {
            0% { background-color: rgba(37, 99, 235, 0.15); }
            100% { background-color: transparent; }
        }

        .activity-icon {
            width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s;
        }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }

        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--dark); }
        body.compact .activity-message { font-size: 0.9rem; }

        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }

        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 1; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; }
        .delete-activity:hover { background-color: rgba(239, 68, 68, 0.1); }

        /* Generic Content Sections (Profile, Settings, Features) */
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        .content-section.active { display: block; }
        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }

        /* Section Headers (used in Profile, Settings, Features) */
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; }
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }

        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }

        /* --- Profile Section Specific Styles --- */
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge {
            width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light);
            color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 3rem; background-size: cover; background-position: center;
            margin-bottom: 1rem;
            border: 3px solid var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #uploadPhotoButton { margin-top: 0.5rem;}

        /* Forms (Profile, Settings) */
        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }

        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }

        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); transition: margin-bottom 0.3s ease, font-size 0.3s ease; }
        body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }

        .form-control {
            width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px;
            font-size: 1rem; background-color: var(--white); color: var(--dark);
            transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }

        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Settings Content Specifics */
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }

        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }

        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* Team Management Panel */
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--dark); margin-bottom: 1rem; }

        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }

        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }

        .member-avatar {
            width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray);
            margin-right: 1rem; display: flex; align-items: center; justify-content: center;
            font-weight: 600; background-size: cover; background-position: center;
            color: var(--primary-dark);
            transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s;
            flex-shrink: 0;
        }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }

        .member-details { flex: 1; min-width: 0; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-email { font-size: 0.8rem; }

        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; }
        body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }

        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        /* Add Member Form */
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }

        /* Theme Classes */
        body.light-theme {
            --primary-light: #f1f5f9;
            --light: #ffffff;
            --white: #ffffff;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            background-color: var(--primary-light);
        }
        body.dark-theme {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --primary-light: #1e293b;
            --light: #334155;
            --white: #0f172a;
            --dark: #e2e8f0;
            --gray: #94a3b8;
            --light-gray: #334155;
            background-color: var(--white);
        }
        body.dark-theme .top-nav { background-color: var(--primary-light); border-bottom-color: var(--light-gray); }
        body.dark-theme .stat-card,
        body.dark-theme .activity-section,
        body.dark-theme .content-section,
        body.dark-theme .team-member-card,
        body.dark-theme .add-member-form,
        body.dark-theme #featureSections .schedule-controls, /* Dark theme schedule */
        body.dark-theme #featureSections .schedule-container,
        body.dark-theme #featureSections .schedule-table tbody td,
        body.dark-theme #featureSections .employee-name,
        body.dark-theme #featureSections .modal-content
        { background-color: var(--primary-light); }

         /* Adjust hover/specific backgrounds for dark theme schedule */
        body.dark-theme #featureSections .schedule-table tbody tr:hover td,
        body.dark-theme #featureSections .schedule-table tbody tr:hover .employee-name
        { background-color: var(--light); } /* Use lighter dark for hover */
        body.dark-theme #featureSections .employee-name { border-right-color: var(--light-gray); }

        body.dark-theme .search-bar input,
        body.dark-theme .form-control,
        body.dark-theme #featureSections .form-control /* Dark theme forms */
         { background-color: var(--light); border-color: var(--light-gray); color: var(--dark); }

        body.dark-theme .form-control[readonly],
        body.dark-theme #featureSections .form-control[readonly]
        { background-color: #293548; } /* Slightly darker readonly */

        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item:hover { background-color: var(--light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .confirm-container { background-color: var(--light); }
        body.dark-theme .theme-option div { border-color: var(--light-gray); }
        body.dark-theme .theme-option[data-theme="dark"] div { border-color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--light); }
        body.dark-theme .notifications-footer { background-color: var(--primary-light); }
        body.dark-theme .welcome-section { background-color: var(--primary-dark); color: var(--dark); } /* Use dark text on dark blue */
         body.dark-theme .user-info-title { color: var(--gray); } /* Lighter gray */
         body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email { color: var(--gray); }
        body.dark-theme .welcome-subtitle { color: var(--gray); }
        body.dark-theme #featureSections .toast { background-color: var(--light); color: var(--dark); border-left-color: var(--primary); } /* Adjust toast for dark */
        body.dark-theme #featureSections .toast.toast-success { border-left-color: var(--success); background-color: var(--light); color: var(--success); }
        body.dark-theme #featureSections .toast.toast-danger { border-left-color: var(--danger); background-color: var(--light); color: var(--danger); }

        body.blue-theme {
            --primary-light: #dbeafe;
            --light: #f8fafc; /* Use light from root */
            --white: #ffffff;
            --dark: #1e293b;
            background-color: var(--primary-light);
        }
         body.blue-theme #featureSections .schedule-controls, /* Ensure default theme backgrounds */
         body.blue-theme #featureSections .schedule-container,
         body.blue-theme #featureSections .schedule-table tbody td,
         body.blue-theme #featureSections .employee-name,
         body.blue-theme #featureSections .modal-content,
         body.blue-theme #featureSections .form-control
         { background-color: var(--white); }
         body.blue-theme #featureSections .schedule-table tbody tr:hover td,
         body.blue-theme #featureSections .schedule-table tbody tr:hover .employee-name
         { background-color: var(--light); }
         body.blue-theme #featureSections .employee-name { border-right-color: var(--light-gray); }
         body.blue-theme #featureSections .form-control[readonly] { background-color: var(--light-gray); }


        /* Theme Selection Options */
        .theme-option { display: flex; flex-direction: column; align-items: center; }
        .theme-option div {
            width: 60px; height: 40px;
            border: 2px solid var(--light-gray); border-radius: 6px; cursor: pointer;
            transition: border-color 0.2s;
        }
        .theme-option span { text-align: center; display: block; margin-top: 0.5rem; font-size: 0.9rem; color: var(--dark); }
        .theme-option:hover div { border-color: var(--primary); }
        .theme-option.selected div { border-color: var(--primary); border-width: 3px; }

        /* Notifications Modal */
        .notifications-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end;
        }
        .notifications-container {
            width: 400px; max-width: 100%; background-color: var(--white); height: 100vh;
            overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }

        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: center; cursor: pointer; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.05); font-weight: 500; }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s; margin-left: auto; padding: 0.5rem; flex-shrink: 0; }
        .delete-notification:hover { opacity: 1; }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }

        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .confirm-container {
            background-color: var(--white); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px;
            max-width: 90%; padding: 2rem;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }

        /* Success Message */
        .success-message {
            position: fixed; top: 20px; right: 20px; background-color: var(--success);
            color: white; padding: 1rem 1.5rem; border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex;
            align-items: center; gap: 0.75rem; z-index: 1200;
            transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; }
            .search-bar { width: 250px; }
            .team-member-card { flex-wrap: wrap; }
             #featureSections .schedule-controls { justify-content: center; }
        }
        @media (max-width: 768px) {
            .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; }
            .search-bar { width: 100%; order: 2; }
            .user-menu { width: 100%; justify-content: space-between; order: 1; }
            .content-area { padding: 1.5rem; }
            .data-form { grid-template-columns: 1fr; }
            .form-actions { grid-column: span 1; }
            .user-info { flex-direction: column; text-align: center; }
            .user-info-avatar { margin-bottom: 1rem; }
            .stats-section { grid-template-columns: 1fr; }
            .settings-tabs { flex-wrap: wrap; }
            .settings-tab { padding: 0.5rem 1rem; }
            .confirm-container { width: 90%; }
            .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .member-role { margin: 0.5rem 0; }
            .member-actions { margin-top: 0.5rem; }
            .profile-avatar-section { margin-bottom: 1.5rem; }
            #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
             /* Schedule specific responsive */
             #featureSections .main-container { padding: 0 1rem; margin-top: 1rem;}
             #featureSections .page-header { margin-bottom: 1.5rem; }
             #featureSections .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
             #featureSections .week-navigation { justify-content: space-between; width: 100%;}
             #featureSections .employee-name { position: static; border-right: none; background-color: var(--light); padding: 0.5rem; font-size: 0.9rem; }
             body.dark-theme #featureSections .employee-name { background-color: var(--light); } /* Ensure dark theme bg */
             #featureSections .schedule-table thead th { position: static; }
             #featureSections .schedule-table { min-width: auto; }
             #featureSections .schedule-table tbody td { padding: 0.5rem 0.25rem; font-size: 0.8rem; }
             #featureSections .shift { font-size: 0.7rem; padding: 0.2rem 0.4rem; min-width: 50px; }
             #featureSections .edit-shift { font-size: 0.7rem; }
             #featureSections .modal-content { padding: 1.5rem; }
             #featureSections .modal-title { font-size: 1.2rem; }
        }
        @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
             /* Schedule specific responsive */
              #featureSections .page-title { font-size: 1.5rem; }
              #featureSections .btn { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
              #featureSections .week-display { font-size: 0.9rem; min-width: 140px; }
              #featureSections .day-header { gap: 0; }
              #featureSections .day-name { font-size: 0.8rem; }
              #featureSections .day-date { font-size: 0.7rem; }
        }

        /* Back button Styles */
        .back-button {
            display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary);
            font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem;
            border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent;
            font-size: 0.9rem;
        }
        .back-button:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }

        /* Notification sound */
        #notificationSound { display: none; }

        /* Helper class */
        .d-none { display: none !important; }

        /* Connection status in sidebar */
        .connection-status {
            padding: 0.75rem 1.5rem;
            margin-top: auto;
            border-top: 1px solid var(--sidebar-divider);
            display: flex; align-items: center; gap: 0.5rem;
            color: rgba(16, 185, 129, 0.9);
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--success); animation: pulseStatus 2s infinite;
        }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* Password error message */
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }

        /* Loading spinner */
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }

         /* Placeholder styling */
        .placeholder-content {
            text-align: center; padding: 4rem 2rem; color: var(--gray);
            border: 2px dashed var(--light-gray); border-radius: 8px;
            margin-top: 2rem; min-height: 300px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; }

    </style>
</head>
<body class="blue-theme"> <!-- Default theme, JS will override based on prefs -->
    <!-- HTML Structure -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <span id="successMessageText">Action successful!</span>
    </div>
    <aside class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
        </div>
        <!-- Sidebar Menu -->
        <div class="sidebar-menu">
            <div class="menu-title">Navigation</div>
            <a href="#dashboard" class="menu-item active" data-feature="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
            <a href="#projects" class="menu-item" data-feature="projects"><i class="fas fa-briefcase"></i><span>Projects</span></a>
            <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"><i class="fas fa-chart-line"></i><span>Reports & Analytics</span></a>
            <a href="#team-members-view" class="menu-item" data-feature="team-members-view"><i class="fas fa-users"></i><span>Team Members</span></a>
            <div class="menu-title">Core Features</div>
            <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
            <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
            <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
            <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
            <div class="menu-title">Team Tools</div>
            <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
            <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
            <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
            <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
            <div class="menu-divider"></div>
            <a href="#settings" class="menu-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
        </div>
        <!-- Connection Status -->
        <div class="connection-status"><div class="status-dot"></div><span>Online</span></div>
    </aside>
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="user-menu">
                <div class="notification-icon" id="notificationIcon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span>
                </div>
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">ME</div>
                    <div class="user-profile-details">
                        <span class="user-name" id="userName">Mohamed Elmenisy</span>
                        <span class="user-status"> • Connected</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#profile" class="dropdown-item" id="profileLink"><i class="fas fa-user"></i><span>Profile</span></a>
                        <a href="#settings" class="dropdown-item" id="settingsLink"><i class="fas fa-cog"></i><span>Settings</span></a>
                        <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                    </div>
                </div>
            </div>
        </nav>
        <!-- Content Area -->
        <div class="content-area">
             <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>
             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">Mohamed</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">ME</div>
                         <div class="user-info-details">
                             <div class="user-info-name">Mohamed Elmenisy</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Administrator</div>
                             <div class="user-info-email"><i class="fas fa-envelope"></i><span id="userEmail">m.elsayed@thechefz.co</span></div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section">
                     <div class="stat-card"><div class="stat-title"><i class="fas fa-users"></i>Team Members</div><div class="stat-value"><span id="teamMembersCount">0</span><span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                     <div class="stat-card"><div class="stat-title"><i class="fas fa-check-circle"></i>Tasks Completed</div><div class="stat-value"><span id="tasksCompleted">0</span><span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                     <div class="stat-card"><div class="stat-title"><i class="fas fa-project-diagram"></i>Active Projects</div><div class="stat-value"><span id="activeProjects">0</span><span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                     <div class="stat-card"><div class="stat-title"><i class="fas fa-calendar-times"></i>Upcoming Deadlines</div><div class="stat-value"><span id="upcomingDeadlines">0</span><span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header"><h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3><div><span class="view-all" id="viewAllActivity" style="display: none;">Show All</span><span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span></div></div>
                     <ul class="activity-list" id="activityList"><li style="text-align: center; padding: 2rem; color: var(--gray);">Loading activities...</li></ul>
                 </div>
             </div>
             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                  <div class="section-main-header"><h2 class="section-main-title">Profile</h2></div>
                  <p class="profile-header-text">Your personal information and account security settings.</p>
                  <div class="profile-avatar-section">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark);">Avatar</label>
                      <div id="profileAvatarLarge">ME</div>
                      <button type="button" class="btn btn-outline btn-sm" id="uploadPhotoButton"><i class="fas fa-upload"></i> Upload Photo</button>
                      <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                  </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" class="form-control" value="Mohamed"></div>
                     <div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" class="form-control" value="Elmenisy"></div>
                     <div class="form-group" style="grid-column: span 2;"><label for="fullNameDisplay">Full Name</label><input type="text" id="fullNameDisplay" class="form-control" value="Mohamed Elmenisy" readonly></div>
                     <div class="form-group"><label for="jobTitle">Job Title</label><input type="text" id="jobTitle" class="form-control" value="Administrator"></div>
                     <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" value="m.elsayed@thechefz.co" readonly></div>
                     <div class="form-group"><label for="phone">Phone Number</label><input type="tel" id="phone" class="form-control" value="+201234567890"></div>
                     <div class="form-group"><label for="department">Department</label><input type="text" id="department" class="form-control" value="Management"></div>
                     <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div>
                 </form>
             </div>
             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"><h2 class="section-main-title">System Settings</h2></div>
                 <div class="settings-tabs">
                     <div class="settings-tab active" data-tab="preferences">Preferences</div><div class="settings-tab" data-tab="account">Account</div><div class="settings-tab" data-tab="security">Security</div><div class="settings-tab" data-tab="notifications">Notifications</div><div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div><div class="settings-tab" data-tab="collaboration">Collaboration</div><div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>
                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                      <h3 class="section-title">Preferences</h3>
                      <form class="data-form" id="preferencesForm">
                          <div class="form-group"><label>Theme</label><div style="display: flex; gap: 1rem; margin-top: 0.5rem;"><div class="theme-option" data-theme="light"><div style="background-color: #f1f5f9;"></div><span>Light</span></div><div class="theme-option" data-theme="dark"><div style="background-color: #0f172a;"></div><span>Dark</span></div><div class="theme-option selected" data-theme="blue"><div style="background-color: #dbeafe;"></div><span>Blue</span></div></div><input type="hidden" id="selectedTheme" value="blue"></div>
                          <div class="form-group"><label for="layoutDensity">Layout Density</label><select id="layoutDensity" class="form-control"><option value="compact">Compact</option><option value="normal" selected>Normal</option><option value="spacious">Spacious</option></select></div>
                          <div class="form-group"><label for="language">Language</label><select id="language" class="form-control"><option value="en" selected>English</option><option value="ar">Arabic (Placeholder)</option><option value="es">Spanish (Placeholder)</option></select></div>
                          <div class="form-group"><label for="dateFormat">Date Format</label><select id="dateFormat" class="form-control"><option value="mm/dd/yyyy">MM/DD/YYYY</option><option value="dd/mm/yyyy" selected>DD/MM/YYYY</option><option value="yyyy-mm-dd">YYYY-MM-DD</option></select></div>
                          <div class="form-group"><label for="region">Region</label><input type="text" id="region" class="form-control" placeholder="Cairo (Placeholder)" disabled></div>
                          <div class="form-group"><label for="weekStart">Calendar Week Start</label><select id="weekStart" class="form-control"><option value="sun" selected>Sunday</option></select></div>
                          <div class="form-group" style="grid-column: span 2;"><label for="defaultHomepage">Default Homepage (Placeholder)</label><select id="defaultHomepage" class="form-control" disabled><option selected>Dashboard</option><option>Tasks</option><option>Calendar</option></select></div>
                          <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelPreferencesBtn">Cancel</button><button type="submit" class="btn btn-primary" id="savePreferencesBtn"><span class="btn-text">Save Preferences</span><div class="spinner" id="preferencesSpinner"></div><span class="loading-text" id="preferencesLoadingText">Saving...</span></button></div>
                     </form>
                 </div>
                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                     <h3 class="section-title">Account Settings</h3>
                     <form class="data-form" id="accountForm">
                         <div class="form-group"><label for="acc_firstName">First Name</label><input type="text" id="acc_firstName" class="form-control" readonly></div>
                         <div class="form-group"><label for="acc_lastName">Last Name</label><input type="text" id="acc_lastName" class="form-control" readonly></div>
                         <div class="form-group"><label for="acc_email">Email</label><input type="email" id="acc_email" class="form-control" readonly></div>
                         <div class="form-group"><label for="timezone">Timezone</label><select id="timezone" class="form-control"><option value="utc">UTC</option><option value="cairo" selected>Cairo (UTC+2)</option><option value="new_york">New York (UTC-5)</option></select></div>
                         <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelAccountBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveAccountBtn"><span class="btn-text">Save Settings</span><div class="spinner" id="accountSpinner"></div><span class="loading-text" id="accountLoadingText">Saving...</span></button></div>
                         <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"><label style="color: var(--danger);">Account Deletion</label><p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 1rem;">Permanently delete your account and all associated data. This action cannot be undone.</p><button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled>Delete Account (Placeholder)</button></div>
                     </form>
                 </div>
                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                      <h3 class="section-title">Security Settings</h3>
                     <form class="data-form" id="securityForm">
                         <div class="form-group" style="grid-column: span 2;"><label>Two-Factor Authentication (2FA)</label><div style="display: flex; align-items: center; gap: 1rem;"><label class="switch"><input type="checkbox" id="twoFactorAuth" checked><span class="slider round"></span></label><span>Enabled</span></div><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">Requires authentication code from your app upon login.</p></div>
                         <div class="form-group"><label for="currentPassword">Current Password</label><input type="password" id="currentPassword" class="form-control" autocomplete="current-password"><div class="password-error" id="currentPasswordError">Current password is incorrect</div></div>
                         <div class="form-group"><label for="newPassword">New Password</label><input type="password" id="newPassword" class="form-control" autocomplete="new-password"><small style="color: var(--gray);">Minimum 8 characters required.</small></div>
                         <div class="form-group"><label for="confirmPassword">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" autocomplete="new-password"><div class="password-error" id="passwordMatchError">Passwords do not match</div></div>
                         <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelSecurityBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveSecurityBtn"><span class="btn-text">Update Password</span><div class="spinner" id="securitySpinner"></div><span class="loading-text" id="securityLoadingText">Updating...</span></button></div>
                         <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"><label>Integrations (Placeholders)</label><div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"><span>Slack Integration</span><button class="btn btn-outline" disabled>Connect</button></div><div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"><span>Single Sign-On (SSO)</span><button class="btn btn-outline" disabled>Configure</button></div></div>
                     </form>
                 </div>
                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <h3 class="section-title">Notification Settings</h3>
                     <form class="data-form" id="notificationsForm">
                         <div class="form-group"><label>Email Notifications</label><div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"><div style="display: flex; align-items: center; justify-content: space-between;"><span>Task Assignments & Updates</span><label class="switch"><input type="checkbox" id="emailTasks" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Deadline Reminders</span><label class="switch"><input type="checkbox" id="emailDeadlines" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>System Updates & Announcements</span><label class="switch"><input type="checkbox" id="emailUpdates"><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Weekly Summary (Placeholder)</span><label class="switch"><input type="checkbox" id="emailSummary" disabled><span class="slider round"></span></label></div></div></div>
                         <div class="form-group"><label>In-App Push Notifications</label><div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"><div style="display: flex; align-items: center; justify-content: space-between;"><span>New Messages & Mentions</span><label class="switch"><input type="checkbox" id="pushMessages" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Team & Project Updates</span><label class="switch"><input type="checkbox" id="pushTeamUpdates"><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Sound Notifications</span><label class="switch"><input type="checkbox" id="soundNotifications" checked><span class="slider round"></span></label></div></div></div>
                         <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelNotificationsBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveNotificationsBtn"><span class="btn-text">Save Settings</span><div class="spinner" id="notificationsSpinner"></div><span class="loading-text" id="notificationsLoadingText">Saving...</span></button></div>
                     </form>
                 </div>
                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                     <div class="team-management">
                         <h3>Team Members</h3>
                         <div class="team-list" id="teamList"><div style="text-align: center; padding: 2rem; color: var(--gray);">Loading team members...</div></div>
                         <div class="add-member-form">
                             <h4>Invite New Member</h4>
                             <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                 <div class="form-group" style="margin-bottom: 0;"><label for="inviteMemberEmail">Email</label><input type="email" id="inviteMemberEmail" class="form-control" placeholder="user@example.com" required></div>
                                 <div class="form-group" style="margin-bottom: 0;"><label for="inviteMemberRole">Role</label><select id="inviteMemberRole" class="form-control" required><option value="member">Member</option><option value="senior">Senior</option><option value="supervisor">Supervisor</option><option value="admin">Admin</option></select></div>
                                 <div style="grid-column: 1 / -1; margin-top: 1rem;"><button type="submit" class="btn btn-primary">Send Invite</button></div>
                             </form>
                         </div>
                     </div>
                 </div>
                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                     <h3 class="section-title">Collaboration Settings</h3>
                     <form class="data-form" id="collaborationForm">
                         <div class="form-group" style="grid-column: span 2;"><label>Shared Calendar Access (Placeholder)</label><p style="color: var(--gray); font-size: 0.9rem;">Control who can view or edit the team calendar.</p><button type="button" class="btn btn-outline" disabled>Manage Permissions</button></div>
                         <div class="form-group" style="grid-column: span 2;"><label>Team Chat Integration (Placeholder)</label><p style="color: var(--gray); font-size: 0.9rem;">Connect to your preferred team chat platform.</p><button type="button" class="btn btn-outline" disabled>Configure Chat</button></div>
                         <div class="form-actions"><button type="button" class="btn btn-outline" disabled>Cancel</button><button type="submit" class="btn btn-primary" disabled>Save Collaboration Settings</button></div>
                     </form>
                 </div>
                 <!-- Danger Zone Panel -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3>
                     <p style="color: var(--gray);">Actions in this section are permanent and cannot be undone. (Visible to Admins only)</p>
                     <div style="margin-top: 1.5rem; border: 1px solid var(--danger); border-radius: 6px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;">
                         <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Delete Team Data (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete all projects, tasks, and files.</p></div><button class="btn btn-danger" disabled>Delete All Team Data</button></div>
                         <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Transfer Ownership (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Transfer administrative control to another user.</p></div><button class="btn btn-warning" disabled>Transfer Ownership</button></div>
                         <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Delete Workspace (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete this entire workspace.</p></div><button class="btn btn-danger" disabled>Delete Workspace</button></div>
                     </div>
                 </div>
             </div>
             <!-- Feature Content Sections Container -->
             <div id="featureSectionsContainer" style="display: none;">
                 <div id="featureSections" class="content-section">
                     <div class="placeholder-content" id="featurePlaceholder">
                         <h2 id="featureTitle">Feature Content Area</h2>
                         <p id="featureDescription">Select a feature from the sidebar.</p>
                         <div class="loading-indicator" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                         <div class="error-message" style="display: none;">Failed to load content.</div>
                     </div>
                 </div>
             </div>
        </div>
    </main>
    <!-- Notifications Modal -->
    <div class="notifications-modal" id="notificationsModal">
        <div class="notifications-container">
            <div class="notifications-header"><h3 class="notifications-title">Notifications</h3><button class="close-notifications" id="closeNotifications">&times;</button></div>
            <div class="notifications-body" id="notificationsBody"><div class="no-notifications-message">Loading notifications...</div></div>
            <div class="notifications-footer"><button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button><button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button></div>
        </div>
    </div>
    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-container">
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
            <div class="confirm-message" id="confirmMessage">Are you sure?</div>
            <div class="confirm-actions"><button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button><button class="btn btn-danger" id="confirmBtn">Confirm</button></div>
        </div>
    </div>

    <script>
        // ======================================================
        // == START: Employee Schedule Specific JavaScript ==
        // ======================================================
        function initializeEmployeeSchedule(currentUserData, teamMembersData) {
            console.log("Initializing Employee Schedule...");
            // More robust container selection
            const featureContentArea = document.getElementById('featureSections');
            if (!featureContentArea) {
                console.error("Feature content area (#featureSections) not found!");
                return;
            }
            const container = featureContentArea.querySelector('#employeeScheduleContainer');
            if (!container) {
                console.error("Employee schedule container (#employeeScheduleContainer) not found within #featureSections!");
                const ph = featureContentArea.querySelector('#featurePlaceholder');
                const phError = ph?.querySelector('.error-message');
                if (ph) ph.style.display = 'flex';
                if (phError) { phError.textContent = 'Schedule container missing.'; phError.style.display = 'block'; }
                return;
            }
            console.log("Schedule container found:", container);

            // --- DOM Elements ---
            const employeeModal = container.querySelector('#employeeModal');
            const shiftModal = container.querySelector('#shiftModal');
            const addEmployeeBtn = container.querySelector('#addEmployeeBtn');
            const sendRemindersBtn = container.querySelector('#sendRemindersBtn');
            const closeEmployeeModal = container.querySelector('#closeEmployeeModal');
            const closeShiftModal = container.querySelector('#closeShiftModal');
            const cancelEmployeeBtn = container.querySelector('#cancelEmployeeBtn');
            const cancelShiftBtn = container.querySelector('#cancelShiftBtn');
            const employeeForm = container.querySelector('#employeeForm');
            const shiftForm = container.querySelector('#shiftForm');
            const shiftTypeSelect = container.querySelector('#shiftType');
            const customShiftGroup = container.querySelector('#customShiftGroup');
            const prevWeekBtn = container.querySelector('#prevWeekBtn');
            const nextWeekBtn = container.querySelector('#nextWeekBtn');
            const weekDisplay = container.querySelector('#weekDisplay');
            const saveScheduleBtn = container.querySelector('#saveScheduleBtn');
            const scheduleTableBody = container.querySelector('#scheduleTableBody');
            const shiftDateInput = container.querySelector('#shiftDate');
            const toastNotification = container.querySelector('#scheduleToastNotification');
            const editEmpIdInput = container.querySelector('#editEmpId');
            const editDayInput = container.querySelector('#editDay');
            const editCellIdInput = container.querySelector('#editCellId');
            const shiftEmployeeDisplayInput = container.querySelector('#shiftEmployeeDisplay');

            // --- Error Check ---
            if (!employeeModal || !shiftModal || !scheduleTableBody || !toastNotification || !shiftForm || !employeeForm || !weekDisplay) {
                console.error("Initialization failed: Critical schedule element missing.", { employeeModal, shiftModal, scheduleTableBody, toastNotification, shiftForm, employeeForm, weekDisplay });
                 const ph = featureContentArea.querySelector('#featurePlaceholder');
                 const phError = ph?.querySelector('.error-message');
                 if (ph) ph.style.display = 'flex';
                 if (phError) { phError.textContent = 'Essential schedule components missing.'; phError.style.display = 'block'; }
                return;
            }
            console.log("All critical schedule elements found.");

            // --- State & Data ---
            let currentUser = currentUserData;
            let employees = Array.isArray(teamMembersData)
                ? teamMembersData.map(member => ({ id: member.id, name: member.name, email: member.email, role: member.role }))
                : [];
            let scheduleData = JSON.parse(localStorage.getItem('scheduleData')) || {
                "1-mon": { type: "morning", text: "9AM-5PM", notes: "" }, "1-tue": { type: "morning", text: "9AM-5PM", notes: "" }, "1-wed": { type: "afternoon", text: "12PM-8PM", notes: "" }, "1-thu": { type: "morning", text: "9AM-5PM", notes: "" }, "1-fri": { type: "day-off", text: "OFF", notes: "" }, "1-sat": { type: "night", text: "5PM-1AM", notes: "" }, "1-sun": { type: "night", text: "5PM-1AM", notes: "" },
                "2-mon": { type: "afternoon", text: "12PM-8PM", notes: "" }, "2-tue": { type: "morning", text: "9AM-5PM", notes: "" }, "2-wed": { type: "morning", text: "9AM-5PM", notes: "" }, "2-thu": { type: "afternoon", text: "12PM-8PM", notes: "" }, "2-fri": { type: "morning", text: "9AM-5PM", notes: "" }, "2-sat": { type: "day-off", text: "OFF", notes: "" }, "2-sun": { type: "day-off", text: "OFF", notes: "" },
                "3-mon": { type: "night", text: "5PM-1AM", notes: "" }, "3-tue": { type: "night", text: "5PM-1AM", notes: "" }, "3-wed": { type: "day-off", text: "OFF", notes: "" }, "3-thu": { type: "morning", text: "9AM-5PM", notes: "" }, "3-fri": { type: "afternoon", text: "12PM-8PM", notes: "" }, "3-sat": { type: "morning", text: "9AM-5PM", notes: "" }, "3-sun": { type: "sick-leave", text: "SICK", notes: "" },
                "4-mon": { type: "vacation", text: "VAC", notes: "" }, "4-tue": { type: "vacation", text: "VAC", notes: "" }, "4-wed": { type: "morning", text: "9AM-5PM", notes: "" }, "4-thu": { type: "night", text: "5PM-1AM", notes: "" }, "4-fri": { type: "night", text: "5PM-1AM", notes: "" }, "4-sat": { type: "day-off", text: "OFF", notes: "" }, "4-sun": { type: "morning", text: "9AM-5PM", notes: "" },
            };
            function saveScheduleData() { localStorage.setItem('scheduleData', JSON.stringify(scheduleData)); }
            let currentWeekStart = getStartOfWeek(new Date());
            const minDate = new Date(currentWeekStart.getFullYear() - 1, 0, 1);
            const maxDate = new Date(currentWeekStart.getFullYear() + 1, 11, 31);

            // --- Helper Functions ---
            function showToast(message, type = 'success') {
                if (!toastNotification) { console.warn("Toast element not found."); return; }
                toastNotification.textContent = message;
                toastNotification.className = 'toast';
                toastNotification.classList.add(type === 'danger' ? 'toast-danger' : 'toast-success'); // Use type for class
                toastNotification.classList.add('show');
                if (toastNotification.timerId) clearTimeout(toastNotification.timerId);
                toastNotification.timerId = setTimeout(() => { toastNotification.classList.remove('show'); toastNotification.timerId = null; }, 3000);
            }

            function getStartOfWeek(date) {
                const dt = new Date(date);
                const weekStartDay = currentUserData?.preferences?.weekStart === 'sun' ? 0 : 0;
                const dayOfWeek = dt.getDay();
                const diff = dt.getDate() - dayOfWeek + (dayOfWeek < weekStartDay ? weekStartDay - 7 : weekStartDay);
                dt.setDate(diff); dt.setHours(0, 0, 0, 0);
                return dt;
            }

            // --- Core Logic ---
            function renderSchedule() {
                console.log("Rendering schedule for week:", currentWeekStart.toDateString());
                if (!scheduleTableBody) { console.error("Schedule table body missing."); return; }
                scheduleTableBody.innerHTML = '';
                updateWeekDisplayAndHeaders();

                if (employees.length === 0) {
                    const r = scheduleTableBody.insertRow(); const c = r.insertCell();
                    c.colSpan = 8; c.textContent = "No employees found."; Object.assign(c.style, { textAlign: 'center', padding: '2rem', color: 'var(--gray)' });
                    applyRolePermissions(); return;
                }

                employees.forEach(emp => {
                    if (!emp?.id || !emp.name) { console.warn("Skipping invalid emp data:", emp); return; }
                    const row = scheduleTableBody.insertRow();
                    row.insertCell().outerHTML = `<td class="employee-name">${emp.name}</td>`;
                    ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                        const cell = row.insertCell(); cell.className = "admin-controls";
                        cell.dataset.emp = emp.id; cell.dataset.day = day; cell.id = `cell-${emp.id}-${day}-${currentWeekStart.getTime()}`;
                        const shiftKey = `${emp.id}-${day}`; const shiftInfo = scheduleData[shiftKey];
                        const editSpan = document.createElement('span'); editSpan.className = 'edit-shift'; editSpan.textContent = '(edit)'; editSpan.style.display = 'none';
                        if (shiftInfo) cell.appendChild(createShiftDiv(shiftInfo.type, shiftInfo.text));
                        cell.appendChild(editSpan);
                    });
                });
                setupEditShiftListeners(); applyRolePermissions(); console.log("Schedule render complete.");
            }

            function createShiftDiv(type, text) {
                const d = document.createElement('div'); d.className = 'shift'; d.textContent = text || '';
                const map = {'morning':'shift-morning','afternoon':'shift-afternoon','night':'shift-night','day-off':'day-off','sick-leave':'sick-leave','vacation':'vacation','custom':'shift-morning'};
                d.classList.add(map[type] || 'shift-morning'); return d;
            }

            function updateWeekDisplayAndHeaders() {
                if (!weekDisplay) return;
                const end = new Date(currentWeekStart); end.setDate(end.getDate() + 6);
                const opts = { month: 'short', day: 'numeric' }; const lang = currentUserData?.preferences?.language || 'en-US';
                weekDisplay.textContent = `${currentWeekStart.toLocaleDateString(lang, opts)} - ${end.toLocaleDateString(lang, opts)}, ${currentWeekStart.getFullYear()}`;
                const dateCells = container.querySelectorAll('.day-date'); const nameCells = container.querySelectorAll('.day-name');
                const temp = new Date(currentWeekStart); const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                dateCells.forEach((c, i) => { if (i<days.length) { c.textContent = temp.toLocaleDateString(lang, opts); if(nameCells[i]) nameCells[i].textContent=days[i]; temp.setDate(temp.getDate()+1); } });
                const prev = new Date(currentWeekStart); prev.setDate(prev.getDate()-7); if(prevWeekBtn) prevWeekBtn.disabled = prev < minDate;
                const nextEnd = new Date(end); nextEnd.setDate(nextEnd.getDate()+1); if(nextWeekBtn) nextWeekBtn.disabled = nextEnd > maxDate;
            }

            function applyRolePermissions() {
                const canManage = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';
                if(addEmployeeBtn) addEmployeeBtn.style.display = canManage ? 'inline-flex' : 'none';
                if(sendRemindersBtn) sendRemindersBtn.style.display = canManage ? 'inline-flex' : 'none';
                if(saveScheduleBtn) saveScheduleBtn.style.display = canManage ? 'inline-flex' : 'none';
                container.querySelectorAll('.edit-shift').forEach(el => el.style.display = canManage ? 'inline' : 'none');
            }

            // --- Event Listener Setup ---
            let scheduleBodyClickListener = null; // Store listener reference
            function setupEditShiftListeners() {
                 if (!scheduleTableBody) return;
                 // Remove old listener before adding new one
                 if (scheduleBodyClickListener) {
                     scheduleTableBody.removeEventListener('click', scheduleBodyClickListener);
                      console.log("Removed previous schedule table body listener.");
                 }
                 scheduleBodyClickListener = handleTableBodyClick; // Assign new handler
                 scheduleTableBody.addEventListener('click', scheduleBodyClickListener);
                 console.log("Added schedule table body listener.");
             }
             // Function to remove the listener (call when feature is deactivated)
             window.cleanupScheduleListeners = function() {
                 if (scheduleTableBody && scheduleBodyClickListener) {
                     scheduleTableBody.removeEventListener('click', scheduleBodyClickListener);
                     scheduleBodyClickListener = null;
                     console.log("Cleaned up schedule table body listener.");
                 }
                  // Remove other listeners specific to the schedule section if needed
             };

            function handleTableBodyClick(event) { if (event.target.classList.contains('edit-shift')) handleEditShiftClick(event.target); }

            function handleEditShiftClick(buttonElement) {
                if (!buttonElement) return;
                const cell = buttonElement.closest('td.admin-controls'); if (!cell) { console.error("No parent cell."); return; }
                const empId = parseInt(cell.dataset.emp); const day = cell.dataset.day; const cellId = cell.id;
                if (isNaN(empId) || !day) { console.error("Invalid cell data."); return; }
                if (!shiftModal || !shiftEmployeeDisplayInput || !editEmpIdInput || !editDayInput || !editCellIdInput || !shiftDateInput || !shiftTypeSelect || !customShiftGroup) { console.error("Shift modal elements missing."); return; }
                const employee = employees.find(e => e.id === empId); const days = ['mon','tue','wed','thu','fri','sat','sun']; const dayIndex = days.indexOf(day);
                if (employee && dayIndex !== -1) {
                    const date = new Date(currentWeekStart); date.setDate(date.getDate() + dayIndex);
                    shiftEmployeeDisplayInput.value = employee.name || 'N/A'; editEmpIdInput.value = empId; editDayInput.value = day; editCellIdInput.value = cellId;
                    shiftDateInput.value = date.toISOString().split('T')[0];
                    const key = `${empId}-${day}`; const info = scheduleData[key];
                    const type = info?.type || 'clear'; const custom = (info?.type === 'custom' ? info.text : ''); const notes = info?.notes || '';
                    shiftTypeSelect.value = type; customShiftGroup.style.display = type === 'custom' ? 'block' : 'none';
                    container.querySelector('#customShift').value = custom; container.querySelector('#shiftNotes').value = notes;
                    shiftModal.style.display = 'flex';
                } else { console.error(`Employee ${empId} or day ${day} not found.`); }
            }

            function addEmployeeToSystem(name, email, role) {
                if (!name || !email || !email.includes('@') || !role) { showToast('Name, valid email, and role required.', 'danger'); return false; }
                if (teamMembersData.some(m => m.email.toLowerCase() === email.toLowerCase())) { showToast('Email already exists in main list.', 'danger'); return false; }

                // --- Integration Point: Update main dashboard data ---
                 const newId = teamMembersData.length > 0 ? Math.max(0, ...teamMembersData.map(m => m.id)) + 1 : 1; // Safer ID generation
                 const newMember = { id: newId, name, email, role, initials: name.split(' ').map(n=>n[0]).join('') };

                 // 1. Update the main teamMembers array in the *dashboard's* scope
                 // (We need access to the dashboard's 'teamMembers' variable)
                 // This is tricky. A better approach might be to dispatch a custom event
                 // that the dashboard listens for.
                 // SIMULATION: Assume we can update the dashboard's array directly for now
                 if (window.dashboardUpdateTeamMembers) { // Check if a global update function exists
                     window.dashboardUpdateTeamMembers(newMember); // Call it
                 } else {
                     console.warn("Dashboard integration function missing. Adding visually only.");
                     // If no integration, just update the local copy for immediate visual feedback
                     employees.push({ ...newMember });
                 }
                 // --- End Integration Point ---

                renderSchedule(); // Re-render this view
                showToast(`Employee ${name} added.`, 'success');
                return true;
            }

            // --- Event Listeners ---
            if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => { const d=new Date(currentWeekStart); d.setDate(d.getDate()-7); if(d>=minDate){currentWeekStart=d;renderSchedule();} });
            if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => { const d=new Date(currentWeekStart); d.setDate(d.getDate()+7); const e=new Date(d); e.setDate(e.getDate()+6); if(e<=maxDate){currentWeekStart=d;renderSchedule();} });
            if (shiftTypeSelect) shiftTypeSelect.addEventListener('change', function() { if(customShiftGroup) customShiftGroup.style.display=this.value==='custom'?'block':'none'; });
            if (addEmployeeBtn) addEmployeeBtn.addEventListener('click', () => { if(employeeModal) employeeModal.style.display='flex'; });
            if (closeEmployeeModal) closeEmployeeModal.addEventListener('click', () => { if(employeeModal) employeeModal.style.display='none'; });
            if (cancelEmployeeBtn) cancelEmployeeBtn.addEventListener('click', () => { if(employeeModal) employeeModal.style.display='none'; });
            if (closeShiftModal) closeShiftModal.addEventListener('click', () => { if(shiftModal) shiftModal.style.display='none'; });
            if (cancelShiftBtn) cancelShiftBtn.addEventListener('click', () => { if(shiftModal) shiftModal.style.display='none'; });
             // Container-level click listener for modals
             container.addEventListener('click', function(event) { if(event.target===employeeModal)employeeModal.style.display='none'; if(event.target===shiftModal)shiftModal.style.display='none'; });

            if (employeeForm) employeeForm.addEventListener('submit', (e) => {
                e.preventDefault(); const n=container.querySelector('#empName'); const em=container.querySelector('#empEmail'); const r=container.querySelector('#empRole');
                if(n&&em&&r&&addEmployeeToSystem(n.value.trim(),em.value.trim(),r.value)){ employeeForm.reset(); if(employeeModal)employeeModal.style.display='none'; }
            });
            if (shiftForm) shiftForm.addEventListener('submit', (e) => {
                e.preventDefault(); const id=parseInt(editEmpIdInput.value); const day=editDayInput.value; const cId=editCellIdInput.value; const type=shiftTypeSelect.value; const custom=container.querySelector('#customShift').value.trim(); const notes=container.querySelector('#shiftNotes').value.trim(); const cell=container.querySelector(`#${cId}`);
                if(!cell||isNaN(id)||!day){ showToast('Error saving. Cell ref lost.','danger'); return; }
                const key=`${id}-${day}`; let text=''; let effType=type;
                switch(type){ case 'morning':text='9AM-5PM';break; case 'afternoon':text='12PM-8PM';break; case 'night':text='5PM-1AM';break; case 'day-off':text='OFF';break; case 'sick-leave':text='SICK';break; case 'vacation':text='VAC';break; case 'custom':text=custom||'Custom';if(!custom)effType='morning';break; case 'clear': delete scheduleData[key];saveScheduleData(); const ex=cell.querySelector('.shift'); if(ex)cell.removeChild(ex); showToast('Shift cleared.','success'); if(shiftModal)shiftModal.style.display='none'; return; }
                scheduleData[key]={type:effType,text,notes}; saveScheduleData();
                const exUp=cell.querySelector('.shift'); if(exUp)cell.removeChild(exUp); const div=createShiftDiv(effType,text); const span=cell.querySelector('.edit-shift'); if(span)cell.insertBefore(div,span); else cell.appendChild(div);
                showToast('Shift updated.','success'); if(shiftModal)shiftModal.style.display='none';
            });
            if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', () => { saveScheduleData(); showToast('Schedule saved.','success'); });
            if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', () => { /* ... (reminder logic) ... */ });

            // --- Initial Setup ---
            try { renderSchedule(); } catch (error) { console.error("Error rendering schedule:", error); showToast("Failed to load schedule.", "danger"); }
            console.log("Employee Schedule Initialized Successfully.");

        } // --- End of initializeEmployeeSchedule ---
        // ======================================================
        // == END: Employee Schedule Specific JavaScript ==
        // ======================================================


        // ======================================================
        // == START: Dashboard Core JavaScript ==
        // ======================================================
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            // ... (Keep all dashboard DOM element definitions) ...
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsBody = document.getElementById('notificationsBody');
            const closeNotifications = document.getElementById('closeNotifications');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const userAvatar = document.getElementById('userAvatar');
            const userProfileDetails = document.querySelector('.user-profile-details');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const welcomeName = document.getElementById('welcomeName');
            const userDropdown = document.getElementById('userDropdown');
            const profileLink = document.getElementById('profileLink');
            const settingsLink = document.getElementById('settingsLink');
            const logoutLink = document.getElementById('logoutLink');
            const contentSections = document.querySelectorAll('.content-section');
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featureSections = document.getElementById('featureSections');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder?.querySelector('.loading-indicator');
            const featureErrorMessage = featurePlaceholder?.querySelector('.error-message');
            const profileForm = document.getElementById('profileForm');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const uploadPhotoButton = document.getElementById('uploadPhotoButton');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingsPanels = document.querySelectorAll('.settings-panel');
            const preferencesForm = document.getElementById('preferencesForm');
            const accountForm = document.getElementById('accountForm');
            const securityForm = document.getElementById('securityForm');
            const notificationsForm = document.getElementById('notificationsForm');
            const teamList = document.getElementById('teamList');
            const inviteMemberForm = document.getElementById('inviteMemberForm');
            const themeOptions = document.querySelectorAll('.theme-option');
            const layoutDensitySelect = document.getElementById('layoutDensity');
            const weekStartSelect = document.getElementById('weekStart');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const teamMembersCount = document.getElementById('teamMembersCount');
            const tasksCompleted = document.getElementById('tasksCompleted');
            const activeProjects = document.getElementById('activeProjects');
            const upcomingDeadlines = document.getElementById('upcomingDeadlines');
            const userInfoRoleTitle = document.getElementById('userInfoRoleTitle');
            const backButton = document.getElementById('backButton');
            const notificationSound = document.getElementById('notificationSound');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
            const cancelAccountBtn = document.getElementById('cancelAccountBtn');
            const cancelSecurityBtn = document.getElementById('cancelSecurityBtn');
            const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const currentPasswordError = document.getElementById('currentPasswordError');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const teamMembersTrend = document.getElementById('teamMembersTrend');
            const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
            const activeProjectsTrend = document.getElementById('activeProjectsTrend');
            const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
            const soundNotificationsSwitch = document.getElementById('soundNotifications');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const teamSettingsTab = document.getElementById('teamSettingsTab');
            const dangerZoneTab = document.getElementById('dangerZoneTab');

            // --- State Variables ---
            let currentUser = {};
            let teamMembers = []; // This is the main source of truth
            let activities = [];
            let notifications = [];
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let activityIntervalId = null;
            let confirmCallback = null;
            let cancelCallback = null;

            // --- Constants ---
             const MAX_ACTIVITIES_DISPLAYED = 5;
             const UPDATE_INTERVAL = 60000;
             const SIMULATED_DELAY = 800;
             const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500;
             const DEFAULT_USER = { id: 1, name: 'Default User', email: 'default@example.com', title: 'Member', department: 'General', phone: '', avatar: '', initials: 'DU', role: 'member', password: 'password', preferences: { language: 'en', timezone: 'utc', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' }, notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } }, security: { twoFactorEnabled: false }, stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' } };


            // --- Initialization ---
            function initDashboard() {
                loadData(); // Load user, team, activities, etc.
                updateUserUI(); // Update static UI parts
                loadTeamMembers(); // Populate team list in settings
                loadActivities(); // Load dashboard activities
                loadNotifications(); // Load notifications for badge/modal
                updateStats(); // Update dashboard stats cards
                applyUserPreferences(); // Apply theme, layout, load settings forms
                applyRBAC(); // Apply role-based UI restrictions
                handleInitialNavigation(); // Load initial view based on hash
                startActivityTimeUpdater(); // Start timer for relative times
                setupEventListeners(); // Attach all static event listeners
                console.log("Dashboard Initialized. Current User:", JSON.parse(JSON.stringify(currentUser))); // Log loaded user
                console.log("Initial Team Members:", JSON.parse(JSON.stringify(teamMembers))); // Log loaded team
            }

            // --- Data Handling ---
            // (loadData, deepMerge, isObject, saveData, clearUserData - Keep these)
            function loadData() {
                const storedUser = JSON.parse(localStorage.getItem('currentUser')) || DEFAULT_USER;
                currentUser = deepMerge(DEFAULT_USER, storedUser);

                teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [
                     { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', role: 'admin', initials: 'ME', avatar: '', title: 'Administrator', department: 'Management', phone: '+201234567890' },
                     { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', role: 'member', initials: 'YA', avatar: '', title: 'Developer', department: 'IT', phone: '' },
                     { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'senior', initials: 'EL', avatar: '', title: 'Senior Designer', department: 'Design', phone: '' },
                     { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'supervisor', initials: 'BB', avatar: '', title: 'Team Lead', department: 'Marketing', phone: '' }
                ];
                 // Ensure all team members have basic fields expected by loadTeamMembers
                 teamMembers = teamMembers.map(m => ({
                     id: m.id,
                     name: m.name || 'Unnamed',
                     email: m.email || 'no-email',
                     role: m.role || 'member',
                     initials: m.initials || m.name?.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase() || '??',
                     avatar: m.avatar || ''
                 }));

                activities = JSON.parse(localStorage.getItem('activities')) || [];
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
                 console.log("Data loaded from localStorage.");
            }

            function deepMerge(target, source) {
                const output = { ...target }; if (isObject(target) && isObject(source)) { Object.keys(source).forEach(key => { if (isObject(source[key])) { if (!(key in target)) Object.assign(output, { [key]: source[key] }); else output[key] = deepMerge(target[key], source[key]); } else Object.assign(output, { [key]: source[key] }); }); } return output;
            }
            function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }

            function saveData() {
                try {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('teamMembers', JSON.stringify(teamMembers)); // Save updated teamMembers
                    localStorage.setItem('activities', JSON.stringify(activities));
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    // Schedule data is saved within initializeEmployeeSchedule
                    console.log("Core data saved to localStorage.");
                } catch (e) { console.error("Error saving data:", e); showConfirmModal({title:"Storage Error",message:"Could not save data.",confirmText:"OK",confirmClass:"btn-primary",onConfirm:hideConfirmModal}); }
            }
            function clearUserData() { localStorage.clear(); console.log("All localStorage cleared."); } // Simpler clear

            // --- UI Update Functions ---
            // (updateUserUI, applyUserPreferences, applyRBAC, loadSettingsFormData, updateStats, updateTrendIndicator, updateNotificationBadge - Keep these)
            function updateUserUI() { /* ... keep as is ... */ }
            function applyUserPreferences() { /* ... keep as is ... */ }
            function applyRBAC() { /* ... keep as is, maybe call again after dynamic load if needed ... */ }
            function loadSettingsFormData() { /* ... keep as is ... */ }
            function updateStats() { /* ... keep as is ... */ }
            function updateTrendIndicator(element, trendValue) { /* ... keep as is ... */ }
            function updateNotificationBadge() { /* ... keep as is ... */ }


            // --- Feature/Section Loading ---
             function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`Activating feature: ${featureId}, Tab: ${settingsTab}`);

                 // --- Cleanup previous feature's listeners ---
                 if (window.cleanupScheduleListeners) {
                     window.cleanupScheduleListeners(); // Call cleanup if it exists
                 }
                 // Add cleanup for other features here if needed

                 // --- RBAC Checks ---
                 if (featureId === 'settings') {
                     const targetTab = settingsTab || currentSettingsTab || 'preferences';
                     if (targetTab === 'danger' && currentUser?.role !== 'admin') { setActiveFeature('dashboard'); return; }
                     if (targetTab === 'team' && !(currentUser?.role === 'admin' || currentUser?.role === 'supervisor')) { setActiveFeature('dashboard'); return; }
                 }

                 currentFeature = featureId;
                 currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);

                 // Update URL
                 let hash = `#${featureId}`; if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                 if (window.location.hash !== hash) history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);

                 // Update Sidebar
                 menuItems.forEach(item => item.classList.remove('active'));
                 const activeMenuItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`);
                 if (activeMenuItem) activeMenuItem.classList.add('active');

                 // Show/Hide Content
                 contentSections.forEach(section => section.classList.remove('active'));
                 featureSectionsContainer.style.display = 'none';

                 // --- Load Content ---
                 if (featureId === 'dashboard') { dashboardContent.classList.add('active'); updateStats(); loadActivities(); }
                 else if (featureId === 'profile') { profileContent.classList.add('active'); updateUserUI(); }
                 else if (featureId === 'settings') { settingsContent.classList.add('active'); applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }
                 else {
                     // Handle dynamic features
                     featureSectionsContainer.style.display = 'block'; featureSections.innerHTML = '';
                     if (featurePlaceholder && featureTitle && featureDescription && featureLoadingIndicator && featureErrorMessage) {
                        featureSections.appendChild(featurePlaceholder); featureTitle.textContent = `Loading ${featureId.replace(/-/g,' ')}...`; featureDescription.textContent=''; featureLoadingIndicator.style.display='block'; featureErrorMessage.style.display='none'; featurePlaceholder.style.display='flex';
                     } else { featureSections.innerHTML = '<p>Loading...</p>'; }

                     const filePath = `sections/${featureId}.html`; console.log(`Fetching: ${filePath}`);
                     fetch(filePath)
                         .then(response => { if (!response.ok) throw new Error(`HTTP ${response.status}`); return response.text(); })
                         .then(html => {
                             featureSections.innerHTML = html; featureSections.classList.add('active');
                             // --- Call Initializer ---
                             if (featureId === 'employee-scheduling') {
                                 if (typeof initializeEmployeeSchedule === 'function') {
                                     try {
                                         console.log("Calling initializeEmployeeSchedule...");
                                         // Pass the *main* teamMembers array reference for potential modification
                                         initializeEmployeeSchedule(
                                             JSON.parse(JSON.stringify(currentUser || DEFAULT_USER)), // Pass copy of user
                                             teamMembers // Pass direct reference to main team array
                                         );
                                     } catch (err) { console.error(`Error in initializeEmployeeSchedule:`, err); /* Show error */ }
                                 } else { console.error(`Init function initializeEmployeeSchedule not found!`); /* Show error */ }
                             }
                             // --- Hide Placeholder ---
                              if (featureLoadingIndicator) featureLoadingIndicator.style.display = 'none';
                              if (featurePlaceholder && featureErrorMessage && featureErrorMessage.style.display !== 'block') {
                                  featurePlaceholder.style.display = 'none';
                              }
                         })
                         .catch(error => { console.error(`Error loading ${featureId}:`, error); /* Show error */ });
                 }
                 backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';
                 window.scrollTo(0, 0);
             }


            // --- Other Dashboard Functions ---
            // (activateSettingsTab, handleInitialNavigation, loadActivities, etc. - Keep remaining functions)
            // ... Make sure loadTeamMembers uses the main 'teamMembers' array ...
            // ... Make sure handleInviteMember updates the main 'teamMembers' array ...
            // ... Make sure handleEditMemberClick updates the main 'teamMembers' array ...
            // ... Make sure handleDeleteMemberClick updates the main 'teamMembers' array ...
            function activateSettingsTab(tabId) { /* ... keep as is ... */ }
            function handleInitialNavigation() { /* ... keep as is ... */ }
            function loadActivities(showAll = false) { /* ... keep as is ... */ }
            function loadNotifications() { /* ... keep as is ... */ }
            function getTimeAgo(timestamp) { /* ... keep as is ... */ }
            function updateActivityTimes() { /* ... keep as is ... */ }
            function startActivityTimeUpdater() { /* ... keep as is ... */ }
            function loadTeamMembers() { /* ... ENSURE IT READS FROM GLOBAL 'teamMembers' ... */
                 if (!teamList) { console.warn("Team list element not found."); return; }
                 teamList.innerHTML = '';
                 const canManageGlobal = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';
                 const canDeleteGlobal = currentUser?.role === 'admin';

                 if (teamMembers.length === 0) {
                     teamList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--gray);">No team members yet. Invite one below.</div>`;
                 } else {
                     teamMembers.forEach(member => { // Use the global teamMembers
                         if(!member || typeof member.id === 'undefined') { console.warn("Skipping invalid member data:", member); return; }
                         const memberCard = document.createElement('div'); memberCard.className = 'team-member-card'; memberCard.dataset.id = member.id;
                         const canManageThis = (canManageGlobal && !['admin', 'supervisor'].includes(member.role)) || (canDeleteGlobal && member.id !== currentUser?.id);
                         const canDeleteThis = canDeleteGlobal && member.id !== currentUser?.id;
                         let avatarContent = member.initials || member.email?.substring(0, 2).toUpperCase() || '??';
                         let avatarStyle = member.avatar ? `background-image: url(${member.avatar});` : '';
                         const role = member.role || 'member'; const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                         memberCard.innerHTML = `
                             <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                             <div class="member-details"><div class="member-name">${member.name || 'Unnamed'}</div><div class="member-email">${member.email || 'No Email'}</div></div>
                             <div class="member-role role-${role}">${roleDisplay}</div>
                             <div class="member-actions">
                                 ${canManageThis ? `<button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-edit"></i></button>` : ''}
                                 ${canDeleteThis ? `<button class="btn btn-danger btn-sm delete-member" title="Delete Member"><i class="fas fa-trash"></i></button>` : ''}
                             </div>`;
                         teamList.appendChild(memberCard);
                     });
                     teamList.querySelectorAll('.edit-member').forEach(btn => btn.addEventListener('click', handleEditMemberClick));
                     teamList.querySelectorAll('.delete-member').forEach(btn => btn.addEventListener('click', handleDeleteMemberClick));
                 }
                 updateStats(); // Update count based on global teamMembers
            }
            function showConfirmModal(config) { /* ... keep as is ... */ }
            function hideConfirmModal() { /* ... keep as is ... */ }
            function handleProfileSave(e) { /* ... keep as is ... */ }
            function handleProfileCancel() { /* ... keep as is ... */ }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... keep as is ... */ }
            function handleSettingsCancel(panelId) { /* ... keep as is ... */ }

            // --- Integration Function for Schedule ---
             window.dashboardUpdateTeamMembers = (newMemberData) => {
                 console.log("dashboardUpdateTeamMembers called with:", newMemberData);
                 if (newMemberData && typeof newMemberData === 'object') {
                     // Check if member already exists (by email - should be unique)
                     if (!teamMembers.some(m => m.email === newMemberData.email)) {
                         teamMembers.push(newMemberData); // Add to the main array
                         saveData(); // Save the updated main array
                         loadTeamMembers(); // Refresh the team list in settings view
                         console.log("Team member added to main list:", newMemberData);
                         return true; // Indicate success
                     } else {
                         console.warn("Attempted to add existing member via schedule:", newMemberData.email);
                         return false; // Indicate failure (already exists)
                     }
                 }
                 return false; // Indicate failure (invalid data)
             };
             // --- End Integration Function ---

            function handleInviteMember(e) { /* ... keep as is (doesn't modify teamMembers directly) ... */ }

            function handleEditMemberClick(e) { // Modifies the global teamMembers array
                 const card=e.target.closest('.team-member-card'); const memberId=parseInt(card?.dataset.id);
                 const memberIndex = teamMembers.findIndex(m => m.id === memberId); // Find index
                 if(memberIndex === -1) return; // Member not found
                 const member = teamMembers[memberIndex];

                 const newName=prompt("Enter new name:",member.name||''); if(newName===null)return;
                 let newRole=member.role; const isAdmin=currentUser?.role==='admin'; const isSupervisor=currentUser?.role==='supervisor'; let canChangeRole=false; let allowedRolesPrompt='';
                 if(isAdmin&&member.id!==currentUser?.id){canChangeRole=true;allowedRolesPrompt='member, senior, supervisor, admin';}
                 else if(isSupervisor&&!['admin','supervisor'].includes(member.role)){canChangeRole=true;allowedRolesPrompt='member, senior';}
                 if(canChangeRole){ const promptedRole=prompt(`Enter new role (${allowedRolesPrompt}):`,member.role); if(promptedRole!==null){ const cleanRole=promptedRole.trim().toLowerCase(); if(allowedRolesPrompt.split(', ').includes(cleanRole)){newRole=cleanRole;} else{alert('Invalid role or permission denied.');}}}
                 else if(member.id!==currentUser?.id){alert("Permission denied to change role.");}

                 // Update the member in the main array
                 teamMembers[memberIndex] = {
                     ...member, // Keep existing properties
                     name: newName.trim() || 'Unnamed Member',
                     role: newRole,
                     initials: (newName.trim() || 'Unnamed Member').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() || member.email?.substring(0,2).toUpperCase() || '??'
                 };

                 saveData(); // Save the updated array
                 loadTeamMembers(); // Reload list UI
                 addActivity('fa-user-edit',`Updated details for ${member.email}`); showSuccessMessage('Member updated.');
            }

            function handleDeleteMemberClick(e) { // Modifies the global teamMembers array
                 const card=e.target.closest('.team-member-card'); const memberId=parseInt(card?.dataset.id); const member=teamMembers.find(m=>m.id===memberId); if(!member)return;
                 if(currentUser?.role!=='admin'){alert('Only admins can delete members.');return;} if(member.id===currentUser?.id){alert("Cannot delete yourself.");return;}
                 showConfirmModal({ title:'Delete Team Member?', message:`Remove <strong>${member.name||member.email}</strong>?`, confirmText:'Delete', confirmClass:'btn-danger',
                     onConfirm:()=>{ const email=member.email;
                         teamMembers=teamMembers.filter(m=>m.id!==memberId); // Update main array
                         saveData(); // Save updated array
                         loadTeamMembers(); addActivity('fa-user-minus',`Removed member: ${email}`); addNotification('fa-user-minus',`Member removed: ${email}`); showSuccessMessage('Member deleted.'); hideConfirmModal();
                     }, onCancel:hideConfirmModal });
            }
            function handleDeleteActivityClick(e) { /* ... keep as is ... */ }
            function handleDeleteAllActivities() { /* ... keep as is ... */ }
            function markNotificationAsRead(id, itemEl) { /* ... keep as is ... */ }
            function handleMarkAllNotificationsRead() { /* ... keep as is ... */ }
            function handleDeleteNotificationClick(id) { /* ... keep as is ... */ }
            function handleDeleteAllNotifications() { /* ... keep as is ... */ }
            // --- CORRECTED handleAvatarUpload ---
            function handleAvatarUpload(e) {
                const file = e.target.files?.[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    alert('Image files only.');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    alert('Max 2MB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = ev => {
                    const url = ev.target?.result;
                    if (!url) return;
                    showConfirmModal({
                        title: 'Update Profile Picture?',
                        message: 'Set this image?',
                        confirmText: 'Set Picture',
                        confirmClass: 'btn-primary',
                        onConfirm: () => {
                            currentUser.avatar = url;
                            saveData();
                            updateUserUI();
                            addActivity('fa-camera', 'Changed profile picture.');
                            showSuccessMessage('Picture updated.');
                            hideConfirmModal();
                        },
                        onCancel: () => {
                            if (profileAvatarInput) profileAvatarInput.value = null;
                            hideConfirmModal();
                        }
                    });
                }; // <-- Semicolon IS present here in the original full code, ensure it's there

                reader.onerror = () => {
                    alert('Error reading file.');
                }; // <-- **** ADD SEMICOLON HERE ****

                reader.readAsDataURL(file);
            }
            // --- End CORRECTED handleAvatarUpload ---
            function handleLogout() { /* ... keep as is ... */ }
            function addActivity(icon, message) { /* ... keep as is ... */ }
            function addNotification(icon, message) { /* ... keep as is ... */ }
            function playNotificationSound() { /* ... keep as is ... */ }
            function showSuccessMessage(message) { /* ... keep as is ... */ }
            function setupEventListeners() { /* ... keep as is ... */ }
            function handleSearch() { /* ... keep as is ... */ }

            // --- Run Initialization ---
            initDashboard();

        }); // --- End of DOMContentLoaded ---
        // ======================================================
        // == END: Dashboard Core JavaScript ==
        // ======================================================
    </script>
</body>
</html>
```

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- استخدم العنوان الأصلي -->
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- الأيقونات الأصلية -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- CORE DASHBOARD CSS (الأنماط الأصلية الكاملة) --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b;
            --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444;
            --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem; --primary-rgb: 37, 99, 235;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* تمت إزالة السمات المتعارضة من body، سيتم تطبيق السمة بواسطة JS */
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        body.blue-theme { /* الألوان الافتراضية جيدة للسمة الزرقاء */ }
        body.dark-theme { /* الأنماط الخاصة بالسمة الداكنة */
            --primary-light: #1f2937; --dark: #f3f4f6; --light: #374151; --gray: #9ca3af;
            --light-gray: #4b5563; --white: #111827; --sidebar-bg: #111827; --sidebar-divider: rgba(255,255,255,0.05);
            --sidebar-text: rgba(255,255,255,0.8); --sidebar-hover: rgba(255,255,255,0.08); --sidebar-active: rgba(255,255,255,0.15);
            .welcome-section { background-color: var(--light); color: var(--dark); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); } /* Changed background */
            .stat-card { background-color: var(--light); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); } /* Changed background */
            .stat-card:hover { box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
            .activity-section { background-color: var(--light); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); } /* Changed background */
            .content-section { background-color: var(--light); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); } /* Changed background */
            .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); }
            .search-bar input { background-color: #374151; color: var(--dark); border-color: var(--light-gray); } /* Adjusted search input */
            .search-results { background-color: #374151; border-color: var(--light-gray); } /* Adjusted search results */
            .search-result-item { color: var(--dark); } .search-result-item:hover { background-color: #4b5563; }
            .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
            .dropdown-item { color: var(--dark); } .dropdown-item:hover { background-color: #4b5563; }
            .form-control { background-color: #374151; color: var(--dark); border-color: var(--light-gray); } /* Adjusted form control */
            .form-control[readonly] { background-color: var(--light-gray); color: var(--gray); opacity: 0.7; } /* Adjusted readonly */
            .team-member-card { background-color: var(--light); border-color: var(--light-gray); }
            .member-name { color: var(--dark); }
            .schedule-controls { background-color: var(--light); }
            .schedule-container { background-color: var(--light); border-color: var(--light-gray); }
            .schedule-table thead th { background-color: #4b5563; color: var(--dark); border-color: var(--gray); } /* Adjusted table header */
            .schedule-table tbody td { background-color: var(--light); border-color: var(--light-gray); color: var(--dark); }
            .schedule-table tbody td:first-child { background-color: var(--light); border-right-color: var(--light-gray); }
            #employeeSchedulingContent .modal-content { background-color: var(--light); }
            .modal-header { border-bottom-color: var(--light-gray); }
            .modal-title { color: var(--dark); }
            .form-actions { border-top-color: var(--light-gray); }
            .user-info-title { color: var(--light-gray); } /* Keep specific role colors if needed */
             .user-info-title.role-admin { color: var(--team-manager); }
        }
        /* --- Sidebar Styles --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: width 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; text-decoration: none; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer; }
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        /* --- Main Content Styles --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: margin-left 0.3s; }
        /* --- Top Navigation Styles --- */
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; } body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--dark); }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; } .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); } .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; gap: 0.5rem; /* Added gap */ }
        .user-name { font-weight: 500; color: var(--dark); }
        .user-status { font-size: 0.8rem; color: var(--success); /* margin-left: 0.5rem; removed */ font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; padding: 0.5rem 0; overflow: hidden; /* Added */ }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--dark); text-decoration: none; transition: background-color 0.2s; cursor: pointer; }
        .dropdown-item:hover { background-color: var(--primary-light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }
        .dropdown-divider { height: 1px; background-color: var(--light-gray); margin: 0.5rem 0; }
        /* --- Content Area Styles --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); /* Adjusted height */ transition: padding 0.3s ease; }
        body.compact .content-area { padding: 1rem; } body.spacious .content-area { padding: 3rem; }
        /* --- Welcome Section Styles --- */
        .welcome-section { background-color: var(--primary-dark); color: var(--white); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: padding 0.3s ease, margin-bottom 0.3s ease, background-color 0.3s ease; }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; } body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; } body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; } body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; } body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; } body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; } .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; } body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; } .user-info-title.role-admin { color: var(--team-manager); } body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }
        /* --- Stats Section Styles --- */
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; } body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background-color: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; }
        body.compact .stat-card { padding: 1rem; } body.spacious .stat-card { padding: 2rem; } .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary), var(--secondary)); opacity: 0.9; }
        .stat-title { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; } body.compact .stat-title { font-size: 0.8rem; } .stat-title i { color: var(--primary); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; } body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; } body.compact .stat-trend { font-size: 0.8rem; } .trend-up { color: var(--secondary); } .trend-down { color: var(--danger); } .trend-neutral { color: var(--gray); }
        /* --- Activity Section Styles --- */
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; } body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; } body.compact .section-header { margin-bottom: 1rem; } body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); } body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; } @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;} .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; } .view-all { color: var(--primary); } .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); } .delete-all { color: var(--danger); } .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding: 0; /* Reset padding */ }
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; } body.compact .activity-item { padding: 0.75rem 0; } body.spacious .activity-item { padding: 1.25rem 0; } .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(var(--primary-rgb), 0.08); animation: highlightNewActivity 2.5s ease-out forwards; } @keyframes highlightNewActivity { 0% { background-color: rgba(var(--primary-rgb), 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(var(--primary-rgb), 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; } body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; } .activity-message { margin-bottom: 0.25rem; color: var(--dark); } body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); } body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; } .delete-activity { color: var(--danger); cursor: pointer; opacity: 1; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; background: none; border: none; font-size: 1em;} .delete-activity:hover { background-color: rgba(239, 68, 68, 0.1); }
        /* --- Content Section Styles --- */
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; margin-bottom: 2rem; /* Added margin */ }
        .content-section.active { display: block; animation: fadeInSection 0.4s ease-out; }
         @keyframes fadeInSection { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body.compact .content-section { padding: 1rem; margin-bottom: 1rem; } body.spacious .content-section { padding: 3rem; margin-bottom: 3rem;}
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; } body.compact .section-main-header { margin-bottom: 1.5rem; } body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); } body.compact .section-main-title { font-size: 1.25rem; }
        /* --- Profile Section Styles --- */
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;} .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #uploadPhotoButton { margin-top: 0.5rem;}
        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; } body.compact .data-form { gap: 1rem; grid-template-columns: 1fr; /* Stack on compact */ } body.spacious .data-form { gap: 2rem; }
        @media (max-width: 768px) { .data-form { grid-template-columns: 1fr; } } /* Stack form on smaller screens */
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; } body.compact .form-group { margin-bottom: 0.75rem; } body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--dark); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; } body.spacious .form-control { padding: 1rem; } .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1); } .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; /* Added opacity */}
        .form-actions { grid-column: 1 / -1; /* Span full width */ display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; } body.compact .form-actions { margin-top: 0.5rem; } body.spacious .form-actions { margin-top: 2rem; }
        /* --- Button Styles --- */
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; line-height: 1.2; /* Added */ }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; } body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--gray); color: white; } .btn-secondary:hover:not(:disabled) { background-color: var(--dark); } /* Added Secondary */
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); } .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; } .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.8rem !important; } /* Ensure btn-sm overrides density */
        /* --- Settings Section Styles --- */
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; } body.compact .settings-tabs { margin-bottom: 1.5rem; } body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; } body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; } body.spacious .settings-tab { padding: 1rem 2rem; } .settings-tab:hover { color: var(--primary); } .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); } .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; animation: fadeInPanel 0.5s ease-out; } .settings-panel.active { display: block; } @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel h3 { font-size: 1.2rem; color: var(--dark); margin-bottom: 1.5rem; }
        /* --- Switch Styles --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; vertical-align: middle; /* Added */ } body.compact .switch { width: 40px; height: 20px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; } body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; } input:checked + .slider { background-color: var(--primary); } input:checked + .slider:before { transform: translateX(26px); } body.compact input:checked + .slider:before { transform: translateX(20px); } .slider.round { border-radius: 34px; } .slider.round:before { border-radius: 50%; }
        .setting-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--light-gray);} .setting-item:last-child { border-bottom: none; } .setting-item label { font-weight: 500; flex-grow: 1; margin-right: 1rem; }
        /* --- Team Management Styles (in Settings) --- */
        .team-management { margin-top: 1.5rem; } body.compact .team-management { margin-top: 1rem; } body.spacious .team-management { margin-top: 2rem; } .team-management h3, .add-member-form h4 { color: var(--dark); margin-bottom: 1rem; }
        .team-list { margin-top: 1rem; max-height: 400px; overflow-y: auto; padding-right: 10px;} body.compact .team-list { margin-top: 0.75rem; } body.spacious .team-list { margin-top: 1.5rem; }
        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); } body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; } body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; } .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; } body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        .member-details { flex: 1; min-width: 0; } .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} body.compact .member-name { font-size: 0.9rem; } .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} body.compact .member-email { font-size: 0.8rem; }
        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-align: center; min-width: 80px; /* Added min-width */ } body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; min-width: 70px;} .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); } .role-senior { background-color: rgba(var(--primary-rgb), 0.1); color: var(--primary); } .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); } .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; } /* No change needed for btn-sm */
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); } body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; } body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .add-member-form .data-form { grid-template-columns: 1fr 1fr 100px; } /* Adjust add form grid */
        .add-member-form .form-actions { grid-column: 1 / -1; margin-top: 0; } /* Adjust add form actions */
        @media (max-width: 768px) { .add-member-form .data-form { grid-template-columns: 1fr; } } /* Stack add form */
        /* --- Theme Selection Styles (in Settings) --- */
         .theme-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem; }
         .theme-option { cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 1rem; text-align: center; transition: all 0.2s; background-color: var(--light); }
         .theme-option div { width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 0.5rem; border: 1px solid var(--light-gray); }
         .theme-option span { font-weight: 500; font-size: 0.9rem; color: var(--dark); }
         .theme-option:hover { border-color: var(--primary-light); background-color: var(--primary-light);}
         .theme-option.selected { border-color: var(--primary); background-color: var(--primary-light); box-shadow: 0 0 0 2px var(--primary); }
         .theme-option[data-theme="light"] div { background: linear-gradient(45deg, #f8fafc 50%, #e2e8f0 50%); }
         .theme-option[data-theme="dark"] div { background: linear-gradient(45deg, #1f2937 50%, #374151 50%); }
         .theme-option[data-theme="blue"] div { background: linear-gradient(45deg, #1e3a8a 50%, #2563eb 50%); }
        /* --- Notifications Modal Styles --- */
        .notifications-modal { display: none; position: fixed; top: 0; right: 0; width: 100%; max-width: 380px; height: 100%; background-color: var(--white); box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); z-index: 1050; flex-direction: column; animation: slideIn 0.3s ease-out; } body.dark-theme .notifications-modal { background-color: var(--light); box-shadow: -5px 0 15px rgba(255, 255, 255, 0.05); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); flex-shrink: 0; } body.dark-theme .notifications-header { border-bottom-color: var(--gray); }
        .notifications-title { font-size: 1.1rem; font-weight: 600; color: var(--dark); }
        .close-notifications { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); line-height: 1; padding: 0; } .close-notifications:hover { color: var(--dark); }
        .notifications-body { flex-grow: 1; overflow-y: auto; padding: 0; }
        .notification-list-item { display: flex; align-items: flex-start; padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; position: relative; } body.dark-theme .notification-list-item { border-bottom-color: var(--gray); }
        .notification-list-item:hover { background-color: var(--light); } body.dark-theme .notification-list-item:hover { background-color: #4b5563; }
        .notification-list-item.unread { background-color: var(--primary-light); } body.dark-theme .notification-list-item.unread { background-color: rgba(var(--primary-rgb), 0.1); }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 32px; height: 32px; border-radius: 50%; background-color: rgba(var(--primary-rgb), 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; font-size: 0.9rem; } body.dark-theme .notification-icon-wrapper { background-color: rgba(var(--primary-rgb), 0.2); }
         .notification-icon-wrapper.icon-danger { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); } body.dark-theme .notification-icon-wrapper.icon-danger { background-color: rgba(239, 68, 68, 0.2); }
         .notification-icon-wrapper.icon-success { background-color: rgba(16, 185, 129, 0.1); color: var(--success); } body.dark-theme .notification-icon-wrapper.icon-success { background-color: rgba(16, 185, 129, 0.2); }
        .notification-content { flex-grow: 1; }
        .notification-message { margin-bottom: 0.25rem; font-size: 0.9rem; color: var(--dark); line-height: 1.4; }
        .notification-time { font-size: 0.75rem; color: var(--gray); }
        .delete-notification { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; color: var(--gray); cursor: pointer; font-size: 0.9rem; opacity: 0; transition: opacity 0.2s; padding: 0.25rem; } .notification-list-item:hover .delete-notification { opacity: 0.7; } .delete-notification:hover { opacity: 1; color: var(--danger); }
        .no-notifications-message { text-align: center; padding: 3rem 1rem; color: var(--gray); font-size: 0.9rem; }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; } body.dark-theme .notifications-footer { border-top-color: var(--gray); }
        .notifications-footer .btn-sm { padding: 0.4rem 0.8rem !important; font-size: 0.8rem !important; } /* Ensure footer buttons are small */
        /* --- Confirm Modal Styles --- */
        .confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1100; justify-content: center; align-items: center; padding: 1rem; }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); padding: 2rem; width: 90%; max-width: 450px; animation: fadeInScale 0.3s ease-out; text-align: center; } body.dark-theme .confirm-container { background-color: var(--light); }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); margin-bottom: 1rem; }
        .confirm-message { margin-bottom: 1.5rem; color: var(--gray); font-size: 1rem; line-height: 1.5; }
        .confirm-message strong { color: var(--dark); font-weight: 600; }
        .confirm-actions { display: flex; justify-content: center; gap: 1rem; }
        /* --- Success Message Styles --- */
        .success-message { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--light); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); z-index: 1200; display: flex; align-items: center; gap: 0.75rem; opacity: 0; transition: opacity 0.3s ease, bottom 0.3s ease; pointer-events: none; }
        .success-message.show { opacity: 1; bottom: 3rem; pointer-events: auto; }
        .success-message i { color: var(--success); font-size: 1.2rem; }
        /* --- Responsive Styles --- */
        @media (max-width: 992px) { .search-bar { width: 300px; } .stats-section { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } }
        @media (max-width: 768px) {
             body { flex-direction: column; } /* Stack layout */
             .sidebar { width: 100%; height: auto; position: relative; z-index: 95; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
             .main-content { margin-left: 0; }
             .top-nav { padding: var(--normal-padding) 1rem; /* Reduce padding */ }
             .search-bar { display: none; /* Hide search on small screens or move elsewhere */ }
             .user-menu { gap: 1rem; }
             .content-area { padding: 1.5rem 1rem; }
             .stats-section { grid-template-columns: 1fr 1fr; gap: 1rem; }
             .welcome-section { padding: 1.5rem; }
             .user-info { flex-direction: column; text-align: center; }
             .activity-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
             .activity-actions { margin-left: 0; padding-left: 0; margin-top: 0.5rem; }
             .confirm-container { width: 95%; padding: 1.5rem; }
        }
        @media (max-width: 480px) { .stats-section { grid-template-columns: 1fr; } .top-nav { flex-wrap: wrap; gap: 0.5rem; padding-top: 0.5rem; padding-bottom: 0.5rem;} .user-menu { /* Maybe hide user name */ } .dropdown-item { padding: 0.6rem 0.8rem; } }
        /* --- Utility Styles --- */
        .back-button { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary); margin-bottom: 1.5rem; cursor: pointer; font-weight: 500; transition: color 0.2s; background: none; border: none; padding: 0; }
        .back-button:hover { color: var(--primary-dark); text-decoration: underline; }
        .back-button i { transition: transform 0.2s; } .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; } .d-none { display: none !important; }
        /* --- Loading/Placeholder Styles --- */
        .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.75s linear infinite; margin-left: 0.5em; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { width: 0.8em; height: 0.8em; } /* Smaller spinner in buttons */
        .loading-text { margin-left: 0.5em; }
        .btn-outline .spinner { border-color: var(--primary); border-right-color: transparent; } /* Spinner color for outline button */
        .placeholder-content { text-align: center; padding: 3rem 1rem; color: var(--gray); }
        .placeholder-content h2 { margin-bottom: 1rem; color: var(--dark); }
        .placeholder-content .loading-indicator { display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .placeholder-content .error-message { color: var(--danger); margin-top: 1rem; }

        /* --- EMPLOYEE SCHEDULING CSS (Scoped - Original) --- */
        #employeeSchedulingContent .main-container { max-width: 100%; margin: 0; padding: 0; }
        #employeeSchedulingContent .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        #employeeSchedulingContent .page-title { font-size: 1.5rem; color: var(--primary-dark); font-weight: 600; }
        #employeeSchedulingContent .page-header > div { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        #employeeSchedulingContent .schedule-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background-color: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); flex-wrap: wrap; gap: 1rem; }
        #employeeSchedulingContent .week-navigation { display: flex; align-items: center; gap: 0.75rem; }
        #employeeSchedulingContent .week-display { font-weight: 600; min-width: 180px; text-align: center; color: var(--dark); }
        #employeeSchedulingContent .schedule-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); overflow-x: auto; border: 1px solid var(--light-gray); margin-top: 1rem; }
        #employeeSchedulingContent .schedule-table { width: 100%; min-width: 800px; /* Increased min-width */ border-collapse: collapse; table-layout: fixed; /* Added */ }
        #employeeSchedulingContent .schedule-table thead th { padding: 0.8rem 0.5rem; text-align: center; background-color: var(--primary-light); /* Lighter header */ color: var(--primary-dark); font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--light-gray); border-left: 1px solid var(--light-gray); font-size: 0.9rem; /* Slightly smaller header font */}
        #employeeSchedulingContent .schedule-table thead th:first-child { min-width: 180px; /* Wider employee column */ text-align: left; padding-left: 1rem; position: sticky; left: 0; z-index: 11; border-right: 1px solid var(--light-gray); background-color: var(--primary-light); /* Match header */ }
        #employeeSchedulingContent .schedule-table tbody td { padding: 0.5rem; /* Reduced padding */ text-align: center; background-color: var(--white); border-bottom: 1px solid var(--light-gray); border-left: 1px solid var(--light-gray); color: var(--dark); vertical-align: middle; height: 70px; /* Increased height */ font-size: 0.85rem; /* Smaller cell font */ }
        #employeeSchedulingContent .schedule-table tbody tr:last-child td { border-bottom: none; }
        #employeeSchedulingContent .schedule-table tbody td:first-child { position: sticky; left: 0; background-color: var(--white); border-right: 1px solid var(--light-gray); z-index: 5; font-weight: 500; text-align: left; padding-left: 1rem; white-space: nowrap; border-left: none; }
        #employeeSchedulingContent .employee-name { /* Existing styles */ }
        #employeeSchedulingContent .shift { padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; margin-bottom: 0.25rem; line-height: 1.3; /* Added */ border: 1px solid transparent; /* Added border */ }
        #employeeSchedulingContent .shift-morning { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        #employeeSchedulingContent .shift-afternoon { background-color: #fef3c7; color: #92400e; border-color: #fde68a; }
        #employeeSchedulingContent .shift-night { background-color: #ccfbf1; color: #115e59; border-color: #99f6e4; }
        #employeeSchedulingContent .day-off { background-color: #f3f4f6; color: #4b5563; border-color: #e5e7eb; font-style: italic; }
        #employeeSchedulingContent .sick-leave { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; font-weight: bold;}
        #employeeSchedulingContent .vacation { background-color: #e0e7ff; color: #3730a3; border-color: #c7d2fe; font-style: italic;}
        #employeeSchedulingContent .shift-custom { background-color: #ede9fe; color: #5b21b6; border-color: #ddd6fe; } /* Custom style */
        #employeeSchedulingContent .day-header { display: flex; flex-direction: column; gap: 0.15rem; align-items: center; } #employeeSchedulingContent .day-name { font-weight: 600; font-size: 0.85rem; } #employeeSchedulingContent .day-date { font-size: 0.75rem; opacity: 0.8; }
        #employeeSchedulingContent .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; padding: 1rem; animation: fadeInModalBg 0.3s ease-out; }
         @keyframes fadeInModalBg { from { background-color: rgba(0, 0, 0, 0); } to { background-color: rgba(0, 0, 0, 0.6); } }
        #employeeSchedulingContent .modal-content { background-color: var(--white); width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); padding: 0; /* Remove padding here */ max-height: 90vh; overflow: hidden; /* Changed to hidden */ display: flex; flex-direction: column; animation: fadeInScale 0.3s ease-out; } body.dark-theme #employeeSchedulingContent .modal-content { background-color: var(--light); }
        #employeeSchedulingContent .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; /* Add padding back */ border-bottom: 1px solid var(--light-gray); flex-shrink: 0; } body.dark-theme #employeeSchedulingContent .modal-header { border-bottom-color: var(--gray); }
        #employeeSchedulingContent .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        #employeeSchedulingContent .close-modal { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--gray); line-height: 1; padding: 0; } .close-modal:hover { color: var(--dark); }
        #employeeSchedulingContent .modal-body { flex-grow: 1; overflow-y: auto; padding: 1.5rem; /* Add padding back */ }
        #employeeSchedulingContent .form-group { margin-bottom: 1rem; } #employeeSchedulingContent .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; } #employeeSchedulingContent .form-control { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.95rem; } #employeeSchedulingContent .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; } #employeeSchedulingContent textarea.form-control { min-height: 80px; resize: vertical; /* Allow vertical resize */ }
        #employeeSchedulingContent .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding: 1rem 1.5rem; /* Add padding back */ border-top: 1px solid var(--light-gray); flex-shrink: 0; background-color: var(--white); /* Add background */} body.dark-theme #employeeSchedulingContent .form-actions { border-top-color: var(--gray); background-color: var(--light); }
        #employeeSchedulingContent .edit-shift { cursor: pointer; color: var(--primary); font-size: 0.75rem; display: block; text-align: center; margin-top: 0.25rem; opacity: 0; transition: opacity 0.2s, height 0.2s; height: 0; overflow: hidden; }
        #employeeSchedulingContent td:hover .edit-shift { /* Show on cell hover */ opacity: 0.7; height: auto; }
        #employeeSchedulingContent .edit-shift:hover { opacity: 1; text-decoration: underline; }
        /* Scoped Responsive styles for Employee Scheduling */
        @media (max-width: 768px) {
             #employeeSchedulingContent .schedule-table thead th { font-size: 0.8rem; padding: 0.6rem 0.3rem; }
             #employeeSchedulingContent .schedule-table tbody td { height: 60px; font-size: 0.75rem; padding: 0.4rem; }
             #employeeSchedulingContent .schedule-table thead th:first-child { min-width: 120px; }
             #employeeSchedulingContent .shift { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
             #employeeSchedulingContent .page-header { flex-direction: column; align-items: flex-start; }
             #employeeSchedulingContent .schedule-controls { flex-direction: column; align-items: stretch; }
             #employeeSchedulingContent .week-navigation { justify-content: space-between; width: 100%; }
        }

    </style>
</head>
<!-- الفئة الأولية للثيم تُطبق هنا -->
<body class="blue-theme">

    <!-- Sidebar (استخدم الهيكل الأصلي) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo" data-feature="dashboard" data-section-id="dashboardContent">
                <i class="fas fa-tasks logo-icon"></i> TeamFlow
            </a>
            <!-- يمكن إضافة زر تبديل هنا إذا لزم الأمر -->
        </div>
        <nav class="sidebar-menu">
            <div class="menu-title">Navigation</div>
             <a href="#" class="menu-item active" data-feature="dashboard" data-section-id="dashboardContent"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
             <a href="#" class="menu-item" data-feature="employee-scheduling" data-section-id="employeeSchedulingContent"><i class="fas fa-calendar-alt"></i> Employee Schedule</a>
             <a href="#" class="menu-item" data-feature="projects" data-section-id="projectsContent"><i class="fas fa-project-diagram"></i> Projects</a>
             <a href="#" class="menu-item" data-feature="taskManagement" data-section-id="taskManagementContent"><i class="fas fa-tasks"></i> Tasks</a> <!-- Corrected feature name -->
             <a href="#" class="menu-item" data-feature="reportsAnalytics" data-section-id="reportsAnalyticsContent"><i class="fas fa-chart-line"></i> Reports</a> <!-- Corrected feature name -->
             <a href="#" class="menu-item" data-feature="teamMembersView" data-section-id="teamMembersViewContent"><i class="fas fa-users"></i> Team</a> <!-- Corrected feature name -->
            <!-- أضف باقي عناصر القائمة من الكود الأصلي إذا كانت موجودة -->
            <a href="#" class="menu-item" data-feature="fileSharing" data-section-id="fileSharingContent"><i class="fas fa-folder-open"></i> File Sharing</a>
            <a href="#" class="menu-item" data-feature="projectTracking" data-section-id="projectTrackingContent"><i class="fas fa-chart-pie"></i> Project Tracking</a>
            <a href="#" class="menu-item" data-feature="teamCalendar" data-section-id="teamCalendarContent"><i class="fas fa-calendar-week"></i> Team Calendar</a>
            <a href="#" class="menu-item" data-feature="deadlineTracking" data-section-id="deadlineTrackingContent"><i class="fas fa-hourglass-half"></i> Deadlines</a>
            <a href="#" class="menu-item" data-feature="innovationHub" data-section-id="innovationHubContent"><i class="fas fa-lightbulb"></i> Innovation Hub</a>

            <div class="menu-divider"></div>
            <div class="menu-title">Management</div>
             <a href="#" class="menu-item" data-feature="dataManagement" data-section-id="dataManagementContent"><i class="fas fa-database"></i> Data Management</a>


            <div class="menu-divider"></div>
            <div class="menu-title">Account</div>
            <!-- روابط الملف الشخصي والإعدادات تستخدم data-feature أيضًا -->
            <a href="#" class="menu-item" data-feature="profile" data-section-id="profileContent"><i class="fas fa-user"></i> Profile</a>
            <a href="#" class="menu-item" data-feature="settings" data-section-id="settingsContent"><i class="fas fa-cog"></i> Settings</a>
        </nav>
        <!-- يمكن إضافة تذييل للشريط الجانبي هنا -->
    </aside>

    <!-- المحتوى الرئيسي -->
    <main class="main-content">
        <!-- الشريط العلوي (استخدم الهيكل الأصلي مع قائمة المستخدم المنسدلة المُصححة) -->
        <nav class="top-nav">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search tasks, projects, team...">
                <div class="search-results" id="searchResults"></div>
            </div>

            <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon" role="button" aria-label="View Notifications" tabindex="0">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span>
                 </div>
                <div class="user-profile">
                    <div class="user-profile-details" id="userProfileToggle" role="button" aria-haspopup="true" aria-expanded="false" tabindex="0">
                         <div class="user-avatar" id="userAvatar">ME</div>
                         <span class="user-name" id="userNameDisplay">M. Elsayed</span>
                         <!-- <span class="user-status" id="userStatus">Online</span> -->
                         <i class="fas fa-chevron-down" style="font-size: 0.8em; color: var(--gray);"></i>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--light-gray);"> <!-- Added User info in dropdown -->
                             <div style="font-weight: 600; color: var(--dark);" id="dropdownUserName">Mohamed Elmenisy</div>
                             <div style="font-size: 0.8rem; color: var(--gray);" id="dropdownUserEmail">m.elsayed@thechefz.co</div>
                        </div>
                         <div style="padding: 0.5rem 0;"> <!-- Wrapper for items -->
                            <a href="#" class="dropdown-item" id="profileLink">
                                <i class="fas fa-user-circle"></i> Profile
                            </a>
                            <a href="#" class="dropdown-item" id="settingsLink">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                             <a href="#" class="dropdown-item" id="themeToggleItem"> <!-- Example: Theme Toggle -->
                                <i class="fas fa-palette"></i> <span id="themeToggleText">Switch Theme</span>
                            </a>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="logoutLink">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- منطقة المحتوى (استخدم الهيكل الأصلي) -->
        <div class="content-area">
            <!-- زر الرجوع -->
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- قسم لوحة التحكم (استخدم المحتوى الأصلي) -->
            <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section">
                     <h1 class="welcome-title">Welcome back, <span id="welcomeName">User</span>!</h1>
                     <p class="welcome-subtitle">Here's a quick overview of your team's activity.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="welcomeUserAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="welcomeUserNameFull">User Full Name</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Member</div>
                             <div class="user-info-email"><i class="fas fa-envelope"></i> <span id="welcomeUserEmail">user@example.com</span></div>
                         </div>
                     </div>
                 </div>

                 <div class="stats-section">
                     <div class="stat-card">
                         <div class="stat-title"><i class="fas fa-users"></i> Team Members</div>
                         <div class="stat-value"><span id="teamMembersCount">0</span> <span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> <span>0%</span></span></div>
                     </div>
                     <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-check-circle"></i> Tasks Completed</div>
                        <div class="stat-value"><span id="tasksCompleted">0</span> <span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> <span>0%</span></span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-project-diagram"></i> Active Projects</div>
                        <div class="stat-value"><span id="activeProjects">0</span> <span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> <span>0%</span></span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-calendar-times"></i> Upcoming Deadlines</div>
                        <div class="stat-value"><span id="upcomingDeadlines">0</span> <span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> <span>0%</span></span></div>
                    </div>
                 </div>

                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge" style="display:none;">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity" style="display: none;">View All</span>
                             <span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li class="placeholder-content" id="activityPlaceholder">
                             <div class="loading-indicator">
                                 <div class="spinner" style="border-color: var(--gray); border-right-color:transparent;"></div>
                                 <span class="loading-text">Loading activity...</span>
                            </div>
                         </li>
                         <!-- سيتم ملء عناصر النشاط هنا بواسطة JavaScript -->
                     </ul>
                 </div>
            </div>

            <!-- قسم الملف الشخصي (استخدم الهيكل الأصلي) -->
            <div id="profileContent" class="content-section" style="display: none;">
                 <div class="section-main-header">
                     <h2 class="section-main-title">Edit Profile</h2>
                 </div>
                 <p class="profile-header-text">Manage your personal information and preferences.</p>
                 <div class="profile-avatar-section">
                     <div id="profileAvatarLarge">U</div>
                     <button id="uploadPhotoButton" class="btn btn-outline"><i class="fas fa-upload"></i> Upload Photo</button>
                     <input type="file" id="avatarUploadInput" accept="image/png, image/jpeg" style="display: none;">
                 </div>
                 <form id="profileForm">
                     <div class="data-form">
                         <div class="form-group"> <label for="profileName">Full Name</label> <input type="text" id="profileName" class="form-control"> </div>
                         <div class="form-group"> <label for="profileEmail">Email Address</label> <input type="email" id="profileEmail" class="form-control" readonly> </div>
                         <div class="form-group"> <label for="profileTitle">Job Title</label> <input type="text" id="profileTitle" class="form-control"> </div>
                         <div class="form-group"> <label for="profilePhone">Phone Number</label> <input type="tel" id="profilePhone" class="form-control"> </div>
                         <div class="form-group"> <label for="profileDepartment">Department</label> <input type="text" id="profileDepartment" class="form-control"> </div>
                         <div class="form-group"> <label for="profileBio">Short Bio</label> <textarea id="profileBio" class="form-control" rows="3" placeholder="Tell us a bit about yourself..."></textarea> </div>
                     </div>
                     <div class="form-actions">
                         <button type="button" id="cancelProfileChanges" class="btn btn-outline">Cancel</button>
                         <button type="submit" id="saveProfileChanges" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                     </div>
                 </form>
            </div>

            <!-- قسم الإعدادات (استخدم الهيكل الأصلي) -->
            <div id="settingsContent" class="content-section" style="display: none;">
                 <div class="section-main-header">
                     <h2 class="section-main-title">Settings</h2>
                 </div>
                 <div class="settings-tabs">
                     <span class="settings-tab active" data-tab="preferences">Preferences</span>
                     <span class="settings-tab" data-tab="notifications">Notifications</span>
                     <span class="settings-tab" data-tab="security">Security</span>
                     <span class="settings-tab" data-tab="team" id="settingsTeamTab">Team Management</span>
                 </div>

                 <!-- لوحة التفضيلات -->
                 <div id="preferencesPanel" class="settings-panel active">
                     <h3>Interface Preferences</h3>
                     <div class="setting-item">
                         <label for="themeSelect">Color Theme</label>
                         <div class="theme-options">
                            <div class="theme-option" data-theme="blue" title="Blue Theme"> <div style="background: linear-gradient(45deg, #1e3a8a 50%, #2563eb 50%);"></div> <span>Blue</span> </div>
                            <div class="theme-option" data-theme="dark" title="Dark Theme"> <div style="background: linear-gradient(45deg, #1f2937 50%, #374151 50%);"></div> <span>Dark</span> </div>
                            <div class="theme-option" data-theme="light" title="Light Theme"> <div style="background: linear-gradient(45deg, #f8fafc 50%, #e2e8f0 50%);"></div> <span>Light</span> </div>
                         </div>
                     </div>
                     <div class="setting-item">
                        <label for="layoutDensitySelect">Layout Density</label>
                         <select id="layoutDensitySelect" class="form-control" style="max-width: 200px;">
                            <option value="compact">Compact</option>
                            <option value="normal">Normal</option>
                            <option value="spacious">Spacious</option>
                         </select>
                     </div>
                      <div class="setting-item">
                         <label for="soundNotificationsToggle">Enable Sound Notifications</label>
                         <label class="switch">
                             <input type="checkbox" id="soundNotificationsToggle">
                             <span class="slider round"></span>
                         </label>
                     </div>
                     <div class="setting-item">
                         <label for="weekStartSelect">Week Starts On</label>
                         <select id="weekStartSelect" class="form-control" style="max-width: 200px;">
                            <option value="sun">Sunday</option>
                            <option value="mon">Monday</option>
                         </select>
                     </div>
                     <!-- Add Language/Timezone if needed -->
                     <div class="form-actions" style="justify-content: flex-end; margin-top: 2rem;">
                         <button id="savePreferences" class="btn btn-primary"><i class="fas fa-save"></i> Save Preferences</button>
                     </div>
                 </div>

                 <!-- لوحة الإشعارات -->
                 <div id="notificationsPanel" class="settings-panel">
                     <h3>Notification Preferences</h3>
                     <h4>Email Notifications</h4>
                     <div class="setting-item"> <label>Notify me about new task assignments</label> <label class="switch"><input type="checkbox" id="emailTasks"><span class="slider round"></span></label> </div>
                     <div class="setting-item"> <label>Notify me about upcoming deadlines</label> <label class="switch"><input type="checkbox" id="emailDeadlines"><span class="slider round"></span></label> </div>
                     <div class="setting-item"> <label>Send me weekly activity summaries</label> <label class="switch"><input type="checkbox" id="emailUpdates"><span class="slider round"></span></label> </div>
                     <h4 style="margin-top: 2rem;">Push Notifications (App/Browser)</h4>
                     <div class="setting-item"> <label>Notify me about direct messages</label> <label class="switch"><input type="checkbox" id="pushMessages"><span class="slider round"></span></label> </div>
                     <div class="setting-item"> <label>Notify me about team updates</label> <label class="switch"><input type="checkbox" id="pushTeamUpdates"><span class="slider round"></span></label> </div>
                     <div class="form-actions" style="justify-content: flex-end; margin-top: 2rem;">
                         <button id="saveNotifications" class="btn btn-primary"><i class="fas fa-save"></i> Save Notification Settings</button>
                     </div>
                 </div>

                 <!-- لوحة الأمان -->
                 <div id="securityPanel" class="settings-panel">
                     <h3>Security Settings</h3>
                      <div class="setting-item">
                         <label>Change Password</label>
                         <button id="changePasswordBtn" class="btn btn-outline">Change Password</button>
                     </div>
                     <div class="setting-item">
                         <label for="twoFactorToggle">Enable Two-Factor Authentication (2FA)</label>
                         <label class="switch">
                             <input type="checkbox" id="twoFactorToggle">
                             <span class="slider round"></span>
                         </label>
                     </div>
                     <div id="twoFactorSetup" style="display: none; margin-top: 1rem; padding: 1rem; background-color: var(--primary-light); border-radius: 6px;">
                         <p>Scan this QR code with your authenticator app:</p>
                         <!-- Placeholder for QR Code -->
                         <div style="width: 150px; height: 150px; background-color: #ccc; margin: 1rem auto; text-align: center; line-height: 150px;">QR Code</div>
                         <p>Or enter this setup key manually:</p>
                         <code style="display: block; text-align: center; margin-bottom: 1rem;">ABCDE FGHJI KLMNO PQRST</code>
                         <div class="form-group">
                             <label for="twoFactorVerifyCode">Enter code from app to verify:</label>
                             <input type="text" id="twoFactorVerifyCode" class="form-control" placeholder="6-digit code">
                         </div>
                         <button id="verify2FABtn" class="btn btn-primary">Verify & Enable 2FA</button>
                     </div>
                     <div class="form-actions" style="justify-content: flex-end; margin-top: 2rem;">
                          <button id="saveSecurity" class="btn btn-primary"><i class="fas fa-save"></i> Save Security Settings</button> <!-- May only be needed if password change is inline -->
                     </div>
                 </div>

                 <!-- لوحة إدارة الفريق -->
                 <div id="teamPanel" class="settings-panel">
                     <div class="team-management">
                         <h3>Manage Team Members</h3>
                         <div id="teamListContainer">
                             <div class="team-list" id="teamList">
                                 <!-- سيتم ملء أعضاء الفريق هنا -->
                                 <div class="placeholder-content">Loading team members...</div>
                             </div>
                         </div>

                         <div class="add-member-form">
                             <h4>Add New Member</h4>
                             <form id="addMemberForm">
                                 <div class="data-form">
                                     <div class="form-group"> <label for="newMemberName">Full Name</label> <input type="text" id="newMemberName" class="form-control" required> </div>
                                     <div class="form-group"> <label for="newMemberEmail">Email</label> <input type="email" id="newMemberEmail" class="form-control" required> </div>
                                     <div class="form-group"> <label for="newMemberRole">Role</label> <select id="newMemberRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="admin">Admin</option> </select> </div>
                                 </div>
                                 <div class="form-actions" style="margin-top: 1rem;">
                                     <button type="submit" class="btn btn-success"><i class="fas fa-user-plus"></i> Invite Member</button>
                                 </div>
                             </form>
                         </div>
                     </div>
                 </div>
            </div>

            <!-- بقية الأقسام الثابتة من الكود الأصلي -->
            <div id="projectsContent" class="content-section" style="display: none;"><h2>Projects</h2><p>Projects content goes here.</p></div>
            <div id="reportsAnalyticsContent" class="content-section" style="display: none;"><h2>Reports & Analytics</h2><p>Reports content goes here.</p></div>
            <div id="teamMembersViewContent" class="content-section" style="display: none;"><h2>Team Members</h2><p>Team Members view content goes here.</p></div>
            <div id="fileSharingContent" class="content-section" style="display: none;"><h2>File Sharing</h2><p>File Sharing content goes here.</p></div>
            <div id="dataManagementContent" class="content-section" style="display: none;"><h2>Data Management</h2><p>Data Management content goes here.</p></div>
            <div id="projectTrackingContent" class="content-section" style="display: none;"><h2>Project Tracking</h2><p>Project Tracking content goes here.</p></div>
            <div id="taskManagementContent" class="content-section" style="display: none;"><h2>Task Management</h2><p>Task Management content goes here.</p></div>
            <div id="teamCalendarContent" class="content-section" style="display: none;"><h2>Team Calendar</h2><p>Team Calendar content goes here.</p></div>
            <div id="deadlineTrackingContent" class="content-section" style="display: none;"><h2>Deadline Tracking</h2><p>Deadline Tracking content goes here.</p></div>
            <div id="innovationHubContent" class="content-section" style="display: none;"><h2>Innovation Hub</h2><p>Innovation Hub content goes here.</p></div>

            <!-- قسم جدولة الموظفين (استخدم الهيكل الأصلي) -->
            <div id="employeeSchedulingContent" class="content-section employee-schedule-section" style="display: none;">
                <div class="main-container">
                    <div class="page-header">
                        <h1 class="page-title">Employee Schedule</h1>
                        <div>
                             <button class="btn btn-primary" id="schedule-addEmployeeBtn" style="display: none;"><i class="fas fa-plus"></i> Add Employee</button>
                             <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="display: none;"><i class="fas fa-envelope"></i> Send Reminders</button>
                        </div>
                    </div>
                    <div class="schedule-controls">
                        <div class="week-navigation">
                             <button class="btn btn-outline" id="schedule-prevWeekBtn"><i class="fas fa-chevron-left"></i></button>
                             <div class="week-display" id="schedule-weekDisplay">Loading...</div>
                             <button class="btn btn-outline" id="schedule-nextWeekBtn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                         <button class="btn btn-primary" id="schedule-saveScheduleBtn" style="display: none;"><i class="fas fa-save"></i> Save Schedule</button>
                    </div>
                    <div class="schedule-container">
                        <table class="schedule-table">
                             <thead>
                                 <tr><th>Employee</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
                             </thead>
                             <tbody id="schedule-table-body">
                                 <tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray);">Initializing Schedule...</td></tr>
                             </tbody>
                        </table>
                    </div>
                </div>
                <!-- Modals for Employee Scheduling -->
                <div class="modal" id="schedule-employeeModal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Add New Employee</h2>
                            <button class="close-modal" id="schedule-closeEmployeeModal" aria-label="Close">&times;</button>
                        </div>
                         <form id="schedule-employeeForm">
                            <div class="modal-body">
                                <div class="form-group"><label for="schedule-empName">Full Name</label><input type="text" id="schedule-empName" class="form-control" required></div>
                                <div class="form-group"><label for="schedule-empEmail">Email</label><input type="email" id="schedule-empEmail" class="form-control" required></div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" id="schedule-cancelEmployeeBtn">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Employee</button>
                            </div>
                         </form>
                    </div>
                </div>
                <div class="modal" id="schedule-shiftModal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit Shift</h2>
                            <button class="close-modal" id="schedule-closeShiftModal" aria-label="Close">&times;</button>
                        </div>
                         <form id="schedule-shiftForm">
                            <div class="modal-body">
                                <input type="hidden" id="schedule-shiftEmpId">
                                <input type="hidden" id="schedule-shiftDateKey">
                                <div class="form-group"><label for="schedule-shiftEmployee">Employee</label><input type="text" id="schedule-shiftEmployee" class="form-control" readonly></div>
                                <div class="form-group"><label for="schedule-shiftDate">Date</label><input type="text" id="schedule-shiftDateDisplay" class="form-control" readonly><input type="date" id="schedule-shiftDate" class="form-control" required style="display:none;"></div>
                                <div class="form-group"><label for="schedule-shiftType">Shift Type</label><select id="schedule-shiftType" class="form-control" required><option value="day-off">Day Off</option><option value="morning">Morning (9AM-5PM)</option><option value="afternoon">Afternoon (12PM-8PM)</option><option value="night">Night (5PM-1AM)</option><option value="sick-leave">Sick Leave</option><option value="vacation">Vacation</option><option value="custom">Custom</option></select></div>
                                <div class="form-group" id="schedule-customShiftGroup" style="display: none;"><label for="schedule-customShift">Custom Shift Times</label><input type="text" id="schedule-customShift" class="form-control" placeholder="e.g., 10AM-6PM"></div>
                                <div class="form-group"><label for="schedule-shiftNotes">Notes (Optional)</label><textarea id="schedule-shiftNotes" class="form-control" rows="3"></textarea></div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" id="schedule-deleteShiftBtn">Delete Shift</button>
                                <div> <!-- Group remaining buttons -->
                                    <button type="button" class="btn btn-outline" id="schedule-cancelShiftBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </div>
                         </form>
                    </div>
                </div>
            </div> <!-- End Employee Scheduling Content -->
        </div> <!-- End Content Area -->
    </main> <!-- End Main Content -->

    <!-- Modals and Notifications (استخدم الهيكل الأصلي) -->
    <div class="notifications-modal" id="notificationsModal" style="display: none;">
        <div class="notifications-header">
            <h3 class="notifications-title">Notifications</h3>
            <button class="close-notifications" id="closeNotificationsBtn" aria-label="Close Notifications">&times;</button>
        </div>
        <div class="notifications-body" id="notificationsBody">
             <div class="no-notifications-message" id="noNotificationsMessage">No new notifications.</div>
             <!-- سيتم ملء الإشعارات هنا -->
        </div>
        <div class="notifications-footer">
             <button class="btn btn-sm btn-outline" id="markAllReadBtn">Mark All as Read</button>
             <button class="btn btn-sm btn-danger" id="clearAllNotificationsBtn">Clear All</button>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal" style="display: none;">
         <div class="confirm-container">
            <h3 id="confirmTitle">Confirm Action</h3>
            <p id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button id="cancelConfirmBtn" class="btn btn-outline">Cancel</button>
                <button id="confirmBtn" class="btn btn-danger">Confirm</button>
            </div>
         </div>
    </div>

    <!-- رسالة النجاح -->
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> <span id="successMessageText">Operation Successful!</span></div>

    <!-- عنصر الصوت (إذا لزم الأمر) -->
    <audio id="notificationSound" src="path/to/your/notification-sound.mp3" preload="auto"></audio>

    <!-- JavaScript (استخدم الكود الأصلي مع التحسينات المطبقة) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CORE DASHBOARD ELEMENTS & STATE (Updated Declarations) ---
             const sidebar = document.getElementById('sidebar');
             const menuItems = document.querySelectorAll('.menu-item');
             const allContentSections = document.querySelectorAll('.content-section');
             const dashboardContent = document.getElementById('dashboardContent');
             const profileContent = document.getElementById('profileContent');
             const settingsContent = document.getElementById('settingsContent');
             const employeeSchedulingContent = document.getElementById('employeeSchedulingContent');
             const teamList = document.getElementById('teamList'); // In Settings
             const backButton = document.getElementById('backButton');
             const searchInput = document.getElementById('searchInput');
             const searchResults = document.getElementById('searchResults');
             const notificationIcon = document.getElementById('notificationIcon');
             const notificationBadge = document.querySelector('.notification-badge');
             const userAvatar = document.getElementById('userAvatar'); // Top nav avatar
             const userProfileToggle = document.getElementById('userProfileToggle'); // Clickable area in top nav
             const userNameDisplay = document.getElementById('userNameDisplay'); // Name in top nav
             const userDropdown = document.getElementById('userDropdown');
             const dropdownUserName = document.getElementById('dropdownUserName'); // Name inside dropdown
             const dropdownUserEmail = document.getElementById('dropdownUserEmail'); // Email inside dropdown
             const profileLink = document.getElementById('profileLink'); // Link in dropdown
             const settingsLink = document.getElementById('settingsLink'); // Link in dropdown
             const logoutLink = document.getElementById('logoutLink');   // Link in dropdown
             const activityList = document.getElementById('activityList');
             const activityPlaceholder = document.getElementById('activityPlaceholder'); // Added
             const viewAllActivity = document.getElementById('viewAllActivity');
             const deleteAllActivity = document.getElementById('deleteAllActivity');
             const settingsTabs = document.querySelectorAll('.settings-tab');
             const settingsPanels = document.querySelectorAll('.settings-panel');
             const teamMembersCount = document.getElementById('teamMembersCount');
             const tasksCompleted = document.getElementById('tasksCompleted');
             const activeProjects = document.getElementById('activeProjects');
             const upcomingDeadlines = document.getElementById('upcomingDeadlines');
             const teamMembersTrend = document.getElementById('teamMembersTrend');
             const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
             const activeProjectsTrend = document.getElementById('activeProjectsTrend');
             const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
             const welcomeName = document.getElementById('welcomeName'); // In welcome section
             const welcomeUserAvatar = document.getElementById('welcomeUserAvatar'); // In welcome section
             const welcomeUserNameFull = document.getElementById('welcomeUserNameFull'); // In welcome section
             const userInfoRoleTitle = document.getElementById('userInfoRoleTitle'); // In welcome section
             const welcomeUserEmail = document.getElementById('welcomeUserEmail'); // In welcome section
             const notificationSound = document.getElementById('notificationSound');
             const successMessage = document.getElementById('successMessage');
             const successMessageText = document.getElementById('successMessageText');
             let confirmBtn = document.getElementById('confirmBtn');
             let cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
             // Profile Form Elements
             const profileForm = document.getElementById('profileForm');
             const profileAvatarLarge = document.getElementById('profileAvatarLarge');
             const uploadPhotoButton = document.getElementById('uploadPhotoButton');
             const avatarUploadInput = document.getElementById('avatarUploadInput');
             const profileNameInput = document.getElementById('profileName');
             const profileEmailInput = document.getElementById('profileEmail');
             const profileTitleInput = document.getElementById('profileTitle');
             const profilePhoneInput = document.getElementById('profilePhone');
             const profileDepartmentInput = document.getElementById('profileDepartment'); // Added
             const profileBioInput = document.getElementById('profileBio'); // Added
             const saveProfileChangesBtn = document.getElementById('saveProfileChanges');
             const cancelProfileChangesBtn = document.getElementById('cancelProfileChanges');
             // Settings Elements
             const themeOptions = document.querySelectorAll('.theme-option');
             const layoutDensitySelect = document.getElementById('layoutDensitySelect');
             const soundNotificationsToggle = document.getElementById('soundNotificationsToggle');
             const weekStartSelect = document.getElementById('weekStartSelect');
             const savePreferencesBtn = document.getElementById('savePreferences');
             const emailTasksToggle = document.getElementById('emailTasks');
             const emailDeadlinesToggle = document.getElementById('emailDeadlines');
             const emailUpdatesToggle = document.getElementById('emailUpdates');
             const pushMessagesToggle = document.getElementById('pushMessages');
             const pushTeamUpdatesToggle = document.getElementById('pushTeamUpdates');
             const saveNotificationsBtn = document.getElementById('saveNotifications');
             const changePasswordBtn = document.getElementById('changePasswordBtn');
             const twoFactorToggle = document.getElementById('twoFactorToggle');
             const twoFactorSetupDiv = document.getElementById('twoFactorSetup');
             const twoFactorVerifyCodeInput = document.getElementById('twoFactorVerifyCode');
             const verify2FABtn = document.getElementById('verify2FABtn');
             const saveSecurityBtn = document.getElementById('saveSecurity'); // Might be optional
             const settingsTeamTab = document.getElementById('settingsTeamTab');
             const teamPanel = document.getElementById('teamPanel');
             const addMemberForm = document.getElementById('addMemberForm');
             const newMemberNameInput = document.getElementById('newMemberName');
             const newMemberEmailInput = document.getElementById('newMemberEmail');
             const newMemberRoleSelect = document.getElementById('newMemberRole');
             // Notification Modal Elements
             const notificationsModal = document.getElementById('notificationsModal');
             const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
             const notificationsBody = document.getElementById('notificationsBody');
             const noNotificationsMessage = document.getElementById('noNotificationsMessage');
             const markAllReadBtn = document.getElementById('markAllReadBtn');
             const clearAllNotificationsBtn = document.getElementById('clearAllNotificationsBtn');
             const themeToggleItem = document.getElementById('themeToggleItem'); // Example Theme toggle in dropdown
             const themeToggleText = document.getElementById('themeToggleText'); // Example Theme toggle text

             // --- STATE VARIABLES ---
             let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
             let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences';
             let scheduleLogicInitialized = false; let scheduleCurrentWeekStart = null; let scheduleSavedData = {};
             const scheduleLocalStorageKey = 'employeeSchedule_May2025_integrated_v3';
             // Default User - expanded slightly to match form fields
             const DEFAULT_USER = {
                id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', bio: 'Passionate about efficient workflows.', avatar: '', initials: 'ME', role: 'admin', password: 'password123', // Note: Password shouldn't ideally be stored like this
                preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' },
                notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } },
                security: { twoFactorEnabled: false }, // Default 2FA to false
                stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' }
             };

             // --- CORE DASHBOARD FUNCTIONS (Keep original implementations, add checks) ---
             function showConfirmModal(config) {
                 const confirmModal=document.getElementById('confirmModal');
                 const confirmTitle=document.getElementById('confirmTitle');
                 const confirmMessage=document.getElementById('confirmMessage');
                 let confirmBtnInstance = document.getElementById('confirmBtn');
                 let cancelConfirmBtnInstance = document.getElementById('cancelConfirmBtn');
                 if(!confirmModal||!confirmTitle||!confirmMessage||!confirmBtnInstance||!cancelConfirmBtnInstance) { console.error("Confirm modal elements missing!"); return; }
                 confirmTitle.textContent=config.title||'Confirm Action'; // Default title
                 confirmMessage.innerHTML=config.message||'Are you sure?';
                 confirmBtnInstance.textContent=config.confirmText||'Confirm';
                 cancelConfirmBtnInstance.textContent=config.cancelText||'Cancel';
                 confirmBtnInstance.className=`btn ${config.confirmClass||'btn-danger'}`;
                 cancelConfirmBtnInstance.className='btn btn-outline';
                 cancelConfirmBtnInstance.style.display = config.cancelText === '' ? 'none' : 'inline-flex'; // Hide cancel if no text

                 const newConfirmBtn=confirmBtnInstance.cloneNode(true); confirmBtnInstance.parentNode.replaceChild(newConfirmBtn,confirmBtnInstance); confirmBtnInstance=newConfirmBtn;
                 const newCancelBtn=cancelConfirmBtnInstance.cloneNode(true); cancelConfirmBtnInstance.parentNode.replaceChild(newCancelBtn,cancelConfirmBtnInstance); cancelConfirmBtnInstance=newCancelBtn;

                 const confirmHandler=()=>{if(config.onConfirm)config.onConfirm(); hideConfirmModal();}; const cancelHandler=()=>{if(config.onCancel)config.onCancel(); hideConfirmModal();};
                 confirmBtnInstance.addEventListener('click',confirmHandler,{once:true});
                 if (cancelConfirmBtnInstance.style.display !== 'none') { cancelConfirmBtnInstance.addEventListener('click',cancelHandler,{once:true}); }

                 confirmModal.style.display='flex'; confirmBtnInstance.focus();
             }
             function hideConfirmModal() { if(confirmModal) confirmModal.style.display='none'; }
             function showSuccessMessage(message) { if(successMessage&&successMessageText){ successMessageText.textContent=message; successMessage.classList.add('show'); setTimeout(()=>{ successMessage.classList.remove('show'); },3000); } else { console.log("Success:", message); } }
             function addActivity(icon, message, isNew = true) {
                 const newActivity = { id: Date.now(), icon, message, timestamp: new Date().toISOString(), isNew };
                 activities.unshift(newActivity); // Add to beginning
                 // Limit activities array size if needed
                 // activities = activities.slice(0, 50);
                 saveData();
                 if(currentFeature==='dashboard' && activityList) {
                     loadActivities(viewAllActivity?.style.display === 'none' && activities.length > 5); // Check if View All is hidden
                 }
                 if (isNew) {
                     addNotification('fa-bell', `New activity: ${message.substring(0, 30)}...`, false); // Add notification for new activity
                 }
             }
              const dashboardGlobals = { showConfirmModal, hideConfirmModal, showSuccessMessage, showErrorMessage: (msg) => showConfirmModal({title:"Error", message:msg, confirmText:"OK", confirmClass:"btn-warning", cancelText:""}), addActivity, getCurrentUser: () => JSON.parse(JSON.stringify(currentUser || {})), getTeamMembers: () => JSON.parse(JSON.stringify(teamMembers || [])), updateTeamMembers: (newTeam) => {if(Array.isArray(newTeam)){teamMembers=newTeam; saveData(); loadTeamMembers(); updateStats(); if(currentFeature === 'employee-scheduling' && scheduleLogicInitialized) { try { renderScheduleTable_schedule(); } catch(e){ console.error("Error rendering schedule after team update:", e);}} }} };
              window.dashboardApp = dashboardGlobals;
             function loadData() { /*...(Keep original try/catch)...*/ console.log("Data loaded. Team members:", teamMembers.length); }
             function saveData() { /*...(Keep original try/catch)...*/ }
             function updateUserUI() {
                 if (!currentUser) return;
                 const name = currentUser.name || 'User';
                 const initials = currentUser.initials || name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() || 'U';
                 const avatarUrl = currentUser.avatar;

                 // Top Nav and Dropdown
                 if (userNameDisplay) userNameDisplay.textContent = name.split(' ')[0]; // Show first name in top nav
                 if (dropdownUserName) dropdownUserName.textContent = name;
                 if (dropdownUserEmail) dropdownUserEmail.textContent = currentUser.email || '';
                 if (userAvatar) {
                     if (avatarUrl) { userAvatar.style.backgroundImage = `url(${avatarUrl})`; userAvatar.textContent = ''; }
                     else { userAvatar.style.backgroundImage = ''; userAvatar.textContent = initials; }
                 }

                 // Welcome Section
                 if (welcomeName) welcomeName.textContent = name;
                 if (welcomeUserNameFull) welcomeUserNameFull.textContent = name;
                 if (welcomeUserEmail) welcomeUserEmail.textContent = currentUser.email || '';
                 if (userInfoRoleTitle) userInfoRoleTitle.textContent = currentUser.title || 'Member';
                 if (welcomeUserAvatar) {
                     if (avatarUrl) { welcomeUserAvatar.style.backgroundImage = `url(${avatarUrl})`; welcomeUserAvatar.textContent = ''; }
                     else { welcomeUserAvatar.style.backgroundImage = ''; welcomeUserAvatar.textContent = initials; }
                 }

                 // Profile Page
                 if (profileAvatarLarge) {
                     if (avatarUrl) { profileAvatarLarge.style.backgroundImage = `url(${avatarUrl})`; profileAvatarLarge.textContent = ''; }
                     else { profileAvatarLarge.style.backgroundImage = ''; profileAvatarLarge.textContent = initials; }
                 }
                 if (profileNameInput) profileNameInput.value = name;
                 if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
                 if (profileTitleInput) profileTitleInput.value = currentUser.title || '';
                 if (profilePhoneInput) profilePhoneInput.value = currentUser.phone || '';
                 if (profileDepartmentInput) profileDepartmentInput.value = currentUser.department || '';
                 if (profileBioInput) profileBioInput.value = currentUser.bio || '';
             }
             function applyUserPreferences() {
                 if (!currentUser || !currentUser.preferences) return;
                 const { theme = 'blue', layoutDensity = 'normal' } = currentUser.preferences;
                 document.body.classList.remove('light-theme', 'dark-theme', 'blue-theme');
                 document.body.classList.add(theme + '-theme');
                 document.body.classList.remove('compact', 'normal', 'spacious');
                 document.body.classList.add(layoutDensity);

                  // Update settings form elements if they exist
                 if (layoutDensitySelect) layoutDensitySelect.value = layoutDensity;
                 if (soundNotificationsToggle) soundNotificationsToggle.checked = currentUser.preferences.soundNotifications || false;
                 if (weekStartSelect) weekStartSelect.value = currentUser.preferences.weekStart || 'sun';
                 themeOptions.forEach(opt => opt.classList.toggle('selected', opt.dataset.theme === theme));
                 if (themeToggleText) themeToggleText.textContent = `Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)}`; // Update dropdown text

                 console.log(`Preferences Applied: Theme=${theme}, Density=${layoutDensity}`);
             }
             function applyRBAC() { // Role-Based Access Control
                 if (!currentUser) return;
                 const isAdmin = currentUser.role === 'admin';
                 const isSupervisor = currentUser.role === 'supervisor';

                 // Settings Team Tab/Panel
                 if (settingsTeamTab) settingsTeamTab.style.display = isAdmin ? 'inline-block' : 'none';
                 if (teamPanel) teamPanel.style.display = isAdmin ? 'block' : 'none'; // Hide panel if tab is hidden during activation logic

                 // Make profile fields editable only by admin (example)
                 // if (profileTitleInput) profileTitleInput.readOnly = !isAdmin;
                 // if (profileDepartmentInput) profileDepartmentInput.readOnly = !isAdmin;

                 // Show delete buttons only to admin/supervisor (example)
                 // document.querySelectorAll('.delete-activity, .delete-notification, .member-actions .btn-danger').forEach(btn => {
                 //     btn.style.display = (isAdmin || isSupervisor) ? 'inline-flex' : 'none';
                 // });
                 if (deleteAllActivity) deleteAllActivity.style.display = (isAdmin || isSupervisor) ? 'inline-block' : 'none';
                 if (clearAllNotificationsBtn) clearAllNotificationsBtn.style.display = (isAdmin || isSupervisor) ? 'inline-block' : 'none';

                 // Scheduling controls visibility handled in initializeScheduleFeature_integrated
                 console.log(`RBAC Applied: Role=${currentUser.role}`);
             }
             function loadSettingsFormData() {
                 if (!currentUser) return;
                 const { preferences, notificationPreferences, security } = currentUser;

                 // Preferences Panel
                 if (preferences) {
                     if (layoutDensitySelect) layoutDensitySelect.value = preferences.layoutDensity || 'normal';
                     if (soundNotificationsToggle) soundNotificationsToggle.checked = preferences.soundNotifications || false;
                     if (weekStartSelect) weekStartSelect.value = preferences.weekStart || 'sun';
                     themeOptions.forEach(opt => opt.classList.toggle('selected', opt.dataset.theme === preferences.theme));
                 }

                 // Notifications Panel
                 if (notificationPreferences) {
                     if (emailTasksToggle && notificationPreferences.email) emailTasksToggle.checked = notificationPreferences.email.tasks || false;
                     if (emailDeadlinesToggle && notificationPreferences.email) emailDeadlinesToggle.checked = notificationPreferences.email.deadlines || false;
                     if (emailUpdatesToggle && notificationPreferences.email) emailUpdatesToggle.checked = notificationPreferences.email.updates || false;
                     if (pushMessagesToggle && notificationPreferences.push) pushMessagesToggle.checked = notificationPreferences.push.messages || false;
                     if (pushTeamUpdatesToggle && notificationPreferences.push) pushTeamUpdatesToggle.checked = notificationPreferences.push.teamUpdates || false;
                 }

                 // Security Panel
                 if (security) {
                    if (twoFactorToggle) twoFactorToggle.checked = security.twoFactorEnabled || false;
                    if (twoFactorSetupDiv) twoFactorSetupDiv.style.display = security.twoFactorEnabled ? 'block' : 'none'; // Show setup only if enabled initially (might need refinement)
                 }
             }
             function updateStats() {
                 if (!currentUser?.stats) return;
                 const { stats } = currentUser;
                 if (teamMembersCount) teamMembersCount.textContent = stats.teamMembers || 0;
                 if (tasksCompleted) tasksCompleted.textContent = stats.tasksCompleted || 0;
                 if (activeProjects) activeProjects.textContent = stats.activeProjects || 0;
                 if (upcomingDeadlines) upcomingDeadlines.textContent = stats.upcomingDeadlines || 0;
                 if (teamMembersTrend) updateTrendIndicator(teamMembersTrend, stats.teamMembersTrend || 'neutral');
                 if (tasksCompletedTrend) updateTrendIndicator(tasksCompletedTrend, stats.tasksCompletedTrend || 'neutral');
                 if (activeProjectsTrend) updateTrendIndicator(activeProjectsTrend, stats.activeProjectsTrend || 'neutral');
                 if (upcomingDeadlinesTrend) updateTrendIndicator(upcomingDeadlinesTrend, stats.upcomingDeadlinesTrend || 'neutral');
             }
             function updateTrendIndicator(element, trend) {
                 if (!element) return;
                 const icon = element.querySelector('i');
                 const text = element.querySelector('span');
                 element.className = 'stat-trend'; // Reset classes
                 if (trend === 'up') {
                     element.classList.add('trend-up');
                     if (icon) icon.className = 'fas fa-arrow-up';
                 } else if (trend === 'down') {
                     element.classList.add('trend-down');
                     if (icon) icon.className = 'fas fa-arrow-down';
                 } else {
                     element.classList.add('trend-neutral');
                      if (icon) icon.className = 'fas fa-minus';
                 }
                 // Update text if needed (e.g., percentage change) - simplified here
                 // if (text) text.textContent = '...';
             }
             function updateNotificationBadge() {
                 if (!notificationBadge) return;
                 const unreadCount = notifications.filter(n => !n.read).length;
                 notificationBadge.textContent = unreadCount;
                 notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
             }
             function loadActivities(showAll = false) {
                 if (!activityList) return;
                 const maxToShow = 5;
                 const activitiesToShow = showAll ? activities : activities.slice(0, maxToShow);

                 activityList.innerHTML = ''; // Clear current list

                 if (activitiesToShow.length === 0) {
                     activityList.innerHTML = `<li class="placeholder-content" style="padding: 2rem 1rem;">No recent activity.</li>`;
                     if(activityPlaceholder) activityPlaceholder.style.display = 'none'; // Hide loading placeholder
                     if (viewAllActivity) viewAllActivity.style.display = 'none';
                     if (deleteAllActivity) deleteAllActivity.style.display = 'none';
                     return;
                 }

                 if(activityPlaceholder) activityPlaceholder.style.display = 'none'; // Hide loading placeholder

                 activitiesToShow.forEach(activity => {
                     const li = document.createElement('li');
                     li.className = 'activity-item';
                     li.dataset.id = activity.id;
                     if (activity.isNew) {
                         li.classList.add('new-activity');
                         // Remove the 'new' status after animation (or on view)
                         setTimeout(() => {
                             const currentActivity = activities.find(a => a.id === activity.id);
                             if (currentActivity) currentActivity.isNew = false;
                             li.classList.remove('new-activity');
                             saveData(); // Save the updated status
                         }, 2500);
                     }
                     const iconHtml = `<div class="activity-icon"><i class="fas ${activity.icon || 'fa-info-circle'}"></i></div>`;
                     const contentHtml = `
                         <div class="activity-content">
                             <div class="activity-message">${activity.message}</div>
                             <div class="activity-time" data-timestamp="${activity.timestamp}">${getTimeAgo(activity.timestamp)}</div>
                         </div>`;
                     const actionsHtml = `
                         <div class="activity-actions">
                             <button class="delete-activity" title="Delete Activity"><i class="fas fa-times"></i></button>
                         </div>`;
                     li.innerHTML = iconHtml + contentHtml + actionsHtml;
                     activityList.appendChild(li);
                 });

                 // Show/hide View All button
                 if (viewAllActivity) {
                     viewAllActivity.style.display = (!showAll && activities.length > maxToShow) ? 'inline-block' : 'none';
                     viewAllActivity.textContent = showAll ? 'Show Less' : 'View All'; // Toggle text
                 }
                 if (deleteAllActivity) deleteAllActivity.style.display = (currentUser?.role === 'admin' || currentUser?.role === 'supervisor') && activities.length > 0 ? 'inline-block' : 'none';


                 // Add event listeners for delete buttons
                 activityList.querySelectorAll('.delete-activity').forEach(button => {
                     button.addEventListener('click', handleDeleteActivityClick);
                 });
             }
             function loadNotifications() {
                 if (!notificationsBody) return;
                 notificationsBody.innerHTML = ''; // Clear current list
                 const unreadNotifications = notifications.filter(n => !n.read);
                 const readNotifications = notifications.filter(n => n.read);
                 // Show unread first, then read, sorted by timestamp descending
                 const sortedNotifications = [...unreadNotifications, ...readNotifications]
                                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                 if (sortedNotifications.length === 0) {
                    if(noNotificationsMessage) noNotificationsMessage.style.display = 'block';
                 } else {
                    if(noNotificationsMessage) noNotificationsMessage.style.display = 'none';
                    sortedNotifications.forEach(notif => {
                         const div = document.createElement('div');
                         div.className = 'notification-list-item';
                         div.dataset.id = notif.id;
                         if (!notif.read) { div.classList.add('unread'); }

                         let iconClass = 'fa-bell'; // Default
                         let wrapperClass = '';
                         if (notif.type === 'alert') { iconClass = 'fa-exclamation-triangle'; wrapperClass = 'icon-danger'; }
                         else if (notif.type === 'success') { iconClass = 'fa-check-circle'; wrapperClass = 'icon-success'; }
                         else if (notif.icon) { iconClass = notif.icon; } // Allow specific icon override

                         div.innerHTML = `
                             <div class="notification-icon-wrapper ${wrapperClass}"> <i class="fas ${iconClass}"></i> </div>
                             <div class="notification-content">
                                 <div class="notification-message">${notif.message}</div>
                                 <div class="notification-time" data-timestamp="${notif.timestamp}">${getTimeAgo(notif.timestamp)}</div>
                             </div>
                             <button class="delete-notification" title="Delete Notification"><i class="fas fa-times"></i></button>
                         `;
                         div.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-notification')) {
                                 markNotificationAsRead(notif.id, div);
                                 // Add navigation logic here if notifications are clickable
                                 // e.g., if (notif.link) window.location.href = notif.link;
                             }
                         });
                         div.querySelector('.delete-notification').addEventListener('click', (e) => {
                             e.stopPropagation(); // Prevent marking as read when deleting
                             handleDeleteNotificationClick(notif.id);
                         });
                         notificationsBody.appendChild(div);
                    });
                 }
                 updateNotificationBadge();
             }
             function getTimeAgo(timestamp) {
                const now = new Date();
                const past = new Date(timestamp);
                const diffInSeconds = Math.floor((now - past) / 1000);
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                const diffInHours = Math.floor(diffInMinutes / 60);
                const diffInDays = Math.floor(diffInHours / 24);

                if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                if (diffInHours < 24) return `${diffInHours}h ago`;
                if (diffInDays === 1) return `Yesterday`;
                if (diffInDays < 7) return `${diffInDays}d ago`;
                return past.toLocaleDateString(); // Older than a week, show date
            }
             function updateActivityTimes() {
                 document.querySelectorAll('.activity-time[data-timestamp], .notification-time[data-timestamp]').forEach(el => {
                     const timestamp = el.dataset.timestamp;
                     if (timestamp) {
                         el.textContent = getTimeAgo(timestamp);
                     }
                 });
             }
             function startActivityTimeUpdater() { setInterval(updateActivityTimes, 60000); } // Update every minute
             function loadTeamMembers() {
                 if (!teamList) return; // Only run if the team list element exists (in settings)
                 teamList.innerHTML = ''; // Clear existing list
                 if (!Array.isArray(teamMembers) || teamMembers.length === 0) {
                     teamList.innerHTML = '<li class="placeholder-content">No team members found.</li>';
                     return;
                 }
                 teamMembers.forEach(member => {
                     const li = document.createElement('li');
                     li.className = 'team-member-card';
                     li.dataset.memberId = member.id;
                     const avatarInitials = member.initials || member.name?.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() || '?';
                     const avatarStyle = member.avatar ? `style="background-image: url('${member.avatar}')"` : '';
                     const roleClass = `role-${member.role || 'member'}`;

                     li.innerHTML = `
                         <div class="member-avatar" ${avatarStyle}>${member.avatar ? '' : avatarInitials}</div>
                         <div class="member-details">
                             <div class="member-name">${member.name || 'N/A'}</div>
                             <div class="member-email">${member.email || 'N/A'}</div>
                         </div>
                         <span class="member-role ${roleClass}">${member.role ? member.role.charAt(0).toUpperCase() + member.role.slice(1) : 'Member'}</span>
                         <div class="member-actions">
                             <button class="btn btn-sm btn-outline edit-member-btn"><i class="fas fa-pencil-alt"></i></button>
                             <button class="btn btn-sm btn-danger delete-member-btn"><i class="fas fa-trash-alt"></i></button>
                         </div>
                     `;
                     li.querySelector('.edit-member-btn').addEventListener('click', handleEditMemberClick);
                     li.querySelector('.delete-member-btn').addEventListener('click', handleDeleteMemberClick);
                     teamList.appendChild(li);
                 });
             }
             function handleProfileSave(e) {
                 e.preventDefault();
                 if (!currentUser || !profileForm) return;
                 // Update currentUser object from form fields
                 currentUser.name = profileNameInput?.value.trim() || currentUser.name;
                 currentUser.title = profileTitleInput?.value.trim() || currentUser.title;
                 currentUser.phone = profilePhoneInput?.value.trim() || currentUser.phone;
                 currentUser.department = profileDepartmentInput?.value.trim() || currentUser.department;
                 currentUser.bio = profileBioInput?.value.trim() || currentUser.bio;
                 currentUser.initials = currentUser.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() || 'U'; // Recalculate initials

                 saveData();
                 updateUserUI(); // Refresh UI elements
                 showSuccessMessage("Profile updated successfully!");
                 // Optionally, briefly disable save button
                 if (saveProfileChangesBtn) { saveProfileChangesBtn.disabled = true; setTimeout(() => {saveProfileChangesBtn.disabled = false;}, 1000); }
             }
             function handleProfileCancel() {
                 // Revert UI changes by reloading data from currentUser
                 updateUserUI();
                 showSuccessMessage("Changes cancelled.");
             }
             function handleSettingsSave(panelId) {
                 if (!currentUser) return;
                 let changesMade = false;
                 let successMsg = "Settings saved successfully!";

                 if (panelId === 'preferences') {
                     const newPrefs = {
                         theme: [...themeOptions].find(opt => opt.classList.contains('selected'))?.dataset.theme || currentUser.preferences.theme,
                         layoutDensity: layoutDensitySelect?.value || currentUser.preferences.layoutDensity,
                         soundNotifications: soundNotificationsToggle?.checked ?? currentUser.preferences.soundNotifications,
                         weekStart: weekStartSelect?.value || currentUser.preferences.weekStart
                     };
                     if (JSON.stringify(newPrefs) !== JSON.stringify(currentUser.preferences)) {
                        currentUser.preferences = { ...currentUser.preferences, ...newPrefs };
                        changesMade = true;
                        successMsg = "Preferences updated!";
                        applyUserPreferences(); // Apply immediately
                     }
                 } else if (panelId === 'notifications') {
                      const newNotifPrefs = {
                         email: {
                             tasks: emailTasksToggle?.checked ?? currentUser.notificationPreferences.email.tasks,
                             deadlines: emailDeadlinesToggle?.checked ?? currentUser.notificationPreferences.email.deadlines,
                             updates: emailUpdatesToggle?.checked ?? currentUser.notificationPreferences.email.updates
                         },
                         push: {
                             messages: pushMessagesToggle?.checked ?? currentUser.notificationPreferences.push.messages,
                             teamUpdates: pushTeamUpdatesToggle?.checked ?? currentUser.notificationPreferences.push.teamUpdates
                         }
                     };
                     if (JSON.stringify(newNotifPrefs) !== JSON.stringify(currentUser.notificationPreferences)) {
                        currentUser.notificationPreferences = newNotifPrefs;
                        changesMade = true;
                        successMsg = "Notification preferences updated!";
                     }
                 } else if (panelId === 'security') {
                     // Security settings might involve more complex actions like password change or 2FA verification
                     // For simplicity, we'll just save the 2FA toggle state here
                     const twoFactorState = twoFactorToggle?.checked ?? currentUser.security.twoFactorEnabled;
                     if (twoFactorState !== currentUser.security.twoFactorEnabled) {
                         // Add actual 2FA verification logic here before changing the state
                         currentUser.security.twoFactorEnabled = twoFactorState;
                         changesMade = true;
                         successMsg = `Two-Factor Authentication ${twoFactorState ? 'enabled' : 'disabled'}!`;
                         if (twoFactorSetupDiv) twoFactorSetupDiv.style.display = twoFactorState ? 'block' : 'none';
                     } else {
                         // Handle password change completion if applicable
                     }
                 }

                 if (changesMade) {
                     saveData();
                     showSuccessMessage(successMsg);
                 } else {
                     showSuccessMessage("No changes detected.");
                 }
             }
             function handleSettingsCancel(panelId) { loadSettingsFormData(); showSuccessMessage("Changes cancelled."); } // Revert form to saved state
             function handleInviteMember(e) {
                 e.preventDefault();
                 if (!addMemberForm) return;
                 const name = newMemberNameInput?.value.trim();
                 const email = newMemberEmailInput?.value.trim();
                 const role = newMemberRoleSelect?.value;

                 if (!name || !email || !role || !/^\S+@\S+\.\S+$/.test(email)) { dashboardGlobals.showErrorMessage("Please provide a valid name, email, and role."); return; }
                 if (teamMembers.some(m => m.email.toLowerCase() === email.toLowerCase())) { dashboardGlobals.showErrorMessage(`A team member with the email ${email} already exists.`); return; }

                 const newMember = {
                     id: Date.now(), name, email, role,
                     initials: name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase(),
                     avatar: '' // Default avatar
                 };
                 dashboardGlobals.updateTeamMembers([...teamMembers, newMember]);
                 addActivity('fa-user-plus', `Invited ${name} (${role}) to the team.`);
                 showSuccessMessage(`${name} has been added to the team.`);
                 addMemberForm.reset(); // Clear the form
             }
             function handleEditMemberClick(e) { /*...(Placeholder - Implement edit logic, maybe open a modal)...*/ const memberId = e.target.closest('.team-member-card')?.dataset.memberId; console.log("Edit member:", memberId); dashboardGlobals.showErrorMessage("Edit functionality not yet implemented."); }
             function handleDeleteMemberClick(e) {
                 const memberCard = e.target.closest('.team-member-card');
                 if (!memberCard) return;
                 const memberId = parseInt(memberCard.dataset.memberId);
                 const member = teamMembers.find(m => m.id === memberId);
                 if (!member) return;

                 showConfirmModal({
                     title: "Delete Team Member?",
                     message: `Are you sure you want to remove <strong>${member.name}</strong> from the team? This action cannot be undone.`,
                     confirmText: "Delete Member",
                     confirmClass: "btn-danger",
                     onConfirm: () => {
                         dashboardGlobals.updateTeamMembers(teamMembers.filter(m => m.id !== memberId));
                         addActivity('fa-user-minus', `Removed ${member.name} from the team.`);
                         showSuccessMessage(`${member.name} has been removed.`);
                     }
                 });
             }
             function handleDeleteActivityClick(e) {
                 const activityItem = e.target.closest('.activity-item');
                 if (!activityItem) return;
                 const activityId = parseInt(activityItem.dataset.id);
                 activities = activities.filter(a => a.id !== activityId);
                 saveData();
                 activityItem.remove(); // Remove from UI
                 showSuccessMessage("Activity deleted.");
                 // Reload activities if list becomes empty to show placeholder
                 if (activityList && activityList.children.length === 0) { loadActivities(); }
             }
             function handleDeleteAllActivities() {
                 showConfirmModal({
                     title: "Delete All Activities?",
                     message: "Are you sure you want to delete all activity logs? This action cannot be undone.",
                     confirmText: "Delete All",
                     confirmClass: "btn-danger",
                     onConfirm: () => {
                         activities = []; saveData(); loadActivities();
                         showSuccessMessage("All activities deleted.");
                     }
                 });
             }
             function markNotificationAsRead(notificationId, itemElement) {
                 const notification = notifications.find(n => n.id === notificationId);
                 if (notification && !notification.read) {
                     notification.read = true;
                     saveData();
                     if(itemElement) itemElement.classList.remove('unread');
                     updateNotificationBadge();
                 }
             }
             function handleMarkAllNotificationsRead() {
                let changed = false;
                notifications.forEach(n => { if (!n.read) { n.read = true; changed = true; } });
                if (changed) {
                    saveData();
                    loadNotifications(); // Reload UI to remove 'unread' class
                    showSuccessMessage("All notifications marked as read.");
                } else {
                    showSuccessMessage("No unread notifications.");
                }
             }
             function handleDeleteNotificationClick(notificationId) {
                 notifications = notifications.filter(n => n.id !== notificationId);
                 saveData();
                 loadNotifications(); // Reload UI
                 showSuccessMessage("Notification deleted.");
             }
             function handleDeleteAllNotifications() {
                  showConfirmModal({
                     title: "Clear All Notifications?",
                     message: "Are you sure you want to clear all notifications?",
                     confirmText: "Clear All",
                     confirmClass: "btn-danger",
                     onConfirm: () => {
                         notifications = []; saveData(); loadNotifications();
                         showSuccessMessage("All notifications cleared.");
                     }
                 });
             }
             function handleAvatarUpload(e) {
                 const file = e.target.files?.[0];
                 if (!file || !currentUser) return;
                 if (file.size > 2 * 1024 * 1024) { // Limit size (e.g., 2MB)
                    dashboardGlobals.showErrorMessage("File is too large. Please select an image under 2MB.");
                    return;
                 }
                 const reader = new FileReader();
                 reader.onload = (event) => {
                     const imageUrl = event.target?.result;
                     if (imageUrl) {
                         currentUser.avatar = imageUrl;
                         // In a real app, you'd upload this to a server and save the URL
                         saveData();
                         updateUserUI(); // Update avatars immediately
                         showSuccessMessage("Avatar updated successfully!");
                         addActivity('fa-image', 'Updated profile picture.');
                     }
                 };
                 reader.onerror = () => { dashboardGlobals.showErrorMessage("Failed to read image file."); };
                 reader.readAsDataURL(file);
                 if (avatarUploadInput) avatarUploadInput.value = ''; // Reset file input
             }
             function handleLogout() {
                  showConfirmModal({
                     title: "Logout",
                     message: "Are you sure you want to logout?",
                     confirmText: "Logout",
                     confirmClass: "btn-primary", // Less destructive color
                     onConfirm: () => {
                         console.log("Logging out...");
                         // Clear sensitive data - adjust as needed
                         localStorage.removeItem('currentUser');
                         localStorage.removeItem('teamMembers');
                         // Keep non-sensitive items like theme preference if desired
                         // localStorage.removeItem('activities');
                         // localStorage.removeItem('notifications');
                         // localStorage.removeItem(scheduleLocalStorageKey);

                         // Redirect or reload
                         window.location.reload(); // Simple reload
                     }
                 });
             }
             function addNotification(icon, message, playSound = true, type = 'info') { // Added type
                if (!notifications) notifications = [];
                 const newNotification = {
                    id: Date.now(), icon, message, timestamp: new Date().toISOString(), read: false, type: type // Added type
                 };
                 notifications.unshift(newNotification); // Add to beginning
                 // Limit notifications array size if needed
                 // notifications = notifications.slice(0, 100);
                 saveData();
                 if (currentFeature === 'notifications') { // Update UI only if modal is open
                     loadNotifications();
                 } else {
                     updateNotificationBadge(); // Update badge regardless
                 }
                 if (playSound && currentUser?.preferences?.soundNotifications) {
                     playNotificationSound();
                 }
             }
             function playNotificationSound() { if (notificationSound) { notificationSound.currentTime = 0; notificationSound.play().catch(e => console.warn("Audio play failed:", e)); } }
             function handleSearch() { /*...(Placeholder - Implement search logic)...*/ console.log("Search:", searchInput?.value); }
             function activateSettingsTab(tabId) {
                 if (!tabId) tabId = 'preferences';
                 currentSettingsTab = tabId;
                 settingsTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
                 settingsPanels.forEach(panel => {
                    const isActive = panel.id === tabId + 'Panel';
                    panel.classList.toggle('active', isActive);
                    panel.style.display = isActive ? 'block' : 'none'; // Ensure display matches class
                 });
                 if (tabId === 'team') { loadTeamMembers(); } // Load team members when tab is activated
                 else if (tabId !== 'preferences') { loadSettingsFormData(); } // Load form data for other tabs

                 if (currentFeature === 'settings') {
                    const hash = `#settings-${currentSettingsTab}`;
                    if (window.location.hash !== hash) { try { history.pushState({ feature: 'settings', tab: currentSettingsTab }, '', hash); } catch (e) { console.warn("History pushState failed:", e); } }
                 }
                 console.log("Activated settings tab:", tabId);
             }

            // --- EMPLOYEE SCHEDULING LOGIC (Integrated - Kept as is) ---
            // ... (Include the entire block from the previous correct version) ...
             function formatDateKey_schedule(date) { if (!date?.getTime) return null; const y=date.getFullYear(); const m=(date.getMonth()+1).toString().padStart(2,'0'); const d=date.getDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
            function getLocalDateFromKey_schedule(dateKey) { if (!dateKey?.match) return null; const p=dateKey.split('-'); return new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2])); }
            function updateWeekDisplay_schedule() {
                 const weekDisplay = document.getElementById('schedule-weekDisplay'); const prevWeekBtn = document.getElementById('schedule-prevWeekBtn'); const nextWeekBtn = document.getElementById('schedule-nextWeekBtn');
                 if (!weekDisplay || !prevWeekBtn || !nextWeekBtn) {console.warn("Missing schedule nav elements for week update"); return;}
                 const scheduleMinDate = new Date(2025, 4, 1); const scheduleMaxDate = new Date(2025, 4, 31);
                 if (!scheduleCurrentWeekStart) { const today=new Date(); const dow=today.getDay(); const diff=today.getDate()-dow+(dow===0?-6:1); scheduleCurrentWeekStart=new Date(today.getFullYear(),today.getMonth(),diff); if (scheduleCurrentWeekStart < scheduleMinDate) scheduleCurrentWeekStart = new Date(scheduleMinDate); if (scheduleCurrentWeekStart > scheduleMaxDate) { scheduleCurrentWeekStart = new Date(scheduleMaxDate); scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate() - 6); } }
                 const weekEnd = new Date(scheduleCurrentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); const options = { month: 'short', day: 'numeric' };
                 weekDisplay.textContent = `${scheduleCurrentWeekStart.toLocaleDateString('en-US', options)} - ${weekEnd.toLocaleDateString('en-US', options)}, ${scheduleCurrentWeekStart.getFullYear()}`;
                 const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; const headerRow = document.querySelector('#employeeSchedulingContent .schedule-table thead tr');
                 if (!headerRow) return; headerRow.innerHTML = '<th>Employee</th>'; const tempDate = new Date(scheduleCurrentWeekStart);
                 days.forEach(dayName => { const th=document.createElement('th'); const ds=tempDate.toLocaleDateString('en-US',{day:'numeric'}); const ms=tempDate.toLocaleDateString('en-US',{month:'short'}); th.innerHTML=`<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${ms} ${ds}</span></div>`; headerRow.appendChild(th); tempDate.setDate(tempDate.getDate()+1); });
                 const prevT=new Date(scheduleCurrentWeekStart); prevT.setDate(prevT.getDate()-1); prevWeekBtn.disabled=prevT<scheduleMinDate; const nextT=new Date(scheduleCurrentWeekStart); nextT.setDate(nextT.getDate()+7); nextWeekBtn.disabled=nextT>scheduleMaxDate;
            }
            function renderScheduleTable_schedule() {
                const scheduleTableBody = document.getElementById('schedule-table-body');
                if (!scheduleTableBody) { console.error("renderScheduleTable_schedule: Cannot find table body!"); return; }
                console.log(`Rendering schedule table. Employees: ${teamMembers.length}`);
                scheduleTableBody.innerHTML = ''; // Clear
                if (!Array.isArray(teamMembers) || teamMembers.length === 0) { scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--gray);">No employees defined. Add team members in Settings > Team Management.</td></tr>`; return; }
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; const isAdmin = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';
                teamMembers.forEach((employee, index) => {
                    if (!employee?.id || !employee?.name) { console.warn("Skipping invalid employee in render:", employee); return; }
                    const tr = document.createElement('tr'); tr.dataset.empId = employee.id;
                    const nameTd = document.createElement('td'); nameTd.className = `employee-name employee-${(index % 6) + 1}`; nameTd.textContent = employee.name; tr.appendChild(nameTd);
                    const tempDate = new Date(scheduleCurrentWeekStart);
                    days.forEach((day, dayIndex) => {
                        const td = document.createElement('td'); const dateKey = formatDateKey_schedule(tempDate);
                        if (!dateKey) { td.textContent='ERR'; tr.appendChild(td); tempDate.setDate(tempDate.getDate()+1); return; }
                        td.dataset.dateKey = dateKey; td.dataset.label = `${days[dayIndex]} (${tempDate.toLocaleDateString('en-us',{month:'short',day:'numeric'})})`;
                        const empKey = `emp-${employee.id}`; const shiftData = scheduleSavedData[empKey]?.[dateKey];
                        if (shiftData?.text && shiftData?.class) { const div=document.createElement('div'); div.className=`shift ${shiftData.class}`; div.textContent=shiftData.text; div.title=shiftData.notes||''; td.appendChild(div); }
                        if (isAdmin) { td.classList.add('admin-controls'); const es=document.createElement('span'); es.className='edit-shift'; es.dataset.empId=employee.id; es.dataset.dateKey=dateKey; es.textContent=shiftData?'(edit)':'(add)'; es.setAttribute('role','button'); es.setAttribute('tabindex','0'); es.onclick=handleEditShiftClick_schedule; es.onkeydown=editShiftKeydownHandler_schedule; td.appendChild(es); }
                        tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1);
                    }); scheduleTableBody.appendChild(tr);
                }); setupDynamicScheduleListeners_schedule();
            }
            function updateShiftDisplayUI_schedule(empId, dateKey, shiftText, shiftClass, notes = '') { const sBody = document.getElementById('schedule-table-body'); if(!sBody) return; const sel=`tr[data-emp-id="${empId}"] td[data-date-key="${dateKey}"]`; const cell=sBody.querySelector(sel); if(!cell) return; const es=cell.querySelector('.edit-shift'); const ex=shiftText&&shiftClass; const os=cell.querySelector('.shift'); if(os)os.remove(); if(ex){const div=document.createElement('div'); div.className=`shift ${shiftClass}`; div.textContent=shiftText; div.title=notes||''; if(es)cell.insertBefore(div,es); else cell.appendChild(div);} if(es)es.textContent=ex?'(edit)':'(add)'; }
            function handleWeekChange_schedule(direction) { if(!scheduleCurrentWeekStart) return; const min=new Date(2025,4,1); const max=new Date(2025,4,31); const newW=new Date(scheduleCurrentWeekStart); newW.setDate(newW.getDate()+(direction*7)); if(newW<min||newW>max && (newW.getMonth() !== 4 || newW.getFullYear() !== 2025) ) return; scheduleCurrentWeekStart=newW; updateWeekDisplay_schedule(); renderScheduleTable_schedule(); }
            function handleAddEmployeeClick_schedule() { const m=document.getElementById('schedule-employeeModal'); const f=document.getElementById('schedule-employeeForm'); if(m&&f){f.reset(); m.style.display='flex'; m.querySelector('#schedule-empName')?.focus();} }
            function handleSendRemindersClick_schedule() { /*...(Keep original implementation)...*/ }
            function handleSaveScheduleClick_schedule() { localStorage.setItem(scheduleLocalStorageKey, JSON.stringify(scheduleSavedData)); dashboardGlobals.showSuccessMessage("Schedule saved successfully."); addActivity('fa-calendar-check', `Employee schedule saved`); }
            function handleEmployeeFormSubmit_schedule(e) { /*...(Keep original implementation)...*/ }
            function handleEditShiftClick_schedule(event) { /*...(Keep original implementation)...*/ }
            function handleShiftFormSubmit_schedule(e) { /*...(Keep original implementation, maybe add 'shift-custom' to class list)...*/ }
            function handleDeleteShiftClick_schedule() { /*...(Keep original implementation)...*/ }
            const shiftTypeChangeHandler_schedule = (e) => { /*...(Keep original implementation)...*/ };
            const editShiftKeydownHandler_schedule = (e) => { if (e.key === 'Enter' || e.key === ' ') handleEditShiftClick_schedule(e); };
            function setupDynamicScheduleListeners_schedule() { /*...(Keep original implementation)...*/ }
            function setupScheduleEventListeners_schedule_static() { /*...(Keep original implementation)...*/ }
            function initializeScheduleFeature_integrated() { /*...(Keep original implementation)...*/ }

            // --- setActiveFeature (Revised - Kept from previous fix) ---
             function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`setActiveFeature: feature='${featureId}', tab='${settingsTab}'`);
                 if (currentFeature === 'employee-scheduling' && featureId !== 'employee-scheduling' && scheduleLogicInitialized) {
                    scheduleLogicInitialized = false; console.log("Reset schedule flag.");
                 }
                 currentFeature = featureId || 'dashboard';
                 currentSettingsTab = settingsTab || (featureId === 'settings' ? 'preferences' : null);
                 let hash = `#${currentFeature}`;
                 if (currentFeature === 'settings' && currentSettingsTab) { hash += `-${currentSettingsTab}`; }
                 if (window.location.hash !== hash) { try { history.pushState({ feature: currentFeature, tab: currentSettingsTab }, '', hash); } catch (e) { console.warn("History pushState failed:", e); } }
                 menuItems.forEach(item => item?.classList.toggle('active', item.dataset.feature === currentFeature));
                 allContentSections.forEach(section => { if(section) { section.style.display = 'none'; section.classList.remove('active'); } });
                 let targetSectionId;
                 if (currentFeature === 'dashboard') { targetSectionId = 'dashboardContent'; }
                 else if (currentFeature === 'profile') { targetSectionId = 'profileContent'; }
                 else if (currentFeature === 'settings') { targetSectionId = 'settingsContent'; }
                 else if (currentFeature === 'employee-scheduling') { targetSectionId = 'employeeSchedulingContent'; }
                 else { targetSectionId = `${currentFeature}Content`; } // Generic mapping

                 const targetSection = document.getElementById(targetSectionId);
                 if (targetSection) {
                     targetSection.style.display = 'block'; targetSection.classList.add('active');
                     // Run initializers AFTER showing section
                     if (targetSectionId === 'dashboardContent') { updateStats(); loadActivities(); }
                     else if (targetSectionId === 'profileContent') { updateUserUI(); }
                     else if (targetSectionId === 'settingsContent') { applyRBAC(); loadSettingsFormData(); activateSettingsTab(currentSettingsTab); }
                     else if (targetSectionId === 'employeeSchedulingContent') { initializeScheduleFeature_integrated(); }
                 } else {
                     console.error(`Target section ${targetSectionId} not found! Defaulting to dashboard.`);
                     const dashSection = document.getElementById('dashboardContent');
                     if (dashSection) {
                         dashSection.style.display = 'block'; dashSection.classList.add('active'); updateStats(); loadActivities();
                         currentFeature = 'dashboard'; menuItems.forEach(item => item?.classList.toggle('active', item.dataset.feature === 'dashboard'));
                         if (window.location.hash !== '#dashboard') { try { history.pushState({ feature: 'dashboard', tab: null }, '', '#dashboard'); } catch(e) {} }
                     } else { console.error("Fallback dashboardContent not found!"); }
                 }
                 if (backButton) backButton.style.display = currentFeature !== 'dashboard' ? 'inline-flex' : 'none';
                 window.scrollTo(0, 0);
             }

            // --- handleInitialNavigation (Revised - Kept from previous fix) ---
             function handleInitialNavigation() {
                 const hash = window.location.hash.substring(1); let featureId = 'dashboard'; let settingsTab = null;
                 if (hash) {
                     if (hash.startsWith('settings-')) {
                         featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences';
                     } else {
                         const isValidFeature = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile';
                         if (isValidFeature) { featureId = hash; }
                     }
                 }
                 console.log(`Initial navigation: feature='${featureId}', tab='${settingsTab}'`);
                 setActiveFeature(featureId, settingsTab);
             }

            // --- INIT DASHBOARD ---
             function initDashboard() {
                 loadData();
                 applyUserPreferences();
                 updateUserUI();
                 loadTeamMembers(); // Load team data early
                 applyRBAC();
                 loadActivities(); // Load dashboard default data
                 loadNotifications();
                 updateStats();
                 setupEventListeners(); // Setup listeners after basic UI is ready
                 handleInitialNavigation(); // Activate correct section based on URL/default
                 startActivityTimeUpdater();
                 console.log("Dashboard Initialized");
             }

            // --- Setup Core Event Listeners (Revised - Kept from previous fix) ---
             function setupEventListeners() {
                  console.log("Setting up CORE dashboard listeners...");
                  const safeAddListener = (el, ev, h, capture = false) => { if(el) { el.addEventListener(ev, h, capture); } else { /* Optional: Less aggressive warning */ /* console.warn(`Listener not added: Element missing for ${ev}.`); */ } };

                  // Sidebar Navigation
                  menuItems.forEach(item => safeAddListener(item, 'click', (e) => { e.preventDefault(); const feature = item.dataset.feature; if (feature) { setActiveFeature(feature, null); } else { console.error("Menu item missing data-feature:", item); } }));
                  // Back Button
                  safeAddListener(backButton, 'click', () => setActiveFeature('dashboard'));
                  // Browser Back/Forward
                  window.addEventListener('popstate', (event) => { if (event.state?.feature) { setActiveFeature(event.state.feature, event.state.tab); } else { handleInitialNavigation(); } });
                  // User Dropdown Toggle
                  safeAddListener(userProfileToggle, 'click', (e) => { e.stopPropagation(); if (userDropdown) { userDropdown.classList.toggle('active'); userProfileToggle.setAttribute('aria-expanded', userDropdown.classList.contains('active')); } });
                  // Close dropdown on outside click
                  safeAddListener(document, 'click', (e) => { if (userDropdown?.classList.contains('active') && !userDropdown.contains(e.target) && !userProfileToggle?.contains(e.target)) { userDropdown.classList.remove('active'); userProfileToggle?.setAttribute('aria-expanded', 'false'); } }, true);
                  // Dropdown Links
                  safeAddListener(profileLink, 'click', (e)=>{ e.preventDefault(); userDropdown?.classList.remove('active'); setActiveFeature('profile'); });
                  safeAddListener(settingsLink, 'click', (e)=>{ e.preventDefault(); userDropdown?.classList.remove('active'); setActiveFeature('settings'); });
                  safeAddListener(logoutLink, 'click', (e)=>{ e.preventDefault(); userDropdown?.classList.remove('active'); handleLogout(); });
                 // Example: Theme toggle from dropdown
                 safeAddListener(themeToggleItem, 'click', (e) => {
                     e.preventDefault();
                     const currentTheme = currentUser.preferences.theme || 'blue';
                     const nextTheme = currentTheme === 'blue' ? 'dark' : currentTheme === 'dark' ? 'light' : 'blue';
                     currentUser.preferences.theme = nextTheme;
                     saveData();
                     applyUserPreferences();
                     userDropdown?.classList.remove('active'); // Close dropdown
                     showSuccessMessage(`Theme switched to ${nextTheme}`);
                 });

                 // Settings Tabs
                 settingsTabs.forEach(tab => safeAddListener(tab, 'click', () => { if (!tab.classList.contains('disabled') && !tab.classList.contains('active')) { activateSettingsTab(tab.dataset.tab); } }));
                 // Settings Save Buttons
                 safeAddListener(savePreferencesBtn, 'click', () => handleSettingsSave('preferences'));
                 safeAddListener(saveNotificationsBtn, 'click', () => handleSettingsSave('notifications'));
                 safeAddListener(saveSecurityBtn, 'click', () => handleSettingsSave('security'));
                 // Settings Theme Selection
                 themeOptions.forEach(opt => safeAddListener(opt, 'click', () => { themeOptions.forEach(o => o.classList.remove('selected')); opt.classList.add('selected'); }));
                 // Settings 2FA Toggle
                 safeAddListener(twoFactorToggle, 'change', () => { if (twoFactorSetupDiv) twoFactorSetupDiv.style.display = twoFactorToggle.checked ? 'block' : 'none'; /* Add verification logic here */ });

                 // Profile Form Actions
                 safeAddListener(profileForm, 'submit', handleProfileSave);
                 safeAddListener(cancelProfileChangesBtn, 'click', handleProfileCancel);
                 safeAddListener(uploadPhotoButton, 'click', () => avatarUploadInput?.click());
                 safeAddListener(avatarUploadInput, 'change', handleAvatarUpload);
                 // Team Management Form
                 safeAddListener(addMemberForm, 'submit', handleInviteMember);
                 // Activity Feed Actions
                 safeAddListener(viewAllActivity, 'click', () => { const showAll = viewAllActivity.textContent === 'View All'; loadActivities(showAll); });
                 safeAddListener(deleteAllActivity, 'click', handleDeleteAllActivities);
                 // Notifications Modal
                 safeAddListener(notificationIcon, 'click', () => { if(notificationsModal) { notificationsModal.style.display = 'flex'; loadNotifications(); } }); // Load fresh notifications on open
                 safeAddListener(closeNotificationsBtn, 'click', () => { if(notificationsModal) notificationsModal.style.display = 'none'; });
                 safeAddListener(markAllReadBtn, 'click', handleMarkAllNotificationsRead);
                 safeAddListener(clearAllNotificationsBtn, 'click', handleDeleteAllNotifications);

                 // Add listeners for search, password change btn etc. if needed
                 // safeAddListener(searchInput, 'input', handleSearch);
                 // safeAddListener(changePasswordBtn, 'click', () => { /* Open password change modal */ });

                 console.log("CORE dashboard listeners attached.");
             }

            // --- RUN INITIALIZATION ---
            initDashboard();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

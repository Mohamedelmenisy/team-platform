<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links (Team Management System Favicon) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- الستايلات الأصلية للداش بورد --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a; /* Dark blue */
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a; /* Dark blue */
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Used for admin role title color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-light);
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; }
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }

        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }

        /* Top Navigation */
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--dark); }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--dark); }
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: 100%; right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--dark); text-decoration: none; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; }

        /* Content Area */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; }
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }

        /* Welcome Section */
        .welcome-section { background-color: var(--primary-dark); color: var(--white); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: padding 0.3s ease, margin-bottom 0.3s ease, background-color 0.3s ease; }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; }
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; }
        .user-info-title.role-admin { color: var(--team-manager); }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }

        /* Stats Section */
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background-color: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; }
        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary), var(--secondary)); opacity: 0.9; }
        .stat-title { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { color: var(--primary); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); } .trend-down { color: var(--danger); } .trend-neutral { color: var(--gray); }

        /* Activity Section */
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); } .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); } .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; } /* Ensure no default padding */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--dark); }
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 1; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; }
        .delete-activity:hover { background-color: rgba(239, 68, 68, 0.1); }

        /* Generic Content Sections (Profile, Settings, Features) */
        /* These are the containers for static content */
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        .content-section.active { display: block; }
        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }

        /* Section Headers (used in Profile, Settings, Features) */
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; }
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }

        /* --- Profile Section Specific Styles --- */
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #uploadPhotoButton { margin-top: 0.5rem;}

        /* Forms (Profile, Settings) */
        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); transition: margin-bottom 0.3s ease, font-size 0.3s ease; }
        body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--dark); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }

        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); } .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; } .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Settings Content Specifics */
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; } .slider.round:before { border-radius: 50%; }

        /* Team Management Panel */
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--dark); margin-bottom: 1rem; }
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        .member-details { flex: 1; min-width: 0; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-email { font-size: 0.8rem; }
        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; }
        body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); } .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); } .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); } .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        /* --- Updated Add Member Form for Invite --- */
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }

        /* Theme Classes & Dark Theme Styles */
        body.light-theme { --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; background-color: var(--primary-light); }
        body.dark-theme { --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #1e293b; --light: #334155; --white: #0f172a; --dark: #e2e8f0; --gray: #94a3b8; --light-gray: #334155; background-color: var(--white); }
        body.dark-theme .top-nav, body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme .team-member-card, body.dark-theme .add-member-form { background-color: var(--primary-light); }
        body.dark-theme .search-bar input, body.dark-theme .form-control { background-color: var(--light); border-color: var(--light-gray); color: var(--dark); }
        body.dark-theme .form-control[readonly] { background-color: var(--primary-light); }
        body.dark-theme .search-results, body.dark-theme .user-dropdown, body.dark-theme .notifications-container, body.dark-theme .confirm-container { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item:hover, body.dark-theme .dropdown-item:hover, body.dark-theme .notification-list-item:hover, body.dark-theme .back-button:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .theme-option div { border-color: var(--light-gray); }
        body.dark-theme .theme-option[data-theme="dark"] div { border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--primary-light); }
        body.dark-theme .welcome-section { background-color: var(--primary-dark); color: var(--white); }
        body.dark-theme .user-info-title, body.dark-theme .user-info-email, body.dark-theme .welcome-subtitle { color: var(--light-gray); }
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.blue-theme { --primary-light: #dbeafe; --light: #eff6ff; --white: #ffffff; --dark: #1e293b; background-color: var(--primary-light); }

        /* Theme Selection Options */
        .theme-option { display: flex; flex-direction: column; align-items: center; }
        .theme-option div { width: 60px; height: 40px; border: 2px solid var(--light-gray); border-radius: 6px; cursor: pointer; transition: border-color 0.2s; }
        .theme-option span { text-align: center; display: block; margin-top: 0.5rem; font-size: 0.9rem; color: var(--dark); }
        .theme-option:hover div { border-color: var(--primary); }
        .theme-option.selected div { border-color: var(--primary); border-width: 3px; }

        /* Notifications Modal */
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: center; cursor: pointer; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.05); font-weight: 500; }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s; margin-left: auto; padding: 0.5rem; flex-shrink: 0; }
        .delete-notification:hover { opacity: 1; }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); }

        /* Confirm Modal */
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }

        /* Success Message */
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }

        /* Responsive Design */
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); width: 250px; } .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); } .main-content { margin-left: 0; } .search-bar { width: 250px; } .team-member-card { flex-wrap: wrap; } }
        @media (max-width: 768px) { .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; } .search-bar { width: 100%; order: 2; } .user-menu { width: 100%; justify-content: space-between; order: 1; } .content-area { padding: 1.5rem; } .data-form { grid-template-columns: 1fr; } .form-actions { grid-column: span 1; } .user-info { flex-direction: column; text-align: center; } .user-info-avatar { margin-bottom: 1rem; } .stats-section { grid-template-columns: 1fr; } .settings-tabs { flex-wrap: wrap; } .settings-tab { padding: 0.5rem 1rem; } .confirm-container { width: 90%; } .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; } .member-role { margin: 0.5rem 0; } .member-actions { margin-top: 0.5rem; } .profile-avatar-section { margin-bottom: 1.5rem; } #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; } .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; } .add-member-form .data-form > div { margin-bottom: 1rem; } .add-member-form .data-form > div:last-child { margin-top: 0; } }
        @media (max-width: 480px) { .section-header > div { justify-content: center; width: 100%; } .welcome-section { padding: 1.5rem; } .stats-section { gap: 0.75rem; } .stat-card { padding: 1rem; } }

        /* --- Back button Styles --- */
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }

        /* Notification sound */
        #notificationSound { display: none; }

        /* Helper class */
        .d-none { display: none !important; }

        /* Connection status in sidebar */
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* Password error message */
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }

        /* Loading spinner */
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }

         /* Placeholder styling for dynamically loaded features */
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; }


        /* ================================================ */
        /* == START: CSS From Employee Schedule ========== */
        /* ================================================ */
        /* Styles relevant to the schedule section when loaded */

        /* Main Content - Keep relevant parts */
        #featureSections .page-header { /* Scope to loaded section */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap; /* Allow wrap */
            gap: 1rem; /* Add gap */
        }
        #featureSections .page-title { /* Scope to loaded section */
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
        }

        /* Schedule Controls */
        #featureSections .schedule-controls { /* Scope to loaded section */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            background-color: var(--white); /* Use dashboard variables */
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap; /* Allow wrap */
            gap: 1rem; /* Add gap */
        }
        #featureSections .week-navigation { display: flex; align-items: center; gap: 1rem; }
        #featureSections .week-display { font-weight: 600; min-width: 180px; text-align: center; }

        /* Schedule Button Styles (ensure no conflicts with main .btn) */
        /* These extend the main .btn styles if needed */
        #featureSections .schedule-controls .btn,
        #featureSections .modal .btn { /* Scope to schedule/modal buttons */
            /* Inherits base .btn styles, add specifics if needed */
            padding: 0.5rem 1rem;
        }
        #featureSections .btn-primary { background-color: var(--primary); color: white; }
        #featureSections .btn-primary:hover { background-color: var(--primary-dark); }
        #featureSections .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        #featureSections .btn-outline:hover { background-color: var(--primary-light); }
        #featureSections .btn-danger { background-color: var(--danger); color: white; }
        #featureSections .btn-danger:hover { background-color: #dc2626; }

        /* Schedule Table */
        #featureSections .schedule-container { /* Scope to loaded section */
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Crucial for responsiveness */
            margin-top: 1rem; /* Add some space */
        }
        #featureSections .schedule-table { /* Scope to loaded section */
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        #featureSections .schedule-table thead th {
            padding: 1rem 0.5rem; text-align: center; background-color: var(--primary); color: white; font-weight: 600;
            position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark);
        }
        #featureSections .schedule-table tbody td {
            padding: 0.75rem 0.5rem; text-align: center; border: 1px solid var(--light-gray); background-color: var(--white);
        }
        #featureSections .schedule-table tbody tr:hover td { background-color: var(--light); }
        #featureSections .employee-name {
            font-weight: 600; text-align: left; position: sticky; left: 0; background-color: inherit;
            padding: 0.75rem 1rem; white-space: nowrap; border-right: 2px solid var(--primary-light); z-index: 5;
        }

        /* Shift Styles */
        #featureSections .shift { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; display: inline-block; }
        #featureSections .shift-morning { background-color: #dbeafe; color: #1e40af; }
        #featureSections .shift-afternoon { background-color: #e0f2fe; color: #0c4a6e; }
        #featureSections .shift-night { background-color: #ede9fe; color: #5b21b6; }
        #featureSections .day-off { background-color: #f0fdf4; color: #166534; }
        #featureSections .sick-leave { background-color: #fee2e2; color: #991b1b; }
        #featureSections .vacation { background-color: #ffedd5; color: #9a3412; }

        /* Compact day headers */
        #featureSections .day-header { display: flex; flex-direction: column; gap: 0.25rem; }
        #featureSections .day-name { font-weight: 600; font-size: 0.9rem; }
        #featureSections .day-date { font-size: 0.8rem; opacity: 0.9; }

        /* Modal Styles */
        /* Targeting modals potentially anywhere, but assumes they load inside #featureSections */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; padding: 1rem; }
        .modal-content { background-color: var(--white); width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); padding: 2rem; max-height: 90vh; overflow-y: auto; animation: fadeInScale 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--light-gray); padding-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1; padding: 0; }
        .close-modal:hover { color: var(--dark); }
        .modal .form-group { margin-bottom: 1.5rem; }
        .modal label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); }
        .modal .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; }
        .modal .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .modal .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--light-gray); }

        /* Admin Controls specific to schedule */
        #featureSections .admin-controls { position: relative; padding-right: 35px; }
        #featureSections .edit-shift { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); font-size: 0.8rem; display: none; /* JS controls visibility */ background: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 3px; }
        /* #featureSections .admin-controls:hover .edit-shift { display: inline; } */ /* Removed hover display, JS handles it */

        /* Toast Notification (scoped if possible) */
        #featureSections .toast { /* Try scoping */
            position: fixed; bottom: 20px; right: 20px; background-color: var(--primary); color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1100; display: none; max-width: 300px; font-size: 0.9rem;
        }
        #featureSections .toast.show { display: block; animation: fadeIn 0.3s, fadeOut 0.3s 2.7s forwards; }
        /* Keyframes are global, no need to scope */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        /* Responsive Design adjustments for schedule */
        @media (max-width: 768px) {
            #featureSections .schedule-controls { justify-content: center; }
            #featureSections .page-header { justify-content: center; text-align: center; }
            #featureSections .page-header > div { width: 100%; display: flex; justify-content: center; gap: 1rem; }
            #featureSections .employee-name { position: static; border-right: none; white-space: normal; }
            .modal-content { padding: 1.5rem; max-height: 85vh; }
            .modal-title { font-size: 1.3rem; }
            .modal .form-actions { flex-direction: column; gap: 0.5rem; }
            .modal .form-actions .btn { width: 100%; }
            #featureSections .admin-controls { padding-right: 5px; }
            #featureSections .edit-shift { position: static; transform: none; display: block; /* Make visible if JS allows */ text-align: center; margin-top: 4px; background: none; padding: 0; }
        }
         @media (max-width: 480px) {
             #featureSections .week-navigation { justify-content: center; }
             #featureSections .week-display { min-width: 150px; font-size: 0.9rem;}
             #featureSections .schedule-table thead th { padding: 0.75rem 0.25rem; }
             #featureSections .schedule-table tbody td { padding: 0.5rem 0.25rem; }
             #featureSections .employee-name { padding: 0.5rem; font-size: 0.9rem;}
             #featureSections .shift { font-size: 0.7rem; padding: 0.15rem 0.3rem; }
         }
        /* ================================================ */
        /* == END: CSS From Employee Schedule ============ */
        /* ================================================ */

    </style>
</head>
<body class="blue-theme"> <!-- Default theme, JS will override based on prefs -->
    <!-- Notification sound (hidden) -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Success message -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <span id="successMessageText">Action successful!</span>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-title">Navigation</div>
            <a href="#dashboard" class="menu-item active" data-feature="dashboard">
                <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
            </a>
            <a href="#projects" class="menu-item" data-feature="projects">
                <i class="fas fa-briefcase"></i><span>Projects</span>
            </a>
            <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics">
                <i class="fas fa-chart-line"></i><span>Reports & Analytics</span>
            </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view">
                 <i class="fas fa-users"></i><span>Team Members</span>
             </a>

            <div class="menu-title">Core Features</div>
            <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
            <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
            <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
            <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>

            <div class="menu-title">Team Tools</div>
             <!-- ***** Feature ID should match the filename in /sections ***** -->
            <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
            <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
            <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
            <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>

            <div class="menu-divider"></div>

            <a href="#settings" class="menu-item" data-feature="settings">
                <i class="fas fa-cog"></i><span>Settings</span>
            </a>
        </div>

        <!-- Connection Status at the bottom -->
        <div class="connection-status">
            <div class="status-dot"></div>
            <span>Online</span>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="user-menu">
                <div class="notification-icon" id="notificationIcon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span>
                </div>
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">ME</div>
                    <div class="user-profile-details">
                        <span class="user-name" id="userName">Mohamed Elmenisy</span>
                        <span class="user-status"> • Connected</span>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#profile" class="dropdown-item" id="profileLink"><i class="fas fa-user"></i><span>Profile</span></a>
                        <a href="#settings" class="dropdown-item" id="settingsLink"><i class="fas fa-cog"></i><span>Settings</span></a>
                        <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="content-area">
             <div class="back-button" id="backButton" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </div>

            <!-- Dashboard Content (Static) -->
            <div id="dashboardContent" class="content-section active">
                <div class="welcome-section">
                    <h2 class="welcome-title">Welcome, <span id="welcomeName">Mohamed</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                    <div class="user-info">
                        <div class="user-info-avatar" id="profileAvatar">ME</div>
                        <div class="user-info-details">
                            <div class="user-info-name">Mohamed Elmenisy</div>
                            <div class="user-info-title" id="userInfoRoleTitle">Administrator</div>
                            <div class="user-info-email">
                                <i class="fas fa-envelope"></i>
                                <span id="userEmail">m.elsayed@thechefz.co</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="stats-section">
                     <div class="stat-card"><div class="stat-title"><i class="fas fa-users"></i>Team Members</div><div class="stat-value"><span id="teamMembersCount">0</span><span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                    <div class="stat-card"><div class="stat-title"><i class="fas fa-check-circle"></i>Tasks Completed</div><div class="stat-value"><span id="tasksCompleted">0</span><span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                    <div class="stat-card"><div class="stat-title"><i class="fas fa-project-diagram"></i>Active Projects</div><div class="stat-value"><span id="activeProjects">0</span><span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                    <div class="stat-card"><div class="stat-title"><i class="fas fa-calendar-times"></i>Upcoming Deadlines</div><div class="stat-value"><span id="upcomingDeadlines">0</span><span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> 0%</span></div></div>
                </div>
                <div class="activity-section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                        <div>
                            <span class="view-all" id="viewAllActivity" style="display: none;">Show All</span>
                            <span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span>
                        </div>
                    </div>
                    <ul class="activity-list" id="activityList">
                        <li style="text-align: center; padding: 2rem; color: var(--gray);">Loading activities...</li>
                    </ul>
                </div>
            </div>

            <!-- Profile Content (Static) -->
            <div class="content-section" id="profileContent">
                 <div class="section-main-header"><h2 class="section-main-title">Profile</h2></div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark);">Avatar</label>
                     <div id="profileAvatarLarge">ME</div>
                     <button type="button" class="btn btn-outline btn-sm" id="uploadPhotoButton"><i class="fas fa-upload"></i> Upload Photo</button>
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                    <div class="form-group"><label for="firstName">First Name</label><input type="text" id="firstName" class="form-control" value="Mohamed"></div>
                    <div class="form-group"><label for="lastName">Last Name</label><input type="text" id="lastName" class="form-control" value="Elmenisy"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="fullNameDisplay">Full Name</label><input type="text" id="fullNameDisplay" class="form-control" value="Mohamed Elmenisy" readonly></div>
                    <div class="form-group"><label for="jobTitle">Job Title</label><input type="text" id="jobTitle" class="form-control" value="Administrator"></div>
                    <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" value="m.elsayed@thechefz.co" readonly></div>
                    <div class="form-group"><label for="phone">Phone Number</label><input type="tel" id="phone" class="form-control" value="+201234567890"></div>
                    <div class="form-group"><label for="department">Department</label><input type="text" id="department" class="form-control" value="Management"></div>
                    <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div>
                </form>
            </div>

            <!-- Settings Content (Static Structure) -->
            <div class="content-section" id="settingsContent">
                <div class="section-main-header"><h2 class="section-main-title">System Settings</h2></div>
                <div class="settings-tabs">
                    <div class="settings-tab active" data-tab="preferences">Preferences</div><div class="settings-tab" data-tab="account">Account</div><div class="settings-tab" data-tab="security">Security</div><div class="settings-tab" data-tab="notifications">Notifications</div><div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div><div class="settings-tab" data-tab="collaboration">Collaboration</div><div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                </div>
                <!-- Panels inside Settings -->
                <div class="settings-panel active" id="preferencesPanel">
                     <h3 class="section-title">Preferences</h3>
                     <form class="data-form" id="preferencesForm">
                         <div class="form-group"><label>Theme</label><div style="display: flex; gap: 1rem; margin-top: 0.5rem;"><div class="theme-option" data-theme="light"><div style="background-color: #f1f5f9;"></div><span>Light</span></div><div class="theme-option" data-theme="dark"><div style="background-color: #0f172a;"></div><span>Dark</span></div><div class="theme-option selected" data-theme="blue"><div style="background-color: #dbeafe;"></div><span>Blue</span></div></div><input type="hidden" id="selectedTheme" value="blue"></div>
                         <div class="form-group"><label for="layoutDensity">Layout Density</label><select id="layoutDensity" class="form-control"><option value="compact">Compact</option><option value="normal" selected>Normal</option><option value="spacious">Spacious</option></select></div>
                         <div class="form-group"><label for="language">Language</label><select id="language" class="form-control"><option value="en" selected>English</option><option value="ar">Arabic (Placeholder)</option><option value="es">Spanish (Placeholder)</option></select></div>
                         <div class="form-group"><label for="dateFormat">Date Format</label><select id="dateFormat" class="form-control"><option value="mm/dd/yyyy">MM/DD/YYYY</option><option value="dd/mm/yyyy" selected>DD/MM/YYYY</option><option value="yyyy-mm-dd">YYYY-MM-DD</option></select></div>
                         <div class="form-group"><label for="region">Region</label><input type="text" id="region" class="form-control" placeholder="Cairo (Placeholder)" disabled></div>
                         <div class="form-group"><label for="weekStart">Calendar Week Start</label><select id="weekStart" class="form-control"><option value="sun" selected>Sunday</option></select></div>
                         <div class="form-group" style="grid-column: span 2;"><label for="defaultHomepage">Default Homepage (Placeholder)</label><select id="defaultHomepage" class="form-control" disabled><option selected>Dashboard</option><option>Tasks</option><option>Calendar</option></select></div>
                         <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelPreferencesBtn">Cancel</button><button type="submit" class="btn btn-primary" id="savePreferencesBtn"><span class="btn-text">Save Preferences</span><div class="spinner" id="preferencesSpinner"></div><span class="loading-text" id="preferencesLoadingText">Saving...</span></button></div>
                     </form>
                </div>
                <div class="settings-panel" id="accountPanel">
                    <h3 class="section-title">Account Settings</h3>
                    <form class="data-form" id="accountForm">
                        <div class="form-group"><label for="acc_firstName">First Name</label><input type="text" id="acc_firstName" class="form-control" readonly></div>
                        <div class="form-group"><label for="acc_lastName">Last Name</label><input type="text" id="acc_lastName" class="form-control" readonly></div>
                        <div class="form-group"><label for="acc_email">Email</label><input type="email" id="acc_email" class="form-control" readonly></div>
                        <div class="form-group"><label for="timezone">Timezone</label><select id="timezone" class="form-control"><option value="utc">UTC</option><option value="cairo" selected>Cairo (UTC+2)</option><option value="new_york">New York (UTC-5)</option></select></div>
                        <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelAccountBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveAccountBtn"><span class="btn-text">Save Settings</span><div class="spinner" id="accountSpinner"></div><span class="loading-text" id="accountLoadingText">Saving...</span></button></div>
                        <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"><label style="color: var(--danger);">Account Deletion</label><p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 1rem;">Permanently delete your account and all associated data. This action cannot be undone.</p><button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled>Delete Account (Placeholder)</button></div>
                    </form>
                </div>
                <div class="settings-panel" id="securityPanel">
                     <h3 class="section-title">Security Settings</h3>
                    <form class="data-form" id="securityForm">
                        <div class="form-group" style="grid-column: span 2;"><label>Two-Factor Authentication (2FA)</label><div style="display: flex; align-items: center; gap: 1rem;"><label class="switch"><input type="checkbox" id="twoFactorAuth" checked><span class="slider round"></span></label><span>Enabled</span></div><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">Requires authentication code from your app upon login.</p></div>
                        <div class="form-group"><label for="currentPassword">Current Password</label><input type="password" id="currentPassword" class="form-control" autocomplete="current-password"><div class="password-error" id="currentPasswordError">Current password is incorrect</div></div>
                        <div class="form-group"><label for="newPassword">New Password</label><input type="password" id="newPassword" class="form-control" autocomplete="new-password"><small style="color: var(--gray);">Minimum 8 characters required.</small></div>
                        <div class="form-group"><label for="confirmPassword">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" autocomplete="new-password"><div class="password-error" id="passwordMatchError">Passwords do not match</div></div>
                        <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelSecurityBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveSecurityBtn"><span class="btn-text">Update Password</span><div class="spinner" id="securitySpinner"></div><span class="loading-text" id="securityLoadingText">Updating...</span></button></div>
                        <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"><label>Integrations (Placeholders)</label><div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"><span>Slack Integration</span><button class="btn btn-outline" disabled>Connect</button></div><div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"><span>Single Sign-On (SSO)</span><button class="btn btn-outline" disabled>Configure</button></div></div>
                    </form>
                </div>
                <div class="settings-panel" id="notificationsPanel">
                    <h3 class="section-title">Notification Settings</h3>
                    <form class="data-form" id="notificationsForm">
                        <div class="form-group"><label>Email Notifications</label><div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"><div style="display: flex; align-items: center; justify-content: space-between;"><span>Task Assignments & Updates</span><label class="switch"><input type="checkbox" id="emailTasks" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Deadline Reminders</span><label class="switch"><input type="checkbox" id="emailDeadlines" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>System Updates & Announcements</span><label class="switch"><input type="checkbox" id="emailUpdates"><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Weekly Summary (Placeholder)</span><label class="switch"><input type="checkbox" id="emailSummary" disabled><span class="slider round"></span></label></div></div></div>
                        <div class="form-group"><label>In-App Push Notifications</label><div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"><div style="display: flex; align-items: center; justify-content: space-between;"><span>New Messages & Mentions</span><label class="switch"><input type="checkbox" id="pushMessages" checked><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Team & Project Updates</span><label class="switch"><input type="checkbox" id="pushTeamUpdates"><span class="slider round"></span></label></div><div style="display: flex; align-items: center; justify-content: space-between;"><span>Sound Notifications</span><label class="switch"><input type="checkbox" id="soundNotifications" checked><span class="slider round"></span></label></div></div></div>
                        <div class="form-actions"><button type="button" class="btn btn-outline" id="cancelNotificationsBtn">Cancel</button><button type="submit" class="btn btn-primary" id="saveNotificationsBtn"><span class="btn-text">Save Settings</span><div class="spinner" id="notificationsSpinner"></div><span class="loading-text" id="notificationsLoadingText">Saving...</span></button></div>
                    </form>
                </div>
                <div class="settings-panel" id="teamPanel">
                    <div class="team-management">
                        <h3>Team Members</h3>
                        <div class="team-list" id="teamList"><div style="text-align: center; padding: 2rem; color: var(--gray);">Loading team members...</div></div>
                        <div class="add-member-form">
                            <h4>Invite New Member</h4>
                            <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                <div class="form-group" style="margin-bottom: 0;"><label for="inviteMemberEmail">Email</label><input type="email" id="inviteMemberEmail" class="form-control" placeholder="user@example.com" required></div>
                                <div class="form-group" style="margin-bottom: 0;"><label for="inviteMemberRole">Role</label><select id="inviteMemberRole" class="form-control" required><option value="member">Member</option><option value="senior">Senior</option><option value="supervisor">Supervisor</option><option value="admin">Admin</option></select></div>
                                <div style="grid-column: 1 / -1; margin-top: 1rem;"><button type="submit" class="btn btn-primary">Send Invite</button></div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="settings-panel" id="collaborationPanel">
                    <h3 class="section-title">Collaboration Settings</h3>
                     <form class="data-form" id="collaborationForm">
                        <div class="form-group" style="grid-column: span 2;"><label>Shared Calendar Access (Placeholder)</label><p style="color: var(--gray); font-size: 0.9rem;">Control who can view or edit the team calendar.</p><button type="button" class="btn btn-outline" disabled>Manage Permissions</button></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Team Chat Integration (Placeholder)</label><p style="color: var(--gray); font-size: 0.9rem;">Connect to your preferred team chat platform.</p><button type="button" class="btn btn-outline" disabled>Configure Chat</button></div>
                        <div class="form-actions"><button type="button" class="btn btn-outline" disabled>Cancel</button><button type="submit" class="btn btn-primary" disabled>Save Collaboration Settings</button></div>
                    </form>
                </div>
                <div class="settings-panel" id="dangerPanel">
                    <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3>
                     <p style="color: var(--gray);">Actions in this section are permanent and cannot be undone. (Visible to Admins only)</p>
                     <div style="margin-top: 1.5rem; border: 1px solid var(--danger); border-radius: 6px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;">
                          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Delete Team Data (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete all projects, tasks, and files associated with this team.</p></div><button class="btn btn-danger" disabled>Delete All Team Data</button></div>
                          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Transfer Ownership (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Transfer administrative control of this workspace to another user.</p></div><button class="btn btn-warning" disabled>Transfer Ownership</button></div>
                          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"><div><strong style="color: var(--dark);">Delete Workspace (Placeholder)</strong><p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete this entire workspace, including all users and data.</p></div><button class="btn btn-danger" disabled>Delete Workspace</button></div>
                     </div>
                </div>
            </div>

            <!-- ****************************************************** -->
            <!-- ** Feature Content Sections Container (for Dynamic Loads) ** -->
            <!-- ****************************************************** -->
            <div id="featureSectionsContainer" style="display: none;">
                <!-- Content loaded dynamically needs its own container -->
                <!-- The loaded HTML fragment ITSELF should be the .content-section -->
                <div id="featureSections">
                     <!-- Placeholder is shown while loading or if error occurs -->
                     <div class="placeholder-content content-section" id="featurePlaceholder"> <!-- Added content-section class -->
                        <h2 id="featureTitle">Feature Content Area</h2>
                        <p id="featureDescription">Select a feature from the sidebar to view its content.</p>
                        <div class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                         <div class="error-message" style="display: none;">
                             Failed to load content. Please try again later.
                        </div>
                    </div>
                    <!-- Dynamically loaded HTML content will replace this placeholder -->
                </div>
            </div>
        </div>
    </main>

    <!-- Notifications Modal -->
    <div class="notifications-modal" id="notificationsModal">
        <div class="notifications-container">
            <div class="notifications-header"><h3 class="notifications-title">Notifications</h3><button class="close-notifications" id="closeNotifications">&times;</button></div>
            <div class="notifications-body" id="notificationsBody"><div class="no-notifications-message">Loading notifications...</div></div>
            <div class="notifications-footer"><button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button><button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-container">
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
            <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
            <div class="confirm-actions"><button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button><button class="btn btn-danger" id="confirmBtn">Confirm</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsBody = document.getElementById('notificationsBody');
            const closeNotifications = document.getElementById('closeNotifications');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const userAvatar = document.getElementById('userAvatar');
            const userProfileDetails = document.querySelector('.user-profile-details');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail'); // In welcome section
            const welcomeName = document.getElementById('welcomeName');
            const userDropdown = document.getElementById('userDropdown');
            const profileLink = document.getElementById('profileLink');
            const settingsLink = document.getElementById('settingsLink');
            const logoutLink = document.getElementById('logoutLink');
            const contentSections = document.querySelectorAll('.main-content > .content-area > .content-section'); // Target only direct children sections
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featureSections = document.getElementById('featureSections'); // DIV where content is injected
            const featurePlaceholder = document.getElementById('featurePlaceholder'); // The placeholder DIV
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorMessage = featurePlaceholder.querySelector('.error-message');
            const profileForm = document.getElementById('profileForm');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const uploadPhotoButton = document.getElementById('uploadPhotoButton');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingsPanels = document.querySelectorAll('.settings-panel');
            const preferencesForm = document.getElementById('preferencesForm');
            const accountForm = document.getElementById('accountForm');
            const securityForm = document.getElementById('securityForm');
            const notificationsForm = document.getElementById('notificationsForm');
            const teamList = document.getElementById('teamList');
            const inviteMemberForm = document.getElementById('inviteMemberForm');
            const themeOptions = document.querySelectorAll('.theme-option');
            const layoutDensitySelect = document.getElementById('layoutDensity');
            const weekStartSelect = document.getElementById('weekStart');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const teamMembersCount = document.getElementById('teamMembersCount');
            const tasksCompleted = document.getElementById('tasksCompleted');
            const activeProjects = document.getElementById('activeProjects');
            const upcomingDeadlines = document.getElementById('upcomingDeadlines');
            const userInfoRoleTitle = document.getElementById('userInfoRoleTitle');
            const backButton = document.getElementById('backButton');
            const notificationSound = document.getElementById('notificationSound');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
            const cancelAccountBtn = document.getElementById('cancelAccountBtn');
            const cancelSecurityBtn = document.getElementById('cancelSecurityBtn');
            const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const currentPasswordError = document.getElementById('currentPasswordError');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const teamMembersTrend = document.getElementById('teamMembersTrend');
            const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
            const activeProjectsTrend = document.getElementById('activeProjectsTrend');
            const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
            const soundNotificationsSwitch = document.getElementById('soundNotifications');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const teamSettingsTab = document.getElementById('teamSettingsTab');
            const dangerZoneTab = document.getElementById('dangerZoneTab');

            // --- State Variables ---
            let currentUser = {};
            let teamMembers = []; // Will be populated by loadData
            let activities = [];
            let notifications = [];
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let activityIntervalId = null;
            let confirmCallback = null;
            let cancelCallback = null;

            // --- Constants ---
            const MAX_ACTIVITIES_DISPLAYED = 5;
            const UPDATE_INTERVAL = 60000;
            const SIMULATED_DELAY = 800;
            const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500;
            const DEFAULT_USER = {
                 id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co',
                 title: 'Administrator', department: 'Management', phone: '+201234567890',
                 avatar: '', initials: 'ME', role: 'admin', password: 'password123',
                 preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' },
                 notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } },
                 security: { twoFactorEnabled: true },
                 stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' }
            };

            // --- Initialization ---
            function initDashboard() {
                loadData(); // Load data first
                updateUserUI(); // Update UI based on loaded data
                loadTeamMembers(); // Load team members into the settings view
                loadActivities(); // Load activities
                loadNotifications(); // Load notifications
                updateStats(); // Update dashboard stats
                applyUserPreferences(); // Apply theme/layout and populate settings forms
                applyRBAC(); // Apply role-based restrictions
                handleInitialNavigation(); // Show content based on URL hash
                startActivityTimeUpdater(); // Start timer for relative times
                setupEventListeners(); // Setup all interactions
                console.log("Dashboard Initialized. Current User:", currentUser);
                console.log("Team Members:", teamMembers);
            }

            // --- Data Handling (LocalStorage) ---
            function loadData() {
                const storedUser = JSON.parse(localStorage.getItem('currentUser'));
                currentUser = { ...DEFAULT_USER, ...storedUser };
                currentUser.preferences = { ...DEFAULT_USER.preferences, ...(storedUser?.preferences || {}) };
                currentUser.notificationPreferences = { ...DEFAULT_USER.notificationPreferences, ...(storedUser?.notificationPreferences || {}) };
                currentUser.notificationPreferences.email = { ...DEFAULT_USER.notificationPreferences.email, ...(storedUser?.notificationPreferences?.email || {}) };
                currentUser.notificationPreferences.push = { ...DEFAULT_USER.notificationPreferences.push, ...(storedUser?.notificationPreferences?.push || {}) };
                currentUser.security = { ...DEFAULT_USER.security, ...(storedUser?.security || {}) };
                currentUser.stats = { ...DEFAULT_USER.stats, ...(storedUser?.stats || {}) };

                // Load team members, provide fallback with IDs if empty
                teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [
                    { id: 1, name: 'Mohamed Elmenisy', email: 'mohamed@example.com', role: 'admin', initials: 'ME' },
                    { id: 2, name: 'Yousef', email: 'yousef@example.com', role: 'member', initials: 'YO' },
                    { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'member', initials: 'EL' },
                    { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'member', initials: 'BB' }
                ];
                 teamMembers.forEach((member, index) => { // Ensure IDs and initials
                    if (!member.id) member.id = index + 5; // Use a higher start index to avoid collision with default user if needed
                    if (!member.initials) member.initials = (member.name || member.email || '??').substring(0,2).toUpperCase();
                    if (!member.role) member.role = 'member'; // Default role if missing
                });

                activities = JSON.parse(localStorage.getItem('activities')) || [];
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
            }
            function saveData() {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                localStorage.setItem('activities', JSON.stringify(activities));
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }
            function clearUserData() { localStorage.clear(); } // Simple clear all

            // --- UI Update Functions ---
            function updateUserUI() { /* ... (same as before) ... */
                const nameParts = currentUser.name.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                userName.textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                welcomeName.textContent = firstName;
                document.querySelector('.user-info-name').textContent = currentUser.name;
                const roleTitles = { 'admin': 'Administrator', 'senior': 'Senior', 'supervisor': 'Supervisor', 'member': 'Member' };
                const roleTitle = roleTitles[currentUser.role] || 'Member';
                userInfoRoleTitle.textContent = roleTitle;
                userInfoRoleTitle.className = 'user-info-title';
                if (currentUser.role === 'admin') userInfoRoleTitle.classList.add('role-admin');
                document.getElementById('firstName').value = firstName;
                document.getElementById('lastName').value = lastName;
                document.getElementById('jobTitle').value = currentUser.title || '';
                document.getElementById('phone').value = currentUser.phone || '';
                document.getElementById('department').value = currentUser.department || '';
                document.getElementById('email').value = currentUser.email;
                fullNameDisplay.value = currentUser.name;
                document.getElementById('acc_firstName').value = firstName;
                document.getElementById('acc_lastName').value = lastName;
                document.getElementById('acc_email').value = currentUser.email;
                const initials = currentUser.initials || (firstName ? firstName[0] : '') + (lastName ? lastName[0] : '');
                [userAvatar, profileAvatar, profileAvatarLarge].forEach(el => {
                    if (currentUser.avatar) { el.style.backgroundImage = `url(${currentUser.avatar})`; el.textContent = ''; el.style.backgroundColor = ''; }
                    else { el.style.backgroundImage = 'none'; el.textContent = initials.toUpperCase(); el.style.backgroundColor = el === profileAvatarLarge ? 'var(--primary-light)' : 'var(--primary)'; el.style.color = el === profileAvatarLarge ? 'var(--primary-dark)' : 'white'; } });
            }
            function applyUserPreferences() { /* ... (same as before) ... */
                document.body.className = ''; document.body.classList.add(`${currentUser.preferences?.theme || 'blue'}-theme`); document.body.classList.add(currentUser.preferences?.layoutDensity || 'normal'); themeOptions.forEach(opt => { opt.classList.toggle('selected', opt.dataset.theme === currentUser.preferences?.theme); }); layoutDensitySelect.value = currentUser.preferences?.layoutDensity || 'normal'; loadSettingsFormData();
            }
            function applyRBAC() { /* ... (same as before) ... */
                const isAdmin = currentUser.role === 'admin'; if (dangerZoneTab) dangerZoneTab.style.display = isAdmin ? 'block' : 'none'; /* Add more rules */
            }
            function loadSettingsFormData() { /* ... (same as before) ... */
                currentUser.preferences = currentUser.preferences || {}; currentUser.security = currentUser.security || {}; currentUser.notificationPreferences = currentUser.notificationPreferences || { email: {}, push: {} }; currentUser.notificationPreferences.email = currentUser.notificationPreferences.email || {}; currentUser.notificationPreferences.push = currentUser.notificationPreferences.push || {};
                document.getElementById('selectedTheme').value = currentUser.preferences.theme || 'blue'; layoutDensitySelect.value = currentUser.preferences.layoutDensity || 'normal'; document.getElementById('language').value = currentUser.preferences.language || 'en'; document.getElementById('dateFormat').value = currentUser.preferences.dateFormat || 'dd/mm/yyyy'; weekStartSelect.value = currentUser.preferences.weekStart || 'sun'; document.getElementById('timezone').value = currentUser.preferences.timezone || 'cairo'; document.getElementById('twoFactorAuth').checked = currentUser.security.twoFactorEnabled ?? true; currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; currentPasswordError.style.display = 'none'; passwordMatchError.style.display = 'none'; document.getElementById('emailTasks').checked = currentUser.notificationPreferences.email.tasks ?? true; document.getElementById('emailDeadlines').checked = currentUser.notificationPreferences.email.deadlines ?? true; document.getElementById('emailUpdates').checked = currentUser.notificationPreferences.email.updates ?? false; document.getElementById('pushMessages').checked = currentUser.notificationPreferences.push.messages ?? true; document.getElementById('pushTeamUpdates').checked = currentUser.notificationPreferences.push.teamUpdates ?? false; soundNotificationsSwitch.checked = currentUser.preferences.soundNotifications ?? true;
            }
            function updateStats() { /* ... (same as before) ... */
                const stats = currentUser.stats || {}; teamMembersCount.textContent = teamMembers.length; tasksCompleted.textContent = stats.tasksCompleted ?? 0; activeProjects.textContent = stats.activeProjects ?? 0; upcomingDeadlines.textContent = stats.upcomingDeadlines ?? 0; if (currentUser.stats) currentUser.stats.teamMembers = teamMembers.length; updateTrendIndicator(teamMembersTrend, stats.teamMembersTrend || ['up', 'down', 'neutral'][Math.floor(Math.random() * 3)]); updateTrendIndicator(tasksCompletedTrend, stats.tasksCompletedTrend || ['up', 'down', 'neutral'][Math.floor(Math.random() * 3)]); updateTrendIndicator(activeProjectsTrend, stats.activeProjectsTrend || ['up', 'down', 'neutral'][Math.floor(Math.random() * 3)]); updateTrendIndicator(upcomingDeadlinesTrend, stats.upcomingDeadlinesTrend || ['up', 'down', 'neutral'][Math.floor(Math.random() * 3)]);
            }
            function updateTrendIndicator(element, trend) { /* ... (same as before) ... */
                trend = trend || 'neutral'; let iconClass = 'fa-minus', trendClass = 'trend-neutral'; let percentageValue = Math.floor(Math.random() * (trend === 'up' ? 50 : trend === 'down' ? 30 : 5)) + (trend === 'neutral' ? 0 : 1); let percentage = `${percentageValue}%`; if (trend === 'up') { iconClass = 'fa-arrow-up'; trendClass = 'trend-up'; } else if (trend === 'down') { iconClass = 'fa-arrow-down'; trendClass = 'trend-down'; } else { percentage = '0%'; } element.innerHTML = `<i class="fas ${iconClass}"></i> ${percentage}`; element.className = `stat-trend ${trendClass}`;
            }
            function updateNotificationBadge() { /* ... (same as before) ... */
                const unreadCount = notifications.filter(n => !n.read).length; notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount; notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none'; deleteAllNotificationsBtn.style.display = notifications.length > 0 && (currentUser.role === 'admin' || currentUser.role === 'supervisor') ? 'inline-flex' : 'none';
            }

            // --- Feature/Section Loading (MODIFIED FOR DYNAMIC LOADING) ---
             function setActiveFeature(featureId, settingsTab = null) {
                console.log(`Activating feature: ${featureId}, Settings Tab: ${settingsTab}`);
                // RBAC placeholder
                // if (featureId === 'some-admin-feature' && currentUser.role !== 'admin') { return; }

                currentFeature = featureId;
                currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);

                let hash = `#${featureId}`;
                if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                if (window.location.hash !== hash) {
                    history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);
                }

                menuItems.forEach(item => item.classList.remove('active'));
                const activeMenuItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`);
                if (activeMenuItem) activeMenuItem.classList.add('active');

                // Hide all static sections AND the dynamic container initially
                contentSections.forEach(section => section.classList.remove('active'));
                featureSectionsContainer.style.display = 'none';

                // --- Logic to show static vs dynamic ---
                if (featureId === 'dashboard') {
                    dashboardContent.classList.add('active');
                    updateStats();
                    loadActivities(viewAllActivity.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED);
                } else if (featureId === 'profile') {
                    profileContent.classList.add('active');
                    updateUserUI();
                } else if (featureId === 'settings') {
                    settingsContent.classList.add('active');
                    applyRBAC(); // Ensure settings tabs visibility is correct
                    activateSettingsTab(currentSettingsTab || 'preferences');
                } else {
                    // --- Dynamic Feature Loading ---
                    featureSectionsContainer.style.display = 'block'; // Show the container for dynamic content
                    featureSections.innerHTML = ''; // Clear previous dynamic content
                    featureSections.appendChild(featurePlaceholder); // Add placeholder back temporarily
                    featureTitle.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`;
                    featureDescription.textContent = '';
                    featureLoadingIndicator.style.display = 'block';
                    featureErrorMessage.style.display = 'none';
                    featurePlaceholder.style.display = 'flex'; // Make sure placeholder is visible
                    featureSections.classList.remove('active'); // Remove active class from the container itself while loading

                    const filePath = `sections/${featureId}.html`;
                    console.log(`Fetching: ${filePath}`);

                    fetch(filePath)
                        .then(response => {
                            console.log(`Fetch response status for ${filePath}: ${response.status}`);
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status} (${response.statusText}) loading ${filePath}`);
                            }
                            return response.text();
                        })
                        .then(htmlContent => {
                            console.log(`Successfully fetched content for ${featureId}. Injecting HTML.`);
                            // Inject the HTML content into the featureSections div
                            featureSections.innerHTML = htmlContent;
                             // Add the 'active' class to the container AFTER content is loaded
                             // Also ensure the loaded content itself might need a .content-section class if it doesn't have one.
                            featureSections.classList.add('active'); // Make the container visible
                            // If the loaded fragment doesn't have .content-section, add it:
                            if (!featureSections.firstElementChild?.classList.contains('content-section')) {
                                // Wrap the loaded content or apply class if appropriate structure exists
                                // This part depends heavily on the structure of your fragments
                                console.warn(`Loaded fragment for ${featureId} might lack '.content-section' class for styling.`);
                            }

                            // --- Call Initialization Function ---
                            if (featureId === 'employee-scheduling') {
                                console.log("Checking for initializeEmployeeSchedule function...");
                                if (typeof initializeEmployeeSchedule === 'function') {
                                    try {
                                        console.log("Calling initializeEmployeeSchedule...");
                                        // Pass deep copies to avoid accidental mutation of original state
                                        initializeEmployeeSchedule(
                                            JSON.parse(JSON.stringify(currentUser || DEFAULT_USER)),
                                            JSON.parse(JSON.stringify(teamMembers || [])) // Pass the LATEST teamMembers
                                        );
                                        console.log("initializeEmployeeSchedule executed.");
                                        featurePlaceholder.style.display = 'none'; // Hide placeholder on success
                                    } catch (err) {
                                        console.error(`Error executing initializeEmployeeSchedule:`, err);
                                        // Show error in placeholder
                                        featureTitle.textContent = `Error Initializing ${featureId.replace(/-/g, ' ')}`;
                                        featureDescription.textContent = `Content loaded, but failed during initialization. Check console. Error: ${err.message}`;
                                        featureLoadingIndicator.style.display = 'none';
                                        featureErrorMessage.style.display = 'block';
                                        featurePlaceholder.style.display = 'flex';
                                        featureSections.innerHTML = ''; // Clear broken content
                                        featureSections.appendChild(featurePlaceholder); // Show only placeholder with error
                                    }
                                } else {
                                    console.warn(`Initialization function 'initializeEmployeeSchedule' not found.`);
                                    featureTitle.textContent = `${featureId.replace(/-/g, ' ')} Loaded (No Init Script)`;
                                    featureDescription.textContent = `Content loaded, but its specific setup script was not found.`;
                                    featureLoadingIndicator.style.display = 'none';
                                    featureErrorMessage.style.display = 'none';
                                    featurePlaceholder.style.display = 'flex'; // Show placeholder with warning
                                }
                            } else {
                                 console.log(`No specific initializer for ${featureId}. Hiding placeholder.`);
                                 featurePlaceholder.style.display = 'none'; // Hide placeholder for features without specific init
                            }
                             featureLoadingIndicator.style.display = 'none'; // Always hide loading indicator after attempt

                        })
                        .catch(error => {
                            console.error(`Error loading feature '${featureId}' from '${filePath}':`, error);
                            featureTitle.textContent = `Error Loading ${featureId.replace(/-/g, ' ')}`;
                            featureDescription.textContent = `Could not load content from '${filePath}'. Error: ${error.message}`;
                            featureLoadingIndicator.style.display = 'none';
                            featureErrorMessage.style.display = 'block';
                            featurePlaceholder.style.display = 'flex'; // Show placeholder with error
                            featureSections.innerHTML = ''; // Clear any partial content
                            featureSections.appendChild(featurePlaceholder); // Display error in placeholder
                            featureSections.classList.add('active'); // Keep container visible to show error
                        });
                }

                backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';
                window.scrollTo(0, 0);
            }

            function activateSettingsTab(tabId) { /* ... (same as before) ... */
                if (tabId === 'danger' && currentUser.role !== 'admin') { return; } currentSettingsTab = tabId; settingsTabs.forEach(t => { t.classList.remove('active'); if (!t.classList.contains('disabled') && t.dataset.tab === tabId) t.classList.add('active'); }); settingsPanels.forEach(p => p.classList.toggle('active', p.id === `${tabId}Panel`)); if (currentFeature === 'settings' && window.location.hash !== `#settings-${tabId}`) { history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`); } if (tabId === 'team') loadTeamMembers(); else if (tabId === 'account') updateUserUI(); else if (['preferences', 'security', 'notifications'].includes(tabId)) loadSettingsFormData();
            }
            function handleInitialNavigation() { /* ... (same as before) ... */
                const hash = window.location.hash.substring(1); let featureId = 'dashboard', settingsTab = null; if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences'; } else { const validFeature = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile'; if (validFeature) featureId = hash; } } setActiveFeature(featureId, settingsTab);
            }

            // --- Activity & Notification Loading ---
            function loadActivities(showAll = false) { /* ... (same as before, ensure sort) ... */
                activityList.innerHTML = ''; const canDeleteAny = currentUser.role === 'admin' || currentUser.role === 'supervisor'; if (activities.length === 0) { activityList.innerHTML = `<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>`; viewAllActivity.style.display = 'none'; deleteAllActivity.style.display = 'none'; return; } activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const activitiesToDisplay = showAll ? activities : activities.slice(0, MAX_ACTIVITIES_DISPLAYED); activitiesToDisplay.forEach(activity => { const li = document.createElement('li'); li.className = 'activity-item'; if (activity.isNew) { li.classList.add('new-activity'); delete activity.isNew; setTimeout(() => { li.classList.remove('new-activity'); }, NEW_ACTIVITY_HIGHLIGHT_DURATION); } li.dataset.id = activity.id; li.innerHTML = `<div class="activity-icon"><i class="fas ${activity.icon || 'fa-info-circle'}"></i></div><div class="activity-content"><div class="activity-message">${activity.message}</div><div class="activity-time" data-timestamp="${activity.timestamp}">${getTimeAgo(activity.timestamp)}</div></div><div class="activity-actions">${canDeleteAny ? `<i class="fas fa-trash delete-activity" title="Delete Activity"></i>` : ''}</div>`; activityList.appendChild(li); }); activityList.querySelectorAll('.delete-activity').forEach(button => { button.addEventListener('click', handleDeleteActivityClick); }); viewAllActivity.style.display = activities.length > MAX_ACTIVITIES_DISPLAYED && !showAll ? 'inline' : 'none'; deleteAllActivity.style.display = activities.length > 0 && canDeleteAny ? 'inline' : 'none'; saveData(); // Save after potentially removing isNew flag
             }
            function loadNotifications() { /* ... (same as before) ... */
                notificationsBody.innerHTML = ''; updateNotificationBadge(); if (notifications.length === 0) { notificationsBody.innerHTML = `<div class="no-notifications-message">No notifications yet.</div>`; return; } const canDeleteAny = currentUser.role === 'admin' || currentUser.role === 'supervisor'; notifications.forEach(notification => { const item = document.createElement('div'); item.className = `notification-list-item ${notification.read ? '' : 'unread'}`; item.dataset.id = notification.id; item.innerHTML = `<div class="notification-icon-wrapper"><i class="fas ${notification.icon || 'fa-bell'}"></i></div><div class="notification-content"><div class="notification-message">${notification.message}</div><div class="notification-time">${getTimeAgo(notification.timestamp)}</div></div>${canDeleteAny ? `<i class="fas fa-trash delete-notification" title="Delete Notification"></i>` : ''}`; item.addEventListener('click', (e) => { if (!e.target.classList.contains('delete-notification')) markNotificationAsRead(notification.id, item); }); const deleteBtn = item.querySelector('.delete-notification'); if (deleteBtn) { deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNotificationClick(notification.id); }); } notificationsBody.appendChild(item); });
             }

            // --- Time Formatting ---
            function getTimeAgo(timestamp) { /* ... (same as before) ... */
                if (!timestamp) return 'Unknown time'; try { const now = new Date(); const date = new Date(timestamp); if (isNaN(date.getTime())) return 'Invalid date'; const seconds = Math.floor((now - date) / 1000); if (seconds < 0) return 'In the future'; let interval = Math.floor(seconds / 31536000); if (interval >= 1) return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); interval = Math.floor(seconds / 2592000); if (interval >= 1) return `${interval} month${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 604800); if (interval >= 1) return `${interval} week${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 86400); if (interval >= 1) return `${interval} day${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 3600); if (interval >= 1) return `${interval} hour${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 60); if (interval >= 1) return `${interval} min${interval === 1 ? '' : 's'} ago`; return seconds < 10 ? 'Just now' : `${Math.floor(seconds)} secs ago`; } catch (error) { console.error("Error formatting time:", error); return "Error in time"; }
             }
            function updateActivityTimes() { /* ... (same as before) ... */
                 activityList.querySelectorAll('.activity-time[data-timestamp]').forEach(el => { if(el.dataset.timestamp) el.textContent = getTimeAgo(el.dataset.timestamp); }); notificationsBody.querySelectorAll('.notification-time').forEach(el => { const item = el.closest('.notification-list-item'); const id = item?.dataset.id; if (id) { const n = notifications.find(n => n.id == id); if (n?.timestamp) el.textContent = getTimeAgo(n.timestamp); } });
             }
            function startActivityTimeUpdater() { /* ... (same as before) ... */
                 if (activityIntervalId) clearInterval(activityIntervalId); updateActivityTimes(); activityIntervalId = setInterval(updateActivityTimes, UPDATE_INTERVAL);
             }

             // --- Team Management ---
             function loadTeamMembers() { /* ... (same as before) ... */
                teamList.innerHTML = ''; const canManage = currentUser.role === 'admin' || currentUser.role === 'supervisor'; const canDelete = currentUser.role === 'admin'; if (teamMembers.length === 0) { teamList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--gray);">No team members yet. Invite one below.</div>`; } else { teamMembers.forEach(member => { const memberCard = document.createElement('div'); memberCard.className = 'team-member-card'; memberCard.dataset.id = member.id; const canManageThisMember = (canManage && member.role !== 'admin' && member.role !== 'supervisor') || (canDelete && member.id !== currentUser.id); const canDeleteThisMember = canDelete && member.id !== currentUser.id; let avatarContent = member.initials || member.email.substring(0, 2).toUpperCase(); let avatarStyle = member.avatar ? `background-image: url(${member.avatar});` : ''; if (member.avatar) avatarContent = ''; memberCard.innerHTML = `<div class="member-avatar" style="${avatarStyle}">${avatarContent}</div><div class="member-details"><div class="member-name">${member.name || 'Unnamed Member'}</div><div class="member-email">${member.email}</div></div><div class="member-role role-${member.role || 'member'}">${(member.role || 'member').charAt(0).toUpperCase() + (member.role || 'member').slice(1)}</div><div class="member-actions">${canManageThisMember ? `<button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-edit"></i></button>` : ''}${canDeleteThisMember ? `<button class="btn btn-danger btn-sm delete-member" title="Delete Member"><i class="fas fa-trash"></i></button>` : ''}</div>`; teamList.appendChild(memberCard); }); teamList.querySelectorAll('.edit-member').forEach(btn => btn.addEventListener('click', handleEditMemberClick)); teamList.querySelectorAll('.delete-member').forEach(btn => btn.addEventListener('click', handleDeleteMemberClick)); } updateStats();
             }

            // --- Modals ---
            function showConfirmModal(config) { /* ... (same as before) ... */
                confirmTitle.textContent = config.title || 'Confirm Action'; confirmMessage.innerHTML = config.message || 'Are you sure?'; confirmBtn.textContent = config.confirmText || 'Confirm'; cancelConfirmBtn.textContent = config.cancelText || 'Cancel'; confirmBtn.className = `btn ${config.confirmClass || 'btn-danger'}`; confirmCallback = config.onConfirm || null; cancelCallback = config.onCancel || null; confirmModal.style.display = 'flex'; confirmBtn.focus();
            }
            function hideConfirmModal() { /* ... (same as before) ... */
                confirmModal.style.display = 'none'; confirmCallback = null; cancelCallback = null;
             }

             // --- Action Handlers ---
            function handleProfileSave(e) { /* ... (same as before) ... */
                 e.preventDefault(); showConfirmModal({ title: 'Save Profile Changes?', message: 'Do you want to save the changes made to your profile?', confirmText: 'Save', confirmClass: 'btn-primary', onConfirm: () => { const firstName = document.getElementById('firstName').value.trim(); const lastName = document.getElementById('lastName').value.trim(); currentUser.name = `${firstName} ${lastName}`; currentUser.initials = (firstName ? firstName[0] : '') + (lastName ? lastName[0] : ''); currentUser.title = document.getElementById('jobTitle').value; currentUser.phone = document.getElementById('phone').value; currentUser.department = document.getElementById('department').value; saveData(); updateUserUI(); addActivity('fa-user-edit', 'Updated profile information.'); showSuccessMessage('Profile updated successfully!'); hideConfirmModal(); }, onCancel: hideConfirmModal });
             }
            function handleProfileCancel() { /* ... (same as before) ... */
                 const firstName = document.getElementById('firstName').value.trim(); const lastName = document.getElementById('lastName').value.trim(); const name = `${firstName} ${lastName}`; const title = document.getElementById('jobTitle').value; const phone = document.getElementById('phone').value; const department = document.getElementById('department').value; const isDirty = name !== currentUser.name || title !== (currentUser.title || '') || phone !== (currentUser.phone || '') || department !== (currentUser.department || ''); if (!isDirty) { setActiveFeature('dashboard'); return; } showConfirmModal({ title: 'Discard Profile Changes?', message: 'Are you sure? Unsaved edits will be lost.', confirmText: 'Discard', confirmClass: 'btn-danger', onConfirm: () => { updateUserUI(); hideConfirmModal(); setActiveFeature('dashboard'); }, onCancel: hideConfirmModal });
             }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... (same as before, with password logic) ... */
                const form = document.getElementById(formId); const saveButton = form.querySelector('button[type="submit"]'); const spinner = form.querySelector('.spinner'); const loadingText = form.querySelector('.loading-text'); const btnText = form.querySelector('.btn-text'); saveButton.disabled = true; if(spinner) spinner.style.display = 'inline-block'; if(loadingText) loadingText.style.display = 'inline'; if(btnText) btnText.style.display = 'none'; setTimeout(() => { try { let activityMessage = '', valuesToSave = {}; if (panelId === 'preferencesPanel') { currentUser.preferences.theme = document.getElementById('selectedTheme').value; currentUser.preferences.layoutDensity = layoutDensitySelect.value; currentUser.preferences.language = document.getElementById('language').value; currentUser.preferences.dateFormat = document.getElementById('dateFormat').value; currentUser.preferences.weekStart = weekStartSelect.value; valuesToSave = { theme: currentUser.preferences.theme, layoutDensity: currentUser.preferences.layoutDensity, language: currentUser.preferences.language, dateFormat: currentUser.preferences.dateFormat, weekStart: currentUser.preferences.weekStart }; activityMessage = 'Updated preferences settings.'; } else if (panelId === 'accountPanel') { currentUser.preferences.timezone = document.getElementById('timezone').value; valuesToSave = { timezone: currentUser.preferences.timezone }; activityMessage = 'Updated account settings.'; } else if (panelId === 'securityPanel') { currentUser.security = currentUser.security || {}; const original2FA = currentUser.security.twoFactorEnabled; currentUser.security.twoFactorEnabled = document.getElementById('twoFactorAuth').checked; const currentPass = currentPasswordInput.value; const newPass = newPasswordInput.value; const confirmPass = confirmPasswordInput.value; valuesToSave = { twoFactorEnabled: currentUser.security.twoFactorEnabled }; activityMessage = 'Updated security settings.'; currentPasswordError.style.display = 'none'; passwordMatchError.style.display = 'none'; if (newPass || confirmPass || currentPass) { if (!currentPass) { currentPasswordError.textContent = 'Current password is required to change password'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Current password missing.'); } if (currentPass !== currentUser.password) { currentPasswordError.textContent = 'Current password is incorrect'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Incorrect current password.'); } if (!newPass) { passwordMatchError.textContent = 'New password cannot be empty'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password empty.'); } if (newPass.length < 8) { passwordMatchError.textContent = 'New password must be at least 8 characters.'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password too short.'); } if (newPass !== confirmPass) { passwordMatchError.textContent = 'New passwords do not match'; passwordMatchError.style.display = 'block'; confirmPasswordInput.focus(); throw new Error('New passwords do not match.'); } currentUser.password = newPass; activityMessage = 'Changed password.'; valuesToSave.passwordChanged = true; currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; } else if (original2FA !== currentUser.security.twoFactorEnabled) { activityMessage = 'Updated 2FA setting.'; } } else if (panelId === 'notificationsPanel') { currentUser.notificationPreferences = currentUser.notificationPreferences || { email: {}, push: {} }; currentUser.notificationPreferences.email = currentUser.notificationPreferences.email || {}; currentUser.notificationPreferences.push = currentUser.notificationPreferences.push || {}; currentUser.notificationPreferences.email.tasks = document.getElementById('emailTasks').checked; currentUser.notificationPreferences.email.deadlines = document.getElementById('emailDeadlines').checked; currentUser.notificationPreferences.email.updates = document.getElementById('emailUpdates').checked; currentUser.notificationPreferences.push.messages = document.getElementById('pushMessages').checked; currentUser.notificationPreferences.push.teamUpdates = document.getElementById('pushTeamUpdates').checked; currentUser.preferences.soundNotifications = soundNotificationsSwitch.checked; valuesToSave = { emailTasks: currentUser.notificationPreferences.email.tasks, emailDeadlines: currentUser.notificationPreferences.email.deadlines, emailUpdates: currentUser.notificationPreferences.email.updates, pushMessages: currentUser.notificationPreferences.push.messages, pushTeamUpdates: currentUser.notificationPreferences.push.teamUpdates, soundNotifications: currentUser.preferences.soundNotifications }; activityMessage = 'Updated notification settings.'; } console.log(`Saving settings for ${panelId}. Values captured:`, valuesToSave); saveData(); applyUserPreferences(); if (activityMessage) addActivity('fa-cogs', activityMessage); showSuccessMessage(successMsg || 'Settings saved successfully!'); } catch (error) { console.error(`Error saving settings for ${panelId}:`, error.message); if (!error.message.includes('password') && !error.message.includes('missing')) showConfirmModal({ title: "Save Error", message: `Could not save settings: ${error.message}`, confirmText: "OK", confirmClass: "btn-primary", onConfirm: hideConfirmModal }); } finally { saveButton.disabled = false; if(spinner) spinner.style.display = 'none'; if(loadingText) loadingText.style.display = 'none'; if(btnText) btnText.style.display = 'inline'; } }, SIMULATED_DELAY);
             }
            function handleSettingsCancel(panelId) { /* ... (same as before) ... */
                showConfirmModal({ title: `Discard ${panelId.replace('Panel', '')} Settings Changes?`, message: 'Are you sure? Any unsaved changes in this section will be lost.', confirmText: 'Discard', confirmClass: 'btn-danger', onConfirm: () => { loadSettingsFormData(); applyUserPreferences(); hideConfirmModal(); }, onCancel: hideConfirmModal });
             }
            function handleInviteMember(e) { /* ... (same as before) ... */
                e.preventDefault(); const emailInput = document.getElementById('inviteMemberEmail'); const roleSelect = document.getElementById('inviteMemberRole'); const email = emailInput.value.trim(); const role = roleSelect.value; if (!email || !email.includes('@')) { alert('Please enter a valid email address.'); emailInput.focus(); return; } if (teamMembers.some(member => member.email.toLowerCase() === email.toLowerCase())) { alert('A team member with this email already exists.'); emailInput.focus(); return; } if (role === 'admin' && currentUser.role !== 'admin') { alert('Only Administrators can invite other Administrators.'); roleSelect.focus(); return; } if (currentUser.role === 'supervisor' && (role === 'admin' || role === 'supervisor')) { alert('Supervisors cannot invite Administrators or other Supervisors.'); roleSelect.focus(); return; } const fakeInviteToken = `sim_token_${Date.now()}`; const fakeInviteLink = `${window.location.origin}/register.html?token=${fakeInviteToken}`; console.log('--- SIMULATING INVITE ---'); console.log('To:', email); console.log('Role:', role); console.log('Invite Link (Fake):', fakeInviteLink); console.log('--- END SIMULATION ---'); addActivity('fa-paper-plane', `${currentUser.name} sent an invite to ${email} as a ${role}.`); showSuccessMessage(`Invitation sent to ${email}.`); inviteMemberForm.reset();
             }
            function handleEditMemberClick(e) { /* ... (same as before) ... */
                 const card = e.target.closest('.team-member-card'); const memberId = parseInt(card.dataset.id); const member = teamMembers.find(m => m.id === memberId); if (!member) return; const newName = prompt("Enter new name:", member.name || ''); let newRole = member.role; const isAdmin = currentUser.role === 'admin'; const isSupervisor = currentUser.role === 'supervisor'; let canChangeRole = false; let allowedRolesPrompt = ''; if (isAdmin && member.id !== currentUser.id) { canChangeRole = true; allowedRolesPrompt = 'member, senior, supervisor, admin'; } else if (isSupervisor && !['admin', 'supervisor'].includes(member.role)) { canChangeRole = true; allowedRolesPrompt = 'member, senior'; } if (canChangeRole) { const promptedRole = prompt(`Enter new role (${allowedRolesPrompt}):`, member.role); if (promptedRole !== null) { const cleanRole = promptedRole.trim().toLowerCase(); if (allowedRolesPrompt.split(', ').includes(cleanRole)) newRole = cleanRole; else alert('Invalid role entered or permission denied. Keeping original role.'); } } else if (member.id !== currentUser.id) alert("You don't have permission to change this member's role."); if (newName !== null) { member.name = newName.trim() || 'Unnamed Member'; member.role = newRole; member.initials = member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || member.email.substring(0, 2).toUpperCase(); saveData(); loadTeamMembers(); addActivity('fa-user-edit', `Updated details for team member: ${member.email}`); showSuccessMessage('Team member updated.'); }
             }
            function handleDeleteMemberClick(e) { /* ... (same as before) ... */
                const card = e.target.closest('.team-member-card'); const memberId = parseInt(card.dataset.id); const member = teamMembers.find(m => m.id === memberId); if (!member) return; if (currentUser.role !== 'admin') { alert('Only administrators can delete team members.'); return; } if (member.id === currentUser.id) { alert("You cannot delete your own account from the team list."); return; } showConfirmModal({ title: 'Delete Team Member?', message: `Remove <strong>${member.name || member.email}</strong> from the team? This cannot be undone.`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { const memberEmail = member.email; teamMembers = teamMembers.filter(m => m.id !== memberId); saveData(); loadTeamMembers(); addActivity('fa-user-minus', `Removed team member: ${memberEmail}`); addNotification('fa-user-minus', `Team member removed: ${memberEmail}`); showSuccessMessage('Team member deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal });
             }
            function handleDeleteActivityClick(e) { /* ... (same as before) ... */
                const listItem = e.target.closest('.activity-item'); const activityId = parseInt(listItem.dataset.id); if (!activityId) return; if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted to Admins/Supervisors.'); return; } showConfirmModal({ title: 'Delete Activity?', message: `Delete this activity record?`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { activities = activities.filter(a => a.id !== activityId); saveData(); loadActivities(viewAllActivity.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); showSuccessMessage('Activity deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal });
             }
            function handleDeleteAllActivities() { /* ... (same as before) ... */
                if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted to Admins/Supervisors.'); return; } if (activities.length === 0) { showSuccessMessage('No activities to delete.'); return; } showConfirmModal({ title: 'Delete ALL Activities?', message: `Delete ALL ${activities.length} activity records? This cannot be undone.`, confirmText: 'Delete All', confirmClass: 'btn-danger', onConfirm: () => { activities = []; saveData(); loadActivities(); showSuccessMessage('All activities deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal });
             }
            function markNotificationAsRead(notificationId, itemElement) { /* ... (same as before) ... */
                const notification = notifications.find(n => n.id == notificationId); if (notification && !notification.read) { notification.read = true; saveData(); itemElement.classList.remove('unread'); updateNotificationBadge(); }
             }
            function handleMarkAllNotificationsRead() { /* ... (same as before) ... */
                 let changed = false; notifications.forEach(n => { if (!n.read) { n.read = true; changed = true; } }); if (changed) { saveData(); loadNotifications(); showSuccessMessage('All notifications marked as read.'); } else { showSuccessMessage('No unread notifications.'); }
            }
            function handleDeleteNotificationClick(notificationId) { /* ... (same as before) ... */
                 if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted.'); return; } showConfirmModal({ title: 'Delete Notification?', message: 'Delete this notification?', confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { notifications = notifications.filter(n => n.id != notificationId); saveData(); loadNotifications(); showSuccessMessage('Notification deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal });
            }
            function handleDeleteAllNotifications() { /* ... (same as before) ... */
                if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted.'); return; } if (notifications.length === 0) { showSuccessMessage('No notifications to delete.'); return; } showConfirmModal({ title: 'Delete ALL Notifications?', message: `Delete ALL ${notifications.length} notifications? This cannot be undone.`, confirmText: 'Delete All', confirmClass: 'btn-danger', onConfirm: () => { notifications = []; saveData(); loadNotifications(); showSuccessMessage('All notifications deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal });
            }
            function handleAvatarUpload(e) { /* ... (same as before) ... */
                const file = e.target.files[0]; if (!file) return; if (!file.type.startsWith('image/')) { alert('Please select an image file.'); return; } if (file.size > 2 * 1024 * 1024) { alert('Image size must be less than 2MB.'); return; } const reader = new FileReader(); reader.onload = function(event) { const imageUrl = event.target.result; showConfirmModal({ title: 'Update Profile Picture?', message: 'Set this image as your profile picture?', confirmText: 'Set Picture', confirmClass: 'btn-primary', onConfirm: () => { currentUser.avatar = imageUrl; saveData(); updateUserUI(); addActivity('fa-camera', 'Changed profile picture.'); showSuccessMessage('Profile picture updated.'); hideConfirmModal(); }, onCancel: () => { profileAvatarInput.value = null; hideConfirmModal(); } }); } reader.onerror = function() { alert('Error reading file.'); } reader.readAsDataURL(file);
            }
            function handleLogout() { /* ... (same as before) ... */
                 showConfirmModal({ title: 'Logout?', message: 'Are you sure you want to log out?', confirmText: 'Logout', confirmClass: 'btn-danger', onConfirm: () => { showSuccessMessage("Logging out..."); setTimeout(() => { window.location.href = 'login.html'; }, 500); }, onCancel: hideConfirmModal });
            }

            // --- Utility Functions ---
             function addActivity(icon, message) { /* ... (same as before) ... */
                const newActivity = { id: Date.now(), icon: icon, message: message, timestamp: new Date().toISOString(), isNew: true }; activities.push(newActivity); activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); saveData(); if (currentFeature === 'dashboard') { loadActivities(viewAllActivity.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); }
             }
             function addNotification(icon, message) { /* ... (same as before) ... */
                const newNotification = { id: Date.now(), icon: icon, message: message, timestamp: new Date().toISOString(), read: false }; notifications.unshift(newNotification); saveData(); updateNotificationBadge(); if (notificationsModal.style.display === 'flex') loadNotifications(); if (currentUser.preferences?.soundNotifications) playNotificationSound();
             }
            function playNotificationSound() { /* ... (same as before) ... */
                 if (notificationSound?.play) notificationSound.play().catch(e => console.warn('Notification sound play failed:', e));
            }
            function showSuccessMessage(message) { /* ... (same as before) ... */
                successMessageText.textContent = message; successMessage.classList.add('show'); setTimeout(() => { successMessage.classList.remove('show'); }, 3000);
             }

            // --- Event Listener Setup ---
            function setupEventListeners() { /* ... (same as before) ... */
                menuItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); setActiveFeature(item.dataset.feature); }));
                backButton.addEventListener('click', () => setActiveFeature('dashboard'));
                window.addEventListener('popstate', (event) => { if (event.state) setActiveFeature(event.state.feature, event.state.tab); else handleInitialNavigation(); });
                searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch);
                document.addEventListener('click', (e) => { if (!e.target.closest('.search-bar')) { searchResults.classList.remove('active'); searchResults.innerHTML = ''; }});
                userAvatar.addEventListener('click', () => userDropdown.classList.toggle('active')); userProfileDetails.addEventListener('click', () => userDropdown.classList.toggle('active'));
                profileLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('profile'); });
                settingsLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('settings'); });
                logoutLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); handleLogout(); });
                document.addEventListener('click', (e) => { if (!e.target.closest('.user-profile')) userDropdown.classList.remove('active'); });
                notificationIcon.addEventListener('click', () => { notificationsModal.style.display = 'flex'; loadNotifications(); });
                closeNotifications.addEventListener('click', () => notificationsModal.style.display = 'none');
                notificationsModal.addEventListener('click', (e) => { if (e.target === notificationsModal) notificationsModal.style.display = 'none'; });
                markAllReadBtn.addEventListener('click', handleMarkAllNotificationsRead);
                deleteAllNotificationsBtn.addEventListener('click', handleDeleteAllNotifications);
                viewAllActivity.addEventListener('click', () => loadActivities(true));
                deleteAllActivity.addEventListener('click', handleDeleteAllActivities);
                profileForm.addEventListener('submit', handleProfileSave);
                cancelProfileBtn.addEventListener('click', handleProfileCancel);
                uploadPhotoButton.addEventListener('click', () => profileAvatarInput.click());
                profileAvatarInput.addEventListener('change', handleAvatarUpload);
                settingsTabs.forEach(tab => { tab.addEventListener('click', () => { if (!tab.classList.contains('disabled')) activateSettingsTab(tab.dataset.tab); }); });
                preferencesForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('preferencesForm', 'preferencesPanel', 'Preferences saved.'); });
                cancelPreferencesBtn.addEventListener('click', () => handleSettingsCancel('preferencesPanel'));
                accountForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('accountForm', 'accountPanel', 'Account settings saved.'); });
                cancelAccountBtn.addEventListener('click', () => handleSettingsCancel('accountPanel'));
                securityForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('securityForm', 'securityPanel', 'Security settings updated.'); });
                cancelSecurityBtn.addEventListener('click', () => handleSettingsCancel('securityPanel'));
                notificationsForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('notificationsForm', 'notificationsPanel', 'Notification settings saved.'); });
                cancelNotificationsBtn.addEventListener('click', () => handleSettingsCancel('notificationsPanel'));
                themeOptions.forEach(option => { option.addEventListener('click', function() { const theme = this.dataset.theme; document.getElementById('selectedTheme').value = theme; themeOptions.forEach(opt => opt.classList.remove('selected')); this.classList.add('selected'); document.body.className = ''; document.body.classList.add(`${theme}-theme`); document.body.classList.add(layoutDensitySelect.value || 'normal'); applyRBAC(); }); });
                layoutDensitySelect.addEventListener('change', function() { const density = this.value; document.body.classList.remove('compact', 'normal', 'spacious'); document.body.classList.add(density); const currentTheme = document.getElementById('selectedTheme').value || 'blue'; document.body.classList.add(`${currentTheme}-theme`); applyRBAC(); });
                inviteMemberForm.addEventListener('submit', handleInviteMember);
                confirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
                cancelConfirmBtn.addEventListener('click', () => { if (cancelCallback) cancelCallback(); hideConfirmModal(); });
                confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideConfirmModal(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && confirmModal.style.display === 'flex') hideConfirmModal(); });
            }

             // --- Placeholder Search Function ---
             function handleSearch() { /* ... (same as before) ... */
                const searchTerm = searchInput.value.toLowerCase().trim(); searchResults.innerHTML = ''; searchResults.classList.remove('active'); if (searchTerm.length < 2) return; const matchingUsers = teamMembers.filter(m => (m.name || '').toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm) ); const matchingActivities = activities.filter(a => a.message.toLowerCase().includes(searchTerm) ); searchResults.classList.add('active'); if (matchingUsers.length === 0 && matchingActivities.length === 0) { searchResults.innerHTML = `<div class="search-result-item" style="color: var(--gray);">No results found for "${searchInput.value}"</div>`; return; } if (matchingUsers.length > 0) { const h = document.createElement('div'); h.innerHTML = '<strong>Team Members</strong>'; h.style.cssText='padding:0.5rem 1rem 0.25rem;font-size:0.8rem;color:var(--gray)'; searchResults.appendChild(h); matchingUsers.slice(0, 3).forEach(u => { const i = document.createElement('div'); i.className = 'search-result-item'; i.innerHTML = `<i class="fas fa-user" style="margin-right:0.5rem;color:var(--primary);"></i> ${u.name} (${u.email})`; i.onclick = () => { setActiveFeature('settings', 'team'); searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(i); }); } if (matchingActivities.length > 0) { const h = document.createElement('div'); h.innerHTML = '<strong>Recent Activities</strong>'; h.style.cssText='padding:0.5rem 1rem 0.25rem;font-size:0.8rem;color:var(--gray)'; searchResults.appendChild(h); matchingActivities.slice(0, 3).forEach(a => { const i = document.createElement('div'); i.className = 'search-result-item'; i.innerHTML = `<i class="fas ${a.icon || 'fa-info-circle'}" style="margin-right:0.5rem;color:var(--secondary);"></i> ${a.message.substring(0, 50)}...`; i.onclick = () => { setActiveFeature('dashboard'); const el = activityList.querySelector(`.activity-item[data-id="${a.id}"]`); if(el){ el.scrollIntoView({ behavior:'smooth', block:'center' }); el.style.transition = 'background-color 0.3s ease-out'; el.style.backgroundColor = 'var(--primary-light)'; setTimeout(() => { el.style.backgroundColor = ''; }, 1500); } searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(i); }); }
              }

            // ==============================================================
            // == START: Initialization Function for Employee Scheduling =====
            // ==============================================================
            function initializeEmployeeSchedule(currentUserData, employeesData) {
                console.log("initializeEmployeeSchedule called with:", currentUserData, employeesData);

                // --- DOM Elements (Query within the loaded section) ---
                const scheduleContainer = document.getElementById('featureSections');
                if (!scheduleContainer) {
                    console.error("Schedule Error: Could not find #featureSections container."); return;
                }
                const employeeModal = scheduleContainer.querySelector('#employeeModal');
                const shiftModal = scheduleContainer.querySelector('#shiftModal');
                const addEmployeeBtn = scheduleContainer.querySelector('#addEmployeeBtn');
                const sendRemindersBtn = scheduleContainer.querySelector('#sendRemindersBtn');
                const closeEmployeeModal = scheduleContainer.querySelector('#closeEmployeeModal');
                const closeShiftModal = scheduleContainer.querySelector('#closeShiftModal');
                const cancelEmployeeBtn = scheduleContainer.querySelector('#cancelEmployeeBtn');
                const cancelShiftBtn = scheduleContainer.querySelector('#cancelShiftBtn');
                const employeeForm = scheduleContainer.querySelector('#employeeForm');
                const shiftForm = scheduleContainer.querySelector('#shiftForm');
                const shiftType = scheduleContainer.querySelector('#shiftType');
                const customShiftGroup = scheduleContainer.querySelector('#customShiftGroup');
                const deleteShiftBtn = scheduleContainer.querySelector('#deleteShiftBtn');
                const prevWeekBtn = scheduleContainer.querySelector('#prevWeekBtn');
                const nextWeekBtn = scheduleContainer.querySelector('#nextWeekBtn');
                const weekDisplay = scheduleContainer.querySelector('#weekDisplay');
                const saveScheduleBtn = scheduleContainer.querySelector('#saveScheduleBtn');
                const additionalEmployeesRow = scheduleContainer.querySelector('#additionalEmployeesRow');
                const shiftDateInput = scheduleContainer.querySelector('#shiftDate');
                const toastNotification = scheduleContainer.querySelector('#toastNotification');

                // --- Check for essential elements ---
                if (!weekDisplay || !prevWeekBtn || !nextWeekBtn || !shiftModal || !employeeModal || !toastNotification) {
                    console.error("Schedule Error: Could not find essential DOM elements within #featureSections. Check IDs in sections/employee-scheduling.html");
                    // Optionally display error message in the placeholder
                    const phError = document.getElementById('featureErrorMessage');
                    if(phError) { phError.textContent = "Error initializing schedule: Core elements missing in loaded content."; phError.style.display = 'block'; document.getElementById('featurePlaceholder')?.style.display = 'flex'; }
                    return;
                }

                // --- Use passed data ---
                const employees = employeesData || []; // Use dashboard's teamMembers
                const currentUser = currentUserData || { role: 'employee' };
                console.log("Schedule using currentUser:", currentUser);
                console.log("Schedule using employees:", employees);

                const isAdminOrSupervisor = currentUser.role === 'admin' || currentUser.role === 'supervisor';
                console.log("Is Admin or Supervisor:", isAdminOrSupervisor);

                // Show/hide controls based on role
                scheduleContainer.querySelectorAll('.edit-shift').forEach(el => el.style.display = isAdminOrSupervisor ? 'inline' : 'none');
                if (addEmployeeBtn) addEmployeeBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none';
                if (sendRemindersBtn) sendRemindersBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none';
                if (saveScheduleBtn) saveScheduleBtn.style.display = isAdminOrSupervisor ? 'flex' : 'none';

                // --- Schedule Logic ---
                let currentWeekStart = new Date(2025, 4, 5); // May 5, 2025 (Monday)
                const minDate = new Date(2025, 4, 1);
                const maxDate = new Date(2025, 4, 31);

                function showToast(message, type = 'success') {
                    toastNotification.textContent = message;
                    toastNotification.style.backgroundColor = type === 'success' ? 'var(--primary)' : 'var(--danger)';
                    toastNotification.classList.add('show');
                    setTimeout(() => { toastNotification.classList.remove('show'); }, 3000);
                }

                function updateWeekDisplay() {
                    const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6);
                    const options = { month: 'short', day: 'numeric' };
                    const startStr = currentWeekStart.toLocaleDateString('en-US', options);
                    const endStr = weekEnd.toLocaleDateString('en-US', options);
                    const year = currentWeekStart.getFullYear();
                    weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;

                    const dateCells = scheduleContainer.querySelectorAll('.day-date');
                    if (dateCells.length > 0) {
                        const tempDate = new Date(currentWeekStart);
                        dateCells.forEach((cell) => {
                            cell.textContent = tempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            tempDate.setDate(tempDate.getDate() + 1);
                        });
                    }
                    const prevWeek = new Date(currentWeekStart); prevWeek.setDate(prevWeek.getDate() - 7);
                    if (prevWeekBtn) prevWeekBtn.disabled = prevWeek < minDate;
                    const nextWeek = new Date(weekEnd); nextWeek.setDate(nextWeek.getDate() + 1);
                    if (nextWeekBtn) nextWeekBtn.disabled = nextWeek > maxDate;
                }

                // --- Event Listeners (scoped) ---
                if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); updateWeekDisplay(); });
                if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); updateWeekDisplay(); });

                if (shiftType && customShiftGroup) shiftType.addEventListener('change', function() { customShiftGroup.style.display = this.value === 'custom' ? 'block' : 'none'; });

                if (addEmployeeBtn && employeeModal) addEmployeeBtn.addEventListener('click', () => { employeeModal.style.display = 'flex'; });
                if (closeEmployeeModal && employeeModal) closeEmployeeModal.addEventListener('click', () => { employeeModal.style.display = 'none'; });
                if (cancelEmployeeBtn && employeeModal) cancelEmployeeBtn.addEventListener('click', () => { employeeModal.style.display = 'none'; });
                if (closeShiftModal && shiftModal) closeShiftModal.addEventListener('click', () => { shiftModal.style.display = 'none'; });
                if (cancelShiftBtn && shiftModal) cancelShiftBtn.addEventListener('click', () => { shiftModal.style.display = 'none'; });

                // Close modals on backdrop click (safer approach)
                if (employeeModal) employeeModal.addEventListener('click', (e) => { if (e.target === employeeModal) employeeModal.style.display = 'none'; });
                if (shiftModal) shiftModal.addEventListener('click', (e) => { if (e.target === shiftModal) shiftModal.style.display = 'none'; });

                if (employeeForm) employeeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const name = scheduleContainer.querySelector('#empName')?.value;
                    const email = scheduleContainer.querySelector('#empEmail')?.value;
                    // const position = scheduleContainer.querySelector('#empPosition')?.value; // Available if needed
                    // const role = scheduleContainer.querySelector('#empRole')?.value; // Available if needed

                    if (!name || !email) { showToast("Name and Email are required.", "danger"); return; }

                     // VISUAL ADDITION ONLY - Does not update main `teamMembers` array
                    const visualEmployeeId = Date.now(); // Use temporary ID for visual elements
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="employee-name">${name}</td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="mon">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="tue">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="wed">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="thu">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="fri">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="sat">(edit)</span></td>
                        <td class="admin-controls"><span class="edit-shift" data-emp="${visualEmployeeId}" data-day="sun">(edit)</span></td>
                    `;
                    if (isAdminOrSupervisor) {
                        newRow.querySelectorAll('.edit-shift').forEach(el => el.style.display = 'inline');
                    }
                    newRow.querySelectorAll('.edit-shift').forEach(button => button.addEventListener('click', handleEditShiftClick));

                    const tbody = scheduleContainer.querySelector('.schedule-table tbody');
                    if (tbody) {
                        const refRow = scheduleContainer.querySelector('#additionalEmployeesRow');
                        if (refRow) tbody.insertBefore(newRow, refRow);
                        else tbody.appendChild(newRow);
                    } else { console.error("Cannot add employee row: tbody not found."); showToast("Error adding employee.", "danger"); return; }

                    employeeForm.reset();
                    if (employeeModal) employeeModal.style.display = 'none';
                    showToast(`Employee ${name} added to schedule view (visual only).`);
                     // ** TODO: In a real app, call a function here to add the user to the main `teamMembers` array and save data. **
                     // Example: addTeamMember({ id: newEmployeeId, name: name, email: email, role: role });
                });

                function handleEditShiftClick() { /* ... (same as before, ensure selectors are scoped/global IDs used) ... */
                     if (!isAdminOrSupervisor) return;
                     const empId = parseInt(this.getAttribute('data-emp'));
                     const day = this.getAttribute('data-day');
                     const currentCell = this.closest('td');

                     // Find employee from the PASSED employeesData array
                     // NOTE: This won't find visually added employees unless the main array is updated
                     const employee = employees.find(e => e.id === empId);
                     if (!employee) {
                         // Attempt to get name from the cell for visually added employees
                         const nameCell = this.closest('tr')?.querySelector('.employee-name');
                         const employeeName = nameCell ? nameCell.textContent : `Employee ID ${empId}`;
                         console.warn(`Employee with ID ${empId} not found in main data. Using name: ${employeeName}`);
                         // Use a placeholder object if not found in main data
                          const tempEmployee = { id: empId, name: employeeName };
                          populateShiftModal(tempEmployee, day, currentCell);
                     } else {
                         populateShiftModal(employee, day, currentCell);
                     }
                }

                 function populateShiftModal(employee, day, currentCell) {
                     const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                     const dayIndex = days.indexOf(day);
                     if (dayIndex === -1) return;

                     const date = new Date(currentWeekStart); date.setDate(date.getDate() + dayIndex);
                     const shiftEmployeeInput = scheduleContainer.querySelector('#shiftEmployee');
                     if (shiftEmployeeInput) shiftEmployeeInput.value = employee.name;

                     const formattedDate = date.toISOString().split('T')[0];
                     if (shiftDateInput) { shiftDateInput.value = formattedDate; shiftDateInput.min = '2025-05-01'; shiftDateInput.max = '2025-05-31'; }

                     const shiftDiv = currentCell.querySelector('.shift');
                     if (shiftType) {
                         if (shiftDiv) {
                             if (shiftDiv.classList.contains('shift-morning')) shiftType.value = 'morning';
                             else if (shiftDiv.classList.contains('shift-afternoon')) shiftType.value = 'afternoon';
                             else if (shiftDiv.classList.contains('shift-night')) shiftType.value = 'night';
                             else if (shiftDiv.classList.contains('day-off')) shiftType.value = 'day-off';
                             else if (shiftDiv.classList.contains('sick-leave')) shiftType.value = 'sick-leave';
                             else if (shiftDiv.classList.contains('vacation')) shiftType.value = 'vacation';
                             else shiftType.value = 'custom'; // Identify custom or default
                         } else { shiftType.value = ''; } // Default to clear/empty if no shift exists
                         if(customShiftGroup) customShiftGroup.style.display = shiftType.value === 'custom' ? 'block' : 'none'; // Update custom visibility
                         const customShiftInput = scheduleContainer.querySelector('#customShift');
                         if(customShiftInput) customShiftInput.value = (shiftType.value === 'custom' && shiftDiv) ? shiftDiv.textContent : ''; // Populate custom field
                     }

                     if (shiftModal) {
                         const cellId = currentCell.id || `cell-${Date.now()}`; currentCell.id = cellId;
                         shiftModal.dataset.currentCell = cellId;
                         shiftModal.style.display = 'flex';
                     }
                 }

                scheduleContainer.querySelectorAll('.edit-shift').forEach(button => button.addEventListener('click', handleEditShiftClick));

                if (shiftForm) shiftForm.addEventListener('submit', function(e) { /* ... (same as before, use scoped selectors) ... */
                     e.preventDefault();
                     const employeeName = scheduleContainer.querySelector('#shiftEmployee')?.value;
                     const shiftTypeValue = scheduleContainer.querySelector('#shiftType')?.value;
                     const customShift = scheduleContainer.querySelector('#customShift')?.value;
                     const currentCellId = shiftModal?.dataset.currentCell;
                     if (!currentCellId) return;
                     const currentCell = scheduleContainer.querySelector(`#${currentCellId}`); // Scope lookup
                     if (currentCell) {
                         currentCell.querySelector('.shift')?.remove(); // Remove existing shift
                         let shiftDiv = document.createElement('div'); shiftDiv.className = 'shift'; let shiftText = '';
                         switch (shiftTypeValue) {
                             case 'morning': shiftDiv.classList.add('shift-morning'); shiftText = '9AM-5PM'; break;
                             case 'afternoon': shiftDiv.classList.add('shift-afternoon'); shiftText = '12PM-8PM'; break;
                             case 'night': shiftDiv.classList.add('shift-night'); shiftText = '5PM-1AM'; break;
                             case 'day-off': shiftDiv.classList.add('day-off'); shiftText = 'OFF'; break;
                             case 'sick-leave': shiftDiv.classList.add('sick-leave'); shiftText = 'SICK'; break;
                             case 'vacation': shiftDiv.classList.add('vacation'); shiftText = 'VAC'; break;
                             case 'custom': shiftDiv.classList.add('shift-morning'); shiftText = customShift || 'Custom'; break;
                             case '': shiftText = ''; break; // Handle clear shift
                             default: shiftText = 'N/A'; break;
                         }
                         if(shiftText) { // Only add div if there's content
                            shiftDiv.textContent = shiftText;
                            const editLink = currentCell.querySelector('.edit-shift');
                            if(editLink) currentCell.insertBefore(shiftDiv, editLink);
                            else currentCell.appendChild(shiftDiv);
                            showToast(`Shift for ${employeeName} updated.`);
                         } else {
                             showToast(`Shift for ${employeeName} cleared.`, 'warning');
                         }
                     }
                     if (shiftModal) shiftModal.style.display = 'none';
                 });

                if (deleteShiftBtn) deleteShiftBtn.addEventListener('click', function() { /* ... (same as before, use scoped selectors) ... */
                    const employeeName = scheduleContainer.querySelector('#shiftEmployee')?.value; const currentCellId = shiftModal?.dataset.currentCell; if (!currentCellId) return; const currentCell = scheduleContainer.querySelector(`#${currentCellId}`); if (currentCell) { currentCell.querySelector('.shift')?.remove(); showToast(`Shift for ${employeeName} deleted.`, 'danger'); } if (shiftModal) shiftModal.style.display = 'none';
                });

                if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', () => { showToast('Schedule saved successfully!'); /* TODO: Send data */ });

                if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', () => { /* ... (same as before, uses passed data) ... */
                     const subject = encodeURIComponent('Upcoming Work Schedule Reminder'); const body = encodeURIComponent(`Dear Team,\n\nSchedule for ${weekDisplay?.textContent || 'this week'}.\n\nBest,\n${currentUser.name}\n${currentUser.email}`); const recipientEmails = employees.map(e => e.email).filter(Boolean).join(','); if (recipientEmails) { window.open(`mailto:?bcc=${recipientEmails}&subject=${subject}&body=${body}`, '_blank'); showToast('Reminder email prepared.'); } else { showToast('No employee emails found.', 'warning'); }
                 });

                // Initialize
                updateWeekDisplay();
                console.log("Employee Schedule Initialized Successfully.");
            }
            // ============================================================
            // == END: Initialization Function for Employee Scheduling =====
            // ============================================================

            // --- Run Initialization ---
            initDashboard();
        });
    </script>
</body>
</html>

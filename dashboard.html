<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- ALL CSS FROM dashboard.txt REMAINS HERE --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a; /* Dark blue */
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a; /* Dark blue */
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Used for admin role title color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-light);
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ... (بقية أنماط CSS تبقى كما هي - تم اختصارها هنا لتسهيل القراءة) ... */

        /* Theme Classes */
        body.light-theme { /* ... */ }
        body.dark-theme { /* ... */ }
        body.blue-theme { /* ... */ }

        /* Theme Selection Options */
        .theme-option { /* ... */ }
        /* Notifications Modal */
        .notifications-modal { /* ... */ }
        /* Confirm Modal */
        .confirm-modal { /* ... */ }
        /* Success Message */
        .success-message { /* ... */ }
        /* Responsive Design */
        @media (max-width: 992px) { /* ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 480px) { /* ... */ }
        /* Back button Styles */
        .back-button { /* ... */ }
        /* Notification sound */
        #notificationSound { display: none; }
        /* Helper class */
        .d-none { display: none !important; }
        /* Connection status */
        .connection-status { /* ... */ }
        /* Password error */
        .password-error { /* ... */ }
        /* Loading spinner */
        .spinner { /* ... */ }
        /* Placeholder styling */
        .placeholder-content { /* ... */ }

    </style>
</head>
<body class="blue-theme">
    <!-- HTML Structure -->
    <audio id="notificationSound" preload="auto">...</audio>
    <div class="success-message" id="successMessage">...</div>
    <aside class="sidebar" id="sidebar">...</aside>
    <main class="main-content">
        <nav class="top-nav">...</nav>
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;">...</div>
            <div id="dashboardContent" class="content-section active">...</div>
            <div class="content-section" id="profileContent">...</div>
            <div class="content-section" id="settingsContent">...</div>
            <div id="featureSectionsContainer" style="display: none;">
                <div id="featureSections" class="content-section">
                     <div class="placeholder-content" id="featurePlaceholder">...</div>
                </div>
            </div>
        </div>
    </main>
    <div class="notifications-modal" id="notificationsModal">...</div>
    <div class="confirm-modal" id="confirmModal">...</div>

    <script>
        // ======================================================
        // == START: Employee Schedule Specific JavaScript ==
        // ======================================================
        function initializeEmployeeSchedule(currentUserData, teamMembersDataRef) { /* ... (كود الجدول يبقى كما هو في الرد السابق) ... */ }
        // ======================================================
        // == END: Employee Schedule Specific JavaScript ==
        // ======================================================


        // ======================================================
        // == START: Dashboard Core JavaScript ==
        // ======================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded. Initializing Dashboard...");

            // --- Initialize Variables First ---
            let currentUser = {};
            let teamMembers = [];
            let activities = [];
            let notifications = [];
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let activityIntervalId = null;
            let confirmCallback = null;
            let cancelCallback = null;
            const DEFAULT_USER = { id: 1, name: 'Default User', email: 'default@example.com', title: 'Member', department: 'General', phone: '', avatar: '', initials: 'DU', role: 'member', password: 'password', preferences: { language: 'en', timezone: 'utc', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' }, notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } }, security: { twoFactorEnabled: false }, stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' } };
            const MAX_ACTIVITIES_DISPLAYED = 5;
            const UPDATE_INTERVAL = 60000;
            const SIMULATED_DELAY = 800;
            const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500;

            // --- DOM Elements Cache (Cache after DOM is loaded) ---
            let sidebar, menuItems, searchInput, searchResults, notificationIcon, notificationBadge, notificationsModal, notificationsBody, closeNotifications, markAllReadBtn, deleteAllNotificationsBtn, userAvatar, userProfileDetails, userName, userEmail, welcomeName, userDropdown, profileLink, settingsLink, logoutLink, contentSections, dashboardContent, profileContent, settingsContent, featureSectionsContainer, featureSections, featurePlaceholder, featureTitle, featureDescription, featureLoadingIndicator, featureErrorMessage, profileForm, cancelProfileBtn, profileAvatarInput, profileAvatar, profileAvatarLarge, uploadPhotoButton, activityList, viewAllActivity, deleteAllActivity, settingsTabs, settingsPanels, preferencesForm, accountForm, securityForm, notificationsForm, teamList, inviteMemberForm, themeOptions, layoutDensitySelect, weekStartSelect, confirmModal, confirmTitle, confirmMessage, cancelConfirmBtn, confirmBtn, teamMembersCount, tasksCompleted, activeProjects, upcomingDeadlines, userInfoRoleTitle, backButton, notificationSound, successMessage, successMessageText, cancelPreferencesBtn, cancelAccountBtn, cancelSecurityBtn, cancelNotificationsBtn, currentPasswordInput, newPasswordInput, confirmPasswordInput, currentPasswordError, passwordMatchError, teamMembersTrend, tasksCompletedTrend, activeProjectsTrend, upcomingDeadlinesTrend, soundNotificationsSwitch, fullNameDisplay, teamSettingsTab, dangerZoneTab;

            function cacheDOMElements() {
                 sidebar = document.getElementById('sidebar');
                 menuItems = document.querySelectorAll('.menu-item');
                 searchInput = document.getElementById('searchInput');
                 searchResults = document.getElementById('searchResults');
                 notificationIcon = document.getElementById('notificationIcon');
                 notificationBadge = document.querySelector('.notification-badge');
                 notificationsModal = document.getElementById('notificationsModal');
                 notificationsBody = document.getElementById('notificationsBody');
                 closeNotifications = document.getElementById('closeNotifications');
                 markAllReadBtn = document.getElementById('markAllReadBtn');
                 deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
                 userAvatar = document.getElementById('userAvatar');
                 userProfileDetails = document.querySelector('.user-profile-details');
                 userName = document.getElementById('userName');
                 userEmail = document.getElementById('userEmail');
                 welcomeName = document.getElementById('welcomeName');
                 userDropdown = document.getElementById('userDropdown');
                 profileLink = document.getElementById('profileLink');
                 settingsLink = document.getElementById('settingsLink');
                 logoutLink = document.getElementById('logoutLink');
                 contentSections = document.querySelectorAll('.content-section');
                 dashboardContent = document.getElementById('dashboardContent');
                 profileContent = document.getElementById('profileContent');
                 settingsContent = document.getElementById('settingsContent');
                 featureSectionsContainer = document.getElementById('featureSectionsContainer');
                 featureSections = document.getElementById('featureSections');
                 featurePlaceholder = document.getElementById('featurePlaceholder');
                 featureTitle = document.getElementById('featureTitle');
                 featureDescription = document.getElementById('featureDescription');
                 featureLoadingIndicator = featurePlaceholder?.querySelector('.loading-indicator');
                 featureErrorMessage = featurePlaceholder?.querySelector('.error-message');
                 profileForm = document.getElementById('profileForm');
                 cancelProfileBtn = document.getElementById('cancelProfileBtn');
                 profileAvatarInput = document.getElementById('profileAvatarInput');
                 profileAvatar = document.getElementById('profileAvatar');
                 profileAvatarLarge = document.getElementById('profileAvatarLarge');
                 uploadPhotoButton = document.getElementById('uploadPhotoButton');
                 activityList = document.getElementById('activityList');
                 viewAllActivity = document.getElementById('viewAllActivity');
                 deleteAllActivity = document.getElementById('deleteAllActivity');
                 settingsTabs = document.querySelectorAll('.settings-tab');
                 settingsPanels = document.querySelectorAll('.settings-panel');
                 preferencesForm = document.getElementById('preferencesForm');
                 accountForm = document.getElementById('accountForm');
                 securityForm = document.getElementById('securityForm');
                 notificationsForm = document.getElementById('notificationsForm');
                 teamList = document.getElementById('teamList');
                 inviteMemberForm = document.getElementById('inviteMemberForm');
                 themeOptions = document.querySelectorAll('.theme-option');
                 layoutDensitySelect = document.getElementById('layoutDensity');
                 weekStartSelect = document.getElementById('weekStart');
                 confirmModal = document.getElementById('confirmModal');
                 confirmTitle = document.getElementById('confirmTitle');
                 confirmMessage = document.getElementById('confirmMessage');
                 cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
                 confirmBtn = document.getElementById('confirmBtn');
                 teamMembersCount = document.getElementById('teamMembersCount');
                 tasksCompleted = document.getElementById('tasksCompleted');
                 activeProjects = document.getElementById('activeProjects');
                 upcomingDeadlines = document.getElementById('upcomingDeadlines');
                 userInfoRoleTitle = document.getElementById('userInfoRoleTitle');
                 backButton = document.getElementById('backButton');
                 notificationSound = document.getElementById('notificationSound');
                 successMessage = document.getElementById('successMessage');
                 successMessageText = document.getElementById('successMessageText');
                 cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
                 cancelAccountBtn = document.getElementById('cancelAccountBtn');
                 cancelSecurityBtn = document.getElementById('cancelSecurityBtn');
                 cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn');
                 currentPasswordInput = document.getElementById('currentPassword');
                 newPasswordInput = document.getElementById('newPassword');
                 confirmPasswordInput = document.getElementById('confirmPassword');
                 currentPasswordError = document.getElementById('currentPasswordError');
                 passwordMatchError = document.getElementById('passwordMatchError');
                 teamMembersTrend = document.getElementById('teamMembersTrend');
                 tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
                 activeProjectsTrend = document.getElementById('activeProjectsTrend');
                 upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
                 soundNotificationsSwitch = document.getElementById('soundNotifications');
                 fullNameDisplay = document.getElementById('fullNameDisplay');
                 teamSettingsTab = document.getElementById('teamSettingsTab');
                 dangerZoneTab = document.getElementById('dangerZoneTab');
                 console.log("DOM Elements cached.");
            }

            // --- Helper function for deep merging objects ---
            function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
            function deepMerge(target, source) {
                let output = { ...target };
                if (isObject(target) && isObject(source)) {
                    Object.keys(source).forEach(key => {
                        if (isObject(source[key])) {
                            if (!(key in target) || !isObject(target[key])) { // Check if target key exists and is an object
                                output[key] = { ...source[key] }; // Clone source if target[key] is not an object
                            } else {
                                output[key] = deepMerge(target[key], source[key]);
                            }
                        } else {
                            output[key] = source[key]; // Assign primitive values directly
                        }
                    });
                }
                return output;
            }

            // --- **** CORRECTED loadData Function **** ---
            function loadData() {
                 console.log("Loading data from localStorage...");

                 const safeParse = (key, defaultValue = null) => {
                     let itemString = null;
                     try {
                         itemString = localStorage.getItem(key);
                     } catch (e) {
                          console.error(`Error reading localStorage key "${key}":`, e);
                          return defaultValue; // Return default if reading fails (e.g., security error)
                     }

                     // Check for null or the literal string "undefined"
                     if (itemString === null || itemString === 'undefined') {
                         console.log(`LocalStorage key "${key}" not found or was 'undefined', using default.`);
                         // Attempt to remove the invalid entry if it was the string "undefined"
                         if (itemString === 'undefined') {
                             try { localStorage.removeItem(key); console.log(`Removed invalid 'undefined' value for key "${key}".`); } catch (e) { console.error(`Error removing localStorage key "${key}":`, e); }
                         }
                         return defaultValue;
                     }

                     // Attempt to parse the string
                     try {
                         const parsed = JSON.parse(itemString);

                         // If a default value was provided and it's an array, ensure the parsed value is also an array
                         if (Array.isArray(defaultValue) && !Array.isArray(parsed)) {
                             console.warn(`LocalStorage key "${key}" expected array but found non-array. Value:`, itemString, "Using default.");
                             try { localStorage.removeItem(key); } catch (e) { console.error(`Error removing localStorage key "${key}":`, e); } // Remove invalid data
                             return defaultValue;
                         }
                         // If a default value was provided and it's an object, ensure parsed is an object
                         if (isObject(defaultValue) && !isObject(parsed)) {
                             console.warn(`LocalStorage key "${key}" expected object but found non-object. Value:`, itemString, "Using default.");
                              try { localStorage.removeItem(key); } catch (e) { console.error(`Error removing localStorage key "${key}":`, e); } // Remove invalid data
                              return defaultValue;
                         }

                         return parsed; // Return the successfully parsed value
                     } catch (error) {
                         // Handle JSON parsing errors
                         console.error(`Error parsing JSON for localStorage key "${key}":`, error, "Value was:", itemString);
                         try { localStorage.removeItem(key); } catch (e) { console.error(`Error removing localStorage key "${key}":`, e); } // Remove invalid JSON
                         return defaultValue; // Return default value on parse error
                     }
                 };

                 // Load currentUser safely
                 currentUser = deepMerge(DEFAULT_USER, safeParse('currentUser', {})); // Pass empty object as default to deepMerge

                 // Load teamMembers safely, ensuring it's an array
                 teamMembers = safeParse('teamMembers', [ /* Default team members array if needed */
                      { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', role: 'admin', initials: 'ME', avatar: '', title: 'Administrator', department: 'Management', phone: '+201234567890' },
                      { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', role: 'member', initials: 'YA', avatar: '', title: 'Developer', department: 'IT', phone: '' },
                      { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'senior', initials: 'EL', avatar: '', title: 'Senior Designer', department: 'Design', phone: '' },
                      { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'supervisor', initials: 'BB', avatar: '', title: 'Team Lead', department: 'Marketing', phone: '' }
                 ]);
                 // Ensure minimum required fields after loading/defaulting
                 teamMembers = teamMembers.map(m => ({ id: m.id ?? Date.now()+Math.random(), name: m.name||'Unnamed', email: m.email||'no-email-'+Date.now(), role: m.role||'member', initials: m.initials||m.name?.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()||'??', avatar: m.avatar||'' }));

                 // Load activities safely, ensuring it's an array
                 activities = safeParse('activities', []);

                 // Load notifications safely, ensuring it's an array
                 notifications = safeParse('notifications', []);

                 console.log("Data loading process complete.");
             }
             // --- **** END CORRECTED loadData Function **** ---


            function saveData() { /* ... keep as is ... */ }
            function clearUserData() { /* ... keep as is ... */ }


            // --- UI Update Functions ---
            function updateUserUI() { /* ... keep as is ... */ }
            function applyUserPreferences() { /* ... keep as is ... */ }
            function applyRBAC() { /* ... keep as is ... */ }
            function loadSettingsFormData() { /* ... keep as is ... */ }
            function updateStats() { /* ... keep as is ... */ }
            function updateTrendIndicator(element, trendValue) { /* ... keep as is ... */ }
            function updateNotificationBadge() { /* ... keep as is ... */ }

            // --- Feature/Section Loading ---
            function setActiveFeature(featureId, settingsTab = null) { /* ... keep as is (with the call to initializeEmployeeSchedule) ... */ }

            // --- Other Dashboard Functions ---
            function activateSettingsTab(tabId) { /* ... keep as is ... */ }
            function handleInitialNavigation() { /* ... keep as is ... */ }
            function loadActivities(showAll = false) { /* ... keep as is ... */ }
            function loadNotifications() { /* ... keep as is ... */ }
            function getTimeAgo(timestamp) { /* ... keep as is ... */ }
            function updateActivityTimes() { /* ... keep as is ... */ }
            function startActivityTimeUpdater() { /* ... keep as is ... */ }
            function loadTeamMembers() { /* ... keep as is ... */ }
            function showConfirmModal(config) { /* ... keep as is ... */ }
            function hideConfirmModal() { /* ... keep as is ... */ }
            function handleProfileSave(e) { /* ... keep as is ... */ }
            function handleProfileCancel() { /* ... keep as is ... */ }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... keep as is ... */ }
            function handleSettingsCancel(panelId) { /* ... keep as is ... */ }
            window.dashboardAddTeamMember = (newMemberData) => { /* ... keep as is ... */ }; // Expose integration function
            function handleInviteMember(e) { /* ... keep as is ... */ }
            function handleEditMemberClick(e) { /* ... keep as is ... */ }
            function handleDeleteMemberClick(e) { /* ... keep as is ... */ }
            function handleDeleteActivityClick(e) { /* ... keep as is ... */ }
            function handleDeleteAllActivities() { /* ... keep as is ... */ }
            function markNotificationAsRead(id, itemEl) { /* ... keep as is ... */ }
            function handleMarkAllNotificationsRead() { /* ... keep as is ... */ }
            function handleDeleteNotificationClick(id) { /* ... keep as is ... */ }
            function handleDeleteAllNotifications() { /* ... keep as is ... */ }
            function handleAvatarUpload(e) { /* ... Use CORRECTED version from previous response ... */
                const file = e.target.files?.[0]; if (!file) return;
                if (!file.type.startsWith('image/')) { alert('Image files only.'); return; }
                if (file.size > 2 * 1024 * 1024) { alert('Max 2MB.'); return; }
                const reader = new FileReader();
                reader.onload = ev => {
                    const url = ev.target?.result; if (!url) return;
                    showConfirmModal({ title:'Update Profile Picture?', message:'Set this image?', confirmText:'Set Picture', confirmClass:'btn-primary',
                        onConfirm: () => { currentUser.avatar = url; saveData(); updateUserUI(); addActivity('fa-camera','Changed profile picture.'); showSuccessMessage('Picture updated.'); hideConfirmModal(); },
                        onCancel: () => { if (profileAvatarInput) profileAvatarInput.value = null; hideConfirmModal(); } });
                };
                reader.onerror = () => { alert('Error reading file.'); }; // Semicolon needed
                reader.readAsDataURL(file);
            }
            function handleLogout() { /* ... keep as is ... */ }
            function addActivity(icon, message) { /* ... keep as is ... */ }
            function addNotification(icon, message) { /* ... keep as is ... */ }
            function playNotificationSound() { /* ... keep as is ... */ }
            function showSuccessMessage(message) { /* ... keep as is ... */ }
            function setupEventListeners() { /* ... keep as is ... */ }
            function handleSearch() { /* ... keep as is ... */ }

            // --- Run Initialization ---
            cacheDOMElements(); // Cache elements right after DOM loaded
            initDashboard(); // Then run the main initialization logic

        }); // --- End of DOMContentLoaded ---
        // ======================================================
        // == END: Dashboard Core JavaScript ==
        // ======================================================
    </script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->

    <!-- Bootstrap 5 CSS (Needed for Features) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- SweetAlert2 CSS (for Data Management & File Sharing) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981; /* Used as Success in some features */
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --info: #0dcaf0; /* Bootstrap cyan for info */
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981; /* Explicit success */
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */
            --dashboard-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%); /* Fancy Header Gradient */

            /* High Contrast Variables */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable */
            --text-color: var(--dark);
            --text-muted: var(--gray); /* Define a muted text color */

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6;
             --schedule-weekend-text: #9ca3af;
             --shift-morning-bg: #dbeafe; --shift-morning-text: #1e40af; --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe; --shift-afternoon-text: #0c4a6e; --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe; --shift-night-text: #5b21b6; --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4; --shift-off-text: #166534; --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2; --shift-sick-text: #991b1b; --shift-sick-border: #fecaca;
             --shift-vacation-bg: #ffedd5; --shift-vacation-text: #9a3412; --shift-vacation-border: #fed7aa;
             --schedule-table-header-bg: var(--primary); --schedule-table-header-text: var(--white); --schedule-table-sticky-header-bg: var(--primary); --schedule-table-employee-sticky-bg: var(--white); --schedule-table-hover-bg: #f0f9ff;

            /* --- Team Members Feature Specific Variables --- */
            --feature-team-bg: var(--white); --feature-team-card-bg: var(--white); --feature-team-border-color: var(--light-gray); --feature-team-shadow-color: rgba(0, 0, 0, 0.05); --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); --feature-team-text-primary: var(--dark); --feature-team-text-secondary: var(--gray); --feature-team-title-text: var(--dark); --feature-team-title-bg: var(--light); --feature-team-admin-color: var(--danger); --feature-team-supervisor-color: var(--primary); --feature-team-senior-color: var(--success); --feature-team-member-color: var(--gray); --feature-team-card-border-radius: 12px; --feature-team-section-padding: 1.5rem; --feature-team-card-padding: 1.25rem; --feature-team-grid-gap: 1.5rem;

            /* --- Projects Feature Specific Variables --- */
            --feature-projects-body-bg: var(--primary-light); --feature-projects-card-bg: var(--white); --feature-projects-text-color: var(--text-color); --feature-projects-text-muted: var(--gray); --feature-projects-heading-color: var(--primary-dark); --feature-projects-border-color: var(--light-gray); --feature-projects-shadow-color: rgba(0, 0, 0, 0.08); --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12); --feature-projects-input-bg: var(--white); --feature-projects-input-border: var(--light-gray); --feature-projects-input-focus-border: var(--primary); --feature-projects-input-focus-shadow: rgba(37, 99, 235, 0.1); --feature-projects-primary-color: var(--primary); --feature-projects-primary-hover: var(--primary-dark); --feature-projects-primary-text: var(--white); --feature-projects-success-bg: #dcfce7; --feature-projects-success-text: #15803d; --feature-projects-success-progress: var(--success); --feature-projects-warning-bg: #fef3c7; --feature-projects-warning-text: #a16207; --feature-projects-warning-progress: var(--warning); --feature-projects-warning-btn-text: var(--dark); --feature-projects-info-bg: #e0f2fe; --feature-projects-info-text: #075985; --feature-projects-info-progress: var(--primary); --feature-projects-secondary-bg: var(--light-gray); --feature-projects-secondary-text: var(--gray); --feature-projects-secondary-progress: var(--gray); --feature-projects-danger-color: var(--danger); --feature-projects-danger-hover: #dc2626; --feature-projects-danger-text: var(--white); --feature-projects-progress-bar-bg: var(--light-gray); --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5);

            /* --- File Sharing Variables --- */
            --feature-filesharing-primary: var(--primary);
            --feature-filesharing-secondary: var(--gray);
            --feature-filesharing-success: var(--success);
            --feature-filesharing-danger: var(--danger);
            --feature-filesharing-warning: var(--warning);
            --feature-filesharing-info: var(--info);
            --feature-filesharing-light: var(--light);
            --feature-filesharing-dark: var(--dark);
            --feature-filesharing-hover-bg: #eef4ff;
            --feature-filesharing-header-bg: var(--dashboard-header-bg);

            /* --- Project Tracking Variables --- */
            --feature-tracking-primary: var(--primary);
            --feature-tracking-secondary: var(--gray);
            --feature-tracking-success: var(--success);
            --feature-tracking-danger: var(--danger);
            --feature-tracking-warning: var(--warning);
            --feature-tracking-info: var(--info);
            --feature-tracking-purple: #6f42c1;
            --feature-tracking-orange: #fd7e14;
            --feature-tracking-teal: #20c997;
            --feature-tracking-light: var(--light);
            --feature-tracking-dark: var(--dark);
            --feature-tracking-hover-bg: #eef4ff;
            --feature-tracking-header-bg: var(--dashboard-header-bg);
            --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-gray: #9E9E9E; --chart-purple: #9C27B0; --chart-cyan: #00BCD4;
            --chart-background: #F5F7FA;
            --status-completed-bg: rgba(76, 175, 80, 0.15); --status-completed-text: #388E3C;
            --status-inprogress-bg: rgba(33, 150, 243, 0.15); --status-inprogress-text: #1976D2;
            --status-delayed-bg: rgba(255, 193, 7, 0.15); --status-delayed-text: #FFA000;
            --status-pending-bg: rgba(158, 158, 158, 0.15); --status-pending-text: #616161;
            --priority-high-bg: rgba(244, 67, 54, 0.15); --priority-high-text: #D32F2F;
            --priority-medium-bg: rgba(255, 193, 7, 0.15); --priority-medium-text: #FFA000;
            --priority-low-bg: rgba(76, 175, 80, 0.15); --priority-low-text: #388E3C;
            --feature-tracking-chart-background: var(--chart-background);

            /* --- Reports & Analytics Variables --- */
            --feature-reports-primary: var(--primary);
            --feature-reports-secondary: var(--gray);
            --feature-reports-success: var(--success);
            --feature-reports-danger: var(--danger);
            --feature-reports-warning: var(--warning);
            --feature-reports-info: var(--info);
            --feature-reports-purple: #6f42c1;
            --feature-reports-orange: #fd7e14;
            --feature-reports-teal: #20c997;
            --feature-reports-light: var(--light);
            --feature-reports-dark: var(--dark);
            --feature-reports-hover-bg: #eef4ff;
            --feature-reports-header-bg: var(--dashboard-header-bg);
            --feature-reports-chart-background: #F5F7FA;
            --feature-reports-chart-fill-opacity: 0.7;
            --feature-reports-chart-radar-fill-opacity: 0.15;

             /* --- Data Management Variables --- */
             --feature-data-management-primary: var(--primary);
             --feature-data-management-secondary: var(--gray);
             --feature-data-management-success: var(--success);
             --feature-data-management-danger: var(--danger);
             --feature-data-management-warning: var(--warning);
             --feature-data-management-info: var(--info);
             --feature-data-management-light: var(--light);
             --feature-data-management-dark: var(--dark);
             --feature-data-management-hover-bg: #eef4ff;
             --feature-data-management-header-bg: var(--dashboard-header-bg);
             --feature-data-management-border-color: var(--light-gray);
             --feature-data-management-table-hover: #f1f1f1;
             --feature-data-management-status-active-bg: #e8f5e9; --feature-data-management-status-active-text: #388e3c;
             --feature-data-management-status-pending-bg: #fff3e0; --feature-data-management-status-pending-text: #f57c00;
             --feature-data-management-status-inactive-bg: #fce4ec; --feature-data-management-status-inactive-text: #d81b60;

             /* --- Deadline Tracker Variables --- */
             --feature-deadline-tracker-bg-color: var(--light);
             --feature-deadline-tracker-text-color: var(--dark);
             --feature-deadline-tracker-card-bg-color: var(--white);
             --feature-deadline-tracker-border-color: var(--light-gray);
             --feature-deadline-tracker-primary-color: var(--primary);
             --feature-deadline-tracker-primary-text-color: var(--white);
             --feature-deadline-tracker-secondary-text-color: var(--gray);
             --feature-deadline-tracker-hover-bg-color: #f3f4f6;
             --feature-deadline-tracker-icon-color: var(--gray);
             --feature-deadline-tracker-shadow-color: rgba(0, 0, 0, 0.05);
             --feature-deadline-tracker-input-border-color: var(--light-gray);
             --feature-deadline-tracker-input-bg-color: var(--white);
             --feature-deadline-tracker-button-secondary-bg: #f3f4f6;
             --feature-deadline-tracker-button-secondary-text: var(--dark);
             --feature-deadline-tracker-button-secondary-hover-bg: var(--light-gray);
             --feature-deadline-tracker-button-radius: 6px;
             --feature-deadline-tracker-card-radius: 8px;
             --feature-deadline-tracker-status-progress-bg: #ffedd5; --feature-deadline-tracker-status-progress-text: #c2410c;
             --feature-deadline-tracker-status-completed-bg: #dcfce7; --feature-deadline-tracker-status-completed-text: #166534;
             --feature-deadline-tracker-status-overdue-bg: #fee2e2;   --feature-deadline-tracker-status-overdue-text: #b91c1c;
             --feature-deadline-tracker-highlight-near-due-bg: #fef9c3;
             --feature-deadline-tracker-highlight-overdue-bg: #fee2e2;
             --feature-deadline-tracker-export-excel-bg: var(--success);
             --feature-deadline-tracker-export-pdf-bg: var(--danger);
             --feature-deadline-tracker-export-button-text: var(--white);
             --feature-deadline-tracker-confirm-overlay-bg: rgba(0, 0, 0, 0.4);
             --feature-deadline-tracker-confirm-yes-bg: var(--success);
             --feature-deadline-tracker-confirm-yes-hover-bg: #16a34a;
             --feature-deadline-tracker-confirm-no-bg: var(--danger);
             --feature-deadline-tracker-confirm-no-hover-bg: #dc2626;
             --feature-deadline-tracker-table-header-bg: #f9fafb;
             --feature-deadline-tracker-table-row-hover-bg: #f0f9ff;
             --feature-deadline-tracker-table-border-color: var(--light-gray);

              /* --- Innovation Hub Variables --- */
              --feature-innovation-hub-bg-color: var(--light);
              --feature-innovation-hub-text-color: var(--dark);
              --feature-innovation-hub-card-bg-color: var(--white);
              --feature-innovation-hub-border-color: var(--light-gray);
              --feature-innovation-hub-primary-color: var(--primary);
              --feature-innovation-hub-primary-text-color: var(--white);
              --feature-innovation-hub-secondary-text-color: var(--gray);
              --feature-innovation-hub-hover-bg-color: #f3f4f6;
              --feature-innovation-hub-icon-color: var(--gray);
              --feature-innovation-hub-shadow-color: rgba(0, 0, 0, 0.08);
              --feature-innovation-hub-input-border-color: var(--light-gray);
              --feature-innovation-hub-input-bg-color: var(--white);
              --feature-innovation-hub-button-secondary-bg: var(--gray);
              --feature-innovation-hub-button-secondary-text: var(--white);
              --feature-innovation-hub-button-secondary-hover-bg: #4b5563;
              --feature-innovation-hub-danger-color: var(--danger);
              --feature-innovation-hub-danger-text-color: var(--white);
              --feature-innovation-hub-danger-hover-bg: #bb2d3b;
              --feature-innovation-hub-hub-header-bg-start: #6f42c1; /* Purple */
              --feature-innovation-hub-hub-header-bg-end: #0d6efd; /* Blue */
              --feature-innovation-hub-hub-header-text-color: var(--white);
              --feature-innovation-hub-status-review-bg: #cfe2ff; --feature-innovation-hub-status-review-text: #0a58ca;
              --feature-innovation-hub-status-implemented-bg: #d1e7dd; --feature-innovation-hub-status-implemented-text: #146c43;
              --feature-innovation-hub-status-rejected-bg: #f8d7da; --feature-innovation-hub-status-rejected-text: #842029;

              /* --- Team Calendar Variables --- */
              --feature-team-calendar-bg-color: var(--light);
              --feature-team-calendar-text-color: var(--dark);
              --feature-team-calendar-card-bg-color: var(--white);
              --feature-team-calendar-border-color: var(--light-gray);
              --feature-team-calendar-primary-color: var(--primary);
              --feature-team-calendar-primary-text-color: var(--white);
              --feature-team-calendar-secondary-text-color: var(--gray);
              --feature-team-calendar-hover-bg-color: #e9ecef;
              --feature-team-calendar-icon-color: var(--dark);
              --feature-team-calendar-shadow-color: rgba(0, 0, 0, 0.1);
              --feature-team-calendar-modal-overlay-color: rgba(0, 0, 0, 0.4);
              --feature-team-calendar-page-title-bg: #e9ecef;
              --feature-team-calendar-input-border-color: var(--light-gray);
              --feature-team-calendar-input-bg-color: var(--white);
              --feature-team-calendar-button-secondary-bg: var(--gray);
              --feature-team-calendar-button-secondary-text: var(--white);
              --feature-team-calendar-button-secondary-hover-bg: #5a6268;
              --feature-team-calendar-event-meeting-bg: #cfe2ff; --feature-team-calendar-event-meeting-text: #0a58ca;
              --feature-team-calendar-event-deadline-bg: #f8d7da; --feature-team-calendar-event-deadline-text: #842029;
              --feature-team-calendar-event-task-bg: #d1e7dd; --feature-team-calendar-event-task-text: #146c43;
              --feature-team-calendar-event-personal-bg: #fff3cd; --feature-team-calendar-event-personal-text: #664d03;
              --feature-team-calendar-event-important-badge: var(--danger);
              --team-calendar-grid-header-bg: var(--light);
              --team-calendar-grid-border: var(--light-gray);
              --team-calendar-day-bg: var(--white);
              --team-calendar-other-month-text: var(--gray);
              --team-calendar-today-marker-bg: var(--primary);
              --team-calendar-today-marker-text: var(--white);


            /* Other base vars */
            --transition-speed: 0.2s;
            --animation-fade-duration: 0.4s;
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode --- */
        body.high-contrast {
             --dark: var(--hc-text); --light: var(--hc-background); --gray: var(--hc-text); --light-gray: var(--hc-border); --white: var(--hc-background); --primary: var(--hc-primary); --primary-dark: var(--hc-primary); --primary-light: #e0e0ff; --secondary: var(--hc-secondary); --success: var(--hc-secondary); --warning: #ffa500; --danger: #ff0000; --info: var(--hc-primary); --text-color: var(--hc-text); --text-muted: var(--hc-text);
             --sidebar-bg: var(--hc-background); --sidebar-text: var(--hc-text); --sidebar-hover: #e0e0e0; --sidebar-active: #c0c0c0; --sidebar-divider: var(--hc-border);
             /* Scheduling HC */
             --schedule-weekend-bg: #dddddd; --schedule-weekend-text: var(--hc-text); --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border); --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border); --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border); --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border); --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border); --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border); --schedule-table-header-bg: var(--hc-primary); --schedule-table-header-text: var(--hc-background); --schedule-table-sticky-header-bg: var(--hc-primary); --schedule-table-employee-sticky-bg: var(--hc-background); --schedule-table-hover-bg: #e0e0e0;
             /* Team Members HC */
             --feature-team-bg: var(--hc-background); --feature-team-card-bg: var(--hc-background); --feature-team-border-color: var(--hc-border); --feature-team-shadow-color: transparent; --feature-team-hover-shadow-color: transparent; --feature-team-text-primary: var(--hc-text); --feature-team-text-secondary: var(--hc-text); --feature-team-title-text: var(--hc-text); --feature-team-title-bg: var(--hc-background); --feature-team-admin-color: var(--danger); --feature-team-supervisor-color: var(--hc-primary); --feature-team-senior-color: var(--hc-secondary); --feature-team-member-color: var(--hc-text);
             /* Projects HC */
             --feature-projects-card-bg: var(--hc-background); --feature-projects-text-color: var(--hc-text); --feature-projects-text-muted: var(--hc-text); --feature-projects-heading-color: var(--hc-text); --feature-projects-border-color: var(--hc-border); --feature-projects-shadow-color: transparent; --feature-projects-shadow-hover-color: transparent; --feature-projects-input-bg: var(--hc-background); --feature-projects-input-border: var(--hc-border); --feature-projects-primary-color: var(--hc-primary); --feature-projects-primary-text: var(--hc-background); --feature-projects-success-bg: var(--hc-background); --feature-projects-success-text: var(--hc-secondary); --feature-projects-success-progress: var(--hc-secondary); --feature-projects-warning-bg: var(--hc-background); --feature-projects-warning-text: var(--hc-text); --feature-projects-warning-progress: var(--warning); --feature-projects-warning-btn-text: var(--hc-text); --feature-projects-info-bg: var(--hc-background); --feature-projects-info-text: var(--hc-primary); --feature-projects-info-progress: var(--hc-primary); --feature-projects-secondary-bg: var(--hc-background); --feature-projects-secondary-text: var(--hc-text); --feature-projects-secondary-progress: var(--hc-text); --feature-projects-danger-color: var(--danger); --feature-projects-danger-text: var(--hc-background); --feature-projects-progress-bar-bg: var(--hc-background);
             /* File Sharing HC */
             --feature-filesharing-primary: var(--hc-primary); --feature-filesharing-secondary: var(--hc-text); --feature-filesharing-success: var(--hc-secondary); --feature-filesharing-danger: var(--danger); --feature-filesharing-warning: var(--warning); --feature-filesharing-info: var(--hc-primary); --feature-filesharing-light: var(--hc-background); --feature-filesharing-dark: var(--hc-text); --feature-filesharing-hover-bg: #e0e0e0; --feature-filesharing-header-bg: var(--hc-primary);
             /* Project Tracking HC */
             --feature-tracking-primary: var(--hc-primary); --feature-tracking-secondary: var(--hc-text); --feature-tracking-success: var(--hc-secondary); --feature-tracking-danger: var(--danger); --feature-tracking-warning: var(--warning); --feature-tracking-info: var(--hc-primary); --feature-tracking-light: var(--hc-background); --feature-tracking-dark: var(--hc-text); --feature-tracking-hover-bg: #e0e0e0; --feature-tracking-header-bg: var(--hc-primary); --chart-background: var(--hc-background); --feature-tracking-chart-background: var(--hc-background);
             --status-completed-bg: transparent; --status-completed-text: var(--hc-secondary); --status-inprogress-bg: transparent; --status-inprogress-text: var(--hc-primary); --status-delayed-bg: transparent; --status-delayed-text: var(--warning); --status-pending-bg: transparent; --status-pending-text: var(--hc-text);
             --priority-high-bg: transparent; --priority-high-text: var(--danger); --priority-medium-bg: transparent; --priority-medium-text: var(--warning); --priority-low-bg: transparent; --priority-low-text: var(--hc-secondary);
             /* Reports HC */
             --feature-reports-primary: var(--hc-primary); --feature-reports-secondary: var(--hc-text); --feature-reports-success: var(--hc-secondary); --feature-reports-danger: var(--danger); --feature-reports-warning: var(--warning); --feature-reports-info: var(--hc-primary); --feature-reports-light: var(--hc-background); --feature-reports-dark: var(--hc-text); --feature-reports-hover-bg: #e0e0e0; --feature-reports-header-bg: var(--hc-primary); --feature-reports-chart-background: var(--hc-background);
             /* Data Management HC */
             --feature-data-management-primary: var(--hc-primary); --feature-data-management-secondary: var(--hc-text); --feature-data-management-success: var(--hc-secondary); --feature-data-management-danger: var(--danger); --feature-data-management-warning: var(--warning); --feature-data-management-info: var(--hc-primary); --feature-data-management-light: var(--hc-background); --feature-data-management-dark: var(--hc-text); --feature-data-management-hover-bg: #e0e0e0; --feature-data-management-header-bg: var(--hc-primary); --feature-data-management-border-color: var(--hc-border); --feature-data-management-table-hover: #e0e0e0;
             --feature-data-management-status-active-bg: transparent; --feature-data-management-status-active-text: var(--hc-secondary); --feature-data-management-status-pending-bg: transparent; --feature-data-management-status-pending-text: var(--warning); --feature-data-management-status-inactive-bg: transparent; --feature-data-management-status-inactive-text: var(--danger);
             /* Deadline Tracker HC */
             --feature-deadline-tracker-bg-color: var(--hc-background); --feature-deadline-tracker-text-color: var(--hc-text); --feature-deadline-tracker-card-bg-color: var(--hc-background); --feature-deadline-tracker-border-color: var(--hc-border); --feature-deadline-tracker-primary-color: var(--hc-primary); --feature-deadline-tracker-secondary-text-color: var(--hc-text); --feature-deadline-tracker-hover-bg-color: #e0e0e0; --feature-deadline-tracker-icon-color: var(--hc-text); --feature-deadline-tracker-shadow-color: transparent; --feature-deadline-tracker-input-border-color: var(--hc-border); --feature-deadline-tracker-input-bg-color: var(--hc-background); --feature-deadline-tracker-button-secondary-bg: #e0e0e0; --feature-deadline-tracker-button-secondary-text: var(--hc-text);
             --feature-deadline-tracker-status-progress-bg: transparent; --feature-deadline-tracker-status-progress-text: var(--warning); --feature-deadline-tracker-status-completed-bg: transparent; --feature-deadline-tracker-status-completed-text: var(--hc-secondary); --feature-deadline-tracker-status-overdue-bg: transparent; --feature-deadline-tracker-status-overdue-text: var(--danger);
             --feature-deadline-tracker-highlight-near-due-bg: #ffff00; --feature-deadline-tracker-highlight-overdue-bg: #ffdddd;
             --feature-deadline-tracker-export-excel-bg: var(--hc-secondary); --feature-deadline-tracker-export-pdf-bg: var(--danger); --feature-deadline-tracker-export-button-text: var(--hc-background);
             --feature-deadline-tracker-confirm-overlay-bg: rgba(0, 0, 0, 0.5); --feature-deadline-tracker-confirm-yes-bg: var(--hc-secondary); --feature-deadline-tracker-confirm-no-bg: var(--danger); --feature-deadline-tracker-table-header-bg: var(--hc-background); --feature-deadline-tracker-table-row-hover-bg: #e0e0e0; --feature-deadline-tracker-table-border-color: var(--hc-border);
             /* Innovation Hub HC */
             --feature-innovation-hub-bg-color: var(--hc-background); --feature-innovation-hub-text-color: var(--hc-text); --feature-innovation-hub-card-bg-color: var(--hc-background); --feature-innovation-hub-border-color: var(--hc-border); --feature-innovation-hub-primary-color: var(--hc-primary); --feature-innovation-hub-secondary-text-color: var(--hc-text); --feature-innovation-hub-hover-bg-color: #e0e0e0; --feature-innovation-hub-icon-color: var(--hc-text); --feature-innovation-hub-shadow-color: transparent; --feature-innovation-hub-input-border-color: var(--hc-border); --feature-innovation-hub-input-bg-color: var(--hc-background); --feature-innovation-hub-button-secondary-bg: #e0e0e0; --feature-innovation-hub-button-secondary-text: var(--hc-text); --feature-innovation-hub-danger-color: var(--danger);
             --feature-innovation-hub-hub-header-bg-start: var(--hc-primary); --feature-innovation-hub-hub-header-bg-end: var(--hc-primary); --feature-innovation-hub-hub-header-text-color: var(--hc-background);
             --feature-innovation-hub-status-review-bg: transparent; --feature-innovation-hub-status-review-text: var(--hc-primary); --feature-innovation-hub-status-implemented-bg: transparent; --feature-innovation-hub-status-implemented-text: var(--hc-secondary); --feature-innovation-hub-status-rejected-bg: transparent; --feature-innovation-hub-status-rejected-text: var(--danger);
              /* Team Calendar HC */
              --feature-team-calendar-bg-color: var(--hc-background); --feature-team-calendar-text-color: var(--hc-text); --feature-team-calendar-card-bg-color: var(--hc-background); --feature-team-calendar-border-color: var(--hc-border); --feature-team-calendar-primary-color: var(--hc-primary); --feature-team-calendar-secondary-text-color: var(--hc-text); --feature-team-calendar-hover-bg-color: #e0e0e0; --feature-team-calendar-icon-color: var(--hc-text); --feature-team-calendar-shadow-color: transparent; --feature-team-calendar-modal-overlay-color: rgba(0, 0, 0, 0.5); --feature-team-calendar-page-title-bg: var(--hc-background); --feature-team-calendar-input-border-color: var(--hc-border); --feature-team-calendar-input-bg-color: var(--hc-background); --feature-team-calendar-button-secondary-bg: #e0e0e0; --feature-team-calendar-button-secondary-text: var(--hc-text);
              --feature-team-calendar-event-meeting-bg: transparent; --feature-team-calendar-event-meeting-text: var(--hc-primary); --feature-team-calendar-event-deadline-bg: transparent; --feature-team-calendar-event-deadline-text: var(--danger); --feature-team-calendar-event-task-bg: transparent; --feature-team-calendar-event-task-text: var(--hc-secondary); --feature-team-calendar-event-personal-bg: transparent; --feature-team-calendar-event-personal-text: var(--warning); --feature-team-calendar-event-important-badge: var(--danger);
              --team-calendar-grid-header-bg: var(--hc-background); --team-calendar-grid-border: var(--hc-border); --team-calendar-day-bg: var(--hc-background); --team-calendar-other-month-text: var(--hc-text); --team-calendar-today-marker-bg: var(--hc-primary); --team-calendar-today-marker-text: var(--hc-background);

             color: var(--text-color); background-color: var(--hc-background);
        }
        /* Specific Element Overrides for High Contrast */
        body.high-contrast .welcome-section, body.high-contrast .stat-card, body.high-contrast .top-nav, body.high-contrast .sidebar, body.high-contrast .activity-section, body.high-contrast .content-section,
        /* Feature Containers */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section, body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section, body.high-contrast #featureSectionsContainer.projects-feature .project-card, body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper, body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-management-content, body.high-contrast #featureSectionsContainer.task-management-feature .task-card, body.high-contrast #featureSectionsContainer.task-management-feature .controls, body.high-contrast #featureSectionsContainer.task-management-feature .task-page-header,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card, body.high-contrast #featureSectionsContainer.file-sharing-feature .filters-section, body.high-contrast #featureSectionsContainer.file-sharing-feature #recentUploadsSection, body.high-contrast #featureSectionsContainer.file-sharing-feature .table,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .card, body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-filters-section, body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container, body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-reminders, body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table-container, body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .card, body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-filters-section, body.high-contrast #featureSectionsContainer.reports-analytics-feature .chart-container, body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table-container, body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table,
        body.high-contrast #featureSectionsContainer.data-management-feature #data-management-section, body.high-contrast #featureSectionsContainer.data-management-feature .dm-toolbar, body.high-contrast #featureSectionsContainer.data-management-feature .dm-table-container,
        body.high-contrast #featureSectionsContainer.deadline-tracker-feature .card, body.high-contrast #featureSectionsContainer.deadline-tracker-feature .tracker-controls, body.high-contrast #featureSectionsContainer.deadline-tracker-feature .tasks-display-area,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .innovation-hub-container, body.high-contrast #featureSectionsContainer.innovation-hub-feature .submission-form-container, body.high-contrast #featureSectionsContainer.innovation-hub-feature .hub-controls, body.high-contrast #featureSectionsContainer.innovation-hub-feature .suggestion-card,
        body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-page-container, body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-header, body.high-contrast #featureSectionsContainer.team-calendar-feature .page-title-container, body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-main-content,
        body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-container, body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th, body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td, body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name
        { background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; color: var(--text-color) !important; box-shadow: none !important; }
        /* Inputs and Selects HC */
        body.high-contrast .btn, body.high-contrast .form-control, body.high-contrast .form-select, body.high-contrast .search-bar input, body.high-contrast input[type="text"], body.high-contrast input[type="email"], body.high-contrast input[type="tel"], body.high-contrast input[type="password"], body.high-contrast input[type="number"], body.high-contrast input[type="date"], body.high-contrast input[type="time"], body.high-contrast input[type="search"], body.high-contrast input[type="url"], body.high-contrast textarea, body.high-contrast select, body.high-contrast .btn-group label
        { border: 1px solid var(--hc-border) !important; background: var(--hc-background) !important; color: var(--text-color) !important; }
        /* Buttons HC */
        body.high-contrast .btn-primary { background-color: var(--hc-primary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-danger, body.high-contrast #confirmBtn, body.high-contrast #confirm-delete-no, body.high-contrast .swal2-cancel, body.high-contrast .dm-delete-btn, body.high-contrast .admin-delete, body.high-contrast .remove-member { background-color: var(--danger) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-success, body.high-contrast #confirm-delete-yes, body.high-contrast .swal2-confirm, body.high-contrast .dm-import-btn, body.high-contrast #export-excel { background-color: var(--hc-secondary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-warning, body.high-contrast .dm-export-btn { background-color: var(--warning) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-outline, body.high-contrast .btn-outline-secondary, body.high-contrast .button-secondary, body.high-contrast .cancel-btn, body.high-contrast #cancelConfirmBtn, body.high-contrast .modal-button-secondary, body.high-contrast .nav-button { background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important; }
        body.high-contrast .btn-outline-danger { background: var(--hc-background) !important; color: var(--danger) !important; border: 1px solid var(--danger) !important; }
        body.high-contrast .btn-outline-success { background: var(--hc-background) !important; color: var(--hc-secondary) !important; border: 1px solid var(--hc-secondary) !important; }
        body.high-contrast .btn-outline-info { background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important; }
        /* Badges and Status HC */
        body.high-contrast .member-role, body.high-contrast .project-status, body.high-contrast .status-badge, body.high-contrast .priority-badge, body.high-contrast .dm-status, body.high-contrast .suggestion-status, body.high-contrast .event, body.high-contrast .badge { border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important; background: none !important; padding: 3px 8px !important; }
        /* Other Elements HC */
        body.high-contrast .logo { color: var(--text-color) !important; }
        body.high-contrast .logo-icon { color: var(--hc-primary) !important; }
        body.high-contrast .menu-item { color: var(--text-color) !important; border-left-color: transparent !important; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0 !important; border-left-color: var(--hc-primary) !important; color: var(--hc-text) !important; }
        body.high-contrast .stat-card { border-left-width: 3px !important; background: var(--hc-background) !important; }
        body.high-contrast .welcome-section { background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important;}
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text) !important; }
        body.high-contrast .progress-bar, body.high-contrast .progress { background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .progress-bar div { color: var(--hc-text) !important; background: none !important; }
        body.high-contrast .project-participants span, body.high-contrast .assigned-team span { border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important; background: none !important; }
        body.high-contrast .theme-preview { border: 2px solid var(--hc-border) !important; background: var(--hc-background) !important; }
        body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary) !important; }
        body.high-contrast .switch .slider { background-color: #999 !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary) !important; }
        body.high-contrast .switch .slider:before { background-color: var(--hc-text) !important; }
        body.high-contrast .fancy-header-title, body.high-contrast .pt-fancy-title, body.high-contrast .ra-fancy-title, body.high-contrast .dm-fancy-title, body.high-contrast .hub-header, body.high-contrast .task-page-header { background: var(--hc-primary) !important; color: var(--hc-background) !important; }
        body.high-contrast table thead, body.high-contrast .ra-table thead, body.high-contrast .dm-table thead, body.high-contrast #tasks-table thead, body.high-contrast #teamCalendarGrid thead, body.high-contrast .pt-table thead { background: var(--hc-background) !important; color: var(--hc-text) !important; border-bottom-color: var(--hc-border) !important; }
        body.high-contrast canvas { border: 1px dashed var(--hc-border); /* Make charts visible */ }
        body.high-contrast #featureSectionsContainer.deadline-tracker-feature .chart-container { background-color: var(--hc-background) !important; }
        body.high-contrast #tasks-table tbody tr.task-near-due td { background-color: yellow !important; }
        body.high-contrast #tasks-table tbody tr.task-overdue td { background-color: pink !important; }
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section { border-top-color: var(--hc-border) !important; }
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .supervisor-reply { background-color: #e0e0e0 !important; }
        body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-grid-placeholder, body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-day { background-color: var(--hc-background) !important; }
        body.high-contrast #featureSectionsContainer.team-calendar-feature .calendar-day.today .day-number { background-color: var(--hc-primary) !important; color: var(--hc-background) !important; }

        /* --- Sidebar Styles --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; text-decoration: none;}
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .connection-status span { font-weight: 600; } /* Added bold */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section { background: var(--welcome-bg-current); color: var(--white); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 500; color: inherit; } /* Changed font-weight */
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); }
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--secondary); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; border-left: 5px solid var(--primary); color: var(--text-color); }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--secondary); background: var(--stat-card-bg-2); }
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }
        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-title { font-size: 0.9rem; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        .stat-card:nth-child(1) .stat-value { color: #1e40af; } .stat-card:nth-child(2) .stat-value { color: #15803d; } .stat-card:nth-child(3) .stat-value { color: #b45309; } .stat-card:nth-child(4) .stat-value { color: #b91c1c; }
        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); } .trend-down { color: var(--danger); } .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-color); } /* Use text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--text-color); } /* Use text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .activity-item:hover .delete-activity { opacity: 1; }
        .delete-activity:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }

        /* --- Profile & Settings Sections Styles --- */
        /* Base content section styling (for Profile, Settings main container) */
        .content-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; display: none; animation: fadeInContent 0.4s ease-in-out; }
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }

        /* Feature container styling (wrapper for features like file-sharing, data-management, etc.) */
        #featureSectionsContainer {
            padding: 0; /* Remove default padding */
            background-color: transparent; /* Let inner card handle background */
            box-shadow: none; /* Let inner card handle shadow */
            border-radius: 0;
            display: none; /* Hidden by default */
            animation: fadeInContent 0.4s ease-in-out;
        }
        #featureSectionsContainer.active { display: block; } /* Shown when feature is active */

        /* Style for the main card *inside* features that need it */
        #featureSectionsContainer > div:first-child { /* Target direct child container of feature */
             border: none; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             background-color: var(--white); margin-bottom: 0;
             padding: 1.5rem; /* Apply standard padding here */
        }
        /* Adjust padding for specific features if their template needs it */
        #featureSectionsContainer.file-sharing-feature > div:first-child,
        #featureSectionsContainer.project-tracking-feature > div:first-child,
        #featureSectionsContainer.reports-analytics-feature > div:first-child,
        #featureSectionsContainer.data-management-feature #data-management-section,
        #featureSectionsContainer.deadline-tracker-feature .deadline-tracker-container,
        #featureSectionsContainer.innovation-hub-feature .innovation-hub-container,
        #featureSectionsContainer.team-calendar-feature .calendar-page-container,
        #featureSectionsContainer.task-management-feature .task-management-content,
        #featureSectionsContainer.employee-scheduling-feature .schedule-page-container,
        #featureSectionsContainer.team-members-feature .team-members-section,
        #featureSectionsContainer.projects-feature #projects-section {
             padding: 0; /* Override standard padding if feature manages it internally */
             background-color: transparent;
             box-shadow: none;
             border-radius: 0;
        }
         /* Ensure dark theme applies correctly to these inner feature containers */
        body.dark-theme #featureSectionsContainer > div:first-child {
             background-color: var(--light); border: 1px solid var(--light-gray);
        }
        body.dark-theme #featureSectionsContainer.file-sharing-feature > div:first-child,
        body.dark-theme #featureSectionsContainer.project-tracking-feature > div:first-child,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature > div:first-child,
        body.dark-theme #featureSectionsContainer.data-management-feature #data-management-section,
        body.dark-theme #featureSectionsContainer.deadline-tracker-feature .deadline-tracker-container,
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .innovation-hub-container,
        body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-page-container,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content,
        body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-page-container,
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section,
        body.dark-theme #featureSectionsContainer.projects-feature #projects-section {
             background-color: transparent !important; /* Let the feature control its bg */
             border: none !important; /* Let the feature control its border */
        }
        /* End Feature container specific styling */

        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem;} /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control, .form-select { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use text-color */
        body.compact .form-control, body.compact .form-select { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control, body.spacious .form-select { padding: 1rem; }
        .form-control:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        /* General Button Styles (Applied to all buttons including features) */
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; line-height: 1.5; vertical-align: middle; }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline, .btn-outline-secondary { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled), .btn-outline-secondary:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-warning { background-color: var(--warning); color: var(--primary-dark); }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn-secondary { background-color: var(--gray); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover:not(:disabled) { background-color: #0a9aaf; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.8rem !important; }
        /* Specific outline colors */
        .btn-outline-success { background-color: transparent; border: 1px solid var(--success); color: var(--success); }
        .btn-outline-success:hover:not(:disabled) { background-color: rgba(16, 185, 129, 0.1); }
        .btn-outline-danger { background-color: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-outline-danger:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.1); }
        .btn-outline-info { background-color: transparent; border: 1px solid var(--info); color: var(--info); }
        .btn-outline-info:hover:not(:disabled) { background-color: rgba(13, 202, 240, 0.1); }

        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        .settings-subsection { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--light-gray); }
        .settings-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-subsection h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 1rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; }
        @media (min-width: 768px) { .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; } }
        .setting-item-label { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; } }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        /* Settings Panel Team Member Card Style */
        #settingsContent .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact #settingsContent .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious #settingsContent .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        #settingsContent .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        #settingsContent .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact #settingsContent .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        #settingsContent .member-details { flex: 1; min-width: 0; }
        #settingsContent .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use text-color */
        body.compact #settingsContent .member-name { font-size: 0.9rem; }
        #settingsContent .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact #settingsContent .member-email { font-size: 0.8rem; }
        #settingsContent .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact #settingsContent .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        #settingsContent .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        #settingsContent .role-senior { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        #settingsContent .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        #settingsContent .role-member { background-color: rgba(100, 116, 139, 0.1); color: var(--gray); }
        #settingsContent .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #settingsContent .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }

        /* --- Theme Styles & Dark Mode Overrides --- */
        body.light-theme { --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; --text-color: var(--dark); background-color: var(--primary-light); }
        body.dark-theme {
             --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #1e293b; --light: #334155; --white: #0f172a; --dark: #e2e8f0; --gray: #94a3b8; --light-gray: #475569; --text-color: var(--dark); --text-muted: var(--gray);
             --schedule-weekend-bg: #262f3e; --schedule-weekend-text: #6b7280; --shift-morning-bg: #1e3a8a; --shift-morning-text: #dbeafe; --shift-morning-border: #2563eb; --shift-afternoon-bg: #0e7490; --shift-afternoon-text: #ecfeff; --shift-afternoon-border: #22d3ee; --shift-night-bg: #581c87; --shift-night-text: #f3e8ff; --shift-night-border: #a855f7; --shift-off-bg: #064e3b; --shift-off-text: #d1fae5; --shift-off-border: #34d399; --shift-sick-bg: #881337; --shift-sick-text: #fecdd3; --shift-sick-border: #fb7185; --shift-vacation-bg: #7c2d12; --shift-vacation-text: #ffedd5; --shift-vacation-border: #fb923c; --schedule-table-header-bg: var(--primary-dark); --schedule-table-header-text: var(--dark); --schedule-table-sticky-header-bg: var(--primary-dark); --schedule-table-employee-sticky-bg: var(--light); --schedule-table-hover-bg: #475569;
             background-color: var(--white); color: var(--text-color);
            /* Team Members Dark */
            --feature-team-bg: var(--white); --feature-team-card-bg: var(--light); --feature-team-border-color: var(--light-gray); --feature-team-text-primary: var(--text-color); --feature-team-text-secondary: var(--gray); --feature-team-title-text: var(--text-color); --feature-team-title-bg: var(--light);
            /* Projects Dark */
            --feature-projects-body-bg: var(--white); --feature-projects-card-bg: var(--light); --feature-projects-text-color: var(--text-color); --feature-projects-text-muted: var(--gray); --feature-projects-heading-color: #a5b4fc; --feature-projects-border-color: var(--light-gray); --feature-projects-input-bg: var(--primary-light); --feature-projects-input-border: var(--light-gray); --feature-projects-success-bg: #14532d; --feature-projects-success-text: #a7f3d0; --feature-projects-success-progress: #4ade80; --feature-projects-warning-bg: #7f5d11; --feature-projects-warning-text: #fef3c7; --feature-projects-warning-progress: #facc15; --feature-projects-warning-btn-text: #1f2937; --feature-projects-info-bg: #1e40af; --feature-projects-info-text: #dbeafe; --feature-projects-info-progress: #60a5fa; --feature-projects-secondary-bg: #4b5563; --feature-projects-secondary-text: #d1d5db; --feature-projects-secondary-progress: var(--gray); --feature-projects-danger-color: #f87171; --feature-projects-danger-hover: #ef4444; --feature-projects-progress-bar-bg: var(--light-gray);
             /* File Sharing Dark */
             --feature-filesharing-light: var(--light); --feature-filesharing-dark: var(--dark); --feature-filesharing-hover-bg: var(--primary-light);
             /* Project Tracking Dark */
             --feature-tracking-light: var(--light); --feature-tracking-dark: var(--dark); --feature-tracking-hover-bg: var(--primary-light); --chart-background: var(--light); --feature-tracking-chart-background: var(--light);
             --status-completed-bg: #14532d; --status-completed-text: #a7f3d0; --status-inprogress-bg: #1e40af; --status-inprogress-text: #dbeafe; --status-delayed-bg: #7c2d12; --status-delayed-text: #fb923c; --status-pending-bg: #4b5563; --status-pending-text: #d1d5db; --priority-high-bg: #7f1d1d; --priority-high-text: #f87171; --priority-medium-bg: #7c2d12; --priority-medium-text: #fb923c; --priority-low-bg: #14532d; --priority-low-text: #a7f3d0;
             /* Reports Dark */
             --feature-reports-light: var(--light); --feature-reports-dark: var(--dark); --feature-reports-hover-bg: var(--primary-light); --feature-reports-chart-background: var(--light);
             /* Data Management Dark */
             --feature-data-management-light: var(--light); --feature-data-management-dark: var(--dark); --feature-data-management-hover-bg: var(--primary-light); --feature-data-management-border-color: var(--light-gray); --feature-data-management-table-hover: var(--primary-light);
             --feature-data-management-status-active-bg: #14532d; --feature-data-management-status-active-text: #a7f3d0; --feature-data-management-status-pending-bg: #7c2d12; --feature-data-management-status-pending-text: #fb923c; --feature-data-management-status-inactive-bg: #881337; --feature-data-management-status-inactive-text: #fecdd3;
             /* Deadline Tracker Dark */
             --feature-deadline-tracker-bg-color: var(--white); --feature-deadline-tracker-text-color: var(--dark); --feature-deadline-tracker-card-bg-color: var(--light); --feature-deadline-tracker-border-color: var(--light-gray); --feature-deadline-tracker-secondary-text-color: var(--gray); --feature-deadline-tracker-hover-bg-color: var(--primary-light); --feature-deadline-tracker-icon-color: var(--gray); --feature-deadline-tracker-input-border-color: var(--light-gray); --feature-deadline-tracker-input-bg-color: var(--primary-light); --feature-deadline-tracker-button-secondary-bg: var(--primary-light); --feature-deadline-tracker-button-secondary-hover-bg: #4b5563;
             --feature-deadline-tracker-status-progress-bg: #7c2d12; --feature-deadline-tracker-status-progress-text: #fb923c; --feature-deadline-tracker-status-completed-bg: #14532d; --feature-deadline-tracker-status-completed-text: #4ade80; --feature-deadline-tracker-status-overdue-bg: #7f1d1d; --feature-deadline-tracker-status-overdue-text: #f87171;
             --feature-deadline-tracker-highlight-near-due-bg: #422006; --feature-deadline-tracker-highlight-overdue-bg: #7f1d1d;
             --feature-deadline-tracker-confirm-overlay-bg: rgba(0, 0, 0, 0.6); --feature-deadline-tracker-table-header-bg: var(--primary-light); --feature-deadline-tracker-table-row-hover-bg: var(--primary-light); --feature-deadline-tracker-table-border-color: var(--light-gray);
             /* Innovation Hub Dark */
             --feature-innovation-hub-bg-color: var(--white); --feature-innovation-hub-text-color: var(--dark); --feature-innovation-hub-card-bg-color: var(--light); --feature-innovation-hub-border-color: var(--light-gray); --feature-innovation-hub-secondary-text-color: var(--gray); --feature-innovation-hub-hover-bg-color: var(--primary-light); --feature-innovation-hub-icon-color: var(--gray); --feature-innovation-hub-input-border-color: var(--light-gray); --feature-innovation-hub-input-bg-color: var(--primary-light); --feature-innovation-hub-button-secondary-bg: var(--primary-light); --feature-innovation-hub-button-secondary-hover-bg: #4b5563;
             --feature-innovation-hub-hub-header-bg-start: #5a3b9a; --feature-innovation-hub-hub-header-bg-end: #0b5ed7;
             --feature-innovation-hub-status-review-bg: #0a58ca; --feature-innovation-hub-status-review-text: #cfe2ff; --feature-innovation-hub-status-implemented-bg: #146c43; --feature-innovation-hub-status-implemented-text: #d1e7dd; --feature-innovation-hub-status-rejected-bg: #842029; --feature-innovation-hub-status-rejected-text: #f8d7da;
              /* Team Calendar Dark */
              --feature-team-calendar-bg-color: var(--white); --feature-team-calendar-text-color: var(--dark); --feature-team-calendar-card-bg-color: var(--light); --feature-team-calendar-border-color: var(--light-gray); --feature-team-calendar-secondary-text-color: var(--gray); --feature-team-calendar-hover-bg-color: var(--primary-light); --feature-team-calendar-icon-color: var(--dark); --feature-team-calendar-modal-overlay-color: rgba(0, 0, 0, 0.6); --feature-team-calendar-page-title-bg: var(--primary-light); --feature-team-calendar-input-border-color: var(--light-gray); --feature-team-calendar-input-bg-color: var(--primary-light); --feature-team-calendar-button-secondary-bg: var(--primary-light); --feature-team-calendar-button-secondary-hover-bg: #4b5563;
              --feature-team-calendar-event-meeting-bg: #0a58ca; --feature-team-calendar-event-meeting-text: #cfe2ff; --feature-team-calendar-event-deadline-bg: #842029; --feature-team-calendar-event-deadline-text: #f8d7da; --feature-team-calendar-event-task-bg: #146c43; --feature-team-calendar-event-task-text: #d1e7dd; --feature-team-calendar-event-personal-bg: #664d03; --feature-team-calendar-event-personal-text: #fff3cd;
              --team-calendar-grid-header-bg: var(--light); --team-calendar-grid-border: var(--light-gray); --team-calendar-day-bg: var(--light); --team-calendar-other-month-text: var(--gray); --team-calendar-today-marker-bg: var(--primary); --team-calendar-today-marker-text: var(--white);
        }
        /* Dark Theme General Overrides */
        body.dark-theme .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); }
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme #settingsContent .team-member-card, body.dark-theme .add-member-form { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-bar input, body.dark-theme .form-control, body.dark-theme .form-select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme .form-control[readonly] { background-color: var(--light); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item { color: var(--text-color); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item { color: var(--text-color); }
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--light); }
        body.dark-theme .notification-list-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); }
        body.dark-theme .confirm-container, body.dark-theme .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme .theme-option .theme-preview { border-color: var(--light-gray); background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%); }
        body.dark-theme .theme-option .light-preview { background: var(--light) !important; }
        body.dark-theme .theme-option .dark-preview { background: var(--white) !important; }
        body.dark-theme .theme-option .system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray);}
        body.dark-theme .theme-option.selected .theme-preview { border-color: var(--primary); }
        body.dark-theme .theme-option .theme-label { color: var(--text-color); }
        body.dark-theme .back-button { color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--light); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--light); border-top-color: var(--light-gray); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white); }
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; }
        body.dark-theme .user-info-name { color: inherit; }
        body.dark-theme .user-info-title { color: var(--gray); }
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email span { color: inherit; }
        body.dark-theme .stat-card { background: var(--light); color: var(--text-color);}
        body.dark-theme .stat-title { color: var(--text-color); }
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; } body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; } body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; } body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        body.dark-theme .activity-item { border-bottom-color: var(--light-gray); }
        body.dark-theme .activity-message { color: var(--text-color); }
        body.dark-theme .activity-time { color: var(--gray); }
        body.dark-theme .activity-item.new-activity { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(239, 68, 68, 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--text-color); }
        body.dark-theme #profileAvatarLarge { background-color: var(--light); color: var(--text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); }
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--light-gray); }
        body.dark-theme .placeholder-content h2 { color: var(--text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--text-color); }
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--text-color); }
        body.dark-theme .settings-subsection h4 { color: #93c5fd; }
        body.dark-theme .setting-item-label { color: var(--text-color); }
        body.dark-theme .setting-item-description { color: var(--gray); }
        body.dark-theme .qr-code-placeholder { border-color: var(--light-gray); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; }
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); }
        body.dark-theme .checkbox-group { border-color: var(--light-gray); }
        body.dark-theme .checkbox-group label { color: var(--text-color); }
        body.dark-theme .confirm-title { color: var(--text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: #93c5fd; }
        body.dark-theme #settingsContent .team-member-card .member-name { color: var(--text-color); }
        body.dark-theme #settingsContent .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--text-color); }
        body.dark-theme .user-name { color: var(--text-color); }
        body.dark-theme .toast { background-color: var(--light); color: var(--text-color); }
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }
        /* Dark Theme: Feature Specific Overrides */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--schedule-table-sticky-header-bg) !important; color: var(--schedule-table-header-text) !important; border-bottom-color: var(--light-gray) !important; border-right-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { border-right: 2px solid var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--text-color); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--schedule-table-employee-sticky-bg); border-right-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; font-style: italic;}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title { background-color: var(--light); color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border);}
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-page-header { background: var(--dashboard-header-bg); }
        body.dark-theme #featureSectionsContainer.task-management-feature .controls { background-color: var(--light); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content #search-input, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .filters select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .search-icon { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card p, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-meta { color: var(--gray); border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-badge { color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); color: #333; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: #3b82f6; color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: var(--success); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal { background-color: rgba(0, 0, 0, 0.7); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn:hover { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content #modal-title { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content label { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="text"], body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="date"], body.dark-theme #featureSectionsContainer.task-management-feature .modal-content textarea, body.dark-theme #featureSectionsContainer.task-management-feature .modal-content select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .form-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section { background-color: var(--feature-team-bg); border-color: var(--feature-team-border-color);}
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section-header { background-color: var(--feature-team-title-bg); color: var(--feature-team-title-text); border-bottom-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"] { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"]::placeholder { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--feature-team-card-bg); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card:hover { border-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-name { color: var(--feature-team-text-primary); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-email { color: var(--feature-team-text-secondary); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: #4b5563; color: #d1d5db;} /* Example adjustment */
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--feature-projects-card-bg); border-left-color: var(--feature-projects-primary-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-controls { background-color: var(--feature-projects-card-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-search-input, body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-projects-input-border); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-card { background-color: var(--feature-projects-card-bg); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--feature-projects-progress-bar-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info i { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); color: var(--feature-projects-text-color); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-actions { border-top-color: var(--feature-projects-border-color); }
        /* Dark theme: File Sharing, Project Tracking, Reports */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card, body.dark-theme #featureSectionsContainer.project-tracking-feature .card, body.dark-theme #featureSectionsContainer.reports-analytics-feature .card { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header, body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section, body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection, body.dark-theme #featureSectionsContainer.file-sharing-feature .table,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card-header, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-filters-section, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card-header, body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section, body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container, body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container, body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table { background-color: var(--light) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .fancy-header-title, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-fancy-title, body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--dashboard-header-bg) !important; color: white !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name, body.dark-theme #featureSectionsContainer.project-tracking-feature .project-name { color: var(--text-color) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .text-muted, body.dark-theme #featureSectionsContainer.project-tracking-feature .text-muted, body.dark-theme #featureSectionsContainer.reports-analytics-feature .text-muted { color: var(--text-muted) !important; } /* Use muted variable */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table thead, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table thead, body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > *, body.dark-theme #featureSectionsContainer.project-tracking-feature .table-hover > tbody > tr:hover > *, body.dark-theme #featureSectionsContainer.reports-analytics-feature .table-hover > tbody > tr:hover > * { background-color: var(--primary-light) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--primary-light) !important; border-color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--light) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--feature-tracking-chart-background) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--feature-reports-chart-background) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { color: var(--text-color) !important; }
        /* Dark theme: Data Management */
         body.dark-theme #featureSectionsContainer.data-management-feature #data-management-section { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-fancy-title { background: var(--dashboard-header-bg) !important; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-toolbar { background-color: transparent; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-search-filter input, body.dark-theme #featureSectionsContainer.data-management-feature .dm-search-filter select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-table { background-color: var(--light); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-table thead th { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-table tbody tr { border-bottom-color: var(--light-gray) !important; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-table tbody tr:hover { background-color: var(--feature-data-management-table-hover); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-row-actions button { color: var(--gray); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-row-actions .dm-view-btn { color: #86efac; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-row-actions .dm-edit-btn { color: #93c5fd; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-row-actions .dm-delete-btn { color: #fca5a5; }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button:hover:not(:disabled) { background-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button:disabled { background-color: var(--primary-light); opacity: 0.6; }
         /* Dark theme: Deadline Tracker */
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .deadline-tracker-container { background-color: var(--app-bg-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .tracker-header { color: var(--text-color); border-bottom-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .tracker-header h1 i { color: var(--primary); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .card { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .card h2 { color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature input, body.dark-theme #featureSectionsContainer.deadline-tracker-feature select, body.dark-theme #featureSectionsContainer.deadline-tracker-feature textarea { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature label { color: var(--text-muted); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .button-secondary { background-color: var(--primary-light); color: var(--text-color); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .button-secondary:hover { background-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .chart-container { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .tasks-display-area { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature #tasks-table thead th { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature #tasks-table tbody tr:hover { background-color: var(--feature-deadline-tracker-table-row-hover-bg); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature td .duration { color: var(--text-muted); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature tr.task-near-due td { background-color: var(--feature-deadline-tracker-highlight-near-due-bg) !important; color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature tr.task-overdue td { background-color: var(--feature-deadline-tracker-highlight-overdue-bg) !important; color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .confirm-modal-overlay { background-color: var(--feature-deadline-tracker-confirm-overlay-bg); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content { background-color: var(--light); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content h3 { color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content p { color: var(--text-muted); }
         /* Dark Theme: Innovation Hub */
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .innovation-hub-container { background-color: var(--app-bg-color); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .hub-header { background: linear-gradient(90deg, var(--feature-innovation-hub-hub-header-bg-start), var(--feature-innovation-hub-hub-header-bg-end)); color: var(--feature-innovation-hub-hub-header-text-color); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .submission-form-container, body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-card, body.dark-theme #featureSectionsContainer.innovation-hub-feature .hub-controls { background-color: var(--light); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature label { color: var(--text-muted); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature select, body.dark-theme #featureSectionsContainer.innovation-hub-feature textarea { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .button-secondary { background-color: var(--primary-light); color: var(--text-color); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .button-secondary:hover { background-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-meta { color: var(--text-muted); border-top-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section { border-top-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .supervisor-reply { background-color: var(--primary-light); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature .admin-controls { border-top-color: var(--light-gray); }
         /* Dark Theme: Team Calendar */
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-page-container { background-color: var(--app-bg-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-header { background-color: var(--light); border-bottom-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .nav-button, body.dark-theme #featureSectionsContainer.team-calendar-feature .icon-button { color: var(--feature-team-calendar-icon-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .nav-button:hover, body.dark-theme #featureSectionsContainer.team-calendar-feature .icon-button:hover { background-color: var(--feature-team-calendar-hover-bg-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .current-month-year { color: var(--feature-team-calendar-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .page-title-container { background-color: var(--light); border-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-main-content { background-color: var(--light); border-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-grid-placeholder { background-color: var(--feature-team-calendar-border-color); border-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-day { background-color: var(--team-calendar-day-bg); color: var(--feature-team-calendar-secondary-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-day.current-month { color: var(--feature-team-calendar-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .calendar-day.today .day-number { background-color: var(--team-calendar-today-marker-bg); color: var(--team-calendar-today-marker-text); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .event .employee-name { opacity: 0.8; color: var(--feature-team-calendar-secondary-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-overlay { background-color: var(--feature-team-calendar-modal-overlay-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-content { background-color: var(--light); color: var(--feature-team-calendar-text-color); border-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-header { border-bottom-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-close-button { color: var(--feature-team-calendar-secondary-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-footer { border-top-color: var(--feature-team-calendar-border-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .form-group label { color: var(--feature-team-calendar-secondary-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .form-group input, body.dark-theme #featureSectionsContainer.team-calendar-feature .form-group select, body.dark-theme #featureSectionsContainer.team-calendar-feature .form-group textarea { background-color: var(--primary-light); border-color: var(--feature-team-calendar-input-border-color); color: var(--feature-team-calendar-text-color); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-button-secondary { background-color: var(--feature-team-calendar-button-secondary-bg); color: var(--feature-team-calendar-button-secondary-text); }
         body.dark-theme #featureSectionsContainer.team-calendar-feature .modal-button-secondary:hover { background-color: var(--feature-team-calendar-button-secondary-hover-bg); }

        /* --- Notifications Modal, Confirm Modal, Utils --- */
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-modal.active { display: flex; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start; cursor: pointer; position: relative; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.08); font-weight: 500; }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        body.dark-theme .notification-icon-wrapper { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa;}
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--text-color); line-height: 1.4; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0; transition: opacity 0.2s; position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem; background: var(--white); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .notification-list-item:hover .delete-notification { opacity: 0.6; }
        .delete-notification:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); }
        body.dark-theme .delete-notification { background: var(--light); }
        body.dark-theme .delete-notification:hover { background: rgba(239, 68, 68, 0.2); }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); flex-wrap: wrap; gap: 0.5rem; }
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-modal.active { display: flex; }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; }
        .d-none { display: none !important; }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s, color 0.3s; }
        .placeholder-content h2 { color: var(--text-color); margin-bottom: 1rem; }
        .placeholder-content p { color: var(--gray); }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; text-align: left; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; max-width: 100%; overflow-wrap: break-word; }

        /* --- Generic Modal Styles (Add/Edit Member, Project, Data, Calendar Event etc.) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--white); width: 100%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); padding: 2rem; max-height: 90vh; overflow-y: auto; animation: zoomIn 0.3s ease-out; color: var(--text-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray); }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        body.dark-theme .modal-title { color: #93c5fd; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1;}
        .close-modal:hover { color: var(--danger); }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- Checkbox Group --- */
         .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: 6px; }
         .checkbox-group label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--text-color); }
         .checkbox-group input[type="checkbox"] { width: auto; margin-right: 0.25rem; }
         .settings-link { color: var(--primary); text-decoration: none; cursor: pointer; }
         .settings-link:hover { text-decoration: underline; color: var(--primary-dark); }

        /* --- Toast --- */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1300; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }

        /* --- Employee Scheduling Table Refinements --- */
        #featureSectionsContainer.employee-scheduling .schedule-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem; }
        #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav { display: flex; align-items: center; gap: 0.75rem; }
        #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions { display: flex; flex-direction: column; gap: 0.5rem; margin-left: auto; }
        #featureSectionsContainer.employee-scheduling .schedule-container { margin-top: 1rem; overflow-x: auto; border: 1px solid var(--light-gray); border-radius: 8px; background-color: var(--white); }
        #featureSectionsContainer.employee-scheduling .schedule-table { width: 100%; min-width: 900px; border-collapse: separate; border-spacing: 0; }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th { padding: 0.8rem 0.75rem; text-align: center; background-color: var(--schedule-table-header-bg); color: var(--schedule-table-header-text); font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark); border-right: 1px solid var(--primary-dark); }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { position: sticky; left: 0; z-index: 11 !important; border-right: 2px solid var(--primary-dark); background-color: var(--schedule-table-sticky-header-bg); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--light-gray); border-right: 1px solid var(--light-gray); vertical-align: middle; transition: background-color 0.2s; color: var(--text-color); white-space: nowrap; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td { background-color: #f9fafb; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td { background-color: var(--schedule-table-hover-bg); }
        #featureSectionsContainer.employee-scheduling .employee-name { font-weight: 600; text-align: left; position: sticky; left: 0; z-index: 5; background-color: var(--schedule-table-employee-sticky-bg); border-right: 2px solid var(--light-gray); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: var(--schedule-table-hover-bg); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        #featureSectionsContainer.employee-scheduling .shift { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; min-width: 70px; border: 1px solid transparent; cursor: default; }
        #featureSectionsContainer.employee-scheduling .shift.editable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #featureSectionsContainer.employee-scheduling .shift.editable:hover { transform: scale(1.05); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent !important; font-style: italic; border: none; cursor: default; font-weight: normal; }
        #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border); }
        #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border); }
        #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border); }
        #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border); }
        #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border); }
        #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border); }
        #featureSectionsContainer.employee-scheduling .day-header { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling .day-name { font-weight: 600; font-size: 0.9rem; color: inherit; }
        #featureSectionsContainer.employee-scheduling .day-date { font-size: 0.8rem; opacity: 0.8; color: inherit; }


        /* --- START: Appearance & Theme Refinements --- */
        #preferencesPanel .theme-options-container { display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap; justify-content: flex-start; margin-bottom: 1.5rem; padding: 0.5rem 0; }
        #preferencesPanel .theme-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 8px; transition: background-color 0.2s, box-shadow 0.2s; min-width: 100px; border: 2px solid transparent; background-color: var(--light); }
        body.dark-theme #preferencesPanel .theme-option { background-color: var(--light); }
        #preferencesPanel .theme-option:hover { background-color: var(--primary-light); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        body.dark-theme #preferencesPanel .theme-option:hover { background-color: var(--light-gray); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #preferencesPanel .theme-option.selected { border-color: var(--primary); background-color: var(--primary-light); }
         body.dark-theme #preferencesPanel .theme-option.selected { background-color: var(--primary-dark); border-color: var(--primary); }
        #preferencesPanel .theme-option .theme-preview { width: 60px; height: 40px; border: 1px solid var(--gray); border-radius: 6px; transition: border-color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 0.75rem; background-color: var(--white); overflow: hidden; }
        #preferencesPanel .theme-option .theme-label { text-align: center; display: block; font-size: 0.9rem; font-weight: 500; color: var(--text-color); }
         body.dark-theme #preferencesPanel .theme-option .theme-label { color: var(--text-color); }
        #preferencesPanel .theme-preview.light-preview { background-color: #f8fafc; color: #1e293b; border-color: var(--light-gray);}
        #preferencesPanel .theme-preview.dark-preview { background-color: #0f172a; color: #e2e8f0; border-color: var(--gray);}
        #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, #f8fafc 50%, #0f172a 50%); color: var(--gray); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview { border-color: var(--light-gray); }
        body.dark-theme #preferencesPanel .theme-preview.light-preview { background: var(--light) !important; color: var(--dark); border-color: var(--light-gray);}
        body.dark-theme #preferencesPanel .theme-preview.dark-preview { background: var(--white) !important; color: var(--dark); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray); border-color: var(--gray);}
        /* --- END: Appearance & Theme Refinements --- */

        /* --- Settings: Danger Zone Refinements --- */
        #dangerPanel { border: 2px solid var(--danger); border-radius: 8px; padding: 1.5rem; background-color: rgba(239, 68, 68, 0.03); }
        #dangerPanel h3 { color: var(--danger); margin-bottom: 0.5rem; }
        #dangerPanel > p { color: var(--gray); margin-bottom: 1.5rem; } /* Target only direct child p */
        .danger-zone-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 1.5rem 0; border-bottom: 1px dashed var(--light-gray); gap: 1rem; }
        .danger-zone-item:last-child { border-bottom: none; padding-bottom: 0; }
        .danger-zone-item div { flex-grow: 1; }
        .danger-zone-item h5 { font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem; }
        .danger-zone-item p { font-size: 0.9rem; color: var(--gray); margin: 0; } /* Reset margin for inner p */
        .danger-zone-item .btn { flex-shrink: 0; }
        body.dark-theme #dangerPanel { background-color: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        body.dark-theme .danger-zone-item h5 { color: var(--text-color); }
        body.dark-theme .danger-zone-item p { color: var(--gray); }
        body.dark-theme .danger-zone-item { border-color: var(--light-gray); }
         /* --- END: Danger Zone Refinements --- */

         /* --- Responsive --- */
         @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); width: 250px; box-shadow: none; }
             .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
             .main-content { margin-left: 0; }
             .search-bar { width: 250px; }
             .main-content.sidebar-active { margin-left: 250px; }
             .sidebar-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
             .top-nav { padding-left: 60px; }
             /* Responsive Features */
             #featureSectionsContainer.task-management-feature .task-management-content .task-list { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
             #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
             #featureSectionsContainer.projects-feature .projects-header { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.projects-feature .projects-title-wrapper { width: auto; }
             #featureSectionsContainer.projects-feature .project-controls { justify-content: flex-start; }
             #featureSectionsContainer.data-management-feature .dm-toolbar { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.data-management-feature .dm-actions { justify-content: flex-start; }
             #featureSectionsContainer.deadline-tracker-feature .tracker-main-content { grid-template-columns: 1fr; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-lg-4, #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-lg-8 { width: 100%; flex: 0 0 100%; max-width: 100%; }
         }
         @media (min-width: 993px) { .sidebar-toggle { display: none; } }
         @media (max-width: 768px) {
             .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; padding-left: 1rem; }
             .search-bar { width: 100%; order: 2; }
             .user-menu { width: 100%; justify-content: space-between; order: 1; }
             .content-area { padding: 1.5rem; }
             .data-form { grid-template-columns: 1fr; }
             .form-actions { grid-column: span 1; }
             .user-info { flex-direction: column; text-align: center; }
             .user-info-avatar { margin-bottom: 1rem; }
             .stats-section { grid-template-columns: 1fr; }
             .settings-tabs { flex-wrap: nowrap; overflow-x: auto; }
             .settings-tab { padding: 0.5rem 1rem; flex-shrink: 0; }
             .confirm-container { width: 90%; }
             #settingsContent .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
             #settingsContent .member-role { margin: 0.5rem 0; }
             #settingsContent .member-actions { margin-top: 0.5rem; width: 100%; justify-content: flex-end; }
             .profile-avatar-section { margin-bottom: 1.5rem; }
             #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
             #featureSectionsContainer.employee-scheduling .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav { justify-content: space-between; width: 100%; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions { margin-left: 0; width: 100%; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions .btn { width: 100%; justify-content: center; }
             #featureSectionsContainer.employee-scheduling .schedule-page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
             #featureSectionsContainer.employee-scheduling .schedule-table { border-spacing: 0; }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th, #featureSectionsContainer.employee-scheduling .schedule-table tbody td { white-space: nowrap; }
             #featureSectionsContainer.employee-scheduling .employee-name { position: sticky !important; left: 0; z-index: 5 !important; border-right: 1px solid var(--feature-projects-border-color); background-color: var(--white); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--light); border-right-color: var(--light-gray); }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { position: sticky !important; left: 0; z-index: 11 !important; background-color: var(--primary); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary-dark); }
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); }
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
             .modal-content { width: 95%; padding: 1.5rem;}
             .notifications-container { width: 100%; max-width: 100%; }
             .sidebar-toggle { top: 10px; left: 10px; }
             .top-nav { padding-top: 60px; }
             /* Responsive Feature Adjustments */
             #featureSectionsContainer.task-management-feature .controls { flex-direction: column; align-items: stretch; gap: 10px; }
             #featureSectionsContainer.task-management-feature .search-container { margin: 0; }
             #featureSectionsContainer.task-management-feature #add-task-btn { width: 100%; margin-left: 0; order: -1; margin-bottom: 10px; }
             #featureSectionsContainer.task-management-feature .filters { flex-direction: column; width: 100%; gap: 10px; }
             #featureSectionsContainer.task-management-feature .filters select { width: 100%; min-width: unset; }
             #featureSectionsContainer.task-management-feature .task-list { grid-template-columns: 1fr; }
             #featureSectionsContainer.task-management-feature .modal-content { width: 95%; padding: 20px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-row { flex-direction: column; gap: 15px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-row > div { min-width: unset; }
             #featureSectionsContainer.task-management-feature .task-page-title { font-size: 1.8em; }
             #featureSectionsContainer.team-members-feature .team-content-area, #featureSectionsContainer.team-members-feature .team-members-section-header { padding-left: 15px; padding-right: 15px; }
             #featureSectionsContainer.team-members-feature .team-members-section-header h2 { font-size: 1.5rem;}
             #featureSectionsContainer.team-members-feature .team-members-section-header { padding-top: 18px; padding-bottom: 18px; }
             #featureSectionsContainer.team-members-feature .team-filter { max-width: none; }
             #featureSectionsContainer.team-members-feature .team-member-card { flex-direction: column; align-items: flex-start; }
             #featureSectionsContainer.projects-feature .projects-list { grid-template-columns: 1fr; gap: 20px; }
             #featureSectionsContainer.projects-feature .project-controls { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.projects-feature .project-search-input, #featureSectionsContainer.projects-feature .project-filter-select, #featureSectionsContainer.projects-feature .add-project-btn { width: 100%; box-sizing: border-box; }
             #featureSectionsContainer.projects-feature .project-card-image { height: 160px; }
             #featureSectionsContainer.projects-feature .project-name { font-size: 1.25em; }
             #featureSectionsContainer.projects-feature .project-actions .btn { padding: 7px 12px; font-size: 0.8em; }
             #preferencesPanel .theme-options-container { justify-content: center; }
             #featureSectionsContainer.file-sharing-feature .filters-section .col-md-1 { text-align: left !important; margin-top: 0.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 150px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination { justify-content: center; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .row > div { margin-bottom: 0.5rem; }
             #featureSectionsContainer.reports-analytics-feature .ra-export-buttons { text-align: left; margin-top: 0.5rem; }
             #featureSectionsContainer.data-management-feature .dm-search-filter input, #featureSectionsContainer.data-management-feature .dm-search-filter select { width: 100%; min-width: unset; }
             #featureSectionsContainer.data-management-feature .dm-actions { width: 100%; justify-content: space-around; }
             #featureSectionsContainer.deadline-tracker-feature #task-form { grid-template-columns: 1fr; }
             #featureSectionsContainer.deadline-tracker-feature #task-form button[type="submit"] { grid-column: 1 / -1; width: 100%; justify-self: stretch; }
             #featureSectionsContainer.deadline-tracker-feature .tracker-controls { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.deadline-tracker-feature .export-buttons { margin-left: 0; margin-top: 1rem; justify-content: flex-start; width: 100%; }
             #featureSectionsContainer.deadline-tracker-feature .export-buttons button { flex-grow: 1; justify-content: center; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls .form-group, #featureSectionsContainer.innovation-hub-feature .hub-controls button { width: 100%; }
             #featureSectionsContainer.innovation-hub-feature .form-row { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.innovation-hub-feature .form-row button { margin-top: 0.5rem; width: 100%; }
             #featureSectionsContainer.innovation-hub-feature #suggestions-list { grid-template-columns: 1fr; }
             #featureSectionsContainer.team-calendar-feature .calendar-header { padding: 0.5rem 1rem; gap: 0.5rem; flex-wrap: wrap; }
             #featureSectionsContainer.team-calendar-feature .current-month-year { font-size: 1.2rem; min-width: auto; margin-right: 0; order: 1; }
             #featureSectionsContainer.team-calendar-feature .nav-button { order: 0; }
             #featureSectionsContainer.team-calendar-feature .add-event-button { order: 2; margin-left: auto; padding: 0.5rem 0.8rem; }
             #featureSectionsContainer.team-calendar-feature #theme-toggle { order: 3; margin-left: 0.25rem; }
         }
         @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
             .user-menu { gap: 1rem; }
             .user-name { display: none; }
             .user-status { margin-left: 0; }
             .notifications-footer { flex-direction: column; gap: 0.5rem; }
             .notifications-footer .btn { width: 100%; justify-content: center; }
             /* Responsive Feature Adjustments Small */
             #featureSectionsContainer.task-management-feature { padding: 10px; }
             #featureSectionsContainer.task-management-feature .task-management-content { padding: 15px; }
             #featureSectionsContainer.task-management-feature .btn { font-size: 0.95em; padding: 9px 15px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-actions .btn { padding: 10px 20px; }
             #featureSectionsContainer.task-management-feature .task-management-content .task-card { padding: 15px; }
             #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { font-size: 1.15em; }
             #featureSectionsContainer.task-management-feature .task-management-content .task-card p, #featureSectionsContainer.task-management-feature .task-management-content .task-card .description, #featureSectionsContainer.task-management-feature .task-management-content .task-meta { font-size: 0.9em; }
             #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { font-size: 1.1em; margin-left: 8px; }
             #featureSectionsContainer.task-management-feature .modal-content { padding: 20px 15px; }
             #featureSectionsContainer.task-management-feature .modal-content #modal-title { font-size: 1.5em; margin-bottom: 20px; }
             #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: 1fr; gap: 15px; }
             #featureSectionsContainer.team-members-feature .team-member-card { padding: 18px; }
             #featureSectionsContainer.team-members-feature .member-name { font-size: 1.1rem; }
             #featureSectionsContainer.team-members-feature .member-email { font-size: 0.85rem; margin-bottom: 12px; }
             #featureSectionsContainer.team-members-feature .member-role { font-size: 0.8rem; padding: 3px 8px; }
             #featureSectionsContainer.projects-feature .project-actions .btn { flex-grow: 1; justify-content: center; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn { padding: 0.3rem 0.7rem; font-size: 0.85rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table tbody td { padding: 0.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-badge, #featureSectionsContainer.project-tracking-feature .pt-table .priority-badge { padding: 3px 8px; font-size: 0.7rem; }
             #featureSectionsContainer.data-management-feature .dm-actions button { font-size: 13px; padding: 10px 8px; }
             #featureSectionsContainer.data-management-feature .dm-actions button i { margin-right: 5px; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-text-display { font-size: 0.95rem; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-card { padding: 1rem; }
             #featureSectionsContainer.team-calendar-feature .calendar-header { flex-wrap: wrap; justify-content: space-between; }
             #featureSectionsContainer.team-calendar-feature .nav-button { padding: 0.4rem; }
             #featureSectionsContainer.team-calendar-feature .current-month-year { font-size: 1.1rem; order: 1; flex-basis: 100%; text-align: center; margin-top: 0.5rem; }
             #featureSectionsContainer.team-calendar-feature .add-event-button span { display: none; }
             #featureSectionsContainer.team-calendar-feature .add-event-button { order: 2; padding: 0.6rem; margin-left: 0; }
             #featureSectionsContainer.team-calendar-feature .add-event-button i { margin: 0; font-size: 1rem; }
             #featureSectionsContainer.team-calendar-feature #theme-toggle { order: 3; margin-left: 0.5rem; font-size: 1rem; padding: 0.4em;}
         }

         /* Table Alignment Fixes */
        table th, table td {
             vertical-align: middle; /* Default vertical alignment */
        }
        table th {
            text-align: left; /* Default horizontal alignment for headers */
        }
        /* Ensure specific feature tables follow the defaults unless overridden */
        #featureSectionsContainer.employee-scheduling .schedule-table thead th,
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td {
            text-align: center; /* Keep center alignment for schedule grid */
        }
        #featureSectionsContainer.employee-scheduling .schedule-table .employee-name {
            text-align: left; /* Left align employee names */
        }
        /* Team Calendar Header Alignment */
        #teamCalendarGrid thead th { /* Assuming this ID is used or adjust selector */
            text-align: left !important; /* Override any centering */
            padding-left: 0.75rem; /* Add some padding */
        }
        /* General Table Margins/Padding Consistency */
        .dm-table-container, .tasks-display-area, .pt-table-container, .ra-table-container,
        #featureSectionsContainer.file-sharing-feature .table-responsive {
             margin: 1.5rem;
        }
        @media (max-width: 768px) {
            .dm-table-container, .tasks-display-area, .pt-table-container, .ra-table-container,
            #featureSectionsContainer.file-sharing-feature .table-responsive {
                 margin: 1rem;
            }
        }


    </style>
</head>
<body class=""> <!-- JS applies theme -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Toast/Success Messages -->
    <div class="toast" id="toastMessage">Toast message</div>
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#dashboard" class="logo" data-feature="dashboard">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </a>
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a> <!-- NEW -->
             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#deadline-tracker" class="menu-item" data-feature="deadline-tracker"><i class="fas fa-calendar-check"></i><span>Deadline Tracker</span></a> <!-- NEW -->
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span> <!-- Styling adjusted in CSS -->
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults"></div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer">
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status"> • Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                      <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light"> <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div> <span class="theme-label">Light</span> </div>
                                 <div class="theme-option" data-theme="dark"> <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div> <span class="theme-label">Dark</span> </div>
                                 <div class="theme-option" data-theme="system"> <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div> <span class="theme-label">System</span> </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div> <span class="setting-item-label">High Contrast Mode</span> <p class="setting-item-description">Increase text visibility for accessibility.</p> </div>
                            <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="highContrastToggle"> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="languageSelect">Language</label> <select id="languageSelect" class="form-control"> <option value="en">English (US)</option> <option value="ar">العربية (Arabic)</option> <option value="es">Español (Spanish)</option> </select> </div>
                             <div class="form-group"> <label for="regionSelect">Region / Timezone</label> <select id="regionSelect" class="form-control"> <option value="utc">UTC</option> <option value="est">EST (UTC-5)</option> <option value="pst">PST (UTC-8)</option> <option value="cet">CET (UTC+1)</option> <option value="eet">EET (UTC+2)</option> <option value="ast">AST (UTC+3) - Riyadh</option> </select> </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="timeFormatSelect">Time Format</label> <select id="timeFormatSelect" class="form-control"> <option value="12h">12-hour (e.g., 3:00 PM)</option> <option value="24h">24-hour (e.g., 15:00)</option> </select> </div>
                              <div class="form-group"> <label for="dateFormatSelect">Date Format</label> <select id="dateFormatSelect" class="form-control"> <option value="MM/DD/YYYY">MM/DD/YYYY</option> <option value="DD/MM/YYYY">DD/MM/YYYY</option> <option value="YYYY-MM-DD">YYYY-MM-DD</option> <option value="Month D, YYYY">Month D, YYYY</option> </select> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Toast Notifications</span> <p class="setting-item-description">Show brief confirmation messages for actions.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="toastToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Sound Notifications</span> <p class="setting-item-description">Play a sound for new notifications and activities.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="soundToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="form-group"> <label for="notificationToneSelect">Notification Tone</label> <select id="notificationToneSelect" class="form-control" disabled> <option value="default">Default</option> <option value="tone1">Tone 1 (Placeholder)</option> <option value="tone2">Tone 2 (Placeholder)</option> </select> <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p> </div>
                         <div class="form-group"> <label class="settings-label">Keyboard Shortcuts</label> <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p> <button class="btn btn-outline btn-sm" disabled>View Shortcuts</button> </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                    <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group"> <label for="accountEmail">Current Email</label> <input type="email" id="accountEmail" class="form-control" value="" readonly> </div>
                             <div class="form-group"> <label for="changeEmail">New Email Address</label> <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <p class="setting-item-description">Changing email requires backend verification.</p> </div>
                             <div class="form-group" style="grid-column: span 2;"> <label for="accountConfirmPassword">Confirm Password (to change email)</label> <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> </div>
                            <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Account Notifications</span> <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="accountNotificationsToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                      <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group"> <label for="currentPassword">Current Password</label> <input type="password" id="currentPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="newPassword">New Password</label> <input type="password" id="newPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="confirmPassword">Confirm New Password</label> <input type="password" id="confirmPassword" class="form-control"> </div>
                             <div class="form-actions"> <button type="submit" class="btn btn-primary">Change Password</button> </div>
                         </form>
                     </div>
                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;"> <span class="status-indicator disabled" id="twoFaStatusIndicator" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; background-color: var(--gray); transition: background-color 0.3s;"></span> <span id="twoFaStatusText" style="font-weight: 500;">2FA is currently Disabled</span> </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>
                         <div id="twoFaSetupSection" style="display: block; margin-top: 1rem;">
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none; margin-top: 1rem;">
                                 <h5 style="margin-bottom: 0.75rem; font-size: 1rem;">Choose Setup Method:</h5>
                                 <div class="two-fa-actions" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;"> <button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button> <button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button> </div>
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;"> <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p> <div class="qr-code-placeholder" style="width: 150px; height: 150px; border: 1px solid var(--light-gray); display: flex; align-items: center; justify-content: center; color: var(--gray); margin: 1rem auto;">QR Placeholder</div> <p>2. Enter the 6-digit code generated by your app below.</p> <div class="form-group" style="max-width: 200px;"> <label for="authCode">Verification Code</label> <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6"> </div> <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> </div>
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;"> <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p> <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button> <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup"> <label for="smsCode">SMS Verification Code</label> <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6" style="max-width: 200px;"> </div> <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button> </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none; margin-top: 1rem;"> <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p> <div class="two-fa-actions" style="display: flex; gap: 1rem;"> <button class="btn btn-outline" disabled>View Recovery Codes</button> <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"> <label for="sessionDuration">Session Duration (minutes)</label> <input type="number" id="sessionDuration" class="form-control" value="60" min="15"> <p class="setting-item-description">Set how long a login session remains active.</p> </div>
                            <div class="form-group"> <label for="idleTimeout">Idle Timeout (minutes)</label> <input type="number" id="idleTimeout" class="form-control" value="15" min="5"> <p class="setting-item-description">Automatically logout after inactivity.</p> </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> </div>
                     </div>
                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Email Notifications</span> <p class="setting-item-description">Receive summaries and important alerts via email.</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="emailNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable In-App Notifications</span> <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="inAppNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span> <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="pushNotificationsToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group"> <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label> <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label> <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label> <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label> <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label> <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <div class="form-group"> <label for="notificationPriority">Minimum Notification Priority</label> <select id="notificationPriority" class="form-control" disabled> <option value="low">Low</option> <option value="medium">Medium</option> <option value="high">High</option> </select> <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p> </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> </div>
                 </div>

                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                      <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <div class="team-list" id="teamList"> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                             <!-- Admin Action: Delete All -->
                             <div class="mt-4 pt-3 border-top" id="deleteAllUsersSection" style="display: none;"> <!-- Initially hidden -->
                                 <h5 class="text-danger">Bulk Actions</h5>
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div>
                                         <p class="mb-0">Delete all non-administrator users.</p>
                                         <small class="text-muted">This action cannot be undone.</small>
                                     </div>
                                     <button class="btn btn-danger" id="deleteAllNonAdminUsersBtn"> <i class="fas fa-users-slash"></i> Delete Non-Admins </button>
                                 </div>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                      <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;"> <button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Connect Slack</button> <button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button> <button class="btn btn-outline" disabled><i class="fab fa-github"></i> Connect GitHub</button> </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item"> <div> <span class="setting-item-label">Allow External Sharing Links</span> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="externalSharingToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                         <button class="btn btn-outline" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline" disabled>Set Default Permissions</button>
                     </div>
                 </div>


                 <!-- Danger Zone Panel (Refined) -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger); margin-bottom: 0.5rem;">Danger Zone</h3>
                     <p style="color: var(--gray); margin-bottom: 1.5rem;">These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p>This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Delete Account</h5>
                            <p>Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for other feature sections -->
             <div id="featureSectionsContainer" class="content-section">
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications">×</button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button>
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="memberModalTitle">Member Details</h3> <button class="close-modal" data-close-modal>×</button> </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group"> <label for="memberFirstName">First Name</label> <input type="text" id="memberFirstName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberLastName">Last Name</label> <input type="text" id="memberLastName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberEmail">Email</label> <input type="email" id="memberEmail" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberRole">Role</label> <select id="memberRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                      <div class="form-group"> <label for="memberTitle">Job Title</label> <input type="text" id="memberTitle" class="form-control"> </div>
                      <div class="form-group"> <label for="memberDepartment">Department</label> <input type="text" id="memberDepartment" class="form-control"> </div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button> </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="projectModalTitle">Project Details</h3> <button class="close-modal" data-close-modal>×</button> </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;">
                    <div class="form-group"> <label for="projectName">Project Name</label> <input type="text" id="projectName" class="form-control" required> </div>
                    <div class="form-group"> <label for="projectDescription">Description</label> <textarea id="projectDescription" class="form-control" rows="3"></textarea> </div>
                     <div class="form-group"> <label for="projectParticipantsInput">Participants (Separate with | )</label> <input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S."> </div>
                    <div class="form-group"> <label for="projectImageInput">Image URL (Optional)</label> <input type="url" id="projectImageInput" class="form-control" placeholder="https://..."> </div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                         <div class="form-group"> <label for="projectStartDate">Start Date</label> <input type="date" id="projectStartDate" class="form-control"> </div>
                        <div class="form-group"> <label for="projectDueDate">Due Date</label> <input type="date" id="projectDueDate" class="form-control"> </div>
                         <div class="form-group"> <label for="projectStatus">Status</label> <select id="projectStatus" class="form-control" required> <option value="pending">Pending</option> <option value="active">Active</option> <option value="in-progress">In Progress</option> <option value="completed">Completed</option> </select> </div>
                        <div class="form-group"> <label for="projectProgress">Progress (%)</label> <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0"> </div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button> </div>
            </form>
        </div>
    </div>


    <!-- ========= Feature Templates ========= -->

    <!-- Template for Task Management -->
    <template id="taskManagementAssets">
        <style id="injected-task-management-styles">
            /* Scoped Styles for Task Management */
            #featureSectionsContainer.task-management-feature .task-management-content {
                 /* This container now uses the base .content-section padding via JS */
                 background-color: var(--white); /* Card background */
                 border-radius: 8px;
                 box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                 border: 1px solid var(--light-gray);
             }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content {
                  background-color: var(--light);
                  border-color: var(--light-gray);
              }

            #featureSectionsContainer.task-management-feature .task-page-header {
                 padding: 1.5rem;
                 background: var(--dashboard-header-bg); /* Use dashboard gradient */
                 color: white;
                 border-radius: 8px 8px 0 0; /* Match card style */
                 margin-bottom: 0;
                 text-align: center;
            }
            #featureSectionsContainer.task-management-feature .task-page-title {
                 font-size: 1.5rem; font-weight: 600; margin: 0;
            }
             #featureSectionsContainer.task-management-feature .controls {
                 padding: 1.5rem; background-color: transparent; border-bottom: 1px solid var(--light-gray);
             }
             #featureSectionsContainer.task-management-feature .task-list {
                 padding: 1.5rem; background-color: transparent; /* List area background is handled by parent card */
                 display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;
             }
            #featureSectionsContainer.task-management-feature .task-card {
                background-color: var(--white); border: 1px solid var(--light-gray); border-left-width: 5px; border-radius: 6px; padding: 1.25rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: box-shadow 0.3s ease, transform 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; position: relative;
            }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-card {
                 background-color: var(--light); border-color: var(--light-gray);
            }
             #featureSectionsContainer.task-management-feature .task-card h3 {
                 font-size: 1.15em; margin-bottom: 0.5rem; color: var(--primary-dark); word-break: break-word;
             }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card h3 {
                  color: #93c5fd;
              }
             #featureSectionsContainer.task-management-feature .task-card .description {
                 color: var(--text-muted); font-size: 0.85em; margin-bottom: 1rem; max-height: 60px; overflow-y: auto;
             }
             #featureSectionsContainer.task-management-feature .task-meta {
                 font-size: 0.8em; color: var(--text-muted); margin-top: 1rem; border-top: 1px solid var(--light-gray); padding-top: 1rem;
             }
             #featureSectionsContainer.task-management-feature .status-badge {
                 padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; color: white; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle;
             }
             #featureSectionsContainer.task-management-feature .task-card.status-Completed {
                 background-color: var(--light); border-left-color: var(--gray); opacity: 0.8;
             }
             body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed {
                  background-color: var(--primary-light); border-left-color: var(--gray);
             }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed h3, body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed p, body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed .description, body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed .task-meta, body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed strong { color: var(--text-muted); }

             #featureSectionsContainer.task-management-feature .task-actions {
                 margin-top: 1rem; text-align: right; border-top: 1px solid var(--light-gray); padding-top: 1rem;
             }
             #featureSectionsContainer.task-management-feature .task-actions button {
                 background: none; border: none; font-size: 1.1em; padding: 5px; margin-left: 8px; vertical-align: middle; color: var(--text-muted); cursor: pointer; transition: color 0.2s ease, transform 0.2s ease;
             }
             #featureSectionsContainer.task-management-feature .task-actions button:hover { transform: scale(1.1); }
             #featureSectionsContainer.task-management-feature .task-actions .edit-btn:hover { color: var(--primary); }
             #featureSectionsContainer.task-management-feature .task-actions .delete-btn { color: var(--danger); }
             #featureSectionsContainer.task-management-feature .task-actions .complete-btn { color: var(--success); }
             #featureSectionsContainer.task-management-feature .task-actions .reopen-btn { color: var(--warning); }
        </style>
        <!-- Task Management Content Area (Wrapped in a div for styling) -->
        <div class="task-management-content"> <!-- Main container for this feature -->
            <div class="task-page-header">
                <h1 class="task-page-title">Task Management</h1>
            </div>
            <div class="controls d-flex flex-wrap align-items-center gap-2">
                <div class="search-container flex-grow-1 me-md-3 position-relative">
                    <i class="fas fa-search search-icon position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                    <input type="text" id="search-input" class="form-control form-control-sm ps-5" placeholder="Search tasks by name, description, assignee...">
                </div>
                <div class="filters d-flex flex-wrap gap-2">
                    <select id="filter-status" class="form-select form-select-sm" style="min-width: 130px;">
                        <option value="all" selected>All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <select id="filter-priority" class="form-select form-select-sm" style="min-width: 120px;">
                        <option value="all" selected>All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                     <select id="filter-assigned-to" class="form-select form-select-sm" style="min-width: 150px;">
                        <option value="all" selected>All Assignees</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <button id="add-task-btn" class="btn btn-primary btn-sm ms-md-auto">
                    <i class="fas fa-plus-circle me-1"></i> Add Task
                </button>
            </div>
            <div class="task-list mt-4" id="task-list">
                <!-- Task cards will be rendered here -->
                 <p class="no-tasks" style="grid-column: 1 / -1;">Loading tasks...</p>
            </div>
        </div>
        <!-- Task Management Modal (uses generic modal styles) -->
        <div class="modal" id="task-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="task-modal-title">Add New Task</h3> <!-- Changed ID -->
                    <button type="button" class="close-btn close-modal" data-close-modal>&times;</button>
                </div>
                <form id="task-modal-form"> <!-- Changed ID -->
                    <input type="hidden" id="task-id">
                    <div class="form-group">
                        <label for="task-name">Task Name</label>
                        <input type="text" id="task-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Description</label>
                        <textarea id="task-description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="task-links">Relevant Links (comma-separated)</label>
                        <input type="text" id="task-links" class="form-control">
                    </div>
                    <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="task-assigned-by">Assigned By</label>
                            <select id="task-assigned-by" class="form-select">
                                <option value="Self Assigned">Self Assigned</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="task-assigned-to">Assigned To</label>
                            <select id="task-assigned-to" class="form-select">
                                <option value="">-- Select Assignee --</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
                     <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="task-start-date">Start Date</label>
                            <input type="date" id="task-start-date" class="form-control">
                        </div>
                        <div>
                            <label for="task-due-date">Due Date</label>
                            <input type="date" id="task-due-date" class="form-control">
                        </div>
                    </div>
                    <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                         <div>
                            <label for="task-priority">Priority</label>
                            <select id="task-priority" class="form-select" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div>
                            <label for="task-status">Status</label>
                            <select id="task-status" class="form-select" required>
                                <option value="Pending" selected>Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <!-- Use data-close-modal -->
                        <button type="submit" class="btn btn-primary" id="save-task-btn">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
        <script>
            function initializeTaskManagementFeature(container) {
                console.log("Initializing Task Management Feature..."); // Debug log
                const taskContentContainer = container.querySelector('.task-management-content'); // Use the inner container
                if (!taskContentContainer) { console.error("Task Management content container not found!"); return { cleanup: () => {} }; }

                 // --- DOM Elements (scoped to container/modal) ---
                const addTaskBtn = taskContentContainer.querySelector('#add-task-btn');
                const taskModal = document.getElementById('task-modal'); // Modal is outside the feature container
                const taskForm = taskModal?.querySelector('#task-modal-form');
                const taskListDiv = taskContentContainer.querySelector('#task-list');
                const modalTitle = taskModal?.querySelector('#task-modal-title');
                const saveTaskBtn = taskModal?.querySelector('#save-task-btn');
                const taskIdInput = taskModal?.querySelector('#task-id');
                const taskNameInput = taskModal?.querySelector('#task-name');
                const taskDescriptionInput = taskModal?.querySelector('#task-description');
                const taskLinksInput = taskModal?.querySelector('#task-links');
                const taskAssignedBySelect = taskModal?.querySelector('#task-assigned-by');
                const taskAssignedToSelect = taskModal?.querySelector('#task-assigned-to');
                const taskStartDateInput = taskModal?.querySelector('#task-start-date');
                const taskDueDateInput = taskModal?.querySelector('#task-due-date');
                const taskPrioritySelect = taskModal?.querySelector('#task-priority');
                const taskStatusSelect = taskModal?.querySelector('#task-status');
                const searchInput = taskContentContainer.querySelector('#search-input');
                const filterStatusSelect = taskContentContainer.querySelector('#filter-status');
                const filterPrioritySelect = taskContentContainer.querySelector('#filter-priority');
                const filterAssignedToSelect = taskContentContainer.querySelector('#filter-assigned-to');

                if (!addTaskBtn || !taskModal || !taskListDiv || !taskForm || !modalTitle || !saveTaskBtn || !taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect || !searchInput || !filterStatusSelect || !filterPrioritySelect || !filterAssignedToSelect) {
                    console.error("Essential Task Management elements missing in container or modal.");
                    if(taskListDiv) taskListDiv.innerHTML = '<p class="no-tasks" style="grid-column: 1 / -1;">Error loading task components.</p>';
                    return { cleanup: () => {} };
                 }

                let tasks = []; let boundCloseOnEscape = null; let boundCloseOnOutsideClick = null; let listeners = []; // Store listeners for cleanup

                const addListener = (element, event, handler) => { if (!element) return; element.addEventListener(event, handler); listeners.push({ element, event, handler }); };
                const loadTasks = () => { const storedTasks = localStorage.getItem('dashboard_tasks'); if (storedTasks) { try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); } } else { tasks = getDefaultTasks(); } populateAssigneeFilters(); renderTasks(); }; // Populate filters after loading
                function getDefaultTasks() { return [ { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure.", links: "https://nodejs.org", assignedBy: "Nada Mahmoud", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null }, { id: 2, name: "Design UI Mockups", description: "Create mockups for main pages using Figma.", links: "https://figma.com", assignedBy: "Yousef Ahmed", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs.", links: "", assignedBy: "Self Assigned", assignedTo: "Yousef Ahmed", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides.", links: "", assignedBy: "Nada Mahmoud", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null }, { id: 5, name: "Review Code Submission", description: "Review 'feature/login' branch.", links: "https://github.com, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" }, { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Special characters issue.", links: "jira-123", assignedBy: "Yousef Ahmed", assignedTo: "Yousef Ahmed", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } ]; }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };
                const formatDate = (dateString) => window.formatDateForDisplay(dateString); // Use global function
                const getCurrentDate = () => new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T23:59:59Z'); const today = new Date(); if (isNaN(dueDate.getTime())) return false; return dueDate < today; } catch(e) { console.error("Error checking overdue:", e); return false; } };
                const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }; // Basic escaping

                function populateAssigneeFilters() {
                    const assignees = [...new Set(window.MOCK_USERS.map(u => u.name))]; // Get from global
                    const assignedBy = [...new Set(tasks.map(t => t.assignedBy || 'Self Assigned'))];

                    // Populate Filter Dropdown
                    filterAssignedToSelect.innerHTML = '<option value="all" selected>All Assignees</option>';
                    assignees.forEach(name => filterAssignedToSelect.appendChild(new Option(name, name)));

                    // Populate Modal Dropdowns
                    taskAssignedBySelect.innerHTML = '<option value="Self Assigned">Self Assigned</option>';
                    assignedBy.filter(n => n !== 'Self Assigned').forEach(name => taskAssignedBySelect.appendChild(new Option(name, name)));

                    taskAssignedToSelect.innerHTML = '<option value="">-- Select Assignee --</option>';
                    assignees.forEach(name => taskAssignedToSelect.appendChild(new Option(name, name)));
                }

                const renderTasks = () => {
                    if (!taskListDiv) return;
                    taskListDiv.innerHTML = '';
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const statusFilter = filterStatusSelect ? filterStatusSelect.value : 'all';
                    const priorityFilter = filterPrioritySelect ? filterPrioritySelect.value : 'all';
                    const assignedToFilter = filterAssignedToSelect ? filterAssignedToSelect.value : 'all';

                    let tasksToDisplay = tasks.filter(task => {
                         const taskStatus = task.status || ''; const taskPriority = task.priority || ''; const taskAssignedTo = task.assignedTo || '';
                         const statusMatch = statusFilter === 'all' || taskStatus === statusFilter;
                         const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter;
                         const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter;
                         const searchMatch = !searchTerm || (task.name || '').toLowerCase().includes(searchTerm) || (task.description || '').toLowerCase().includes(searchTerm) || (task.links || '').toLowerCase().includes(searchTerm) || (task.assignedTo || '').toLowerCase().includes(searchTerm) || (task.assignedBy || '').toLowerCase().includes(searchTerm);
                         return statusMatch && priorityMatch && assignedToMatch && searchMatch;
                    });

                     if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks" style="grid-column: 1 / -1;">No tasks found matching your criteria.</p>'; return; }
                    tasksToDisplay.sort((a, b) => { const statusOrder={"Pending":1,"In Progress":1,"Completed":2}; const ```javascript
dateA=a.dueDate?new Date(a.dueDate+'T00:00:00Z'):null; const dateB=b.dueDate?new Date(b.dueDate+'T00:00:00Z'):null; const
                         dateValA=dateA&&!isNaN(dateA)?dateA.getTime():Infinity; const dateValB=dateB&&!isNaN(dateB)?dateB.getTime():Infinity; if(dateValA!==dateValB)return dateValA-dateValB; const priorityOrder={High:3,Medium:2,Low:1}; const priorityA=priorityOrder[a.priority]||0; const priorityB=priorityOrder[b.priority]||0; return priorityB-priorityA; });

                    tasksToDisplay.forEach(task => {
                        const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue');
                        const overdue = isOverdue(task); const overdueText = overdue ? `<span class="text-danger overdue-indicator">(Overdue!)</span>` : ''; // Added text-danger
                        let linksHTML = 'N/A'; if (task.links && task.links.trim()) { linksHTML=task.links.split(',').map(l=>l.trim()).filter(l=>l).map(link=>{let href=link;let isUrl=false;try{const url=new URL(link.startsWith('http')?link:`http://${link}`);if(url.hostname&&(url.hostname.includes('.')||url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))){isUrl=true;href=url.protocol+"//"+url.hostname+url.pathname+url.search+url.hash;}else{href=link;}}catch(_){isUrl=false;href=link;}const displayText=link.length>35?link.substring(0,32)+'...':link;return isUrl?`<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}" class="text-primary">${escapeHTML(displayText)}</a>`:`<span title="${link}" class="text-muted">${escapeHTML(displayText)}</span>`;}).join(' ');}

                        taskCard.innerHTML = `
                            <h3>${escapeHTML(task.name || 'Unnamed')}</h3>
                            ${task.description ? `<p class="description">${escapeHTML(task.description)}</p>` : ''}
                             <div class="task-meta">
                                 <div><span><strong>To:</strong> ${escapeHTML(task.assignedTo || 'N/A')}</span> <span class="ms-3"><strong>By:</strong> ${escapeHTML(task.assignedBy || 'N/A')}</span></div> <!-- Added ms-3 -->
                                <div> <span><strong>Start:</strong> ${formatDate(task.startDate)}</span> <span class="ms-3"><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span> </div> <!-- Added ms-3 -->
                                <div> <span><strong>Priority:</strong> ${escapeHTML(task.priority || 'N/A')}</span> <span class="ms-3"><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${escapeHTML(task.status || 'N/A')}</span></span> </div> <!-- Added ms-3 -->
                                ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''}
                                <div><strong>Links:</strong> <span class="links">${linksHTML}</span></div>
                             </div>
                            <div class="task-actions">
                                <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                                ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`}
                            </div>`;

                        const editBtn = taskCard.querySelector('.edit-btn'); if (editBtn) { addListener(editBtn, 'click', (e) => { e.stopPropagation(); openEditModal(task.id); }); }
                        const deleteBtn = taskCard.querySelector('.delete-btn'); if (deleteBtn) { addListener(deleteBtn, 'click', (e) => { e.stopPropagation(); deleteTask(task.id); }); }
                        const completeOrReopenBtn = taskCard.querySelector('.complete-btn, .reopen-btn'); if (completeOrReopenBtn) { addListener(completeOrReopenBtn, 'click', (e) => { e.stopPropagation(); toggleTaskStatus(task.id); }); }
                        taskListDiv.appendChild(taskCard);
                    });
                };

                const showModal = () => { if (!taskModal) return; taskModal.classList.add('active'); document.body.style.overflow = 'hidden'; };
                const hideModal = () => { if (!taskModal) return; taskModal.classList.remove('active'); if (taskForm) taskForm.reset(); if (taskIdInput) taskIdInput.value = ''; if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; document.body.style.overflow = ''; };
                const openAddModal = () => { hideModal(); if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; if (taskStatusSelect) taskStatusSelect.value = "Pending"; if (taskPrioritySelect) taskPrioritySelect.value = "Medium"; if (taskAssignedBySelect) taskAssignedBySelect.value = "Self Assigned"; if (taskAssignedToSelect) taskAssignedToSelect.value = ""; showModal(); if (taskNameInput) taskNameInput.focus(); };
                const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task) return; hideModal(); if (modalTitle) modalTitle.textContent = "Edit Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Update Task"; taskIdInput.value = task.id; taskNameInput.value = task.name; taskDescriptionInput.value = task.description || ''; taskLinksInput.value = task.links || ''; taskAssignedBySelect.value = task.assignedBy || ''; taskAssignedToSelect.value = task.assignedTo || ''; taskStartDateInput.value = task.startDate || ''; taskDueDateInput.value = task.dueDate || ''; taskPrioritySelect.value = task.priority || 'Medium'; taskStatusSelect.value = task.status || 'Pending'; showModal(); taskNameInput.focus(); };
                const handleFormSubmit = (event) => { event.preventDefault();const taskId=taskIdInput.value?parseInt(taskIdInput.value):Date.now();const currentTask=tasks.find(t=>t.id===taskId);const newStatus=taskStatusSelect.value;let completionDate=currentTask?.completionDate||null;if(newStatus==='Completed'){if(!taskIdInput.value||(currentTask&&currentTask.status!=='Completed')){completionDate=getCurrentDate();}}else{completionDate=null;}const startDate=taskStartDateInput.value;const dueDate=taskDueDateInput.value;if(startDate&&dueDate&&new Date(dueDate)<new Date(startDate)){window.showToast("Due Date cannot be before Start Date.", "error");taskDueDateInput.focus();return;}const taskData={id:taskId,name:taskNameInput.value.trim(),description:taskDescriptionInput.value.trim(),links:taskLinksInput.value.trim(),assignedBy:taskAssignedBySelect.value,assignedTo:taskAssignedToSelect.value,startDate:startDate||null,dueDate:dueDate||null,priority:taskPrioritySelect.value,status:newStatus,completionDate:completionDate};if(!taskData.name){window.showToast("Task Name is required.", "error");taskNameInput.focus();return;}if(!taskData.assignedTo){window.showToast("Please select an assignee.", "error");taskAssignedToSelect.focus();return;}if(taskIdInput.value){const index=tasks.findIndex(task=>task.id===taskData.id);if(index>-1){tasks[index]=taskData;}else{console.warn(`Task ${taskData.id} not found for edit.`);tasks.push(taskData);}}else{tasks.push(taskData);}saveTasks();renderTasks();hideModal(); };
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); window.showConfirmModal(`Delete Task`, `Are you sure you want to delete "${escapeHTML(taskToDelete?.name || 'this task')}"?`, () => { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); window.showToast('Task deleted.', 'success'); }, 'btn-danger'); }; // Use global confirm
                const toggleTaskStatus = (id) => { tasks = tasks.map(task => { if (task.id === id) { if (task.status === 'Completed') { return { ...task, status: 'Pending', completionDate: null }; } else { return { ...task, status: 'Completed', completionDate: getCurrentDate() }; } } return task; }); saveTasks(); renderTasks(); window.showToast('Task status updated.', 'success'); }; // Use global toast

                addListener(addTaskBtn, 'click', openAddModal);
                // Add listeners for modal close handled by main script's generic modal logic
                addListener(taskForm, 'submit', handleFormSubmit);
                addListener(searchInput, 'input', renderTasks);
                addListener(filterStatusSelect, 'change', renderTasks);
                addListener(filterPrioritySelect, 'change', renderTasks);
                addListener(filterAssignedToSelect, 'change', renderTasks);

                loadTasks();

                const cleanup = () => {
                    console.log("Cleaning Task Management...");
                     listeners.forEach(({ element, event, handler }) => { element?.removeEventListener(event, handler); }); listeners = [];
                    taskModal?.classList.remove('active'); // Hide modal on cleanup
                    document.body.style.overflow = ''; // Ensure body scroll is restored
                    console.log("Task Management cleanup complete.");
                };
                return { cleanup };
            }
        </script>
    </template>

    <!-- Template for File Sharing -->
    <template id="fileSharingAssets">
        <style id="injected-file-sharing-styles">
            /* Scoped variables using feature class */
            #featureSectionsContainer.file-sharing-feature {
                 --app-primary: var(--feature-filesharing-primary); --app-secondary: var(--feature-filesharing-secondary); --app-success: var(--feature-filesharing-success); --app-danger: var(--feature-filesharing-danger); --app-warning: var(--feature-filesharing-warning); --app-info: var(--feature-filesharing-info); --app-light: var(--feature-filesharing-light); --app-dark: var(--feature-filesharing-dark); --app-hover-bg: var(--feature-filesharing-hover-bg); --app-header-bg: var(--feature-filesharing-header-bg);
            }
            #featureSectionsContainer.file-sharing-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.file-sharing-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
             #featureSectionsContainer.file-sharing-feature .card { border: none; border-radius: 0; margin-bottom: 0; box-shadow: none; background-color: transparent; }
             #featureSectionsContainer.file-sharing-feature .card-header { background-color: var(--app-light); border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
            #featureSectionsContainer.file-sharing-feature .fancy-header-title { background: var(--app-header-bg); color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.0rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease; margin-bottom: 0; }
             #featureSectionsContainer.file-sharing-feature .fancy-header-title:hover { transform: scale(1.02); }
             #featureSectionsContainer.file-sharing-feature .card-header .d-flex { align-items: center; }
             #featureSectionsContainer.file-sharing-feature .card-body { padding: 1.5rem; } /* Standard padding */
             body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header { background-color: var(--light); border-bottom-color: var(--light-gray); }
             #featureSectionsContainer.file-sharing-feature .file-icon { font-size: 1.6rem; vertical-align: middle; margin-right: 10px; width: 25px; text-align: center; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-danger { color: var(--app-danger) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-success { color: var(--app-success) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-warning { color: var(--app-warning) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-primary { color: var(--app-primary) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-info { color: var(--app-info) !important; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn { margin: 0 3px; transition: all 0.2s ease-in-out; border-radius: 50px; padding: 0.25rem 0.6rem; font-size: 0.8rem; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
             #featureSectionsContainer.file-sharing-feature .action-btn .loading-spinner { display: none; margin: 0 2px; }
             #featureSectionsContainer.file-sharing-feature .action-btn.loading .original-icon { display: none; }
             #featureSectionsContainer.file-sharing-feature .action-btn.loading .loading-spinner { display: inline-block; }
             #featureSectionsContainer.file-sharing-feature .filters-section { background-color: var(--white); padding: 1rem 1.25rem; border-radius: 0.375rem; border: 1px solid var(--light-gray); margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.file-sharing-feature .filters-section .form-label { font-size: 0.8rem; color: var(--app-secondary); margin-bottom: 0.25rem; }
             #featureSectionsContainer.file-sharing-feature .filters-section .form-control-sm, #featureSectionsContainer.file-sharing-feature .filters-section .form-select-sm { font-size: 0.875rem; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection { background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0.375rem; padding: 1rem 1.25rem; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 { color: var(--app-primary); margin-bottom: 10px; font-weight: 600; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom: 1px dashed #eee !important; padding: 8px 0 !important; background-color: transparent !important; border-top: none !important; border-left: none !important; border-right: none !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom-color: var(--light-gray) !important; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item:last-child { border-bottom: 0 !important; }
             #featureSectionsContainer.file-sharing-feature .time-ago { font-style: normal; font-size: 0.85em; color: var(--app-secondary); }
             #featureSectionsContainer.file-sharing-feature .table { margin-bottom: 0; background-color: transparent; } /* Table bg handled by card body */
             #featureSectionsContainer.file-sharing-feature .table thead { background-color: var(--app-light) !important; color: var(--app-secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table thead { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
             #featureSectionsContainer.file-sharing-feature .table tbody tr td { vertical-align: middle; padding: 0.85rem 0.75rem; }
             #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--app-hover-bg) !important; cursor: default; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--primary-light) !important; }
             #featureSectionsContainer.file-sharing-feature .file-name { font-weight: 500; color: var(--app-dark); }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name { color: var(--text-color); }
             #featureSectionsContainer.file-sharing-feature .badge { font-size: 0.75em; padding: 0.35em 0.6em; font-weight: 500; }
             #featureSectionsContainer.file-sharing-feature .upload-area { border: 2px dashed var(--app-primary); padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background-color: var(--app-light); border-radius: 8px; transition: background-color 0.2s ease, border-color 0.2s ease; }
             #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--app-hover-bg); border-color: lighten(var(--app-primary), 10%); }
             #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--app-primary); }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--primary-light) !important; border-color: var(--primary) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--light) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-success { background-color: var(--app-success) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-danger { background-color: var(--app-danger) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar { background-color: var(--app-primary); }
             /* SweetAlert uses dashboard variables now */
             .swal2-confirm { background-color: var(--success) !important; }
             .swal2-cancel { background-color: var(--danger) !important; }
             .swal2-popup { font-size: 0.9rem !important; }
             body.dark-theme .swal2-popup { background-color: var(--light) !important; color: var(--text-color) !important; }
             body.dark-theme .swal2-title { color: var(--text-color) !important; }
             body.dark-theme .swal2-html-container { color: var(--text-muted) !important; }
        </style>
        <div class="card shadow-sm"> <!-- Wrapper card for consistent styling -->
            <div class="card-header">
                 <h5 class="fancy-header-title mb-0"><i class="fas fa-folder-open me-2"></i>File Management</h5> <!-- Added mb-0 -->
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                    <i class="fas fa-upload me-1"></i> Upload New File
                </button>
            </div>
            <div class="card-body pt-3">
                 <!-- Filters Section -->
                 <div class="row filters-section gy-2 align-items-end">
                     <div class="col-md-4">
                          <label for="fileSearchInput" class="form-label">Search by Name</label>
                         <div class="input-group input-group-sm search-input">
                             <input type="text" class="form-control form-control-sm" placeholder="Enter file name..." id="fileSearchInput">
                              <span class="input-group-text"><i class="fas fa-search"></i></span>
                         </div>
                     </div>
                     <div class="col-md-2">
                          <label for="fileTypeFilter" class="form-label">File Type</label>
                          <select class="form-select form-select-sm" id="fileTypeFilter" title="Filter by Type">
                             <option value="" selected>All Types</option>
                             <option value="PDF">PDF</option> <option value="Image">Image</option> <option value="Video">Video</option> <option value="Archive">Archive</option> <option value="Document">Document</option> <option value="Spreadsheet">Spreadsheet</option>
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="uploadDateFilter" class="form-label">Upload Date</label>
                         <input type="date" class="form-control form-control-sm" id="uploadDateFilter" title="Filter by Upload Date">
                     </div>
                     <div class="col-md-2" id="userFilterContainer" style="display: none;">
                         <label for="userFilter" class="form-label">Uploader</label>
                          <select class="form-select form-select-sm" id="userFilter" title="Filter by Uploader">
                             <option value="" selected>All Users</option>
                             <!-- Options populated by JS -->
                         </select>
                     </div>
                      <div class="col-md-1 text-end">
                         <button class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt"></i> </button>
                      </div>
                 </div>
                 <!-- Recent Uploads Section -->
                 <div class="mb-4 p-3" id="recentUploadsSection">
                     <h6><i class="fas fa-history me-1"></i> Recent Uploads</h6>
                     <ul class="list-group list-group-flush">
                         <!-- Placeholder / populated by JS -->
                         <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 5 * 60 * 1000).toISOString()}"> <div><i class="fas fa-file-pdf file-icon text-danger"></i> Placeholder_Report_Q1.pdf</div> <small class="text-muted time-ago">calculating...</small> </li>
                    </ul>
                </div>

            <!-- Files Table -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 5%;">Type</th>
                            <th scope="col" style="width: 30%;">File Name</th>
                            <th scope="col" style="width: 18%;">Upload Date</th>
                            <th scope="col" style="width: 17%;">Tags</th>
                            <th scope="col" style="width: 15%;">Uploader</th>
                            <th scope="col" class="text-center" style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody">
                        <!-- Rows populated by JS -->
                        <tr> <td colspan="6" class="text-center p-4 text-muted"> <div class="spinner-border spinner-border-sm text-primary me-2" role="status"> <span class="visually-hidden">Loading...</span> </div> Loading files... </td> </tr>
                        <tr id="noResultsRow" style="display: none;">
                             <td colspan="6" class="text-center text-muted fst-italic py-4">No files found matching your criteria.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination (Optional) -->
            <nav aria-label="File list navigation" class="mt-3 d-flex justify-content-center">
                 <!-- <ul class="pagination pagination-sm"> --> <!-- Pagination items here --> <!-- </ul> -->
            </nav>
            </div> <!-- End card-body -->
        </div> <!-- End card -->

         <!-- Bootstrap Modals for File Sharing -->
         <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="uploadFileModalLabel"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New File</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="upload-area" id="dropZone"> <p><i class="fas fa-cloud-upload-alt fa-3x mb-2"></i></p> <p>Drag & drop files here or click to select</p> <input type="file" id="fileInputHidden" multiple hidden> </div> <div class="mb-3"> <label for="fileInputManual" class="form-label">Or select file(s):</label> <input class="form-control form-control-sm" type="file" id="fileInputManual" multiple> </div> <div class="mb-3"> <label for="fileTagsInput" class="form-label"><i class="fas fa-tags me-1"></i>Add Tags (comma-separated):</label> <input type="text" class="form-control form-control-sm" id="fileTagsInput" placeholder="e.g., reports, important, 2024"> </div> <div id="uploadProgressContainer" class="mt-3" style="display: none;"> <div class="d-flex justify-content-between"> <small id="uploadFileName" class="text-muted">Uploading file...</small> <small id="uploadPercentage" class="text-muted">0%</small> </div> <div class="progress mt-1" style="height: 10px;"> <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div> </div> <small id="uploadStatus" class="text-muted d-block mt-1"></small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-sm btn-primary" id="startUploadButton">Start Upload</button> </div> </div> </div> </div>
         <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="filePreviewModalLabel">File Preview</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body text-center" style="min-height: 400px; max-height: 80vh; overflow-y: auto;"> <div id="previewContent"> <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"> <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> </div> </div> </div> <div class="modal-footer justify-content-start py-2"> <small class="text-muted me-3" id="previewFileName">File Name: </small> <small class="text-muted" id="previewFileType">Type: </small> </div> </div> </div> </div>

        <script>
            function initializeFileSharingFeature(container) {
                console.log("Initializing File Sharing Feature..."); // Debug log
                // Scope selectors to the container
                const featureWrapper = container.querySelector('.card'); // Target the wrapping card
                if (!featureWrapper) { console.error("File Sharing wrapper card not found!"); return { cleanup: () => {} }; }
                const fileTableBody = featureWrapper.querySelector('#fileTableBody');
                const fileSearchInput = featureWrapper.querySelector('#fileSearchInput');
                const fileTypeFilter = featureWrapper.querySelector('#fileTypeFilter');
                const uploadDateFilter = featureWrapper.querySelector('#uploadDateFilter');
                const userFilter = featureWrapper.querySelector('#userFilter');
                const userFilterContainer = featureWrapper.querySelector('#userFilterContainer');
                const noResultsRow = featureWrapper.querySelector('#noResultsRow');
                const resetFiltersBtn = featureWrapper.querySelector('#resetFiltersBtn');
                const recentUploadsSection = featureWrapper.querySelector('#recentUploadsSection');
                const recentUploadsList = recentUploadsSection?.querySelector('.list-group');

                // Modals are outside the container, use document scope but check existence
                const uploadFileModalEl = document.getElementById('uploadFileModal');
                const filePreviewModalEl = document.getElementById('filePreviewModal');

                if (!fileTableBody || !uploadFileModalEl || !filePreviewModalEl || !recentUploadsList) {
                    console.error("File Sharing essential elements not found!");
                    if(fileTableBody) fileTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                    return { cleanup: () => {} };
                }

                const isAdmin = window.currentUser?.role === 'admin'; // Use global currentUser
                if (isAdmin && userFilterContainer) { userFilterContainer.style.display = 'block'; } else if(userFilterContainer) { userFilterContainer.style.display = 'none'; }

                let allFilesData = []; // Store all file data
                let recentUploads = []; // Store recent uploads separately
                let listeners = []; // Store listeners for cleanup
                const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                const formatDateFS = (dateStr) => window.formatFullDateTime(new Date(dateStr)); // Use global
                const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };

                // --- File Type Icons ---
                function getFileIconClass(fileType) { fileType = fileType ? fileType.toLowerCase() : 'unknown'; switch (fileType) { case 'pdf': return 'fas fa-file-pdf text-danger'; case 'image': return 'fas fa-file-image text-success'; case 'video': return 'fas fa-file-video text-info'; case 'archive': return 'fas fa-file-zipper text-warning'; case 'document': return 'fas fa-file-word text-primary'; case 'spreadsheet': return 'fas fa-file-excel text-success'; default: return 'fas fa-file text-secondary'; } }
                function getFileTypeFromName(filename) { const ext = filename.split('.').pop()?.toLowerCase() || ''; if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) return 'Image'; if (['doc', 'docx', 'rtf', 'odt', 'txt'].includes(ext)) return 'Document'; if (['xls', 'xlsx', 'csv', 'ods'].includes(ext)) return 'Spreadsheet'; if (['pdf'].includes(ext)) return 'PDF'; if (['mp4', 'mov', 'avi', 'wmv', 'mkv'].includes(ext)) return 'Video'; if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'Archive'; return 'Other'; }

                // --- Data Loading & Rendering ---
                function loadFiles() { const storedFiles = localStorage.getItem('fileSharingFilesV2'); if (storedFiles) { try { allFilesData = JSON.parse(storedFiles); } catch (e) { console.error("Error parsing files:", e); allFilesData = generateSampleFiles(); } } else { allFilesData = generateSampleFiles(); } recentUploads = allFilesData.slice().sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)).slice(0, 3); populateUserFilter(); renderRecentUploads(); applyFilters(); // Initial render }
                function generateSampleFiles() { return [ { id: 1, name: "Monthly Performance Report.pdf", type: "PDF", size: "2.5 MB", tags: ["Reports", "Monthly"], uploader: "Mohamed Elmenisy", uploadDate: "2024-05-25T10:30:00Z", url: "path/to/report.pdf" }, { id: 2, name: "New Product Photo.jpg", type: "Image", size: "800 KB", tags: ["Products", "Design"], uploader: "Nada Mahmoud", uploadDate: "2024-05-24T15:15:00Z", url: "https://via.placeholder.com/800x600.jpg/007bff/ffffff?text=Product" }, { id: 3, name: "Project Resources.zip", type: "Archive", size: "15.2 MB", tags: ["Project X"], uploader: "Yousef Ahmed", uploadDate: "2024-05-23T09:00:00Z", url: "path/to/archive.zip" }, { id: 4, name: "Meeting Agenda.docx", type: "Document", size: "150 KB", tags: ["Meetings"], uploader: "Esraa Lashin", uploadDate: "2024-05-22T11:00:00Z", url: "path/to/agenda.docx" }, { id: 5, name: "Team Photo May.png", type: "Image", size: "1.2 MB", tags: ["Team"], uploader: "Bassant Badr", uploadDate: "2024-05-26T09:00:00Z", url: "https://via.placeholder.com/800x600.png/28a745/ffffff?text=Team" }, { id: 6, name: "Financial Summary Q1.xlsx", type: "Spreadsheet", size: "550 KB", tags: ["Finance", "Reports"], uploader: "Mohamed Elmenisy", uploadDate: "2024-05-27T14:00:00Z", url: "path/to/sheet.xlsx" } ]; }
                function populateUserFilter() { if (!userFilter) return; userFilter.innerHTML = '<option value="" selected>All Users</option>'; const users = [...new Set(allFilesData.map(f => f.uploader))]; users.sort().forEach(user => userFilter.appendChild(new Option(user, user))); }
                function renderRecentUploads() { recentUploadsList.innerHTML = ''; if (recentUploads.length === 0) { recentUploadsList.innerHTML = '<li class="list-group-item text-muted">No recent uploads.</li>'; return; } recentUploads.forEach(file => { const li = document.createElement('li'); li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center'); li.dataset.timestamp = file.uploadDate; const fileType = file.type || getFileTypeFromName(file.name); li.innerHTML = ` <div><i class="${getFileIconClass(fileType)} file-icon"></i> ${escapeHTML(file.name)}</div> <small class="text-muted time-ago">calculating...</small> `; recentUploadsList.appendChild(li); }); updateRelativeTimes(); }
                function renderTable(filesToRender) { fileTableBody.innerHTML = ''; if (filesToRender.length === 0) { if(noResultsRow) noResultsRow.style.display = 'table-row'; return; } if(noResultsRow) noResultsRow.style.display = 'none'; filesToRender.forEach(file => { const row = document.createElement('tr'); row.dataset.fileId = file.id; row.dataset.fileType = file.type || getFileTypeFromName(file.name); row.dataset.uploadDate = file.uploadDate.split('T')[0]; row.dataset.uploader = file.uploader; const tagsHtml = (file.tags || []).map(tag => `<span class="badge text-bg-secondary me-1">${escapeHTML(tag)}</span>`).join(''); const fileType = file.type || getFileTypeFromName(file.name); const iconClass = getFileIconClass(fileType); row.innerHTML = ` <td><i class="${iconClass}" title="${fileType}"></i></td> <td> <strong class="file-name">${escapeHTML(file.name)}</strong> <small class="d-block text-muted">Size: ${file.size || 'N/A'}</small> </td> <td class="upload-date">${formatDateFS(file.uploadDate)}</td> <td>${tagsHtml || '-'}</td> <td class="uploader-shared">${escapeHTML(file.uploader)}</td> <td class="text-center action-buttons"> <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="${file.id}" data-file-url="${file.url}"> <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span> </button> <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="${fileType}" data-file-url="${file.url}"> <i class="fas fa-eye"></i> </button> <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="${file.id}"> <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span> </button> </td> `; fileTableBody.appendChild(row); }); }
                function applyFilters() { const searchTerm = fileSearchInput.value.toLowerCase().trim(); const selectedType = fileTypeFilter.value; const selectedDate = uploadDateFilter.value; const selectedUser = userFilter.value; let filteredFiles = allFilesData.filter(file => { const fileType = file.type || getFileTypeFromName(file.name); const nameMatch = searchTerm === '' || file.name.toLowerCase().includes(searchTerm); const typeMatch = selectedType === '' || fileType === selectedType; const dateMatch = selectedDate === '' || file.uploadDate.startsWith(selectedDate); const userMatch = (!isAdmin || selectedUser === '' || file.uploader === selectedUser); return nameMatch && typeMatch && dateMatch && userMatch; }); // Apply sorting (e.g., by date desc) filteredFiles.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)); renderTable(filteredFiles); }

                function resetFilters() { if(fileSearchInput) fileSearchInput.value = ''; if(fileTypeFilter) fileTypeFilter.value = ''; if(uploadDateFilter) uploadDateFilter.value = ''; if(userFilter) userFilter.value = ''; applyFilters(); }
                function updateRelativeTimes() { if (!recentUploadsSection) return; const timeElements = recentUploadsSection.querySelectorAll('.time-ago'); timeElements.forEach(el => { const timestamp = el.closest('li')?.dataset.timestamp; if(timestamp) el.textContent = window.timeAgo(timestamp); }); }

                updateRelativeTimes(); // Initial update
                 const timeUpdateInterval = setInterval(updateRelativeTimes, 60000); // Update every minute

                // --- Action Button Handler ---
                 const handleTableClick = (event) => { const button = event.target.closest('.action-btn'); if (!button) return; if (button.classList.contains('loading')) return; const fileId = button.dataset.fileId; const row = button.closest('tr'); const fileNameElement = row?.querySelector('.file-name'); const fileName = fileNameElement ? fileNameElement.textContent : 'this file'; if (button.classList.contains('download-btn')) { const fileUrl = button.dataset.fileUrl; if (!fileUrl || fileUrl.startsWith('path/to/')) { console.error(`Download failed: URL missing/invalid for file ID ${fileId}.`); Swal.fire({ icon: 'error', title: 'Download Error', text: 'Could not download the file. URL is missing or invalid.', timer: 2500, showConfirmButton: false }); return; } button.classList.add('loading'); button.disabled = true; console.log(`Download: ID ${fileId}, URL: ${fileUrl}`); try { const link = document.createElement('a'); link.href = fileUrl; link.setAttribute('download', fileName); document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log(`Download initiated for: ${fileName}`); } catch (error) { console.error('Download error:', error); Swal.fire({ icon: 'error', title: 'Download Failed', text: 'An error occurred.' }); } finally { setTimeout(() => { button.classList.remove('loading'); button.disabled = false; }, 500); } } else if (button.classList.contains('delete-btn')) { Swal.fire({ title: 'Are you sure?', html: `Delete file: <br><strong>${escapeHTML(fileName)}</strong>`, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--success)', cancelButtonColor: 'var(--danger)', confirmButtonText: '<i class="fas fa-check me-1"></i> Yes, delete it!', cancelButtonText: '<i class="fas fa-times me-1"></i> Cancel' }).then((result) => { if (result.isConfirmed) { button.classList.add('loading'); button.disabled = true; console.log(`Delete: ID ${fileId}`); setTimeout(() => { const deleteSuccess = Math.random() > 0.1; if (deleteSuccess) { console.log(`Deleted: ${fileId}`); allFilesData = allFilesData.filter(f => f.id != fileId); // Update main data applyFilters(); // Re-render table recentUploads = allFilesData.slice().sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)).slice(0, 3); // Update recents renderRecentUploads(); // Re-render recents Swal.fire( 'Deleted!', `"${escapeHTML(fileName)}" has been deleted.`, 'success' ); } else { console.error(`Failed delete: ${fileId}`); button.classList.remove('loading'); button.disabled = false; Swal.fire( 'Error!', 'Could not delete file.', 'error' ); } }, 1000); } }); } };
                addListener(fileTableBody, 'click', handleTableClick);

                 // --- Preview Modal Logic ---
                 let previewModalInstance = filePreviewModalEl ? new bootstrap.Modal(filePreviewModalEl) : null;
                 const previewContent = filePreviewModalEl?.querySelector('#previewContent');
                 const previewFileName = filePreviewModalEl?.querySelector('#previewFileName');
                 const previewFileType = filePreviewModalEl?.querySelector('#previewFileType');
                 const handlePreviewShow = (event) => { const button = event.relatedTarget; if (!button || !previewContent || !previewFileName || !previewFileType) return; const fileUrl = button.getAttribute('data-file-url'); const fileType = button.getAttribute('data-file-type'); const row = button.closest('tr'); const fileNameElement = row?.querySelector('.file-name'); const fileName = fileNameElement ? fileNameElement.textContent : 'N/A'; previewFileName.textContent = `File Name: ${escapeHTML(fileName)}`; previewFileType.textContent = `Type: ${fileType ? fileType.toUpperCase() : 'N/A'}`; previewContent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; // Spinner
                     if (fileUrl && !fileUrl.startsWith('path/to/')) { setTimeout(() => { // Delay for spinner
                            if (fileType === 'Image') { previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" alt="Preview" style="max-height: 75vh;">`; }
                            else if (fileType === 'PDF') { previewContent.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="650px"><p class="text-warning p-4">Preview unavailable. Browser might not support PDF embedding. <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Download PDF</a></p></object>`; }
                            else { previewContent.innerHTML = `<p class="text-warning p-4">Preview not available for file type (${fileType}).</p>`; }
                        }, 300);
                    } else { previewContent.innerHTML = `<p class="text-danger p-4">Could not load preview. URL missing or invalid.</p>`; }
                 };
                 const handlePreviewHidden = () => { if(previewContent) previewContent.innerHTML = ''; }; // Clear on hide
                addListener(filePreviewModalEl, 'show.bs.modal', handlePreviewShow);
                addListener(filePreviewModalEl, 'hidden.bs.modal', handlePreviewHidden);

                // --- Upload Modal Logic ---
                 const startUploadButton = uploadFileModalEl?.querySelector('#startUploadButton');
                 const uploadProgressContainer = uploadFileModalEl?.querySelector('#uploadProgressContainer');
                 const uploadProgressBar = uploadFileModalEl?.querySelector('#uploadProgressBar');
                 const uploadStatus = uploadFileModalEl?.querySelector('#uploadStatus');
                 const uploadFileName = uploadFileModalEl?.querySelector('#uploadFileName');
                 const uploadPercentage = uploadFileModalEl?.querySelector('#uploadPercentage');
                 const fileInputManual = uploadFileModalEl?.querySelector('#fileInputManual');
                 const fileInputHidden = uploadFileModalEl?.querySelector('#fileInputHidden');
                 const dropZone = uploadFileModalEl?.querySelector('#dropZone');
                 const fileTagsInput = uploadFileModalEl?.querySelector('#fileTagsInput'); // Added tag input selector
                 let uploadModalInstance = uploadFileModalEl ? new bootstrap.Modal(uploadFileModalEl) : null;
                 const handleUploadStart = () => { if (!startUploadButton || !uploadProgressContainer || !uploadProgressBar || !uploadStatus || !uploadFileName || !uploadPercentage || !fileInputManual || !fileInputHidden) return; const filesToUpload = fileInputManual.files.length > 0 ? fileInputManual.files : fileInputHidden.files; if (filesToUpload.length === 0) { Swal.fire('No File Selected', 'Please select at least one file.', 'warning'); return; } const firstFile = filesToUpload[0]; const tags = (fileTagsInput ? fileTagsInput.value : '').split(',').map(tag => tag.trim()).filter(tag => tag); console.log("Starting upload for:", firstFile.name, "with tags:", tags); uploadFileName.textContent = `Uploading: ${firstFile.name}`; uploadProgressContainer.style.display = 'block'; uploadProgressBar.style.width = '0%'; uploadProgressBar.classList.remove('bg-success', 'bg-danger'); uploadProgressBar.classList.add('progress-bar-striped','progress-bar-animated'); uploadPercentage.textContent = '0%'; uploadStatus.textContent = 'Initializing...'; uploadStatus.className = 'text-muted d-block mt-1'; let progress = 0; const interval = setInterval(() => { progress += Math.random() * 15; progress = Math.min(progress, 100); uploadProgressBar.style.width = progress + '%'; uploadProgressBar.setAttribute('aria-valuenow', progress); uploadPercentage.textContent = Math.round(progress) + '%'; if (progress >= 100) { clearInterval(interval); const uploadSuccess = Math.random() > 0.2; uploadProgressBar.classList.remove('progress-bar-animated'); if(uploadSuccess) { const newFile = { id: Date.now(), name: firstFile.name, type: getFileTypeFromName(firstFile.name), size: `${(firstFile.size / (1024*1024)).toFixed(2)} MB`, tags: tags, uploader: window.currentUser?.name || "Unknown", uploadDate: new Date().toISOString(), url: `path/to/uploaded/${firstFile.name}` }; allFilesData.unshift(newFile); recentUploads = allFilesData.slice().sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)).slice(0, 3); // Update recents localStorage.setItem('fileSharingFilesV2', JSON.stringify(allFilesData)); // Save new file list uploadStatus.textContent = 'Upload successful!'; uploadStatus.className = 'text-success d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-success'); setTimeout(() => { uploadModalInstance?.hide(); applyFilters(); // Re-render table renderRecentUploads(); // Re-render recents }, 1500); } else { uploadStatus.textContent = 'Upload failed. Please try again.'; uploadStatus.className = 'text-danger d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-danger'); } fileInputManual.value = ''; fileInputHidden.value = ''; if(fileTagsInput) fileTagsInput.value = ''; } }, 300); };
                addListener(startUploadButton, 'click', handleUploadStart);

                // Drag and Drop Listeners
                if (dropZone) { addListener(dropZone, 'dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--app-success)'; }); addListener(dropZone, 'dragleave', () => { dropZone.style.borderColor = 'var(--app-primary)'; }); addListener(dropZone, 'drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--app-primary)'; if (e.dataTransfer.files.length > 0 && fileInputHidden) { fileInputHidden.files = e.dataTransfer.files; dropZone.querySelector('p:last-child').textContent = `${e.dataTransfer.files.length} file(s) selected.`; } }); addListener(dropZone, 'click', () => fileInputHidden?.click()); }
                 if (fileInputHidden) { addListener(fileInputHidden, 'change', () => { if(fileInputHidden.files.length > 0 && dropZone) dropZone.querySelector('p:last-child').textContent = `${fileInputHidden.files.length} file(s) selected.`; }); }
                 if (fileInputManual) { addListener(fileInputManual, 'change', () => { if (fileInputManual.files.length > 0 && dropZone) { dropZone.querySelector('p:last-child').textContent = 'Or drag & drop files here'; if(fileInputHidden) fileInputHidden.value = ''; } }); }

                // Filter Listeners
                addListener(fileSearchInput, 'input', applyFilters);
                addListener(fileTypeFilter, 'change', applyFilters);
                addListener(uploadDateFilter, 'change', applyFilters);
                addListener(userFilter, 'change', applyFilters);
                addListener(resetFiltersBtn, 'click', resetFilters);

                // Initial call
                loadFiles(); // This now calls applyFilters internally

                const cleanup = () => {
                    console.log("Cleaning up File Sharing..."); clearInterval(timeUpdateInterval);
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                    uploadModalInstance?.hide(); previewModalInstance?.hide(); document.querySelectorAll('.modal-backdrop').forEach(el => el.remove()); document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = '';
                    console.log("File Sharing cleanup complete.");
                };
                return { cleanup };
            }
        </script>
    </template>

    <!-- Template for Project Tracking -->
    <template id="projectTrackingAssets">
         <style id="injected-project-tracking-styles">
             #featureSectionsContainer.project-tracking-feature {
                 /* ... (Variables as defined before) ... */
                 --app-primary: var(--feature-tracking-primary); --app-secondary: var(--feature-tracking-secondary); --app-success: var(--feature-tracking-success); --app-danger: var(--feature-tracking-danger); --app-warning: var(--feature-tracking-warning); --app-info: var(--feature-tracking-info); --app-purple: var(--feature-tracking-purple); --app-orange: var(--feature-tracking-orange); --app-teal: var(--feature-tracking-teal); --app-light: var(--feature-tracking-light); --app-dark: var(--feature-tracking-dark); --app-hover-bg: var(--feature-tracking-hover-bg); --app-header-bg: var(--feature-tracking-header-bg); --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-gray: #9E9E9E; --chart-purple: #9C27B0; --chart-cyan: #00BCD4; --chart-background: var(--feature-tracking-chart-background); --status-completed-bg: rgba(76, 175, 80, 0.15); --status-completed-text: #388E3C; --status-inprogress-bg: rgba(33, 150, 243, 0.15); --status-inprogress-text: #1976D2; --status-delayed-bg: rgba(255, 193, 7, 0.15); --status-delayed-text: #FFA000; --status-pending-bg: rgba(158, 158, 158, 0.15); --status-pending-text: #616161; --priority-high-bg: rgba(244, 67, 54, 0.15); --priority-high-text: #D32F2F; --priority-medium-bg: rgba(255, 193, 7, 0.15); --priority-medium-text: #FFA000; --priority-low-bg: rgba(76, 175, 80, 0.15); --priority-low-text: #388E3C;
             }
             #featureSectionsContainer.project-tracking-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.project-tracking-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
             #featureSectionsContainer.project-tracking-feature { background-color: transparent; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
             #featureSectionsContainer.project-tracking-feature #project-tracking-section { padding: 0; }
             #featureSectionsContainer.project-tracking-feature .card { border: none; border-radius: 0; margin-bottom: 0; box-shadow: none; background-color: transparent; }
             #featureSectionsContainer.project-tracking-feature .card-header { background-color: var(--app-light); border-radius: 8px 8px 0 0; border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .card-header { background-color: var(--light); border-bottom-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-fancy-title { background: var(--app-header-bg); color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.0rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 0; }
             #featureSectionsContainer.project-tracking-feature .pt-fancy-title i { margin-right: 8px; }
             #featureSectionsContainer.project-tracking-feature .pt-filters-section { background-color: var(--white); padding: 1rem 1.25rem; border-radius: 6px; border: 1px solid var(--light-gray); margin: 1.5rem; } /* Added margin */
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-filters-section { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-filters-section .form-label { font-size: 0.8rem; color: var(--app-secondary); margin-bottom: 0.25rem; font-weight: 500; }
             #featureSectionsContainer.project-tracking-feature .pt-filters-section .form-select-sm { font-size: 0.875rem; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations { padding: 0 1.5rem 1.5rem; } /* Add padding */
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 300px; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-title { font-weight: 600; color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--white); padding: 15px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 300px; display: flex; flex-direction: column; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--app-primary); font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li { padding: 8px 5px; border-bottom: 1px dashed #eee; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li { border-bottom-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li:last-child { border-bottom: none; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--app-hover-bg); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--primary-light); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders .deadline { font-size: 0.8em; color: var(--app-danger); font-weight: 500; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders .days-left { font-size: 0.75em; color: var(--text-muted); font-style: italic; }
             #featureSectionsContainer.project-tracking-feature .pt-table-container { background-color: var(--white); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); margin: 0 1.5rem 1.5rem; } /* Add margin */
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container { background-color: var(--light); border-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-table-container h5 { color: var(--app-primary); margin-bottom: 15px; font-weight: 600; }
             #featureSectionsContainer.project-tracking-feature .pt-table thead { background-color: var(--app-light) !important; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table thead { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
             #featureSectionsContainer.project-tracking-feature .pt-table tbody td { vertical-align: middle; font-size: 0.875rem; padding: 0.7rem 0.75rem; color: var(--text-color);} /* Ensure text color */
             #featureSectionsContainer.project-tracking-feature .pt-table th[data-sort-by] { cursor: pointer; }
             #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon { margin-left: 5px; color: #ccc; font-size: 0.8em; display: inline-block; width: 10px; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon.active { color: var(--app-primary); }
             #featureSectionsContainer.project-tracking-feature .pt-table .project-name { font-weight: 500; color: var(--app-dark); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .project-name { color: var(--text-color); }
             #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { display: inline-block; background-color: #eee; color: #555; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-right: 3px; margin-bottom: 2px; white-space: nowrap; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { background-color: var(--light-gray); color: var(--text-color); }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-cell { min-width: 120px; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress { height: 14px; background-color: #e9ecef; border-radius: 7px; overflow: hidden; position: relative; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .progress { background-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar { font-size: 0.9rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-high { background-color: var(--chart-green) !important; color: white; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-medium { background-color: var(--chart-orange) !important; color: #212529; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-low { background-color: var(--chart-red) !important; color: white; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-badge, #featureSectionsContainer.project-tracking-feature .pt-table .priority-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; display: inline-block; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-inprogress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-delayed { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-high { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-low { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-inprogress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-delayed { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-high { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-low { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 5px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button, #featureSectionsContainer.project-tracking-feature .pt-pagination span { padding: 8px 12px; border: 1px solid #ddd; background-color: #fff; border-radius: 4px; font-size: 14px; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button, body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination span { border-color: var(--light-gray); background-color: var(--light); }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button { cursor: pointer; transition: background-color 0.2s ease; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button:hover:not(:disabled) { background-color: #eee; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button:hover:not(:disabled) { background-color: var(--light-gray); }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button:disabled { cursor: not-allowed; opacity: 0.6; background-color: var(--light); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button:disabled { background-color: var(--primary-light); }
             #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-page-info { border: none; background: none; padding: 8px 5px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-current-page { font-weight: bold; }
             @media (max-width: 992px) { #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container, #featureSectionsContainer.project-tracking-feature .pt-reminders { height: 280px; } }
             @media (max-width: 768px) {
                 #featureSectionsContainer.project-tracking-feature .card-header { flex-direction: column; align-items: flex-start; }
                 #featureSectionsContainer.project-tracking-feature .pt-filters-section .row > div { margin-bottom: 10px; }
                 #featureSectionsContainer.project-tracking-feature .pt-reminders { margin-bottom: 1.5rem; }
                 #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 100px; }
                 #featureSectionsContainer.project-tracking-feature .pt-table-container { margin: 1rem; }
                 #featureSectionsContainer.project-tracking-feature .pt-visualizations { padding: 0 1rem; }
             }
         </style>
        <div id="project-tracking-section"> <!-- Wrapper div -->
             <!-- Section Header -->
             <div class="card-header">
                 <h2 class="pt-fancy-title"><i class="fas fa-tasks me-2"></i> Project Tracking</h2>
                 <!-- Add Actions Button if needed -->
             </div>

             <!-- Filters -->
             <div class="pt-filters-section">
                 <div class="row gy-2 align-items-end">
                     <div class="col-md-4">
                         <label for="project-status-filter" class="form-label">Filter by Status:</label>
                         <select class="form-select form-select-sm" id="project-status-filter"> <option value="" selected>All Statuses</option> <option value="Completed">Completed</option> <option value="In Progress">In Progress</option> <option value="Delayed">Delayed</option> <option value="Pending">Pending</option> </select>
                     </div>
                     <div class="col-md-4">
                         <label for="project-team-filter" class="form-label">Filter by Team/Member:</label>
                         <select class="form-select form-select-sm" id="project-team-filter"> <option value="" selected>All Teams/Members</option>
                          <!-- Options added by JS -->
                          </select>
                     </div>
                     <div class="col-md-2">
                          <label for="project-priority-filter" class="form-label">Filter by Priority:</label>
                         <select class="form-select form-select-sm" id="project-priority-filter"> <option value="" selected>All Priorities</option> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select>
                     </div>
                     <div class="col-md-2 text-end">
                         <button class="btn btn-sm btn-outline-secondary w-100" id="resetProjectFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt me-1"></i> Reset </button>
                     </div>
                 </div>
             </div>

             <!-- Visualizations & Reminders -->
             <div class="row g-3 pt-visualizations">
                  <div class="col-lg-8">
                     <div class="row g-3">
                         <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Project Status Distribution</p> <canvas id="projectStatusPieChart"></canvas> </div> </div>
                         <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Overall Progress Trend (Simulated)</p> <canvas id="projectProgressLineChart"></canvas> </div> </div>
                     </div>
                  </div>
                  <div class="col-lg-4">
                      <div class="pt-reminders"> <h6><i class="fas fa-bell me-1 text-warning"></i> Upcoming Deadlines (Next 7 Days)</h6> <ul id="upcomingDeadlinesList"> <li class="text-muted text-center pt-5">Loading deadlines...</li> </ul> </div>
                  </div>
             </div>

             <!-- Project Table -->
             <div class="pt-table-container">
                  <h5><i class="fas fa-list-check me-2"></i> Project Details</h5> <!-- Headline Added -->
                  <div class="table-responsive">
                     <table class="table table-sm table-hover table-striped align-middle pt-table" id="projectTrackingTable">
                         <thead> <tr> <th data-sort-by="name">Project Name <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="startDate">Start Date <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="endDate">End Date <i class="fas fa-sort sort-icon"></i></th> <th>Assigned Team</th> <th class="text-center progress-cell" data-sort-by="progress">Progress (%) <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="status">Status <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="priority">Priority <i class="fas fa-sort sort-icon"></i></th> <th>Notes</th> </tr> </thead>
                         <tbody id="projectTableBody"> <tr> <td colspan="8" class="text-center p-4 text-muted"> <div class="spinner-border spinner-border-sm text-primary me-2" role="status"> <span class="visually-hidden">Loading...</span> </div> Loading project data... </td> </tr> </tbody>
                     </table>
                  </div>
                  <div class="pt-pagination" id="projectPaginationControls"></div>
             </div>
        </div> <!-- End #project-tracking-section -->
        <script>
            function initializeProjectTrackingFeature(container) {
                console.log("Initializing Project Tracking Feature..."); // Debug log
                 const sectionContainer = container.querySelector('#project-tracking-section');
                 if (!sectionContainer) { console.error("Project tracking main container not found"); return { cleanup: () => {} }; }
                 const statusFilter = sectionContainer.querySelector('#project-status-filter');
                 const teamFilter = sectionContainer.querySelector('#project-team-filter');
                 const priorityFilter = sectionContainer.querySelector('#project-priority-filter');
                 const resetFiltersBtn = sectionContainer.querySelector('#resetProjectFiltersBtn');
                 const tableBody = sectionContainer.querySelector('#projectTableBody');
                 const paginationControls = sectionContainer.querySelector('#projectPaginationControls');
                 const deadlinesList = sectionContainer.querySelector('#upcomingDeadlinesList');
                 const tableHeaders = sectionContainer.querySelectorAll("#projectTrackingTable th[data-sort-by]");
                 const projectStatusPieChartEl = sectionContainer.querySelector('#projectStatusPieChart');
                 const projectProgressLineChartEl = sectionContainer.querySelector('#projectProgressLineChart');

                 if (!tableBody || !projectStatusPieChartEl || !projectProgressLineChartEl || !statusFilter || !teamFilter || !priorityFilter || !resetFiltersBtn || !paginationControls || !deadlinesList) {
                     console.error("Essential Project Tracking elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 let projectData = []; let filteredData = []; let currentPage = 1; const rowsPerPage = 5; let currentSortColumn = 'endDate'; let currentSortDirection = 'asc';
                 let statusPieChartInstance = null; let progressLineChartInstance = null;
                 let listeners = [];

                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 const formatDate = (dateString) => window.formatDateForDisplay(dateString); // Use global
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                 const rgbaColor = (c, alpha) => { try { if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; } catch(e) { console.warn("Could not parse color for rgba:", c); return 'rgba(0,0,0,0.1)'; } };
                 const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };
                 function getStatusBadgeClass(status) { switch (status?.toLowerCase()) { case 'completed': return 'status-completed'; case 'in progress': return 'status-inprogress'; case 'delayed': return 'status-delayed'; case 'pending': return 'status-pending'; default: return ''; } }
                 function getPriorityBadgeClass(priority) { switch (priority?.toLowerCase()) { case 'high': return 'priority-high'; case 'medium': return 'priority-medium'; case 'low': return 'priority-low'; default: return ''; } }
                 function getProgressBgClass(progress) { if (progress >= 80) return 'bg-progress-high'; if (progress >= 50) return 'bg-progress-medium'; return 'bg-progress-low'; }
                 function getProgressTextColor(progress) { return (progress >= 50 && progress < 80) ? '#212529' : '#fff'; }

                function renderProjectStatusPieChart(data) {
                     const ctx = projectStatusPieChartEl.getContext('2d'); if (!ctx) return;
                     const statusCounts = data.reduce((acc, project) => { acc[project.status] = (acc[project.status] || 0) + 1; return acc; }, {});
                     const labels = Object.keys(statusCounts); const chartData = Object.values(statusCounts);
                     const backgroundColors = labels.map(label => { switch (label.toLowerCase()) { case 'completed': return getCssVar('--chart-green'); case 'in progress': return getCssVar('--chart-blue'); case 'delayed': return getCssVar('--chart-orange'); case 'pending': return getCssVar('--chart-gray'); default: return getCssVar('--app-secondary'); } });
                     const config = { type: 'pie', data: { labels: labels, datasets: [{ data: chartData, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: getCssVar('--text-muted') } } } } };
                     if (statusPieChartInstance) statusPieChartInstance.destroy(); statusPieChartInstance = new Chart(ctx, config);
                 }
                 function renderProjectProgressLineChart() { // Keeps simulated data
                      const ctx = projectProgressLineChartEl.getContext('2d'); if (!ctx) return;
                      const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']; const data = [20, 35, 50, 60, 75, 80]; // SIMULATED
                      const config = { type: 'line', data: { labels: labels, datasets: [{ label: 'Overall Progress %', data: data, borderColor: getCssVar('--chart-blue'), backgroundColor: rgbaColor(getCssVar('--chart-blue'), 0.1), fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: getCssVar('--text-muted') } }, x: { ticks: { color: getCssVar('--text-muted') } } }, plugins: { legend: { display: false } } } };
                      if (progressLineChartInstance) progressLineChartInstance.destroy(); progressLineChartInstance = new Chart(ctx, config);
                 }
                 function renderUpcomingDeadlines(data) {
                     if (!deadlinesList) return; deadlinesList.innerHTML = ''; const today = new Date(); today.setHours(0, 0, 0, 0); const sevenDaysFromNow = new Date(today); sevenDaysFromNow.setDate(today.getDate() + 7);
                     const upcoming = data.filter(project => { if (!project.endDate || project.status === 'Completed') return false; const endDate = new Date(project.endDate + 'T00:00:00Z'); return !isNaN(endDate.getTime()) && endDate >= today && endDate <= sevenDaysFromNow; }).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                     if (upcoming.length === 0) { deadlinesList.innerHTML = '<li class="text-muted text-center pt-5">No upcoming deadlines found.</li>'; return; }
                     upcoming.forEach(project => { const li = document.createElement('li'); const endDate = new Date(project.endDate + 'T00:00:00Z'); const diffTime = endDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const daysLeftText = diffDays === 0 ? 'Due Today' : `${diffDays} day${diffDays !== 1 ? 's' : ''} left`; li.innerHTML = `<span>${escapeHTML(project.name)}</span><span class="text-end"><span class="deadline me-2">${formatDate(project.endDate)}</span><span class="days-left">(${daysLeftText})</span></span>`; deadlinesList.appendChild(li); });
                 }
                 function renderTable() {
                     tableBody.innerHTML = ''; if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-muted fst-italic">No projects found matching criteria.</td></tr>`; renderPagination(); return; }
                     const totalItems = filteredData.length; const totalPages = Math.ceil(totalItems / rowsPerPage); if (currentPage > totalPages && totalPages > 0) currentPage = totalPages; else if (currentPage < 1) currentPage = 1; const startIndex = (currentPage - 1) * rowsPerPage; const endIndex = startIndex + rowsPerPage; const pageData = filteredData.slice(startIndex, endIndex);
                     pageData.forEach(project => {
                         const row = document.createElement('tr'); const statusClass = getStatusBadgeClass(project.status); const priorityClass = getPriorityBadgeClass(project.priority); const progressBg = getProgressBgClass(project.progress); const progressTextClr = getProgressTextColor(project.progress);
                         const teamHtml = (project.assignedTeam || []).map(member => `<span>${escapeHTML(member)}</span>`).join('');
                         row.innerHTML = ` <td><div class="project-name">${escapeHTML(project.name)}</div></td> <td>${formatDate(project.startDate)}</td> <td>${formatDate(project.endDate)}</td> <td class="assigned-team">${teamHtml}</td> <td class="text-center progress-cell"> <div class="progress" role="progressbar" aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100"> <div class="progress-bar ${progressBg}" style="width: ${project.progress}%; color: ${progressTextClr};">${project.progress}%</div> </div> </td> <td class="text-center"><span class="status-badge ${statusClass}">${escapeHTML(project.status)}</span></td> <td class="text-center"><span class="priority-badge ${priorityClass}">${escapeHTML(project.priority)}</span></td> <td class="notes-cell" title="${escapeHTML(project.notes || '')}">${escapeHTML(project.notes || '-')}</td> `;
                         tableBody.appendChild(row);
                     });
                     renderPagination(); updateSortIcons();
                 }
                 function renderPagination() { if(!paginationControls) return; paginationControls.innerHTML = ''; const totalItems = filteredData.length; if (totalItems <= rowsPerPage) return; const totalPages = Math.ceil(totalItems / rowsPerPage); const createButton = (text, page, disabled = false) => { const button = document.createElement('button'); button.className = 'btn btn-sm btn-outline-secondary'; button.innerHTML = text; button.disabled = disabled; addListener(button, 'click', () => { currentPage = page; renderTable(); }); return button; }; paginationControls.appendChild(createButton('<i class="fas fa-chevron-left"></i> Prev', currentPage - 1, currentPage === 1)); const pageInfo = document.createElement('span'); pageInfo.className = 'pt-page-info'; pageInfo.innerHTML = `Page <span class="pt-current-page">${currentPage}</span> of ${totalPages}`; paginationControls.appendChild(pageInfo); paginationControls.appendChild(createButton('Next <i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages)); }
                 function updateSortIcons() { tableHeaders.forEach(th => { const icon = th.querySelector('.sort-icon'); if (!icon) return; const columnKey = th.getAttribute('data-sort-by'); icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down', 'active'); if (columnKey === currentSortColumn) { icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'); icon.classList.add('active'); } else { icon.classList.add('fa-sort'); } }); }
                 function handleSortClick(event) { const header = event.currentTarget; const columnKey = header.getAttribute('data-sort-by'); if (!columnKey) return; if (currentSortColumn === columnKey) { currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc'; } else { currentSortColumn = columnKey; currentSortDirection = 'asc'; } applyFiltersAndSort(); }
                 function applyFiltersAndSort() {
                     const statusValue = statusFilter.value; const teamValue = teamFilter.value; const priorityValue = priorityFilter.value;
                     let tempFilteredData = projectData.filter(project => { const statusMatch = !statusValue || project.status === statusValue; const teamMatch = !teamValue || (project.assignedTeam || []).includes(teamValue); const priorityMatch = !priorityValue || project.priority === priorityValue; return statusMatch && teamMatch && priorityMatch; });
                     tempFilteredData.sort((a, b) => { let valA = a[currentSortColumn]; let valB = b[currentSortColumn]; if (currentSortColumn === 'startDate' || currentSortColumn === 'endDate') { valA = new Date(valA || 0).getTime(); valB = new Date(valB || 0).getTime(); if (isNaN(valA)) valA = Infinity; if (isNaN(valB)) valB = Infinity; } else if (currentSortColumn === 'progress') { valA = Number(valA); valB = Number(valB); } else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } else if (currentSortColumn === 'priority') { const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 }; valA = priorityOrder[a.priority] || 0; valB = priorityOrder[b.priority] || 0; } if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1; if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1; return 0; });
                     filteredData = tempFilteredData;
                     currentPage = 1;
                     renderTable(); renderProjectStatusPieChart(filteredData); renderUpcomingDeadlines(filteredData); renderProjectProgressLineChart(); // Needs actual data to be useful
                 }
                 function resetFilters() { statusFilter.value = ''; teamFilter.value = ''; priorityFilter.value = ''; applyFiltersAndSort(); }
                 function populateTeamFilter() { const teamMembers = [...new Set(projectData.flatMap(p => p.assignedTeam || []))]; teamFilter.innerHTML = '<option value="" selected>All Teams/Members</option>'; teamMembers.sort().forEach(member => teamFilter.appendChild(new Option(member, member))); }

                 function fetchInitialData() {
                     setTimeout(() => {
                         projectData = [ { id: 1, name: "Website Overhaul", startDate: "2024-03-01", endDate: "2024-07-30", assignedTeam: ["Mohamed Elmenisy", "Esraa Lashin"], progress: 75, status: "In Progress", priority: "High", notes: "Phase 1 complete, focusing on backend." }, { id: 2, name: "Mobile App Dev", startDate: "2024-04-15", endDate: "2024-09-15", assignedTeam: ["Yousef Ahmed", "Bassant Badr"], progress: 40, status: "In Progress", priority: "High", notes: "Core features implemented." }, { id: 3, name: "Marketing Campaign Q3", startDate: "2024-07-01", endDate: "2024-09-30", assignedTeam: ["Bassant Badr", "Nada Mahmoud"], progress: 15, status: "Pending", priority: "Medium", notes: "Planning stage." }, { id: 4, name: "Server Upgrade", startDate: "2024-05-20", endDate: "2024-06-10", assignedTeam: ["Yousef Ahmed"], progress: 100, status: "Completed", priority: "Medium", notes: "Completed ahead of schedule." }, { id: 5, name: "UI Kit Development", startDate: "2024-06-01", endDate: "2024-08-15", assignedTeam: ["Esraa Lashin"], progress: 60, status: "In Progress", priority: "Low", notes: "Delayed due to scope change." }, { id: 6, name: "API Documentation", startDate: "2024-07-10", endDate: "2024-07-25", assignedTeam: ["Mohamed Elmenisy"], progress: 90, status: "Delayed", priority: "Medium", notes: "Awaiting final review." }, { id: 7, name: "User Training Material", startDate: "2024-08-01", endDate: "2024-08-20", assignedTeam: ["Nada Mahmoud"], progress: 0, status: "Pending", priority: "Low", notes: null }, ];
                         populateTeamFilter(); // Populate filter after data is loaded
                         applyFiltersAndSort(); // Initial render with data
                         console.log("Project Tracking data loaded.");
                     }, 500); // Simulate network delay
                 }

                 tableHeaders.forEach(th => addListener(th, 'click', handleSortClick));
                 addListener(statusFilter, 'change', applyFiltersAndSort);
                 addListener(teamFilter, 'change', applyFiltersAndSort);
                 addListener(priorityFilter, 'change', applyFiltersAndSort);
                 addListener(resetFiltersBtn, 'click', resetFilters);

                 fetchInitialData(); // Load data and render

                 // Make instance methods available if needed globally (optional)
                 window.projectTrackingInstance = { applyFiltersAndSort, renderTable, renderUpcomingDeadlines, filteredData };

                 const cleanup = () => {
                     console.log("Cleaning up Project Tracking...");
                     if (statusPieChartInstance) statusPieChartInstance.destroy(); statusPieChartInstance = null;
                     if (progressLineChartInstance) progressLineChartInstance.destroy(); progressLineChartInstance = null;
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                     delete window.projectTrackingInstance; // Clean up global instance
                     console.log("Project Tracking cleanup complete.");
                 };
                 return { cleanup };
            }
        </script>
    </template>

    <!-- Template for Reports & Analytics -->
    <template id="reportsAnalyticsAssets">
        <style id="injected-reports-analytics-styles">
            /* --- Color Palette & Chart Colors --- */
            #featureSectionsContainer.reports-analytics-feature {
                 --app-primary: var(--feature-reports-primary); --app-secondary: var(--feature-reports-secondary); --app-success: var(--feature-reports-success); --app-danger: var(--feature-reports-danger); --app-warning: var(--feature-reports-warning); --app-info: var(--feature-reports-info); --app-purple: var(--feature-reports-purple); --app-orange: var(--feature-reports-orange); --app-teal: var(--feature-reports-teal); --app-light: var(--feature-reports-light); --app-dark: var(--feature-reports-dark); --app-hover-bg: var(--feature-reports-hover-bg); --app-header-bg: var(--feature-reports-header-bg); --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-purple: #9C27B0; --chart-cyan: #00BCD4; --chart-background: var(--feature-reports-chart-background); --chart-fill-opacity: var(--feature-reports-chart-fill-opacity); --chart-radar-fill-opacity: var(--feature-reports-chart-radar-fill-opacity);
            }
             #featureSectionsContainer.reports-analytics-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
            #featureSectionsContainer.reports-analytics-feature { background-color: transparent; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
            #featureSectionsContainer.reports-analytics-feature #reports-analytics-section { padding: 0; }
            #featureSectionsContainer.reports-analytics-feature .card { border: none; border-radius: 0; margin-bottom: 0; box-shadow: none; background-color: transparent;}
            #featureSectionsContainer.reports-analytics-feature .card-header { background-color: var(--app-light); border-radius: 8px 8px 0 0; border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .card-header { background-color: var(--light); border-bottom-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--app-header-bg); color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.0rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 0; }
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title i { margin-right: 8px; }
            #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn { font-size: 0.8rem; padding: 0.375rem 0.75rem; }
            #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn i { margin-right: 5px; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section { background-color: var(--white); padding: 1rem 1.25rem; border-radius: 6px; border: 1px solid var(--light-gray); margin: 1.5rem; } /* Added margin */
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group .btn { font-size: 0.85rem; padding: 0.375rem 0.85rem; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .form-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 500; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { font-size: 0.85rem; padding: 0.375rem 0.75rem; max-width: 150px; }
            #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 350px; display: flex; flex-direction: column; }
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
            #featureSectionsContainer.reports-analytics-feature .chart-title { font-weight: 600; color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
            #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--white); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); margin: 1.5rem; } /* Add margin */
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .ra-table-container h5 { color: var(--app-primary); margin-bottom: 15px; font-weight: 600; }
            #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--app-light) !important; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table tbody td { vertical-align: middle; font-size: 0.875rem; padding-top: 0.6rem; padding-bottom: 0.6rem; color: var(--text-color); } /* Ensure text color */
            #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { font-weight: 500; color: var(--app-dark); padding-left: 5px; }
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { color: var(--text-color); }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress { height: 14px; background-color: #e9ecef; min-width: 100px; border-radius: 7px; overflow: hidden; position: relative; }
            body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .progress { background-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar { font-size: 0.9rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-high { background-color: var(--chart-green) !important; color: white; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-medium { background-color: var(--chart-orange) !important; color: #212529; } /* Darker text on orange */
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-low { background-color: var(--chart-red) !important; color: white; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .metric-value { font-weight: 500; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-success { color: var(--chart-green) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-danger { color: var(--chart-red) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-info { color: var(--chart-blue) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-warning { color: var(--chart-orange) !important; }
            @media (max-width: 768px) {
                 #featureSectionsContainer.reports-analytics-feature .chart-container { height: 300px; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section .d-flex { flex-direction: column; align-items: stretch !important; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group, #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { width: 100%; margin-bottom: 10px; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { max-width: none; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section button[type="submit"] { width: 100%; }
                 #featureSectionsContainer.reports-analytics-feature .card-header { flex-direction: column; align-items: flex-start; }
                 #featureSectionsContainer.reports-analytics-feature .ra-export-buttons { margin-top: 10px; width: 100%; text-align: right; }
                 #featureSectionsContainer.reports-analytics-feature .ra-table-container { margin: 1rem; } /* Reduce margin */
            }
        </style>
        <div id="reports-analytics-section"> <!-- Wrapper div -->
             <!-- Section Header with Export Buttons -->
             <div class="card-header">
                 <h2 class="ra-fancy-title"><i class="fas fa-chart-pie me-2"></i> Reports & Analytics</h2>
                 <div class="ra-export-buttons">
                      <button id="exportPdfBtn" class="btn btn-sm btn-outline-danger"> <i class="fas fa-file-pdf"></i> Export PDF </button>
                      <button id="exportExcelBtn" class="btn btn-sm btn-outline-success"> <i class="fas fa-file-excel"></i> Export Excel </button>
                 </div>
             </div>

             <!-- Filters -->
             <div class="ra-filters-section">
                 <form id="reports-filter-form">
                      <div class="row gy-2 align-items-end">
                         <div class="col-md-auto">
                             <label class="form-label">Quick Period:</label>
                             <div class="btn-group w-100" role="group" aria-label="Report Period" id="periodBtnGroup"> <input type="radio" class="btn-check" name="period" id="period-day" autocomplete="off" value="day"> <label class="btn btn-sm btn-outline-secondary" for="period-day">Day</label> <input type="radio" class="btn-check" name="period" id="period-week" autocomplete="off" value="week" checked> <label class="btn btn-sm btn-outline-secondary" for="period-week">Week</label> <input type="radio" class="btn-check" name="period" id="period-month" autocomplete="off" value="month"> <label class="btn btn-sm btn-outline-secondary" for="period-month">Month</label> </div>
                         </div>
                          <div class="col-md"> <label for="report-start-date" class="form-label">Start Date:</label> <input type="date" class="form-control form-control-sm" id="report-start-date" name="startDate" required> </div>
                          <div class="col-md"> <label for="report-end-date" class="form-label">End Date:</label> <input type="date" class="form-control form-control-sm" id="report-end-date" name="endDate" required> </div>
                          <div class="col-md-auto"> <button type="submit" class="btn btn-sm btn-primary w-100"> <i class="fas fa-sync-alt me-1"></i> Update Report </button> </div>
                     </div>
                 </form>
             </div>

             <!-- Charts Section -->
             <div class="row g-4 mx-3"> <!-- Add margin -->
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Task Completion Rate (%)</p> <canvas id="taskCompletionChart"></canvas> </div> </div>
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Overdue Tasks Count</p> <canvas id="overdueTasksChart"></canvas> </div> </div>
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Files Uploaded by Employee</p> <canvas id="filesUploadedChart"></canvas> </div> </div>
                 <div class="col-lg-12"> <div class="chart-container" style="height: 400px;"> <p class="chart-title">Employee Performance Comparison</p> <canvas id="performanceComparisonChart"></canvas> </div> </div>
             </div>

             <!-- Employee Summary Table Section -->
             <div class="ra-table-container">
                  <h5><i class="fas fa-users me-2"></i> Employee Performance Summary</h5> <!-- Headline Added -->
                  <div class="table-responsive">
                     <table class="table table-sm table-hover table-striped align-middle ra-table" id="employeeSummaryTable">
                         <thead> <tr> <th>Employee</th> <th class="text-center">Tasks Completed (%)</th> <th class="text-center">Overdue Tasks</th> <th class="text-center">Files Uploaded</th> <th class="text-center">Activity Score</th> </tr> </thead>
                         <tbody id="employeeSummaryTableBody"> <tr><td colspan="5" class="text-center p-4 text-muted"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div><span class="ms-2">Loading employee data...</span></td></tr> </tbody>
                     </table>
                  </div>
             </div>
        </div> <!-- End #reports-analytics-section -->
         <script>
             function initializeReportsAnalyticsFeature(container) {
                 console.log("Initializing Reports & Analytics Feature..."); // Debug log
                 // --- Scoped Selectors ---
                 const sectionContainer = container.querySelector('#reports-analytics-section');
                 if (!sectionContainer) { console.error("Reports main container not found"); return { cleanup: () => {} }; }
                 const filterForm = sectionContainer.querySelector('#reports-filter-form');
                 const startDateInput = sectionContainer.querySelector('#report-start-date');
                 const endDateInput = sectionContainer.querySelector('#report-end-date');
                 const periodBtnGroup = sectionContainer.querySelector('#periodBtnGroup');
                 const tableBody = sectionContainer.querySelector('#employeeSummaryTableBody');
                 const exportPdfBtn = sectionContainer.querySelector('#exportPdfBtn');
                 const exportExcelBtn = sectionContainer.querySelector('#exportExcelBtn');
                 const taskCompletionChartEl = sectionContainer.querySelector('#taskCompletionChart');
                 const overdueTasksChartEl = sectionContainer.querySelector('#overdueTasksChart');
                 const filesUploadedChartEl = sectionContainer.querySelector('#filesUploadedChart');
                 const performanceComparisonChartEl = sectionContainer.querySelector('#performanceComparisonChart');

                 if (!filterForm || !startDateInput || !endDateInput || !tableBody || !taskCompletionChartEl || !overdueTasksChartEl || !filesUploadedChartEl || !performanceComparisonChartEl) {
                     console.error("Essential Reports & Analytics elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 // --- Sample Data & State ---
                 const employeePerformanceData = [ { id: 1, name: "Mohamed Elmenisy", tasksCompleted: 85, tasksOverdue: 3, filesUploaded: 15, activityScore: 9.2, performanceMetrics: [8.5, 9, 7, 9.2, 8.4] }, { id: 3, name: "Yousef Ahmed", tasksCompleted: 70, tasksOverdue: 8, filesUploaded: 8, activityScore: 7.5, performanceMetrics: [7, 6, 6, 7.5, 6.6] }, { id: 4, name: "Esraa Lashin", tasksCompleted: 45, tasksOverdue: 12, filesUploaded: 5, activityScore: 6.1, performanceMetrics: [4.5, 5, 5, 6.1, 5.1] }, { id: 5, name: "Bassant Badr", tasksCompleted: 91, tasksOverdue: 2, filesUploaded: 18, activityScore: 9.5, performanceMetrics: [9.1, 9.5, 8, 9.5, 9.0] }, ];
                 let currentFilteredData = [...employeePerformanceData];
                 let taskCompletionChartInstance = null; let overdueTasksChartInstance = null; let filesUploadedChartInstance = null; let performanceComparisonChartInstance = null;
                 let listeners = [];

                 // --- Utility Functions ---
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 function formatDateInput(date) { const d = new Date(date); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const year = d.getFullYear(); return `${year}-${month}-${day}`; }
                 function formatReportDate(dateString) { if (!dateString) return 'N/A'; const parts = dateString.split('-'); if (parts.length === 3) { return `${parts[1]}/${parts[2]}/${parts[0]}`; } return dateString; }
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                 const rgbaColor = (c, alpha) => { try { if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; } catch(e) { console.warn("Could not parse color for rgba:", c); return 'rgba(0,0,0,0.1)'; } };
                 const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };

                 // --- Chart Rendering ---
                 function renderTaskCompletionChart(data) { const ctx = taskCompletionChartEl.getContext('2d'); if (!ctx) return; const avgCompletion = data.length > 0 ? Math.round(data.reduce((sum, emp) => sum + emp.tasksCompleted, 0) / data.length) : 0; const chartData = { labels: ['Completed', 'Remaining'], datasets: [{ data: [avgCompletion, 100 - avgCompletion], backgroundColor: [ getCssVar('--chart-green'), getCssVar('--light-gray')], borderColor: [getCssVar('--white')], borderWidth: 2 }] }; if (taskCompletionChartInstance) taskCompletionChartInstance.destroy(); taskCompletionChartInstance = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` } } } } }); }
                 function renderOverdueTasksChart(data) { const ctx = overdueTasksChartEl.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const overdueData = data.map(emp => emp.tasksOverdue); if (overdueTasksChartInstance) overdueTasksChartInstance.destroy(); overdueTasksChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Overdue Tasks', data: overdueData, backgroundColor: getCssVar('--chart-red'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 2, color: getCssVar('--text-muted') } }, x: { ticks: { color: getCssVar('--text-muted') } } }, plugins: { legend: { display: false } } } }); }
                 function renderFilesUploadedChart(data) { const ctx = filesUploadedChartEl.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const filesData = data.map(emp => emp.filesUploaded); if (filesUploadedChartInstance) filesUploadedChartInstance.destroy(); filesUploadedChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Files Uploaded', data: filesData, backgroundColor: getCssVar('--chart-blue'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { color: getCssVar('--text-muted') } }, y: { ticks: { color: getCssVar('--text-muted') } } }, plugins: { legend: { display: false } } } }); }
                 function renderPerformanceComparisonChart(data) { const ctx = performanceComparisonChartEl.getContext('2d'); if (!ctx) return; const labels = ['Completion', 'Timeliness', 'Files Mgmt', 'Activity', 'Overall Score']; const datasets = data.map((emp, index) => { const metricsData = emp.performanceMetrics || [ emp.tasksCompleted / 10, 10 - (emp.tasksOverdue / 2), emp.filesUploaded / 2, emp.activityScore, ((emp.tasksCompleted / 10) + (10 - (emp.tasksOverdue / 2)) + (emp.filesUploaded / 2) + emp.activityScore) / 4]; const clampedData = metricsData.map(score => Math.max(0, Math.min(10, score || 0))); const colors = [getCssVar('--chart-blue'), getCssVar('--chart-green'), getCssVar('--chart-purple'), getCssVar('--chart-orange'), getCssVar('--chart-cyan'), getCssVar('--chart-red')]; const color = colors[index % colors.length]; const bgFill = rgbaColor(color, getCssVar('--chart-radar-fill-opacity')); return { label: emp.name, data: clampedData, fill: true, backgroundColor: bgFill, borderColor: color, pointBackgroundColor: color, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: color } }); const pointLabelColor = getCssVar('--text-muted'); if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy(); performanceComparisonChartInstance = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, elements: { line: { borderWidth: 2 } }, scales: { r: { angleLines: { display: true, color: getCssVar('--light-gray')}, grid: { color: getCssVar('--light-gray')}, suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 10 }, color: pointLabelColor }, ticks: { backdropColor: 'rgba(0,0,0,0)', color: pointLabelColor, stepSize: 2 } } }, plugins: { legend: { position: 'top', labels: { color: getCssVar('--text-muted') } } } } }); }

                 // --- Table Rendering ---
                 function renderEmployeeSummaryTable(data) {
                     tableBody.innerHTML = ''; if (!data || data.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted fst-italic">No employee data found.</td></tr>`; return; }
                     data.forEach((emp) => {
                         const row = document.createElement('tr'); let scoreBadgeClass = 'text-bg-secondary'; let scoreText = 'Average'; if (emp.activityScore >= 9) { scoreBadgeClass = 'text-bg-success'; scoreText = 'Excellent'; } else if (emp.activityScore >= 7.5) { scoreBadgeClass = 'text-bg-warning'; scoreText = 'Good'; } else if (emp.activityScore < 6.5) { scoreBadgeClass = 'text-bg-danger'; scoreText = 'Needs Improv.'; }
                         const completion = emp.tasksCompleted; let progressBgClass = ''; let progressTextColor = '#fff'; if (completion >= 80) { progressBgClass = 'bg-progress-high'; } else if (completion >= 50) { progressBgClass = 'bg-progress-medium'; progressTextColor = '#212529'; } else { progressBgClass = 'bg-progress-low'; }
                         row.innerHTML = ` <td><div class="employee-name">${escapeHTML(emp.name)}</div></td> <td class="text-center"> <div class="progress" role="progressbar" aria-label="Completion rate for ${escapeHTML(emp.name)}" aria-valuenow="${completion}" aria-valuemin="0" aria-valuemax="100"> <div class="progress-bar ${progressBgClass}" style="width: ${completion}%; color: ${progressTextColor};"> ${completion}% </div> </div> </td> <td class="text-center"><span class="metric-value ${emp.tasksOverdue === 0 ? 'text-success' : emp.tasksOverdue <= 5 ? 'text-warning' : 'text-danger'}">${emp.tasksOverdue}</span></td> <td class="text-center"><span class="metric-value text-info">${emp.filesUploaded}</span></td> <td class="text-center"><span class="badge ${scoreBadgeClass}">${scoreText}</span></td> `;
                         tableBody.appendChild(row);
                     });
                 }

                 // --- Filtering & Export ---
                 function applyFilters() { const startDate = startDateInput.value; const endDate = endDateInput.value; console.log("Reports: Applying filters for period:", startDate, "to", endDate); currentFilteredData = [...employeePerformanceData]; // Simulate filtering based on dates if needed renderTaskCompletionChart(currentFilteredData); renderOverdueTasksChart(currentFilteredData); renderFilesUploadedChart(currentFilteredData); renderPerformanceComparisonChart(currentFilteredData); renderEmployeeSummaryTable(currentFilteredData); }
                 function setPeriodDates(period) { const today = new Date(); let startDate, endDate = new Date(); switch (period) { case 'day': startDate = new Date(today); break; case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break; case 'week': default: const firstDay = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1); // Adjust to start week on Monday startDate = new Date(new Date(today).setDate(firstDay)); break; } startDateInput.value = formatDateInput(startDate); endDateInput.value = formatDateInput(endDate); applyFilters(); }
                 function generateCsv(tableElement, filename = 'report.csv') { let csv = []; const rows = tableElement.querySelectorAll("thead tr, tbody tr"); for (let i = 0; i < rows.length; i++) { const row = [], cols = rows[i].querySelectorAll("td, th"); for (let j = 0; j < cols.length; j++) { let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/(\s\s)/gm, " ").trim(); if (cols[j].querySelector('.progress')) { const progressBar = cols[j].querySelector('.progress-bar'); data = progressBar ? progressBar.innerText.trim() : '0%'; } data = data.replace(/"/g, '""'); if (data.includes(',')) data = `"${data}"`; row.push(data); } csv.push(row.join(",")); } const csvFile = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" }); const downloadLink = document.createElement("a"); downloadLink.download = filename; downloadLink.href = window.URL.createObjectURL(csvFile); downloadLink.style.display = "none"; document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink); window.showToast('CSV export successful.', 'success'); }
                 function generatePdf(tableElement, filename = 'report.pdf') { if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') { window.showToast('Error: jsPDF library not loaded.', 'error'); return; } const { jsPDF } = jspdf; const doc = new jsPDF({ orientation: 'landscape' }); const startDateValue = startDateInput.value; const endDateValue = endDateInput.value; const startDateFormatted = formatReportDate(startDateValue); const endDateFormatted = formatReportDate(endDateValue); const dateRangeText = `Period: ${startDateFormatted} - ${endDateFormatted}`; const reportTitle = "Employee Performance Report"; doc.setFontSize(16); doc.text(reportTitle, 14, 16); doc.setFontSize(10); doc.setTextColor(100); doc.text(dateRangeText, 14, 22); doc.setTextColor(0); if (typeof doc.autoTable !== 'function') { window.showToast('Error: jsPDF AutoTable plugin not loaded.', 'error'); return; } const head = [['Employee', 'Completion (%)', 'Overdue', 'Files', 'Score']]; const body = []; const rows = tableElement.querySelectorAll("tbody tr"); rows.forEach(row => { const rowData = []; const cells = row.querySelectorAll("td"); rowData.push(cells[0] ? cells[0].innerText.trim() : ''); rowData.push(cells[1] ? cells[1].querySelector('.progress-bar')?.innerText.trim() || '0%' : '0%'); rowData.push(cells[2] ? cells[2].innerText.trim() : '0'); rowData.push(cells[3] ? cells[3].innerText.trim() : '0'); rowData.push(cells[4] ? cells[4].querySelector('.badge')?.innerText.trim() || '' : ''); body.push(rowData); }); const tableStartY = 28; doc.autoTable({ head: head, body: body, startY: tableStartY, theme: 'grid', styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' }, columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 'auto', halign: 'center'}, 2: { cellWidth: 'auto', halign: 'center'}, 3: { cellWidth: 'auto', halign: 'center'}, 4: { cellWidth: 'auto', halign: 'center'} } }); doc.save(filename); window.showToast('PDF export successful.', 'success'); }

                 // --- Initialization & Listeners ---
                 setPeriodDates('week'); // Set initial dates and trigger render
                 addListener(filterForm, 'submit', (event) => { event.preventDefault(); applyFilters(); });
                 addListener(periodBtnGroup, 'change', (event) => { if (event.target.name === 'period') { setPeriodDates(event.target.value); } });
                 addListener(exportPdfBtn, 'click', () => { const table = sectionContainer.querySelector('#employeeSummaryTable'); if (table) { generatePdf(table, `Employee_Summary_${formatDateInput(new Date())}.pdf`); } else { window.showToast('Summary table not found.', 'error'); } });
                 addListener(exportExcelBtn, 'click', () => { const table = sectionContainer.querySelector('#employeeSummaryTable'); if (table) { generateCsv(table, `Employee_Summary_${formatDateInput(new Date())}.csv`); } else { window.showToast('Summary table not found.', 'error'); } });
                 applyFilters(); // Initial Render

                 const cleanup = () => {
                    console.log("Cleaning up Reports & Analytics...");
                    if (taskCompletionChartInstance) taskCompletionChartInstance.destroy(); if (overdueTasksChartInstance) overdueTasksChartInstance.destroy(); if (filesUploadedChartInstance) filesUploadedChartInstance.destroy(); if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy();
                    taskCompletionChartInstance = overdueTasksChartInstance = filesUploadedChartInstance = performanceComparisonChartInstance = null;
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                    console.log("Reports & Analytics cleanup complete.");
                 };
                 return { cleanup };
             }
         </script>
    </template>

    <!-- Template for Employee Scheduling -->
    <template id="employeeSchedulingAssets">
        <style id="injected-employee-scheduling-styles">
            /* Base styles are in main CSS. Add specific overrides if needed */
            #featureSectionsContainer.employee-scheduling-feature > div:first-child { /* Target the wrapping div */
                background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
            }
            body.dark-theme #featureSectionsContainer.employee-scheduling-feature > div:first-child {
                background-color: var(--light); border-color: var(--light-gray);
            }
        </style>
        <!-- Schedule Container (Outer wrapper for styling) -->
        <div class="schedule-page-container">
            <div class="schedule-page-header d-flex justify-content-between align-items-center mb-4">
                <h2 class="schedule-page-title m-0"><i class="fas fa-user-clock me-2"></i> Employee Schedule</h2>
                <div class="schedule-controls">
                    <div class="week-nav">
                        <button id="prevWeekBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-left me-1"></i> Prev Week</button>
                        <span id="currentWeekDisplay" class="mx-2 fw-bold">Current Week</span>
                        <button id="nextWeekBtn" class="btn btn-sm btn-outline-secondary">Next Week <i class="fas fa-chevron-right ms-1"></i></button>
                    </div>
                    <div class="admin-actions" id="scheduleAdminActions" style="display: none;">
                         <button id="publishScheduleBtn" class="btn btn-sm btn-success">Publish Changes</button>
                         <button id="clearScheduleBtn" class="btn btn-sm btn-danger">Clear Week</button>
                    </div>
                </div>
            </div>
            <div class="schedule-container">
                <table class="schedule-table">
                    <thead id="scheduleThead">
                        <!-- Header row generated by JS -->
                    </thead>
                    <tbody id="scheduleTableBody">
                        <!-- Schedule rows generated by JS -->
                        <tr><td colspan="8" class="text-center p-5 text-muted">Loading schedule...</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- Shift Edit Modal (Example - use generic modal if preferred) -->
            <div class="modal" id="shiftEditModal">
                 <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Shift</h5>
                        <button class="close-modal" data-close-modal>&times;</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Employee:</strong> <span id="editShiftEmployeeName"></span></p>
                        <p><strong>Date:</strong> <span id="editShiftDate"></span></p>
                        <div class="form-group">
                             <label for="shiftTypeSelect">Select Shift:</label>
                             <select id="shiftTypeSelect" class="form-select">
                                <option value="M">Morning (M)</option>
                                <option value="A">Afternoon (A)</option>
                                <option value="N">Night (N)</option>
                                <option value="OFF">OFF</option>
                                <option value="SICK">Sick (SICK)</option>
                                <option value="VAC">Vacation (VAC)</option>
                            </select>
                         </div>
                    </div>
                     <div class="modal-footer form-actions">
                         <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                         <button type="button" id="saveShiftBtn" class="btn btn-primary">Save Shift</button>
                     </div>
                </div>
            </div>
        </div>
         <script>
            function initializeEmployeeScheduleLogic(container) {
                 console.log("Initializing Employee Schedule Logic...");
                 const scheduleContainer = container.querySelector('.schedule-page-container');
                 if (!scheduleContainer) { console.error("Schedule page container not found!"); return { cleanup: () => {} }; }
                 const thead = scheduleContainer.querySelector('#scheduleThead');
                 const tbody = scheduleContainer.querySelector('#scheduleTableBody');
                 const prevWeekBtn = scheduleContainer.querySelector('#prevWeekBtn');
                 const nextWeekBtn = scheduleContainer.querySelector('#nextWeekBtn');
                 const currentWeekDisplay = scheduleContainer.querySelector('#currentWeekDisplay');
                 const adminActions = scheduleContainer.querySelector('#scheduleAdminActions');
                 const publishBtn = scheduleContainer.querySelector('#publishScheduleBtn');
                 const clearBtn = scheduleContainer.querySelector('#clearScheduleBtn');
                 const shiftEditModalEl = document.getElementById('shiftEditModal'); // Global modal
                 const shiftEditModalInstance = shiftEditModalEl ? new bootstrap.Modal(shiftEditModalEl) : null;
                 const employeeNameSpan = shiftEditModalEl?.querySelector('#editShiftEmployeeName');
                 const dateSpan = shiftEditModalEl?.querySelector('#editShiftDate');
                 const shiftTypeSelect = shiftEditModalEl?.querySelector('#shiftTypeSelect');
                 const saveShiftBtn = shiftEditModalEl?.querySelector('#saveShiftBtn');

                 if (!thead || !tbody || !prevWeekBtn || !nextWeekBtn || !currentWeekDisplay) {
                     console.error("Essential schedule elements missing!");
                     if(tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-danger">Error loading schedule components.</td></tr>';
                     return { cleanup: () => {} };
                 }

                 let listeners = []; const addListener = (element, event, handler) => { if (!element) return; element.addEventListener(event, handler); listeners.push({ element, event, handler }); };
                 let scheduleData = JSON.parse(localStorage.getItem('employeeScheduleDataV1')) || {}; // { 'empId-weekOffset-dayIndex': 'shiftCode' }
                 let weekOffset = 0; // 0 is the current week
                 let currentEditTarget = null; // { empId, dayIndex, weekOffset }

                 function getWeekStartDate(offset = 0) { const today = new Date(); const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon,... const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday as start const monday = new Date(today.setDate(diff)); monday.setDate(monday.getDate() + (offset * 7)); return monday; }
                 function getWeekDates(offset = 0) { const start = getWeekStartDate(offset); const dates = []; for (let i = 0; i < 7; i++) { const date = new Date(start); date.setDate(start.getDate() + i); dates.push(date); } return dates; }
                 const formatHeaderDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                 const formatDateKey = (date) => date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                 const getShiftClass = (shiftCode) => { switch (shiftCode) { case 'M': return 'shift-morning'; case 'A': return 'shift-afternoon'; case 'N': return 'shift-night'; case 'OFF': return 'shift-off'; case 'SICK': return 'shift-sick'; case 'VAC': return 'shift-vacation'; default: return ''; } };
                 const getShiftDisplay = (shiftCode) => { switch (shiftCode) { case 'M': return 'Morning'; case 'A': return 'Afternoon'; case 'N': return 'Night'; case 'OFF': return 'OFF'; case 'SICK': return 'Sick'; case 'VAC': return 'Vacation'; default: return '-'; } };

                 function renderSchedule(offset) {
                     weekOffset = offset; // Update global offset
                     const dates = getWeekDates(offset);
                     const weekStartStr = formatHeaderDate(dates[0]); const weekEndStr = formatHeaderDate(dates[6]);
                     currentWeekDisplay.textContent = `${weekStartStr} - ${weekEndStr}`;
                     // Render Header
                     thead.innerHTML = ''; const headerRow = thead.insertRow(); headerRow.insertCell().outerHTML = '<th scope="col">Employee</th>'; dates.forEach((date, index) => { const th = document.createElement('th'); th.scope = 'col'; const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }); const dayDate = date.getDate(); const isWeekend = date.getDay() === 0 || date.getDay() === 6; if (isWeekend) th.classList.add('weekend-header'); th.innerHTML = `<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${dayDate}</span></div>`; headerRow.appendChild(th); });
                     // Render Body
                     tbody.innerHTML = ''; const employees = window.MOCK_USERS || []; if (employees.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-muted">No employees found. Add team members in settings.</td></tr>'; return; }
                     employees.forEach(emp => { const row = tbody.insertRow(); row.insertCell().outerHTML = `<td class="employee-name">${escapeHTML(emp.name)}</td>`; dates.forEach((date, dayIndex) => { const cell = row.insertCell(); const dataKey = `${emp.id}-${offset}-${dayIndex}`; const shiftCode = scheduleData[dataKey]; const isWeekend = date.getDay() === 0 || date.getDay() === 6; if (isWeekend) cell.classList.add('weekend-cell'); if (!shiftCode && isWeekend) { cell.innerHTML = `<span class="shift shift-weekend-off">Weekend</span>`; } else { const shiftClass = getShiftClass(shiftCode); cell.innerHTML = `<span class="shift ${shiftClass} ${window.currentUser?.role === 'admin' ? 'editable' : ''}" data-emp-id="${emp.id}" data-day-index="${dayIndex}" data-week-offset="${offset}" data-date-key="${formatDateKey(date)}" title="${window.currentUser?.role === 'admin' ? 'Click to edit' : ''}">${getShiftDisplay(shiftCode)}</span>`; } }); });
                 }
                 function saveScheduleData() { localStorage.setItem('employeeScheduleDataV1', JSON.stringify(scheduleData)); }

                 // Event Listeners
                 addListener(prevWeekBtn, 'click', () => renderSchedule(weekOffset - 1));
                 addListener(nextWeekBtn, 'click', () => renderSchedule(weekOffset + 1));
                 addListener(tbody, 'click', (e) => { if (window.currentUser?.role !== 'admin' || !e.target.classList.contains('editable')) return; const shiftSpan = e.target; currentEditTarget = { empId: shiftSpan.dataset.empId, dayIndex: shiftSpan.dataset.dayIndex, weekOffset: shiftSpan.dataset.weekOffset, dateKey: shiftSpan.dataset.dateKey }; const empName = window.MOCK_USERS.find(u => u.id == currentEditTarget.empId)?.name || 'Unknown'; const dateStr = formatDate(new Date(currentEditTarget.dateKey)); if (employeeNameSpan) employeeNameSpan.textContent = empName; if (dateSpan) dateSpan.textContent = dateStr; const currentShiftKey = `${currentEditTarget.empId}-${currentEditTarget.weekOffset}-${currentEditTarget.dayIndex}`; if (shiftTypeSelect) shiftTypeSelect.value = scheduleData[currentShiftKey] || 'OFF'; shiftEditModalInstance?.show(); });
                 addListener(saveShiftBtn, 'click', () => { if (!currentEditTarget || !shiftTypeSelect) return; const newShiftCode = shiftTypeSelect.value; const dataKey = `${currentEditTarget.empId}-${currentEditTarget.weekOffset}-${currentEditTarget.dayIndex}`; scheduleData[dataKey] = newShiftCode; saveScheduleData(); renderSchedule(weekOffset); // Re-render current week shiftEditModalInstance?.hide(); window.showToast('Shift updated.', 'success'); });
                 // Add listener for modal close buttons handled by main script
                 if(adminActions) adminActions.style.display = window.currentUser?.role === 'admin' ? 'flex' : 'none';
                 addListener(publishBtn, 'click', () => window.showToast('Schedule published (simulated).', 'success'));
                 addListener(clearBtn, 'click', () => { window.showConfirmModal('Clear Week Schedule', `Clear all shifts for ${currentWeekDisplay.textContent}?`, () => { const keysToDelete = Object.keys(scheduleData).filter(key => key.split('-')[1] == weekOffset); keysToDelete.forEach(key => delete scheduleData[key]); saveScheduleData(); renderSchedule(weekOffset); window.showToast('Week schedule cleared.', 'success'); }, 'btn-danger'); });

                 renderSchedule(0); // Initial render

                 const cleanup = () => {
                     console.log("Cleaning up Employee Schedule...");
                      listeners.forEach(({ element, event, handler }) => { element?.removeEventListener(event, handler); }); listeners = [];
                     shiftEditModalInstance?.hide(); // Ensure modal is hidden
                     console.log("Employee Schedule cleanup complete.");
                 };
                 window.renderSchedule = renderSchedule; // Expose for potential cross-feature interaction (e.g., profile update)
                 return { cleanup };
            }
        </script>
    </template>

    <!-- Template for Team Members View -->
    <template id="teamMembersAssets">
        <style id="injected-team-members-view-styles">
             /* Specific styles for team members view */
             #featureSectionsContainer.team-members-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.team-members-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
             #featureSectionsContainer.team-members-feature .team-members-section { padding: 0; }
             #featureSectionsContainer.team-members-feature .team-members-section-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background-color: var(--feature-team-title-bg); border-bottom: 1px solid var(--feature-team-border-color); border-radius: 8px 8px 0 0; flex-wrap: wrap; gap: 1rem; }
             #featureSectionsContainer.team-members-feature .team-members-section-header h2 { font-size: 1.5rem; font-weight: 600; color: var(--feature-team-title-text); margin: 0; }
             #featureSectionsContainer.team-members-feature .team-filter { display: flex; gap: 0.75rem; align-items: center; max-width: 400px; flex-grow: 1; }
             #featureSectionsContainer.team-members-feature .team-filter input[type="text"] { background-color: var(--white); color: var(--text-color); border: 1px solid var(--feature-team-border-color); padding: 0.6rem 1rem; border-radius: 6px; flex-grow: 1; font-size: 0.9rem; }
             #featureSectionsContainer.team-members-feature .team-filter input[type="text"]::placeholder { color: var(--feature-team-text-secondary); }
             #featureSectionsContainer.team-members-feature .team-filter .btn { flex-shrink: 0; }
             #featureSectionsContainer.team-members-feature .team-content-area { padding: var(--feature-team-section-padding); }
             #featureSectionsContainer.team-members-feature .team-members-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--feature-team-grid-gap); }
             #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--feature-team-card-bg); border-radius: var(--feature-team-card-border-radius); border: 1px solid var(--feature-team-border-color); padding: var(--feature-team-card-padding); box-shadow: 0 2px 4px var(--feature-team-shadow-color); transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; gap: 1rem; align-items: center; }
             #featureSectionsContainer.team-members-feature .team-member-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px var(--feature-team-hover-shadow-color); }
             #featureSectionsContainer.team-members-feature .member-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.5rem; background-size: cover; background-position: center; flex-shrink: 0; border: 2px solid var(--white); }
             #featureSectionsContainer.team-members-feature .member-info { flex-grow: 1; min-width: 0; }
             #featureSectionsContainer.team-members-feature .member-name { font-size: 1.1rem; font-weight: 600; color: var(--feature-team-text-primary); margin-bottom: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
             #featureSectionsContainer.team-members-feature .member-email { font-size: 0.85rem; color: var(--feature-team-text-secondary); margin-bottom: 0.4rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
             #featureSectionsContainer.team-members-feature .member-role { padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; display: inline-block; text-transform: capitalize; }
             #featureSectionsContainer.team-members-feature .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--feature-team-admin-color); }
             #featureSectionsContainer.team-members-feature .role-senior { background-color: rgba(16, 185, 129, 0.1); color: var(--feature-team-senior-color); }
             #featureSectionsContainer.team-members-feature .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--feature-team-supervisor-color); }
             #featureSectionsContainer.team-members-feature .role-member { background-color: rgba(100, 116, 139, 0.1); color: var(--feature-team-member-color); }
             #featureSectionsContainer.team-members-feature .add-team-member-btn { /* Uses general .btn-primary */ }
        </style>
        <!-- Team Members View Container -->
        <div class="team-members-section">
            <div class="team-members-section-header">
                <h2>Team Members</h2>
                <div class="team-filter">
                    <input type="text" id="teamMemberSearchInput" placeholder="Search by name or email...">
                    <button id="resetTeamMemberSearch" class="btn btn-sm btn-outline-secondary" title="Reset Search"><i class="fas fa-times"></i></button>
                </div>
                 <!-- Add button can be here or elsewhere if needed -->
                 <!-- <button id="addTeamMemberBtn" class="btn btn-sm btn-primary add-team-member-btn"><i class="fas fa-user-plus me-1"></i> Add Member</button> -->
            </div>
            <div class="team-content-area">
                <div class="team-members-list" id="teamMemberListContainer">
                    <!-- Member cards generated by JS -->
                    <p style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--feature-team-text-secondary);">Loading team members...</p>
                </div>
            </div>
        </div>
        <script>
             function initializeTeamMembersFeature(container) {
                 console.log("Initializing Team Members View Feature...");
                 const sectionContainer = container.querySelector('.team-members-section');
                 if (!sectionContainer) { console.error("Team members section container not found!"); return { cleanup: () => {} }; }

                 const memberListContainer = sectionContainer.querySelector('#teamMemberListContainer');
                 const searchInput = sectionContainer.querySelector('#teamMemberSearchInput');
                 const resetBtn = sectionContainer.querySelector('#resetTeamMemberSearch');
                 // const addBtn = sectionContainer.querySelector('#addTeamMemberBtn'); // If add button is needed here

                 if (!memberListContainer || !searchInput || !resetBtn) {
                     console.error("Essential team members view elements missing!");
                     if(memberListContainer) memberListContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--feature-team-text-secondary);">Error loading components.</p>';
                     return { cleanup: () => {} };
                 }

                 let listeners = [];
                 const addListener = (element, event, handler) => { if (!element) return; element.addEventListener(event, handler); listeners.push({ element, event, handler }); };
                 const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };
                 const formatRole = (role) => { if (!role) return 'Member'; return role.charAt(0).toUpperCase() + role.slice(1); }; // Reuse from main

                 function renderTeamMembers(filterTerm = '') {
                     memberListContainer.innerHTML = '';
                     const membersToDisplay = (window.MOCK_USERS || []).filter(member =>
                         !filterTerm ||
                         member.name.toLowerCase().includes(filterTerm) ||
                         member.email.toLowerCase().includes(filterTerm)
                     );

                     if (membersToDisplay.length === 0) {
                         memberListContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--feature-team-text-secondary);">No members found${filterTerm ? ' matching search' : ''}.</p>`;
                         return;
                     }

                     membersToDisplay.sort((a,b) => a.name.localeCompare(b.name)); // Sort alphabetically

                     membersToDisplay.forEach(member => {
                         const card = document.createElement('div');
                         card.classList.add('team-member-card');
                         card.dataset.id = member.id;

                         const avatarStyle = member.avatar ? `background-image: url('${escapeHTML(member.avatar)}');` : '';
                         const avatarContent = member.avatar ? '' : escapeHTML(member.initials);

                         card.innerHTML = `
                            <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div class="member-info">
                                <h4 class="member-name">${escapeHTML(member.name)}</h4>
                                <p class="member-email">${escapeHTML(member.email)}</p>
                                <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                            </div>
                         `;
                         // Add action buttons if needed in this view (e.g., View Profile link)
                         // card.innerHTML += `<div class="member-actions-view"><button class="btn btn-sm btn-outline">View</button></div>`;
                         memberListContainer.appendChild(card);
                     });
                 }

                 const handleSearch = () => {
                     const term = searchInput.value.toLowerCase().trim();
                     renderTeamMembers(term);
                 };

                 const handleReset = () => {
                     searchInput.value = '';
                     renderTeamMembers();
                 };

                 // Event Listeners
                 addListener(searchInput, 'input', handleSearch);
                 addListener(resetBtn, 'click', handleReset);
                 // Add listener for Add Button if it exists here
                 // addListener(addBtn, 'click', () => openMemberModal()); // Assumes openMemberModal is global

                 // Initial Render
                 renderTeamMembers();

                 const cleanup = () => {
                     console.log("Cleaning up Team Members View...");
                     listeners.forEach(({ element, event, handler }) => {
                         element?.removeEventListener(event, handler);
                     });
                     listeners = [];
                     console.log("Team Members View cleanup complete.");
                 };
                 return { cleanup };
             }
        </script>
    </template>

     <!-- Template for Projects View -->
    <template id="projectsAssets">
         <style id="injected-projects-view-styles">
             /* Scoped styles for Projects View */
             #featureSectionsContainer.projects-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.projects-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
             #featureSectionsContainer.projects-feature #projects-section { padding: 0; } /* Remove padding from inner section */
             #featureSectionsContainer.projects-feature .projects-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background-color: var(--feature-projects-body-bg); border-bottom: 1px solid var(--feature-projects-border-color); border-radius: 8px 8px 0 0; flex-wrap: wrap; gap: 1rem; }
             #featureSectionsContainer.projects-feature .projects-title-wrapper { flex-shrink: 0; display: flex; align-items: center; gap: 0.75rem; /* No background/border needed */ }
             #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { font-size: 1.5rem; font-weight: 600; color: var(--feature-projects-heading-color); margin: 0; }
             #featureSectionsContainer.projects-feature .projects-title-wrapper i { color: var(--feature-projects-primary-color); font-size: 1.5rem; }
             #featureSectionsContainer.projects-feature .project-controls { display: flex; gap: 1rem; align-items: center; flex-grow: 1; justify-content: flex-end; flex-wrap: wrap; }
             #featureSectionsContainer.projects-feature .project-search-input { max-width: 300px; flex-grow: 1; }
             #featureSectionsContainer.projects-feature .project-filter-select { max-width: 200px; flex-grow: 1; }
             #featureSectionsContainer.projects-feature .add-project-btn { flex-shrink: 0; }
             #featureSectionsContainer.projects-feature .projects-content-area { padding: var(--feature-team-section-padding, 1.5rem); } /* Consistent padding */
             #featureSectionsContainer.projects-feature .projects-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--feature-team-grid-gap, 1.5rem); }
             #featureSectionsContainer.projects-feature .project-card { background-color: var(--feature-projects-card-bg); border-radius: var(--feature-team-card-border-radius, 12px); border: 1px solid var(--feature-projects-border-color); box-shadow: var(--feature-projects-shadow-color) 0px 2px 4px; transition: transform 0.2s ease, box-shadow 0.2s ease; overflow: hidden; display: flex; flex-direction: column; }
             #featureSectionsContainer.projects-feature .project-card:hover { transform: translateY(-3px); box-shadow: var(--feature-projects-shadow-hover-color) 0px 5px 10px; }
             #featureSectionsContainer.projects-feature .project-card-image { height: 180px; background-size: cover; background-position: center; }
             #featureSectionsContainer.projects-feature .project-card-body { padding: var(--feature-team-card-padding, 1.25rem); display: flex; flex-direction: column; flex-grow: 1; }
             #featureSectionsContainer.projects-feature .project-name { font-size: 1.3em; font-weight: 600; color: var(--feature-projects-heading-color); margin-bottom: 0.5rem; word-break: break-word; }
             #featureSectionsContainer.projects-feature .project-status { padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; display: inline-block; margin-bottom: 0.75rem; }
             #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
             #featureSectionsContainer.projects-feature .status-in-progress, #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
             #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
             #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--feature-projects-progress-bar-bg); border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 1rem; width: 100%; }
             #featureSectionsContainer.projects-feature .progress-bar { height: 100%; background-color: var(--feature-projects-primary-color); border-radius: 10px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; font-size: 0.7rem; color: white; padding-right: 5px; }
             #featureSectionsContainer.projects-feature .project-info { font-size: 0.85em; color: var(--feature-projects-text-muted); margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem; }
             #featureSectionsContainer.projects-feature .project-info i { margin-top: 3px; flex-shrink: 0; color: var(--feature-projects-text-muted); width: 14px; text-align: center;}
             #featureSectionsContainer.projects-feature .project-participants .participant-list { display: flex; flex-wrap: wrap; gap: 4px; }
             #featureSectionsContainer.projects-feature .project-participants span { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
             #featureSectionsContainer.projects-feature .project-dates { /* Already styled by .project-info */ }
             #featureSectionsContainer.projects-feature .project-actions { margin-top: auto; /* Push actions to bottom */ padding-top: 1rem; border-top: 1px solid var(--feature-projects-border-color); display: flex; justify-content: flex-end; gap: 0.5rem; }
             #featureSectionsContainer.projects-feature .project-actions .btn { padding: 0.4rem 0.8rem; font-size: 0.85rem; } /* Use .btn classes */
             #featureSectionsContainer.projects-feature .project-actions .btn-view { /* Uses btn-outline */ }
             #featureSectionsContainer.projects-feature .project-actions .btn-edit { /* Uses btn-outline */ }
             #featureSectionsContainer.projects-feature .project-actions .btn-delete { /* Uses btn-outline-danger */ border-color: var(--danger); color: var(--danger); }
             #featureSectionsContainer.projects-feature .project-actions .btn-delete:hover { background-color: rgba(239, 68, 68, 0.1); }

         </style>
         <!-- Projects View Container -->
         <div id="projects-section">
             <div class="projects-header">
                 <div class="projects-title-wrapper">
                     <i class="fas fa-briefcase"></i>
                     <h2>Projects Overview</h2>
                 </div>
                 <div class="project-controls">
                     <input type="text" id="projectSearchInputFeature" class="form-control form-control-sm project-search-input" placeholder="Search projects...">
                     <select id="projectFilterSelectFeature" class="form-select form-select-sm project-filter-select">
                         <option value="all" selected>All Statuses</option>
                         <option value="active">Active</option>
                         <option value="in-progress">In Progress</option>
                         <option value="pending">Pending</option>
                         <option value="completed">Completed</option>
                     </select>
                     <button id="addProjectBtnFeature" class="btn btn-primary btn-sm add-project-btn"><i class="fas fa-plus"></i> Add Project</button>
                 </div>
             </div>
             <div class="projects-content-area">
                 <div class="projects-list" id="projectsListContainerFeature">
                     <!-- Project cards generated by JS -->
                     <p style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--feature-projects-text-muted);">Loading projects...</p>
                 </div>
             </div>
         </div>
         <script>
              // Definition moved to main script block and renamed to avoid conflicts
             // function initializeProjectsFeature(container) { ... }
         </script>
    </template>

    <!-- NEW: Template for Data Management -->
    <template id="dataManagementAssets">
        <style id="injected-data-management-styles">
             /* Scoped variables */
             #featureSectionsContainer.data-management-feature {
                 --app-primary: var(--feature-data-management-primary); --app-secondary: var(--feature-data-management-secondary); --app-success: var(--feature-data-management-success); --app-danger: var(--feature-data-management-danger); --app-warning: var(--feature-data-management-warning); --app-info: var(--feature-data-management-info); --app-light: var(--feature-data-management-light); --app-dark: var(--feature-data-management-dark); --app-hover-bg: var(--feature-data-management-hover-bg); --app-header-bg: var(--feature-data-management-header-bg); --dm-border-color: var(--feature-data-management-border-color); --dm-table-hover: var(--feature-data-management-table-hover); --dm-status-active-bg: var(--feature-data-management-status-active-bg); --dm-status-active-text: var(--feature-data-management-status-active-text); --dm-status-pending-bg: var(--feature-data-management-status-pending-bg); --dm-status-pending-text: var(--feature-data-management-status-pending-text); --dm-status-inactive-bg: var(--feature-data-management-status-inactive-bg); --dm-status-inactive-text: var(--feature-data-management-status-inactive-text);
             }
            #featureSectionsContainer.data-management-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--light-gray);
             }
             body.dark-theme #featureSectionsContainer.data-management-feature > div:first-child {
                 background-color: var(--light); border-color: var(--light-gray);
             }
             #featureSectionsContainer.data-management-feature .dm-fancy-title { background: var(--app-header-bg); color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; }
             #featureSectionsContainer.data-management-feature .dm-fancy-title i { margin-right: 10px; }
             #featureSectionsContainer.data-management-feature .dm-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 1rem; }
             #featureSectionsContainer.data-management-feature .dm-actions { display: flex; align-items: center; flex-wrap: wrap; gap: 0.6rem; }
             #featureSectionsContainer.data-management-feature .dm-actions .dm-add-btn { /* Uses btn-primary */ }
             #featureSectionsContainer.data-management-feature .dm-actions .dm-import-btn { /* Uses btn-success */ }
             #featureSectionsContainer.data-management-feature .dm-actions .dm-export-btn { /* Uses btn-warning */ }
             #featureSectionsContainer.data-management-feature .dm-search-filter { display: flex; align-items: center; flex-grow: 1; min-width: 250px; flex-wrap: wrap; gap: 0.6rem; }
             #featureSectionsContainer.data-management-feature .dm-search-filter input, #featureSectionsContainer.data-management-feature .dm-search-filter select { height: auto; padding: 0.5rem 0.75rem; font-size: 0.9rem; }
             #featureSectionsContainer.data-management-feature .dm-table-container { overflow-x: auto; }
             #featureSectionsContainer.data-management-feature .dm-table { width: 100%; border-collapse: collapse; margin-bottom: 1.25rem; background-color: transparent; }
             #featureSectionsContainer.data-management-feature .dm-table th, #featureSectionsContainer.data-management-feature .dm-table td { padding: 0.85rem 1rem; text-align: left; border-bottom: 1px solid var(--dm-border-color); white-space: nowrap; color: var(--text-color); }
             #featureSectionsContainer.data-management-feature .dm-table thead th { background-color: var(--app-light); font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-table thead th { background-color: var(--primary-light) !important; color: var(--text-muted) !important; border-bottom-color: var(--light-gray) !important; }
             #featureSectionsContainer.data-management-feature .dm-table th:first-child, #featureSectionsContainer.data-management-feature .dm-table td:first-child { width: 1%; white-space: nowrap; text-align: center; }
             #featureSectionsContainer.data-management-feature .dm-table td:last-child { white-space: nowrap; width: 1%; text-align: center; }
             #featureSectionsContainer.data-management-feature .dm-table tbody tr:hover { background-color: var(--dm-table-hover); }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-table tbody tr:hover { background-color: var(--primary-light); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-status { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; text-transform: capitalize; display: inline-block; text-align: center; min-width: 70px; }
             #featureSectionsContainer.data-management-feature .dm-table .dm-status-active { background-color: var(--dm-status-active-bg); color: var(--dm-status-active-text); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-status-pending { background-color: var(--dm-status-pending-bg); color: var(--dm-status-pending-text); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-status-inactive { background-color: var(--dm-status-inactive-bg); color: var(--dm-status-inactive-text); }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-table .dm-status-active { background-color: var(--feature-data-management-status-active-bg); color: var(--feature-data-management-status-active-text); }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-table .dm-status-pending { background-color: var(--feature-data-management-status-pending-bg); color: var(--feature-data-management-status-pending-text); }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-table .dm-status-inactive { background-color: var(--feature-data-management-status-inactive-bg); color: var(--feature-data-management-status-inactive-text); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-row-actions button { background: none; border: none; cursor: pointer; padding: 5px; margin: 0 4px; font-size: 1rem; transition: color 0.2s ease, transform 0.1s ease; color: var(--text-muted); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-row-actions button:active { transform: scale(0.9); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-row-actions .dm-view-btn:hover { color: var(--app-success); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-row-actions .dm-edit-btn:hover { color: var(--app-primary); }
             #featureSectionsContainer.data-management-feature .dm-table .dm-row-actions .dm-delete-btn:hover { color: var(--app-danger); }
             #featureSectionsContainer.data-management-feature .dm-pagination { display: flex; justify-content: center; align-items: center; margin-top: 1.25rem; flex-wrap: wrap; gap: 5px; }
             #featureSectionsContainer.data-management-feature .dm-pagination button, #featureSectionsContainer.data-management-feature .dm-pagination span { padding: 8px 12px; border: 1px solid var(--dm-border-color); background-color: var(--white); border-radius: 4px; font-size: 0.9rem; }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button, body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination span { border-color: var(--light-gray); background-color: var(--light); }
             #featureSectionsContainer.data-management-feature .dm-pagination button { cursor: pointer; transition: background-color 0.2s ease; }
             #featureSectionsContainer.data-management-feature .dm-pagination button:hover:not(:disabled) { background-color: #eee; }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button:hover:not(:disabled) { background-color: var(--light-gray); }
             #featureSectionsContainer.data-management-feature .dm-pagination button:disabled { cursor: not-allowed; opacity: 0.6; background-color: var(--app-light); }
             body.dark-theme #featureSectionsContainer.data-management-feature .dm-pagination button:disabled { background-color: var(--primary-light); }
             #featureSectionsContainer.data-management-feature .dm-pagination span.dm-page-info { border: none; background: none; padding: 8px 5px; color: var(--text-muted);}
             #featureSectionsContainer.data-management-feature .dm-pagination span.dm-current-page { font-weight: bold; }
             #featureSectionsContainer.data-management-feature .dm-table tbody tr.selected-row { background-color: var(--primary-light) !important; }
             /* Modal styles will use dashboard generic .modal */
             #featureSectionsContainer.data-management-feature #view-modal dl { margin: 0; }
             #featureSectionsContainer.data-management-feature #view-modal dt { margin-top: 10px; color: var(--text-muted); }
             #featureSectionsContainer.data-management-feature #view-modal dd { margin-left: 0; margin-bottom: 10px; padding: 5px 8px; background-color: var(--app-light); border: 1px solid var(--dm-border-color); border-radius: 4px; word-wrap: break-word; }
             body.dark-theme #featureSectionsContainer.data-management-feature #view-modal dd { background-color: var(--primary-light); border-color: var(--light-gray); }
             #featureSectionsContainer.data-management-feature #view-modal .dm-status { display: inline-block; }
             /* SweetAlert2 specific styles */
             .swal2-confirm { background-color: var(--success) !important; }
             .swal2-cancel { background-color: var(--danger) !important; }
             body.dark-theme .swal2-popup { background-color: var(--light) !important; color: var(--text-color) !important; }
             body.dark-theme .swal2-title { color: var(--text-color) !important; }
             body.dark-theme .swal2-html-container { color: var(--text-muted) !important; }
        </style>
        <div id="data-management-section"> <!-- Wrapper div -->
            <h2 class="dm-fancy-title"><i class="fas fa-database"></i> Data Management</h2>
             <!-- Toolbar -->
            <div class="dm-toolbar">
                 <div class="dm-search-filter">
                     <input type="search" id="dm-search-input" class="form-control" placeholder="Search data (ID, Name, etc.)...">
                     <select id="dm-filter-status" class="form-select">
                         <option value="">Filter by Status...</option>
                         <option value="active">Active</option>
                         <option value="pending">Pending</option>
                         <option value="inactive">Inactive</option>
                     </select>
                     <select id="dm-filter-responsible" class="form-select">
                         <option value="">Filter by Responsible...</option>
                         <!-- Options added by JS -->
                     </select>
                 </div>
                 <div class="dm-actions">
                     <button id="dm-add-new-btn" class="btn btn-sm btn-primary dm-add-btn"><i class="fas fa-plus"></i> Add New</button>
                     <button id="dm-import-btn" class="btn btn-sm btn-success dm-import-btn"><i class="fas fa-file-import"></i> Import</button>
                     <button id="dm-export-btn" class="btn btn-sm btn-warning dm-export-btn"><i class="fas fa-file-export"></i> Export</button>
                 </div>
            </div>
             <!-- Table Container -->
             <div class="dm-table-container">
                 <table class="dm-table" id="dm-data-table">
                     <thead> <tr> <th><input type="checkbox" id="dm-select-all" title="Select All"></th> <th>ID</th> <th>Record Name</th> <th>Creation Date</th> <th>Responsible</th> <th>Status</th> <th>Last Updated</th> <th>Actions</th> </tr> </thead>
                     <tbody id="dm-table-body"> <tr><td colspan="8" style="text-align:center; padding: 20px;">Loading data...</td></tr> </tbody>
                 </table>
             </div>
             <!-- Pagination Controls -->
             <div class="dm-pagination" id="dm-pagination-controls"></div>
        </div> <!-- End #data-management-section -->
        <!-- Add/Edit Modal (Uses Generic Dashboard Modal) -->
        <div class="modal" id="dataManagementModal">
            <div class="modal-content">
                 <div class="modal-header">
                    <h3 class="modal-title" id="dm-modal-title">Add New Record</h3>
                    <button class="close-modal" data-close-modal>&times;</button>
                 </div>
                 <form id="add-edit-form">
                     <input type="hidden" id="edit-record-id">
                     <div class="form-group"> <label for="record-name">Record Name:</label> <input type="text" id="record-name" name="recordName" class="form-control" required> </div>
                     <div class="form-group"> <label for="responsible">Responsible:</label> <select id="responsible" name="responsible" class="form-select" required> <option value="" disabled selected>-- Select Person --</option> <!-- Options added by JS --> </select> </div>
                     <div class="form-group"> <label for="status">Status:</label> <select id="status" name="status" class="form-select" required> <option value="" disabled selected>-- Select Status --</option> <option value="active">Active</option> <option value="pending">Pending</option> <option value="inactive">Inactive</option> </select> </div>
                     <div class="form-actions"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary">Save Record</button> </div>
                 </form>
            </div>
        </div>
         <!-- View Modal (Uses Generic Dashboard Modal) -->
        <div class="modal" id="dataManagementViewModal">
            <div class="modal-content">
                <div class="modal-header">
                     <h3 class="modal-title">Record Details</h3>
                     <button class="close-modal" data-close-modal>&times;</button>
                </div>
                <dl id="view-details" style="margin-top: 1rem;">
                    <dt>ID:</dt><dd id="view-id"></dd>
                    <dt>Record Name:</dt><dd id="view-name"></dd>
                    <dt>Creation Date:</dt><dd id="view-creation-date"></dd>
                    <dt>Responsible:</dt><dd id="view-responsible"></dd>
                    <dt>Status:</dt><dd id="view-status"></dd>
                    <dt>Last Updated:</dt><dd id="view-last-updated"></dd>
                </dl>
                 <div class="form-actions"> <button type="button" class="btn btn-outline" data-close-modal>Close</button> </div>
            </div>
        </div>
        <script>
             function initializeDataManagementFeature(container) {
                 console.log("Initializing Data Management Feature..."); // Debug log
                 const sectionContainer = container.querySelector('#data-management-section');
                 if (!sectionContainer) { console.error("Data Management section container not found!"); return { cleanup: () => {} }; }
                 const tableBody = sectionContainer.querySelector('#dm-table-body');
                 const searchInput = sectionContainer.querySelector('#dm-search-input');
                 const filterStatusSelect = sectionContainer.querySelector('#dm-filter-status');
                 const filterResponsibleSelect = sectionContainer.querySelector('#dm-filter-responsible');
                 const paginationControls = sectionContainer.querySelector('#dm-pagination-controls');
                 const selectAllCheckbox = sectionContainer.querySelector('#dm-select-all');
                 const addNewBtn = sectionContainer.querySelector('#dm-add-new-btn');
                 const importBtn = sectionContainer.querySelector('#dm-import-btn');
                 const exportBtn = sectionContainer.querySelector('#dm-export-btn');
                 const addEditModal = document.getElementById('dataManagementModal');
                 const viewModal = document.getElementById('dataManagementViewModal');
                 const modalTitle = addEditModal?.querySelector('#dm-modal-title');
                 const addEditForm = addEditModal?.querySelector('#add-edit-form');
                 const editRecordIdInput = addEditModal?.querySelector('#edit-record-id');
                 const responsibleSelectModal = addEditModal?.querySelector('#responsible');

                 if (!tableBody || !addEditModal || !viewModal || !addEditForm || !responsibleSelectModal) {
                     console.error("Data Management essential elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 let allData = []; let filteredData = []; let currentPage = 1; const rowsPerPage = 7; // Adjusted for potentially more data
                 let editingRecordId = null; let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };

                 function generateSampleData() { /* Returns sample data (same as before) */ return [ { id: 1001, name: "Client File - Al Amal Co.", creationDate: "2024-05-20", responsible: "Nada Mahmoud", status: "active", lastUpdated: "2024-05-21 10:30" }, { id: 1002, name: "Quarterly Performance Report", creationDate: "2024-05-18", responsible: "Mohamed Elmenisy", status: "pending", lastUpdated: "2024-05-19 14:00" }, { id: 1003, name: "New Product Data (X Headphones)", creationDate: "2024-05-15", responsible: "Yousef Ahmed", status: "active", lastUpdated: "2024-05-16 09:15" }, { id: 1004, name: "Workshop Attendance List", creationDate: "2024-05-12", responsible: "Esraa Lashin", status: "inactive", lastUpdated: "2024-05-13 11:00" }, { id: 1005, name: "Weekly Team Meeting Notes", creationDate: "2024-05-10", responsible: "Bassant Badr", status: "active", lastUpdated: "2024-05-10 16:45" }, { id: 1006, name: "Supplier Contract - Beta Inc.", creationDate: "2024-05-08", responsible: "Nada Mahmoud", status: "active", lastUpdated: "2024-05-09 15:00" }, { id: 1007, name: "Marketing Campaign Plan Q3", creationDate: "2024-05-05", responsible: "Mohamed Elmenisy", status: "pending", lastUpdated: "2024-05-06 11:30" }, { id: 1008, name: "IT Equipment Inventory", creationDate: "2024-05-01", responsible: "Yousef Ahmed", status: "active", lastUpdated: "2024-05-02 17:00" }, { id: 1009, name: "Annual Financial Statement Prep", creationDate: "2024-04-28", responsible: "Bassant Badr", status: "pending", lastUpdated: "2024-05-20 12:00" }, { id: 1010, name: "Website Content Update", creationDate: "2024-04-25", responsible: "Esraa Lashin", status: "active", lastUpdated: "2024-05-18 09:00" }, { id: 1011, name: "Internal Audit Checklist", creationDate: "2024-05-22", responsible: "Nada Mahmoud", status: "pending", lastUpdated: "2024-05-22 15:00" }, { id: 1012, name: "Onboarding Docs - New Hire", creationDate: "2024-05-21", responsible: "Esraa Lashin", status: "active", lastUpdated: "2024-05-21 16:00" }, ]; }
                 function formatDateDM(dateTimeString) { if (!dateTimeString) return 'N/A'; try { const date = new Date(dateTimeString); return window.formatFullDateTime(date); } catch (e) { return dateTimeString; } } // Use global formatter
                 function getCurrentDateTime() { const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); const day = String(now.getDate()).padStart(2, '0'); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); return `${year}-${month}-${day} ${hours}:${minutes}`; }
                 function openModal(modalElement) { modalElement.classList.add('active'); document.body.style.overflow = 'hidden'; }
                 function closeModal(modalElement) { modalElement.classList.remove('active'); document.body.style.overflow = ''; }
                 function populateResponsibleFilters() { const responsibles = [...new Set(allData.map(item => item.responsible || 'Other'))]; filterResponsibleSelect.innerHTML = '<option value="">Filter by Responsible...</option>'; responsibles.sort().forEach(r => filterResponsibleSelect.appendChild(new Option(r, r))); responsibleSelectModal.innerHTML = '<option value="" disabled selected>-- Select Person --</option>'; responsibles.forEach(r => responsibleSelectModal.appendChild(new Option(r, r))); }

                 function renderTable() { tableBody.innerHTML = ''; if(selectAllCheckbox) selectAllCheckbox.checked = false; if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px; color: var(--text-muted);">No matching records found.</td></tr>`; renderPagination(0); return; } const totalItems = filteredData.length; const totalPages = Math.ceil(totalItems / rowsPerPage); if (currentPage > totalPages && totalPages > 0) { currentPage = totalPages; } else if (currentPage < 1) { currentPage = 1; } const startIndex = (currentPage - 1) * rowsPerPage; const endIndex = startIndex + rowsPerPage; const pageData = filteredData.slice(startIndex, endIndex); pageData.forEach(item => { const row = document.createElement('tr'); row.setAttribute('data-id', item.id); const statusClass = `dm-status-${item.status?.toLowerCase() || 'unknown'}`; row.innerHTML = `<td><input type="checkbox" class="dm-row-select" data-id="${item.id}"></td><td>#${item.id}</td><td>${escapeHTML(item.name || 'N/A')}</td><td>${formatDateDM(item.creationDate)}</td><td>${escapeHTML(item.responsible || 'N/A')}</td><td><span class="dm-status ${statusClass}">${escapeHTML(item.status || 'N/A')}</span></td><td>${formatDateDM(item.lastUpdated)}</td><td class="dm-row-actions"><button class="dm-view-btn" title="View Details" data-id="${item.id}"><i class="fas fa-eye fa-fw"></i></button><button class="dm-edit-btn" title="Edit Record" data-id="${item.id}"><i class="fas fa-edit fa-fw"></i></button><button class="dm-delete-btn" title="Delete Record" data-id="${item.id}"><i class="fas fa-trash-alt fa-fw"></i></button></td>`; tableBody.appendChild(row); }); renderPagination(totalItems); attachRowEventListeners(); }
                 function renderPagination(totalItems) { paginationControls.innerHTML = ''; if (totalItems <= rowsPerPage) return; const totalPages = Math.ceil(totalItems / rowsPerPage); const prevButton = document.createElement('button'); prevButton.id = 'dm-prev-page'; prevButton.className = 'btn btn-sm btn-outline-secondary'; prevButton.innerHTML = `<i class="fas fa-chevron-left"></i> Previous`; prevButton.disabled = currentPage === 1; addListener(prevButton, 'click', () => { if (currentPage > 1) { currentPage--; renderTable(); } }); const pageInfo = document.createElement('span'); pageInfo.className = 'dm-page-info'; pageInfo.innerHTML = `Page <span class="dm-current-page">${currentPage}</span> of ${totalPages}`; const nextButton = document.createElement('button'); nextButton.id = 'dm-next-page'; nextButton.className = 'btn btn-sm btn-outline-secondary'; nextButton.innerHTML = `Next <i class="fas fa-chevron-right"></i>`; nextButton.disabled = currentPage === totalPages; addListener(nextButton, 'click', () => { if (currentPage < totalPages) { currentPage++; renderTable(); } }); paginationControls.appendChild(prevButton); paginationControls.appendChild(pageInfo); paginationControls.appendChild(nextButton); }
                 function applyFiltersAndSearch() { const searchTerm = searchInput.value.toLowerCase().trim(); const statusFilterValue = filterStatusSelect.value; const responsibleFilterValue = filterResponsibleSelect.value; let currentData = [...allData]; if (statusFilterValue) { currentData = currentData.filter(item => item.status.toLowerCase() === statusFilterValue); } if (responsibleFilterValue) { currentData = currentData.filter(item => item.responsible === responsibleFilterValue); } if (searchTerm) { currentData = currentData.filter(item => ( item.id.toString().includes(searchTerm) || (item.name && item.name.toLowerCase().includes(searchTerm)) || (item.responsible && item.responsible.toLowerCase().includes(searchTerm)) )); } filteredData = currentData; currentPage = 1; renderTable(); }
                 function attachRowEventListeners() { tableBody.removeEventListener('click', handleTableBodyClick); addListener(tableBody, 'click', handleTableBodyClick); tableBody.querySelectorAll('.dm-row-select').forEach(checkbox => { checkbox.removeEventListener('change', handleRowCheckboxChange); addListener(checkbox, 'change', handleRowCheckboxChange); }); }
                 function handleTableBodyClick(event) { const target = event.target; const viewButton = target.closest('.dm-view-btn'); const editButton = target.closest('.dm-edit-btn'); const deleteButton = target.closest('.dm-delete-btn'); if (viewButton) { handleViewClick(viewButton); } else if (editButton) { handleEditClick(editButton); } else if (deleteButton) { handleDeleteClick(deleteButton); } }
                 function handleRowCheckboxChange(event) { const checkbox = event.target; const row = checkbox.closest('tr'); if (row) { row.classList.toggle('selected-row', checkbox.checked); } const visibleCheckboxes = Array.from(tableBody.querySelectorAll('tr:not([style*="display: none"]) .dm-row-select')); const allVisibleChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked); if(selectAllCheckbox) selectAllCheckbox.checked = allVisibleChecked; }
                 function handleViewClick(button) { const recordId = parseInt(button.getAttribute('data-id')); const record = allData.find(item => item.id === recordId); if (record && viewModal) { viewModal.querySelector('#view-id').textContent = `#${record.id}`; viewModal.querySelector('#view-name').textContent = escapeHTML(record.name || 'N/A'); viewModal.querySelector('#view-creation-date').textContent = formatDateDM(record.creationDate); viewModal.querySelector('#view-responsible').textContent = escapeHTML(record.responsible || 'N/A'); viewModal.querySelector('#view-last-updated').textContent = formatDateDM(record.lastUpdated); const statusDd = viewModal.querySelector('#view-status'); statusDd.innerHTML = ''; if (record.status) { const statusSpan = document.createElement('span'); statusSpan.textContent = escapeHTML(record.status); statusSpan.className = `dm-status dm-status-${record.status.toLowerCase()}`; statusDd.appendChild(statusSpan); } else { statusDd.textContent = 'N/A'; } openModal(viewModal); } }
                 function handleEditClick(button) { editingRecordId = parseInt(button.getAttribute('data-id')); const record = allData.find(item => item.id === editingRecordId); if (record && addEditModal) { modalTitle.textContent = `Edit Record #${record.id}`; editRecordIdInput.value = record.id; addEditModal.querySelector('#record-name').value = record.name || ''; addEditModal.querySelector('#responsible').value = record.responsible || ''; addEditModal.querySelector('#status').value = record.status ? record.status.toLowerCase() : ''; openModal(addEditModal); } }
                 function handleDeleteClick(button) {
                     const recordIdToDelete = parseInt(button.getAttribute('data-id')); const record = allData.find(item => item.id === recordIdToDelete); const recordName = record ? record.name || 'No Name' : 'this item'; const recordIdText = record ? `#${record.id}` : 'this item';
                     window.showConfirmModal(`Delete Record`, `Are you sure you want to delete:<br><strong>${escapeHTML(recordIdText)} (${escapeHTML(recordName)})</strong>`, () => { const initialLength = allData.length; allData = allData.filter(item => item.id !== recordIdToDelete); if (allData.length < initialLength) { window.showToast(`Record ${escapeHTML(recordIdText)} (${escapeHTML(recordName)}) has been deleted.`, 'success'); } else { window.showToast(`Error: Could not find record ${escapeHTML(recordIdText)} to delete.`, 'error'); } applyFiltersAndSearch(); }, 'btn-danger');
                 }

                 allData = generateSampleData(); populateResponsibleFilters(); applyFiltersAndSearch();
                 addListener(searchInput, 'input', applyFiltersAndSearch);
                 addListener(filterStatusSelect, 'change', applyFiltersAndSearch);
                 addListener(filterResponsibleSelect, 'change', applyFiltersAndSearch);
                 addListener(selectAllCheckbox, 'change', () => { const isChecked = selectAllCheckbox.checked; tableBody.querySelectorAll('tr:not([style*="display: none"]) .dm-row-select').forEach(checkbox => { if (checkbox.checked !== isChecked) { checkbox.checked = isChecked; checkbox.dispatchEvent(new Event('change')); } }); });
                 addListener(addNewBtn, 'click', () => { editingRecordId = null; if(modalTitle) modalTitle.textContent = 'Add New Record'; if(addEditForm) addEditForm.reset(); addEditModal.querySelector('#responsible').value = ""; addEditModal.querySelector('#status').value = ""; if(editRecordIdInput) editRecordIdInput.value = ''; openModal(addEditModal); });
                 addListener(addEditForm, 'submit', (event) => { event.preventDefault(); const formData = new FormData(addEditForm); const recordName = formData.get('recordName').trim(); const responsible = formData.get('responsible'); const status = formData.get('status'); const now = getCurrentDateTime(); if (!recordName || !responsible || !status) { window.showToast('Please fill in all required fields (Name, Responsible, Status).', 'error'); return; } if (editingRecordId) { const index = allData.findIndex(item => item.id === editingRecordId); if (index !== -1) { allData[index] = { ...allData[index], name: recordName, responsible: responsible, status: status, lastUpdated: now }; window.showToast(`Record #${editingRecordId} updated successfully!`, 'success'); } else { window.showToast('Error: Could not find record to update.', 'error'); } } else { const newId = allData.length > 0 ? Math.max(...allData.map(item => item.id)) + 1 : 1001; const newRecord = { id: newId, name: recordName, creationDate: now.split(' ')[0], responsible: responsible, status: status, lastUpdated: now }; allData.unshift(newRecord); window.showToast(`Record #${newId} added successfully!`, 'success'); } closeModal(addEditModal); populateResponsibleFilters(); applyFiltersAndSearch(); editingRecordId = null; });

                 // Modal Close Buttons (using delegation on document for generic modals)
                 document.body.addEventListener('click', (event) => { if (event.target.matches('[data-close-modal]')) { const modal = event.target.closest('.modal'); if (modal && (modal.id === 'dataManagementModal' || modal.id === 'dataManagementViewModal')) { closeModal(modal); } } else if (event.target.matches('#dataManagementModal, #dataManagementViewModal')) { closeModal(event.target); } });

                 addListener(importBtn, 'click', () => { window.showToast('Import function simulated. No file processed.', 'info'); });
                 addListener(exportBtn, 'click', () => { const exportData = filteredData.length > 0 ? filteredData : allData; if (exportData.length === 0) { window.showToast('No data available to export.', 'info'); return; } let csvContent = "data:text/csv;charset=utf-8,"; const headers = Object.keys(exportData[0]); csvContent += headers.join(",") + "\r\n"; exportData.forEach(row => { const values = headers.map(header => { let cellValue = row[header] === null || row[header] === undefined ? '' : row[header]; cellValue = String(cellValue).replace(/"/g, '""'); if (String(cellValue).includes(',') || String(cellValue).includes('"') || String(cellValue).includes('\n')) { cellValue = `"${cellValue}"`; } return cellValue; }); csvContent += values.join(",") + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); link.setAttribute("download", `data_export_${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); window.showToast(`Exported ${exportData.length} records as CSV.`, 'success'); });

                 // Make instance methods available if needed globally (optional)
                 window.dataManagementInstance = { renderTable, applyFiltersAndSearch };

                 const cleanup = () => {
                    console.log("Cleaning up Data Management...");
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                     closeModal(addEditModal); closeModal(viewModal); // Ensure modals closed
                     delete window.dataManagementInstance; // Clean up global instance
                     document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = '';
                     console.log("Data Management cleanup complete.");
                 };
                 return { cleanup };
             }
         </script>
    </template>

    <!-- NEW: Template for Deadline Tracker -->
    <template id="deadlineTrackerAssets">
        <style id="injected-deadline-tracker-styles">
             /* Scoped Variables */
             #featureSectionsContainer.deadline-tracker-feature {
                 --app-bg-color: var(--feature-deadline-tracker-bg-color); --app-text-color: var(--feature-deadline-tracker-text-color); --app-card-bg-color: var(--feature-deadline-tracker-card-bg-color); --app-border-color: var(--feature-deadline-tracker-border-color); --app-primary-color: var(--feature-deadline-tracker-primary-color); --app-primary-text-color: var(--feature-deadline-tracker-primary-text-color); --app-secondary-text-color: var(--feature-deadline-tracker-secondary-text-color); --app-hover-bg-color: var(--feature-deadline-tracker-hover-bg-color); --app-icon-color: var(--feature-deadline-tracker-icon-color); --app-shadow-color: var(--feature-deadline-tracker-shadow-color); --app-input-border-color: var(--feature-deadline-tracker-input-border-color); --app-input-bg-color: var(--feature-deadline-tracker-input-bg-color); --app-button-secondary-bg: var(--feature-deadline-tracker-button-secondary-bg); --app-button-secondary-text: var(--feature-deadline-tracker-button-secondary-text); --app-button-secondary-hover-bg: var(--feature-deadline-tracker-button-secondary-hover-bg); --app-button-radius: var(--feature-deadline-tracker-button-radius); --app-card-radius: var(--feature-deadline-tracker-card-radius); --app-status-progress-bg: var(--feature-deadline-tracker-status-progress-bg); --app-status-progress-text: var(--feature-deadline-tracker-status-progress-text); --app-status-completed-bg: var(--feature-deadline-tracker-status-completed-bg); --app-status-completed-text: var(--feature-deadline-tracker-status-completed-text); --app-status-overdue-bg: var(--feature-deadline-tracker-status-overdue-bg); --app-status-overdue-text: var(--feature-deadline-tracker-status-overdue-text); --app-highlight-near-due-bg: var(--feature-deadline-tracker-highlight-near-due-bg); --app-highlight-overdue-bg: var(--feature-deadline-tracker-highlight-overdue-bg); --app-export-excel-bg: var(--feature-deadline-tracker-export-excel-bg); --app-export-pdf-bg: var(--feature-deadline-tracker-export-pdf-bg); --app-export-button-text: var(--feature-deadline-tracker-export-button-text); --app-confirm-overlay-bg: var(--feature-deadline-tracker-confirm-overlay-bg); --app-confirm-yes-bg: var(--feature-deadline-tracker-confirm-yes-bg); --app-confirm-yes-hover-bg: var(--feature-deadline-tracker-confirm-yes-hover-bg); --app-confirm-no-bg: var(--feature-deadline-tracker-confirm-no-bg); --app-confirm-no-hover-bg: var(--feature-deadline-tracker-confirm-no-hover-bg); --app-table-header-bg: var(--feature-deadline-tracker-table-header-bg); --app-table-row-hover-bg: var(--feature-deadline-tracker-table-row-hover-bg); --app-table-border-color: var(--feature-deadline-tracker-table-border-color); --app-transition-speed: 0.2s; --app-animation-fade-duration: 0.4s;
             }
              /* Feature Container */
             #featureSectionsContainer.deadline-tracker-feature { padding: 0; }
             #featureSectionsContainer.deadline-tracker-feature .deadline-tracker-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.75rem; padding: 1.5rem; background-color: transparent; /* Let the feature control its BG if needed */ }
             /* General */
             #featureSectionsContainer.deadline-tracker-feature .card { background-color: var(--app-card-bg-color); padding: 1.5rem; border-radius: var(--app-card-radius); box-shadow: 0 4px 6px -1px var(--app-shadow-color), 0 2px 4px -2px var(--app-shadow-color); border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.deadline-tracker-feature .card h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--app-text-color); }
             #featureSectionsContainer.deadline-tracker-feature label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--app-secondary-text-color); }
             /* Buttons use dashboard styles */
             #featureSectionsContainer.deadline-tracker-feature .button-icon { padding: 0.5em; line-height: 1; font-size: 0.9em; background: none; border: none; color: var(--app-icon-color); }
             #featureSectionsContainer.deadline-tracker-feature .button-icon:hover { background-color: var(--app-hover-bg-color); }
             #featureSectionsContainer.deadline-tracker-feature .button-danger-icon { color: var(--danger); }
             body.dark-theme #featureSectionsContainer.deadline-tracker-feature .button-danger-icon { color: #f87171; }
             #featureSectionsContainer.deadline-tracker-feature .button-danger-icon:hover { background-color: rgba(239, 68, 68, 0.1); }
             #featureSectionsContainer.deadline-tracker-feature .button-export { background-color: var(--app-export-excel-bg); color: var(--app-export-button-text); border: none; }
             #featureSectionsContainer.deadline-tracker-feature .button-export:hover { opacity: 0.9; }
             #featureSectionsContainer.deadline-tracker-feature .button-pdf { background-color: var(--app-export-pdf-bg); color: var(--app-export-button-text); border: none; }
             #featureSectionsContainer.deadline-tracker-feature .button-pdf:hover { opacity: 0.9; }
             /* Header */
             #featureSectionsContainer.deadline-tracker-feature .tracker-header { grid-column: 1 / -1; background: transparent; color: var(--app-text-color); padding: 0.5rem 0; text-align: left; border-bottom: 1px solid var(--app-border-color); margin-bottom: 0.5rem; }
             #featureSectionsContainer.deadline-tracker-feature .tracker-header h1 { font-size: 1.75rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.6rem; }
             #featureSectionsContainer.deadline-tracker-feature .tracker-header h1 i { color: var(--app-primary-color); font-size: 1em; }
             /* Task Input */
             #featureSectionsContainer.deadline-tracker-feature .task-input-container { grid-column: 1 / -1; }
             #featureSectionsContainer.deadline-tracker-feature #task-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem 1.25rem; align-items: flex-end; }
             #featureSectionsContainer.deadline-tracker-feature #task-form button[type="submit"] { grid-column: -1 / -2; justify-self: flex-end; min-width: 120px; }
             /* Main Content Grid */
             #featureSectionsContainer.deadline-tracker-feature .tracker-main-content { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.75rem; }
             /* Controls */
             #featureSectionsContainer.deadline-tracker-feature .tracker-controls { grid-column: span 12 / span 12; display: flex; flex-wrap: wrap; gap: 1.25rem; align-items: flex-end; padding: 1.25rem; background-color: var(--app-card-bg-color); border-radius: var(--app-card-radius); box-shadow: 0 2px 4px var(--app-shadow-color); border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.deadline-tracker-feature .control-group { display: flex; flex-direction: column; gap: 0.4rem; flex-grow: 1; min-width: 160px;}
             #featureSectionsContainer.deadline-tracker-feature .export-buttons { margin-left: auto; display: flex; gap: 0.75rem; align-items: center; }
             #featureSectionsContainer.deadline-tracker-feature .export-buttons button { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.6rem 1rem; font-size: 0.9rem;}
             /* Chart */
             #featureSectionsContainer.deadline-tracker-feature .chart-container { grid-column: span 12 / span 12; min-height: 280px; position: relative; padding: 1.5rem; background-color: var(--app-card-bg-color); border-radius: var(--app-card-radius); box-shadow: 0 2px 4px var(--app-shadow-color); border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.deadline-tracker-feature #task-status-chart { max-height: 320px; }
             /* Tasks Table */
             #featureSectionsContainer.deadline-tracker-feature .tasks-display-area { grid-column: 1 / -1; background-color: var(--app-card-bg-color); border-radius: var(--app-card-radius); box-shadow: 0 4px 6px -1px var(--app-shadow-color), 0 2px 4px -2px var(--app-shadow-color); border: 1px solid var(--app-border-color); overflow-x: auto; }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table { width: 100%; border-collapse: collapse; }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table th, #featureSectionsContainer.deadline-tracker-feature #tasks-table td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid var(--app-table-border-color); vertical-align: middle; white-space: nowrap; color: var(--text-color); }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table th:first-child, #featureSectionsContainer.deadline-tracker-feature #tasks-table td:first-child { white-space: normal; min-width: 200px; }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table thead th { background-color: var(--app-table-header-bg); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em; position: sticky; top: 0; z-index: 1; color: var(--app-secondary-text-color); }
             body.dark-theme #featureSectionsContainer.deadline-tracker-feature #tasks-table thead th { background-color: var(--primary-light); color: var(--text-muted); }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table tbody tr { transition: background-color var(--app-transition-speed) ease; opacity: 0; animation: fadeIn var(--app-animation-fade-duration) ease forwards; }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table tbody tr:hover { background-color: var(--app-table-row-hover-bg); }
             body.dark-theme #featureSectionsContainer.deadline-tracker-feature #tasks-table tbody tr:hover { background-color: var(--primary-light); }
             #featureSectionsContainer.deadline-tracker-feature #tasks-table td { font-size: 0.95rem; }
             /* Status Badge */
             #featureSectionsContainer.deadline-tracker-feature .status-badge { display: inline-block; padding: 0.35em 0.8em; font-size: 0.8rem; font-weight: 500; border-radius: 12px; text-align: center; min-width: 100px; }
             #featureSectionsContainer.deadline-tracker-feature .status-in-progress { background-color: var(--app-status-progress-bg); color: var(--app-status-progress-text); }
             #featureSectionsContainer.deadline-tracker-feature .status-completed { background-color: var(--app-status-completed-bg); color: var(--app-status-completed-text); }
             #featureSectionsContainer.deadline-tracker-feature .status-overdue { background-color: var(--app-status-overdue-bg); color: var(--app-status-overdue-text); }
              body.dark-theme #featureSectionsContainer.deadline-tracker-feature .status-in-progress { background-color: var(--feature-deadline-tracker-status-progress-bg); color: var(--feature-deadline-tracker-status-progress-text); }
              body.dark-theme #featureSectionsContainer.deadline-tracker-feature .status-completed { background-color: var(--feature-deadline-tracker-status-completed-bg); color: var(--feature-deadline-tracker-status-completed-text); }
              body.dark-theme #featureSectionsContainer.deadline-tracker-feature .status-overdue { background-color: var(--feature-deadline-tracker-status-overdue-bg); color: var(--feature-deadline-tracker-status-overdue-text); }
             #featureSectionsContainer.deadline-tracker-feature td .duration { font-size: 0.85em; color: var(--app-secondary-text-color); }
             /* Highlighting */
             #featureSectionsContainer.deadline-tracker-feature tr.task-near-due td { background-color: var(--app-highlight-near-due-bg) !important; }
             #featureSectionsContainer.deadline-tracker-feature tr.task-overdue td { background-color: var(--app-highlight-overdue-bg) !important; }
             body.dark-theme #featureSectionsContainer.deadline-tracker-feature tr.task-near-due td, body.dark-theme #featureSectionsContainer.deadline-tracker-feature tr.task-overdue td { color: var(--app-text-color); }
             /* Actions */
             #featureSectionsContainer.deadline-tracker-feature .task-actions { text-align: right; }
             #featureSectionsContainer.deadline-tracker-feature .task-actions button { margin-left: 0.4rem; }
             /* Delete Modal */
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-overlay { position: fixed; inset: 0; background-color: var(--app-confirm-overlay-bg); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content { background-color: var(--app-card-bg-color); padding: 2rem; border-radius: var(--app-card-radius); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-overlay.visible .confirm-modal-content { transform: scale(1); }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content h3 { font-size: 1.25rem; margin-bottom: 1rem; color: var(--app-text-color); }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-content p { margin-bottom: 1.5rem; color: var(--app-secondary-text-color); }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-actions { display: flex; justify-content: center; gap: 1rem; }
             #featureSectionsContainer.deadline-tracker-feature .confirm-modal-actions button { padding: 0.7rem 1.5rem; color: white; border: none; min-width: 100px; } /* Uses dashboard .btn */
             #featureSectionsContainer.deadline-tracker-feature #confirm-delete-yes { background-color: var(--app-confirm-yes-bg); }
             #featureSectionsContainer.deadline-tracker-feature #confirm-delete-yes:hover { background-color: var(--app-confirm-yes-hover-bg); }
             #featureSectionsContainer.deadline-tracker-feature #confirm-delete-no { background-color: var(--app-confirm-no-bg); }
             #featureSectionsContainer.deadline-tracker-feature #confirm-delete-no:hover { background-color: var(--app-confirm-no-hover-bg); }
             /* Animation */
             @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
             /* Responsiveness */
             @media (min-width: 1024px) {
                  #featureSectionsContainer.deadline-tracker-feature .tracker-main-content { grid-template-columns: 7fr 5fr; } /* Adjust grid layout */
                  #featureSectionsContainer.deadline-tracker-feature .task-input-container { grid-column: 1 / 2; }
                  #featureSectionsContainer.deadline-tracker-feature .chart-container { grid-column: 2 / 3; }
                  #featureSectionsContainer.deadline-tracker-feature .tracker-controls { grid-column: 1 / -1; order: 1; }
                  #featureSectionsContainer.deadline-tracker-feature .tasks-display-area { grid-column: 1 / -1; order: 3; }
             }
             @media (max-width: 768px) {
                  #featureSectionsContainer.deadline-tracker-feature .tracker-header h1 { font-size: 1.5rem; }
                  #featureSectionsContainer.deadline-tracker-feature #task-form { grid-template-columns: 1fr; }
                  #featureSectionsContainer.deadline-tracker-feature #task-form button[type="submit"] { grid-column: 1 / -1; justify-self: stretch; width: 100%; }
                  #featureSectionsContainer.deadline-tracker-feature .tracker-controls { flex-direction: column; align-items: stretch; }
                  #featureSectionsContainer.deadline-tracker-feature .control-group { min-width: unset; }
                  #featureSectionsContainer.deadline-tracker-feature .export-buttons { margin-left: 0; margin-top: 1rem; justify-content: flex-start; width: 100%; }
                  #featureSectionsContainer.deadline-tracker-feature .export-buttons button { flex-grow: 1; justify-content: center; }
                  #featureSectionsContainer.deadline-tracker-feature .tracker-main-content, #featureSectionsContainer.deadline-tracker-feature .deadline-tracker-container { display: flex; flex-direction: column; }
                  #featureSectionsContainer.deadline-tracker-feature #tasks-table th, #featureSectionsContainer.deadline-tracker-feature #tasks-table td { padding: 0.8rem; font-size: 0.9rem; }
                  #featureSectionsContainer.deadline-tracker-feature .tasks-display-area { margin-top: 1.5rem; } /* Add space when stacked */
             }
        </style>
        <div class="deadline-tracker-container">
            <header class="tracker-header"> <h1><i class="fas fa-calendar-check"></i> Deadline Tracker</h1> </header>
             <div class="tracker-main-content">
                <section class="task-input-container card">
                     <h2>Add New Task</h2>
                     <form id="task-form">
                         <div class="form-group"> <label for="task-name">Task Name:</label> <input type="text" id="task-name" name="task-name" required placeholder="Task description..." class="form-control"> </div>
                         <div class="form-group"> <label for="assignee-select">Assignee:</label> <select id="assignee-select" name="assignee" required class="form-select"> <option value="" disabled selected>-- Assignee --</option> </select> </div>
                         <div class="form-group"> <label for="start-date">Start Date:</label> <input type="date" id="start-date" name="start-date" required class="form-control"> </div>
                         <div class="form-group"> <label for="deadline-date">Deadline:</label> <input type="date" id="deadline-date" name="deadline" required class="form-control"> </div>
                         <button type="submit" class="btn btn-primary">Add Task</button>
                     </form>
                </section>
                <section class="chart-container card"> <h2>Task Status Overview</h2> <canvas id="task-status-chart"></canvas> </section>
             </div>
             <section class="tracker-controls card">
                 <div class="control-group"> <label for="sort-by">Sort By:</label> <select id="sort-by" class="form-select"> <option value="deadline-asc">Deadline (Soonest)</option> <option value="deadline-desc">Deadline (Latest)</option> <option value="start-date-asc">Start Date (Oldest)</option> <option value="assignee-asc">Assignee (A-Z)</option> <option value="status-asc">Status</option> </select> </div>
                 <div class="control-group"> <label for="filter-assignee">Filter Assignee:</label> <select id="filter-assignee" class="form-select"> <option value="All">All Assignees</option> </select> </div>
                 <div class="control-group"> <label for="filter-status">Filter Status:</label> <select id="filter-status" class="form-select"> <option value="All">All Statuses</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> <option value="Overdue">Overdue</option> </select> </div>
                 <div class="export-buttons"> <button id="export-excel" class="btn button-export" title="Download Excel Report"><i class="fas fa-file-excel"></i> Excel</button> <button id="export-pdf" class="btn button-pdf" title="Download PDF Report"><i class="fas fa-file-pdf"></i> PDF</button> </div>
             </section>
             <section class="tasks-display-area">
                 <table id="tasks-table">
                      <thead> <tr> <th>Task Name</th> <th>Assignee</th> <th>Start Date</th> <th>Deadline</th> <th>Duration</th> <th>Status</th> <th>Actions</th> </tr> </thead>
                      <tbody id="tasks-tbody"><tr><td colspan="7" class="text-center p-4 text-muted">Loading tasks...</td></tr></tbody>
                 </table>
             </section>
         </div>
        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="confirm-modal-overlay">
             <div class="confirm-modal-content">
                <h3>Confirm Deletion</h3>
                <p id="delete-confirm-message">Are you sure you want to delete this task?</p>
                <div class="confirm-modal-actions"> <button id="confirm-delete-no" class="btn">No <i class="fas fa-times"></i></button> <button id="confirm-delete-yes" class="btn">Yes <i class="fas fa-check"></i></button> </div>
             </div>
        </div>
        <script>
            function initializeDeadlineTrackerFeature(container) {
                console.log("Initializing Deadline Tracker Feature..."); // Debug log
                const sectionContainer = container.querySelector('.deadline-tracker-container');
                if (!sectionContainer) { console.error("Deadline Tracker container not found!"); return { cleanup: () => {} }; }
                const taskForm = sectionContainer.querySelector('#task-form');
                const taskNameInput = sectionContainer.querySelector('#task-name');
                const assigneeSelect = sectionContainer.querySelector('#assignee-select');
                const startDateInput = sectionContainer.querySelector('#start-date');
                const deadlineInput = sectionContainer.querySelector('#deadline-date');
                const tasksTbody = sectionContainer.querySelector('#tasks-tbody');
                const sortBySelect = sectionContainer.querySelector('#sort-by');
                const filterAssigneeSelect = sectionContainer.querySelector('#filter-assignee');
                const filterStatusSelect = sectionContainer.querySelector('#filter-status');
                const exportExcelButton = sectionContainer.querySelector('#export-excel');
                const exportPdfButton = sectionContainer.querySelector('#export-pdf');
                const chartCanvasEl = sectionContainer.querySelector('#task-status-chart');
                const deleteModal = document.getElementById('delete-confirm-modal'); // Global modal
                const deleteModalMessage = deleteModal?.querySelector('#delete-confirm-message');
                const confirmDeleteYesBtn = deleteModal?.querySelector('#confirm-delete-yes');
                const confirmDeleteNoBtn = deleteModal?.querySelector('#confirm-delete-no');

                if (!taskForm || !tasksTbody || !chartCanvasEl || !deleteModal || !confirmDeleteYesBtn || !confirmDeleteNoBtn) {
                    console.error("Deadline Tracker essential elements missing!");
                    if(tasksTbody) tasksTbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                    return { cleanup: () => {} };
                }
                let chartCanvas, taskChart = null;
                try { chartCanvas = chartCanvasEl.getContext('2d'); if (!chartCanvas) throw new Error("Canvas context failed"); } catch (e) { console.error("Failed to get chart context:", e); return { cleanup: () => {} }; }

                const employeeNames = (window.MOCK_USERS || []).map(u => u.name); // Get names from global MOCK_USERS
                const nearDueDays = 3;
                let tasksData = JSON.parse(localStorage.getItem('deadlineTrackerTasksV3')) || [ { id: 1, taskName: "Prepare Q3 Presentation Draft", assignee: "Esraa Lashin", startDate: "2024-07-01", deadline: "2024-07-15", status: "In Progress" }, { id: 2, taskName: "Update Client Database", assignee: "Yousef Ahmed", startDate: "2024-06-20", deadline: "2024-06-30", status: "Completed" }, { id: 3, taskName: "Review Project Alpha Proposal", assignee: "Nada Mahmoud", startDate: "2024-06-01", deadline: "2024-06-05", status: "In Progress" }, { id: 4, taskName: "Onboard New Intern", assignee: "Mohamed Elmenisy", startDate: getFutureDate(-1), deadline: getFutureDate(2), status: "In Progress" }, { id: 5, taskName: "Schedule Team Building Activity", assignee: "Bassant Badr", startDate: "2024-07-10", deadline: "2024-07-25", status: "In Progress" }, ];
                let taskIdToDelete = null; let listeners = [];
                const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };

                function getFutureDate(days) { const date = new Date(); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; }
                const saveData = () => localStorage.setItem('deadlineTrackerTasksV3', JSON.stringify(tasksData));
                const formatDateDT = (dateString) => window.formatDateForDisplay(dateString); // Use global
                const calculateDuration = (startDateStr, deadlineStr) => { if (!startDateStr || !deadlineStr) return '-'; try { const start = new Date(startDateStr + 'T00:00:00Z'); const end = new Date(deadlineStr + 'T00:00:00Z'); if (isNaN(start) || isNaN(end) || start > end) return 'Invalid'; const diffTime = Math.abs(end - start); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; if (diffDays === 1) return '1 Day'; return `${diffDays} Days`; } catch (e) { return 'Error'; } };
                const getCurrentStatus = (task) => { if (task.status === "Completed") return "Completed"; const today = new Date(); today.setUTCHours(0, 0, 0, 0); const deadlineDate = new Date(task.deadline + 'T00:00:00Z'); if (isNaN(deadlineDate.getTime())) return "In Progress"; if (deadlineDate < today) return "Overdue"; return task.status || "In Progress"; };
                const getStatusClass = (status) => { switch (status) { case "In Progress": return "status-in-progress"; case "Completed": return "status-completed"; case "Overdue": return "status-overdue"; default: return ""; } };
                const escapeHTML = (str) => { if (str === null || str === undefined) return ''; const div = document.createElement('div'); div.appendChild(document.createTextNode(str)); return div.innerHTML; }

                const renderTasks = () => {
                    tasksTbody.innerHTML = ''; const sortBy = sortBySelect.value; const filterAssignee = filterAssigneeSelect.value; const filterStatus = filterStatusSelect.value;
                    let filteredTasks = tasksData.filter(task => { const currentStatus = getCurrentStatus(task); const assigneeMatch = filterAssignee === 'All' || task.assignee === filterAssignee; const statusMatch = filterStatus === 'All' || currentStatus === filterStatus; return assigneeMatch && statusMatch; });
                    filteredTasks.sort((a, b) => { switch (sortBy) { case 'deadline-asc': return new Date(a.deadline) - new Date(b.deadline); case 'deadline-desc': return new Date(b.deadline) - new Date(a.deadline); case 'start-date-asc': return new Date(a.startDate) - new Date(b.startDate); case 'assignee-asc': return a.assignee.localeCompare(b.assignee); case 'status-asc': const order = { "Overdue": 1, "In Progress": 2, "Completed": 3 }; return (order[getCurrentStatus(a)] || 99) - (order[getCurrentStatus(b)] || 99); default: return 0; } });
                    const today = new Date(); today.setUTCHours(0, 0, 0, 0); const nearDueDate = new Date(); nearDueDate.setDate(today.getDate() + nearDueDays);
                    if (filteredTasks.length === 0) { const row = tasksTbody.insertRow(); const cell = row.insertCell(); cell.colSpan = 7; cell.textContent = 'No tasks match filters.'; cell.style.textAlign = 'center'; cell.style.padding = '1.5rem'; cell.style.color = 'var(--app-secondary-text-color)'; }
                    else {
                        filteredTasks.forEach((task, index) => {
                            const row = document.createElement('tr'); row.dataset.id = task.id; const currentStatus = getCurrentStatus(task); const deadlineDate = new Date(task.deadline + 'T00:00:00Z'); if (currentStatus === "Overdue") row.classList.add('task-overdue'); else if (currentStatus !== "Completed" && !isNaN(deadlineDate.getTime()) && deadlineDate <= nearDueDate && deadlineDate >= today) row.classList.add('task-near-due');
                            row.style.animationDelay = `${index * 0.05}s`; row.style.opacity = 0; // Start hidden for animation
                            row.innerHTML = `
                                <td>${escapeHTML(task.taskName)}</td> <td>${escapeHTML(task.assignee)}</td> <td>${formatDateDT(task.startDate)}</td> <td>${formatDateDT(task.deadline)}</td> <td><span class="duration">${calculateDuration(task.startDate, task.deadline)}</span></td>
                                <td> <select class="status-select-inline form-select form-select-sm ${getStatusClass(currentStatus)}" data-task-id="${task.id}" title="Change Status" style="min-width: 110px; font-size: 0.8rem; padding: 0.2rem 0.5rem;"> <option value="In Progress" ${currentStatus === 'In Progress' || currentStatus === 'Overdue' ? 'selected' : ''}>In Progress</option> <option value="Completed" ${currentStatus === 'Completed' ? 'selected' : ''}>Completed</option> </select> </td>
                                <td class="task-actions"> <button class="button-icon button-danger-icon task-delete" aria-label="Delete task ${task.id}" title="Delete Task"><i class="fas fa-trash"></i></button> </td>
                            `; tasksTbody.appendChild(row);
                        });
                    } updateChart(filteredTasks);
                };
                const updateChart = (dataForChart) => {
                    const statusCounts = {"In Progress": 0, "Completed": 0, "Overdue": 0 }; dataForChart.forEach(task => { const status = getCurrentStatus(task); if (statusCounts.hasOwnProperty(status)) { statusCounts[status]++; } else if (status === "Overdue") { statusCounts["Overdue"]++; } else { statusCounts["In Progress"]++; } }); // Count Overdue as In Progress for simplicity if not explicitly handled
                    const chartData = { labels: ["In Progress", "Completed", "Overdue"], datasets: [{ label: 'Task Status', data: [statusCounts["In Progress"], statusCounts["Completed"], statusCounts["Overdue"]], backgroundColor: [ getCssVar('--chart-blue'), getCssVar('--chart-green'), getCssVar('--chart-red')], borderColor: getCssVar('--app-card-bg-color'), borderWidth: 2, hoverOffset: 6 }] };
                    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: getCssVar('--text-muted'), padding: 15 } }, tooltip: { boxPadding: 5 } } };
                    if (taskChart) { taskChart.data = chartData; taskChart.options = chartOptions; taskChart.update(); }
                    else { taskChart = new Chart(chartCanvas, { type: 'pie', data: chartData, options: chartOptions }); }
                };

                addListener(taskForm, 'submit', (e) => { e.preventDefault(); const taskName = taskNameInput.value.trim(); const assignee = assigneeSelect.value; const startDate = startDateInput.value; const deadline = deadlineInput.value; if (!taskName || !assignee || !startDate || !deadline) { window.showToast('Please fill all fields.', 'error'); return; } if (new Date(startDate) > new Date(deadline)) { window.showToast('Start Date cannot be after Deadline.', 'error'); return; } const newTask = { id: Date.now(), taskName, assignee, startDate, deadline, status: "In Progress" }; tasksData.push(newTask); saveData(); renderTasks(); taskForm.reset(); assigneeSelect.value = ""; startDateInput.value = new Date().toISOString().split('T')[0]; });
                addListener(sortBySelect, 'change', renderTasks);
                addListener(filterAssigneeSelect, 'change', renderTasks);
                addListener(filterStatusSelect, 'change', renderTasks);
                addListener(tasksTbody, 'change', (e) => { if (e.target.classList.contains('status-select-inline')) { const taskId = parseInt(e.target.dataset.taskId); const newStatus = e.target.value; const taskIndex = tasksData.findIndex(t => t.id === taskId); if(taskIndex !== -1) { tasksData[taskIndex].status = newStatus; saveData(); renderTasks(); window.showToast('Task status updated.', 'success'); } } });
                addListener(tasksTbody, 'click', (e) => { const deleteButton = e.target.closest('.task-delete'); if (deleteButton) { const row = deleteButton.closest('tr'); const taskId = parseInt(row.dataset.id); const task = tasksData.find(t => t.id === taskId); if (task) { showDeleteConfirmModal(taskId, task.taskName); } } });
                function showDeleteConfirmModal(taskId, taskName) { taskIdToDelete = taskId; if(deleteModalMessage) deleteModalMessage.textContent = `Are you sure you want to delete the task: "${escapeHTML(taskName)}"?`; if(deleteModal) deleteModal.classList.add('visible'); document.body.style.overflow = 'hidden'; }
                function hideDeleteConfirmModal() { taskIdToDelete = null; if(deleteModal) deleteModal.classList.remove('visible'); document.body.style.overflow = ''; }
                addListener(confirmDeleteYesBtn, 'click', () => { if (taskIdToDelete !== null) { const taskIndex = tasksData.findIndex(t => t.id === taskIdToDelete); if (taskIndex !== -1) { tasksData.splice(taskIndex, 1); saveData(); renderTasks(); window.showToast('Task deleted.', 'success');} } hideDeleteConfirmModal(); });
                addListener(confirmDeleteNoBtn, 'click', hideDeleteConfirmModal);
                addListener(deleteModal, 'click', (e) => { if (e.target === deleteModal) { hideDeleteConfirmModal(); } }); // Close on overlay click

                addListener(exportExcelButton, 'click', () => { try { if (typeof XLSX === 'undefined') throw new Error("SheetJS library (XLSX) is not loaded."); const filteredTasks = tasksData.filter(task => { const currentStatus = getCurrentStatus(task); const assigneeMatch = filterAssigneeSelect.value === 'All' || task.assignee === filterAssigneeSelect.value; const statusMatch = filterStatusSelect.value === 'All' || currentStatus === filterStatusSelect.value; return assigneeMatch && statusMatch; }).sort((a, b) => { switch (sortBySelect.value) { case 'deadline-asc': return new Date(a.deadline) - new Date(b.deadline); case 'deadline-desc': return new Date(b.deadline) - new Date(a.deadline); default: return 0; } }); const dataToExport = [ ["Task Name", "Assignee", "Start Date", "Deadline", "Duration", "Status"], ...filteredTasks.map(task => [ task.taskName, task.assignee, formatDateDT(task.startDate), formatDateDT(task.deadline), calculateDuration(task.startDate, task.deadline), getCurrentStatus(task) ]) ]; const worksheet = XLSX.utils.aoa_to_sheet(dataToExport); worksheet['!cols'] = [ { wch: 40 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 } ]; const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Deadlines"); XLSX.writeFile(workbook, "Deadline_Report.xlsx"); window.showToast('Excel export successful.', 'success'); } catch (error) { console.error("Excel export failed:", error); window.showToast(`Excel export failed. Error: ${error.message}`, 'error'); } });
                addListener(exportPdfButton, 'click', () => { try { if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined' || typeof jspdf.autoTable !== 'function') { throw new Error('jsPDF or jsPDF-AutoTable library not loaded.'); } const { jsPDF } = jspdf; const doc = new jsPDF({ orientation: 'landscape' }); doc.setFontSize(14); doc.text("Deadline Tracker Report", 14, 15); const filteredTasks = tasksData.filter(task => { const currentStatus = getCurrentStatus(task); const assigneeMatch = filterAssigneeSelect.value === 'All' || task.assignee === filterAssigneeSelect.value; const statusMatch = filterStatusSelect.value === 'All' || currentStatus === filterStatusSelect.value; return assigneeMatch && statusMatch; }).sort((a, b) => { switch (sortBySelect.value) { case 'deadline-asc': return new Date(a.deadline) - new Date(b.deadline); default: return 0; } }); const head = [['Task Name', 'Assignee', 'Start Date', 'Deadline', 'Duration', 'Status']]; const body = filteredTasks.map(task => [ task.taskName, task.assignee, formatDateDT(task.startDate), formatDateDT(task.deadline), calculateDuration(task.startDate, task.deadline), getCurrentStatus(task) ]); doc.autoTable({ head: head, body: body, startY: 22, theme: 'grid', headStyles: { fillColor: [37, 99, 235] }, styles: { fontSize: 8 }, columnStyles: { 0: { cellWidth: 60 } } }); doc.save('Deadline_Report.pdf'); window.showToast('PDF export successful.', 'success'); } catch (error) { console.error("PDF export failed:", error); window.showToast(`PDF export failed. Error: ${error.message}`, 'error'); } });

                const initializeTracker = () => { assigneeSelect.innerHTML = '<option value="" disabled selected>-- Assignee --</option>'; filterAssigneeSelect.innerHTML = '<option value="All">All Assignees</option>'; employeeNames.forEach(name => { const op1 = new Option(name, name); assigneeSelect.appendChild(op1); const op2 = new Option(name, name); filterAssigneeSelect.appendChild(op2); }); startDateInput.value = new Date().toISOString().split('T')[0]; renderTasks(); };
                initializeTracker();

                const cleanup = () => {
                    console.log("Cleaning up Deadline Tracker..."); if (taskChart) taskChart.destroy(); taskChart = null;
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                    hideDeleteConfirmModal(); // Ensure modal is hidden
                    delete window.deadlineTrackerInstance; // Clean up global instance
                    document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = '';
                    console.log("Deadline Tracker cleanup complete.");
                };
                window.deadlineTrackerInstance = { renderTasks }; // Expose render function
                return { cleanup };
            }
        </script>
    </template>

    <!-- NEW: Template for Innovation Hub -->
    <template id="innovationHubAssets">
        <style id="injected-innovation-hub-styles">
            /* Scoped Variables */
            #featureSectionsContainer.innovation-hub-feature {
                 --app-bg-color: var(--feature-innovation-hub-bg-color); --app-text-color: var(--feature-innovation-hub-text-color); --app-card-bg-color: var(--feature-innovation-hub-card-bg-color); --app-border-color: var(--feature-innovation-hub-border-color); --app-primary-color: var(--feature-innovation-hub-primary-color); --app-primary-text-color: var(--feature-innovation-hub-primary-text-color); --app-secondary-text-color: var(--feature-innovation-hub-secondary-text-color); --app-hover-bg-color: var(--feature-innovation-hub-hover-bg-color); --app-icon-color: var(--feature-innovation-hub-icon-color); --app-shadow-color: var(--feature-innovation-hub-shadow-color); --app-input-border-color: var(--feature-innovation-hub-input-border-color); --app-input-bg-color: var(--feature-innovation-hub-input-bg-color); --app-button-secondary-bg: var(--feature-innovation-hub-button-secondary-bg); --app-button-secondary-text: var(--feature-innovation-hub-button-secondary-text); --app-button-secondary-hover-bg: var(--feature-innovation-hub-button-secondary-hover-bg); --app-danger-color: var(--feature-innovation-hub-danger-color); --app-danger-text-color: var(--feature-innovation-hub-danger-text-color); --app-danger-hover-bg: var(--feature-innovation-hub-danger-hover-bg); --app-hub-header-bg-start: var(--feature-innovation-hub-hub-header-bg-start); --app-hub-header-bg-end: var(--feature-innovation-hub-hub-header-bg-end); --app-hub-header-text-color: var(--feature-innovation-hub-hub-header-text-color); --app-status-review-bg: var(--feature-innovation-hub-status-review-bg); --app-status-review-text: var(--feature-innovation-hub-status-review-text); --app-status-implemented-bg: var(--feature-innovation-hub-status-implemented-bg); --app-status-implemented-text: var(--feature-innovation-hub-status-implemented-text); --app-status-rejected-bg: var(--feature-innovation-hub-status-rejected-bg); --app-status-rejected-text: var(--feature-innovation-hub-status-rejected-text); --app-transition-speed: 0.2s;
            }
             /* Feature Container */
             #featureSectionsContainer.innovation-hub-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--app-bg-color); padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--app-border-color);
             }
             body.dark-theme #featureSectionsContainer.innovation-hub-feature > div:first-child {
                 background-color: var(--app-bg-color); border-color: var(--app-border-color); /* Already defined in dark theme vars */
             }
             #featureSectionsContainer.innovation-hub-feature .innovation-hub-container { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; }
             /* General - Buttons use dashboard styles */
             #featureSectionsContainer.innovation-hub-feature select, #featureSectionsContainer.innovation-hub-feature textarea { font-family: inherit; padding: 0.6rem 0.8rem; border: 1px solid var(--app-input-border-color); border-radius: 6px; font-size: 0.95rem; background-color: var(--app-input-bg-color); color: var(--app-text-color); transition: border-color var(--app-transition-speed) ease, box-shadow var(--app-transition-speed) ease; }
             #featureSectionsContainer.innovation-hub-feature select:focus, #featureSectionsContainer.innovation-hub-feature textarea:focus { outline: none; border-color: var(--app-primary-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
             #featureSectionsContainer.innovation-hub-feature textarea { resize: vertical; min-height: 80px; width: 100%; }
             #featureSectionsContainer.innovation-hub-feature label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; color: var(--app-secondary-text-color); }
             #featureSectionsContainer.innovation-hub-feature .hidden { display: none !important; }
             /* Header */
             #featureSectionsContainer.innovation-hub-feature .hub-header { text-align: center; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--app-card-bg-color); border-radius: 8px; border: 1px solid var(--app-border-color); box-shadow: 0 2px 4px var(--app-shadow-color); }
             #featureSectionsContainer.innovation-hub-feature .hub-header h2 { font-size: 1.6rem; font-weight: 600; color: var(--app-text-color); margin: 0 0 0.5rem 0; display: inline-flex; align-items: center; gap: 0.6rem; }
             #featureSectionsContainer.innovation-hub-feature .hub-header h2 i { color: var(--app-primary-color); font-size: 1em; }
             #featureSectionsContainer.innovation-hub-feature .hub-header p { font-size: 1rem; color: var(--app-secondary-text-color); margin: 0; }
             /* Form */
             #featureSectionsContainer.innovation-hub-feature .submission-form-container { background-color: var(--app-card-bg-color); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px var(--app-shadow-color); border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.innovation-hub-feature .submission-form-container h3 { font-size: 1.3rem; margin-bottom: 1rem; color: var(--app-text-color); }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form { display: flex; flex-direction: column; gap: 1rem; }
             #featureSectionsContainer.innovation-hub-feature .form-row { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
             #featureSectionsContainer.innovation-hub-feature .form-row .form-group { flex-grow: 1; min-width: 200px; }
             #featureSectionsContainer.innovation-hub-feature .form-row button { flex-shrink: 0; height: fit-content; padding: 0.7rem 1.5rem; margin-top: 1.5rem; /* Align with label bottom */ }
             /* Controls */
             #featureSectionsContainer.innovation-hub-feature .hub-controls { display: flex; flex-wrap: wrap; gap: 1rem; padding: 1rem 1.5rem; align-items: flex-end; background-color: var(--app-card-bg-color); border-radius: 8px; box-shadow: 0 2px 8px var(--app-shadow-color); border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.innovation-hub-feature .hub-controls .form-group { margin-bottom: 0; flex-grow: 1; min-width: 150px; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls label { font-size: 0.85rem; }
             #featureSectionsContainer.innovation-hub-feature #my-ideas-toggle { padding: 0.6rem 1rem; /* Use .btn class styling */ }
             #featureSectionsContainer.innovation-hub-feature #my-ideas-toggle.active { background-color: var(--app-primary-color); color: var(--app-primary-text-color); opacity: 1; border-color: var(--app-primary-color); }
             /* Suggestions List */
             #featureSectionsContainer.innovation-hub-feature #suggestions-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
             /* Suggestion Card */
             #featureSectionsContainer.innovation-hub-feature .suggestion-card { background-color: var(--app-card-bg-color); border-radius: 8px; box-shadow: 0 2px 8px var(--app-shadow-color); padding: 1.25rem; display: flex; flex-direction: column; gap: 0.8rem; transition: transform 0.2s ease, box-shadow 0.2s ease; opacity: 0; animation: fadeIn 0.5s ease forwards; border: 1px solid var(--app-border-color); }
             #featureSectionsContainer.innovation-hub-feature .suggestion-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--app-shadow-color); }
             #featureSectionsContainer.innovation-hub-feature .suggestion-text-display { font-size: 1rem; line-height: 1.6; margin-bottom: 0.5rem; white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); } /* Ensure text color */
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta { font-size: 0.8rem; color: var(--app-secondary-text-color); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid var(--app-border-color); padding-top: 0.8rem; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta .author::before { content: "👤 "; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta .date::before { content: "📅 "; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-status-section { margin-top: 0.5rem; font-size: 0.9rem; color: var(--app-secondary-text-color); }
             #featureSectionsContainer.innovation-hub-feature .suggestion-status { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 600; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
             #featureSectionsContainer.innovation-hub-feature .status-under-review { background-color: var(--app-status-review-bg); color: var(--app-status-review-text); }
             #featureSectionsContainer.innovation-hub-feature .status-implemented { background-color: var(--app-status-implemented-bg); color: var(--app-status-implemented-text); }
             #featureSectionsContainer.innovation-hub-feature .status-rejected { background-color: var(--app-status-rejected-bg); color: var(--app-status-rejected-text); }
             body.dark-theme #featureSectionsContainer.innovation-hub-feature .status-under-review { background-color: var(--feature-innovation-hub-status-review-bg); color: var(--feature-innovation-hub-status-review-text); }
             body.dark-theme #featureSectionsContainer.innovation-hub-feature .status-implemented { background-color: var(--feature-innovation-hub-status-implemented-bg); color: var(--feature-innovation-hub-status-implemented-text); }
             body.dark-theme #featureSectionsContainer.innovation-hub-feature .status-rejected { background-color: var(--feature-innovation-hub-status-rejected-bg); color: var(--feature-innovation-hub-status-rejected-text); }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section { margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px dashed var(--app-border-color); }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section strong { display: block; font-size: 0.85rem; color: var(--app-secondary-text-color); margin-bottom: 0.3rem; }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply { font-size: 0.9rem; background-color: var(--app-hover-bg-color); padding: 0.5rem 0.8rem; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-color); } /* Ensure text color */
             /* Admin Controls */
             #featureSectionsContainer.innovation-hub-feature .admin-controls { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--app-border-color); display: none; flex-direction: column; gap: 0.8rem; }
             #featureSectionsContainer.innovation-hub-feature.admin-view #suggestions-list .admin-controls { display: flex; } /* Show controls */
             #featureSectionsContainer.innovation-hub-feature .admin-controls .form-group { margin-bottom: 0; }
             #featureSectionsContainer.innovation-hub-feature .admin-controls select { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
             #featureSectionsContainer.innovation-hub-feature .admin-controls textarea { font-size: 0.9rem; min-height: 60px; }
             #featureSectionsContainer.innovation-hub-feature .admin-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
             #featureSectionsContainer.innovation-hub-feature .admin-actions button { font-size: 0.8rem; padding: 0.4em 0.8em; } /* Use .btn classes */
             /* Animation */
             @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
             /* Responsiveness */
             @media (max-width: 768px) {
                 #featureSectionsContainer.innovation-hub-feature .hub-header h2 { font-size: 1.5rem; }
                 #featureSectionsContainer.innovation-hub-feature #suggestions-list { grid-template-columns: 1fr; }
                 #featureSectionsContainer.innovation-hub-feature .hub-controls { flex-direction: column; align-items: stretch; }
                 #featureSectionsContainer.innovation-hub-feature .hub-controls .form-group, #featureSectionsContainer.innovation-hub-feature .hub-controls button { width: 100%; }
                 #featureSectionsContainer.innovation-hub-feature .form-row { flex-direction: column; align-items: stretch; }
                 #featureSectionsContainer.innovation-hub-feature .form-row button { margin-top: 1rem; width: 100%; }
             }
             @media (max-width: 480px) {
                 #featureSectionsContainer.innovation-hub-feature .hub-header { padding: 1rem 1.5rem; }
                 #featureSectionsContainer.innovation-hub-feature .hub-header h2 { font-size: 1.3rem; }
                 #featureSectionsContainer.innovation-hub-feature .submission-form-container { padding: 1rem; }
                 #featureSectionsContainer.innovation-hub-feature .suggestion-card { padding: 1rem; }
                 #featureSectionsContainer.innovation-hub-feature .suggestion-text-display { font-size: 0.95rem; }
                 #featureSectionsContainer.innovation-hub-feature .form-row button { margin-top: 0.5rem; }
             }
        </style>
        <div class="innovation-hub-container" id="innovation-hub"> <!-- Main container with ID -->
            <header class="hub-header">
                <h2><i class="fas fa-lightbulb"></i> Innovation Hub</h2>
                <p>💡 Share Your Ideas & Improve Our Workplace</p>
            </header>
            <section class="submission-form-container">
                <h3>Submit a New Suggestion</h3>
                <form id="suggestion-form">
                     <div class="form-group"> <label for="suggestion-text">Your Idea / Suggestion:</label> <textarea id="suggestion-text" name="suggestion-text" rows="4" required placeholder="Describe your innovative idea..." class="form-control"></textarea> </div>
                     <div class="form-row">
                        <div class="form-group"> <label for="employee-select">Submitted By:</label> <select id="employee-select" name="employee" required class="form-select"> <option value="" disabled selected>-- Select Your Name --</option> </select> </div>
                        <button type="submit" class="btn btn-primary">Submit Idea</button>
                     </div>
                </form>
            </section>
             <section class="hub-controls">
                <div class="form-group"> <label for="filter-status">Filter by Status:</label> <select id="filter-status" class="form-select form-select-sm"> <option value="All">All Statuses</option> <option value="Under Review">Under Review</option> <option value="Implemented">Implemented</option> <option value="Rejected">Rejected</option> </select> </div>
                <div class="form-group"> <label for="filter-author">Filter by Author:</label> <select id="filter-author" class="form-select form-select-sm"> <option value="All">All Authors</option> </select> </div>
                <button id="my-ideas-toggle" class="btn btn-sm btn-secondary">Show My Ideas Only</button>
             </section>
             <section id="suggestions-list"></section>
        </div><!-- End of innovation-hub-container -->
         <script>
            function initializeInnovationHubFeature(container) {
                console.log("Initializing Innovation Hub Feature..."); // Debug log
                 const hubContainer = container.querySelector('#innovation-hub');
                 if (!hubContainer) { console.error("Innovation Hub container not found!"); return { cleanup: () => {} }; }
                 const suggestionForm = hubContainer.querySelector('#suggestion-form');
                 const suggestionText = hubContainer.querySelector('#suggestion-text');
                 const employeeSelect = hubContainer.querySelector('#employee-select');
                 const suggestionsList = hubContainer.querySelector('#suggestions-list');
                 const filterStatusSelect = hubContainer.querySelector('#filter-status');
                 const filterAuthorSelect = hubContainer.querySelector('#filter-author');
                 const myIdeasToggle = hubContainer.querySelector('#my-ideas-toggle');

                 if (!suggestionForm || !suggestionsList || !filterStatusSelect || !employeeSelect) {
                    console.error("Innovation Hub essential elements missing!");
                    return { cleanup: () => {} };
                 }

                 const employeeNames = (window.MOCK_USERS || []).map(u => u.name); // Use global mock users
                 const adminUser = "Nada Mahmoud"; // Example Admin
                 const currentDashboardUser = window.currentUser?.name || employeeNames[0]; // Get from global or default
                 const isAdmin = currentDashboardUser === adminUser;
                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };

                 let suggestionsData = JSON.parse(localStorage.getItem('innovationHubSuggestionsV2')) || [ { id: 1, text: "Implement a 'quiet hour' policy twice a week for focused work.", author: "Esraa Lashin", date: "2024-05-15", status: "Under Review", reply: "" }, { id: 2, text: "Organize monthly cross-departmental knowledge sharing sessions.", author: "Yousef Ahmed", date: "2024-05-10", status: "Implemented", reply: "Excellent initiative, this is now scheduled!" }, { id: 3, text: "Upgrade the coffee machine in the break room.", author: "Mohamed Elmenisy", date: "2024-04-28", status: "Rejected", reply: "Budget constraints prevent this at the moment." }, { id: 4, text: "Create a mentorship program for new hires.", author: "Bassant Badr", date: "2024-05-20", status: "Under Review", reply: "" }, ];

                 const saveData = () => localStorage.setItem('innovationHubSuggestionsV2', JSON.stringify(suggestionsData));
                 const formatDateIH = (dateString) => window.formatDateForDisplay(new Date(dateString + 'T00:00:00Z'));
                 const getStatusClassIH = (status) => { switch (status) { case "Under Review": return "status-under-review"; case "Implemented": return "status-implemented"; case "Rejected": return "status-rejected"; default: return ""; } };
                 const escapeHTML = (str) => { if (str === null || str === undefined) return ''; const div = document.createElement('div'); div.appendChild(document.createTextNode(str)); return div.innerHTML; }

                 const renderSuggestions = () => {
                     suggestionsList.innerHTML = ''; const statusFilter = filterStatusSelect.value; const authorFilter = filterAuthorSelect.value; const showMyIdeas = myIdeasToggle.classList.contains('active');
                     let filteredSuggestions = suggestionsData.filter(suggestion => { const statusMatch = statusFilter === 'All' || suggestion.status === statusFilter; const authorMatch = authorFilter === 'All' || suggestion.author === authorFilter; const myIdeasMatch = !showMyIdeas || suggestion.author === currentDashboardUser; return statusMatch && authorMatch && myIdeasMatch; });
                     filteredSuggestions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first

                     if (filteredSuggestions.length === 0) { suggestionsList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--app-secondary-text-color); padding: 2rem 0;">No suggestions match the current filters.</p>'; }
                     else {
                        filteredSuggestions.forEach(suggestion => {
                            const card = document.createElement('div'); card.classList.add('suggestion-card'); card.dataset.id = suggestion.id;
                            card.innerHTML = `
                                <p class="suggestion-text-display">${escapeHTML(suggestion.text)}</p>
                                <div class="suggestion-meta"> <span class="author">👤 ${escapeHTML(suggestion.author)}</span> <span class="date">📅 ${formatDateIH(suggestion.date)}</span> </div>
                                <div class="suggestion-status-section"> Status: <span class="suggestion-status ${getStatusClassIH(suggestion.status)}">${escapeHTML(suggestion.status)}</span> </div>
                                <div class="supervisor-reply-section ${suggestion.reply ? '' : 'hidden'}"> <strong>${escapeHTML(adminUser)}'s Reply:</strong> <p class="supervisor-reply">${escapeHTML(suggestion.reply)}</p> </div>
                                <!-- Admin Controls Section -->
                                <div class="admin-controls">
                                    <div class="form-group"> <label for="status-select-${suggestion.id}">Change Status:</label> <select id="status-select-${suggestion.id}" class="admin-status-select form-select form-select-sm"> <option value="Under Review" ${suggestion.status === 'Under Review' ? 'selected' : ''}>Under Review</option> <option value="Implemented" ${suggestion.status === 'Implemented' ? 'selected' : ''}>Implemented</option> <option value="Rejected" ${suggestion.status === 'Rejected' ? 'selected' : ''}>Rejected</option> </select> </div>
                                    <div class="form-group"> <label for="reply-input-${suggestion.id}">Add/Edit Reply:</label> <textarea id="reply-input-${suggestion.id}" class="admin-reply-input form-control form-control-sm" rows="2">${escapeHTML(suggestion.reply)}</textarea> </div>
                                    <div class="admin-actions"> <button class="btn btn-sm btn-primary admin-save-reply">Save Reply</button> <button class="btn btn-sm btn-danger admin-delete">Delete</button> </div>
                                </div>`;
                            suggestionsList.appendChild(card);
                        });
                     }
                 };

                 addListener(suggestionForm, 'submit', (e) => { e.preventDefault(); const text = suggestionText.value.trim(); const author = employeeSelect.value; if (!text || !author) { window.showToast('Please enter your suggestion and select your name.', 'error'); return; } const newSuggestion = { id: Date```javascript
.now(), text: text, author: author, date: new Date().toISOString().split('T')[0], status: "Under Review", reply: "" }; suggestionsData.unshift(newSuggestion); saveData(); renderSuggestions(); suggestionForm.reset(); employeeSelect.value = currentDashboardUser; window.showToast('Suggestion submitted successfully!', 'success'); });
                 addListener(filterStatusSelect, 'change', renderSuggestions);
                 addListener(filterAuthorSelect, 'change', renderSuggestions);
                 addListener(myIdeasToggle, 'click', () => { myIdeasToggle.classList.toggle('active'); if (myIdeasToggle.classList.contains('active')) { myIdeasToggle.textContent = 'Show All Ideas'; myIdeasToggle.classList.remove('btn-secondary'); myIdeasToggle.classList.add('btn-primary'); } else { myIdeasToggle.textContent = 'Show My Ideas Only'; myIdeasToggle.classList.remove('btn-primary'); myIdeasToggle.classList.add('btn-secondary'); } renderSuggestions(); });
                 addListener(suggestionsList, 'click', (e) => { if (!isAdmin) return; const card = e.target.closest('.suggestion-card'); if (!card) return; const suggestionId = parseInt(card.dataset.id); const suggestionIndex = suggestionsData.findIndex(s => s.id === suggestionId); if (suggestionIndex === -1) return; if (e.target.classList.contains('admin-status-select')) { const newStatus = e.target.value; suggestionsData[suggestionIndex].status = newStatus; saveData(); const statusBadge = card.querySelector('.suggestion-status'); statusBadge.textContent = newStatus; statusBadge.className = `suggestion-status ${getStatusClassIH(newStatus)}`; } else if (e.target.classList.contains('admin-save-reply')) { const replyInput = card.querySelector('.admin-reply-input'); const newReply = replyInput.value.trim(); suggestionsData[suggestionIndex].reply = newReply; saveData(); const replySection = card.querySelector('.supervisor-reply-section'); const replyText = card.querySelector('.supervisor-reply'); if (newReply) { replyText.textContent = escapeHTML(newReply); replySection.classList.remove('hidden'); } else { replySection.classList.add('hidden'); } window.showToast('Reply saved.', 'success'); } else if (e.target.classList.contains('admin-delete')) { window.showConfirmModal(`Delete Suggestion`, `Are you sure you want to delete this suggestion?<br><strong>"${escapeHTML(suggestionsData[suggestionIndex].text.substring(0, 50))}..."</strong>`, () => { suggestionsData.splice(suggestionIndex, 1); saveData(); renderSuggestions(); window.showToast('Suggestion deleted.', 'success'); }, 'btn-danger'); } });

                 const setupHub = () => { // Populate dropdowns
                    employeeSelect.innerHTML = '<option value="" disabled>-- Select Your Name --</option>';
                    filterAuthorSelect.innerHTML = '<option value="All">All Authors</option>';
                    employeeNames.forEach(name => {
                        const op1 = new Option(name, name);
                        const op2 = new Option(name, name);
                        employeeSelect.appendChild(op1);
                        filterAuthorSelect.appendChild(op2);
                    });
                    employeeSelect.value = currentDashboardUser; // Pre-select current user

                    if (isAdmin) { hubContainer.classList.add('admin-view'); } else { hubContainer.classList.remove('admin-view'); }
                    renderSuggestions(); // Initial render
                 };
                 setupHub();

                 const cleanup = () => {
                     console.log("Cleaning up Innovation Hub...");
                      listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                     delete window.innovationHubInstance; // Clean up global instance
                     console.log("Innovation Hub cleanup complete.");
                 };
                 window.innovationHubInstance = { renderSuggestions }; // Expose if needed
                 return { cleanup };
             }
         </script>
    </template>

    <!-- NEW: Template for Team Calendar -->
    <template id="teamCalendarAssets">
         <style id="injected-team-calendar-styles">
             /* Scoped Variables */
             #featureSectionsContainer.team-calendar-feature {
                 --app-bg-color: var(--feature-team-calendar-bg-color); --app-text-color: var(--feature-team-calendar-text-color); --app-card-bg-color: var(--feature-team-calendar-card-bg-color); --app-border-color: var(--feature-team-calendar-border-color); --app-primary-color: var(--feature-team-calendar-primary-color); --app-primary-text-color: var(--feature-team-calendar-primary-text-color); --app-secondary-text-color: var(--feature-team-calendar-secondary-text-color); --app-hover-bg-color: var(--feature-team-calendar-hover-bg-color); --app-icon-color: var(--feature-team-calendar-icon-color); --app-shadow-color: var(--feature-team-calendar-shadow-color); --app-modal-overlay-color: var(--feature-team-calendar-modal-overlay-color); --app-page-title-bg: var(--feature-team-calendar-page-title-bg); --app-input-border-color: var(--feature-team-calendar-input-border-color); --app-input-bg-color: var(--feature-team-calendar-input-bg-color); --app-button-secondary-bg: var(--feature-team-calendar-button-secondary-bg); --app-button-secondary-text: var(--feature-team-calendar-button-secondary-text); --app-button-secondary-hover-bg: var(--feature-team-calendar-button-secondary-hover-bg); --app-event-meeting-bg: var(--feature-team-calendar-event-meeting-bg); --app-event-meeting-text: var(--feature-team-calendar-event-meeting-text); --app-event-deadline-bg: var(--feature-team-calendar-event-deadline-bg); --app-event-deadline-text: var(--feature-team-calendar-event-deadline-text); --app-event-task-bg: var(--feature-team-calendar-event-task-bg); --app-event-task-text: var(--feature-team-calendar-event-task-text); --app-event-personal-bg: var(--feature-team-calendar-event-personal-bg); --app-event-personal-text: var(--feature-team-calendar-event-personal-text); --app-event-important-badge: var(--feature-team-calendar-event-important-badge); --app-transition-speed: 0.2s;
             }
              /* Feature Container */
             #featureSectionsContainer.team-calendar-feature > div:first-child { /* Target the wrapping div */
                 background-color: var(--app-bg-color); padding: 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--app-border-color); display: flex; flex-direction: column; min-height: calc(100vh - 150px); /* Adjust as needed */
             }
             body.dark-theme #featureSectionsContainer.team-calendar-feature > div:first-child {
                 background-color: var(--app-bg-color); border-color: var(--app-border-color);
             }
             /* General */
             #featureSectionsContainer.team-calendar-feature { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--app-text-color); line-height: 1.6; }
             #featureSectionsContainer.team-calendar-feature button { cursor: pointer; border: none; background: none; font-family: inherit; padding: 0.5em 1em; border-radius: 6px; transition: background-color var(--app-transition-speed) ease, color var(--app-transition-speed) ease, opacity var(--app-transition-speed) ease; }
             #featureSectionsContainer.team-calendar-feature button:hover { opacity: 0.85; }
             #featureSectionsContainer.team-calendar-feature .icon-button { padding: 0.5em; line-height: 1; color: var(--app-icon-color); font-size: 1.1rem; position: relative; }
             #featureSectionsContainer.team-calendar-feature .icon-button:hover { background-color: var(--app-hover-bg-color); }
             #featureSectionsContainer.team-calendar-feature .hidden { display: none !important; }
             /* Header */
             #featureSectionsContainer.team-calendar-feature .calendar-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; background-color: var(--app-page-title-bg); color: var(--app-text-color); width: 100%; flex-shrink: 0; border-bottom: 1px solid var(--app-border-color); }
             #featureSectionsContainer.team-calendar-feature .nav-button { color: var(--app-icon-color); font-size: 1rem; padding: 0.4rem 0.6rem; }
             #featureSectionsContainer.team-calendar-feature .nav-button:hover { background-color: var(--app-hover-bg-color); }
             #featureSectionsContainer.team-calendar-feature .current-month-year { font-size: 1.4rem; font-weight: 600; color: var(--app-text-color); min-width: 150px; text-align: left; white-space: nowrap; margin-right: auto; }
             #featureSectionsContainer.team-calendar-feature .add-event-button { background-color: var(--app-primary-color); color: var(--app-primary-text-color); font-weight: 500; padding: 0.6rem 1.2rem; display: flex; align-items: center; gap: 0.5rem; margin-left: auto; } /* Use .btn class */
             #featureSectionsContainer.team-calendar-feature .add-event-button i { font-size: 0.9em; }
             #featureSectionsContainer.team-calendar-feature #calendarThemeToggle { margin-left: 0.5rem; }
             /* Page Title */
             #featureSectionsContainer.team-calendar-feature .page-title-container { background-color: var(--app-card-bg-color); color: var(--app-text-color); padding: 0.75rem 1.5rem; border-radius: 8px; margin: 1.5rem; margin-bottom: 0; flex-shrink: 0; text-align: center; border: 1px solid var(--app-border-color); box-shadow: 0 2px 5px var(--app-shadow-color); }
             #featureSectionsContainer.team-calendar-feature .page-title-container h1 { font-size: 1.6rem; font-weight: 600; margin: 0; }
             /* Main Content */
             #featureSectionsContainer.team-calendar-feature .calendar-main-content { flex-grow: 1; overflow: hidden; display: flex; background-color: var(--app-card-bg-color); border-radius: 8px; box-shadow: 0 4px 15px var(--app-shadow-color); border: 1px solid var(--app-border-color); margin: 1.5rem; }
             #featureSectionsContainer.team-calendar-feature #calendar-container { width: 100%; height: 100%; padding: 1rem; overflow-y: auto; }
             /* Calendar Grid */
             #featureSectionsContainer.team-calendar-feature #teamCalendarGrid { width: 100%; border-collapse: collapse; table-layout: fixed; height: 100%; }
             #featureSectionsContainer.team-calendar-feature #teamCalendarGrid thead th { text-align: left !important; padding: 0.75rem; font-weight: 600; font-size: 0.9rem; color: var(--app-secondary-text-color); border-bottom: 2px solid var(--app-border-color); background-color: var(--team-calendar-grid-header-bg); position: sticky; top: 0; z-index: 2; }
             #featureSectionsContainer.team-calendar-feature #teamCalendarGrid tbody td { border: 1px solid var(--team-calendar-grid-border); vertical-align: top; height: 120px; /* Adjust as needed */ }
             #featureSectionsContainer.team-calendar-feature .calendar-day { padding: 8px; background-color: var(--team-calendar-day-bg); height: 100%; display: flex; flex-direction: column; gap: 4px; position: relative; color: var(--app-secondary-text-color); overflow: hidden; }
             #featureSectionsContainer.team-calendar-feature .calendar-day.other-month { color: var(--app-secondary-text-color); opacity: 0.6; background-color: color-mix(in srgb, var(--team-calendar-day-bg) 95%, var(--app-secondary-text-color) 5%); }
             #featureSectionsContainer.team-calendar-feature .calendar-day.current-month { color: var(--app-text-color); }
             #featureSectionsContainer.team-calendar-feature .calendar-day.today { background-color: color-mix(in srgb, var(--team-calendar-day-bg) 90%, var(--app-primary-color) 10%); }
             #featureSectionsContainer.team-calendar-feature .calendar-day.today .day-number { background-color: var(--team-calendar-today-marker-bg); color: var(--team-calendar-today-marker-text); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; position: static; margin-bottom: 6px; }
             #featureSectionsContainer.team-calendar-feature .day-number { font-size: 0.85rem; font-weight: 500; margin-bottom: 6px; display: block; text-align: left; }
             #featureSectionsContainer.team-calendar-feature .event-list { margin-top: 0; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; max-height: calc(100% - 30px); }
             #featureSectionsContainer.team-calendar-feature .event { font-size: 0.8rem; padding: 4px 6px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: opacity var(--app-transition-speed) ease; position: relative; z-index: 0; }
             #featureSectionsContainer.team-calendar-feature .event:hover { opacity: 0.8; }
             #featureSectionsContainer.team-calendar-feature .event-meeting { background-color: var(--app-event-meeting-bg); color: var(--app-event-meeting-text); }
             #featureSectionsContainer.team-calendar-feature .event-deadline { background-color: var(--app-event-deadline-bg); color: var(--app-event-deadline-text); }
             #featureSectionsContainer.team-calendar-feature .event-task { background-color: var(--app-event-task-bg); color: var(--app-event-task-text); }
             #featureSectionsContainer.team-calendar-feature .event-personal { background-color: var(--app-event-personal-bg); color: var(--app-event-personal-text); }
             #featureSectionsContainer.team-calendar-feature .event .employee-name { font-size: 0.7em; margin-left: 5px; opacity: 0.8; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 50px; }
             #featureSectionsContainer.team-calendar-feature .event.important .event-badge { background-color: var(--app-event-important-badge); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 0.7rem; display: inline-flex; justify-content: center; align-items: center; margin-left: 4px; font-weight: bold; flex-shrink: 0; }
             /* Modal Styles (Use dashboard generic .modal) */
             #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 0.5rem; }
             #featureSectionsContainer.team-calendar-feature #add-event-modal .form-group { margin-bottom: 1rem; }
             #featureSectionsContainer.team-calendar-feature #add-event-modal .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; color: var(--app-secondary-text-color); }
             #featureSectionsContainer.team-calendar-feature #add-event-modal .form-group input[type="text"], #featureSectionsContainer.team-calendar-feature #add-event-modal input[type="date"], #featureSectionsContainer.team-calendar-feature #add-event-modal input[type="time"], #featureSectionsContainer.team-calendar-feature #add-event-modal select, #featureSectionsContainer.team-calendar-feature #add-event-modal textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--app-input-border-color); border-radius: 6px; font-size: 0.95rem; background-color: var(--app-input-bg-color); color: var(--app-text-color); transition: border-color var(--app-transition-speed) ease, box-shadow var(--app-transition-speed) ease; }
             #featureSectionsContainer.team-calendar-feature #add-event-modal .form-group input:focus, #featureSectionsContainer.team-calendar-feature #add-event-modal select:focus, #featureSectionsContainer.team-calendar-feature #add-event-modal textarea:focus { outline: none; border-color: var(--app-primary-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
             #featureSectionsContainer.team-calendar-feature #add-event-modal .form-group textarea { resize: vertical; min-height: 80px; }
             /* Responsiveness */
             @media (max-width: 992px) { #featureSectionsContainer.team-calendar-feature .calendar-page-container { padding: 0.75rem; } #featureSectionsContainer.team-calendar-feature #calendar-container { padding: 0.75rem; } #featureSectionsContainer.team-calendar-feature .event { font-size: 0.78rem; } #featureSectionsContainer.team-calendar-feature #teamCalendarGrid tbody td { height: 100px; } #featureSectionsContainer.team-calendar-feature .page-title-container h1 { font-size: 1.5rem; } }
             @media (max-width: 768px) { #featureSectionsContainer.team-calendar-feature .calendar-header { padding: 0.5rem 1rem; gap: 0.5rem; flex-wrap: wrap; } #featureSectionsContainer.team-calendar-feature .current-month-year { font-size: 1.2rem; min-width: auto; margin-right: 0; order: 1; } #featureSectionsContainer.team-calendar-feature .nav-button { order: 0; } #featureSectionsContainer.team-calendar-feature .add-event-button { order: 2; margin-left: auto; padding: 0.5rem 0.8rem; } #featureSectionsContainer.team-calendar-feature #calendarThemeToggle { order: 3; margin-left: 0.25rem; } #featureSectionsContainer.team-calendar-feature .calendar-page-container { padding: 0.5rem; gap: 0.75rem; } #featureSectionsContainer.team-calendar-feature #calendar-container { padding: 0.5rem; } #featureSectionsContainer.team-calendar-feature .event { font-size: 0.75rem; padding: 3px 5px; } #featureSectionsContainer.team-calendar-feature .day-number { font-size: 0.8rem; } #featureSectionsContainer.team-calendar-feature .event-list { margin-top: 25px; } #featureSectionsContainer.team-calendar-feature #teamCalendarGrid tbody td { height: 80px; } #featureSectionsContainer.team-calendar-feature .page-title-container { padding: 0.6rem 1rem; margin: 1rem; margin-bottom: 0; } #featureSectionsContainer.team-calendar-feature .page-title-container h1 { font-size: 1.4rem; } #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-content { padding: 1rem 1.5rem; width: 95%; } #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-header h2 { font-size: 1.2rem; } #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-footer { justify-content: center; flex-wrap: wrap; } #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-button { width: 100%; text-align: center;} #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-button:first-child { margin-bottom: 0.5rem; } }
             @media (max-width: 480px) { #featureSectionsContainer.team-calendar-feature .calendar-header { flex-wrap: wrap; justify-content: space-between; } #featureSectionsContainer.team-calendar-feature .nav-button { padding: 0.4rem; } #featureSectionsContainer.team-calendar-feature .current-month-year { font-size: 1.1rem; order: 1; flex-basis: 100%; text-align: center; margin-top: 0.5rem; } #featureSectionsContainer.team-calendar-feature .add-event-button span { display: none; } #featureSectionsContainer.team-calendar-feature .add-event-button { order: 2; padding: 0.6rem; margin-left: 0; } #featureSectionsContainer.team-calendar-feature .add-event-button i { margin: 0; font-size: 1rem; } #featureSectionsContainer.team-calendar-feature #calendarThemeToggle { order: 3; margin-left: 0.5rem; font-size: 1rem; padding: 0.4em;} #featureSectionsContainer.team-calendar-feature #teamCalendarGrid tbody td { height: 70px; } #featureSectionsContainer.team-calendar-feature .day-number { font-size: 0.75rem; } #featureSectionsContainer.team-calendar-feature .event-list { margin-top: 22px; } #featureSectionsContainer.team-calendar-feature .page-title-container { padding: 0.5rem 0.8rem; margin: 0.75rem; margin-bottom: 0;} #featureSectionsContainer.team-calendar-feature .page-title-container h1 { font-size: 1.2rem; } #featureSectionsContainer.team-calendar-feature #add-event-modal .modal-content { padding: 1rem; } }
         </style>
         <div class="calendar-page-container"> <!-- Wrapper div -->
             <header class="calendar-header">
                 <button class="nav-button btn btn-sm btn-outline-secondary" id="prev-month" aria-label="Previous Month"><i class="fas fa-chevron-left"></i></button>
                 <button class="nav-button btn btn-sm btn-outline-secondary" id="next-month" aria-label="Next Month"><i class="fas fa-chevron-right"></i></button>
                 <h2 class="current-month-year" id="current-month-year">May 2025</h2>
                 <button class="add-event-button btn btn-primary btn-sm" id="add-event"><i class="fas fa-plus"></i> <span>Add Event</span></button>
                 <button id="calendarThemeToggle" class="icon-button btn btn-sm btn-outline-secondary" aria-label="Toggle Theme"><i class="fas fa-moon"></i></button>
             </header>
             <div class="page-title-container"> <h1>Team Calendar</h1> </div>
             <main class="calendar-main-content">
                 <div id="calendar-container">
                    <table id="teamCalendarGrid">
                         <thead>
                             <tr>
                                 <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                             </tr>
                         </thead>
                         <tbody id="calendar-grid-body">
                             <!-- Calendar days will be rendered here by JS -->
                              <tr><td colspan="7" class="text-center p-5 text-muted"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Loading Calendar...</td></tr>
                         </tbody>
                     </table>
                 </div>
             </main>
         </div> <!-- End calendar-page-container -->
         <!-- Add Event Modal (Uses Dashboard Generic Modal Structure) -->
         <div id="add-event-modal" class="modal"> <!-- Adjusted class for dashboard JS -->
              <div class="modal-content">
                 <div class="modal-header">
                    <h3 class="modal-title">Add New Event</h3> <!-- Use h3 -->
                    <button class="close-modal" data-close-modal>&times;</button> <!-- Use standard close -->
                 </div>
                 <div class="modal-body">
                     <form id="add-event-form">
                         <div class="form-group"><label for="event-title">Event Title</label><input type="text" id="event-title" name="event-title" required class="form-control"></div>
                         <div class="form-group"><label for="event-employee">Assignee</label><select id="event-employee" name="event-employee" class="form-select"><option value="">Select Employee...</option></select></div>
                         <div class="form-group"><label for="event-date">Date</label><input type="date" id="event-date" name="event-date" required class="form-control"></div>
                         <div class="form-group"><label for="event-time">Time (Optional)</label><input type="time" id="event-time" name="event-time" class="form-control"></div>
                         <div class="form-group"><label for="event-type">Event Type</label><select id="event-type" name="event-type" class="form-select"><option value="meeting">Meeting</option><option value="deadline">Deadline</option><option value="task">Task</option><option value="personal">Personal</option></select></div>
                         <div class="form-group"><label for="event-description">Description (Optional)</label><textarea id="event-description" name="event-description" rows="3" class="form-control"></textarea></div>
                         <div class="form-group"><label class="d-flex align-items-center"><input type="checkbox" id="event-important" name="event-important" class="form-check-input me-2"> Mark as Important</label></div>
                     </form>
                 </div>
                 <div class="form-actions modal-footer"> <!-- Use dashboard footer -->
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" form="add-event-form" class="btn btn-primary">Save Event</button>
                 </div>
             </div>
         </div>
         <script>
             function initializeTeamCalendarFeature(container) {
                console.log("Initializing Team Calendar Feature..."); // Debug log
                const pageContainer = container.querySelector('.calendar-page-container');
                if (!pageContainer) { console.error("Team Calendar page container not found!"); return { cleanup: () => {} }; }

                const addEventButton = pageContainer.querySelector('#add-event');
                const addEventModal = document.getElementById('add-event-modal'); // Global modal
                const calendarThemeToggle = pageContainer.querySelector('#calendarThemeToggle');
                const prevMonthButton = pageContainer.querySelector('#prev-month');
                const nextMonthButton = pageContainer.querySelector('#next-month');
                const currentMonthYearDisplay = pageContainer.querySelector('#current-month-year');
                const calendarGridBody = pageContainer.querySelector('#calendar-grid-body');
                const eventForm = addEventModal?.querySelector('#add-event-form');
                const employeeSelect = addEventModal?.querySelector('#event-employee');
                const eventDateInput = addEventModal?.querySelector('#event-date');

                if (!addEventButton || !addEventModal || !calendarThemeToggle || !prevMonthButton || !nextMonthButton || !currentMonthYearDisplay || !calendarGridBody || !eventForm || !employeeSelect) {
                    console.error("Essential Team Calendar elements missing!");
                    if(calendarGridBody) calendarGridBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-danger">Error loading calendar components.</td></tr>';
                    return { cleanup: () => {} };
                }

                let listeners = [];
                const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                const escapeHTML = (str) => { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };

                let currentDate = new Date(); // State for the currently displayed month
                let eventsData = JSON.parse(localStorage.getItem('teamCalendarEventsV1')) || [
                    { id: 1, title: "Team Sync", employee: "Nada Mahmoud", date: "2025-05-01", time: "10:00", type: "meeting", description: "Weekly sync", important: false },
                    { id: 2, title: "Project Alpha Due", employee: "Team", date: "2025-05-01", time: "", type: "deadline", description: "", important: true },
                    { id: 3, title: "Design Review", employee: "Yousef Ahmed", date: "2025-05-02", time: "14:30", type: "task", description: "Review V2 mockups", important: false },
                    { id: 4, title: "Doc Appointment", employee: "Mohamed Elmenisy", date: "2025-05-03", time: "09:00", type: "personal", description: "", important: false },
                    { id: 5, title: "Client Call", employee: "Esraa Lashin", date: "2025-05-07", time: "11:00", type: "meeting", description: "Discuss project Beta", important: false },
                    { id: 6, title: "Deploy Staging", employee: "Mohamed Elmenisy", date: "2025-05-10", time: "16:00", type: "task", description: "", important: true },
                ];

                function saveEvents() { localStorage.setItem('teamCalendarEventsV1', JSON.stringify(eventsData)); }
                function getEventTypeClass(type) { return `event-${type.toLowerCase()}`; }

                function renderCalendar(date) {
                    calendarGridBody.innerHTML = ''; // Clear previous grid
                    currentDate = new Date(date.getFullYear(), date.getMonth(), 1); // Ensure we're at the start of the month
                    currentMonthYearDisplay.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth(); // 0-indexed
                    const firstDayOfMonth = new Date(year, month, 1);
                    const lastDayOfMonth = new Date(year, month + 1, 0);
                    const daysInMonth = lastDayOfMonth.getDate();
                    const startDayOfWeek = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1; // 0=Mon, 6=Sun

                    let dayCounter = 1;
                    let otherMonthDayStart = new Date(year, month, 1 - startDayOfWeek).getDate();
                    let otherMonthDayEnd = 1;
                    const totalCells = Math.ceil((daysInMonth + startDayOfWeek) / 7) * 7; // Ensure full weeks

                    for (let i = 0; i < totalCells / 7; i++) {
                        const row = calendarGridBody.insertRow();
                        for (let j = 0; j < 7; j++) {
                            const cell = row.insertCell();
                            cell.classList.add('calendar-day');
                            const dayNumberSpan = document.createElement('span');
                            dayNumberSpan.classList.add('day-number');
                            const eventListDiv = document.createElement('div');
                            eventListDiv.classList.add('event-list');

                            const cellIndex = i * 7 + j;
                            let cellDate;

                            if (cellIndex < startDayOfWeek) {
                                cell.classList.add('other-month');
                                dayNumberSpan.textContent = otherMonthDayStart++;
                                cellDate = new Date(year, month - 1, dayNumberSpan.textContent);
                            } else if (dayCounter <= daysInMonth) {
                                cell.classList.add('current-month');
                                dayNumberSpan.textContent = dayCounter;
                                cellDate = new Date(year, month, dayCounter);
                                const today = new Date();
                                if (cellDate.toDateString() === today.toDateString()) {
                                    cell.classList.add('today');
                                }
                                dayCounter++;
                            } else {
                                cell.classList.add('other-month');
                                dayNumberSpan.textContent = otherMonthDayEnd++;
                                cellDate = new Date(year, month + 1, dayNumberSpan.textContent);
                            }

                            const dateKey = cellDate.toLocaleDateString('en-CA'); // YYYY-MM-DD
                            const todaysEvents = eventsData.filter(event => event.date === dateKey);
                            todaysEvents.sort((a,b) => (a.time || '23:59').localeCompare(b.time || '23:59')); // Sort by time

                            todaysEvents.forEach(event => {
                                const eventDiv = document.createElement('div');
                                eventDiv.classList.add('event', getEventTypeClass(event.type));
                                if (event.important) eventDiv.classList.add('important');
                                eventDiv.dataset.eventId = event.id;
                                eventDiv.title = `${event.title} (${event.employee || 'Team'})${event.time ? ' at ' + event.time : ''}\n${event.description || ''}`;

                                const titleSpan = document.createElement('span');
                                titleSpan.textContent = event.title;
                                eventDiv.appendChild(titleSpan);

                                if (event.important) {
                                     const badge = document.createElement('span'); badge.classList.add('event-badge'); badge.innerHTML = '!'; eventDiv.appendChild(badge);
                                } else if (event.employee && event.employee !== 'Team') {
                                    const employeeSpan = document.createElement('span');
                                    employeeSpan.classList.add('employee-name');
                                    const nameParts = event.employee.split(' ');
                                    employeeSpan.textContent = nameParts[0].charAt(0) + (nameParts[1] ? nameParts[1].charAt(0) : '');
                                    employeeSpan.title = event.employee;
                                    eventDiv.appendChild(employeeSpan);
                                }
                                eventListDiv.appendChild(eventDiv);
                            });

                            cell.appendChild(dayNumberSpan);
                            cell.appendChild(eventListDiv);
                        }
                    }
                }

                const showModal = (date = null) => { if (addEventModal) { if (date) { eventDateInput.value = date; } else { eventDateInput.value = ''; } addEventModal.classList.add('active'); document.body.style.overflow = 'hidden'; } };
                const hideModal = () => { if (addEventModal) { addEventModal.classList.remove('active'); eventForm.reset(); document.body.style.overflow = ''; } };

                // Populate employee dropdown
                if (employeeSelect && window.MOCK_USERS) {
                    window.MOCK_USERS.forEach(user => {
                        const option = new Option(user.name, user.name);
                        employeeSelect.appendChild(option);
                    });
                    employeeSelect.appendChild(new Option('Team / General', 'Team'));
                }

                // Event Listeners
                addListener(addEventButton, 'click', () => showModal());
                addListener(eventForm, 'submit', (e) => { e.preventDefault(); console.log('Event Form submitted.'); const formData = new FormData(eventForm); const eventData = { id: Date.now(), title: formData.get('event-title'), employee: formData.get('event-employee') || 'Team', date: formData.get('event-date'), time: formData.get('event-time') || '', type: formData.get('event-type'), description: formData.get('event-description') || '', important: formData.has('event-important') }; if (!eventData.title || !eventData.date) { window.showToast('Title and Date are required.', 'error'); return; } eventsData.push(eventData); saveEvents(); renderCalendar(currentDate); hideModal(); window.showToast('Event saved successfully!', 'success'); });
                // Close listeners handled by main script's generic modal logic
                addListener(calendarThemeToggle, 'click', () => { window.showToast("Theme toggle affects main dashboard.", 'info'); document.querySelector('#preferencesPanel .theme-option[data-theme="dark"]').click(); });
                addListener(prevMonthButton, 'click', () => renderCalendar(new Date(currentDate.setMonth(currentDate.getMonth() - 1))));
                addListener(nextMonthButton, 'click', () => renderCalendar(new Date(currentDate.setMonth(currentDate.getMonth() + 1))));
                addListener(calendarGridBody, 'click', (e) => { const eventDiv = e.target.closest('.event'); if (eventDiv && eventDiv.dataset.eventId) { const eventId = parseInt(eventDiv.dataset.eventId); const event = eventsData.find(ev => ev.id === eventId); if (event) { Swal.fire({ title: `<strong>${escapeHTML(event.title)}</strong>`, icon: 'info', html: `<div style="text-align: left;"> <b>Date:</b> ${formatDateDT(event.date)} ${event.time ? '@ ' + event.time : ''}<br> <b>Assignee:</b> ${escapeHTML(event.employee || 'Team')}<br> <b>Type:</b> ${escapeHTML(event.type)}<br> ${event.description ? `<b>Desc:</b> ${escapeHTML(event.description)}<br>` : ''} ${event.important ? '<b>Marked Important</b>' : ''} </div>`, showCloseButton: true, showCancelButton: true, focusConfirm: false, confirmButtonText: '<i class="fas fa-trash-alt"></i> Delete', confirmButtonColor: 'var(--danger)', cancelButtonText: '<i class="fas fa-times"></i> Close', cancelButtonAriaLabel: 'Close' }).then((result) => { if (result.isConfirmed) { // Delete event eventsData = eventsData.filter(ev => ev.id !== eventId); saveEvents(); renderCalendar(currentDate); window.showToast('Event deleted.', 'success'); } }); } } });

                // Initial Render
                renderCalendar(new Date()); // Render current month

                const cleanup = () => {
                    console.log("Cleaning up Team Calendar...");
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = [];
                     hideModal(); // Ensure modal is hidden
                     delete window.teamCalendarInstance; // Clean up global instance
                    console.log("Team Calendar cleanup complete.");
                 };
                 window.teamCalendarInstance = { renderCalendar }; // Expose if needed
                 return { cleanup };
             }
         </script>
    </template>

    <!-- Placeholder Template for unimplemented features -->
    <template id="placeholderAssets">
        <div class="placeholder-content">
            <h2>Feature Coming Soon</h2>
            <p>This section is under development.</p>
        </div>
    </template>


    <!-- ========= END Feature Templates ========= -->


    <!-- JS Libraries (Bootstrap, Chart.js, SweetAlert2, jsPDF, jsPDF-AutoTable, SheetJS) -->
    <!-- Ensure Bootstrap is first -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script> <!-- Updated Autotable version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <script>
        // Wait for the DOM to be fully loaded before running any scripts
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = document.getElementById('featureTitle');
            const featureDescEl = document.getElementById('featureDescription');
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModal = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModal = document.getElementById('projectModal'); // NEW: Project Modal
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button


            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = []; // Store all loaded activities
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let currentFeatureCleanup = null; // Stores the cleanup function for the loaded feature
            let MOCK_PROJECTS_DATA = []; // To store projects data


            // --- Mock Data ---
             window.MOCK_USERS = [ // Expose globally for features
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [ // Renamed to avoid conflict, used for search/activity generation
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            const MOCK_TASKS = [ // Used for search/activity generation
                { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
            ];

             // Global Utilities (Ensure these are defined before use in features)
             window.timeAgo = function(timestamp) { if (!(timestamp instanceof Date)) { const date = new Date(timestamp); if (isNaN(date.getTime())) return ''; timestamp = date; } const now = new Date(); const secondsPast = (now.getTime() - timestamp.getTime()) / 1000; if (secondsPast < 10) { return 'Just now'; } if (secondsPast < 60) { return parseInt(secondsPast) + 's ago'; } if (secondsPast < 3600) { return parseInt(secondsPast / 60) + 'm ago'; } if (secondsPast < 3600 * 24) { return parseInt(secondsPast / 3600) + 'h ago'; } return formatDateForDisplay(timestamp); }
             window.formatDateForDisplay = function(date) { if (!date) return 'N/A'; if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; const year = date.getFullYear(); const month = date.getMonth() + 1; const day = date.getDate(); const monthPadded = String(month).padStart(2, '0'); const dayPadded = String(day).padStart(2, '0'); const monthName = date.toLocaleDateString(undefined, { month: 'short' }); try { switch (dateFormat) { case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`; case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`; case 'Month D, YYYY': return `${monthName} ${day}, ${year}`; case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`; } } catch (e) { console.error("Error formatting date:", e); return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`; } }
             window.formatFullDateTime = function(date) { if (!date) return 'N/A'; if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const formattedDate = formatDateForDisplay(date); const timeFormat = localStorage.getItem('timeFormat') || '12h'; const options = { hour: 'numeric', minute: 'numeric', hour12: timeFormat === '12h' }; try { const formattedTime = date.toLocaleTimeString(undefined, options); return `${formattedDate}, ${formattedTime}`; } catch (e) { console.error("Error formatting time:", e); return formattedDate; } }
             window.generateMockActivities = function(count, baseTimestampMillis) { const nowMillis=baseTimestampMillis||Date.now();const newActivities=[];let users=window.MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const actions=['updated profile','completed task','added project','commented on task','uploaded file','joined team'];const icons=['fa-user-edit','fa-check-circle','fa-plus-circle','fa-comment','fa-upload','fa-user-plus'];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=window.MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);const files=['doc.pdf','img.png','sheet.xlsx','pres.pptx'];for(let i=0;i<count;i++){const user=users[Math.floor(Math.random()*users.length)];const actionIndex=Math.floor(Math.random()*actions.length);let message=`${user} ${actions[actionIndex]}`;if(actions[actionIndex].includes('task')&&tasks.length>0){message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;}else if(actions[actionIndex].includes('project')&&projects.length>0){message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;}else if(actions[actionIndex].includes('file')&&files.length>0){message+=` ${files[Math.floor(Math.random()*files.length)]}`;}let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*10;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.5+300000);}timestampMillis=Math.min(timestampMillis,nowMillis);newActivities.push({id:nowMillis+i+Math.floor(Math.random()*1000),icon:icons[actionIndex],message:message,timestamp:new Date(timestampMillis),isNew:false});}return count>1?newActivities.sort((a,b)=>b.timestamp-a.timestamp):newActivities; }
             window.generateMockNotifications = function(count, baseTimestampMillis) { const nowMillis=baseTimestampMillis||Date.now();const newNotifications=[];const types=[{msg:'New task assigned:',icon:'fa-tasks',type:'task'},{msg:'Project deadline approaching:',icon:'fa-clock',type:'project'},{msg:'Mentioned you:',icon:'fa-comment-dots',type:'comment'},{msg:'System update:',icon:'fa-info-circle',type:'system'},{msg:'File shared:',icon:'fa-file-alt',type:'file'},];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=window.MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);let users=window.MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const files=['report.docx','logo.svg','data.csv'];for(let i=0;i<count;i++){const typeInfo=types[Math.floor(Math.random()*types.length)];let message=typeInfo.msg;if(typeInfo.type==='task'&&tasks.length>0)message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;else if(typeInfo.type==='project'&&projects.length>0)message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;else if(typeInfo.type==='comment'&&users.length>0)message+=` by ${users[Math.floor(Math.random()*users.length)]}`;else if(typeInfo.type==='file'&&files.length>0&&users.length>0)message+=` ${files[Math.floor(Math.random()*files.length)]} by ${users[Math.floor(Math.random()*users.length)]}`;let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*15;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.8+180000);}timestampMillis=Math.min(timestampMillis,nowMillis);newNotifications.push({id:nowMillis+i+10000+Math.floor(Math.random()*1000),icon:typeInfo.icon,message:message,timestamp:new Date(timestampMillis),unread:count===1?true:Math.random()>0.3});}return count>1?newNotifications.sort((a,b)=>b.timestamp-a.timestamp):newNotifications; }
             window.showConfirmModal = function(title, message, onConfirm, buttonClass = 'btn-danger') { confirmTitle.textContent = title; confirmMessage.innerHTML = message; confirmCallback = onConfirm; confirmBtn.className = 'btn'; confirmBtn.classList.add(buttonClass); confirmModal.classList.add('active'); document.body.style.overflow = 'hidden'; } // Lock scroll
             function hideConfirmModal() { confirmModal.classList.remove('active'); confirmCallback = null; document.body.style.overflow = ''; } // Unlock scroll
             window.showSuccessMessage = function(message) { successMessageText.textContent = message; successMessage.classList.add('show'); setTimeout(() => { successMessage.classList.remove('show'); }, 3000); }
             window.showToast = function(message, type = 'info') { if (!showToasts && type !== 'error') { console.log("Toast suppressed:", message); return; } toastMessage.textContent = message; toastMessage.className = 'toast'; if (type === 'success') { toastMessage.classList.add('success'); } else if (type === 'error') { toastMessage.classList.add('error'); } toastMessage.classList.add('show'); setTimeout(() => { toastMessage.classList.remove('show'); }, 3000); }


            // --- Initialization ---
            function initDashboard() {
                currentUser = { ...MOCK_USERS[0] }; // Simulate logged-in user
                window.currentUser = currentUser; // Make available globally
                console.log("Initializing dashboard for:", currentUser.name);

                applyStoredPreferences();
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Handle hash on load
                startDynamicUpdates();
                setupResponsiveSidebar();
            }

            // --- UI Updates ---
            function updateUserUI() {
                if (!currentUser) return;
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) { document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`; document.getElementById('userAvatar').textContent = ''; } else { document.getElementById('userAvatar').style.backgroundImage = 'none'; document.getElementById('userAvatar').textContent = currentUser.initials; }
                document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userInfoName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) { document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`; document.getElementById('profileAvatar').textContent = ''; } else { document.getElementById('profileAvatar').style.backgroundImage = 'none'; document.getElementById('profileAvatar').textContent = currentUser.initials; }
                const roleTitle = document.getElementById('userInfoRoleTitle'); roleTitle.textContent = formatRole(currentUser.role); roleTitle.className = `user-info-title role-${currentUser.role}`;
                updateProfileForm();
                profileAvatarLarge.textContent = currentUser.initials;
                if (currentUser.avatar) { profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`; profileAvatarLarge.textContent = ''; } else { profileAvatarLarge.style.backgroundImage = 'none'; profileAvatarLarge.textContent = currentUser.initials; }
                if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;
                const teamSettingsTab = document.getElementById('teamSettingsTab'); const dangerZoneTab = document.getElementById('dangerZoneTab'); const deleteAllUsersSection = document.getElementById('deleteAllUsersSection');
                if (currentUser.role === 'admin') { if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; if (dangerZoneTab) dangerZoneTab.style.display = 'flex'; if (deleteAllUsersSection) deleteAllUsersSection.style.display = 'block'; } else { if (teamSettingsTab) teamSettingsTab.style.display = 'none'; if (dangerZoneTab) dangerZoneTab.style.display = 'none'; if (deleteAllUsersSection) deleteAllUsersSection.style.display = 'none'; if (currentFeature === 'settings' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) { activateSettingsTab('preferences'); } }
                update2FA_UI(); if (userPhoneNumberForSms) userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
            }
            function updateProfileForm() { if (!currentUser) return; const nameParts = currentUser.name.split(' '); firstNameInput.value = nameParts[0] || ''; lastNameInput.value = nameParts.slice(1).join(' ') || ''; fullNameDisplay.value = currentUser.name; jobTitleInput.value = currentUser.title || ''; emailDisplay.value = currentUser.email || ''; phoneInput.value = currentUser.phone || ''; departmentInput.value = currentUser.department || ''; }
            function formatRole(role) { if (!role) return 'Member'; return role.charAt(0).toUpperCase() + role.slice(1); }

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() { const storedTheme = localStorage.getItem('theme') || 'system'; setTheme(storedTheme); const storedContrast = localStorage.getItem('highContrast') === 'true'; setContrast(storedContrast); if (highContrastToggle) highContrastToggle.checked = storedContrast; const storedLang = localStorage.getItem('language') || 'en'; if (languageSelect) languageSelect.value = storedLang; applyLanguage(storedLang); const storedRegion = localStorage.getItem('region') || 'utc'; if (regionSelect) regionSelect.value = storedRegion; const storedTimeFormat = localStorage.getItem('timeFormat') || '12h'; const storedDateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; if (timeFormatSelect) timeFormatSelect.value = storedTimeFormat; if (dateFormatSelect) dateFormatSelect.value = storedDateFormat; applyDateTimeFormat(storedTimeFormat, storedDateFormat); const storedToastPref = localStorage.getItem('showToasts'); showToasts = storedToastPref === null ? true : (storedToastPref === 'true'); if (toastToggle) toastToggle.checked = showToasts; const storedSoundPref = localStorage.getItem('playSounds'); playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true'); if (soundToggle) soundToggle.checked = playSounds; }
            function setTheme(theme) { console.log("Setting theme:", theme); document.body.classList.remove('light-theme', 'dark-theme'); if (theme === 'system') { const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.classList.add(prefersDark ? 'dark-theme' : 'light-theme'); console.log("System prefers dark:", prefersDark); } else { document.body.classList.add(`${theme}-theme`); } themeOptions.forEach(option => { option.classList.toggle('selected', option.dataset.theme === theme); }); localStorage.setItem('theme', theme); }
            function setContrast(enabled) { console.log("Setting high contrast:", enabled); document.body.classList.toggle('high-contrast', enabled); localStorage.setItem('highContrast', enabled); }
             function applyLanguage(lang) { console.log("Applying language:", lang); document.documentElement.lang = lang; const elementsToTranslate = [ { selector: '[data-feature="dashboard"] span', en: 'Dashboard', ar: 'لوحة التحكم' }, { selector: '[data-feature="projects"] span', en: 'Projects', ar: 'المشاريع' }, { selector: '[data-feature="reports-analytics"] span', en: 'Reports & Analytics', ar: 'التقارير والتحليلات' }, { selector: '[data-feature="team-members-view"] span', en: 'Team Members', ar: 'أعضاء الفريق' }, { selector: '[data-feature="file-sharing"] span', en: 'File Sharing', ar: 'مشاركة الملفات' }, { selector: '[data-feature="project-tracking"] span', en: 'Project Tracking', ar: 'تتبع المشاريع' }, { selector: '[data-feature="task-management"] span', en: 'Task Management', ar: 'إدارة المهام' }, { selector: '[data-feature="data-management"] span', en: 'Data Management', ar: 'إدارة البيانات' }, { selector: '[data-feature="employee-scheduling"] span', en: 'Employee Scheduling', ar: 'جدولة الموظفين' }, { selector: '[data-feature="deadline-tracker"] span', en: 'Deadline Tracker', ar: 'متتبع المواعيد' }, { selector: '[data-feature="team-calendar"] span', en: 'Team Calendar', ar: 'تقويم الفريق' }, { selector: '[data-feature="innovation-hub"] span', en: 'Innovation Hub', ar: 'مركز الابتكار' }, { selector: '[data-feature="settings"] span', en: 'Settings', ar: 'الإعدادات' }, { selector: '[data-feature="profile"] span', en: 'Profile', ar: 'الملف الشخصي' } ]; if (lang === 'ar') { document.body.dir = 'rtl'; if (document.getElementById('welcomeName')) document.getElementById('welcomeName').textContent = "مستخدم"; elementsToTranslate.forEach(el => { const element = document.querySelector(el.selector); if (element) element.textContent = el.ar; }); } else { document.body.dir = 'ltr'; if (document.getElementById('welcomeName') && currentUser) document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0]; elementsToTranslate.forEach(el => { const element = document.querySelector(el.selector); if (element) element.textContent = el.en; }); } localStorage.setItem('language', lang); }
            function applyDateTimeFormat(timeFormat, dateFormat) { console.log("Applying DateTime Format:", timeFormat, dateFormat); localStorage.setItem('timeFormat', timeFormat); localStorage.setItem('dateFormat', dateFormat); const elementsNeedingUpdate = document.querySelectorAll('.activity-time, .notification-time, .upload-date, .creation-date, .last-updated, .date, .deadline'); elementsNeedingUpdate.forEach(el => { const timestamp = el.getAttribute('title'); if (timestamp) { try { const date = new Date(timestamp); if (!isNaN(date)) { el.textContent = window.timeAgo(date); } } catch (e) { /* Ignore errors if title isn't a valid date */ } } }); /* Add calls to re-render specific feature tables/lists if needed */ if (typeof window.dataManagementInstance?.renderTable === 'function') window.dataManagementInstance.renderTable(); if (typeof window.deadlineTrackerInstance?.renderTasks === 'function') window.deadlineTrackerInstance.renderTasks(); if (typeof window.innovationHubInstance?.renderSuggestions === 'function') window.innovationHubInstance.renderSuggestions(); if (typeof window.teamCalendarInstance?.renderCalendar === 'function') window.teamCalendarInstance.renderCalendar(currentDate); if (typeof window.fileSharingInstance?.applyFilters === 'function') window.fileSharingInstance.applyFilters(); if (typeof window.projectTrackingInstance?.renderTable === 'function') window.projectTrackingInstance.renderTable(); if (typeof window.renderSchedule === 'function') window.renderSchedule(currentScheduleWeekOffset); }
            function applyToastPreference(enabled) { console.log("Applying toast preference:", enabled); showToasts = enabled; localStorage.setItem('showToasts', enabled); }
            function applySoundPreference(enabled) { console.log("Applying sound preference:", enabled); playSounds = enabled; localStorage.setItem('playSounds', enabled); }

            // --- Navigation & Content Loading ---
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));

                 // --- Cleanup previous feature ---
                 removeInjectedStyles();
                 if (typeof currentFeatureCleanup === 'function') {
                     try { currentFeatureCleanup(); } catch (e) { console.error("Error during feature cleanup:", e); }
                     currentFeatureCleanup = null;
                 }
                 // --- End Cleanup ---

                currentFeature = featureId;

                // Update Menu Items
                menuItems.forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                });

                // Hide all top-level content sections first
                contentSections.forEach(section => section.classList.remove('active'));
                featureSectionsContainer.classList.remove('active'); // Ensure feature container is hidden initially

                // Reset feature container styles and content if it's not the target
                 if (featureId !== 'dashboard' && featureId !== 'profile' && featureId !== 'settings') {
                     featureSectionsContainer.className = 'content-section feature-container'; // Reset classes, keep 'content-section' for potential base styles
                     featureSectionsContainer.innerHTML = ''; // Clear dynamic content
                     featureSectionsContainer.appendChild(featurePlaceholder); // Re-add placeholder for loading state
                     featurePlaceholder.style.display = 'flex'; // Show placeholder
                     featureLoadingEl.style.display = 'none';
                     featureErrorEl.style.display = 'none';
                 } else {
                      featurePlaceholder.style.display = 'none'; // Hide placeholder if not loading a feature
                 }

                // Show the correct section
                let targetSection = null;
                let isFeatureSection = false;

                if (featureId === 'dashboard') {
                    targetSection = dashboardContent;
                    backButton.style.display = 'none';
                } else if (featureId === 'profile') {
                    targetSection = profileContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                     updateProfileForm(); // Ensure form data is current
                } else if (featureId === 'settings') {
                    targetSection = settingsContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    currentSettingsTab = settingsTab || (currentUser.role === 'admin' ? 'preferences' : 'preferences');
                     if (currentUser.role !== 'admin' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) { currentSettingsTab = 'preferences'; }
                    activateSettingsTab(currentSettingsTab);
                     update2FA_UI(); // Update 2FA display when security tab is shown
                } else {
                    isFeatureSection = true;
                    targetSection = featureSectionsContainer; // The feature container itself
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    loadFeatureContent(featureId); // Load content into feature container
                }

                if (targetSection) {
                    targetSection.classList.add('active'); // Activate the correct container
                }

                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                    if(closeSidebar) closeSidebar.style.display = 'none';
                }
                // Close user dropdown if open
                if (userDropdownOpen) { userDropdown.classList.remove('active'); userDropdownOpen = false; }

                if (!skipHistory) { updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null); }
                window.scrollTo(0, 0); // Scroll to top on navigation
            }

            function activateSettingsTab(tabId) { console.log(`Activating settings tab: ${tabId}`); currentSettingsTab = tabId; document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId)); document.querySelectorAll('.settings-panel').forEach(panel => panel.classList.toggle('active', panel.id === `${tabId}Panel`)); if (tabId === 'team' && currentUser.role === 'admin') { loadTeamMembers(); } if (tabId === 'security') { update2FA_UI(); } if (tabId === 'account' && accountEmailDisplay) { accountEmailDisplay.value = currentUser.email; } }
            function injectStyles(styleContent, styleId) { removeInjectedStyles(styleId); const styleTag = document.createElement('style'); styleTag.id = styleId; styleTag.textContent = styleContent; document.head.appendChild(styleTag); console.log(`Styles injected: ${styleId}`); }
            function removeInjectedStyles(styleIdPrefix = 'injected-') { const styles = document.querySelectorAll(`style[id^="${styleIdPrefix}"]`); styles.forEach(style => { style.remove(); console.log(`Styles removed: ${style.id}`); }); }

            function loadFeatureContent(featureId) {
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';
                 const templateIdMap = { 'task-management': 'taskManagementAssets', 'file-sharing': 'fileSharingAssets', 'project-tracking': 'projectTrackingAssets', 'reports-analytics': 'reportsAnalyticsAssets', 'team-members-view': 'teamMembersAssets', 'projects': 'projectsAssets', 'employee-scheduling': 'employeeSchedulingAssets', 'data-management': 'dataManagementAssets', 'deadline-tracker': 'deadlineTrackerAssets', 'innovation-hub': 'innovationHubAssets', 'team-calendar': 'teamCalendarAssets', };
                 const templateId = templateIdMap[featureId] || 'placeholderAssets';

                 // Reset feature container and show loading
                 featureSectionsContainer.innerHTML = ''; // Clear previous content first
                 featureSectionsContainer.className = `content-section active ${featureId}-feature`; // Set classes for styling
                 featureSectionsContainer.appendChild(featurePlaceholder); // Add placeholder back
                 featurePlaceholder.style.display = 'flex'; // Show placeholder
                 featureLoadingEl.style.display = 'block'; // Show loading indicator
                 featureErrorEl.style.display = 'none';
                 featureTitleEl.textContent = ''; // Clear placeholder text
                 featureDescEl.textContent = '';

                 console.log(`Loading content for: ${featureName} (${featureId}) from template: ${templateId}`);

                 // Simulate loading delay
                 setTimeout(() => {
                     try {
                         const template = document.getElementById(templateId);
                         if (!template) throw new Error(`Template not found: ${templateId}`);

                         featureSectionsContainer.innerHTML = ''; // Clear loading placeholder

                         if (templateId === 'placeholderAssets') {
                             const placeholderContent = template.content.cloneNode(true);
                             placeholderContent.querySelector('h2').textContent = featureName;
                             placeholderContent.querySelector('p').textContent = `Content for ${featureName} will be loaded here.`;
                             featureSectionsContainer.appendChild(placeholderContent);
                             currentFeatureCleanup = () => { console.log(`Cleaning up placeholder for ${featureName}`); };
                             return;
                         }

                         const styleContent = template.content.querySelector('style');
                         if (styleContent) { injectStyles(styleContent.textContent, `injected-${featureId}-styles`); }
                         else { console.warn(`No styles found in template for ${featureId}`); }

                         const htmlContent = template.content.cloneNode(true);
                         htmlContent.querySelectorAll('style, script').forEach(el => el.remove()); // Remove style/script from template content itself
                         featureSectionsContainer.appendChild(htmlContent); // Append the actual feature HTML

                         // --- Feature Initialization ---
                         const initFunctionNameMap = { 'task-management': 'initializeTaskManagementFeature', 'file-sharing': 'initializeFileSharingFeature', 'project-tracking': 'initializeProjectTrackingFeature', 'reports-analytics': 'initializeReportsAnalyticsFeature', 'team-members-view': 'initializeTeamMembersFeature', 'projects': 'initializeProjectsFeature', 'employee-scheduling': 'initializeEmployeeScheduleLogic', 'data-management': 'initializeDataManagementFeature', 'deadline-tracker': 'initializeDeadlineTrackerFeature', 'innovation-hub': 'initializeInnovationHubFeature', 'team-calendar': 'initializeTeamCalendarFeature', };
                         const initFunctionName = initFunctionNameMap[featureId];

                         if (initFunctionName && typeof window[initFunctionName] === 'function') {
                             try {
                                const instance = window[initFunctionName](featureSectionsContainer); // Pass the container
                                window[`${featureId}Instance`] = instance; // Store instance globally
                                currentFeatureCleanup = instance?.cleanup; // Store cleanup function
                                console.log(`${featureName} JS initialized successfully.`);
                             } catch(initError) {
                                 console.error(`Error initializing JS for ${featureId} (${initFunctionName}):`, initError);
                                 throw new Error(`JS initialization failed for ${featureName}.`); // Re-throw to be caught below
                             }
                         } else {
                             console.warn(`No specific JS init function mapped or found for ${featureId}.`);
                             // No cleanup function if no init function was called
                             currentFeatureCleanup = () => { console.log(`No specific cleanup for ${featureId}`); };
                         }

                     } catch (error) {
                         console.error(`Error loading feature ${featureId}:`, error);
                         featureSectionsContainer.innerHTML = ''; // Clear partially loaded content
                         featureSectionsContainer.appendChild(featurePlaceholder); // Put placeholder back
                         featurePlaceholder.style.display = 'flex';
                         featureLoadingEl.style.display = 'none';
                         featureErrorEl.textContent = `Failed to load ${featureName}. Error: ${error.message}`;
                         featureErrorEl.style.display = 'block';
                     }
                 }, 150); // Reduced delay
            }

            function updateBrowserHistory(featureId, settingsTab = null) { let hash = `#${featureId}`; if (featureId === 'settings' && settingsTab) { hash += `-${settingsTab}`; } const currentHash = window.location.hash; if (currentHash !== hash) { window.history.pushState({ feature: featureId, tab: settingsTab }, '', hash); } else { window.history.replaceState({ feature: featureId, tab: settingsTab }, '', hash); } } // Use replaceState if hash is the same
            function handleInitialNavigation() { const hash = window.location.hash.substring(1); console.log(`Handling navigation for hash: ${hash}`); let featureId = 'dashboard'; let settingsTab = null; if (hash) { if (hash.startsWith('settings-')) { const parts = hash.split('-'); featureId = parts[0]; settingsTab = parts[1]; } else { const knownFeature = Array.from(menuItems).some(item => item.getAttribute('data-feature') === hash); if (knownFeature) { featureId = hash; } } } setActiveFeature(featureId, settingsTab, true); } // Pass skipHistory = true

            // --- Data Loading & Simulation ---
            function loadInitialData() { loadDashboardStats(); loadRecentActivities(); loadNotifications(); loadMockProjects(); if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') { loadTeamMembers(); } }
             function loadMockProjects() { MOCK_PROJECTS_DATA = [ { id: "alpha001", name: "Project Alpha", status: "in-progress", participants: "Esraa Lashin|Yousef Ahmed", description: "Core development phase.", img: "https://images.unsplash.com/photo-1517048676732-d65bc937f952?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 65, startDate: "2024-03-15", dueDate: "2024-08-30", updatedDate: "2024-05-10", editable: true }, { id: "web002", name: "Website Redesign", status: "completed", participants: "Mohamed Elmenisy|Bassant Badr", description: "Launched successfully.", img: "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 100, startDate: "2024-01-01", dueDate: "2024-04-15", updatedDate: "2024-04-20", editable: false }, { id: "mobile003", name: "Mobile App V2", status: "active", participants: "Yousef Ahmed|Esraa Lashin", description: "User testing phase.", img: "https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 20, startDate: "2024-04-20", dueDate: "2024-10-01", updatedDate: "2024-05-05", editable: true }, { id: "mktg004", name: "Q3 Marketing Plan", status: "pending", participants: "Bassant Badr|Nada Mahmoud", description: "Initial planning.", img: "https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 0, startDate: "2024-06-01", dueDate: "2024-07-15", updatedDate: "2024-05-12", editable: true }, { id: "infra005", name: "Server Migration", status: "in-progress", participants: "Yousef Ahmed|Mohamed Elmenisy", description: "Data transfer ongoing.", img: "https://images.unsplash.com/photo-1580894742597-87bc8789db3d?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 85, startDate: "2024-05-10", dueDate: "2024-06-20", updatedDate: "2024-05-15", editable: true } ]; console.log("Mock projects loaded into MOCK_PROJECTS_DATA"); }
            function loadDashboardStats() { console.log("Loading dashboard stats..."); setTimeout(() => { const teamMembersCount = window.MOCK_USERS.length; const tasksCompleted = MOCK_TASKS.filter(t => t.status === 'Completed').length + Math.floor(Math.random() * 5); const activeProjects = MOCK_PROJECTS_DATA.filter(p => p.status === 'active' || p.status === 'in-progress').length; const upcomingDeadlines = MOCK_PROJECTS_DATA.filter(p => p.dueDate && new Date(p.dueDate) > new Date() && new Date(p.dueDate) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)).length; updateStatCard('teamMembersCount', 'Team Members', 'fas fa-users', teamMembersCount, Math.random() * 10 - 5); updateStatCard('tasksCompleted', 'Tasks Completed', 'fas fa-check-circle', tasksCompleted, Math.random() * 20); updateStatCard('activeProjects', 'Active Projects', 'fas fa-project-diagram', activeProjects, Math.random() * 5 - 2); updateStatCard('upcomingDeadlines', 'Upcoming Deadlines', 'fas fa-calendar-times', upcomingDeadlines, Math.random() * 15 - 10); }, 300); }
            function updateStatCard(id, title, iconClass, value, trendPercent) { const cardIndex = ['teamMembersCount', 'tasksCompleted', 'activeProjects', 'upcomingDeadlines'].indexOf(id); if (cardIndex === -1 || !statsSection || !statsSection.children[cardIndex]) return; const card = statsSection.children[cardIndex]; let trendClass = 'trend-neutral'; let trendIcon = 'fas fa-minus'; if (trendPercent > 1) { trendClass = 'trend-up'; trendIcon = 'fas fa-arrow-up'; } else if (trendPercent < -1) { trendClass = 'trend-down'; trendIcon = 'fas fa-arrow-down'; } card.innerHTML = ` <div class="stat-title"><i class="${iconClass}"></i>${title}</div> <div class="stat-value"> <span>${value}</span> <span class="stat-trend ${trendClass}"> <i class="${trendIcon}"></i> ${trendPercent !== 0 ? Math.abs(trendPercent).toFixed(0) + '%' : ''} </span> </div>`; }
            function loadRecentActivities(showAll = false) { console.log("Loading recent activities..."); if (activities.length === 0 || !showingAllActivities) { const now = Date.now(); activities = generateMockActivities(15, now); } showingAllActivities = showAll; const activitiesToDisplay = showAll ? activities : activities.slice(0, maxActivitiesToShow); activityList.innerHTML = ''; if (activitiesToDisplay.length === 0) { activityList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>'; deleteAllActivity.style.display = 'none'; viewAllActivity.style.display = 'none'; return; } activitiesToDisplay.sort((a, b) => b.timestamp - a.timestamp); activitiesToDisplay.forEach((activity, index) => { const li = document.createElement('li'); li.classList.add('activity-item'); li.dataset.id = activity.id; if (activity.isNew) { li.classList.add('new-activity'); setTimeout(() => { activity.isNew = false; const currentLi = activityList.querySelector(`[data-id='${activity.id}']`); if (currentLi) currentLi.classList.remove('new-activity'); }, 2500); } li.innerHTML = ` <div class="activity-icon"><i class="fas ${activity.icon}"></i></div> <div class="activity-content"> <div class="activity-message">${activity.message}</div> <div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div> </div> <div class="activity-actions"> <i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i> </div>`; activityList.appendChild(li); }); deleteAllActivity.style.display = activities.length > 0 ? 'inline-block' : 'none'; viewAllActivity.textContent = showAll ? 'Show Less' : 'Show All'; viewAllActivity.style.display = activities.length > maxActivitiesToShow ? 'inline-block' : 'none'; }
            function loadNotifications() { console.log("Loading notifications..."); if (notifications.length === 0) { const now = Date.now(); notifications = generateMockNotifications(8, now); } renderNotifications(); }
            function renderNotifications() { notificationsBody.innerHTML = ''; const unreadCount = notifications.filter(n => n.unread).length; if (notifications.length === 0) { noNotificationsMessage.textContent = 'You have no notifications.'; noNotificationsMessage.style.display = 'block'; notificationBadge.style.display = 'none'; notificationBadge.textContent = '0'; markAllReadBtn.disabled = true; deleteAllNotificationsBtn.disabled = true; return; } noNotificationsMessage.style.display = 'none'; markAllReadBtn.disabled = unreadCount === 0; deleteAllNotificationsBtn.disabled = false; notifications.sort((a, b) => b.timestamp - a.timestamp); notifications.forEach(notification => { const div = document.createElement('div'); div.classList.add('notification-list-item'); div.dataset.id = notification.id; if (notification.unread) { div.classList.add('unread'); } div.innerHTML = ` <div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div> <div class="notification-content"> <div class="notification-message">${notification.message}</div> <div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div> </div> <i class="fas fa-times delete-notification" title="Delete Notification"></i>`; notificationsBody.appendChild(div); }); notificationBadge.textContent = unreadCount; notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none'; }
             function loadTeamMembers(container = settingsContent) { // Default to settings container
                 const teamListContainer = container.id === 'settingsContent' ? container.querySelector('#teamList') : container.querySelector('#teamMemberListContainer');
                 if (!teamListContainer) { console.error("Team list container not found in", container); return; }
                 console.log("Loading team members into:", teamListContainer.id);
                 teamListContainer.innerHTML = '<p style="color: var(--gray);">Loading...</p>';
                 setTimeout(() => {
                     teamListContainer.innerHTML = '';
                     if (window.MOCK_USERS.length === 0) { teamListContainer.innerHTML = '<p style="color: var(--gray);">No team members found.</p>'; return; }
                     window.MOCK_USERS.sort((a, b) => a.name.localeCompare(b.name));
                     window.MOCK_USERS.forEach(member => {
                         const card = document.createElement('div'); card.classList.add('team-member-card'); card.dataset.id = member.id; card.dataset.name = member.name; card.dataset.role = member.role; card.dataset.email = member.email;
                         const avatarStyle = member.avatar ? `background-image: url('${member.avatar}')` : ''; const avatarContent = member.avatar ? '' : member.initials;
                         const roleClass = `role-${member.role}`; const roleText = formatRole(member.role);
                         if (container.id === 'settingsContent') { // Settings view (list)
                             card.innerHTML = `
                                <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                                <div class="member-details"> <div class="member-name">${member.name}</div> <div class="member-email">${member.email}</div> </div>
                                <span class="member-role ${roleClass}">${roleText}</span>
                                ${currentUser.role === 'admin' && currentUser.id !== member.id ? `<div class="member-actions"> <button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button> <button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button> </div>` : '<div class="member-actions" style="width: 70px;">&nbsp;</div>'}`;
                         } else { // Feature view (grid)
                             card.innerHTML = `<div class="member-avatar" style="${avatarStyle}">${avatarContent}</div><div class="member-info"><h4 class="member-name">${member.name}</h4><p class="member-email">${member.email}</p><span class="member-role ${roleClass}">${roleText}</span></div>`;
                         } teamListContainer.appendChild(card);
                     });
                 }, 300);
             }

            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() { if (activityIntervalId) clearInterval(activityIntervalId); activityIntervalId = setInterval(() => { const newActivity = generateMockActivities(1, Date.now())[0]; newActivity.isNew = true; activities.unshift(newActivity); if (activities.length > 50) activities.pop(); activities.sort((a, b) => b.timestamp - a.timestamp); if (currentFeature === 'dashboard') { loadRecentActivities(showingAllActivities); } window.showToast(`New Activity: ${newActivity.message.substring(0, 30)}...`); }, Math.random() * 10000 + 15000); if (notificationIntervalId) clearInterval(notificationIntervalId); notificationIntervalId = setInterval(() => { const newNotification = generateMockNotifications(1, Date.now())[0]; newNotification.unread = true; notifications.unshift(newNotification); if (notifications.length > 30) notifications.pop(); renderNotifications(); playNotificationSound(); }, Math.random() * 20000 + 25000); if (statsIntervalId) clearInterval(statsIntervalId); statsIntervalId = setInterval(loadDashboardStats, 30000); if (welcomeBgIntervalId) clearInterval(welcomeBgIntervalId); welcomeBgIntervalId = setInterval(changeWelcomeBackground, 15000); }
            function changeWelcomeBackground() { const backgrounds = ['--welcome-bg-1', '--welcome-bg-2', '--welcome-bg-3']; const currentBgVar = getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim(); let currentIndex = backgrounds.indexOf(currentBgVar); if (currentIndex === -1) currentIndex = 0; const nextIndex = (currentIndex + 1) % backgrounds.length; document.documentElement.style.setProperty('--welcome-bg-current', `var(${backgrounds[nextIndex]})`); }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                 if (sidebarToggle) { sidebarToggle.addEventListener('click', () => { sidebar.classList.add('active'); mainContent.classList.add('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'block'; }); }
                 if (closeSidebar) { closeSidebar.addEventListener('click', () => { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); closeSidebar.style.display = 'none'; }); }
                 document.addEventListener('click', (event) => { if (window.innerWidth <= 992 && sidebar.classList.contains('active')) { const isClickInsideSidebar = sidebar.contains(event.target); const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target); if (!isClickInsideSidebar && !isClickOnToggler) { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } } });
                menuItems.forEach(item => item.addEventListener('click', function(e) { e.preventDefault(); const featureId = this.getAttribute('data-feature'); setActiveFeature(featureId); }));
                document.body.addEventListener('click', function(e) { const target = e.target; const settingsTab = target.closest('.settings-tab'); const settingsLink = target.closest('.settings-link'); if (settingsTab && !settingsTab.classList.contains('active')) { const tabId = settingsTab.getAttribute('data-tab'); activateSettingsTab(tabId); updateBrowserHistory('settings', tabId); } else if (settingsLink && settingsLink.dataset.tabTarget) { e.preventDefault(); const tabId = settingsLink.dataset.tabTarget; setActiveFeature('settings', tabId); } });
                backButton.addEventListener('click', function() { setActiveFeature('dashboard'); });
                userProfileContainer.addEventListener('click', function(e) { const dropdownItem = e.target.closest('.dropdown-item'); if (dropdownItem) { const feature = dropdownItem.getAttribute('data-feature'); if (feature) { setActiveFeature(feature); } userDropdown.classList.remove('active'); userDropdownOpen = false; return; } userDropdownOpen = !userDropdownOpen; userDropdown.classList.toggle('active', userDropdownOpen); });
                 document.addEventListener('click', function(event) { if (!userProfileContainer.contains(event.target) && userDropdownOpen) { userDropdown.classList.remove('active'); userDropdownOpen = false; } });
                searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch);
                 document.addEventListener('click', (event) => { if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) { searchResultsContainer.classList.remove('active'); } });
                 searchResultsContainer.addEventListener('click', (event) => { const targetItem = event.target.closest('.search-result-item'); if (targetItem && targetItem.dataset.feature) { const featureId = targetItem.dataset.feature; const itemId = targetItem.dataset.id; console.log(`Search result: Feature=${featureId}, ID=${itemId}`); setActiveFeature(featureId); searchResultsContainer.classList.remove('active'); searchInput.value = ''; } });
                notificationIcon.addEventListener('click', () => { notificationsModal.classList.add('active'); document.body.style.overflow = 'hidden'; });
                closeNotifications.addEventListener('click', () => { notificationsModal.classList.remove('active'); document.body.style.overflow = ''; });
                 notificationsModal.addEventListener('click', (event) => { if (event.target === notificationsModal) { notificationsModal.classList.remove('active'); document.body.style.overflow = ''; } });
                 notificationsBody.addEventListener('click', (event) => { const target = event.target; const notificationItem = target.closest('.notification-list-item'); const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null; if (target.classList.contains('delete-notification') && notificationId) { window.showConfirmModal('Delete Notification', 'Are you sure?', () => { notifications = notifications.filter(n => n.id !== notificationId); renderNotifications(); window.showToast('Notification deleted.', 'success'); }); } else if (notificationItem && notificationId) { const notification = notifications.find(n => n.id === notificationId); if (notification && notification.unread) { notification.unread = false; renderNotifications(); } console.log(`Clicked notification ${notificationId}`); } });
                 markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
                 deleteAllNotificationsBtn.addEventListener('click', () => { if (notifications.length === 0) return; window.showConfirmModal('Delete All Notifications', 'Are you sure?', () => { notifications = []; renderNotifications(); window.showToast('All notifications deleted.', 'success'); }); });
                 activityList.addEventListener('click', (event) => { const target = event.target; if (target.classList.contains('delete-activity')) { const activityItem = target.closest('.activity-item'); const activityId = activityItem ? parseInt(activityItem.dataset.id) : null; if (activityId) { activities = activities.filter(a => a.id !== activityId); loadRecentActivities(showingAllActivities); window.showToast('Activity deleted.'); } } });
                viewAllActivity.addEventListener('click', () => { loadRecentActivities(!showingAllActivities); });
                deleteAllActivity.addEventListener('click', () => { if (activities.length === 0) return; window.showConfirmModal('Delete All Activities', 'Are you sure?', () => { activities = []; loadRecentActivities(false); window.showToast('All activities deleted.'); }); });
                profileAvatarLarge.addEventListener('click', () => { profileAvatarInput.click(); });
                 profileAvatarInput.addEventListener('change', handleAvatarUpload);
                 profileForm.addEventListener('submit', handleProfileSave);
                 cancelProfileBtn.addEventListener('click', handleProfileCancel);
                 firstNameInput.addEventListener('input', updateFullNameDisplay);
                 lastNameInput.addEventListener('input', updateFullNameDisplay);
                 logoutLink.addEventListener('click', handleLogout);
                 const teamListContainer = document.getElementById('teamList'); if (teamListContainer) { teamListContainer.addEventListener('click', (event) => { const target = event.target; const memberCard = target.closest('.team-member-card'); const memberId = memberCard ? parseInt(memberCard.dataset.id) : null; if (!memberId || memberId === currentUser.id) return; if (target.closest('.edit-member')) { openMemberModal(memberId); } else if (target.closest('.remove-member')) { handleRemoveMember(memberId); } }); }
                 if (memberForm) { memberForm.addEventListener('submit', handleSaveMember); }
                 if(memberModal) { memberModal.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => { memberModal.classList.remove('active'); document.body.style.overflow = ''; }); }); memberModal.addEventListener('click', (event) => { if (event.target === memberModal) { memberModal.classList.remove('active'); document.body.style.overflow = ''; } }); }
                 const inviteMemberForm = document.getElementById('inviteMemberForm'); if (inviteMemberForm) { inviteMemberForm.addEventListener('submit', handleInviteMember); }
                 const deleteAllNonAdminUsersBtn = document.getElementById('deleteAllNonAdminUsersBtn'); if (deleteAllNonAdminUsersBtn) { deleteAllNonAdminUsersBtn.addEventListener('click', handleDeleteAllNonAdminUsers); }
                 if (projectForm) { projectForm.addEventListener('submit', handleSaveProject); }
                 if (projectModal) { projectModal.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => { projectModal.classList.remove('active'); document.body.style.overflow = ''; }); }); projectModal.addEventListener('click', (event) => { if (event.target === projectModal) { projectModal.classList.remove('active'); document.body.style.overflow = ''; } }); }
                 themeOptions.forEach(option => { option.addEventListener('click', () => setTheme(option.dataset.theme)); });
                 if (highContrastToggle) { highContrastToggle.addEventListener('change', (e) => setContrast(e.target.checked)); }
                 if (languageSelect) { languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value)); }
                 if (regionSelect) { regionSelect.addEventListener('change', (e) => localStorage.setItem('region', e.target.value)); }
                 if (timeFormatSelect || dateFormatSelect) { const applyDateTimeListener = () => { applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value); }; if (timeFormatSelect) timeFormatSelect.addEventListener('change', applyDateTimeListener); if (dateFormatSelect) dateFormatSelect.addEventListener('change', applyDateTimeListener); }
                 if (toastToggle) { toastToggle.addEventListener('change', (e) => applyToastPreference(e.target.checked)); }
                 if (soundToggle) { soundToggle.addEventListener('change', (e) => applySoundPreference(e.target.checked)); }
                if(savePreferencesBtn) savePreferencesBtn.addEventListener('click', handleSavePreferences);
                if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
                if(saveAccountSettingsBtn) saveAccountSettingsBtn.addEventListener('click', handleSaveAccountSettings);
                if(saveSessionSettingsBtn) saveSessionSettingsBtn.addEventListener('click', handleSaveSessionSettings);
                if(saveNotificationSettingsBtn) saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);
                 if (enable2faBtn) enable2faBtn.addEventListener('click', handleEnable2FA);
                 if (setupAuthAppBtn) setupAuthAppBtn.addEventListener('click', showAuthAppSetup);
                 if (setupSmsBtn) setupSmsBtn.addEventListener('click', showSmsSetup);
                 if (verifyAuthCodeBtn) verifyAuthCodeBtn.addEventListener('click', handleVerifyAuthCode);
                 if (sendSmsCodeBtn) sendSmsCodeBtn.addEventListener('click', handleSendSmsCode);
                 if (verifySmsCodeBtn) verifySmsCodeBtn.addEventListener('click', handleVerifySmsCode);
                 if (disable2faBtn) disable2faBtn.addEventListener('click', handleDisable2FA);
                 if(logoutAllDevicesBtn) logoutAllDevicesBtn.addEventListener('click', handleLogoutAllDevices);
                 if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);
                cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                confirmBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmModal(); });
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (confirmModal.classList.contains('active')) { hideConfirmModal(); } if (memberModal.classList.contains('active')) { memberModal.classList.remove('active'); document.body.style.overflow = ''; } if (projectModal.classList.contains('active')) { projectModal.classList.remove('active'); document.body.style.overflow = ''; } const anyActiveModal = document.querySelector('.modal.active'); if(anyActiveModal) { anyActiveModal.classList.remove('active'); document.body.style.overflow = ''; } if (notificationsModal.classList.contains('active')) { notificationsModal.classList.remove('active'); document.body.style.overflow = ''; } } });
                window.addEventListener('popstate', function(event) { console.log("Popstate event:", event.state, window.location.hash); handleInitialNavigation(); });
            }

            // --- Profile Logic ---
            function handleAvatarUpload(event) { const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { const imageUrl = e.target.result; profileAvatarLarge.style.backgroundImage = `url(${imageUrl})`; profileAvatarLarge.textContent = ''; document.getElementById('userAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('userAvatar').textContent = ''; document.getElementById('profileAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('profileAvatar').textContent = ''; currentUser.avatar = imageUrl; window.showToast('Avatar preview updated. Save changes to persist.'); }; reader.readAsDataURL(file); } else if (file) { window.showToast('Please select a valid image file.', 'error'); } }
            function updateFullNameDisplay() { fullNameDisplay.value = `${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim(); }
             function handleProfileSave(event) { event.preventDefault(); console.log("Saving profile..."); window.showConfirmModal( 'Save Profile Changes', 'Are you sure?', () => { console.log("Profile save confirmed."); const saveButtonText = saveProfileBtn.querySelector('.btn-text'); const spinner = saveProfileBtn.querySelector('.spinner'); saveProfileBtn.disabled = true; if (saveButtonText) saveButtonText.textContent = 'Saving...'; if (spinner) spinner.style.display = 'inline-block'; setTimeout(() => { currentUser.name = fullNameDisplay.value; currentUser.title = jobTitleInput.value; currentUser.phone = phoneInput.value; currentUser.department = departmentInput.value; if (!currentUser.avatar) { const nameParts = currentUser.name.split(' '); currentUser.initials = (nameParts[0]?.[0] || '') + (nameParts[1]?.[0] || ''); } if(userPhoneNumberForSms) userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available'; updateUserUI(); saveProfileBtn.disabled = false; if (saveButtonText) saveButtonText.textContent = 'Save Changes'; if (spinner) spinner.style.display = 'none'; window.showSuccessMessage('Profile updated successfully!'); }, 1000); }, 'btn-primary' ); }
             function handleProfileCancel() { window.showConfirmModal( 'Cancel Changes', 'Discard changes?', () => { updateProfileForm(); window.showToast('Changes discarded.'); }, 'btn-warning' ); }

             // --- Settings Save Logic ---
             function handleSavePreferences() { window.showConfirmModal('Save Preferences', 'Save Appearance/Localization?', () => { console.log("Saving Preferences..."); window.showToast('Preferences saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveAccountSettings() { window.showConfirmModal('Save Account Settings', 'Save notification settings?', () => { console.log("Saving Account Settings..."); const enableNotifications = document.getElementById('accountNotificationsToggle').checked; console.log("Account Notifications Enabled:", enableNotifications); window.showToast('Account settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleChangePassword(event) { event.preventDefault(); window.showConfirmModal('Change Password', 'Are you sure you want to attempt to change your password?', () => { console.log("Changing password..."); const currentPass = document.getElementById('currentPassword').value; const newPass = document.getElementById('newPassword').value; const confirmPass = document.getElementById('confirmPassword').value; if (!currentPass || !newPass || !confirmPass) { window.showToast('Please fill in all password fields.', 'error'); return; } if (newPass !== confirmPass) { window.showToast('New passwords do not match.', 'error'); return; } if (newPass.length < 8) { window.showToast('New password must be at least 8 characters.', 'error'); return; } window.showToast('Attempting password change...', 'info'); setTimeout(() => { const success = Math.random() > 0.2; if (success) { window.showSuccessMessage('Password changed successfully!'); document.getElementById('currentPassword').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('confirmPassword').value = ''; } else { window.showToast('Password change failed. Incorrect current password?', 'error'); } }, 1500); }, 'btn-danger'); }
             function handleSaveSessionSettings() { window.showConfirmModal('Save Session Settings', 'Save session duration and idle timeout?', () => { console.log("Saving Session Settings..."); const sessionDuration = document.getElementById('sessionDuration').value; const idleTimeout = document.getElementById('idleTimeout').value; console.log("Session Duration:", sessionDuration, "Idle Timeout:", idleTimeout); window.showToast('Session settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveNotificationSettings() { window.showConfirmModal('Save Notification Settings', 'Save notification delivery/types?', () => { console.log("Saving Notification Settings..."); const emailEnabled = document.getElementById('emailNotificationsToggle').checked; const inAppEnabled = document.getElementById('inAppNotificationsToggle').checked; const pushEnabled = document.getElementById('pushNotificationsToggle').checked; const selectedTypes = Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb => cb.value); console.log("Email:", emailEnabled, "InApp:", inAppEnabled, "Types:", selectedTypes); window.showToast('Notification settings saved (simulated).', 'success'); }, 'btn-primary'); }

             // --- 2FA Logic (Simulation) ---
             function update2FA_UI() { if (!currentUser || !twoFaStatusIndicator || !twoFaStatusText || !twoFaSetupSection || !twoFaManagementSection) return; const isEnabled = currentUser.twoFaEnabled; twoFaStatusIndicator.style.backgroundColor = isEnabled ? 'var(--success)' : 'var(--gray)'; twoFaStatusText.textContent = `2FA is currently ${isEnabled ? 'Enabled' : 'Disabled'}`; twoFaSetupSection.style.display = isEnabled ? 'none' : 'block'; twoFaManagementSection.style.display = isEnabled ? 'block' : 'none'; if (twoFaSetupOptions) twoFaSetupOptions.style.display = 'none'; if (authAppSetup) authAppSetup.style.display = 'none'; if (smsSetup) smsSetup.style.display = 'none'; }
             function handleEnable2FA() { if(twoFaSetupOptions) twoFaSetupOptions.style.display = 'block'; if(enable2faBtn) enable2faBtn.style.display = 'none'; }
             function showAuthAppSetup() { if(authAppSetup) authAppSetup.style.display = 'block'; if(smsSetup) smsSetup.style.display = 'none'; }
             function showSmsSetup() { if(authAppSetup) authAppSetup.style.display = 'none'; if(smsSetup) smsSetup.style.display = 'block'; if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none'; }
             function handleVerifyAuthCode() { const authCodeInput = document.getElementById('authCode'); if (!authCodeInput) return; const code = authCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { window.showToast('Verifying code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); window.showToast('2FA enabled via Authenticator App!', 'success'); }, 1000); } else { window.showToast('Invalid code. Please enter 6 digits.', 'error'); } }
             function handleSendSmsCode() { window.showToast('Sending SMS code...', 'info'); setTimeout(() => { window.showToast('SMS code sent (simulated).', 'success'); if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'block'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'inline-flex'; }, 1500); }
             function handleVerifySmsCode() { const smsCodeInput = document.getElementById('smsCode'); if (!smsCodeInput) return; const code = smsCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { window.showToast('Verifying SMS code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); window.showToast('2FA enabled via SMS!', 'success'); }, 1000); } else { window.showToast('Invalid SMS code. Please enter 6 digits.', 'error'); } }
             function handleDisable2FA() { window.showConfirmModal('Disable 2FA', 'Are you sure? This reduces security.', () => { currentUser.twoFaEnabled = false; update2FA_UI(); if(enable2faBtn) enable2faBtn.style.display = 'inline-flex'; window.showToast('2FA disabled.'); }, 'btn-danger'); }

             // --- Danger Zone Logic ---
             function handleLogoutAllDevices() { window.showConfirmModal('Logout From All Devices', 'End all other sessions?', () => { window.showToast('Logging out from other devices...', 'info'); setTimeout(() => { window.showSuccessMessage('Logged out from other devices.'); }, 1500); }, 'btn-warning'); }
             function handleDeleteAccount() { window.showConfirmModal('Delete Account', 'IRREVERSIBLE! Delete all data?', () => { window.showConfirmModal('Final Confirmation', 'Are you absolutely sure?', () => { console.warn("Account Deletion Confirmed (Simulated)"); window.showToast('Deleting account...', 'error'); setTimeout(() => { alert("Account Deleted (Simulated). Redirecting..."); handleLogout(new Event('click')); }, 2000); }, 'btn-danger'); }, 'btn-danger'); }

             // --- Notification Logic ---
             function markAllNotificationsAsRead() { if (notifications.some(n => n.unread)) { notifications.forEach(n => n.unread = false); renderNotifications(); window.showToast('All notifications marked as read.'); } }
             function playNotificationSound() { if (!playSounds) return; try { if (notificationSound && notificationSound.paused) { notificationSound.play().catch(e => console.warn("Audio play failed:", e)); } } catch(e) { console.warn("Audio error:", e); } }

             // --- Logout Logic ---
             function handleLogout(event) { event.preventDefault(); window.showConfirmModal( 'Confirm Logout', 'Are you sure?', () => { console.log("Logging out..."); clearInterval(activityIntervalId); clearInterval(notificationIntervalId); clearInterval(statsIntervalId); clearInterval(welcomeBgIntervalId); window.showSuccessMessage('Logout successful! Redirecting...'); setTimeout(() => { window.location.href = 'login.html'; }, 1500); }, 'btn-danger' ); }

            // --- Team Management Logic ---
             function handleInviteMember(event) { event.preventDefault(); const emailInput = document.getElementById('inviteEmail'); const roleInput = document.getElementById('inviteRole'); const email = emailInput ? emailInput.value : null; const role = roleInput ? roleInput.value : null; const inviteButton = event.target.querySelector('button[type="submit"]'); if (!email || !role || !/\S+@\S+\.\S+/.test(email)) { window.showToast('Please provide a valid email and role.', 'error'); return; } if (window.MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) { window.showToast('A user with this email already exists.', 'error'); return; } console.log(`Inviting ${email} as ${role}`); if (inviteButton) { inviteButton.disabled = true; inviteButton.innerHTML = '<span class="spinner"></span> Sending...'; } setTimeout(() => { const newId = window.MOCK_USERS.length > 0 ? Math.max(...window.MOCK_USERS.map(u => u.id)) + 1 : 1; const nameParts = email.split('@')[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)); const newUser = { id: newId, name: nameParts.join(' ') || 'New User', email: email, title: formatRole(role), department: 'Pending', phone: '', avatar: '', initials: (nameParts[0]?.[0] || 'N') + (nameParts[1]?.[0] || 'U'), role: role, twoFaEnabled: false }; window.MOCK_USERS.push(newUser); loadTeamMembers(); if(currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } loadDashboardStats(); window.showToast(`Invitation sent to ${email}.`, 'success'); if (inviteButton) { inviteButton.disabled = false; inviteButton.innerHTML = 'Invite'; } if (emailInput) emailInput.value = ''; if (roleInput) roleInput.value = 'member'; }, 1000); }
            function openMemberModal(memberId = null) { const isEditing = memberId !== null; const member = isEditing ? window.MOCK_USERS.find(u => u.id === memberId) : null; if (isEditing && !member) { window.showToast("Error: Member not found.", "error"); return; } memberForm.reset(); document.getElementById('memberId').value = isEditing ? member.id : ''; document.getElementById('memberEmail').readOnly = isEditing; if (isEditing) { const nameParts = member.name.split(' '); document.getElementById('memberFirstName').value = nameParts[0] || ''; document.getElementById('memberLastName').value = nameParts.slice(1).join(' ') || ''; document.getElementById('memberEmail').value = member.email; document.getElementById('memberRole').value = member.role; document.getElementById('memberTitle').value = member.title || ''; document.getElementById('memberDepartment').value = member.department || ''; memberModalTitle.textContent = `Edit ${member.name}`; saveMemberBtn.textContent = 'Save Changes'; } else { memberModalTitle.textContent = `Add New Member`; saveMemberBtn.textContent = 'Add Member'; document.getElementById('memberEmail').readOnly = false; } memberModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
             function handleSaveMember(event) { event.preventDefault(); const memberId = document.getElementById('memberId').value ? parseInt(document.getElementById('memberId').value) : null; const firstName = document.getElementById('memberFirstName').value.trim(); const lastName = document.getElementById('memberLastName').value.trim(); const email = document.getElementById('memberEmail').value.trim(); const role = document.getElementById('memberRole').value; const title = document.getElementById('memberTitle').value.trim(); const department = document.getElementById('memberDepartment').value.trim(); const isEditing = memberId !== null; if (!firstName || !lastName || !email || !role) { window.showToast('Please fill in First Name, Last Name, Email, and Role.', 'error'); return; } if (!/\S+@\S+\.\S+/.test(email)) { window.showToast('Please enter a valid email address.', 'error'); return; } if (!isEditing && window.MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) { window.showToast('A user with this email already exists.', 'error'); return; } const memberData = { id: isEditing ? memberId : Date.now(), name: `${firstName} ${lastName}`, email: email, role: role, title: title, department: department, phone: isEditing ? window.MOCK_USERS.find(u=>u.id === memberId)?.phone || '' : '', avatar: isEditing ? window.MOCK_USERS.find(u=>u.id === memberId)?.avatar || '' : '', initials: (firstName?.[0] || '') + (lastName?.[0] || ''), twoFaEnabled: isEditing ? window.MOCK_USERS.find(u=>u.id === memberId)?.twoFaEnabled || false : false }; if (!memberData.avatar) { memberData.initials = (firstName?.[0] || '') + (lastName?.[0] || ''); } console.log(`${isEditing ? 'Saving' : 'Adding'} member:`, memberData); window.showToast(`${isEditing ? 'Saving' : 'Adding'} member...`, 'info'); setTimeout(() => { if (isEditing) { const memberIndex = window.MOCK_USERS.findIndex(u => u.id === memberId); if (memberIndex > -1) { window.MOCK_USERS[memberIndex] = memberData; if (currentUser && currentUser.id === memberId) { currentUser = { ...memberData }; updateUserUI(); } } else { console.error("Error finding member to edit"); } } else { window.MOCK_USERS.push(memberData); } loadTeamMembers(); if(currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } loadDashboardStats(); window.showToast(`Member ${isEditing ? 'updated' : 'added'} successfully!`, 'success'); memberModal.classList.remove('active'); document.body.style.overflow = ''; }, 1000); }
            function handleRemoveMember(memberId) { const memberToRemove = window.MOCK_USERS.find(u => u.id === memberId); window.showConfirmModal('Remove Team Member', `Are you sure you want to remove ${memberToRemove?.name || 'this member'}?`, () => { window.showToast(`Removing ${memberToRemove?.name || 'member'}...`, 'info'); setTimeout(() => { window.MOCK_USERS = window.MOCK_USERS.filter(u => u.id !== memberId); loadTeamMembers(); if(currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } loadDashboardStats(); if (currentFeature === 'employee-scheduling' && typeof window.renderSchedule === 'function') { window.renderSchedule(currentScheduleWeekOffset); } window.showToast('Team member removed.', 'success'); }, 500); }, 'btn-danger'); }
            function handleDeleteAllNonAdminUsers() { const nonAdminUsers = window.MOCK_USERS.filter(u => u.role !== 'admin'); if (nonAdminUsers.length === 0) { window.showToast('No non-admin users to delete.', 'info'); return; } const userCount = nonAdminUsers.length; const userListHTML = nonAdminUsers.slice(0, 5).map(u => `<li>${u.name} (${u.email})</li>`).join('') + (userCount > 5 ? '<li>... and more</li>' : ''); window.showConfirmModal( `Delete ${userCount} Non-Admin Users`, `This will permanently delete ${userCount} user(s) who are not administrators, including:<br><ul>${userListHTML}</ul><strong>This action cannot be undone.</strong> Are you sure?`, () => { window.showConfirmModal( 'Final Confirmation', `Really delete all ${userCount} non-admin users?`, () => { window.showToast(`Deleting ${userCount} users...`, 'warning'); setTimeout(() => { window.MOCK_USERS = window.MOCK_USERS.filter(u => u.role === 'admin'); loadTeamMembers(); if (currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } loadDashboardStats(); window.showSuccessMessage(`${userCount} non-admin users deleted successfully.`); }, 1500); }, 'btn-danger' ); }, 'btn-danger' ); }

            // --- Projects Feature Logic ---
            function openProjectModal(projectId = null) { const isEditing = projectId !== null; const project = isEditing ? MOCK_PROJECTS_DATA.find(p => p.id === projectId) : null; if (isEditing && !project) { window.showToast("Error: Project not found.", "error"); return; } projectForm.reset(); document.getElementById('projectId').value = isEditing ? project.id : ''; if (isEditing) { projectModalTitle.textContent = `Edit Project: ${project.name}`; saveProjectBtn.textContent = 'Save Changes'; document.getElementById('projectName').value = project.name; document.getElementById('projectDescription').value = project.description || ''; document.getElementById('projectParticipantsInput').value = project.participants || ''; document.getElementById('projectImageInput').value = project.img || ''; document.getElementById('projectStartDate').value = project.startDate || ''; document.getElementById('projectDueDate').value = project.dueDate || ''; document.getElementById('projectStatus').value = project.status || 'pending'; document.getElementById('projectProgress').value = project.progress || 0; } else { projectModalTitle.textContent = 'Add New Project'; saveProjectBtn.textContent = 'Add Project'; document.getElementById('projectStatus').value = 'pending'; document.getElementById('projectProgress').value = 0; } projectModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
             function handleSaveProject(event) { event.preventDefault(); const projectId = document.getElementById('projectId').value; const isEditing = projectId !== ''; const projectData = { id: isEditing ? projectId : `proj-${Date.now()}`, name: document.getElementById('projectName').value.trim(), description: document.getElementById('projectDescription').value.trim(), participants: document.getElementById('projectParticipantsInput').value.trim(), img: document.getElementById('projectImageInput').value.trim(), startDate: document.getElementById('projectStartDate').value || null, dueDate: document.getElementById('projectDueDate').value || null, status: document.getElementById('projectStatus').value, progress: parseInt(document.getElementById('projectProgress').value) || 0, updatedDate: getCurrentDate(), // Use helper
                 editable: true }; if (!projectData.name) { window.showToast('Project Name is required.', 'error'); return; } console.log(`${isEditing ? 'Saving' : 'Adding'} project:`, projectData); window.showToast(`${isEditing ? 'Saving' : 'Adding'} project...`, 'info'); setTimeout(() => { if (isEditing) { const index = MOCK_PROJECTS_DATA.findIndex(p => p.id === projectId); if (index > -1) { MOCK_PROJECTS_DATA[index] = { ...MOCK_PROJECTS_DATA[index], ...projectData }; } else { console.error("Error finding project to edit"); MOCK_PROJECTS_DATA.push(projectData); } } else { MOCK_PROJECTS_DATA.push(projectData); } if (typeof window.projectsInstance?.renderProjects === 'function') { window.projectsInstance.renderProjects(featureSectionsContainer); } loadDashboardStats(); window.showToast(`Project ${isEditing ? 'updated' : 'added'} successfully!`, 'success'); projectModal.classList.remove('active'); document.body.style.overflow = ''; }, 500); }
             function handleDeleteProject(projectId) { const projectToDelete = MOCK_PROJECTS_DATA.find(p => p.id === projectId); if (!projectToDelete) return; window.showConfirmModal( 'Confirm Project Deletion', `Are you sure you want to delete project: "${projectToDelete.name}"? This action cannot be undone.`, () => { window.showToast(`Deleting project ${projectToDelete.name}...`, 'info'); setTimeout(() => { MOCK_PROJECTS_DATA = MOCK_PROJECTS_DATA.filter(p => p.id !== projectId); if (typeof window.projectsInstance?.renderProjects === 'function') { window.projectsInstance.renderProjects(featureSectionsContainer); } loadDashboardStats(); window.showToast('Project deleted successfully!', 'success'); }, 500); }, 'btn-danger' ); }
             // Renamed renderProjects to avoid conflict, definition moved to template
             function initializeProjectsFeature(container) { console.log("Initializing Projects Feature..."); const searchInput = container.querySelector('#projectSearchInputFeature'); const filterSelect = container.querySelector('#projectFilterSelectFeature'); const projectsListContainer = container.querySelector('#projectsListContainerFeature'); const addProjectBtn = container.querySelector('#addProjectBtnFeature'); let listeners = []; const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); }; const escapeHTML = (str) => { if (!str) return ''; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }; const formatDate = (dateString) => window.formatDateForDisplay(dateString); const getCurrentDate = () => new Date().toLocaleDateString('en-CA'); const renderProjects = (currentContainer) => { if (!projectsListContainer) return; const currentSearchTerm = searchInput ? searchInput.value.toLowerCase().trim() : ''; const currentSelectedStatus = filterSelect ? filterSelect.value : 'all'; projectsListContainer.innerHTML = ''; let projectsToDisplay = MOCK_PROJECTS_DATA.filter(project => { const statusMatch = (currentSelectedStatus === 'all' || project.status === currentSelectedStatus); const searchMatch = ( project.name.toLowerCase().includes(currentSearchTerm) || (project.participants || '').toLowerCase().includes(currentSearchTerm) || project.status.toLowerCase().includes(currentSearchTerm) ); return statusMatch && searchMatch; }); if (projectsToDisplay.length === 0) { projectsListContainer.innerHTML = '<p style="color: var(--feature-projects-text-muted); grid-column: 1 / -1; text-align: center; padding: 2rem;">No projects found matching your criteria.</p>'; return; } projectsToDisplay.forEach(project => { const card = document.createElement('div'); card.classList.add('project-card'); card.dataset.projectId = project.id; card.dataset.status = project.status; card.dataset.participants = project.participants; const participantsHTML = (project.participants || '').split('|').map(p => p.trim()).filter(p => p).map(p => `<span>${escapeHTML(p)}</span>`).join(' '); const canEdit = project.editable !== false; const canDelete = window.currentUser?.role === 'admin'; card.innerHTML = ` <div class="project-card-image" style="background-image: url('${escapeHTML(project.img || 'https://via.placeholder.com/400x180/cccccc/969696?text=No+Image')}');"></div> <div class="project-card-body"> <h3 class="project-name">${escapeHTML(project.name)}</h3> <span class="project-status status-${project.status}">${project.status.replace('-', ' ')}</span> <div class="progress-bar-container" title="Progress: ${project.progress}%"> <div class="progress-bar" style="width: ${project.progress}%;">${project.progress > 5 ? project.progress + '%' : ''}</div> </div> <div class="project-info project-participants"> <i class="fas fa-users"></i> <div class="participant-list">${participantsHTML || 'N/A'}</div> </div> <div class="project-info project-dates"> <i class="fas fa-calendar-alt"></i> Started: ${formatDate(project.startDate)} | Updated: ${formatDate(project.updatedDate)} </div> <div class="project-actions"> <button class="btn btn-outline-secondary btn-sm btn-view" data-project-id="${project.id}"><i class="fas fa-eye"></i> View</button> <button class="btn btn-outline-primary btn-sm btn-edit" data-project-id="${project.id}" ${!canEdit ? 'disabled' : ''}><i class="fas fa-pencil-alt"></i> Edit</button> <button class="btn btn-outline-danger btn-sm btn-delete" data-project-id="${project.id}" ${!canDelete ? 'disabled' : ''}><i class="fas fa-trash-alt"></i> Delete</button> </div> </div> `; projectsListContainer.appendChild(card); }); }; const filterHandler = () => renderProjects(container); const actionHandler = (event) => { const target = event.target.closest('.btn'); if (!target) return; const projectId = target.dataset.projectId; if (!projectId) return; if (target.classList.contains('btn-view')) { window.showToast(`Placeholder: View details for Project ID ${projectId}`, 'info'); } else if (target.classList.contains('btn-edit')) { openProjectModal(projectId); } else if (target.classList.contains('btn-delete')) { handleDeleteProject(projectId); } }; const addHandler = () => { openProjectModal(); }; renderProjects(container); addListener(searchInput, 'input', filterHandler); addListener(filterSelect, 'change', filterHandler); addListener(projectsListContainer, 'click', actionHandler); addListener(addProjectBtn, 'click', addHandler); const cleanup = () => { console.log("Cleaning up Projects feature listeners..."); listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); }); listeners = []; delete window.projectsInstance; }; window.projectsInstance = { renderProjects }; return { cleanup }; }

            // --- Employee Scheduling (Definition moved to template) ---

            // --- Responsive Sidebar ---
            function setupResponsiveSidebar() { if (window.innerWidth <= 992) { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } else { sidebar.classList.add('active'); mainContent.classList.add('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } } // Ensure sidebar starts correctly based on width

            // --- Start Application ---
            initDashboard();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

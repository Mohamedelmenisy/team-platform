<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <!-- =========================================== -->
    <!-- == Main Dashboard Styles ================== -->
    <!-- =========================================== -->
    <style>
        /* --- ALL **ORIGINAL** DASHBOARD CSS GOES HERE --- */
        /* --- DO NOT INCLUDE EMPLOYEE SCHEDULE CSS HERE --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a; --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2); --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444; --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        /* Sidebar Styles */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer; }
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        /* Top Navigation */
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        /* ... (Rest of MAIN dashboard CSS - Search, User Menu, Content Area Base, Welcome, Stats, Activity, Profile, Settings, Modals, Responsive, etc.) ... */
        /* Content Sections Base Styling */
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; margin-top: 1.5rem; }
        .content-section.active { display: block; }
        body.compact .content-section { padding: 1rem; margin-top: 1rem;} body.spacious .content-section { padding: 3rem; margin-top: 2rem; }
         /* Placeholder Styling */
         .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: transparent; box-shadow: none; }
         .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; } .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; } .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; }
        /* Dynamic container hidden by default */
        #featureSectionsContainer { display: none; }

        /* Add any other ORIGINAL dashboard styles here */

    </style>

</head>
<body class="blue-theme">
    <!-- Audio, Success Message -->
    <audio id="notificationSound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg"></audio>
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i><span id="successMessageText">Action successful!</span></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
         <!-- Sidebar Content (Ensure href="#" and data-feature) -->
         <div class="sidebar-header"><div class="logo"><i class="fas fa-users-cog logo-icon"></i><span>TeamFlow</span></div></div>
         <div class="sidebar-menu">
             <div class="menu-title">Navigation</div>
             <a href="#" class="menu-item active" data-feature="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
             <a href="#" class="menu-item" data-feature="projects"><i class="fas fa-briefcase"></i><span>Projects</span></a>
             <a href="#" class="menu-item" data-feature="reports-analytics"><i class="fas fa-chart-line"></i><span>Reports & Analytics</span></a>
             <a href="#" class="menu-item" data-feature="team-members-view"><i class="fas fa-users"></i><span>Team Members</span></a>
             <div class="menu-title">Core Features</div>
             <a href="#" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <div class="menu-title">Team Tools</div>
             <a href="#" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#" class="menu-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
             <a href="#" class="menu-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile (from Sidebar)</span></a>
         </div>
         <div class="connection-status"><div class="status-dot"></div><span>Online</span></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav"> <!-- ... Top Nav Content ... --> </nav>

        <!-- Content Area -->
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- STATIC SECTIONS -->
            <div id="dashboardContent" class="content-section active">
                 <h2>Dashboard Section</h2>
                 <p>This is the main dashboard area.</p>
                 <!-- Welcome, Stats, Activity should be here -->
            </div>
            <div class="content-section" id="profileContent">
                <h2>Profile Section</h2>
                <p>Profile form goes here.</p>
            </div>
            <div class="content-section" id="settingsContent">
                 <h2>Settings Section</h2>
                 <p>Settings panels go here.</p>
            </div>

            <!-- CONTAINER FOR DYNAMIC FEATURES -->
            <div id="featureSectionsContainer" style="display: none;">
                <div id="featureSections">
                    <!-- Placeholder shown during loading/error -->
                     <div class="placeholder-content content-section" id="featurePlaceholder">
                        <h2 id="featureTitle">Feature Area</h2>
                        <p id="featureDescription">Loading content...</p>
                        <div class="loading-indicator" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div class="error-message" style="display: none;">Failed to load content.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="notifications-modal" id="notificationsModal"> <!-- ... --> </div>
    <div class="confirm-modal" id="confirmModal"> <!-- ... --> </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const staticContentSections = document.querySelectorAll('.main-content > .content-area > .content-section'); // Static sections
            const featureSectionsContainer = document.getElementById('featureSectionsContainer'); // Dynamic container
            const featureSections = document.getElementById('featureSections'); // Dynamic injection target
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorMessage = featurePlaceholder.querySelector('.error-message');
            const backButton = document.getElementById('backButton');
            const profileLink = document.getElementById('profileLink');
            const settingsLink = document.getElementById('settingsLink');
            // ... other elements

            // --- State ---
            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
            let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences';
            const DEFAULT_USER = { /* ... */ }; // Define default user

            // --- Initialization ---
            function initDashboard() {
                console.log("Initializing Dashboard...");
                loadData();
                // Basic UI updates needed on load
                // updateUserUI(); // Might call too early if elements aren't ready or needed yet
                applyUserPreferences(); // Set theme/layout
                applyRBAC(); // Apply initial role restrictions
                setupEventListeners(); // Setup interactions
                handleInitialNavigation(); // Show default view (usually dashboard)
                console.log("Dashboard Initialized.");
            }

             // --- Data Handling ---
            function loadData() { console.log("Loading data..."); /* ... code to load from localStorage ... */ }
            function saveData() { /* ... */ }
            function clearUserData() { /* ... */ }

             // --- UI Updates ---
            function updateUserUI() { console.log("Updating User UI..."); /* ... */ }
            function applyUserPreferences() { console.log("Applying Prefs..."); /* ... */ }
            function applyRBAC() { console.log("Applying RBAC..."); /* ... */ }
            function loadSettingsFormData() { /* ... */ }
            function updateStats() { console.log("Updating Stats..."); /* ... */ }
            function updateTrendIndicator(element, trend) { /* ... */ }
            function updateNotificationBadge() { /* ... */ }
            function loadActivities(showAll = false) { console.log("Loading Activities..."); /* ... */ }
            function loadNotifications() { console.log("Loading Notifications..."); /* ... */ }
            function loadTeamMembers() { console.log("Loading Team Members (Settings)..."); /* ... */ }
            function getTimeAgo(timestamp) { /* ... */ }
            function updateActivityTimes() { /* ... */ }
            function startActivityTimeUpdater() { /* ... */ }
            function showConfirmModal(config) { /* ... */ }
            function hideConfirmModal() { /* ... */ }
            function showSuccessMessage(message) { /* ... */ }
            function playNotificationSound() { /* ... */ }
            function addActivity(icon, message) { /* ... */ }
            function addNotification(icon, message) { /* ... */ }

            // --- Navigation Logic ---
             function setActiveFeature(featureId, settingsTab = null) {
                console.log(`%c[NAV] === Activating Feature: ${featureId} ===`, "color: blue; font-weight: bold;");

                // --- 1. Update State & URL ---
                currentFeature = featureId;
                currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);
                let hash = `#${featureId}`;
                if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                if (window.location.hash !== hash) { history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash); }

                // --- 2. Update Sidebar Active Item ---
                menuItems.forEach(item => item.classList.remove('active'));
                document.querySelector(`.menu-item[data-feature="${featureId}"]`)?.classList.add('active');

                // --- 3. HIDE EVERYTHING ---
                console.log("%c[NAV] Hiding all content sections...", "color: orange;");
                staticContentSections.forEach(section => section.style.display = 'none');
                featureSectionsContainer.style.display = 'none'; // Hide dynamic container
                featureSections.innerHTML = ''; // Clear previous dynamic content

                // --- 4. SHOW/LOAD TARGET ---
                let targetStaticElementId = null;
                if (featureId === 'dashboard') targetStaticElementId = 'dashboardContent';
                else if (featureId === 'profile') targetStaticElementId = 'profileContent';
                else if (featureId === 'settings') targetStaticElementId = 'settingsContent';

                removeDynamicStyles(); // Remove previously loaded dynamic CSS

                if (targetStaticElementId) {
                    // --- Show Static Section ---
                    const elementToShow = document.getElementById(targetStaticElementId);
                    if (elementToShow) {
                        console.log(`%c[NAV] Showing static section: #${targetStaticElementId}`, "color: green;");
                        elementToShow.style.display = 'block';
                        // Refresh static content if necessary
                        if (featureId === 'dashboard') { updateStats(); /* loadActivities maybe */ }
                        if (featureId === 'profile') { updateUserUI(); } // Refresh profile form
                        if (featureId === 'settings') { applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }
                    } else { console.error(`%c[ERROR] Static element #${targetStaticElementId} not found!`, "color: red;"); }
                } else {
                    // --- Load Dynamic Section ---
                    console.log(`%c[NAV] Loading dynamic feature: ${featureId}`, "color: purple;");
                    featureSectionsContainer.style.display = 'block'; // Show the container
                    featureSections.innerHTML = ''; // Clear just in case
                    featureSections.appendChild(featurePlaceholder); // Add placeholder
                    featurePlaceholder.style.display = 'flex';
                    featureTitle.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`;
                    featureDescription.textContent = '';
                    featureLoadingIndicator.style.display = 'block';
                    featureErrorMessage.style.display = 'none';

                    // --- Load CSS dynamically first ---
                    loadDynamicCSS(featureId)
                        .then(() => {
                            // --- Then Load HTML ---
                            const filePath = `sections/${featureId}.html`;
                            console.log(`%c[FETCH] Fetching HTML: ${filePath}`, "color: #007acc;");
                            return fetch(filePath);
                        })
                        .then(response => {
                            console.log(`%c[FETCH] HTML Status for ${filePath}: ${response.status}`, "color: #007acc;");
                            if (!response.ok) { throw new Error(`HTTP ${response.status}`); }
                            return response.text();
                        })
                        .then(htmlContent => {
                            console.log(`%c[FETCH] Success: ${featureId}. Injecting HTML.`, "color: green;");
                            featureSections.innerHTML = htmlContent; // Replace placeholder

                            // --- Call Initializer ---
                            if (featureId === 'employee-scheduling') {
                                // Check if function exists (it should be defined globally now)
                                if (typeof initializeEmployeeSchedule === 'function') {
                                    try {
                                         console.log("%c[INIT] Calling initializeEmployeeSchedule...", "color: teal;");
                                         initializeEmployeeSchedule(JSON.parse(JSON.stringify(currentUser)), JSON.parse(JSON.stringify(teamMembers)));
                                         console.log("%c[INIT] OK: initializeEmployeeSchedule", "color: teal;");
                                     } catch (err) { console.error(`%c[INIT ERROR] initializeEmployeeSchedule:`, "color: red;", err); displayInitError(featureId, err); }
                                } else { console.warn(`%c[INIT WARN] initializeEmployeeSchedule not found.`, "color: orange;"); displayInitWarning(featureId); }
                            }
                            // Add else if for other features
                        })
                        .catch(error => {
                            // This catches errors from CSS loading OR HTML fetching
                            console.error(`%c[ERROR] Failed loading feature '${featureId}':`, "color: red;", error);
                            displayFetchError(featureId, error, `CSS or HTML for ${featureId}`);
                            removeDynamicStyles(featureId); // Clean up potentially loaded CSS if HTML failed
                        });
                }

                // --- 5. Update Back Button ---
                backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';
                // --- 6. Scroll Top ---
                window.scrollTo(0, 0);
                 console.log(`%c[NAV] === Activation END: ${featureId} ===`, "color: blue;");
            }

            // --- Dynamic CSS Loading ---
            function loadDynamicCSS(featureId) {
                return new Promise((resolve, reject) => {
                    const cssPath = `css/${featureId}.css`; // Assumes css folder parallel to sections
                    const existingLink = document.getElementById(`dynamic-style-${featureId}`);

                    if (existingLink) {
                        console.log(`%c[CSS] Styles for ${featureId} already loaded.`, "color: gray;");
                        resolve(); // Already loaded
                        return;
                    }

                    console.log(`%c[CSS] Loading: ${cssPath}`, "color: #cc00cc;");
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.type = 'text/css';
                    link.href = cssPath;
                    link.id = `dynamic-style-${featureId}`; // ID to find and remove later
                    link.onload = () => {
                        console.log(`%c[CSS] Loaded successfully: ${cssPath}`, "color: green;");
                        resolve();
                    };
                    link.onerror = (error) => {
                        console.error(`%c[CSS ERROR] Failed to load ${cssPath}`, "color: red;", error);
                        // Remove the failed link tag
                        link.remove();
                        reject(new Error(`Failed to load CSS: ${cssPath}`));
                    };
                    document.head.appendChild(link);
                });
            }

            function removeDynamicStyles() {
                const dynamicLinks = document.querySelectorAll('link[id^="dynamic-style-"]');
                dynamicLinks.forEach(link => {
                    console.log(`%c[CSS] Removing: ${link.id}`, "color: orange;");
                    link.remove();
                });
            }

            // Helper functions for displaying errors in placeholder
            function displayFetchError(featureId, error, filePath) { /* ... (same as before) ... */ featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featurePlaceholder.style.display = 'flex'; featureTitle.textContent = `Error Loading: ${featureId}`; featureDescription.textContent = `Could not fetch ${filePath}. ${error.message}. Check path & console.`; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'block'; }
            function displayInitError(featureId, error) { /* ... (same as before) ... */ featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featurePlaceholder.style.display = 'flex'; featureTitle.textContent = `Initialization Error: ${featureId}`; featureDescription.textContent = `Content loaded, but script failed: ${error.message}. Check console.`; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'block'; }
            function displayInitWarning(featureId) { /* ... (same as before) ... */ featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featurePlaceholder.style.display = 'flex'; featureTitle.textContent = `${featureId} Loaded (No Init Script)`; featureDescription.textContent = `Content might not be fully interactive. Initialization script not found.`; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'none'; }

            function activateSettingsTab(tabId) { /* ... (same as before) ... */ }
            function handleInitialNavigation() { /* ... (same as before) ... */ }

            // --- Other Functions (Action Handlers, Utilities) ---
            // ... (Paste ALL other JS functions like handleProfileSave, addActivity, etc. here) ...

            // --- Event Listener Setup ---
             function setupEventListeners() {
                console.log("%c[SETUP] Setting up event listeners...", "color: gray;");
                sidebar.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem?.dataset.feature) { e.preventDefault(); setActiveFeature(menuItem.dataset.feature); }
                });
                 profileLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('profile'); });
                 settingsLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('settings'); });
                 // ... (Add ALL other event listeners from the previous correct version) ...
                 backButton.addEventListener('click', () => setActiveFeature('dashboard'));
                 window.addEventListener('popstate', (event) => { /* ... */ });
                 // etc...
            }

            // --- Employee Scheduling Initialization (now defined globally) ---
             function initializeEmployeeSchedule(currentUserData, employeesData) {
                 // --- This function remains exactly the same as the previous response ---
                 // --- It will be called by setActiveFeature AFTER loading ---
                 console.log("%c[INIT] initializeEmployeeSchedule called.", "color: teal;");
                 const scheduleContainer = document.getElementById('featureSections');
                 if (!scheduleContainer) { console.error("Init Schedule Error: #featureSections not found!"); return; }
                 // Get ALL elements needed by the schedule logic, scoped to scheduleContainer
                 const employeeModal = scheduleContainer.querySelector('#employeeModal');
                 // ... (rest of the getElementById/querySelector calls scoped to scheduleContainer) ...
                 console.log("... schedule logic runs ...");
                 // updateWeekDisplay(); // Call initial display update
                 console.log("Employee Schedule Initialized Successfully.");
             }

            // --- Run Initialization ---
            initDashboard();
        });
    </script>
</body>
</html>

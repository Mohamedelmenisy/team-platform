<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome (Dashboard already includes it) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon - Ensuring it's present -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->


    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */

            /* High Contrast Variables (Initial basic setup) */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable (for request ✅ 2️⃣) - Aliased to existing variables */
            --text-color: var(--dark);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6; /* Light gray for weekend cells */
             --schedule-weekend-text: #9ca3af; /* Muted text for weekend OFF */
             /* Light Mode Shift Colors */
             --shift-morning-bg: #dbeafe;
             --shift-morning-text: #1e40af;
             --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe;
             --shift-afternoon-text: #0c4a6e;
             --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe;
             --shift-night-text: #5b21b6;
             --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4;
             --shift-off-text: #166534;
             --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2;
             --shift-sick-text: #991b1b;
             --shift-sick-border: #fecaca;
             --shift-vacation-bg: #ffedd5;
             --shift-vacation-text: #9a3412;
             --shift-vacation-border: #fed7aa;

            /* --- Team Members Feature Specific Variables (mapped from original) --- */
            --feature-team-bg: var(--white); /* Section background - use white for light mode */
            --feature-team-card-bg: var(--white);            /* Card background */
            --feature-team-border-color: var(--light-gray);       /* Border color */
            --feature-team-shadow-color: rgba(0, 0, 0, 0.05); /* Reduced shadow intensity */
            --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); /* Subtle shadow increase on hover */
            --feature-team-text-primary: var(--dark);       /* Names */
            --feature-team-text-secondary: var(--gray);     /* Emails */
            --feature-team-title-text: var(--dark);         /* Title text */
            --feature-team-title-bg: var(--light);     /* Soft Gray title background - use light */
            --feature-team-admin-color: var(--danger);        /* Slightly softer deep red */
            --feature-team-supervisor-color: var(--primary);   /* Professional blue */
            --feature-team-senior-color: var(--success);       /* Professional green */
            --feature-team-member-color: var(--gray);       /* Professional gray */
            --feature-team-card-border-radius: 12px;    /* Slightly more rounded */
            --feature-team-section-padding: 1.5rem; /* Match dashboard spacious padding */
            --feature-team-card-padding: 1.25rem;          /* Increased card padding slightly */
            --feature-team-grid-gap: 1.5rem;              /* Match dashboard grid gap */

            /* --- Projects Feature Specific Variables (mapped from original) --- */
            --feature-projects-body-bg: var(--primary-light);
            --feature-projects-card-bg: var(--white);
            --feature-projects-text-color: var(--text-color);
            --feature-projects-text-muted: var(--gray);
            --feature-projects-heading-color: var(--primary-dark);
            --feature-projects-border-color: var(--light-gray);
            --feature-projects-shadow-color: rgba(0, 0, 0, 0.08);
            --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12);
            --feature-projects-input-bg: var(--white);
            --feature-projects-input-border: var(--light-gray);
            --feature-projects-input-focus-border: var(--primary);
            --feature-projects-input-focus-shadow: rgba(37, 99, 235, 0.1);
            --feature-projects-primary-color: var(--primary);
            --feature-projects-primary-hover: var(--primary-dark);
            --feature-projects-primary-text: var(--white);
            --feature-projects-success-bg: #dcfce7; /* Light Green Bg */
            --feature-projects-success-text: #15803d; /* Dark Green Text */
            --feature-projects-success-progress: var(--success);
            --feature-projects-warning-bg: #fef3c7; /* Light Yellow Bg */
            --feature-projects-warning-text: #a16207; /* Dark Yellow Text */
            --feature-projects-warning-progress: var(--warning);
            --feature-projects-warning-btn-text: var(--dark); /* Dark text for yellow button */
            --feature-projects-info-bg: #e0f2fe; /* Light Blue Bg */
            --feature-projects-info-text: #075985; /* Dark Blue Text */
            --feature-projects-info-progress: var(--primary);
            --feature-projects-secondary-bg: var(--light-gray);
            --feature-projects-secondary-text: var(--gray);
            --feature-projects-secondary-progress: var(--gray);
            --feature-projects-danger-color: var(--danger);
            --feature-projects-danger-hover: #dc2626;
            --feature-projects-danger-text: var(--white);
            --feature-projects-progress-bar-bg: var(--light-gray);
            --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5); /* Use dashboard modal */
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode (Existing + Refined) --- */
        body.high-contrast {
             --hc-text: #000000;
             --hc-background: #ffffff;
             --hc-primary: #0000ff;
             --hc-secondary: #008000;
             --hc-link: #0000ee;
             --hc-border: #000000;
             --dark: var(--hc-text);
             --light: var(--hc-background);
             --gray: var(--hc-text);
             --light-gray: var(--hc-border);
             --white: var(--hc-background);
             --primary: var(--hc-primary);
             --primary-dark: var(--hc-primary);
             --primary-light: #e0e0ff;
             --secondary: var(--hc-secondary);
             --success: var(--hc-secondary);
             --warning: #ffa500; /* Orange */
             --danger: #ff0000; /* Red */
             --sidebar-bg: var(--hc-background);
             --sidebar-text: var(--hc-text);
             --sidebar-hover: #e0e0e0;
             --sidebar-active: #c0c0c0;
             --sidebar-divider: var(--hc-border);
             --text-color: var(--hc-text);
             --schedule-weekend-bg: #dddddd; /* HC weekend BG */
             --schedule-weekend-text: var(--hc-text); /* HC weekend text */
             /* Mapped Feature Variables for HC */
             --feature-team-bg: var(--hc-background);
             --feature-team-card-bg: var(--hc-background);
             --feature-team-border-color: var(--hc-border);
             --feature-team-shadow-color: transparent;
             --feature-team-hover-shadow-color: transparent;
             --feature-team-text-primary: var(--hc-text);
             --feature-team-text-secondary: var(--hc-text);
             --feature-team-title-text: var(--hc-text);
             --feature-team-title-bg: var(--hc-background);
             --feature-team-admin-color: var(--danger);
             --feature-team-supervisor-color: var(--hc-primary);
             --feature-team-senior-color: var(--hc-secondary);
             --feature-team-member-color: var(--hc-text);
             --feature-projects-card-bg: var(--hc-background);
             --feature-projects-text-color: var(--hc-text);
             --feature-projects-text-muted: var(--hc-text);
             --feature-projects-heading-color: var(--hc-text);
             --feature-projects-border-color: var(--hc-border);
             --feature-projects-shadow-color: transparent;
             --feature-projects-shadow-hover-color: transparent;
             --feature-projects-input-bg: var(--hc-background);
             --feature-projects-input-border: var(--hc-border);
             --feature-projects-primary-color: var(--hc-primary);
             --feature-projects-primary-text: var(--hc-background);
             --feature-projects-success-bg: var(--hc-background);
             --feature-projects-success-text: var(--hc-secondary);
             --feature-projects-success-progress: var(--hc-secondary);
             --feature-projects-warning-bg: var(--hc-background);
             --feature-projects-warning-text: var(--hc-text);
             --feature-projects-warning-progress: var(--warning);
             --feature-projects-warning-btn-text: var(--hc-text);
             --feature-projects-info-bg: var(--hc-background);
             --feature-projects-info-text: var(--hc-primary);
             --feature-projects-info-progress: var(--hc-primary);
             --feature-projects-secondary-bg: var(--hc-background);
             --feature-projects-secondary-text: var(--hc-text);
             --feature-projects-secondary-progress: var(--hc-text);
             --feature-projects-danger-color: var(--danger);
             --feature-projects-danger-text: var(--hc-background);
             --feature-projects-progress-bar-bg: var(--hc-background);
              /* HC Shift Colors */
             --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border);
             --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border);
             --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border);
             --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border);
             --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border);
             --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border);

             color: var(--text-color);
             background-color: var(--hc-background);
        }
        body.high-contrast .welcome-section,
        body.high-contrast .stat-card,
        body.high-contrast .top-nav,
        body.high-contrast .sidebar,
        body.high-contrast .activity-section,
        body.high-contrast .content-section, /* Applied to individual sections now */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section,
        body.high-contrast #featureSectionsContainer.projects-feature .project-card,
        body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper,
        body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-management-content,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-card {
            background: var(--hc-background);
            border: 1px solid var(--hc-border);
            color: var(--text-color);
            box-shadow: none !important; /* Remove shadows in HC */
        }
        body.high-contrast .btn,
        body.high-contrast .form-control,
        body.high-contrast .search-bar input,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-filter input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-search-input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-filter-select,
        body.high-contrast #featureSectionsContainer.task-management-feature #search-input,
        body.high-contrast #featureSectionsContainer.task-management-feature .filters select,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form input,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form textarea,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form select {
            border: 1px solid var(--hc-border);
            background: var(--hc-background);
            color: var(--text-color);
        }
        body.high-contrast .btn-primary,
        body.high-contrast #featureSectionsContainer.projects-feature .add-project-btn,
        body.high-contrast #featureSectionsContainer.task-management-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.team-members-feature .add-team-member-btn {
            background-color: var(--hc-primary); color: var(--hc-background); border: 1px solid var(--hc-border);
        }
        body.high-contrast .btn-danger { background-color: var(--danger); color: var(--hc-background); border: 1px solid var(--hc-border); }
        body.high-contrast .btn-warning { background-color: var(--warning); color: var(--hc-text); border: 1px solid var(--hc-border); }
        body.high-contrast .btn-success { background-color: var(--hc-secondary); color: var(--hc-background); border: 1px solid var(--hc-border); }
        body.high-contrast .btn-outline { background: var(--hc-background); color: var(--hc-primary); border: 1px solid var(--hc-primary); }
        body.high-contrast .logo { color: var(--text-color); }
        body.high-contrast .logo-icon { color: var(--hc-primary); }
        body.high-contrast .menu-item { color: var(--text-color); border-left-color: transparent; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0; border-left-color: var(--hc-primary); color: var(--hc-text); }
        body.high-contrast .stat-card { border-left-width: 3px; background: var(--hc-background); } /* Reset gradient */
        body.high-contrast .welcome-section { background: var(--hc-background); border: 1px solid var(--hc-border); color: var(--hc-text);}
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text); } /* Reset role color */
        body.high-contrast #featureSectionsContainer.team-members-feature .member-role,
        body.high-contrast #featureSectionsContainer.projects-feature .project-status,
        body.high-contrast #featureSectionsContainer.task-management-feature .status-badge {
            border: 1px solid var(--hc-border); color: var(--hc-text); background: none !important; padding: 3px 8px;
        }
        body.high-contrast #featureSectionsContainer.projects-feature .progress-bar {
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast #featureSectionsContainer.projects-feature .progress-bar-container { background: var(--hc-background); border: 1px solid var(--hc-border); }
        body.high-contrast #featureSectionsContainer.projects-feature .project-participants span {
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast .theme-preview { border: 2px solid var(--hc-border); background: var(--hc-background) !important; }
         body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary); }
         body.high-contrast .switch .slider { background-color: #999; border: 1px solid var(--hc-border); }
         body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary); }
         body.high-contrast .switch .slider:before { background-color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th { background: var(--hc-background); color: var(--hc-text); border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border: 1px solid var(--hc-border); background: var(--hc-background) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name { background: var(--hc-background); border-right: 2px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-name,
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-date { color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift { border: 1px solid var(--hc-border); background: none !important; color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift-weekend-off { border: none; font-style: normal; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
         body.high-contrast #featureSectionsContainer.task-management-feature .modal-content,
         body.high-contrast #featureSectionsContainer.task-management-feature .controls { border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card { border-left-width: 3px; }


        /* --- Sidebar Styles (Existing) --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles (Existing) --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles (Reverted Structure) --- */
        /* The main wrapper for content */
        .content-area {
            padding: 2rem; /* Default padding */
            min-height: calc(100vh - 70px); /* Adjusted height */
            transition: padding 0.3s ease;
        }
        /* Padding adjustment for compact/spacious modes */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }

        /* Specific rule to remove padding when file sharing is active */
        body.file-sharing-active .content-area {
            padding: 0 !important;
        }

        /* Styles for sections inside the content area */
        .content-section {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: none; /* Hidden by default */
            animation: fadeInContent 0.4s ease-in-out;
            margin-bottom: 2rem; /* Add margin between sections if needed */
        }
        .content-section:last-child {
            margin-bottom: 0; /* No margin for the last section */
        }
        /* Show section when active */
        .content-section.active {
            display: block;
        }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Welcome Section Styles */
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem; /* Padding is inside this section */
            border-radius: 8px;
            margin-bottom: 2rem; /* Keep margin bottom for spacing */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out;
        }
        /* ... other specific section styles like stats, activity remain largely the same ... */
        /* Ensure they don't have the .content-area padding applied directly */
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        .stat-card { /* Styles for individual stat cards */ padding: 1.5rem; /* Padding inside the card */ /* ... other stat card styles ... */ }
        .activity-section { /* Styles for activity section */ padding: 1.5rem; /* Padding inside the section */ /* ... other activity section styles ... */ }

        /* Profile & Settings Sections (No direct .content-area padding) */
        #profileContent { /* No padding here, inherited from .content-area wrapper */ }
        #settingsContent { /* No padding here, inherited from .content-area wrapper */ }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; padding: 0; /* Remove padding if added before */ }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        /* ... other profile/settings specific styles ... */

        /* Feature Container (No direct .content-area padding unless added by JS for specific features) */
        #featureSectionsContainer {
            /* Base styles for the container */
            margin-bottom: 0; /* Usually the last element */
        }
        /* Apply content-area padding when needed for specific features */
        #featureSectionsContainer.content-area-padding {
             padding: 2rem; /* Default padding */
             background-color: var(--white);
             border-radius: 8px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        body.compact #featureSectionsContainer.content-area-padding { padding: 1rem; }
        body.spacious #featureSectionsContainer.content-area-padding { padding: 3rem; }

        /* Iframe specific styles */
        #featureSectionsContainer.file-sharing-feature {
             padding: 0 !important; /* Ensure no padding for iframe container */
             height: calc(100vh - 70px); /* Adjust height calculation if needed */
             overflow: hidden;
             background-color: transparent; /* No background */
             box-shadow: none; border: none; border-radius: 0;
             margin-bottom: 0; /* Remove margin when iframe is shown */
        }
        #fileShareIframe {
             width: 100%;
             height: 100%;
             border: none;
             display: block;
        }
        /* ... Rest of the CSS remains the same ... */

        /* --- Responsive Styles (Existing) --- */
        /* ... All existing responsive styles ... */
        @media (max-width: 768px) {
             /* REVERTED: No longer need body.file-sharing-active .content-area rule here */
             /* Base content area padding for mobile */
             .content-area { padding: 1.5rem; }
             body.compact .content-area { padding: 1rem; }
             body.spacious .content-area { padding: 2rem; }
             /* Apply no padding rule for file sharing on mobile too */
             body.file-sharing-active .content-area { padding: 0 !important; }

             /* ... other 768px styles ... */
        }
        /* ... other media queries ... */

    </style>
</head>
<!-- Apply theme class from localStorage -->
<body class=""> <!-- Start with no specific theme, JS will apply -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle (Visible on smaller screens) -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Success/Toast message container -->
    <div class="toast" id="toastMessage">Toast message</div>
    <!-- Success message (Specific style from original) -->
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
            <!-- Optional: Close button inside sidebar for mobile -->
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none; background: none; border: none; color: white; font-size: 1.2rem; position: absolute; top: 1.5rem; right: 1rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <!-- Sidebar items remain the same -->
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span>
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <!-- Top Nav content remains the same -->
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults">
                    <!-- Search results will be populated here -->
                 </div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer"> <!-- Added ID for event delegation -->
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status"> • Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <!-- Back Button -->
         <div class="back-button" id="backButton" style="display: none; padding: 0 2rem 1.5rem;"> <!-- Keep outside content-area -->
             <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
         </div>

         <!-- REVERTED: Add the main content area wrapper back -->
         <div class="content-area">

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active"> <!-- Removed content-area class -->
                 <!-- Dashboard HTML remains the same -->
                  <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent"> <!-- Removed content-area class -->
                 <!-- Profile HTML remains the same -->
                  <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent"> <!-- Removed content-area class -->
                 <!-- Settings HTML remains the same -->
                   <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>
                 <div class="settings-panel active" id="preferencesPanel">
                      <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light">
                                     <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div>
                                     <span class="theme-label">Light</span>
                                 </div>
                                 <div class="theme-option" data-theme="dark">
                                     <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div>
                                     <span class="theme-label">Dark</span>
                                 </div>
                                 <div class="theme-option" data-theme="system">
                                    <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div>
                                    <span class="theme-label">System</span>
                                 </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div>
                                <span class="setting-item-label">High Contrast Mode</span>
                                <p class="setting-item-description">Increase text visibility.</p>
                            </div>
                            <div class="setting-item-control">
                                <label class="switch">
                                    <input type="checkbox" id="highContrastToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                         </div>
                     </div>
                    <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                 <label for="languageSelect">Language</label>
                                 <select id="languageSelect" class="form-control">
                                     <option value="en">English (US)</option>
                                     <option value="ar">العربية (Arabic)</option>
                                     <option value="es">Español (Spanish)</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="regionSelect">Region / Timezone</label>
                                 <select id="regionSelect" class="form-control">
                                     <option value="utc">UTC</option>
                                     <option value="est">EST (UTC-5)</option>
                                     <option value="pst">PST (UTC-8)</option>
                                     <option value="cet">CET (UTC+1)</option>
                                     <option value="eet">EET (UTC+2)</option>
                                     <option value="ast">AST (UTC+3) - Riyadh</option>
                                 </select>
                             </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                 <label for="timeFormatSelect">Time Format</label>
                                 <select id="timeFormatSelect" class="form-control">
                                     <option value="12h">12-hour (e.g., 3:00 PM)</option>
                                     <option value="24h">24-hour (e.g., 15:00)</option>
                                 </select>
                             </div>
                              <div class="form-group">
                                 <label for="dateFormatSelect">Date Format</label>
                                 <select id="dateFormatSelect" class="form-control">
                                     <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                     <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                     <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                     <option value="Month D, YYYY">Month D, YYYY</option>
                                 </select>
                             </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Toast Notifications</span>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="toastToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Sound Notifications</span>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="soundToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="form-group">
                             <label for="notificationToneSelect">Notification Tone</label>
                             <select id="notificationToneSelect" class="form-control" disabled>
                                 <option value="default">Default</option>
                             </select>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button>
                     </div>
                 </div>
                 <div class="settings-panel" id="accountPanel">
                     <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group">
                                 <label for="accountEmail">Current Email</label>
                                 <input type="email" id="accountEmail" class="form-control" value="" readonly>
                             </div>
                             <div class="form-group">
                                <label for="changeEmail">New Email Address</label>
                                <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled>
                            </div>
                             <div class="form-group" style="grid-column: span 2;">
                                <label for="accountConfirmPassword">Confirm Password (to change email)</label>
                                <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled>
                            </div>
                            <div class="form-actions" style="grid-column: span 2;">
                                <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button>
                            </div>
                         </div>
                         <p style="margin-top: 1rem;">Password changes managed in <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div><span class="setting-item-label">Enable Account Notifications</span></div>
                             <div class="setting-item-control"><label class="switch"><input type="checkbox" id="accountNotificationsToggle" checked><span class="slider round"></span></label></div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button>
                     </div>
                 </div>
                 <div class="settings-panel" id="securityPanel">
                     <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group"><label for="currentPassword">Current Password</label><input type="password" id="currentPassword" class="form-control"></div>
                             <div class="form-group"><label for="newPassword">New Password</label><input type="password" id="newPassword" class="form-control"></div>
                             <div class="form-group"><label for="confirmPassword">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control"></div>
                             <div class="form-actions"><button type="submit" class="btn btn-primary">Change Password</button></div>
                         </form>
                     </div>
                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status"><span class="status-indicator disabled" id="twoFaStatusIndicator"></span><span id="twoFaStatusText">2FA is currently Disabled</span></div>
                         <div id="twoFaSetupSection" style="display: block;"><button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button><div class="two-fa-setup" id="twoFaSetupOptions" style="display:none;"><h5>Choose Method:</h5><div class="two-fa-actions"><button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> App</button><button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS</button></div><div id="authAppSetup" style="display: none; margin-top: 1.5rem;"><p>1. Scan QR</p><div class="qr-code-placeholder">QR Code</div><p>2. Enter code</p><div class="form-group"><label for="authCode">Code</label><input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6"></div><button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button></div><div id="smsSetup" style="display: none; margin-top: 1.5rem;"><p>1. Send SMS to (<span id="userPhoneNumberForSms"></span>)</p><button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button><div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup"><label for="smsCode">SMS Code</label><input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6"></div><button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button></div></div></div>
                         <div id="twoFaManagementSection" style="display: none;"><p>2FA is enabled.</p><div class="two-fa-actions"><button class="btn btn-outline" disabled>Recovery Codes</button><button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button></div></div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;"><div class="form-group"><label for="sessionDuration">Session Duration (min)</label><input type="number" id="sessionDuration" class="form-control" value="60" min="15"></div><div class="form-group"><label for="idleTimeout">Idle Timeout (min)</label><input type="number" id="idleTimeout" class="form-control" value="15" min="5"></div></div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"><button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button></div>
                     </div>
                 </div>
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection"><h4>Notification Delivery</h4><div class="setting-item"><div><span class="setting-item-label">Enable Email Notifications</span></div><div class="setting-item-control"><label class="switch"><input type="checkbox" id="emailNotificationsToggle" checked><span class="slider round"></span></label></div></div><div class="setting-item"><div><span class="setting-item-label">Enable In-App Notifications</span></div><div class="setting-item-control"><label class="switch"><input type="checkbox" id="inAppNotificationsToggle" checked><span class="slider round"></span></label></div></div><div class="setting-item"><div><span class="setting-item-label">Enable Push Notifications</span></div><div class="setting-item-control"><label class="switch"><input type="checkbox" id="pushNotificationsToggle" disabled><span class="slider round"></span></label></div></div></div>
                     <div class="settings-subsection"><h4>Notification Types</h4><div class="checkbox-group"><label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label><label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment</label><label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label><label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label><label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label><label><input type="checkbox" name="notificationType" value="system_announcement" checked> Announcement</label></div></div>
                     <div class="settings-subsection"><h4>Sound & Priority</h4><p class="setting-item-description">Sound settings in <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences</a>.</p><div class="form-group"><label for="notificationPriority">Min Priority</label><select id="notificationPriority" class="form-control" disabled><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div></div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"><button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notifications</button></div>
                 </div>
                 <div class="settings-panel" id="teamPanel">
                      <div class="team-management"><div class="settings-subsection"><h4>Team Members</h4><div class="team-list" id="teamList"><p>Loading team members...</p></div><div class="add-member-form"><h4>Invite New Member</h4><form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;"><div class="form-group"><label for="inviteEmail">Email</label><input type="email" id="inviteEmail" class="form-control" required></div><div class="form-group"><label for="inviteRole">Role</label><select id="inviteRole" class="form-control" required><option value="member">Member</option><option value="supervisor">Supervisor</option><option value="senior">Senior</option><option value="admin">Admin</option></select></div><button type="submit" class="btn btn-primary">Invite</button></form></div></div><div class="settings-subsection"><h4>Custom Role Permissions</h4><button class="btn btn-outline" disabled>Manage Permissions</button></div></div>
                 </div>
                 <div class="settings-panel" id="collaborationPanel">
                    <div class="settings-subsection"><h4>External Integrations</h4><div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;"><button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Slack</button><button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Drive</button><button class="btn btn-outline" disabled><i class="fab fa-github"></i> GitHub</button></div></div>
                    <div class="settings-subsection"><h4>Sharing & Invitations</h4><div class="setting-item"><div><span class="setting-item-label">Allow External Links</span></div><div class="setting-item-control"><label class="switch"><input type="checkbox" id="externalSharingToggle" disabled><span class="slider round"></span></label></div></div><button class="btn btn-outline" disabled>Manage Invites</button></div>
                 </div>
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3><p>Actions here are permanent.</p><div class="danger-zone-item"><div><h5>Logout From All Devices</h5></div><button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button></div><div class="danger-zone-item"><div><h5>Delete Account</h5></div><button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button></div>
                 </div>
             </div>

             <!-- Container for other feature sections -->
             <div id="featureSectionsContainer" class="content-section"> <!-- Removed content-area class -->
                 <!-- Content loaded dynamically here -->
                 <!-- Placeholder is added/removed by JS -->
             </div>

         </div> <!-- END: content-area wrapper -->

    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <!-- Modal content remains the same -->
          <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications">×</button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <!-- Modal content remains the same -->
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button>
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <!-- Modal content remains the same -->
          <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="memberModalTitle">Member Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group"><label for="memberFirstName">First Name</label><input type="text" id="memberFirstName" class="form-control" required></div>
                     <div class="form-group"><label for="memberLastName">Last Name</label><input type="text" id="memberLastName" class="form-control" required></div>
                     <div class="form-group"><label for="memberEmail">Email</label><input type="email" id="memberEmail" class="form-control" required></div>
                     <div class="form-group"><label for="memberRole">Role</label><select id="memberRole" class="form-control" required><option value="member">Member</option><option value="supervisor">Supervisor</option><option value="senior">Senior</option><option value="admin">Admin</option></select></div>
                      <div class="form-group"><label for="memberTitle">Job Title</label><input type="text" id="memberTitle" class="form-control"></div>
                      <div class="form-group"><label for="memberDepartment">Department</label><input type="text" id="memberDepartment" class="form-control"></div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;">
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <!-- Modal content remains the same -->
         <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Project Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;">
                    <div class="form-group"><label for="projectName">Project Name</label><input type="text" id="projectName" class="form-control" required></div>
                    <div class="form-group"><label for="projectDescription">Description</label><textarea id="projectDescription" class="form-control" rows="3"></textarea></div>
                    <div class="form-group"><label for="projectParticipantsInput">Participants (|)</label><input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S."></div>
                    <div class="form-group"><label for="projectImageInput">Image URL</label><input type="url" id="projectImageInput" class="form-control" placeholder="https://..."></div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                         <div class="form-group"><label for="projectStartDate">Start</label><input type="date" id="projectStartDate" class="form-control"></div>
                        <div class="form-group"><label for="projectDueDate">Due</label><input type="date" id="projectDueDate" class="form-control"></div>
                         <div class="form-group"><label for="projectStatus">Status</label><select id="projectStatus" class="form-control" required><option value="pending">Pending</option><option value="active">Active</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div>
                        <div class="form-group"><label for="projectProgress">Progress (%)</label><input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0"></div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;">
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Container for Task Management CSS and JS -->
    <template id="taskManagementAssets">
        <!-- Template content remains the same -->
         <style id="task-management-styles">
             /* --- PASTE CSS FROM task.txt HERE --- */
            #featureSectionsContainer.task-management-feature * { box-sizing: border-box; }
            #featureSectionsContainer.task-management-feature .task-management-content { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7fc; color: #333; line-height: 1.6; }
            #featureSectionsContainer.task-management-feature .task-management-content .container { max-width: 1200px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
            #featureSectionsContainer.task-management-feature .task-management-content h1 { color: #333; margin-bottom: 25px; text-align: center; font-weight: 600; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn { padding: 10px 18px; margin-left: 5px; gap: 5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn i { font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-primary { background-color: #007bff; color: white; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-primary:hover { background-color: #0056b3; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-secondary { background-color: #6c757d; color: white; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-secondary:hover { background-color: #5a6268; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-danger { background-color: #dc3545; color: white; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-danger:hover { background-color: #c82333; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-warning { background-color: #ffc107; color: #333; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-warning:hover { background-color: #e0a800; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-success { background-color: #28a745; color: white; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-success:hover { background-color: #218838; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-info { background-color: #17a2b8; color: white; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn-info:hover { background-color: #138496; }
            #featureSectionsContainer.task-management-feature .task-management-content .controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 30px; padding: 15px; background-color: #e9ecef; border-radius: 6px; gap: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .search-container { position: relative; display: flex; align-items: center; flex-grow: 1; min-width: 200px; }
            #featureSectionsContainer.task-management-feature .task-management-content #search-input { padding: 10px 35px 10px 15px; border: 1px solid #ced4da; border-radius: 5px; font-size: 1em; width: 100%; }
            #featureSectionsContainer.task-management-feature .task-management-content .search-icon { position: absolute; right: 12px; color: #6c757d; pointer-events: none; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters { display: flex; flex-wrap: wrap; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters select { padding: 10px; border: 1px solid #ced4da; border-radius: 5px; background-color: #fff; font-size: 0.95em; cursor: pointer; min-width: 150px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-list { margin-top: 20px; display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
            #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { text-align: center; color: #6c757d; padding: 40px 20px; font-size: 1.1em; background-color: #f8f9fa; border-radius: 6px; grid-column: 1 / -1; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: #ffffff; border: 1px solid #e0e0e0; border-left: 5px solid #007bff; border-radius: 6px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: box-shadow 0.3s ease, transform 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); transform: translateY(-2px); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { font-size: 1.25em; margin-bottom: 10px; color: #0056b3; word-break: break-word; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card p { margin-bottom: 8px; color: #555; font-size: 0.95em; word-break: break-word; line-height: 1.5; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: #666; font-size: 0.9em; margin-bottom: 15px; max-height: 80px; overflow-y: auto; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: #333; min-width: 90px; display: inline-block; margin-right: 5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links { font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links span { display: inline-block; margin-right: 5px; margin-bottom: 3px; word-break: break-all; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: #007bff; text-decoration: none; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a:hover { text-decoration: underline; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta { font-size: 0.85em; color: #777; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta > div { display: flex; flex-wrap: wrap; gap: 5px 15px; margin-bottom: 5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta span { white-space: nowrap; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-High { border-left-color: #dc3545; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Medium { border-left-color: #ffc107; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Low { border-left-color: #28a745; }
            #featureSectionsContainer.task-management-feature .task-management-content .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; color: white; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: #ffc107; color: #333;}
            #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: #17a2b8; }
            #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: #28a745; }
            #featureSectionsContainer.task-management-feature .task-management-content .overdue-indicator { color: #dc3545; font-weight: bold; margin-left: 5px; font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: #f8f9fa; border-left-color: #6c757d; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3 { color: #6c757d; text-decoration: line-through; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta { color: #6c757d; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: #5a6268; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions { margin-top: 15px; text-align: right; border-top: 1px solid #eee; padding-top: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { background: none; border: none; font-size: 1.2em; padding: 5px 8px; margin-left: 10px; vertical-align: middle; color: #6c757d; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button:hover { transform: scale(1.1); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: #007bff; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: #dc3545; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn:hover { color: #a71d2a; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: #28a745; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn:hover { color: #1e7e34; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: #ffc107; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn:hover { color: #d39e00; }
            #featureSectionsContainer.task-management-feature .modal { display: none; position: fixed; z-index: 1060; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); padding-top: 50px; backdrop-filter: blur(3px); }
            #featureSectionsContainer.task-management-feature .modal-content { background-color: #fefefe; margin: 5% auto 10% auto; padding: 30px 40px; border: none; width: 90%; max-width: 650px; border-radius: 8px; position: relative; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); animation: slideDown 0.4s ease-out; }
            @keyframes slideDown { from {opacity: 0; transform: translateY(-30px);} to {opacity: 1; transform: translateY(0);} }
            #featureSectionsContainer.task-management-feature .modal-content .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; line-height: 1; transition: color 0.2s ease; text-decoration: none; cursor: pointer; background: none; border: none; }
            #featureSectionsContainer.task-management-feature .modal-content .close-btn:hover,
            #featureSectionsContainer.task-management-feature .modal-content .close-btn:focus { color: #333; text-decoration: none; cursor: pointer; }
            #featureSectionsContainer.task-management-feature .modal-content #modal-title { margin-bottom: 25px; font-weight: 600; color: #333; text-align: left; }
            #featureSectionsContainer.task-management-feature .modal-content #task-form { margin-top: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-group { margin-bottom: 18px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="text"],
            #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="date"],
            #featureSectionsContainer.task-management-feature .modal-content #task-form textarea,
            #featureSectionsContainer.task-management-feature .modal-content #task-form select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; transition: border-color 0.2s ease, box-shadow 0.2s ease; background-color: white; color: #333; }
            #featureSectionsContainer.task-management-feature .modal-content #task-form input:focus,
            #featureSectionsContainer.task-management-feature .modal-content #task-form textarea:focus,
            #featureSectionsContainer.task-management-feature .modal-content #task-form select:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); outline: none; }
            #featureSectionsContainer.task-management-feature .modal-content #task-form textarea { resize: vertical; min-height: 80px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row > div { flex: 1; min-width: 200px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-actions { text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
            #featureSectionsContainer.task-management-feature .modal-content .form-actions .btn { padding: 12px 25px; }
             /* --- END OF PASTED CSS --- */
        </style>
        <script>
            // --- PASTE JS LOGIC FROM task.txt HERE (will be wrapped) ---
            function initializeTaskManagementFeature(container) {
                 // --- DOM Elements ---
                const taskContentContainer = container.querySelector('.task-management-content');
                if (!taskContentContainer) { console.error("Task Management content container not found!"); return { cleanup: () => {} }; }
                const addTaskBtn = taskContentContainer.querySelector('#add-task-btn');
                const taskModal = taskContentContainer.querySelector('#task-modal');
                const closeModalBtn = taskModal?.querySelector('.close-btn');
                const cancelBtn = taskContentContainer.querySelector('#cancel-btn');
                const taskForm = taskContentContainer.querySelector('#task-form');
                const taskListDiv = taskContentContainer.querySelector('#task-list');
                const modalTitle = taskContentContainer.querySelector('#modal-title');
                const saveTaskBtn = taskContentContainer.querySelector('#save-task-btn');
                const taskIdInput = taskContentContainer.querySelector('#task-id');
                const taskNameInput = taskContentContainer.querySelector('#task-name');
                const taskDescriptionInput = taskContentContainer.querySelector('#task-description');
                const taskLinksInput = taskContentContainer.querySelector('#task-links');
                const taskAssignedBySelect = taskContentContainer.querySelector('#task-assigned-by');
                const taskAssignedToSelect = taskContentContainer.querySelector('#task-assigned-to');
                const taskStartDateInput = taskContentContainer.querySelector('#task-start-date');
                const taskDueDateInput = taskContentContainer.querySelector('#task-due-date');
                const taskPrioritySelect = taskContentContainer.querySelector('#task-priority');
                const taskStatusSelect = taskContentContainer.querySelector('#task-status');
                const searchInput = taskContentContainer.querySelector('#search-input');
                const filterStatusSelect = taskContentContainer.querySelector('#filter-status');
                const filterPrioritySelect = taskContentContainer.querySelector('#filter-priority');
                const filterAssignedToSelect = taskContentContainer.querySelector('#filter-assigned-to');
                 if (!addTaskBtn || !taskModal || !closeModalBtn || !taskListDiv || !taskForm) { console.error("Essential Task Management elements missing."); return { cleanup: () => {} }; }
                let tasks = []; let boundCloseOnEscape = null; let boundCloseOnOutsideClick = null;
                const loadTasks = () => { const storedTasks = localStorage.getItem('dashboard_tasks'); if (storedTasks) { try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); } } else { tasks = getDefaultTasks(); } renderTasks(); };
                function getDefaultTasks() { return [ { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure.", links: "https://nodejs.org", assignedBy: "Nada", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null }, { id: 2, name: "Design UI Mockups", description: "Create mockups for main pages using Figma.", links: "https://figma.com", assignedBy: "Yousef", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs.", links: "", assignedBy: "Self Assigned", assignedTo: "Yousef", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides.", links: "", assignedBy: "Nada", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null }, { id: 5, name: "Review Code Submission", description: "Review 'feature/login' branch.", links: "https://github.com, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" }, { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Special characters issue.", links: "jira-123", assignedBy: "Yousef", assignedTo: "Yousef", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } ]; }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };
                const formatDate = (dateString) => { if (!dateString) return 'N/A'; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) return 'Invalid Date'; return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } catch (e) { console.error("Error formatting date:", e); return 'Invalid Date'; } };
                const getCurrentDate = () => { return new Date().toLocaleDateString('en-CA'); };
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T00:00:00Z'); const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); if (isNaN(dueDate.getTime())) return false; return dueDate < todayUTC; } catch(e) { console.error("Error checking overdue:", e); return false; } };
                const renderTasks = () => { if (!taskListDiv) return; taskListDiv.innerHTML = ''; const searchTerm = searchInput ? searchInput.value.toLowerCase() : ''; const statusFilter = filterStatusSelect ? filterStatusSelect.value : 'all'; const priorityFilter = filterPrioritySelect ? filterPrioritySelect.value : 'all'; const assignedToFilter = filterAssignedToSelect ? filterAssignedToSelect.value : 'all'; let tasksToDisplay = tasks.filter(task => { const taskStatus = task.status || ''; const taskPriority = task.priority || ''; const taskAssignedTo = task.assignedTo || ''; const statusMatch = statusFilter === 'all' || taskStatus === statusFilter; const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter; const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter; return statusMatch && priorityMatch && assignedToMatch; }); if (searchTerm) { tasksToDisplay = tasksToDisplay.filter(task => { const nameMatch = (task.name || '').toLowerCase().includes(searchTerm); const descMatch = (task.description || '').toLowerCase().includes(searchTerm); const linksMatch = (task.links || '').toLowerCase().includes(searchTerm); const assignedToMatch = (task.assignedTo || '').toLowerCase().includes(searchTerm); const assignedByMatch = (task.assignedBy || '').toLowerCase().includes(searchTerm); return nameMatch || descMatch || linksMatch || assignedToMatch || assignedByMatch; }); } if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks">No tasks found.</p>'; return; } tasksToDisplay.sort((a, b) => { const statusOrder = { "Pending": 1, "In Progress": 1, "Completed": 2 }; const statusA = statusOrder[a.status] || 3; const statusB = statusOrder[b.status] || 3; if (statusA !== statusB) return statusA - statusB; const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00Z') : null; const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00Z') : null; const dateValA = dateA && !isNaN(dateA) ? dateA.getTime() : Infinity; const dateValB = dateB && !isNaN(dateB) ? dateB.getTime() : Infinity; if (dateValA !== dateValB) return dateValA - dateValB; const priorityOrder = { High: 3, Medium: 2, Low: 1 }; const priorityA = priorityOrder[a.priority] || 0; const priorityB = priorityOrder[b.priority] || 0; return priorityB - priorityA; }); tasksToDisplay.forEach(task => { const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue'); const overdue = isOverdue(task); const overdueText = overdue ? `<span class="overdue-indicator">(Overdue!)</span>` : ''; let linksHTML = 'N/A'; if (task.links && task.links.trim()) { linksHTML = task.links.split(',').map(l => l.trim()).filter(l => l).map(link => { let href = link; let isUrl = false; try { const url = new URL(link.startsWith('http') ? link : `http://${link}`); if(url.hostname && (url.hostname.includes('.') || url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))) { isUrl = true; href = url.protocol + "//" + url.hostname + url.pathname + url.search + url.hash; } else { href = link; } } catch (_) { isUrl = false; href = link; } const displayText = link.length > 35 ? link.substring(0, 32) + '...' : link; return isUrl ? `<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>` : `<span title="${link}">${displayText}</span>`; }).join(' '); } taskCard.innerHTML = `<h3>${task.name || 'Unnamed'}</h3> ${task.description ? `<p class="description">${task.description}</p>` : ''} <p><strong>Links:</strong> <span class="links">${linksHTML}</span></p> <p><strong>By:</strong> ${task.assignedBy || 'N/A'}</p> <p><strong>To:</strong> ${task.assignedTo || 'N/A'}</p> <div class="task-meta"> <div> <span><strong>Start:</strong> ${formatDate(task.startDate)}</span> <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span> </div> <div> <span><strong>Priority:</strong> ${task.priority || 'N/A'}</span> <span><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${task.status || 'N/A'}</span></span> </div> ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''} </div> <div class="task-actions"> <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button> <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button> ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`} </div>`; const editBtn = taskCard.querySelector('.edit-btn'); if (editBtn) { editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(task.id); }); } const deleteBtn = taskCard.querySelector('.delete-btn'); if (deleteBtn) { deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); }); } const completeOrReopenBtn = taskCard.querySelector('.complete-btn, .reopen-btn'); if (completeOrReopenBtn) { completeOrReopenBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTaskStatus(task.id); }); } taskListDiv.appendChild(taskCard); }); };
                const showModal = () => { if (!taskModal) return; taskModal.style.display = 'block'; document.body.style.overflow = 'hidden'; };
                const hideModal = () => { if (!taskModal) return; taskModal.style.display = 'none'; if (taskForm) taskForm.reset(); if (taskIdInput) taskIdInput.value = ''; if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; document.body.style.overflow = ''; };
                const openAddModal = () => { hideModal(); if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; if (taskStatusSelect) taskStatusSelect.value = "Pending"; if (taskPrioritySelect) taskPrioritySelect.value = "Medium"; showModal(); if (taskNameInput) taskNameInput.focus(); };
                const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task || !taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect) { console.error("Cannot open edit: elements missing."); return; }; hideModal(); if (modalTitle) modalTitle.textContent = "Edit Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Update Task"; taskIdInput.value = task.id; taskNameInput.value = task.name; taskDescriptionInput.value = task.description || ''; taskLinksInput.value = task.links || ''; taskAssignedBySelect.value = task.assignedBy; taskAssignedToSelect.value = task.assignedTo; taskStartDateInput.value = task.startDate || ''; taskDueDateInput.value = task.dueDate || ''; taskPrioritySelect.value = task.priority; taskStatusSelect.value = task.status; showModal(); taskNameInput.focus(); };
                const handleFormSubmit = (event) => { event.preventDefault(); if (!taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect) { console.error("Submit error: form elements missing."); alert("An error occurred."); return; } const taskId = taskIdInput.value ? parseInt(taskIdInput.value) : Date.now(); const currentTask = tasks.find(t => t.id === taskId); const newStatus = taskStatusSelect.value; let completionDate = currentTask?.completionDate || null; if (newStatus === 'Completed') { if (!taskIdInput.value || (currentTask && currentTask.status !== 'Completed')) { completionDate = getCurrentDate(); } } else { completionDate = null; } const startDate = taskStartDateInput.value; const dueDate = taskDueDateInput.value; if (startDate && dueDate && new Date(dueDate) < new Date(startDate)) { alert("Due Date cannot be before Start Date."); taskDueDateInput.focus(); return; } const taskData = { id: taskId, name: taskNameInput.value.trim(), description: taskDescriptionInput.value.trim(), links: taskLinksInput.value.trim(), assignedBy: taskAssignedBySelect.value, assignedTo: taskAssignedToSelect.value, startDate: startDate || null, dueDate: dueDate || null, priority: taskPrioritySelect.value, status: newStatus, completionDate: completionDate }; if (!taskData.name) { alert("Task Name is required."); taskNameInput.focus(); return; } if (taskIdInput.value) { const index = tasks.findIndex(task => task.id === taskData.id); if (index > -1) { tasks[index] = taskData; } else { console.warn(`Task ${taskData.id} not found for edit.`); tasks.push(taskData); } } else { tasks.push(taskData); } saveTasks(); renderTasks(); hideModal(); };
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); if (confirm(`Delete task: "${taskToDelete?.name || id}"?`)) { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); } };
                const toggleTaskStatus = (id) => { tasks = tasks.map(task => { if (task.id === id) { if (task.status === 'Completed') { return { ...task, status: 'Pending', completionDate: null }; } else { return { ...task, status: 'Completed', completionDate: getCurrentDate() }; } } return task; }); saveTasks(); renderTasks(); };
                addTaskBtn.addEventListener('click', openAddModal);
                closeModalBtn.addEventListener('click', hideModal);
                if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
                taskForm.addEventListener('submit', handleFormSubmit);
                 const handleOutsideClick = (event) => { if (event.target === taskModal) { hideModal(); } };
                 const handleEscapeKey = (event) => { if (event.key === 'Escape' && taskModal && taskModal.style.display === 'block') { hideModal(); } };
                taskModal.addEventListener('click', handleOutsideClick);
                document.addEventListener('keydown', handleEscapeKey);
                boundCloseOnOutsideClick = handleOutsideClick; boundCloseOnEscape = handleEscapeKey;
                if (searchInput) searchInput.addEventListener('input', renderTasks);
                if (filterStatusSelect) filterStatusSelect.addEventListener('change', renderTasks);
                if (filterPrioritySelect) filterPrioritySelect.addEventListener('change', renderTasks);
                if (filterAssignedToSelect) filterAssignedToSelect.addEventListener('change', renderTasks);
                loadTasks();
                const cleanup = () => { console.log("Cleaning Task Management..."); addTaskBtn?.removeEventListener('click', openAddModal); closeModalBtn?.removeEventListener('click', hideModal); cancelBtn?.removeEventListener('click', hideModal); taskForm?.removeEventListener('submit', handleFormSubmit); taskModal?.removeEventListener('click', boundCloseOnOutsideClick); document.removeEventListener('keydown', boundCloseOnEscape); searchInput?.removeEventListener('input', renderTasks); filterStatusSelect?.removeEventListener('change', renderTasks); filterPrioritySelect?.removeEventListener('change', renderTasks); filterAssignedToSelect?.removeEventListener('change', renderTasks); document.body.style.overflow = ''; console.log("Task Management cleanup complete."); };
                 return { cleanup };
            }
            // --- END OF PASTED JS LOGIC ---
        </script>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            // REVERTED: Select sections within the .content-area wrapper
            const contentAreaDiv = document.querySelector('.content-area'); // Get the main wrapper
            const contentSections = contentAreaDiv ? contentAreaDiv.querySelectorAll(':scope > .content-section') : []; // Select direct children with .content-section

            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            // Placeholder elements are now found within featureSectionsContainer as needed by loadFeatureContent
            let featurePlaceholder, featureTitleEl, featureDescEl, featureLoadingEl, featureErrorEl;

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModal = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModal = document.getElementById('projectModal'); // NEW: Project Modal
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button


            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let currentFeatureCleanup = null; // Stores the cleanup function for the loaded feature
            let MOCK_PROJECTS_DATA = []; // To store projects data


            // --- Mock Data ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [ // Renamed to avoid conflict
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            const MOCK_TASKS = [
                { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
            ];

            // --- Initialization ---
            function initDashboard() {
                // Simulate loading current user (using the first mock user)
                currentUser = { ...MOCK_USERS[0] }; // Use a copy
                console.log("Initializing dashboard for:", currentUser.name);

                applyStoredPreferences(); // Apply theme, contrast etc. *before* other UI updates
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Navigate based on URL hash first
                startDynamicUpdates(); // Start intervals for data refresh
                setupResponsiveSidebar();
            }

            // --- UI Updates ---
            function updateUserUI() {
                if (!currentUser) return;

                // Top Nav User Menu
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.initials;
                 if (currentUser.avatar) {
                    document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                    document.getElementById('userAvatar').textContent = ''; // Clear initials if avatar exists
                } else {
                    document.getElementById('userAvatar').style.backgroundImage = 'none';
                    document.getElementById('userAvatar').textContent = currentUser.initials;
                }

                // Welcome Section
                document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userInfoName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) {
                    document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                     document.getElementById('profileAvatar').textContent = '';
                } else {
                    document.getElementById('profileAvatar').style.backgroundImage = 'none';
                    document.getElementById('profileAvatar').textContent = currentUser.initials;
                }

                // User Role Title
                const roleTitle = document.getElementById('userInfoRoleTitle');
                roleTitle.textContent = formatRole(currentUser.role);
                roleTitle.className = `user-info-title role-${currentUser.role}`; // Apply role class

                // Profile Page Elements
                updateProfileForm();
                profileAvatarLarge.textContent = currentUser.initials;
                if (currentUser.avatar) {
                    profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                     profileAvatarLarge.textContent = '';
                } else {
                    profileAvatarLarge.style.backgroundImage = 'none';
                    profileAvatarLarge.textContent = currentUser.initials;
                }
                // Update Account panel email display
                if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;


                // Admin specific elements
                const teamSettingsTab = document.getElementById('teamSettingsTab');
                const dangerZoneTab = document.getElementById('dangerZoneTab');
                 if (currentUser.role === 'admin') {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; // Use flex for tabs
                    if (dangerZoneTab) dangerZoneTab.style.display = 'flex';
                } else {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'none';
                     if (dangerZoneTab) dangerZoneTab.style.display = 'none';
                     // Hide team panel if not admin and trying to access it directly
                     if (currentFeature === 'settings' && currentSettingsTab === 'team') {
                         activateSettingsTab('preferences'); // Default to preferences
                     }
                     if (currentFeature === 'settings' && currentSettingsTab === 'danger') {
                         activateSettingsTab('preferences');
                     }
                }

                // Update 2FA UI based on current user status
                update2FA_UI();
                if (userPhoneNumberForSms) { // Check if element exists
                     userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
                }
            }

            function updateProfileForm() {
                if (!currentUser) return;
                const nameParts = currentUser.name.split(' ');
                firstNameInput.value = nameParts[0] || '';
                lastNameInput.value = nameParts.slice(1).join(' ') || '';
                fullNameDisplay.value = currentUser.name; // Update readonly full name
                jobTitleInput.value = currentUser.title || '';
                emailDisplay.value = currentUser.email || '';
                phoneInput.value = currentUser.phone || '';
                departmentInput.value = currentUser.department || '';
            }

            function formatRole(role) {
                if (!role) return 'Member';
                return role.charAt(0).toUpperCase() + role.slice(1); // Capitalize first letter
            }

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() {
                // Theme
                const storedTheme = localStorage.getItem('theme') || 'system'; // Default to system
                setTheme(storedTheme);

                // Contrast
                const storedContrast = localStorage.getItem('highContrast') === 'true';
                setContrast(storedContrast);
                if (highContrastToggle) highContrastToggle.checked = storedContrast;

                // Language
                const storedLang = localStorage.getItem('language') || 'en';
                if (languageSelect) languageSelect.value = storedLang;
                applyLanguage(storedLang);

                 // Region/Timezone (Just set the dropdown)
                 const storedRegion = localStorage.getItem('region') || 'utc';
                 if (regionSelect) regionSelect.value = storedRegion;

                // Date/Time Format
                const storedTimeFormat = localStorage.getItem('timeFormat') || '12h';
                const storedDateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                if (timeFormatSelect) timeFormatSelect.value = storedTimeFormat;
                if (dateFormatSelect) dateFormatSelect.value = storedDateFormat;
                applyDateTimeFormat(storedTimeFormat, storedDateFormat);

                 // Toast Notifications
                const storedToastPref = localStorage.getItem('showToasts');
                // Default to true if not set
                showToasts = storedToastPref === null ? true : (storedToastPref === 'true');
                if (toastToggle) toastToggle.checked = showToasts;

                // Sound Notifications
                const storedSoundPref = localStorage.getItem('playSounds');
                playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true');
                if (soundToggle) soundToggle.checked = playSounds;

            }

            function setTheme(theme) {
                 console.log("Setting theme:", theme);
                 document.body.classList.remove('light-theme', 'dark-theme'); // Remove existing theme classes

                 if (theme === 'system') {
                    // Use matchMedia to detect system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.classList.add(prefersDark ? 'dark-theme' : 'light-theme');
                    console.log("System prefers dark:", prefersDark);
                 } else {
                     document.body.classList.add(`${theme}-theme`);
                 }

                 // Update selection state in UI
                 themeOptions.forEach(option => {
                     option.classList.toggle('selected', option.dataset.theme === theme);
                 });

                 localStorage.setItem('theme', theme); // Save preference
            }

            function setContrast(enabled) {
                 console.log("Setting high contrast:", enabled);
                 document.body.classList.toggle('high-contrast', enabled);
                 localStorage.setItem('highContrast', enabled);
            }

             function applyLanguage(lang) {
                 console.log("Applying language:", lang);
                 // --- Simulation ---
                 document.documentElement.lang = lang; // Set HTML lang attribute

                 if (lang === 'ar') {
                     document.body.dir = 'rtl'; // Basic RTL support
                     if (document.getElementById('welcomeName')) document.getElementById('welcomeName').textContent = "مستخدم"; // Example
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "لوحة التحكم";
                     if (document.querySelector('[data-feature="projects"] span')) document.querySelector('[data-feature="projects"] span').textContent = "المشاريع";
                     if (document.querySelector('[data-feature="team-members-view"] span')) document.querySelector('[data-feature="team-members-view"] span').textContent = "أعضاء الفريق";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "الإعدادات";
                     if (document.querySelector('[data-feature="file-sharing"] span')) document.querySelector('[data-feature="file-sharing"] span').textContent = "مشاركة الملفات";
                 } else {
                     document.body.dir = 'ltr';
                      if (document.getElementById('welcomeName') && currentUser) document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "Dashboard";
                     if (document.querySelector('[data-feature="projects"] span')) document.querySelector('[data-feature="projects"] span').textContent = "Projects";
                     if (document.querySelector('[data-feature="team-members-view"] span')) document.querySelector('[data-feature="team-members-view"] span').textContent = "Team Members";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "Settings";
                     if (document.querySelector('[data-feature="file-sharing"] span')) document.querySelector('[data-feature="file-sharing"] span').textContent = "File Sharing";
                 }
                 localStorage.setItem('language', lang);
                 // --- End Simulation ---
             }

             function applyDateTimeFormat(timeFormat, dateFormat) {
                console.log("Applying DateTime Format:", timeFormat, dateFormat);
                localStorage.setItem('timeFormat', timeFormat);
                localStorage.setItem('dateFormat', dateFormat);
                // Re-render any visible dates/times if needed
                if (currentFeature === 'dashboard' && activityList?.children.length > 0 && activities.length > 0) { loadRecentActivities(showingAllActivities); }
                if (currentFeature === 'dashboard' && notifications.length > 0) { renderNotifications(); }
                 if (currentFeature === 'employee-scheduling') {
                     const scheduleTableBody = document.getElementById('scheduleTableBody');
                     if (scheduleTableBody) { renderSchedule(currentScheduleWeekOffset); }
                 }
                 if (currentFeature === 'projects') { // Re-render projects if visible
                    const container = document.getElementById('featureSectionsContainer'); // Get the main container
                     if(container && container.classList.contains('projects-feature')) { // Check if projects feature is active
                        renderProjects(container); // Pass container to render function
                     }
                 }
             }

             function applyToastPreference(enabled) {
                 console.log("Applying toast preference:", enabled);
                 showToasts = enabled;
                 localStorage.setItem('showToasts', enabled);
             }

             function applySoundPreference(enabled) {
                 console.log("Applying sound preference:", enabled);
                 playSounds = enabled;
                 localStorage.setItem('playSounds', enabled);
             }


            // --- Navigation & Content Loading ---
            // REVERTED to original structure logic
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));

                // --- Cleanup previous feature ---
                document.body.classList.remove('file-sharing-active'); // Remove class on any navigation
                removeTaskManagementStyles();
                removeTeamMembersStyles();
                removeProjectsStyles();
                if (typeof currentFeatureCleanup === 'function') {
                    currentFeatureCleanup();
                    currentFeatureCleanup = null;
                }
                // --- End Cleanup ---

                currentFeature = featureId;

                // Update Menu Items
                menuItems.forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                });

                // Hide all direct content sections within .content-area
                if (contentAreaDiv) {
                    contentAreaDiv.querySelectorAll(':scope > .content-section').forEach(section => {
                        section.classList.remove('active');
                        // section.style.display = 'none'; // Let the .active class handle display
                    });
                } else {
                    console.error("'.content-area' wrapper not found!");
                    return;
                }

                // Show the correct section
                let targetSection = null;

                if (featureId === 'dashboard') {
                    targetSection = dashboardContent;
                    backButton.style.display = 'none';
                } else if (featureId === 'profile') {
                    targetSection = profileContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    updateProfileForm();
                } else if (featureId === 'settings') {
                    targetSection = settingsContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    currentSettingsTab = settingsTab || (currentUser.role === 'admin' ? 'preferences' : 'preferences');
                    if (currentUser.role !== 'admin' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) {
                        currentSettingsTab = 'preferences';
                    }
                    activateSettingsTab(currentSettingsTab);
                    update2FA_UI();
                } else {
                    // Handle other features - load into feature container
                    targetSection = featureSectionsContainer;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    loadFeatureContent(featureId); // Handles content/iframe loading and placeholder
                }

                // Activate the target section
                if (targetSection) {
                    targetSection.classList.add('active');
                    // targetSection.style.display = 'block'; // Let CSS handle display via .active
                }

                // Add body class if file sharing is active (AFTER showing the container)
                if (featureId === 'file-sharing') {
                    document.body.classList.add('file-sharing-active');
                }

                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                    if(closeSidebar) closeSidebar.style.display = 'none';
                }
                // Close user dropdown if open
                userDropdown.classList.remove('active');
                userDropdownOpen = false;

                if (!skipHistory) {
                    updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null);
                }
            }

            function activateSettingsTab(tabId) {
                console.log(`Activating settings tab: ${tabId}`);
                currentSettingsTab = tabId; // Update state
                if (settingsContent) { // Check if settingsContent exists
                    settingsContent.querySelectorAll('.settings-tab').forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId));
                    settingsContent.querySelectorAll('.settings-panel').forEach(panel => panel.classList.toggle('active', panel.id === `${tabId}Panel`));
                    if (tabId === 'team' && currentUser.role === 'admin') { loadTeamMembers(); } // Load team members if applicable
                     if (tabId === 'security') { update2FA_UI(); }
                     if (tabId === 'account' && accountEmailDisplay) { accountEmailDisplay.value = currentUser.email; }
                }
            }

             // REVISED FUNCTION loadFeatureContent
             function loadFeatureContent(featureId) {
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';

                 // Clear previous content FIRST, then add placeholder structure
                 featureSectionsContainer.innerHTML = `
                    <div class="placeholder-content" id="featurePlaceholder" style="display: flex;"> <!-- Removed content-area from placeholder -->
                         <h2 id="featureTitle"></h2>
                         <p id="featureDescription"></p>
                         <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                         <div class="error-message" style="display: none;"> Failed to load content. </div>
                    </div>`;
                 // Function to re-select placeholder elements
                 const getPlaceholderElements = () => {
                    featurePlaceholder = featureSectionsContainer.querySelector('#featurePlaceholder');
                    if(featurePlaceholder){
                        featureTitleEl = featurePlaceholder.querySelector('#featureTitle');
                        featureDescEl = featurePlaceholder.querySelector('#featureDescription');
                        featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
                        featureErrorEl = featurePlaceholder.querySelector('.error-message');
                    }
                 };
                 getPlaceholderElements(); // Initial selection

                 // Show loading state in the placeholder
                 if (featureTitleEl) featureTitleEl.textContent = '';
                 if (featureDescEl) featureDescEl.textContent = '';
                 if (featureLoadingEl) featureLoadingEl.style.display = 'block';
                 if (featureErrorEl) featureErrorEl.style.display = 'none';

                 console.log(`Loading content for: ${featureName} (${featureId})`);

                 // Apply feature-specific class to the container (for CSS styling like iframe container)
                 featureSectionsContainer.className = `content-section ${featureId}-feature`; // Keep content-section base

                 setTimeout(() => {
                     try {
                         // --- Feature Loading Logic ---

                         // --- File Sharing Logic ---
                         if (featureId === 'file-sharing') {
                             console.log("Loading file-sharing via iframe...");
                             // Remove placeholder content
                             if(featurePlaceholder) featurePlaceholder.remove();

                             const iframe = document.createElement('iframe');
                             iframe.id = 'fileShareIframe';
                             iframe.src = 'filesharing.html'; // <<< ASSUMES IT'S IN THE SAME FOLDER
                             // Styles are applied via CSS rules added earlier
                             featureSectionsContainer.appendChild(iframe);
                             currentFeatureCleanup = null; // No specific JS cleanup for iframe content
                             console.log("Iframe added for file sharing.");
                         }
                         // --- Other Feature Loading ---
                         else if (featureId === 'team-members-view') {
                             if(featurePlaceholder) featurePlaceholder.remove();
                             // Add padding class specifically for this feature
                             featureSectionsContainer.classList.add('content-area-padding');
                             featureSectionsContainer.innerHTML = getTeamMembersHTML();
                             const initResult = initializeTeamMembersFeature(featureSectionsContainer);
                             currentFeatureCleanup = initResult?.cleanup;
                         } else if (featureId === 'projects') {
                            if(featurePlaceholder) featurePlaceholder.remove();
                            // Add padding class specifically for this feature
                            featureSectionsContainer.classList.add('content-area-padding');
                            featureSectionsContainer.innerHTML = getProjectsHTML();
                             const initResult = initializeProjectsFeature(featureSectionsContainer);
                             currentFeatureCleanup = initResult?.cleanup;
                         } else if (featureId === 'employee-scheduling') {
                             if(featurePlaceholder) featurePlaceholder.remove();
                            // Add padding class specifically for this feature
                            featureSectionsContainer.classList.add('content-area-padding');
                             featureSectionsContainer.innerHTML = getEmployeeScheduleHTML();
                             initializeEmployeeScheduleLogic();
                             currentFeatureCleanup = null;
                         } else if (featureId === 'task-management') {
                             if(featurePlaceholder) featurePlaceholder.remove();
                            // Add padding class specifically for this feature
                            featureSectionsContainer.classList.add('content-area-padding');
                             loadTaskManagementFeature(); // Manages its own content/cleanup
                         } else {
                             // Default placeholder for unimplemented features
                             if (featureLoadingEl) featureLoadingEl.style.display = 'none';
                             if (featureTitleEl) featureTitleEl.textContent = featureName;
                             if (featureDescEl) featureDescEl.textContent = `Content for ${featureName} would be loaded here.`;
                             // Ensure placeholder has padding
                             if(featurePlaceholder) featurePlaceholder.classList.add('content-area-padding');
                         }

                     } catch (error) {
                         console.error(`Error loading feature ${featureId}:`, error);
                         if (featureLoadingEl) featureLoadingEl.style.display = 'none';
                         // Re-insert placeholder on error, ensure it has padding
                         featureSectionsContainer.innerHTML = `
                             <div class="placeholder-content content-area-padding" id="featurePlaceholder" style="display: flex;">
                                 <h2 id="featureTitle">Error</h2>
                                 <p id="featureDescription">Failed to load ${featureName}.</p>
                                 <div class="loading-indicator" style="display: none;"></div>
                                 <div class="error-message" style="display: block;">${error.message}</div>
                            </div>`;
                     }
                 }, 300); // Simulate loading delay
             }


            function updateBrowserHistory(featureId, settingsTab = null) {
                let hash = `#${featureId}`;
                if (featureId === 'settings' && settingsTab) {
                    hash += `-${settingsTab}`;
                }
                if (window.location.hash !== hash) {
                    window.history.pushState({ feature: featureId, tab: settingsTab }, '', hash);
                }
            }

            function handleInitialNavigation() {
                const hash = window.location.hash.substring(1);
                console.log(`Handling navigation for hash: ${hash}`);
                let featureId = 'dashboard';
                let settingsTab = null;

                if (hash) {
                    if (hash.startsWith('settings-')) {
                        const parts = hash.split('-');
                        featureId = parts[0];
                        settingsTab = parts[1];
                    } else {
                        const knownFeature = Array.from(menuItems).some(item => item.getAttribute('data-feature') === hash);
                        if (knownFeature) { featureId = hash; }
                    }
                }
                setActiveFeature(featureId, settingsTab, true); // Skip history update on initial load
            }

            window.addEventListener('popstate', function(event) {
                console.log("Popstate event:", event.state, window.location.hash);
                handleInitialNavigation();
            });


            // --- Data Loading & Simulation ---
            function loadInitialData() {
                loadDashboardStats();
                loadRecentActivities();
                loadNotifications();
                loadMockProjects(); // Load project data into state
                if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') { loadTeamMembers(); }
            }

             function loadMockProjects() {
                 MOCK_PROJECTS_DATA = [
                    { id: "alpha001", name: "Project Alpha", status: "in-progress", participants: "Alice B.|Bob K.|Charlie M.", img: "https://images.unsplash.com/photo-1517048676732-d65bc937f952?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 65, startDate: "2023-08-15", updatedDate: "2024-03-10", editable: true },
                    { id: "web002", name: "Website Redesign", status: "completed", participants: "David L.|Eva G.", img: "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 100, startDate: "2023-05-01", updatedDate: "2024-01-20", editable: false },
                    { id: "mobile003", name: "Mobile App V2", status: "active", participants: "Frank H.|Grace P.|Heidi R.|Ian S.", img: "https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 20, startDate: "2024-02-20", updatedDate: "2024-03-05", editable: true },
                    { id: "mktg004", name: "Q4 Marketing Plan", status: "pending", participants: "Marketing Team", img: "https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 0, startDate: "2024-09-01", updatedDate: "2024-03-12", editable: true },
                    { id: "infra005", name: "Server Migration", status: "in-progress", participants: "Admin Team|Mohamed Elmenisy", img: "https://images.unsplash.com/photo-1580894742597-87bc8789db3d?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 85, startDate: "2024-01-10", updatedDate: "2024-03-15", editable: true }
                ];
                console.log("Mock projects loaded into MOCK_PROJECTS_DATA");
            }

            function loadDashboardStats() {
                 console.log("Loading dashboard stats...");
                 setTimeout(() => {
                     const teamMembersCount = MOCK_USERS.length;
                     const tasksCompleted = MOCK_TASKS.filter(t => t.status === 'Completed').length + Math.floor(Math.random() * 50);
                     const activeProjects = MOCK_PROJECTS_DATA.filter(p => p.status === 'active' || p.status === 'in-progress').length; // Count active & in-progress
                     const upcomingDeadlines = Math.floor(Math.random() * 10);
                     updateStatCard('teamMembersCount', 'Team Members', 'fas fa-users', teamMembersCount, Math.random() * 10 - 5);
                     updateStatCard('tasksCompleted', 'Tasks Completed', 'fas fa-check-circle', tasksCompleted, Math.random() * 20);
                     updateStatCard('activeProjects', 'Active Projects', 'fas fa-project-diagram', activeProjects, Math.random() * 5 - 2);
                     updateStatCard('upcomingDeadlines', 'Upcoming Deadlines', 'fas fa-calendar-times', upcomingDeadlines, Math.random() * 15 - 10);
                 }, 300);
            }

            function updateStatCard(id, title, iconClass, value, trendPercent) {
                 const cardIndex = ['teamMembersCount', 'tasksCompleted', 'activeProjects', 'upcomingDeadlines'].indexOf(id);
                 if (cardIndex === -1 || !statsSection || !statsSection.children[cardIndex]) return;
                 const card = statsSection.children[cardIndex];
                 let trendClass = 'trend-neutral'; let trendIcon = 'fas fa-minus';
                 if (trendPercent > 1) { trendClass = 'trend-up'; trendIcon = 'fas fa-arrow-up'; }
                 else if (trendPercent < -1) { trendClass = 'trend-down'; trendIcon = 'fas fa-arrow-down'; }
                 card.innerHTML = `
                    <div class="stat-title"><i class="${iconClass}"></i>${title}</div>
                    <div class="stat-value">
                        <span>${value}</span>
                        <span class="stat-trend ${trendClass}">
                            <i class="${trendIcon}"></i> ${trendPercent !== 0 ? Math.abs(trendPercent).toFixed(0) + '%' : ''}
                        </span>
                    </div>`;
            }

            function loadRecentActivities(showAll = false) {
                console.log("Loading recent activities...");
                if (activities.length === 0) {
                    const now = Date.now();
                    activities = generateMockActivities(15, now);
                }
                showingAllActivities = showAll;
                const activitiesToDisplay = showAll ? activities : activities.slice(0, maxActivitiesToShow);
                if (!activityList) return; // Guard clause
                activityList.innerHTML = '';
                if (activitiesToDisplay.length === 0) {
                    activityList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>';
                    if(deleteAllActivity) deleteAllActivity.style.display = 'none';
                    if(viewAllActivity) viewAllActivity.style.display = 'none';
                    return;
                }
                activitiesToDisplay.forEach((activity, index) => {
                    const li = document.createElement('li'); li.classList.add('activity-item'); li.dataset.id = activity.id;
                    if (activity.isNew) { li.classList.add('new-activity'); setTimeout(() => { activity.isNew = false; const currentLi = activityList.querySelector(`[data-id='${activity.id}']`); if (currentLi) currentLi.classList.remove('new-activity'); }, 2500); }
                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon}"></i></div>
                        <div class="activity-content"> <div class="activity-message">${activity.message}</div> <div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div> </div>
                        <div class="activity-actions"> <i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i> </div>`;
                    activityList.appendChild(li);
                });
                 if(deleteAllActivity) deleteAllActivity.style.display = activities.length > 0 ? 'inline-block' : 'none';
                 if(viewAllActivity) {
                     viewAllActivity.textContent = showAll ? 'Show Less' : 'Show All';
                     viewAllActivity.style.display = activities.length > maxActivitiesToShow ? 'inline-block' : 'none';
                 }
            }

            function loadNotifications() {
                 console.log("Loading notifications...");
                 if (notifications.length === 0) { const now = Date.now(); notifications = generateMockNotifications(8, now); }
                 renderNotifications();
            }

            function renderNotifications() {
                 if (!notificationsBody) return; // Guard clause
                 notificationsBody.innerHTML = ''; const unreadCount = notifications.filter(n => n.unread).length;
                 if (notifications.length === 0) {
                     if (noNotificationsMessage) {
                         noNotificationsMessage.textContent = 'You have no notifications.';
                         noNotificationsMessage.style.display = 'block';
                     }
                     if (notificationBadge) {
                         notificationBadge.style.display = 'none';
                         notificationBadge.textContent = '0';
                     }
                     if(markAllReadBtn) markAllReadBtn.disabled = true;
                     if(deleteAllNotificationsBtn) deleteAllNotificationsBtn.disabled = true;
                     return;
                 }
                 if(noNotificationsMessage) noNotificationsMessage.style.display = 'none';
                 if(markAllReadBtn) markAllReadBtn.disabled = unreadCount === 0;
                 if(deleteAllNotificationsBtn) deleteAllNotificationsBtn.disabled = false;

                 notifications.forEach(notification => {
                     const div = document.createElement('div'); div.classList.add('notification-list-item'); div.dataset.id = notification.id; if (notification.unread) { div.classList.add('unread'); }
                     div.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div>
                        <div class="notification-content"> <div class="notification-message">${notification.message}</div> <div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div> </div>
                        <i class="fas fa-times delete-notification" title="Delete Notification"></i>`;
                    notificationsBody.appendChild(div);
                 });
                 if (notificationBadge) {
                     notificationBadge.textContent = unreadCount;
                     notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                 }
            }

             function loadTeamMembers(container) {
                 const teamListContainer = container ? container.querySelector('.team-list-display') : document.getElementById('teamList');
                 if (!teamListContainer) return;

                 console.log("Loading team members...");
                 teamListContainer.innerHTML = '<p style="color: var(--gray);">Loading...</p>'; // Loading indicator

                 setTimeout(() => {
                     teamListContainer.innerHTML = ''; // Clear loading
                     if (MOCK_USERS.length === 0) {
                         teamListContainer.innerHTML = '<p style="color: var(--gray);">No team members found.</p>';
                         return;
                     }
                     MOCK_USERS.forEach(member => {
                         const card = document.createElement('div');
                         const isFeatureView = container && container.closest('#featureSectionsContainer');
                         card.classList.add(isFeatureView ? 'team-member-card' : 'team-member-card'); // Use correct class

                         card.dataset.id = member.id;
                         card.dataset.name = member.name;
                         card.dataset.role = member.role;
                         card.dataset.email = member.email;

                         const avatarStyle = member.avatar ? `background-image: url('${member.avatar}')` : '';
                         const avatarContent = member.avatar ? '' : member.initials;

                         if (isFeatureView) { // Feature view (grid card)
                             card.innerHTML = `
                                <div class="member-info">
                                    <h4 class="member-name">${member.name}</h4>
                                    <p class="member-email">${member.email}</p>
                                    <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                                </div>
                             `;
                         } else { // Settings view (list item)
                             card.innerHTML = `
                                <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                                <div class="member-details">
                                    <div class="member-name">${member.name}</div>
                                    <div class="member-email">${member.email}</div>
                                </div>
                                <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                                ${currentUser.role === 'admin' && currentUser.id !== member.id ? `
                                <div class="member-actions">
                                    <button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                ` : '<div class="member-actions" style="width: 70px;">&nbsp;</div>'}
                             `;
                         }
                         teamListContainer.appendChild(card);
                     });
                 }, 300);
             }


            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() {
                if (activityIntervalId) clearInterval(activityIntervalId);
                activityIntervalId = setInterval(() => {
                    const newActivity = generateMockActivities(1, Date.now())[0]; newActivity.isNew = true;
                    activities.unshift(newActivity); if (activities.length > 50) activities.pop();
                    if (currentFeature === 'dashboard') { loadRecentActivities(showingAllActivities); }
                    showToast(`New Activity: ${newActivity.message.substring(0, 30)}...`);
                }, Math.random() * 10000 + 10000);

                 if (notificationIntervalId) clearInterval(notificationIntervalId);
                 notificationIntervalId = setInterval(() => {
                    const newNotification = generateMockNotifications(1, Date.now())[0]; newNotification.unread = true;
                    notifications.unshift(newNotification); if (notifications.length > 30) notifications.pop();
                    renderNotifications(); playNotificationSound();
                 }, Math.random() * 20000 + 20000);

                 if (statsIntervalId) clearInterval(statsIntervalId);
                 statsIntervalId = setInterval(loadDashboardStats, 30000);

                 if (welcomeBgIntervalId) clearInterval(welcomeBgIntervalId);
                 welcomeBgIntervalId = setInterval(changeWelcomeBackground, 15000);
            }

            function changeWelcomeBackground() {
                const backgrounds = ['--welcome-bg-1', '--welcome-bg-2', '--welcome-bg-3'];
                const currentBgVar = getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim();
                let currentIndex = backgrounds.indexOf(currentBgVar); if (currentIndex === -1) currentIndex = 0;
                const nextIndex = (currentIndex + 1) % backgrounds.length;
                document.documentElement.style.setProperty('--welcome-bg-current', `var(${backgrounds[nextIndex]})`);
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                 if (sidebarToggle) { sidebarToggle.addEventListener('click', () => { sidebar.classList.add('active'); mainContent.classList.add('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'block'; }); }
                 if (closeSidebar) { closeSidebar.addEventListener('click', () => { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); closeSidebar.style.display = 'none'; }); }
                 document.addEventListener('click', (event) => { if (window.innerWidth <= 992 && sidebar.classList.contains('active')) { const isClickInsideSidebar = sidebar.contains(event.target); const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target); if (!isClickInsideSidebar && !isClickOnToggler) { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } } });
                menuItems.forEach(item => item.addEventListener('click', function(e) { e.preventDefault(); const featureId = this.getAttribute('data-feature'); setActiveFeature(featureId); }));
                document.body.addEventListener('click', function(e) { const target = e.target; if (target.closest('.settings-tab') && !target.closest('.settings-tab.active')) { const tabId = target.closest('.settings-tab').getAttribute('data-tab'); activateSettingsTab(tabId); updateBrowserHistory('settings', tabId); } else if (target.closest('.settings-link') && target.closest('.settings-link').dataset.tabTarget) { e.preventDefault(); const tabId = target.closest('.settings-link').dataset.tabTarget; setActiveFeature('settings', tabId); } });
                if (backButton) { backButton.addEventListener('click', function() { setActiveFeature('dashboard'); }); }
                if (userProfileContainer) { userProfileContainer.addEventListener('click', function(e) { if (e.target.closest('.dropdown-item')) { const feature = e.target.closest('.dropdown-item').getAttribute('data-feature'); if (feature) { setActiveFeature(feature); } return; } userDropdownOpen = !userDropdownOpen; if(userDropdown) userDropdown.classList.toggle('active', userDropdownOpen); }); }
                 document.addEventListener('click', function(event) { if (userProfileContainer && !userProfileContainer.contains(event.target) && userDropdownOpen) { if(userDropdown) userDropdown.classList.remove('active'); userDropdownOpen = false; } });
                 if (searchInput) { searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch); }
                 document.addEventListener('click', (event) => { if (searchInput && searchResultsContainer && !searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) { searchResultsContainer.classList.remove('active'); } });
                 if (searchResultsContainer) { searchResultsContainer.addEventListener('click', (event) => { const targetItem = event.target.closest('.search-result-item'); if (targetItem && targetItem.dataset.feature) { const featureId = targetItem.dataset.feature; const itemId = targetItem.dataset.id; console.log(`Search result: Feature=${featureId}, ID=${itemId}`); setActiveFeature(featureId); searchResultsContainer.classList.remove('active'); if(searchInput) searchInput.value = ''; } }); }
                 if (notificationIcon) { notificationIcon.addEventListener('click', () => { if(notificationsModal) notificationsModal.classList.add('active'); }); }
                 if (closeNotifications) { closeNotifications.addEventListener('click', () => { if(notificationsModal) notificationsModal.classList.remove('active'); }); }
                 if (notificationsModal) { notificationsModal.addEventListener('click', (event) => { if (event.target === notificationsModal) { notificationsModal.classList.remove('active'); } }); }
                 if (notificationsBody) { notificationsBody.addEventListener('click', (event) => { const target = event.target; const notificationItem = target.closest('.notification-list-item'); const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null; if (target.classList.contains('delete-notification') && notificationId) { showConfirmModal('Delete Notification', 'Are you sure?', () => { notifications = notifications.filter(n => n.id !== notificationId); renderNotifications(); showToast('Notification deleted.', 'success'); }); } else if (notificationItem && notificationId) { const notification = notifications.find(n => n.id === notificationId); if (notification && notification.unread) { notification.unread = false; renderNotifications(); } console.log(`Clicked notification ${notificationId}`); } }); }
                 if (markAllReadBtn) { markAllReadBtn.addEventListener('click', markAllNotificationsAsRead); }
                 if (deleteAllNotificationsBtn) { deleteAllNotificationsBtn.addEventListener('click', () => { if (notifications.length === 0) return; showConfirmModal('Delete All Notifications', 'Are you sure?', () => { notifications = []; renderNotifications(); showToast('All notifications deleted.', 'success'); }); }); }
                 if (activityList) { activityList.addEventListener('click', (event) => { const target = event.target; if (target.classList.contains('delete-activity')) { const activityItem = target.closest('.activity-item'); const activityId = activityItem ? parseInt(activityItem.dataset.id) : null; if (activityId) { activities = activities.filter(a => a.id !== activityId); loadRecentActivities(showingAllActivities); showToast('Activity deleted.'); } } }); }
                 if (viewAllActivity) { viewAllActivity.addEventListener('click', () => { loadRecentActivities(!showingAllActivities); }); }
                 if (deleteAllActivity) { deleteAllActivity.addEventListener('click', () => { if (activities.length === 0) return; showConfirmModal('Delete All Activities', 'Are you sure?', () => { activities = []; loadRecentActivities(false); showToast('All activities deleted.'); }); }); }
                 if (profileAvatarLarge) { profileAvatarLarge.addEventListener('click', () => { if(profileAvatarInput) profileAvatarInput.click(); }); }
                 if (profileAvatarInput) { profileAvatarInput.addEventListener('change', handleAvatarUpload); }
                 if (profileForm) { profileForm.addEventListener('submit', handleProfileSave); }
                 if (cancelProfileBtn) { cancelProfileBtn.addEventListener('click', handleProfileCancel); }
                 if (firstNameInput) { firstNameInput.addEventListener('input', updateFullNameDisplay); }
                 if (lastNameInput) { lastNameInput.addEventListener('input', updateFullNameDisplay); }
                 if (logoutLink) { logoutLink.addEventListener('click', handleLogout); }

                 // Team Management Actions (Settings Panel)
                 const teamListContainer = document.getElementById('teamList');
                 if (teamListContainer) {
                    teamListContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        const memberCard = target.closest('.team-member-card'); // Look for the card in settings list
                        const memberId = memberCard ? parseInt(memberCard.dataset.id) : null;
                        if (!memberId || memberId === currentUser.id) return;
                        if (target.closest('.edit-member')) { openMemberModal(memberId); } // Use generic modal
                        else if (target.closest('.remove-member')) { handleRemoveMember(memberId); }
                    });
                 }
                 // Use generic member modal/form for Add/Edit
                 if (memberForm) { memberForm.addEventListener('submit', handleSaveMember); }
                 if(memberModal) {
                     memberModal.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => memberModal.classList.remove('active')); });
                     memberModal.addEventListener('click', (event) => { if (event.target === memberModal) { memberModal.classList.remove('active'); } });
                 }
                 const inviteMemberForm = document.getElementById('inviteMemberForm');
                 if (inviteMemberForm) { inviteMemberForm.addEventListener('submit', handleInviteMember); }

                // Project Modal Listeners
                 if (projectForm) { projectForm.addEventListener('submit', handleSaveProject); }
                 if (projectModal) {
                     projectModal.querySelectorAll('[data-close-modal]').forEach(btn => {
                         btn.addEventListener('click', () => projectModal.classList.remove('active'));
                     });
                     projectModal.addEventListener('click', (event) => {
                         if (event.target === projectModal) { projectModal.classList.remove('active'); }
                     });
                 }


                 // Settings Controls Listeners
                 themeOptions.forEach(option => { option.addEventListener('click', () => setTheme(option.dataset.theme)); });
                 if (highContrastToggle) { highContrastToggle.addEventListener('change', (e) => setContrast(e.target.checked)); }
                 if (languageSelect) { languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value)); }
                 if (regionSelect) { regionSelect.addEventListener('change', (e) => localStorage.setItem('region', e.target.value)); }
                 if (timeFormatSelect || dateFormatSelect) { const applyDateTimeListener = () => { applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value); }; if (timeFormatSelect) timeFormatSelect.addEventListener('change', applyDateTimeListener); if (dateFormatSelect) dateFormatSelect.addEventListener('change', applyDateTimeListener); }
                 if (toastToggle) { toastToggle.addEventListener('change', (e) => applyToastPreference(e.target.checked)); }
                 if (soundToggle) { soundToggle.addEventListener('change', (e) => applySoundPreference(e.target.checked)); }
                if(savePreferencesBtn) savePreferencesBtn.addEventListener('click', handleSavePreferences);
                if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
                if(saveAccountSettingsBtn) saveAccountSettingsBtn.addEventListener('click', handleSaveAccountSettings);
                if(saveSessionSettingsBtn) saveSessionSettingsBtn.addEventListener('click', handleSaveSessionSettings);
                if(saveNotificationSettingsBtn) saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);
                 if (enable2faBtn) enable2faBtn.addEventListener('click', handleEnable2FA);
                 if (setupAuthAppBtn) setupAuthAppBtn.addEventListener('click', showAuthAppSetup);
                 if (setupSmsBtn) setupSmsBtn.addEventListener('click', showSmsSetup);
                 if (verifyAuthCodeBtn) verifyAuthCodeBtn.addEventListener('click', handleVerifyAuthCode);
                 if (sendSmsCodeBtn) sendSmsCodeBtn.addEventListener('click', handleSendSmsCode);
                 if (verifySmsCodeBtn) verifySmsCodeBtn.addEventListener('click', handleVerifySmsCode);
                 if (disable2faBtn) disable2faBtn.addEventListener('click', handleDisable2FA);
                 if(logoutAllDevicesBtn) logoutAllDevicesBtn.addEventListener('click', handleLogoutAllDevices);
                 if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);
                 if (cancelConfirmBtn) cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                 if (confirmBtn) confirmBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmModal(); });
            }

            // --- Specific Feature Logic ---
            function setupResponsiveSidebar() { /* Handled in setupEventListeners */ }

            // --- Search Logic ---
            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (!searchResultsContainer) return; // Guard clause
                searchResultsContainer.innerHTML = '';
                if (searchTerm.length < 2) { searchResultsContainer.classList.remove('active'); return; }
                console.log(`Searching for: ${searchTerm}`); const results = [];
                MOCK_USERS.forEach(user => { if (user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) { results.push({ type: 'User', id: user.id, name: user.name, description: user.email, icon: 'fa-user', feature: 'team-members-view' }); } });
                MOCK_PROJECTS_DATA.forEach(project => { if (project.name.toLowerCase().includes(searchTerm)) { results.push({ type: 'Project', id: project.id, name: project.name, description: `Status: ${project.status}`, icon: 'fa-briefcase', feature: 'projects' }); } });
                MOCK_TASKS.forEach(task => { if (task.name.toLowerCase().includes(searchTerm)) { const projectName = MOCK_PROJECTS.find(p => p.id === task.project)?.name || 'Unknown Project'; results.push({ type: 'Task', id: task.id, name: task.name, description: `Project: ${projectName} | Status: ${task.status}`, icon: 'fa-tasks', feature: 'task-management' }); } });
                menuItems.forEach(item => { const featureName = item.querySelector('span')?.textContent; const featureId = item.getAttribute('data-feature'); if (featureName && featureId && featureName.toLowerCase().includes(searchTerm)) { if (!results.some(r => r.feature === featureId && r.type !== 'User' && r.type !== 'Project' && r.type !== 'Task')) { results.push({ type: 'Feature', id: null, name: featureName, description: 'Navigate to section', icon: item.querySelector('i')?.className.split(' ')[1] || 'fa-compass', feature: featureId }); } } });
                if (results.length > 0) { results.slice(0, 10).forEach(result => { const item = document.createElement('div'); item.classList.add('search-result-item'); item.dataset.feature = result.feature; if (result.id) item.dataset.id = result.id; item.innerHTML = `<i class="fas ${result.icon}"></i> <div> <strong>${result.name}</strong> <small>(${result.type})</small><br> <span style="font-size: 0.8em; color: var(--gray);">${result.description}</span> </div>`; searchResultsContainer.appendChild(item); }); searchResultsContainer.classList.add('active'); }
                else { searchResultsContainer.innerHTML = '<div class="search-result-item" style="text-align: center; color: var(--gray); cursor: default;">No results found.</div>'; searchResultsContainer.classList.add('active'); }
            }

            // --- Profile Logic ---
            function handleAvatarUpload(event) { const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { const imageUrl = e.target.result; profileAvatarLarge.style.backgroundImage = `url(${imageUrl})`; profileAvatarLarge.textContent = ''; document.getElementById('userAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('userAvatar').textContent = ''; document.getElementById('profileAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('profileAvatar').textContent = ''; currentUser.avatar = imageUrl; showToast('Avatar preview updated. Save changes to persist.'); }; reader.readAsDataURL(file); } else if (file) { showToast('Please select a valid image file.', 'error'); } }
            function updateFullNameDisplay() { fullNameDisplay.value = `${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim(); }
             function handleProfileSave(event) { event.preventDefault(); console.log("Saving profile..."); showConfirmModal( 'Save Profile Changes', 'Are you sure?', () => { console.log("Profile save confirmed."); const saveButtonText = saveProfileBtn.querySelector('.btn-text'); const spinner = saveProfileBtn.querySelector('.spinner'); saveProfileBtn.disabled = true; if (saveButtonText) saveButtonText.textContent = 'Saving...'; if (spinner) spinner.style.display = 'inline-block'; setTimeout(() => { currentUser.name = fullNameDisplay.value; currentUser.title = jobTitleInput.value; currentUser.phone = phoneInput.value; currentUser.department = departmentInput.value; if (!currentUser.avatar) { const nameParts = currentUser.name.split(' '); currentUser.initials = (nameParts[0]?.[0] || '') + (nameParts[1]?.[0] || ''); } if (userPhoneNumberForSms) userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available'; updateUserUI(); saveProfileBtn.disabled = false; if (saveButtonText) saveButtonText.textContent = 'Save Changes'; if (spinner) spinner.style.display = 'none'; showSuccessMessage('Profile updated successfully!'); }, 1000); }, 'btn-primary' ); }
             function handleProfileCancel() { showConfirmModal( 'Cancel Changes', 'Discard changes?', () => { updateProfileForm(); showToast('Changes discarded.'); }, 'btn-warning' ); }

             // --- Settings Save Logic ---
             function handleSavePreferences() { showConfirmModal('Save Preferences', 'Save Appearance/Localization?', () => { console.log("Saving Preferences..."); showToast('Preferences saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveAccountSettings() { showConfirmModal('Save Account Settings', 'Save notification settings?', () => { console.log("Saving Account Settings..."); const enableNotifications = document.getElementById('accountNotificationsToggle').checked; console.log("Account Notifications Enabled:", enableNotifications); showToast('Account settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleChangePassword(event) {
                 event.preventDefault(); // Prevent default form submission
                  showConfirmModal('Change Password', 'Are you sure you want to attempt to change your password?', () => {
                     console.log("Changing password...");
                     const currentPass = document.getElementById('currentPassword').value;
                     const newPass = document.getElementById('newPassword').value;
                     const confirmPass = document.getElementById('confirmPassword').value;
                     if (!currentPass || !newPass || !confirmPass) { showToast('Please fill in all password fields.', 'error'); return; }
                     if (newPass !== confirmPass) { showToast('New passwords do not match.', 'error'); return; }
                     if (newPass.length < 8) { showToast('New password must be at least 8 characters.', 'error'); return; }
                     showToast('Attempting password change...', 'info');
                     setTimeout(() => {
                         const success = Math.random() > 0.2;
                         if (success) {
                             showSuccessMessage('Password changed successfully!');
                             document.getElementById('currentPassword').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('confirmPassword').value = '';
                         } else { showToast('Password change failed. Incorrect current password?', 'error'); }
                     }, 1500);
                  }, 'btn-danger');
             }
             function handleSaveSessionSettings() { showConfirmModal('Save Session Settings', 'Save session duration and idle timeout?', () => { console.log("Saving Session Settings..."); const sessionDuration = document.getElementById('sessionDuration').value; const idleTimeout = document.getElementById('idleTimeout').value; console.log("Session Duration:", sessionDuration, "Idle Timeout:", idleTimeout); showToast('Session settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveNotificationSettings() { showConfirmModal('Save Notification Settings', 'Save notification delivery/types?', () => { console.log("Saving Notification Settings..."); const emailEnabled = document.getElementById('emailNotificationsToggle').checked; const inAppEnabled = document.getElementById('inAppNotificationsToggle').checked; const pushEnabled = document.getElementById('pushNotificationsToggle').checked; const selectedTypes = Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb => cb.value); console.log("Email:", emailEnabled, "InApp:", inAppEnabled, "Types:", selectedTypes); showToast('Notification settings saved (simulated).', 'success'); }, 'btn-primary'); }

             // --- 2FA Logic (Simulation) ---
             function update2FA_UI() { if (!currentUser || !twoFaStatusIndicator || !twoFaStatusText || !twoFaSetupSection || !twoFaManagementSection) return; const isEnabled = currentUser.twoFaEnabled; twoFaStatusIndicator.className = `status-indicator ${isEnabled ? 'enabled' : 'disabled'}`; twoFaStatusText.textContent = `2FA is currently ${isEnabled ? 'Enabled' : 'Disabled'}`; twoFaSetupSection.style.display = isEnabled ? 'none' : 'block'; twoFaManagementSection.style.display = isEnabled ? 'block' : 'none'; if (twoFaSetupOptions) twoFaSetupOptions.style.display = 'none'; if (authAppSetup) authAppSetup.style.display = 'none'; if (smsSetup) smsSetup.style.display = 'none'; }
             function handleEnable2FA() { if(twoFaSetupOptions) twoFaSetupOptions.style.display = 'block'; if(enable2faBtn) enable2faBtn.style.display = 'none'; }
             function showAuthAppSetup() { if(authAppSetup) authAppSetup.style.display = 'block'; if(smsSetup) smsSetup.style.display = 'none'; }
             function showSmsSetup() { if(authAppSetup) authAppSetup.style.display = 'none'; if(smsSetup) smsSetup.style.display = 'block'; if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none'; }
             function handleVerifyAuthCode() { const authCodeInput = document.getElementById('authCode'); if (!authCodeInput) return; const code = authCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { showToast('Verifying code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); showToast('2FA enabled via Authenticator App!', 'success'); }, 1000); } else { showToast('Invalid code. Please enter 6 digits.', 'error'); } }
             function handleSendSmsCode() { showToast('Sending SMS code...', 'info'); setTimeout(() => { showToast('SMS code sent (simulated).', 'success'); if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'block'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'inline-flex'; }, 1500); }
             function handleVerifySmsCode() { const smsCodeInput = document.getElementById('smsCode'); if (!smsCodeInput) return; const code = smsCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { showToast('Verifying SMS code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); showToast('2FA enabled via SMS!', 'success'); }, 1000); } else { showToast('Invalid SMS code. Please enter 6 digits.', 'error'); } }
             function handleDisable2FA() { showConfirmModal('Disable 2FA', 'Are you sure? This reduces security.', () => { currentUser.twoFaEnabled = false; update2FA_UI(); if(enable2faBtn) enable2faBtn.style.display = 'inline-flex'; showToast('2FA disabled.'); }, 'btn-danger'); }

             // --- Danger Zone Logic ---
             function handleLogoutAllDevices() { showConfirmModal('Logout From All Devices', 'End all other sessions?', () => { showToast('Logging out from other devices...', 'info'); setTimeout(() => { showSuccessMessage('Logged out from other devices.'); }, 1500); }, 'btn-warning'); }
             function handleDeleteAccount() { showConfirmModal('Delete Account', 'IRREVERSIBLE! Delete all data?', () => { showConfirmModal('Final Confirmation', 'Are you absolutely sure?', () => { console.warn("Account Deletion Confirmed (Simulated)"); showToast('Deleting account...', 'error'); setTimeout(() => { alert("Account Deleted (Simulated). Redirecting..."); handleLogout(new Event('click')); }, 2000); }, 'btn-danger'); }, 'btn-danger'); }

             // --- Notification Logic ---
             function markAllNotificationsAsRead() { if (notifications.some(n => n.unread)) { notifications.forEach(n => n.unread = false); renderNotifications(); showToast('All notifications marked as read.'); } }
             function playNotificationSound() { if (!playSounds) return; try { if (notificationSound && notificationSound.paused) { notificationSound.play().catch(e => console.warn("Audio play failed:", e)); } } catch(e) { console.warn("Audio error:", e); } }

             // --- Logout Logic ---
             function handleLogout(event) { event.preventDefault(); showConfirmModal( 'Confirm Logout', 'Are you sure?', () => { console.log("Logging out..."); clearInterval(activityIntervalId); clearInterval(notificationIntervalId); clearInterval(statsIntervalId); clearInterval(welcomeBgIntervalId); showSuccessMessage('Logout successful! Redirecting...'); setTimeout(() => { window.location.href = 'login.html'; // Redirect to login page (adjust if needed)
                 }, 1500); }, 'btn-danger' ); }

            // --- Team Management Logic ---
             function handleInviteMember(event) {
                 event.preventDefault();
                 const emailInput = document.getElementById('inviteEmail');
                 const roleInput = document.getElementById('inviteRole');
                 const email = emailInput ? emailInput.value : null;
                 const role = roleInput ? roleInput.value : null;
                 const inviteButton = event.target.querySelector('button[type="submit"]');

                 if (!email || !role || !/\S+@\S+\.\S+/.test(email)) { // Basic email validation
                     showToast('Please provide a valid email and role.', 'error');
                     return;
                 }
                 // Check if email already exists
                 if (MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                     showToast('A user with this email already exists.', 'error');
                     return;
                 }

                 console.log(`Inviting ${email} as ${role}`);
                 if (inviteButton) { inviteButton.disabled = true; inviteButton.innerHTML = '<span class="spinner"></span> Sending...'; }

                 setTimeout(() => {
                    const newId = MOCK_USERS.length > 0 ? Math.max(...MOCK_USERS.map(u => u.id)) + 1 : 1;
                    const nameParts = email.split('@')[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1));
                    const newUser = { id: newId, name: nameParts.join(' ') || 'New User', email: email, title: formatRole(role), department: 'Pending', phone: '', avatar: '', initials: (nameParts[0]?.[0] || 'N') + (nameParts[1]?.[0] || 'U'), role: role, twoFaEnabled: false };
                    MOCK_USERS.push(newUser);
                    loadTeamMembers(); // Refresh list in settings
                    loadDashboardStats();
                     // Refresh team members view if active
                     if(currentFeature === 'team-members-view') {
                         loadTeamMembers(featureSectionsContainer);
                     }
                    showToast(`Invitation sent to ${email}.`, 'success');
                    if (inviteButton) { inviteButton.disabled = false; inviteButton.innerHTML = 'Invite'; }
                    if (emailInput) emailInput.value = ''; if (roleInput) roleInput.value = 'member';
                 }, 1000);
             }

            function openMemberModal(memberId = null) { // Handles both Add and Edit
                 const isEditing = memberId !== null;
                 const member = isEditing ? MOCK_USERS.find(u => u.id === memberId) : null;

                 if (isEditing && !member) {
                     showToast("Error: Member not found.", "error");
                     return;
                 }
                 if (!memberForm || !memberModal || !memberModalTitle || !saveMemberBtn) return; // Guard clause

                 memberForm.reset(); // Clear previous data
                 document.getElementById('memberId').value = isEditing ? member.id : '';
                 document.getElementById('memberEmail').readOnly = isEditing; // Can't edit email

                 if (isEditing) {
                     const nameParts = member.name.split(' ');
                     document.getElementById('memberFirstName').value = nameParts[0] || '';
                     document.getElementById('memberLastName').value = nameParts.slice(1).join(' ') || '';
                     document.getElementById('memberEmail').value = member.email;
                     document.getElementById('memberRole').value = member.role;
                     document.getElementById('memberTitle').value = member.title || '';
                     document.getElementById('memberDepartment').value = member.department || '';
                     memberModalTitle.textContent = `Edit ${member.name}`;
                     saveMemberBtn.textContent = 'Save Changes';
                 } else {
                     // Add Mode - Fields are cleared by reset()
                     memberModalTitle.textContent = `Add New Member`;
                     saveMemberBtn.textContent = 'Add Member';
                     document.getElementById('memberEmail').readOnly = false; // Allow email input for new member
                 }

                 memberModal.classList.add('active');
             }

             function handleSaveMember(event) {
                event.preventDefault();
                const memberId = document.getElementById('memberId').value ? parseInt(document.getElementById('memberId').value) : null;
                const firstName = document.getElementById('memberFirstName').value.trim();
                const lastName = document.getElementById('memberLastName').value.trim();
                const email = document.getElementById('memberEmail').value.trim();
                const role = document.getElementById('memberRole').value;
                const title = document.getElementById('memberTitle').value.trim();
                const department = document.getElementById('memberDepartment').value.trim();
                const isEditing = memberId !== null;

                if (!firstName || !lastName || !email || !role) {
                    showToast('Please fill in First Name, Last Name, Email, and Role.', 'error');
                    return;
                }
                 if (!/\S+@\S+\.\S+/.test(email)) {
                     showToast('Please enter a valid email address.', 'error');
                    return;
                 }
                 // Prevent duplicate email on add (unless editing self)
                 if (!isEditing && MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                     showToast('A user with this email already exists.', 'error');
                     return;
                 }

                const memberData = {
                    id: isEditing ? memberId : Date.now(), // Generate new ID if adding
                    name: `${firstName} ${lastName}`,
                    email: email,
                    role: role,
                    title: title,
                    department: department,
                    // Preserve existing phone/avatar/2fa or set defaults
                    phone: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.phone || '' : '',
                    avatar: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.avatar || '' : '',
                    initials: (firstName?.[0] || '') + (lastName?.[0] || ''),
                    twoFaEnabled: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.twoFaEnabled || false : false
                };
                 // Update initials if name changed and no avatar
                 if (!memberData.avatar) {
                     memberData.initials = (firstName?.[0] || '') + (lastName?.[0] || '');
                 }


                console.log(`${isEditing ? 'Saving' : 'Adding'} member:`, memberData);
                showToast(`${isEditing ? 'Saving' : 'Adding'} member...`, 'info');

                setTimeout(() => {
                    if (isEditing) {
                        const memberIndex = MOCK_USERS.findIndex(u => u.id === memberId);
                        if (memberIndex > -1) {
                            MOCK_USERS[memberIndex] = memberData;
                            // If editing current user, update the main UI immediately
                            if (currentUser && currentUser.id === memberId) {
                                currentUser = { ...memberData }; // Update global current user state
                                updateUserUI();
                            }
                         } else { console.error("Error finding member to edit"); }
                    } else {
                        MOCK_USERS.push(memberData);
                    }

                    loadTeamMembers(); // Refresh settings list
                     if(currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } // Refresh feature view if active
                    loadDashboardStats(); // Update team count
                    showToast(`Member ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
                    if(memberModal) memberModal.classList.remove('active');
                 }, 1000);
             }

            function handleRemoveMember(memberId) {
                 const memberToRemove = MOCK_USERS.find(u => u.id === memberId);
                 showConfirmModal('Remove Team Member', `Are you sure you want to remove ${memberToRemove?.name || 'this member'}?`, () => {
                    showToast(`Removing ${memberToRemove?.name || 'member'}...`, 'info');
                    setTimeout(() => {
                        MOCK_USERS = MOCK_USERS.filter(u => u.id !== memberId);
                        loadTeamMembers(); // Refresh settings list
                         if(currentFeature === 'team-members-view') { loadTeamMembers(featureSectionsContainer); } // Refresh feature view
                        loadDashboardStats(); // Update dashboard stats
                         if (currentFeature === 'employee-scheduling') { const scheduleTableBody = document.getElementById('scheduleTableBody'); if(scheduleTableBody) { renderSchedule(currentScheduleWeekOffset); } }
                        showToast('Team member removed.', 'success');
                    }, 500);
                 }, 'btn-danger');
            }

            // --- Employee Scheduling (Existing + Refinements) ---
             function getEmployeeScheduleHTML() {
                 // Added content-area class to wrappers
                 return `
                    <div class="schedule-page-header section-main-header content-area">
                        <h2 class="schedule-page-title section-main-title">Employee Scheduling</h2>
                         ${currentUser.role === 'admin' ? `
                         <div class="admin-actions">
                            <button class="btn btn-primary" id="saveScheduleBtn"><i class="fas fa-save"></i> Save Schedule</button>
                             <button class="btn btn-success" id="sendRemindersBtn"><i class="fas fa-envelope"></i> Send Reminders</button>
                         </div>
                         ` : ''}
                    </div>
                    <div class="schedule-controls content-area">
                        <div class="week-nav">
                            <button class="btn btn-outline" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev</button>
                            <span id="weekDisplay" style="margin: 0 1rem; font-weight: 500;">Loading...</span>
                            <button class="btn btn-outline" id="nextWeekBtn">Next <i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="schedule-container content-area">
                        <table class="schedule-table">
                            <thead> <tr> <th>Employee</th> </tr> </thead>
                            <tbody id="scheduleTableBody"> <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td></tr> </tbody>
                        </table>
                    </div>
                    <div class="modal" id="editShiftModal">
                        <div class="modal-content">
                            <div class="modal-header"> <h3 class="modal-title" id="editShiftModalTitle">Edit Shift</h3> <button class="close-modal" data-close-modal>×</button> </div>
                            <form id="editShiftForm">
                                <input type="hidden" id="editShiftEmployeeId"> <input type="hidden" id="editShiftDayIndex"> <input type="hidden" id="editShiftWeekOffset">
                                <div class="form-group">
                                    <label for="shiftType">Shift Type</label>
                                    <select id="shiftType" class="form-control"> <option value="morning">Morning (9AM-5PM)</option> <option value="afternoon">Afternoon (12PM-8PM)</option> <option value="night">Night (8PM-4AM)</option> <option value="off">Day Off</option> <option value="sick">Sick Leave</option> <option value="vacation">Vacation</option> </select>
                                </div>
                                <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary">Save Shift</button> </div>
                            </form>
                        </div>
                    </div>`;
             }

            function initializeEmployeeScheduleLogic() {
                console.log("Initializing Employee Schedule Logic...");
                 const calculateOffsets = () => { const today = new Date(); const mayFirst2025 = new Date(2025, 4, 1); mayFirst2025.setHours(0, 0, 0, 0); const currentDayOfWeek = today.getDay(); const diffToSunday = today.getDate() - currentDayOfWeek; const startOfCurrentWeek = new Date(today); startOfCurrentWeek.setDate(diffToSunday); startOfCurrentWeek.setHours(0, 0, 0, 0); const mayFirstDayOfWeek = mayFirst2025.getDay(); const diffToMayFirstSunday = mayFirst2025.getDate() - mayFirstDayOfWeek; const startOfMayFirstWeek = new Date(mayFirst2025); startOfMayFirstWeek.setDate(diffToMayFirstSunday); startOfMayFirstWeek.setHours(0, 0, 0, 0); const msPerDay = 24 * 60 * 60 * 1000; const weeksDifference = Math.round((startOfMayFirstWeek.getTime() - startOfCurrentWeek.getTime()) / (7 * msPerDay)); console.log(`Current Week Start: ${startOfCurrentWeek.toDateString()}`); console.log(`Target Week Start: ${startOfMayFirstWeek.toDateString()}`); console.log(`Calculated offset: ${weeksDifference}`); currentScheduleWeekOffset = weeksDifference; scheduleMinWeekOffset = weeksDifference; };
                calculateOffsets();
                const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const weekDisplay = document.getElementById('weekDisplay');
                const scheduleTableBody = document.getElementById('scheduleTableBody');
                const scheduleThead = document.querySelector('.schedule-table thead tr');
                const prevWeekBtn = document.getElementById('prevWeekBtn');
                const nextWeekBtn = document.getElementById('nextWeekBtn');
                const saveScheduleBtn = document.getElementById('saveScheduleBtn');
                const sendRemindersBtn = document.getElementById('sendRemindersBtn');
                const editShiftModal = document.getElementById('editShiftModal');
                const editShiftForm = document.getElementById('editShiftForm');
                const shiftTypeSelect = document.getElementById('shiftType');
                const editShiftEmployeeIdInput = document.getElementById('editShiftEmployeeId');
                const editShiftDayIndexInput = document.getElementById('editShiftDayIndex');
                const editShiftWeekOffsetInput = document.getElementById('editShiftWeekOffset');
                const editShiftModalTitle = document.getElementById('editShiftModalTitle');

                function getWeekDates(weekOffset = 0) { const baseDate = new Date(); const startOfWeek = new Date(baseDate); const dayOfWeek = baseDate.getDay(); const diff = baseDate.getDate() - dayOfWeek; startOfWeek.setDate(diff + (weekOffset * 7)); startOfWeek.setHours(0,0,0,0); const dates = []; for (let i = 0; i < 7; i++) { const date = new Date(startOfWeek); date.setDate(startOfWeek.getDate() + i); dates.push(date); } return dates; }

                window.renderSchedule = function(weekOffset) { // Make global for refresh
                     console.log(`Rendering schedule offset: ${weekOffset}`);
                     if (isNaN(weekOffset)) { weekOffset = currentScheduleWeekOffset; }
                     const weekDates = getWeekDates(weekOffset); const start = weekDates[0]; const end = weekDates[6]; if(weekDisplay) weekDisplay.textContent = `${formatDateForDisplay(start)} - ${formatDateForDisplay(end)}`;
                     if (prevWeekBtn) { prevWeekBtn.disabled = weekOffset <= scheduleMinWeekOffset; }
                     if(scheduleThead) { scheduleThead.innerHTML = '<th>Employee</th>'; weekDates.forEach((date, index) => { scheduleThead.innerHTML += `<th><div class="day-header"><span class="day-name">${days[index]}</span><span class="day-date">${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric'})}</span></div></th>`; }); }
                     if(scheduleTableBody) { scheduleTableBody.innerHTML = ''; if (MOCK_USERS.length === 0) { scheduleTableBody.innerHTML = `<tr><td colspan="8">No employees found.</td></tr>`; return; }
                         MOCK_USERS.forEach(employee => {
                             const row = document.createElement('tr'); row.innerHTML = `<td class="employee-name">${employee.name}</td>`;
                             for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                                 const cell = document.createElement('td'); const scheduleKey = `${employee.id}-${weekOffset}-${dayIndex}`; const isWeekend = dayIndex === 5 || dayIndex === 6; let shiftType; let isEditable = currentUser.role === 'admin' && !isWeekend;
                                 if (isWeekend) { shiftType = 'off'; mockScheduleData[scheduleKey] = 'off'; cell.classList.add('weekend-cell'); }
                                 else { if (!mockScheduleData[scheduleKey]) { const shiftTypes = ['morning', 'afternoon', 'night', 'off', 'sick', 'vacation']; mockScheduleData[scheduleKey] = shiftTypes[Math.floor(Math.random() * shiftTypes.length)]; } shiftType = mockScheduleData[scheduleKey]; }
                                 const shiftDiv = document.createElement('div'); shiftDiv.classList.add('shift');
                                 if (isWeekend) { shiftDiv.classList.add('shift-weekend-off'); } else { shiftDiv.classList.add(`shift-${shiftType.replace('_', '-')}`); }
                                 shiftDiv.textContent = getShiftText(shiftType);
                                 if (isEditable) { shiftDiv.classList.add('editable'); shiftDiv.dataset.employeeId = employee.id; shiftDiv.dataset.employeeName = employee.name; shiftDiv.dataset.dayIndex = dayIndex; shiftDiv.dataset.weekOffset = weekOffset; shiftDiv.dataset.date = formatDateForDisplay(weekDates[dayIndex]); shiftDiv.title = `Edit ${employee.name}'s shift`; shiftDiv.addEventListener('click', handleEditShiftClick); }
                                 else if (isWeekend) { shiftDiv.title = "Weekend Off"; }
                                 cell.appendChild(shiftDiv); row.appendChild(cell);
                             } scheduleTableBody.appendChild(row);
                         });
                    }
                 }

                function getShiftText(type) { switch (type) { case 'morning': return '9AM-5PM'; case 'afternoon': return '12PM-8PM'; case 'night': return '8PM-4AM'; case 'off': return 'OFF'; case 'sick': return 'Sick'; case 'vacation': return 'Vacation'; default: return 'N/A'; } }
                function handleEditShiftClick(event) { const target = event.target; if (!target.classList.contains('editable')) return; const employeeId = target.dataset.employeeId; const dayIndex = target.dataset.dayIndex; const weekOffset = target.dataset.weekOffset; const employeeName = target.dataset.employeeName; const dateStr = target.dataset.date; const scheduleKey = `${employeeId}-${weekOffset}-${dayIndex}`; const currentShift = mockScheduleData[scheduleKey] || 'morning'; if (editShiftEmployeeIdInput) editShiftEmployeeIdInput.value = employeeId; if (editShiftDayIndexInput) editShiftDayIndexInput.value = dayIndex; if (editShiftWeekOffsetInput) editShiftWeekOffsetInput.value = weekOffset; if (shiftTypeSelect) shiftTypeSelect.value = currentShift; if (editShiftModalTitle) editShiftModalTitle.textContent = `Edit ${employeeName}'s Shift on ${days[dayIndex] || dateStr}`; if (editShiftModal) editShiftModal.classList.add('active'); }

                 if (prevWeekBtn) { prevWeekBtn.addEventListener('click', () => { if (currentScheduleWeekOffset > scheduleMinWeekOffset) { currentScheduleWeekOffset--; renderSchedule(currentScheduleWeekOffset); } }); }
                 if (nextWeekBtn) { nextWeekBtn.addEventListener('click', () => { currentScheduleWeekOffset++; renderSchedule(currentScheduleWeekOffset); }); }
                 if (saveScheduleBtn) { saveScheduleBtn.addEventListener('click', () => { showConfirmModal('Save Schedule', 'Save changes?', () => { saveScheduleBtn.disabled = true; saveScheduleBtn.innerHTML = '<span class="spinner"></span> Saving...'; console.log("Saving schedule...", mockScheduleData); setTimeout(() => { showToast("Schedule saved!", "success"); saveScheduleBtn.disabled = false; saveScheduleBtn.innerHTML = '<i class="fas fa-save"></i> Save Schedule'; }, 1000); }, 'btn-primary'); }); }
                 if (sendRemindersBtn) { sendRemindersBtn.addEventListener('click', handleSendReminders); }
                 if (editShiftModal) { editShiftModal.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => editShiftModal.classList.remove('active')); }); editShiftModal.addEventListener('click', (event) => { if (event.target === editShiftModal) { editShiftModal.classList.remove('active'); } }); }
                 if (editShiftForm) { editShiftForm.addEventListener('submit', (event) => { event.preventDefault(); const employeeId = editShiftEmployeeIdInput.value; const dayIndex = editShiftDayIndexInput.value; const weekOffset = editShiftWeekOffsetInput.value; const newShiftType = shiftTypeSelect.value; const scheduleKey = `${employeeId}-${weekOffset}-${dayIndex}`; mockScheduleData[scheduleKey] = newShiftType; renderSchedule(parseInt(weekOffset)); if(editShiftModal) editShiftModal.classList.remove('active'); showToast("Shift updated."); }); }
                 renderSchedule(currentScheduleWeekOffset); // Initial render
            }

             function handleSendReminders() {
                const btn = document.getElementById('sendRemindersBtn'); if (!btn) return; btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Sending...'; console.log("Sending reminders...");
                 const weekDates = getWeekDates(currentScheduleWeekOffset); const weekStart = formatDateForDisplay(weekDates[0]); const weekEnd = formatDateForDisplay(weekDates[6]); const emailSubject = `Schedule: ${weekStart} - ${weekEnd}`; const emailFooter = "\n\nRegards,\nTeam Management System"; const fullDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]; let emailsSent = 0; let emailsFailed = 0;
                 MOCK_USERS.forEach((user, index) => {
                     let userScheduleInfo = `Your schedule:\n`;
                     for (let dayIndex = 0; dayIndex < 7; dayIndex++) { const scheduleKey = `${user.id}-${currentScheduleWeekOffset}-${dayIndex}`; const shiftType = mockScheduleData[scheduleKey] || 'off'; userScheduleInfo += `- ${fullDays[dayIndex]} (${formatDateForDisplay(weekDates[dayIndex])}): ${getShiftText(shiftType)}\n`; }
                     const emailBody = `Hi ${user.name.split(' ')[0]},\n\n${userScheduleInfo}${emailFooter}`;
                     console.log(`--- Sending to: ${user.email} ---\nSubject: ${emailSubject}\nBody:\n${emailBody}\n------`);
                     const success = Math.random() > 0.1; if (success) { emailsSent++; } else { emailsFailed++; }
                 });
                 setTimeout(() => { if (emailsFailed > 0) { showToast(`Sent ${emailsSent} reminders. ${emailsFailed} failed.`, "error"); } else { showToast(`Sent ${emailsSent} reminders!`, "success"); } btn.disabled = false; btn.innerHTML = '<i class="fas fa-envelope"></i> Send Reminders'; }, 1500 + MOCK_USERS.length * 50);
             }


             // --- Task Management Feature Loading ---
             function loadTaskManagementFeature() {
                 console.log("Loading Task Management feature...");
                 const template = document.getElementById('taskManagementAssets');
                 if (!template) { console.error("Task Management template not found!"); featureSectionsContainer.innerHTML = '<p class="error-message content-area-padding">Error: Task assets missing.</p>'; return; } // Added padding class
                 // Inject Styles
                 const styleContent = template.content.querySelector('#task-management-styles');
                 if (styleContent) { const styleTag = document.createElement('style'); styleTag.id = 'injected-task-management-styles'; styleTag.textContent = styleContent.textContent; document.head.appendChild(styleTag); console.log("Task styles injected."); }
                 else { console.warn("Task styles not found in template."); }
                 // Inject HTML (Add content-area-padding wrapper)
                 const taskHTML = ` <div class="content-area-padding"> <div class="task-page-header"> <h2 class="task-page-title">Task Management</h2> </div> <div class="task-management-content"> <!-- Controls --> <div class="controls"> <button id="add-task-btn" class="btn btn-primary"><i class="fas fa-plus"></i> New Task</button> <div class="search-container"> <input type="text" id="search-input" placeholder="Search tasks..."> <i class="fas fa-search search-icon"></i> </div> <div class="filters"> <select id="filter-status"> <option value="all">Status: All</option> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> </select> <select id="filter-priority"> <option value="all">Priority: All</option> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select> <select id="filter-assigned-to"> <option value="all">Assigned To: All</option> <option value="Mohamed Elmenisy">Mohamed Elmenisy</option> <option value="Yousef">Yousef</option> <option value="Esraa Lashin">Esraa Lashin</option> <option value="Bassant Badr">Bassant Badr</option> </select> </div> </div> <!-- Task List --> <div id="task-list" class="task-list"> <p class="no-tasks">Loading tasks...</p> </div> <!-- Modal --> <div id="task-modal" class="modal"> <div class="modal-content"> <span class="close-btn">×</span> <h2 id="modal-title">Add New Task</h2> <form id="task-form"> <input type="hidden" id="task-id"> <div class="form-group"> <label for="task-name">Task Name:</label> <input type="text" id="task-name" required> </div> <div class="form-group"> <label for="task-description">Description:</label> <textarea id="task-description" rows="3"></textarea> </div> <div class="form-group"> <label for="task-links">Links:</label> <input type="text" id="task-links" placeholder="e.g., https://example.com, jira-123"> </div> <div class="form-group form-row"> <div> <label for="task-assigned-by">Assigned By:</label> <select id="task-assigned-by" required> <option value="Nada">Nada</option> <option value="Yousef">Yousef</option> <option value="Self Assigned">Self Assigned</option> </select> </div> <div> <label for="task-assigned-to">Assigned To:</label> <select id="task-assigned-to" required> <option value="Mohamed Elmenisy">Mohamed Elmenisy</option> <option value="Yousef">Yousef</option> <option value="Esraa Lashin">Esraa Lashin</option> <option value="Bassant Badr">Bassant Badr</option> </select> </div> </div> <div class="form-group form-row"> <div> <label for="task-start-date">Start Date:</label> <input type="date" id="task-start-date"> </div> <div> <label for="task-due-date">Due Date:</label> <input type="date" id="task-due-date"> </div> </div> <div class="form-group form-row"> <div> <label for="task-priority">Priority:</label> <select id="task-priority" required> <option value="Low">Low</option> <option value="Medium">Medium</option> <option value="High">High</option> </select> </div> <div> <label for="task-status">Status:</label> <select id="task-status" required> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> </select> </div> </div> <div class="form-actions"> <button type="submit" id="save-task-btn" class="btn btn-primary">Save Task</button> <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button> </div> </form> </div> </div> </div> </div> `;
                 featureSectionsContainer.innerHTML = taskHTML;
                 // Initialize JS
                 const scriptContent = template.content.querySelector('script');
                 if (scriptContent) { try { const initFunction = new Function(`${scriptContent.textContent}\n return initializeTaskManagementFeature;`)(); if (typeof initFunction === 'function') { const result = initFunction(featureSectionsContainer); currentFeatureCleanup = result?.cleanup; console.log("Task Management JS initialized."); } else { console.error("Task init function not found."); } } catch (e) { console.error("Error initializing Task script:", e); featureSectionsContainer.innerHTML = '<p class="error-message content-area-padding">Error initializing Task Management.</p>'; } } // Added padding class
                 else { console.warn("Task script not found in template."); }
             }
             function removeTaskManagementStyles() { const injectedStyle = document.getElementById('injected-task-management-styles'); if (injectedStyle) { injectedStyle.remove(); console.log("Task styles removed."); } }
             function removeTeamMembersStyles() { /* Placeholder if specific styles were injected */ }
             function removeProjectsStyles() { /* Placeholder if specific styles were injected */ }

            // --- Utility Functions ---
            function timeAgo(timestamp) { if (!(timestamp instanceof Date)) { const date = new Date(timestamp); if (isNaN(date.getTime())) return ''; timestamp = date; } const now = new Date(); const secondsPast = (now.getTime() - timestamp.getTime()) / 1000; if (secondsPast < 10) { return 'Just now'; } if (secondsPast < 60) { return parseInt(secondsPast) + 's ago'; } if (secondsPast < 3600) { return parseInt(secondsPast / 60) + 'm ago'; } if (secondsPast < 3600 * 24) { return parseInt(secondsPast / 3600) + 'h ago'; } return formatDateForDisplay(timestamp); }
            function formatDateForDisplay(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; const year = date.getFullYear(); const month = date.getMonth() + 1; const day = date.getDate(); const monthPadded = String(month).padStart(2, '0'); const dayPadded = String(day).padStart(2, '0'); const monthName = date.toLocaleDateString(undefined, { month: 'short' }); try { switch (dateFormat) { case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`; case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`; case 'Month D, YYYY': return `${monthName} ${day}, ${year}`; case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`; } } catch (e) { console.error("Error formatting date:", e); return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`; } }
            function formatFullDateTime(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const formattedDate = formatDateForDisplay(date); const timeFormat = localStorage.getItem('timeFormat') || '12h'; const options = { hour: 'numeric', minute: 'numeric', hour12: timeFormat === '12h' }; try { const formattedTime = date.toLocaleTimeString(undefined, options); return `${formattedDate}, ${formattedTime}`; } catch (e) { console.error("Error formatting time:", e); return formattedDate; } }
            function generateMockActivities(count, baseTimestampMillis) { const nowMillis = baseTimestampMillis || Date.now(); const newActivities = []; let users = MOCK_USERS.map(u => u.name.split(' ')[0]); if (users.length === 0) users.push('System'); const actions = ['updated profile', 'completed task', 'added project', 'commented on task', 'uploaded file', 'joined team']; const icons = ['fa-user-edit', 'fa-check-circle', 'fa-plus-circle', 'fa-comment', 'fa-upload', 'fa-user-plus']; const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`); const projects = MOCK_PROJECTS_DATA.map(p => `'${p.name}'`); const files = ['doc.pdf', 'img.png', 'sheet.xlsx', 'pres.pptx']; for (let i = 0; i < count; i++) { const user = users[Math.floor(Math.random() * users.length)]; const actionIndex = Math.floor(Math.random() * actions.length); let message = `${user} ${actions[actionIndex]}`; if (actions[actionIndex].includes('task') && tasks.length > 0) { message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`; } else if (actions[actionIndex].includes('project') && projects.length > 0) { message += ` ${projects[Math.floor(Math.random() * projects.length)]}`; } else if (actions[actionIndex].includes('file') && files.length > 0) { message += ` ${files[Math.floor(Math.random() * files.length)]}`; } let timestampMillis; if (count === 1) { timestampMillis = nowMillis - Math.random() * 1000 * 10; } else { timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.5 + 300000); } timestampMillis = Math.min(timestampMillis, nowMillis); newActivities.push({ id: nowMillis + i + Math.floor(Math.random()*1000), icon: icons[actionIndex], message: message, timestamp: new Date(timestampMillis), isNew: false }); } return count > 1 ? newActivities.sort((a, b) => b.timestamp - a.timestamp) : newActivities; }
            function generateMockNotifications(count, baseTimestampMillis) { const nowMillis = baseTimestampMillis || Date.now(); const newNotifications = []; const types = [ { msg: 'New task assigned:', icon: 'fa-tasks', type: 'task' }, { msg: 'Project deadline approaching:', icon: 'fa-clock', type: 'project' }, { msg: 'Mentioned you:', icon: 'fa-comment-dots', type: 'comment' }, { msg: 'System update:', icon: 'fa-info-circle', type: 'system' }, { msg: 'File shared:', icon: 'fa-file-alt', type: 'file' }, ]; const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`); const projects = MOCK_PROJECTS_DATA.map(p => `'${p.name}'`); let users = MOCK_USERS.map(u => u.name.split(' ')[0]); if (users.length === 0) users.push('System'); const files = ['report.docx', 'logo.svg', 'data.csv']; for (let i = 0; i < count; i++) { const typeInfo = types[Math.floor(Math.random() * types.length)]; let message = typeInfo.msg; if (typeInfo.type === 'task' && tasks.length > 0) message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`; else if (typeInfo.type === 'project' && projects.length > 0) message += ` ${projects[Math.floor(Math.random() * projects.length)]}`; else if (typeInfo.type === 'comment' && users.length > 0) message += ` by ${users[Math.floor(Math.random() * users.length)]}`; else if (typeInfo.type === 'file' && files.length > 0 && users.length > 0) message += ` ${files[Math.floor(Math.random() * files.length)]} by ${users[Math.floor(Math.random() * users.length)]}`; let timestampMillis; if (count === 1) { timestampMillis = nowMillis - Math.random() * 1000 * 15; } else { timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.8 + 180000); } timestampMillis = Math.min(timestampMillis, nowMillis); newNotifications.push({ id: nowMillis + i + 10000 + Math.floor(Math.random()*1000), icon: typeInfo.icon, message: message, timestamp: new Date(timestampMillis), unread: count === 1 ? true : Math.random() > 0.3 }); } return count > 1 ? newNotifications.sort((a, b) => b.timestamp - a.timestamp) : newNotifications; }
            function showConfirmModal(title, message, onConfirm, buttonClass = 'btn-danger') { if(!confirmModal || !confirmTitle || !confirmMessage || !confirmBtn) return; confirmTitle.textContent = title; confirmMessage.innerHTML = message; confirmCallback = onConfirm; confirmBtn.className = 'btn'; confirmBtn.classList.add(buttonClass); confirmModal.classList.add('active'); }
            function hideConfirmModal() { if(confirmModal) confirmModal.classList.remove('active'); confirmCallback = null; }
            function showSuccessMessage(message) { if (successMessageText) successMessageText.textContent = message; if(successMessage) successMessage.classList.add('show'); setTimeout(() => { if(successMessage) successMessage.classList.remove('show'); }, 3000); }
            function showToast(message, type = 'info') { if (!showToasts && type !== 'error') { console.log("Toast suppressed:", message); return; } if (!toastMessage) return; toastMessage.textContent = message; toastMessage.className = 'toast'; if (type === 'success') { toastMessage.classList.add('success'); } else if (type === 'error') { toastMessage.classList.add('error'); } toastMessage.classList.add('show'); setTimeout(() => { toastMessage.classList.remove('show'); }, 3000); }

            // --- START: Team Members Feature ---
             function getTeamMembersHTML() {
                 const addMemberBtnHTML = currentUser.role === 'admin' ? `<button class="btn btn-primary add-team-member-btn"><i class="fas fa-user-plus"></i> Add Member</button>` : '';
                 // Removed content-area from the wrapper here
                 return `
                 <div class="team-members-section">
                     <div class="team-members-section-header">
                        <h2>Team Members</h2>
                        ${addMemberBtnHTML}
                     </div>
                     <div class="team-content-area">
                         <div class="team-filter">
                             <input type="text" id="teamSearchInputFeature" placeholder="Search team by name, email, or role..." aria-label="Search team members">
                         </div>
                         <div class="team-members-list team-list-display" id="teamListContainerFeature">
                             <p style="color: var(--gray);">Loading team members...</p>
                         </div>
                     </div>
                 </div>
                 `;
             }

             function initializeTeamMembersFeature(container) {
                 console.log("Initializing Team Members Feature...");
                 const searchInput = container.querySelector('#teamSearchInputFeature');
                 const teamListContainer = container.querySelector('#teamListContainerFeature');
                 const addMemberBtn = container.querySelector('.add-team-member-btn');

                 let boundFilterHandler = null;
                 let boundAddMemberHandler = null;

                 function filterTeamMembers() {
                     if (!searchInput || !teamListContainer) return;
                     const filterText = searchInput.value.toLowerCase().trim();
                     const memberCards = teamListContainer.querySelectorAll('.team-member-card');

                     memberCards.forEach(card => {
                         const name = (card.dataset.name || '').toLowerCase();
                         const role = (card.dataset.role || '').toLowerCase();
                         const email = (card.dataset.email || '').toLowerCase();
                         const isMatch = name.includes(filterText) || role.includes(filterText) || email.includes(filterText);
                         card.classList.toggle('hidden-by-filter', !isMatch);
                     });
                 }

                 loadTeamMembers(container); // Load members into the feature view

                 if (searchInput) {
                     boundFilterHandler = filterTeamMembers;
                     searchInput.addEventListener('input', boundFilterHandler);
                 }
                  if (addMemberBtn) {
                     boundAddMemberHandler = () => openMemberModal(); // Open the generic Add/Edit modal
                     addMemberBtn.addEventListener('click', boundAddMemberHandler);
                 }

                 const cleanup = () => {
                     console.log("Cleaning up Team Members feature listeners...");
                     if (searchInput && boundFilterHandler) { searchInput.removeEventListener('input', boundFilterHandler); }
                      if (addMemberBtn && boundAddMemberHandler) { addMemberBtn.removeEventListener('click', boundAddMemberHandler); }
                     boundFilterHandler = null; boundAddMemberHandler = null;
                 };

                 return { cleanup };
             }
            // --- END: Team Members Feature ---


            // --- START: Projects Feature ---
             function getProjectsHTML() {
                 const addProjectBtnHTML = (currentUser.role === 'admin' || currentUser.role === 'supervisor')
                    ? `<button class="btn add-project-btn" id="addProjectBtnFeature"> <i class="fas fa-plus-circle"></i> Add Project </button>`
                    : '';
                 // Removed content-area from the wrapper here
                 return `
                 <section id="projects-section">
                     <div class="projects-header">
                         <div class="projects-title-wrapper"><h2>Projects</h2></div>
                         <div class="project-controls">
                             <input type="search" placeholder="Search Projects..." class="project-search-input" id="projectSearchInputFeature">
                             <select class="project-filter-select" id="projectFilterSelectFeature">
                                 <option value="all">All Statuses</option>
                                 <option value="active">Active</option>
                                 <option value="in-progress">In Progress</option>
                                 <option value="completed">Completed</option>
                                 <option value="pending">Pending</option>
                             </select>
                             ${addProjectBtnHTML}
                         </div>
                     </div>
                     <div class="projects-list" id="projectsListContainerFeature">
                         <p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">Loading projects...</p>
                     </div>
                 </section>
                 `;
             }

             function renderProjects(container) {
                 const projectsListContainer = container.querySelector('#projectsListContainerFeature');
                 if (!projectsListContainer) return;

                 const searchInput = container.querySelector('#projectSearchInputFeature');
                 const filterSelect = container.querySelector('#projectFilterSelectFeature');
                 const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const selectedStatus = filterSelect ? filterSelect.value : 'all';

                 projectsListContainer.innerHTML = ''; // Clear previous list

                 let projectsToDisplay = MOCK_PROJECTS_DATA.filter(project => {
                     const statusMatch = (selectedStatus === 'all' || project.status === selectedStatus);
                     const searchMatch = (
                         project.name.toLowerCase().includes(searchTerm) ||
                         (project.participants || '').toLowerCase().includes(searchTerm) ||
                         project.status.toLowerCase().includes(searchTerm)
                     );
                     return statusMatch && searchMatch;
                 });

                  if (projectsToDisplay.length === 0) {
                     projectsListContainer.innerHTML = '<p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">No projects found matching your criteria.</p>';
                     return;
                  }

                 projectsToDisplay.forEach(project => {
                     const card = document.createElement('div');
                     card.classList.add('project-card');
                     card.dataset.projectId = project.id;
                     card.dataset.status = project.status;
                     card.dataset.participants = project.participants;

                     const participantsHTML = (project.participants || '').split('|')
                        .map(p => p.trim())
                        .filter(p => p)
                        .map(p => `<span>${p}</span>`).join(' ');

                     const canEdit = project.editable !== false; // Default to true if undefined
                     const canDelete = currentUser.role === 'admin'; // Only admin can delete (example permission)

                     card.innerHTML = `
                         <div class="project-card-image" style="background-image: url('${project.img || 'placeholder.jpg'}');"></div>
                         <div class="project-card-body">
                             <h3 class="project-name">${project.name}</h3>
                              <span class="project-status status-${project.status}">${project.status.replace('-', ' ')}</span>
                              <div class="progress-bar-container" title="Progress: ${project.progress}%">
                                 <div class="progress-bar" style="width: ${project.progress}%;">${project.progress > 5 ? project.progress + '%' : ''}</div>
                             </div>
                             <div class="project-info project-participants">
                                 <i class="fas fa-users"></i>
                                 <div class="participant-list">${participantsHTML || 'N/A'}</div>
                             </div>
                             <div class="project-info project-dates">
                                 <i class="fas fa-calendar-alt"></i> Started: ${formatDateForDisplay(project.startDate)} | Updated: ${formatDateForDisplay(project.updatedDate)}
                             </div>
                             <div class="project-actions">
                                 <button class="btn btn-view" data-project-id="${project.id}"><i class="fas fa-eye"></i> View</button>
                                 <button class="btn btn-edit" data-project-id="${project.id}" ${!canEdit ? 'disabled' : ''}><i class="fas fa-pencil-alt"></i> Edit</button>
                                 <button class="btn btn-delete" data-project-id="${project.id}" ${!canDelete ? 'disabled' : ''}><i class="fas fa-trash-alt"></i> Delete</button>
                             </div>
                         </div>
                     `;
                     projectsListContainer.appendChild(card);
                 });
             }

             function handleDeleteProject(projectId) {
                 const projectToDelete = MOCK_PROJECTS_DATA.find(p => p.id === projectId);
                 if (!projectToDelete) return;

                 showConfirmModal(
                     'Confirm Project Deletion',
                     `Are you sure you want to delete project: "${projectToDelete.name}"? This action cannot be undone.`,
                     () => {
                         showToast(`Deleting project ${projectToDelete.name}...`, 'info');
                         // Simulate backend deletion
                         setTimeout(() => {
                             MOCK_PROJECTS_DATA = MOCK_PROJECTS_DATA.filter(p => p.id !== projectId);
                             // Re-render the projects list within the feature container
                             const container = document.getElementById('featureSectionsContainer');
                              if(container && container.classList.contains('projects-feature')) {
                                renderProjects(container);
                              }
                             loadDashboardStats(); // Update dashboard stats
                             showToast('Project deleted successfully!', 'success');
                         }, 500);
                     }
                 );
             }

             // NEW: Function to open the project modal (for Add/Edit)
             function openProjectModal(projectId = null) {
                 const isEditing = projectId !== null;
                 const project = isEditing ? MOCK_PROJECTS_DATA.find(p => p.id === projectId) : null;

                 if (isEditing && !project) {
                     showToast("Error: Project not found.", "error");
                     return;
                 }
                 if (!projectForm || !projectModal || !projectModalTitle || !saveProjectBtn) return; // Guard clause


                 projectForm.reset(); // Clear form
                 document.getElementById('projectId').value = isEditing ? project.id : '';

                 if (isEditing) {
                     projectModalTitle.textContent = `Edit Project: ${project.name}`;
                     saveProjectBtn.textContent = 'Save Changes';
                     document.getElementById('projectName').value = project.name;
                     document.getElementById('projectDescription').value = project.description || '';
                     document.getElementById('projectParticipantsInput').value = project.participants || '';
                     document.getElementById('projectImageInput').value = project.img || '';
                     document.getElementById('projectStartDate').value = project.startDate || '';
                     document.getElementById('projectDueDate').value = project.dueDate || '';
                     document.getElementById('projectStatus').value = project.status || 'pending';
                     document.getElementById('projectProgress').value = project.progress || 0;
                 } else {
                     projectModalTitle.textContent = 'Add New Project';
                     saveProjectBtn.textContent = 'Add Project';
                     // Defaults are handled by form reset or can be set here
                     document.getElementById('projectStatus').value = 'pending';
                     document.getElementById('projectProgress').value = 0;
                 }

                 projectModal.classList.add('active');
             }

             // NEW: Function to handle saving the project form
            function handleSaveProject(event) {
                 event.preventDefault();
                 const projectId = document.getElementById('projectId').value;
                 const isEditing = projectId !== '';

                 const projectData = {
                     id: isEditing ? projectId : `proj-${Date.now()}`, // Generate ID if new
                     name: document.getElementById('projectName').value.trim(),
                     description: document.getElementById('projectDescription').value.trim(),
                     participants: document.getElementById('projectParticipantsInput').value.trim(),
                     img: document.getElementById('projectImageInput').value.trim(),
                     startDate: document.getElementById('projectStartDate').value || null,
                     dueDate: document.getElementById('projectDueDate').value || null,
                     status: document.getElementById('projectStatus').value,
                     progress: parseInt(document.getElementById('projectProgress').value) || 0,
                     updatedDate: getCurrentDate(), // Set updated date
                     editable: true // New/edited projects are editable by default
                 };

                 if (!projectData.name) {
                     showToast('Project Name is required.', 'error');
                     return;
                 }

                 console.log(`${isEditing ? 'Saving' : 'Adding'} project:`, projectData);
                 showToast(`${isEditing ? 'Saving' : 'Adding'} project...`, 'info');

                 setTimeout(() => {
                    if (isEditing) {
                         const index = MOCK_PROJECTS_DATA.findIndex(p => p.id === projectId);
                         if (index > -1) {
                             MOCK_PROJECTS_DATA[index] = { ...MOCK_PROJECTS_DATA[index], ...projectData }; // Merge data
                         } else {
                             console.error("Error finding project to edit");
                             MOCK_PROJECTS_DATA.push(projectData); // Add if not found (fallback)
                         }
                     } else {
                         MOCK_PROJECTS_DATA.push(projectData);
                     }

                     // Re-render the projects list within the feature container
                     const container = document.getElementById('featureSectionsContainer');
                     if(container && container.classList.contains('projects-feature')) {
                         renderProjects(container);
                     }
                     loadDashboardStats(); // Update dashboard stats
                     showToast(`Project ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
                     if(projectModal) projectModal.classList.remove('active');
                 }, 500);
             }

            function initializeProjectsFeature(container) {
                 console.log("Initializing Projects Feature...");
                 const searchInput = container.querySelector('#projectSearchInputFeature');
                 const filterSelect = container.querySelector('#projectFilterSelectFeature');
                 const projectsListContainer = container.querySelector('#projectsListContainerFeature');
                 const addProjectBtn = container.querySelector('#addProjectBtnFeature');

                 let boundFilterHandler = null;
                 let boundActionHandler = null;
                 let boundAddHandler = null;

                 // Initial render
                 renderProjects(container);

                 boundFilterHandler = () => renderProjects(container);
                 boundActionHandler = (event) => {
                     const target = event.target.closest('.btn');
                     if (!target) return;

                     const projectId = target.dataset.projectId;
                     if (!projectId) return;

                     if (target.classList.contains('btn-view')) {
                         alert(`Placeholder: View details for Project ID ${projectId}`);
                     } else if (target.classList.contains('btn-edit')) {
                          openProjectModal(projectId); // NEW: Open edit modal
                     } else if (target.classList.contains('btn-delete')) {
                         handleDeleteProject(projectId);
                     }
                 };
                  boundAddHandler = () => {
                     openProjectModal(); // NEW: Open add modal (no ID passed)
                 };


                 // Add event listeners
                 if (searchInput) searchInput.addEventListener('input', boundFilterHandler);
                 if (filterSelect) filterSelect.addEventListener('change', boundFilterHandler);
                 if (projectsListContainer) projectsListContainer.addEventListener('click', boundActionHandler);
                 if (addProjectBtn) addProjectBtn.addEventListener('click', boundAddHandler);


                 // Cleanup function
                 const cleanup = () => {
                     console.log("Cleaning up Projects feature listeners...");
                     if (searchInput && boundFilterHandler) searchInput.removeEventListener('input', boundFilterHandler);
                     if (filterSelect && boundFilterHandler) filterSelect.removeEventListener('change', boundFilterHandler);
                     if (projectsListContainer && boundActionHandler) projectsListContainer.removeEventListener('click', boundActionHandler);
                     if (addProjectBtn && boundAddHandler) addProjectBtn.removeEventListener('click', boundAddHandler);
                     boundFilterHandler = null;
                     boundActionHandler = null;
                     boundAddHandler = null;
                      // No specific styles injected for this feature
                 };
                 return { cleanup };
             }
             // --- END: Projects Feature ---


            // --- Start Application ---
            initDashboard();
        });
    </script>
</body>
</html>

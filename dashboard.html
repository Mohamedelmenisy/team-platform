<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->

    <!-- Bootstrap 5 CSS (Required by File Sharing as well) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- SweetAlert2 CSS (Required by File Sharing) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #0d6efd; /* Bootstrap Blue - Use dashboard's primary */
            --primary-dark: #0a58ca; /* Darker blue */
            --primary-light: #cfe2ff; /* Lighter blue */
            --secondary: #6c757d; /* Bootstrap Gray */
            --danger: #dc3545; /* Bootstrap Red */
            --warning: #ffc107; /* Bootstrap Yellow */
            --success: #198754; /* Bootstrap Green */
            --info: #0dcaf0; /* Bootstrap Cyan */
            --dark: #212529;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8f9fa; /* Use Bootstrap light */
            --gray: #6c757d; /* Bootstrap gray */
            --light-gray: #dee2e6; /* Bootstrap light gray */
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a; /* Custom sidebar color */
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --team-manager: var(--danger); /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--sidebar-bg), #172554); /* Use sidebar color in gradient */
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */

            /* High Contrast Variables (Initial basic setup) */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable - Aliased to existing variables */
            --text-color: var(--dark);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6; /* Light gray for weekend cells */
             --schedule-weekend-text: #9ca3af; /* Muted text for weekend OFF */
             /* Light Mode Shift Colors */
             --shift-morning-bg: #dbeafe;
             --shift-morning-text: #1e40af;
             --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe;
             --shift-afternoon-text: #0c4a6e;
             --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe;
             --shift-night-text: #5b21b6;
             --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4;
             --shift-off-text: #166534;
             --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2;
             --shift-sick-text: #991b1b;
             --shift-sick-border: #fecdd3;
             --shift-vacation-bg: #ffedd5;
             --shift-vacation-text: #9a3412;
             --shift-vacation-border: #fed7aa;

            /* --- Team Members Feature Specific Variables (mapped from original) --- */
            --feature-team-bg: var(--white); /* Section background - use white for light mode */
            --feature-team-card-bg: var(--white);            /* Card background */
            --feature-team-border-color: var(--light-gray);       /* Border color */
            --feature-team-shadow-color: rgba(0, 0, 0, 0.05); /* Reduced shadow intensity */
            --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); /* Subtle shadow increase on hover */
            --feature-team-text-primary: var(--dark);       /* Names */
            --feature-team-text-secondary: var(--gray);     /* Emails */
            --feature-team-title-text: var(--dark);         /* Title text */
            --feature-team-title-bg: var(--light);     /* Soft Gray title background - use light */
            --feature-team-admin-color: var(--danger);        /* Slightly softer deep red */
            --feature-team-supervisor-color: var(--primary);   /* Professional blue */
            --feature-team-senior-color: var(--success);       /* Professional green */
            --feature-team-member-color: var(--gray);       /* Professional gray */
            --feature-team-card-border-radius: 12px;    /* Slightly more rounded */
            --feature-team-section-padding: 1.5rem; /* Match dashboard spacious padding */
            --feature-team-card-padding: 1.25rem;          /* Increased card padding slightly */
            --feature-team-grid-gap: 1.5rem;              /* Match dashboard grid gap */

            /* --- Projects Feature Specific Variables (mapped from original) --- */
            --feature-projects-body-bg: var(--primary-light);
            --feature-projects-card-bg: var(--white);
            --feature-projects-text-color: var(--text-color);
            --feature-projects-text-muted: var(--gray);
            --feature-projects-heading-color: var(--primary-dark);
            --feature-projects-border-color: var(--light-gray);
            --feature-projects-shadow-color: rgba(0, 0, 0, 0.08);
            --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12);
            --feature-projects-input-bg: var(--white);
            --feature-projects-input-border: var(--light-gray);
            --feature-projects-input-focus-border: var(--primary);
            --feature-projects-input-focus-shadow: rgba(var(--bs-primary-rgb), 0.1); /* Use BS primary RGB */
            --feature-projects-primary-color: var(--primary);
            --feature-projects-primary-hover: var(--primary-dark);
            --feature-projects-primary-text: var(--white);
            --feature-projects-success-bg: #d1e7dd; /* Bootstrap success bg */
            --feature-projects-success-text: #0f5132; /* Bootstrap success text */
            --feature-projects-success-progress: var(--success);
            --feature-projects-warning-bg: #fff3cd; /* Bootstrap warning bg */
            --feature-projects-warning-text: #664d03; /* Bootstrap warning text */
            --feature-projects-warning-progress: var(--warning);
            --feature-projects-warning-btn-text: var(--dark); /* Dark text for yellow button */
            --feature-projects-info-bg: #cff4fc; /* Bootstrap info bg */
            --feature-projects-info-text: #055160; /* Bootstrap info text */
            --feature-projects-info-progress: var(--info); /* Use info color */
            --feature-projects-secondary-bg: var(--light-gray);
            --feature-projects-secondary-text: var(--gray);
            --feature-projects-secondary-progress: var(--gray);
            --feature-projects-danger-color: var(--danger);
            --feature-projects-danger-hover: #bb2d3b; /* Bootstrap danger hover */
            --feature-projects-danger-text: var(--white);
            --feature-projects-progress-bar-bg: var(--light-gray);
            --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5); /* Use dashboard modal */

             /* File Sharing - Map to Dashboard Vars */
             --feature-file-sharing-hover-bg: #eef4ff; /* Light blue for hover */
             --feature-file-sharing-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%); /* Keep original gradient for now */

        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: #f0f2f5; /* Match file sharing slightly off-white */ color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode (Existing + Refined) --- */
        body.high-contrast {
             --hc-text: #000000;
             --hc-background: #ffffff;
             --hc-primary: #0000ff;
             --hc-secondary: #008000;
             --hc-link: #0000ee;
             --hc-border: #000000;
             --dark: var(--hc-text);
             --light: var(--hc-background);
             --gray: var(--hc-text);
             --light-gray: var(--hc-border);
             --white: var(--hc-background);
             --primary: var(--hc-primary);
             --primary-dark: var(--hc-primary);
             --primary-light: #e0e0ff;
             --secondary: var(--hc-secondary);
             --success: var(--hc-secondary);
             --warning: #ffa500; /* Orange */
             --danger: #ff0000; /* Red */
             --info: #00ffff; /* Cyan */
             --sidebar-bg: var(--hc-background);
             --sidebar-text: var(--hc-text);
             --sidebar-hover: #e0e0e0;
             --sidebar-active: #c0c0c0;
             --sidebar-divider: var(--hc-border);
             --text-color: var(--hc-text);
             --schedule-weekend-bg: #dddddd; /* HC weekend BG */
             --schedule-weekend-text: var(--hc-text); /* HC weekend text */
             /* Mapped Feature Variables for HC */
             --feature-team-bg: var(--hc-background);
             --feature-team-card-bg: var(--hc-background);
             --feature-team-border-color: var(--hc-border);
             --feature-team-shadow-color: transparent;
             --feature-team-hover-shadow-color: transparent;
             --feature-team-text-primary: var(--hc-text);
             --feature-team-text-secondary: var(--hc-text);
             --feature-team-title-text: var(--hc-text);
             --feature-team-title-bg: var(--hc-background);
             --feature-team-admin-color: var(--danger);
             --feature-team-supervisor-color: var(--hc-primary);
             --feature-team-senior-color: var(--hc-secondary);
             --feature-team-member-color: var(--hc-text);
             --feature-projects-card-bg: var(--hc-background);
             --feature-projects-text-color: var(--hc-text);
             --feature-projects-text-muted: var(--hc-text);
             --feature-projects-heading-color: var(--hc-text);
             --feature-projects-border-color: var(--hc-border);
             --feature-projects-shadow-color: transparent;
             --feature-projects-shadow-hover-color: transparent;
             --feature-projects-input-bg: var(--hc-background);
             --feature-projects-input-border: var(--hc-border);
             --feature-projects-primary-color: var(--hc-primary);
             --feature-projects-primary-text: var(--hc-background);
             --feature-projects-success-bg: var(--hc-background);
             --feature-projects-success-text: var(--hc-secondary);
             --feature-projects-success-progress: var(--hc-secondary);
             --feature-projects-warning-bg: var(--hc-background);
             --feature-projects-warning-text: var(--hc-text);
             --feature-projects-warning-progress: var(--warning);
             --feature-projects-warning-btn-text: var(--hc-text);
             --feature-projects-info-bg: var(--hc-background);
             --feature-projects-info-text: var(--hc-text); /* Use text color for info text */
             --feature-projects-info-progress: var(--hc-text); /* Use text color for info progress */
             --feature-projects-secondary-bg: var(--hc-background);
             --feature-projects-secondary-text: var(--hc-text);
             --feature-projects-secondary-progress: var(--hc-text);
             --feature-projects-danger-color: var(--danger);
             --feature-projects-danger-text: var(--hc-background);
             --feature-projects-progress-bar-bg: var(--hc-background);
             /* HC Shift Colors */
             --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border);
             --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border);
             --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border);
             --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border);
             --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border);
             --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border);
             /* File Sharing HC */
             --feature-file-sharing-hover-bg: #e0e0e0;
             --feature-file-sharing-header-bg: var(--hc-primary);


             color: var(--text-color);
             background-color: var(--hc-background);
        }
        body.high-contrast .welcome-section,
        body.high-contrast .stat-card,
        body.high-contrast .top-nav,
        body.high-contrast .sidebar,
        body.high-contrast .activity-section,
        body.high-contrast .content-section,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.projects-feature .project-card,
        body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper,
        body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-management-content, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card, /* HC for File Sharing */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card-header,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .filters-section,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .table,
        body.high-contrast #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .modal-content {
            background: var(--hc-background) !important; /* Ensure override */
            border: 1px solid var(--hc-border);
            color: var(--text-color);
            box-shadow: none !important; /* Remove shadows in HC */
        }
        body.high-contrast .btn,
        body.high-contrast .form-control,
        body.high-contrast .form-select, /* Added form-select */
        body.high-contrast .input-group-text, /* Added input group text */
        body.high-contrast .search-bar input,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-filter input, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.projects-feature .project-search-input, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.projects-feature .project-filter-select,
        body.high-contrast #featureSectionsContainer.task-management-feature #search-input, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.task-management-feature .filters select,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form input,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form textarea,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form select,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-control, /* HC for File Sharing */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-select,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .input-group-text {
            border: 1px solid var(--hc-border) !important;
            background: var(--hc-background) !important;
            color: var(--text-color) !important;
        }
         /* Specific Button Overrides for HC */
        body.high-contrast .btn-primary,
        body.high-contrast #featureSectionsContainer.projects-feature .add-project-btn, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.task-management-feature .btn-primary, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.team-members-feature .add-team-member-btn,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card-header .btn-primary, /* File Sharing Upload Button */
        body.high-contrast #featureSectionsContainer.file-sharing-feature #fsStartUploadButton { /* File Sharing Upload Button ID */
            background-color: var(--hc-primary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important;
        }
        body.high-contrast .btn-danger { background-color: var(--danger) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-warning { background-color: var(--warning) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-success { background-color: var(--hc-secondary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-info { background-color: var(--hc-background) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important;} /* Info buttons */
        body.high-contrast .btn-secondary { background-color: var(--hc-background) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important;} /* Secondary buttons */
        body.high-contrast .btn-outline, /* Includes btn-outline-secondary, etc. */
        body.high-contrast .btn-outline-secondary,
        body.high-contrast .btn-outline-success,
        body.high-contrast .btn-outline-info,
        body.high-contrast .btn-outline-danger { background: var(--hc-background) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }

        body.high-contrast .logo { color: var(--text-color); }
        body.high-contrast .logo-icon { color: var(--hc-primary); }
        body.high-contrast .menu-item { color: var(--text-color); border-left-color: transparent; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0; border-left-color: var(--hc-primary); color: var(--hc-text); }
        body.high-contrast .stat-card { border-left-width: 3px; background: var(--hc-background); } /* Reset gradient */
        body.high-contrast .welcome-section { background: var(--hc-background); border: 1px solid var(--hc-border); color: var(--hc-text);}
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text); } /* Reset role color */
        body.high-contrast #featureSectionsContainer.team-members-feature .member-role, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.projects-feature .project-status, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.task-management-feature .status-badge, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .badge { /* HC for File Sharing Badges */
            border: 1px solid var(--hc-border); color: var(--hc-text) !important; background: none !important; background-color: transparent !important; padding: 3px 8px;
        }
        body.high-contrast #featureSectionsContainer.projects-feature .progress-bar { /* HC for Projects */
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast #featureSectionsContainer.projects-feature .progress-bar-container { background: var(--hc-background); border: 1px solid var(--hc-border); }
        body.high-contrast #featureSectionsContainer.projects-feature .project-participants span { /* HC for Projects */
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast .theme-preview { border: 2px solid var(--hc-border); background: var(--hc-background) !important; /* Override inline styles */ }
         body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary); }
         body.high-contrast .switch .slider { background-color: #999; border: 1px solid var(--hc-border); }
         body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary); }
         body.high-contrast .switch .slider:before { background-color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th { background: var(--hc-background); color: var(--hc-text); border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border: 1px solid var(--hc-border); background: var(--hc-background) !important; /* Override nth-child */ }
         body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name { background: var(--hc-background); border-right: 2px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-name,
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-date { color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift { border: 1px solid var(--hc-border); background: none !important; color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift-weekend-off { border: none; font-style: normal; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
         body.high-contrast #featureSectionsContainer.task-management-feature .modal-content,
         body.high-contrast #featureSectionsContainer.task-management-feature .controls { border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card { border-left-width: 3px; }
         /* File Sharing HC Specifics */
         body.high-contrast #featureSectionsContainer.file-sharing-feature .fancy-header-title { background: var(--hc-primary) !important; color: var(--hc-background) !important; box-shadow: none !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .file-icon { color: var(--hc-text) !important; } /* Reset icon colors */
         body.high-contrast #featureSectionsContainer.file-sharing-feature .file-name { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .time-ago { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .table thead { background-color: var(--hc-background) !important; color: var(--hc-text) !important; border-bottom: 2px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * { background-color: #e0e0e0 !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area { border-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .progress-bar { background-color: var(--hc-text) !important; } /* Use text color for progress */
         body.high-contrast #featureSectionsContainer.file-sharing-feature .progress { border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .swal2-popup { background-color: var(--hc-background) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .swal2-title { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .swal2-html-container { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .swal2-confirm { background-color: var(--hc-secondary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .swal2-cancel { background-color: var(--danger) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }

        /* --- Sidebar Styles (Existing) --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: transform 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: var(--success); font-size: 0.85rem; flex-shrink: 0; } /* Use success variable */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(var(--bs-success-rgb), 0.4); } 50% { box-shadow: 0 0 0 5px rgba(var(--bs-success-rgb), 0); } } /* Use BS success RGB */

        /* --- Main Content & Top Nav Styles (Existing) --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: margin-left 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.1); } /* Use BS primary RGB */
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(var(--bs-success-rgb), 0.4); } /* Use BS success RGB */
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles (Existing) --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; /* Smooth background transition */
        }
        /* ... other existing welcome, stats, activity styles ... */
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; color: inherit; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(var(--bs-danger-rgb), 0.5); } /* Use BS danger RGB */
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--success); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--white); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary); /* Colored border instead of top gradient */
            color: var(--dark); /* Ensure text inside uses appropriate theme color */
        }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--success); background: var(--stat-card-bg-2); } /* Use success */
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }

        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-title { font-size: 0.9rem; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        .stat-card:nth-child(1) .stat-value { color: #052c65; } /* Darker blue for stat */
        .stat-card:nth-child(2) .stat-value { color: #0a3622; } /* Darker green */
        .stat-card:nth-child(3) .stat-value { color: #664d03; } /* Darker yellow */
        .stat-card:nth-child(4) .stat-value { color: #58151c; } /* Darker red */

        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--success); } /* Use success */
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-color); } /* Use text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #bb2d3b; text-decoration: underline; background-color: rgba(var(--bs-danger-rgb), 0.1); } /* Use BS danger rgb */
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(var(--bs-primary-rgb), 0.08); animation: highlightNewActivity 2.5s ease-out forwards; } /* Use BS primary rgb */
        @keyframes highlightNewActivity { 0% { background-color: rgba(var(--bs-primary-rgb), 0.15); } 100% { background-color: transparent; } } /* Use BS primary rgb */
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(var(--bs-primary-rgb), 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; } /* Use BS primary rgb */
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--text-color); } /* Use text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .activity-item:hover .delete-activity { opacity: 1; }
        .delete-activity:hover { opacity: 1; background-color: rgba(var(--bs-danger-rgb), 0.1); } /* Use BS danger rgb */

        /* --- Profile & Settings Sections Styles (Existing) --- */
        .content-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; display: none; animation: fadeInContent 0.4s ease-in-out; } /* Hidden by default */
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem;} /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control, .form-select { /* Combined form-control and form-select */ width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use text-color */
        body.compact .form-control, body.compact .form-select { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control, body.spacious .form-select { padding: 1rem; }
        .form-control:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.1); } /* Use BS primary rgb */
        .form-control[readonly] { background-color: var(--light); cursor: not-allowed; opacity: 0.7; } /* Use BS light */
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        .btn { /* Using Bootstrap's btn styles */ display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        /* Use Bootstrap button variants directly (e.g., .btn-primary, .btn-outline-primary) */
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        /* Settings Sub-section */
        .settings-subsection { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--light-gray); }
        .settings-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-subsection h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 1rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; /* Default: Label takes full width */ }
        @media (min-width: 768px) { .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; } }
        .setting-item-label { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; } }


        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        /* Settings Panel Team Member Card Style */
        #settingsContent .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact #settingsContent .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious #settingsContent .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        #settingsContent .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        #settingsContent .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact #settingsContent .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        #settingsContent .member-details { flex: 1; min-width: 0; }
        #settingsContent .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use text-color */
        body.compact #settingsContent .member-name { font-size: 0.9rem; }
        #settingsContent .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact #settingsContent .member-email { font-size: 0.8rem; }
        #settingsContent .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact #settingsContent .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        /* Use dashboard variables for role colors */
        #settingsContent .role-admin { background-color: rgba(var(--bs-danger-rgb), 0.1); color: var(--danger); }
        #settingsContent .role-senior { background-color: rgba(var(--bs-success-rgb), 0.1); color: var(--success); } /* Use success */
        #settingsContent .role-supervisor { background-color: rgba(var(--bs-warning-rgb), 0.1); color: var(--warning); }
        #settingsContent .role-member { background-color: rgba(var(--bs-secondary-rgb), 0.1); color: var(--secondary); } /* Use secondary */

        #settingsContent .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #settingsContent .member-actions .btn-sm { /* Use Bootstrap class */ }

        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */
        .btn.btn-outline .spinner,
        .btn.btn-outline-secondary .spinner { /* Include outline-secondary */
            border-color: rgba(var(--bs-primary-rgb), 0.3); border-top-color: var(--primary);
        }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }


        /* --- Theme Styles & Dark Mode Overrides (Existing) --- */
        body.light-theme { /* Use defaults from :root */ }
        body.dark-theme {
             --primary: #3b82f6; /* Lighter blue */
             --primary-dark: #1e40af; /* Darker blue */
             --primary-light: #1e293b; /* Dark blue-gray */
             --light: #334155; /* Lighter background for cards/sections */
             --white: #0f172a; /* Darkest background for body */
             --dark: #e2e8f0; /* Light text */
             --gray: #94a3b8; /* Lighter gray text */
             --light-gray: #475569; /* Darker borders/dividers */
             --text-color: var(--dark); /* Update text-color for dark mode */
             --secondary: #a1a1aa; /* Lighter secondary */
             --success: #4ade80; /* Brighter Green */
             --danger: #f87171; /* Lighter red */
             --warning: #facc15; /* Brighter Yellow */
             --info: #67e8f9; /* Brighter Cyan */
             --sidebar-bg: #111827; /* Even darker sidebar */
             --schedule-weekend-bg: #262f3e; /* Darker gray for weekend cells */
             --schedule-weekend-text: #6b7280; /* Muted dark text for weekend OFF */
              /* Dark Mode Shift Colors */
             --shift-morning-bg: #1e3a8a; --shift-morning-text: #dbeafe; --shift-morning-border: #2563eb;
             --shift-afternoon-bg: #0e7490; --shift-afternoon-text: #ecfeff; --shift-afternoon-border: #22d3ee;
             --shift-night-bg: #581c87; --shift-night-text: #f3e8ff; --shift-night-border: #a855f7;
             --shift-off-bg: #064e3b; --shift-off-text: #d1fae5; --shift-off-border: #34d399;
             --shift-sick-bg: #881337; --shift-sick-text: #fecdd3; --shift-sick-border: #fb7185;
             --shift-vacation-bg: #7c2d12; --shift-vacation-text: #ffedd5; --shift-vacation-border: #fb923c;
            /* Mapped Team Members Dark Theme Variables */
            --feature-team-bg: var(--white); /* Darkest */
            --feature-team-card-bg: var(--light); /* Lighter dark */
            --feature-team-border-color: var(--light-gray);
            --feature-team-text-primary: var(--text-color);
            --feature-team-text-secondary: var(--gray);
            --feature-team-title-text: var(--text-color);
            --feature-team-title-bg: var(--light);
            /* Mapped Projects Dark Theme Variables */
            --feature-projects-body-bg: var(--white);
            --feature-projects-card-bg: var(--light);
            --feature-projects-text-color: var(--text-color);
            --feature-projects-text-muted: var(--gray);
            --feature-projects-heading-color: #a5b4fc; /* Brighter heading in dark */
            --feature-projects-border-color: var(--light-gray);
            --feature-projects-input-bg: var(--primary-light);
            --feature-projects-input-border: var(--light-gray);
            --feature-projects-success-bg: #14532d; /* Darker green bg */
            --feature-projects-success-text: #a7f3d0; /* Lighter green text */
            --feature-projects-success-progress: var(--success);
            --feature-projects-warning-bg: #7f5d11; /* Darker orange/brown */
            --feature-projects-warning-text: #fef3c7; /* Lighter orange/brown text */
            --feature-projects-warning-progress: var(--warning);
            --feature-projects-warning-btn-text: #1f2937; /* Keep dark text */
            --feature-projects-info-bg: #1e40af; /* Darker blue */
            --feature-projects-info-text: #dbeafe; /* Lighter blue text */
            --feature-projects-info-progress: var(--primary);
            --feature-projects-secondary-bg: #4b5563; /* Darker gray */
            --feature-projects-secondary-text: #d1d5db; /* Lighter gray text */
            --feature-projects-secondary-progress: var(--gray);
            --feature-projects-danger-color: var(--danger);
            --feature-projects-danger-hover: #ef4444;
            --feature-projects-progress-bar-bg: var(--light-gray);
             /* File Sharing Dark Mode */
             --feature-file-sharing-hover-bg: #374151; /* Dark hover */
             --feature-file-sharing-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%); /* Keep original */

             background-color: var(--white); /* Use darkest for body */
             color: var(--text-color); /* Default text color */
        }
        /* --- Dark Theme Overrides --- */
        body.dark-theme .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); } /* Lighter BG for nav */
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme #settingsContent .team-member-card, body.dark-theme .add-member-form { background-color: var(--light); border-color: var(--light-gray); } /* Lighter BG for content cards */
        body.dark-theme .search-bar input, body.dark-theme .form-control, body.dark-theme .form-select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); } /* Even darker BG for inputs */
        body.dark-theme .form-control[readonly] { background-color: var(--light); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item { color: var(--text-color); } /* Ensure search result text is light */
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item { color: var(--text-color); } /* Ensure dropdown text is light */
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-modal { background-color: rgba(0, 0, 0, 0.7); } /* Darker backdrop */
        body.dark-theme .notifications-container { background-color: var(--light); } /* Lighter BG for notifications panel */
        body.dark-theme .notification-list-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(var(--bs-primary-rgb), 0.15); } /* Slightly more visible unread */
        body.dark-theme .confirm-modal { background-color: rgba(0, 0, 0, 0.7); }
        body.dark-theme .confirm-container, body.dark-theme .modal-content { background-color: var(--light); color: var(--text-color); } /* Modal background and default text */
        body.dark-theme .theme-option .theme-preview { border-color: var(--light-gray); background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%); /* Adjust preview */ }
        body.dark-theme .theme-option .light-preview { background: var(--light) !important; }
        body.dark-theme .theme-option .dark-preview { background: var(--white) !important; }
        body.dark-theme .theme-option .system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray);}
        body.dark-theme .theme-option.selected .theme-preview { border-color: var(--primary); }
        body.dark-theme .theme-option .theme-label { color: var(--text-color); }
        body.dark-theme .back-button { color: var(--primary); } /* Use primary color for link */
        body.dark-theme .back-button:hover { background-color: var(--light); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--light); border-top-color: var(--light-gray); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white); } /* Welcome section retains white text */
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; } /* Inherit white */
        body.dark-theme .user-info-name { color: inherit; } /* Inherit white */
        body.dark-theme .user-info-title { color: var(--gray); } /* Role title uses gray */
        body.dark-theme .user-info-title.role-admin { color: var(--danger); }
        body.dark-theme .user-info-email span { color: inherit; } /* Inherit white */
        body.dark-theme .stat-card { background: var(--light); color: var(--text-color);} /* Dark theme stat card background, ensure text color */
        body.dark-theme .stat-title { color: var(--text-color); } /* Ensure stat title is light */
        /* Specific stat value colors adjusted for dark theme */
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; }
        body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; }
        body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; }
        body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(var(--bs-primary-rgb), 0.1); color: var(--primary); } /* Adjust icon color */
        body.dark-theme .activity-item { border-bottom-color: var(--light-gray); }
        body.dark-theme .activity-message { color: var(--text-color); } /* Activity text */
        body.dark-theme .activity-time { color: var(--gray); } /* Activity time */
        body.dark-theme .activity-item.new-activity { background-color: rgba(var(--bs-primary-rgb), 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(var(--bs-danger-rgb), 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--text-color); } /* Text label */
        body.dark-theme #profileAvatarLarge { background-color: var(--light); color: var(--text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); } /* Profile intro text */
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--light-gray); }
        body.dark-theme .placeholder-content h2 { color: var(--text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(var(--bs-danger-rgb), 0.1); border-color: rgba(var(--bs-danger-rgb), 0.3); color: var(--text-color); } /* Ensure error text readable */
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--text-color); } /* Form labels */
        body.dark-theme .settings-subsection h4 { color: var(--primary); } /* Lighter primary */
        body.dark-theme .setting-item-label { color: var(--text-color); } /* Setting item title */
        body.dark-theme .setting-item-description { color: var(--gray); } /* Setting item description */
        body.dark-theme .qr-code-placeholder { border-color: var(--light-gray); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; } /* Ensure danger button stands out */
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); } /* Danger zone description */
        body.dark-theme .checkbox-group { border-color: var(--light-gray); }
        body.dark-theme .checkbox-group label { color: var(--text-color); } /* Checkbox label text */
        body.dark-theme .confirm-title { color: var(--text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: var(--primary); } /* Lighter primary */
        body.dark-theme #settingsContent .team-member-card .member-name { color: var(--text-color); }
        body.dark-theme #settingsContent .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--text-color); } /* Ensure bold text is readable */
        body.dark-theme .user-name { color: var(--text-color); } /* Top nav user name */
        body.dark-theme .toast { background-color: var(--light); color: var(--text-color); } /* Dark theme toast */
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }
        body.dark-theme .input-group-text { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); } /* Dark input group text */

        /* --- Dark Theme: Employee Scheduling --- */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-bottom-color: var(--light-gray);} /* Adjusted for better contrast */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--text-color); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); } /* Darker even row background */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; } /* Hover effect */
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--light); border-right-color: var(--light-gray); color: var(--text-color); } /* Dark sticky column bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: var(--text-color); } /* Day name text color */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; } /* Dark weekend bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; font-style: italic;}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title { color: var(--primary); }
        /* Dark theme shift colors defined in :root.dark-theme */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border);}


        /* --- Dark Theme: Task Management (Existing + Overrides) --- */
        body.dark-theme #featureSectionsContainer.task-management-feature { background-color: var(--white); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-page-header { background-color: var(--primary-dark); color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content h1 { color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .controls { background-color: var(--primary-light); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content #search-input,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .filters select { background-color: var(--white); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .search-icon { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { background-color: var(--primary-light); color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--light); border-color: var(--light-gray); border-left-color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-High { border-left-color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Medium { border-left-color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Low { border-left-color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card p { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-meta { color: var(--gray); border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-badge { color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); color: #333; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: var(--primary); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: var(--success); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal { background-color: rgba(0, 0, 0, 0.7); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn:hover { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content #modal-title { color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content label { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="text"],
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="date"],
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content textarea,
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .form-actions { border-top-color: var(--light-gray); }

        /* --- Dark Theme: Team Members Feature --- */
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section { background-color: var(--feature-team-bg); border-color: var(--feature-team-border-color);}
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section-header { background-color: var(--feature-team-title-bg); color: var(--feature-team-title-text); border-bottom-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"] { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"]::placeholder { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--feature-team-card-bg); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card:hover { border-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-name { color: var(--feature-team-text-primary); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-email { color: var(--feature-team-text-secondary); }
        /* Role colors might need slight adjustment for dark mode if contrast is low, but using existing vars for now */
        body.dark-theme #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: #4b5563; color: #d1d5db;} /* Example adjustment */

        /* --- Dark Theme: Projects Feature --- */
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--feature-projects-card-bg); border-left-color: var(--feature-projects-primary-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-controls { background-color: var(--feature-projects-card-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-search-input,
        body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-projects-input-border); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-card { background-color: var(--feature-projects-card-bg); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--feature-projects-progress-bar-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info i { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); color: var(--feature-projects-text-color); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-actions { border-top-color: var(--feature-projects-border-color); }

         /* --- Dark Theme: File Sharing --- */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card,
        body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section,
        body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table {
            background-color: var(--light) !important; /* Use lighter dark */
            border-color: var(--light-gray) !important;
            color: var(--text-color) !important;
        }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header {
            background-color: var(--light) !important; border-bottom-color: var(--light-gray) !important;
        }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .fancy-header-title { background: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section .form-label { color: var(--gray) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 { color: var(--primary) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom-color: var(--light-gray) !important; color: var(--text-color) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name { color: var(--text-color) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .text-muted { color: var(--gray) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .time-ago { color: var(--gray) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .table thead { background-color: var(--primary-light) !important; color: var(--gray) !important; border-bottom-color: var(--light-gray) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .table tbody tr td { border-bottom-color: var(--light-gray) !important; color: var(--text-color) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--feature-file-sharing-hover-bg) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--primary-light) !important; border-color: var(--primary) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--light) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .progress { background-color: var(--light-gray) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-popup { background-color: var(--light) !important; color: var(--text-color) !important; border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-title { color: var(--text-color) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-html-container { color: var(--gray) !important; }


        /* --- Notifications Modal, Confirm Modal, Utils (Existing) --- */
        /* ... existing styles for these elements ... */
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-modal.active { display: flex; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start; /* Align top */ cursor: pointer; position: relative; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(var(--bs-primary-rgb), 0.08); font-weight: 500; } /* Adjusted unread bg slightly */
        body.dark-theme .notification-list-item.unread { background-color: rgba(var(--bs-primary-rgb), 0.15); } /* Dark theme unread */
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(var(--bs-primary-rgb), 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        body.dark-theme .notification-icon-wrapper { background-color: rgba(var(--bs-primary-rgb), 0.1); color: var(--primary);}
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--text-color); line-height: 1.4; } /* Use text-color */
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0; /* Hidden by default */ transition: opacity 0.2s; position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem; background: var(--white); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .notification-list-item:hover .delete-notification { opacity: 0.6; } /* Show on hover */
        .delete-notification:hover { opacity: 1; background: rgba(var(--bs-danger-rgb), 0.1); }
        body.dark-theme .delete-notification { background: var(--light); }
        body.dark-theme .delete-notification:hover { background: rgba(var(--bs-danger-rgb), 0.2); }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); flex-wrap: wrap; gap: 0.5rem; } /* Added wrap */
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-modal.active { display: flex; }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); } /* Use text-color */
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; }
        .d-none { display: none !important; }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s, color 0.3s; }
        .placeholder-content h2 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .placeholder-content p { color: var(--gray); } /* Ensure placeholder text uses gray */
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; text-align: left; padding: 1rem; background: rgba(var(--bs-danger-rgb), 0.05); border: 1px solid rgba(var(--bs-danger-rgb), 0.2); border-radius: 4px; max-width: 100%; overflow-wrap: break-word; }


        /* --- Generic Modal Styles (Existing + Edit Member/Add Member) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1050; /* Higher than confirm modal */
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--white); width: 100%; max-width: 550px; /* Slightly wider for member form */
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem; max-height: 90vh; overflow-y: auto; animation: zoomIn 0.3s ease-out;
            color: var(--text-color); /* Default text color for modal content */
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray);
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        body.dark-theme .modal-title { color: var(--primary); }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1;}
        .close-modal:hover { color: var(--danger); }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- Checkbox Group (Existing) --- */
         .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: 6px; }
         .checkbox-group label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--text-color); }
         .checkbox-group input[type="checkbox"] { width: auto; margin-right: 0.25rem; }
         .settings-link { color: var(--primary); text-decoration: none; cursor: pointer; }
         .settings-link:hover { text-decoration: underline; color: var(--primary-dark); }

        /* --- Toast (Existing) --- */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1300; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        body.dark-theme .toast.success { color: var(--white); } /* Ensure text is white */
        body.dark-theme .toast.error { color: var(--white); } /* Ensure text is white */


        /* --- Employee Scheduling Table Refinements --- */
        #featureSectionsContainer.employee-scheduling .schedule-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center; /* Align items vertically */
            margin-bottom: 1.5rem;
        }
        /* Container for the main control buttons */
        #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        /* Container for admin buttons (Save, Send Reminders) */
        #featureSectionsContainer.employee-scheduling .admin-actions {
            display: flex;
            flex-direction: row; /* Changed back to row */
            gap: 0.75rem; /* Space between buttons */
            margin-left: auto; /* Push to the right */
            align-items: center; /* Align with week nav */
        }
        @media (max-width: 768px) { /* On mobile, stack everything */
            #featureSectionsContainer.employee-scheduling .schedule-controls {
                 flex-direction: column;
                 align-items: stretch;
            }
             #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav {
                 justify-content: space-between; /* Space out Prev/Next */
                 width: 100%;
             }
             #featureSectionsContainer.employee-scheduling .admin-actions {
                 margin-left: 0; /* Remove auto margin */
                 width: 100%;
                 flex-direction: column; /* Stack admin buttons on mobile */
                 align-items: stretch; /* Stretch buttons */
             }
             #featureSectionsContainer.employee-scheduling .admin-actions .btn {
                 width: 100%;
                 justify-content: center;
             }
        }

        #featureSectionsContainer.employee-scheduling .schedule-container {
            margin-top: 1rem;
            overflow-x: auto; /* Enable horizontal scroll on container */
            border: 1px solid var(--light-gray); /* Add border to container */
            border-radius: 8px;
            background-color: var(--white); /* Ensure container has BG */
        }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-container {
            border-color: var(--light-gray);
            background-color: var(--light);
        }
        #featureSectionsContainer.employee-scheduling .schedule-table {
            width: 100%;
            min-width: 900px; /* Ensure enough width for 7 days + employee */
            border-collapse: separate; /* Use separate for sticky */
            border-spacing: 0;
        }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th {
            padding: 0.8rem 0.75rem; /* Adjust padding */
            text-align: center;
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--primary-dark);
            border-right: 1px solid var(--primary-dark); /* Add right border */
        }
         #featureSectionsContainer.employee-scheduling .schedule-table thead th:last-child { border-right: none; }
         #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { /* Employee Header */
            position: sticky; left: 0; z-index: 11 !important; border-right: 2px solid var(--primary-dark); background-color: var(--primary);
         }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary-dark); border-right: 2px solid var(--light-gray); }

        #featureSectionsContainer.employee-scheduling .schedule-table tbody td {
            padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--light-gray); border-right: 1px solid var(--light-gray); vertical-align: middle; transition: background-color 0.2s; color: var(--text-color); white-space: nowrap;
        }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td { background-color: #f9fafb; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td { background-color: var(--primary-light); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td { background-color: #f0f9ff; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td { background-color: #475569; }
        #featureSectionsContainer.employee-scheduling .employee-name { /* Sticky employee name cell */
            font-weight: 600; text-align: left; position: sticky; left: 0; z-index: 5; background-color: var(--white); border-right: 2px solid var(--gray);
        }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; }
         body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--light); border-right-color: var(--light-gray); } /* Adjusted Dark BG */
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); }
         #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }

        #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        #featureSectionsContainer.employee-scheduling .shift { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; min-width: 70px; border: 1px solid transparent; cursor: default; }
        #featureSectionsContainer.employee-scheduling .shift.editable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #featureSectionsContainer.employee-scheduling .shift.editable:hover { transform: scale(1.05); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent !important; font-style: italic; border: none; cursor: default; font-weight: normal; }
         /* Apply Shift Colors using Variables */
        #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border); }
        #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border); }
        #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border); }
        #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border); }
        #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border); }
        #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border); }
        #featureSectionsContainer.employee-scheduling .day-header { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling .day-name { font-weight: 600; font-size: 0.9rem; color: inherit; }
        #featureSectionsContainer.employee-scheduling .day-date { font-size: 0.8rem; opacity: 0.8; color: inherit; }
        /* --- END: Employee Scheduling Table Refinements --- */

        /* --- START: Appearance & Theme Refinements --- */
        #preferencesPanel .theme-options-container {
            display: flex; /* Arrange horizontally */
            gap: 1.5rem; /* Space between options */
            margin-top: 0.5rem;
            flex-wrap: wrap; /* Allow wrapping if needed */
            justify-content: flex-start; /* Align to start */
            margin-bottom: 1.5rem; /* Add space below */
            padding: 0.5rem 0; /* Add vertical padding */
        }
        #preferencesPanel .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem; /* More padding for better click area */
            border-radius: 8px; /* Slightly more rounded */
            transition: background-color 0.2s, box-shadow 0.2s;
            min-width: 100px; /* Ensure minimum width */
            border: 2px solid transparent; /* Add border for selected state */
            background-color: var(--light); /* Subtle background */
        }
        body.dark-theme #preferencesPanel .theme-option {
            background-color: var(--light);
        }
        #preferencesPanel .theme-option:hover {
             background-color: var(--primary-light);
             box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        body.dark-theme #preferencesPanel .theme-option:hover {
            background-color: var(--light-gray);
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #preferencesPanel .theme-option.selected {
             border-color: var(--primary);
             background-color: var(--primary-light);
        }
         body.dark-theme #preferencesPanel .theme-option.selected {
             background-color: var(--primary-dark);
             border-color: var(--primary);
         }
        #preferencesPanel .theme-option .theme-preview {
            width: 60px;
            height: 40px;
            border: 1px solid var(--gray); /* Simple border for preview box */
            border-radius: 6px;
            transition: border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 0.75rem; /* Increased Space between preview and label */
            background-color: var(--white); /* Default background */
            overflow: hidden; /* Needed for gradient preview */
        }
        #preferencesPanel .theme-option .theme-label {
            text-align: center;
            display: block;
            font-size: 0.9rem;
            font-weight: 500; /* Make label slightly bolder */
            color: var(--text-color);
        }
         body.dark-theme #preferencesPanel .theme-option .theme-label {
             color: var(--text-color);
         }
        /* Specific theme previews */
        #preferencesPanel .theme-preview.light-preview { background-color: #f8fafc; color: #1e293b; border-color: var(--light-gray);}
        #preferencesPanel .theme-preview.dark-preview { background-color: #0f172a; color: #e2e8f0; border-color: var(--gray);}
        #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, #f8fafc 50%, #0f172a 50%); color: var(--gray); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview { border-color: var(--light-gray); }
        body.dark-theme #preferencesPanel .theme-preview.light-preview { background: var(--light) !important; color: var(--dark); border-color: var(--light-gray);}
        body.dark-theme #preferencesPanel .theme-preview.dark-preview { background: var(--white) !important; color: var(--dark); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray); border-color: var(--gray);}
        /* --- END: Appearance & Theme Refinements --- */

         /* --- Responsive (Existing + Refinements) --- */
         /* ... existing responsive styles ... */
         @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); width: 250px; box-shadow: none; }
             .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
             .main-content { margin-left: 0; }
             .search-bar { width: 250px; }
             /* .main-content.sidebar-active { margin-left: 250px; } Removed, sidebar overlays now */
             .sidebar-toggle { display: block; /* Show hamburger */ position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
             .top-nav { padding-left: 60px; } /* Make space for hamburger */
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature .task-management-content .task-list { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
            #featureSectionsContainer.task-management-feature .task-management-content .container { padding: 20px; }
            /* Responsive: Team Members */
            #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .projects-header { flex-direction: column; align-items: stretch; }
            #featureSectionsContainer.projects-feature .projects-title-wrapper { width: auto; }
            #featureSectionsContainer.projects-feature .project-controls { justify-content: flex-start; }
             /* Responsive: File Sharing */
             #featureSectionsContainer.file-sharing-feature .card-header .btn { margin-top: 0.5rem; width: 100%;}
             #featureSectionsContainer.file-sharing-feature .filters-section .col-md-1 { text-align: left !important; margin-top: 0.5rem;}

         }
         @media (min-width: 993px) { .sidebar-toggle { display: none; } }
         @media (max-width: 768px) {
             .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; padding-left: 1rem; }
             .search-bar { width: 100%; order: 2; }
             .user-menu { width: 100%; justify-content: space-between; order: 1; }
             .content-area { padding: 1.5rem; }
             .data-form { grid-template-columns: 1fr; }
             .form-actions { grid-column: span 1; }
             .user-info { flex-direction: column; text-align: center; }
             .user-info-avatar { margin-bottom: 1rem; }
             .stats-section { grid-template-columns: 1fr; }
             .settings-tabs { flex-wrap: nowrap; overflow-x: auto; }
             .settings-tab { padding: 0.5rem 1rem; flex-shrink: 0; }
             .confirm-container { width: 90%; }
             #settingsContent .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; } /* Settings list */
             #settingsContent .member-role { margin: 0.5rem 0; }
             #settingsContent .member-actions { margin-top: 0.5rem; width: 100%; justify-content: flex-end; } /* Adjust actions on mobile */
             .profile-avatar-section { margin-bottom: 1.5rem; }
             #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
             #featureSectionsContainer.employee-scheduling .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav { justify-content: space-between; width: 100%; } /* Space out Prev/Next */
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions { margin-left: 0; width: 100%; } /* Reset margin, full width */
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions .btn { width: 100%; justify-content: center; }
             #featureSectionsContainer.employee-scheduling .schedule-page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
             /* Employee Schedule Table Responsive Fixes */
             #featureSectionsContainer.employee-scheduling .schedule-table { border-spacing: 0; /* Needed for sticky */ }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th,
             #featureSectionsContainer.employee-scheduling .schedule-table tbody td { white-space: nowrap; /* Prevent wrapping */ }
             #featureSectionsContainer.employee-scheduling .employee-name { position: sticky !important; left: 0; z-index: 5 !important; border-right: 1px solid var(--feature-projects-border-color); background-color: var(--white); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--light); border-right-color: var(--light-gray); }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { position: sticky !important; left: 0; z-index: 11 !important; background-color: var(--primary); } /* Ensure header sticky bg */
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary-dark); } /* Dark theme header sticky bg */
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; } /* Light mode */
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); } /* Dark mode */
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; } /* Light mode hover */
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; } /* Dark mode hover */
             /* End Employee Schedule Responsive Fixes */
             .modal-content { width: 95%; padding: 1.5rem;}
             .notifications-container { width: 100%; max-width: 100%; }
             .sidebar-toggle { top: 10px; left: 10px; }
             .top-nav { padding-top: 60px; }
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature .task-management-content .controls { flex-direction: column; align-items: stretch; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .search-container { margin: 0; }
            #featureSectionsContainer.task-management-feature .task-management-content #add-task-btn { width: 100%; margin-left: 0; order: -1; margin-bottom: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters { flex-direction: column; width: 100%; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters select { width: 100%; min-width: unset; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-list { grid-template-columns: 1fr; }
            #featureSectionsContainer.task-management-feature .modal-content { width: 95%; padding: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row { flex-direction: column; gap: 15px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row > div { min-width: unset; }
            #featureSectionsContainer.task-management-feature .task-management-content h1 { font-size: 1.8em; }
            /* Responsive: Team Members */
             #featureSectionsContainer.team-members-feature .team-content-area,
             #featureSectionsContainer.team-members-feature .team-members-section-header { padding-left: 15px; padding-right: 15px; }
             #featureSectionsContainer.team-members-feature .team-members-section-header h2 { font-size: 1.5rem;}
             #featureSectionsContainer.team-members-feature .team-members-section-header { padding-top: 18px; padding-bottom: 18px; }
             #featureSectionsContainer.team-members-feature .team-filter { max-width: none; } /* Full width filter */
             #featureSectionsContainer.team-members-feature .team-member-card { /* Feature view card */ flex-direction: column; align-items: flex-start; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .projects-list { grid-template-columns: 1fr; gap: 20px; }
            #featureSectionsContainer.projects-feature .project-controls { flex-direction: column; align-items: stretch; }
            #featureSectionsContainer.projects-feature .project-search-input,
            #featureSectionsContainer.projects-feature .project-filter-select,
            #featureSectionsContainer.projects-feature .add-project-btn { width: 100%; box-sizing: border-box; }
            #featureSectionsContainer.projects-feature .project-card-image { height: 160px; }
            #featureSectionsContainer.projects-feature .project-name { font-size: 1.25em; }
            #featureSectionsContainer.projects-feature .project-actions .btn { padding: 7px 12px; font-size: 0.8em; }
             #preferencesPanel .theme-options-container { justify-content: center; /* Center themes on small screens */ }
             /* Responsive: File Sharing Table */
             #featureSectionsContainer.file-sharing-feature .table thead { display: none; }
             #featureSectionsContainer.file-sharing-feature .table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid var(--light-gray); border-radius: 0.375rem; padding: 0.5rem; background-color: var(--white); }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table tbody tr { background-color: var(--light) !important; border-color: var(--light-gray); }
             #featureSectionsContainer.file-sharing-feature .table tbody td { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.25rem; border: none; border-bottom: 1px dashed var(--light-gray); text-align: right; } /* Align right */
             #featureSectionsContainer.file-sharing-feature .table tbody td:last-child { border-bottom: none; }
             #featureSectionsContainer.file-sharing-feature .table tbody td::before { content: attr(data-label); font-weight: bold; margin-right: 1rem; color: var(--gray); text-align: left; /* Align label left */ flex-grow: 1; white-space: nowrap; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(1)::before { content: 'Type'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2)::before { content: 'File'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(3)::before { content: 'Date'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4)::before { content: 'Tags'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(5)::before { content: 'Uploader'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6)::before { content: 'Actions'; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) { flex-direction: column; align-items: flex-end; } /* Stack file name/size */
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) .file-name { width: 100%; text-align: right; word-break: break-all; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) small { margin-top: 0.25rem; width: 100%; text-align: right; }
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4) { flex-wrap: wrap; justify-content: flex-end; } /* Wrap tags */
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4) .badge { margin-left: 2px; margin-bottom: 2px; } /* Stack badges */
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6) { padding-top: 0.8rem; padding-bottom: 0.8rem; } /* More padding for actions */
             #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6) .action-buttons { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 5px; }
         }
         @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
             .user-menu { gap: 1rem; }
             .user-name { display: none; } /* Hide name on very small screens */
             .user-status { margin-left: 0; }
             .notifications-footer { flex-direction: column; gap: 0.5rem; }
             .notifications-footer .btn { width: 100%; justify-content: center; }
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature { padding: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content { padding: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn { font-size: 0.95em; padding: 9px 15px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-actions .btn { padding: 10px 20px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card { padding: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { font-size: 1.15em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card p,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .description,
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta { font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { font-size: 1.1em; margin-left: 8px; }
            #featureSectionsContainer.task-management-feature .modal-content { padding: 20px 15px; }
            #featureSectionsContainer.task-management-feature .modal-content #modal-title { font-size: 1.5em; margin-bottom: 20px; }
            /* Responsive: Team Members */
             #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: 1fr; gap: 15px; }
             #featureSectionsContainer.team-members-feature .team-member-card { padding: 18px; } /* Use original padding */
             #featureSectionsContainer.team-members-feature .member-name { font-size: 1.1rem; }
             #featureSectionsContainer.team-members-feature .member-email { font-size: 0.85rem; margin-bottom: 12px; }
             #featureSectionsContainer.team-members-feature .member-role { font-size: 0.8rem; padding: 3px 8px; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .project-actions .btn { flex-grow: 1; justify-content: center; } /* Make buttons fill width */
             /* Responsive: File Sharing */
            #featureSectionsContainer.file-sharing-feature .fancy-header-title { font-size: 1rem; padding: 8px 15px; }
             #featureSectionsContainer.file-sharing-feature .card-header .btn-sm { font-size: 0.8rem; padding: 0.25rem 0.5rem;}
         }

        /* --- START: Adapted Team Members Styles (Refined) --- */
        /* Scope all styles to the feature container */
        #featureSectionsContainer.team-members-feature .team-members-section {
            background-color: var(--feature-team-bg);
            border-radius: var(--feature-team-card-border-radius);
            max-width: 1200px; /* Keep max-width or adjust */
            margin: 0 auto; /* Center within content area */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid var(--feature-team-border-color);
        }
        #featureSectionsContainer.team-members-feature .team-members-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: var(--feature-team-title-bg);
            color: var(--feature-team-title-text);
            margin: 0;
            padding: 1.1rem var(--feature-team-section-padding); /* Consistent padding */
            font-weight: 600;
            text-align: left;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--feature-team-border-color);
        }
        #featureSectionsContainer.team-members-feature .team-members-section-header h2 {
            font-size: 1.5rem; /* Match dashboard section title */
            margin: 0; /* Remove default margin */
        }
        #featureSectionsContainer.team-members-feature .add-team-member-btn {
             /* Use dashboard button styles */
        }
        #featureSectionsContainer.team-members-feature .team-content-area {
            padding: var(--feature-team-section-padding);
        }
        #featureSectionsContainer.team-members-feature .team-filter {
            margin-bottom: 1.5rem; /* Consistent margin */
            max-width: 400px;
        }
        #featureSectionsContainer.team-members-feature .team-filter input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem; /* Match dashboard input padding */
            border: 1px solid var(--feature-team-border-color);
            border-radius: 6px; /* Match dashboard radius */
            background-color: var(--white); /* Use var */
            box-sizing: border-box;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            color: var(--text-color); /* Use dashboard text color */
        }
        #featureSectionsContainer.team-members-feature .team-filter input[type="text"]::placeholder {
            color: var(--gray); /* Use var */
        }
        #featureSectionsContainer.team-members-feature .team-filter input[type="text"]:focus {
            outline: none;
            border-color: var(--primary); /* Use var */
            box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.1); /* Use var */
        }
        #featureSectionsContainer.team-members-feature .team-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--feature-team-grid-gap);
        }
        #featureSectionsContainer.team-members-feature .team-member-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: var(--feature-team-card-bg);
            border: 1px solid var(--feature-team-border-color);
            border-radius: var(--feature-team-card-border-radius);
            padding: var(--feature-team-card-padding);
            box-shadow: 0 3px 8px var(--feature-team-shadow-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out;
            overflow: hidden;
        }
        #featureSectionsContainer.team-members-feature .team-member-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--feature-team-hover-shadow-color);
            border-color: var(--gray); /* Slightly darker border */
        }
        #featureSectionsContainer.team-members-feature .member-info { width: 100%; }
        #featureSectionsContainer.team-members-feature .member-name {
            font-size: 1.15rem; font-weight: 600;
            color: var(--feature-team-text-primary);
            margin: 0 0 5px 0; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        #featureSectionsContainer.team-members-feature .member-email {
            font-size: 0.88rem; color: var(--feature-team-text-secondary);
            margin: 0 0 14px 0; word-break: break-all; line-height: 1.4;
        }
        #featureSectionsContainer.team-members-feature .member-role {
            font-size: 0.85rem; font-weight: 500; margin: 0;
            padding: 4px 10px; border-radius: 6px;
            display: inline-block; line-height: 1.3;
            /* Use background colors for roles */
            color: #fff; /* White text on colored background */
        }
        #featureSectionsContainer.team-members-feature .member-role.role-admin { background-color: var(--feature-team-admin-color); }
        #featureSectionsContainer.team-members-feature .member-role.role-supervisor { background-color: var(--feature-team-supervisor-color); }
        #featureSectionsContainer.team-members-feature .member-role.role-senior { background-color: var(--feature-team-senior-color); }
        #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: var(--feature-team-member-color); }
        #featureSectionsContainer.team-members-feature .team-member-card.hidden-by-filter { display: none; }
        /* --- END: Adapted Team Members Styles --- */


        /* --- START: Adapted Projects Styles (Refined) --- */
        #featureSectionsContainer.projects-feature #projects-section {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto; /* Center within content area */
        }
        #featureSectionsContainer.projects-feature .projects-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        #featureSectionsContainer.projects-feature .projects-title-wrapper {
            background-color: var(--feature-projects-card-bg); /* Use variable */
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--feature-projects-shadow-color); /* Use variable */
            flex-grow: 1;
            border-left: 5px solid var(--feature-projects-primary-color); /* Use variable */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .projects-title-wrapper h2 {
            color: var(--feature-projects-heading-color); /* Use variable */
            margin: 0;
            font-weight: 600;
            font-size: 1.8em;
            transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--feature-projects-card-bg); /* Use variable */
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--feature-projects-shadow-color); /* Use variable */
            transition: background-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-search-input,
        #featureSectionsContainer.projects-feature .project-filter-select {
            padding: 9px 13px;
            border: 1px solid var(--feature-projects-input-border); /* Use variable */
            border-radius: 6px;
            font-size: 0.9em;
            background-color: var(--feature-projects-input-bg); /* Use variable */
            color: var(--feature-projects-text-color); /* Use variable */
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-search-input:focus,
        #featureSectionsContainer.projects-feature .project-filter-select:focus {
            outline: none;
            border-color: var(--feature-projects-input-focus-border); /* Use variable */
            box-shadow: 0 0 0 0.2rem var(--feature-projects-input-focus-shadow); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .project-search-input { min-width: 200px; }
        #featureSectionsContainer.projects-feature .project-filter-select {
             appearance: none;
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); /* Default arrow */
             background-repeat: no-repeat;
             background-position: right 0.75rem center;
             background-size: 16px 12px;
             padding-right: 2.5rem;
        }
         /* Dark mode arrow */
        body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23cccccc' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); /* Lighter arrow */
        }
        #featureSectionsContainer.projects-feature .add-project-btn {
            /* Use dashboard .btn styles implicitly */
            background-color: var(--feature-projects-primary-color); /* Use variable */
            color: var(--feature-projects-primary-text); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .add-project-btn:hover {
            background-color: var(--feature-projects-primary-hover); /* Use variable */
            box-shadow: 0 2px 5px rgba(var(--bs-primary-rgb), 0.3);
        }
        #featureSectionsContainer.projects-feature .projects-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
        }
        #featureSectionsContainer.projects-feature .project-card {
            background-color: var(--feature-projects-card-bg); /* Use variable */
            border-radius: 12px; /* Use original rounded corners */
            border: 1px solid var(--feature-projects-border-color); /* Use variable */
            box-shadow: 0 6px 12px var(--feature-projects-shadow-color); /* Use variable */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 10px 20px var(--feature-projects-shadow-hover-color); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .project-card-image {
            height: 180px; background-size: cover; background-position: center; position: relative;
        }
        #featureSectionsContainer.projects-feature .project-card-body {
            padding: 25px; display: flex; flex-direction: column; flex-grow: 1;
        }
        #featureSectionsContainer.projects-feature .project-name {
            font-size: 1.4em; font-weight: 600;
            color: var(--feature-projects-heading-color); /* Use variable */
            margin-top: 0; margin-bottom: 10px; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .progress-bar-container {
            width: 100%; height: 10px;
            background-color: var(--feature-projects-progress-bar-bg); /* Use variable */
            border-radius: 5px; overflow: hidden; margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .progress-bar {
            height: 100%; background-color: var(--feature-projects-primary-color); /* Use variable */
            border-radius: 5px; transition: width 0.4s ease, background-color 0.3s ease;
            text-align: center; color: var(--feature-projects-primary-text); /* Use variable */
            font-size: 0.75em; font-weight: 500; line-height: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        #featureSectionsContainer.projects-feature .status-completed ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-success-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .status-in-progress ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-warning-progress); color: var(--feature-projects-warning-btn-text); }
        #featureSectionsContainer.projects-feature .status-active ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-info-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .status-pending ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-secondary-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .project-info {
            font-size: 0.9em; color: var(--feature-projects-text-muted); /* Use variable */
            margin-bottom: 12px; line-height: 1.6; display: flex;
            align-items: flex-start; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-info i {
            margin-right: 10px; color: var(--feature-projects-text-muted); /* Use variable */
            width: 18px; text-align: center; margin-top: 3px; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-participants span {
            display: inline-block;
            background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); /* Mix color for tag */
            color: var(--feature-projects-text-color); /* Use variable */
            padding: 4px 10px; border-radius: 15px; font-size: 0.8em;
            margin-right: 6px; margin-bottom: 6px; white-space: nowrap;
            border: 1px solid var(--feature-projects-border-color); /* Use variable */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-participants .participant-list { flex: 1; }
        #featureSectionsContainer.projects-feature .project-status {
            display: inline-block; padding: 6px 14px; border-radius: 15px;
            font-size: 0.8em; font-weight: 600; text-transform: uppercase;
            margin-bottom: 15px; align-self: flex-start;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        #featureSectionsContainer.projects-feature .project-actions {
            margin-top: auto; padding-top: 15px;
            border-top: 1px solid var(--feature-projects-border-color); /* Use variable */
            display: flex; gap: 10px; transition: border-color 0.3s ease;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }
        #featureSectionsContainer.projects-feature .project-actions .btn {
            /* Use dashboard .btn styles */
            font-size: 0.85em;
        }
        #featureSectionsContainer.projects-feature .project-actions .btn i { font-size: 0.9em; }
        #featureSectionsContainer.projects-feature .btn-view { background-color: var(--feature-projects-primary-color); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .btn-view:hover { background-color: var(--feature-projects-primary-hover); }
        #featureSectionsContainer.projects-feature .btn-edit { background-color: var(--feature-projects-warning-progress); color: var(--feature-projects-warning-btn-text); }
        #featureSectionsContainer.projects-feature .btn-edit:hover { background-color: color-mix(in srgb, var(--feature-projects-warning-progress) 90%, black 10%); }
        #featureSectionsContainer.projects-feature .btn-delete { background-color: var(--feature-projects-danger-color); color: var(--feature-projects-danger-text); }
        #featureSectionsContainer.projects-feature .btn-delete:hover { background-color: var(--feature-projects-danger-hover); }
        #featureSectionsContainer.projects-feature .btn:disabled,
        #featureSectionsContainer.projects-feature .btn[disabled] {
            opacity: 0.5; cursor: not-allowed; box-shadow: none;
            background-color: var(--feature-projects-secondary-progress);
            color: var(--feature-projects-secondary-text);
        }
         /* --- END: Adapted Projects Styles --- */


        /* --- File Sharing Specific Styles (Scoped & Mapped) --- */
        /* Apply only when file-sharing feature is active */
        #featureSectionsContainer.file-sharing-feature .card {
            border: none; /* Remove default card border */
            border-radius: 0.5rem; /* Softer border radius */
            box-shadow: 0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06); /* Match dashboard shadow */
            background-color: var(--white); /* Use dashboard variable */
            margin-bottom: 1.5rem; /* Add some bottom margin */
        }
        #featureSectionsContainer.file-sharing-feature .card-header {
             background-color: var(--white); /* Use dashboard variable */
             border-bottom: 1px solid var(--light-gray); /* Use dashboard variable */
             padding: 0.75rem 1.25rem;
        }
        #featureSectionsContainer.file-sharing-feature .fancy-header-title {
            background: var(--feature-file-sharing-header-bg); /* Use specific var */
            color: white;
            padding: 10px 20px; /* Increased padding */
            border-radius: 50px;
            display: inline-block;
            font-weight: 600;
            font-size: 1.1rem; /* Slightly larger */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        #featureSectionsContainer.file-sharing-feature .fancy-header-title:hover {
            transform: scale(1.02); /* Subtle hover effect */
        }
        #featureSectionsContainer.file-sharing-feature .card-header .d-flex {
            align-items: center;
        }
        #featureSectionsContainer.file-sharing-feature .file-icon {
            font-size: 1.6rem; /* Slightly larger icons */
            vertical-align: middle;
            margin-right: 10px;
            width: 25px; /* Fixed width for alignment */
            text-align: center;
        }
        /* Specific Icon Colors - Use dashboard variables */
        #featureSectionsContainer.file-sharing-feature .file-icon.text-danger { color: var(--danger) !important; }
        #featureSectionsContainer.file-sharing-feature .file-icon.text-success { color: var(--success) !important; }
        #featureSectionsContainer.file-sharing-feature .file-icon.text-warning { color: var(--warning) !important; }
        #featureSectionsContainer.file-sharing-feature .file-icon.text-primary { color: var(--primary) !important; } /* For Docs etc */
        #featureSectionsContainer.file-sharing-feature .file-icon.text-info { color: var(--info) !important; } /* For other types */
        #featureSectionsContainer.file-sharing-feature .action-buttons .btn {
            margin: 0 3px; /* Slightly more space */
            transition: all 0.2s ease-in-out;
            border-radius: 50px; /* Pill shape buttons */
            padding: 0.25rem 0.6rem; /* Adjust padding */
            font-size: 0.8rem; /* Slightly smaller icon buttons */
        }
         #featureSectionsContainer.file-sharing-feature .action-buttons .btn:hover {
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         /* Loading spinner style */
        #featureSectionsContainer.file-sharing-feature .action-btn .loading-spinner { display: none; margin: 0 2px; }
        #featureSectionsContainer.file-sharing-feature .action-btn.loading .original-icon { display: none; }
        #featureSectionsContainer.file-sharing-feature .action-btn.loading .loading-spinner { display: inline-block; }
         /* Filters Area */
        #featureSectionsContainer.file-sharing-feature .filters-section {
            background-color: var(--white); /* Use dashboard variable */
            padding: 1rem 1.25rem;
            border-radius: 0.375rem;
            border: 1px solid var(--light-gray); /* Use dashboard variable */
            margin-bottom: 1.5rem; /* More space below filters */
        }
        #featureSectionsContainer.file-sharing-feature .filters-section .form-label {
            font-size: 0.8rem;
            color: var(--secondary); /* Use dashboard variable */
            margin-bottom: 0.25rem;
        }
        #featureSectionsContainer.file-sharing-feature .filters-section .form-control-sm,
        #featureSectionsContainer.file-sharing-feature .filters-section .form-select-sm {
             font-size: 0.875rem;
        }
         /* Recent Uploads */
        #featureSectionsContainer.file-sharing-feature #recentUploadsSection {
            background-color: var(--white); /* Use dashboard variable */
            border: 1px solid var(--light-gray); /* Use dashboard variable */
            border-radius: 0.375rem;
            padding: 1rem 1.25rem;
        }
        #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 {
            color: var(--primary); /* Use dashboard variable */
            margin-bottom: 10px;
            font-weight: 600;
        }
        #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item {
             border-bottom: 1px dashed #eee !important;
             padding: 8px 0 !important;
             background-color: transparent !important; /* Ensure bg is transparent */
             border-top: none !important; border-left: none !important; border-right: none !important;
             color: var(--text-color); /* Ensure text color */
        }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item:last-child { border-bottom: 0 !important; }
        #featureSectionsContainer.file-sharing-feature .time-ago {
            font-style: normal; /* Removed italic */
            font-size: 0.85em;
            color: var(--secondary); /* Softer color */
        }
        /* Table Styling */
        #featureSectionsContainer.file-sharing-feature .table {
            margin-bottom: 0; /* Remove default bottom margin if inside card body */
             background-color: var(--white); /* Ensure table bg is white */
        }
        #featureSectionsContainer.file-sharing-feature .table thead {
             background-color: var(--light) !important; /* Use dashboard light variable */
             color: var(--secondary); /* Use dashboard secondary variable */
             text-transform: uppercase;
             font-size: 0.75rem;
             letter-spacing: 0.5px;
             border-bottom: 2px solid var(--light-gray); /* Use dashboard variable */
        }
        #featureSectionsContainer.file-sharing-feature .table tbody tr td {
             vertical-align: middle;
             padding: 0.85rem 0.75rem; /* Adjust padding */
             border-bottom: 1px solid var(--light-gray) !important; /* Ensure border color */
             border-top: none !important; /* Remove Bootstrap's default top border */
             color: var(--text-color); /* Ensure text color */
        }
             /* Remove top border from first row */
            #featureSectionsContainer.file-sharing-feature .table tbody tr:first-child td {
                 border-top: none !important;
             }

        #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * {
             background-color: var(--feature-file-sharing-hover-bg) !important; /* Use specific var */
             cursor: default; /* Indicate row isn't clickable unless intended */
        }
        #featureSectionsContainer.file-sharing-feature .file-name {
            font-weight: 500;
            color: var(--dark); /* Use dashboard dark */
        }
        /* Badge Styling - Use Bootstrap text-bg-* for better contrast */
        #featureSectionsContainer.file-sharing-feature .badge {
             font-size: 0.75em;
             padding: 0.35em 0.6em;
             font-weight: 500;
        }
        /* Upload Area */
        #featureSectionsContainer.file-sharing-feature .upload-area {
            border: 2px dashed var(--primary); /* Use dashboard primary */
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            background-color: var(--light); /* Use dashboard light */
            border-radius: 8px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        #featureSectionsContainer.file-sharing-feature .upload-area:hover {
            background-color: var(--feature-file-sharing-hover-bg); /* Use specific var */
            border-color: color-mix(in srgb, var(--primary) 90%, black 10%); /* Slightly darker primary */
        }
        #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary); } /* Use dashboard primary */

        /* Progress Bar Status Colors */
        #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar { background-color: var(--primary); } /* Default */
        #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-success { background-color: var(--success) !important; }
        #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-danger { background-color: var(--danger) !important; }
        /* SweetAlert Customization */
        .swal2-popup { font-size: 0.9rem !important; } /* Keep this general adjustment */
        /* Scoped SweetAlert button colors only for file sharing */
         #featureSectionsContainer.file-sharing-feature .swal2-popup { background-color: var(--white); color: var(--text-color); border: 1px solid var(--light-gray);}
         #featureSectionsContainer.file-sharing-feature .swal2-title { color: var(--text-color);}
         #featureSectionsContainer.file-sharing-feature .swal2-html-container { color: var(--gray);}
        #featureSectionsContainer.file-sharing-feature .swal2-confirm { background-color: var(--success) !important; }
        #featureSectionsContainer.file-sharing-feature .swal2-cancel { background-color: var(--danger) !important; }
         /* Dark Mode Scoped SweetAlert */
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-popup { background-color: var(--light) !important; color: var(--text-color) !important; border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-title { color: var(--text-color) !important; }
         body.dark-theme #featureSectionsContainer.file-sharing-feature .swal2-html-container { color: var(--gray) !important; }


    </style>
</head>
<!-- Apply theme class from localStorage -->
<body class=""> <!-- Start with no specific theme, JS will apply -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle (Visible on smaller screens) -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Success/Toast message container -->
    <div class="toast" id="toastMessage">Toast message</div>
    <!-- Success message (Specific style from original) -->
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
            <!-- Optional: Close button inside sidebar for mobile -->
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none; background: none; border: none; color: white; font-size: 1.2rem; position: absolute; top: 1.5rem; right: 1rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <!-- Sidebar items remain the same, ensure data-feature attributes are correct -->
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>

             <div class="menu-title">Core Features</div>
             <!-- !!! ADDED File Sharing Menu Item !!! -->
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-folder-open"></i><span>File Sharing</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>

             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span>
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults">
                    <!-- Search results will be populated here -->
                 </div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer"> <!-- Added ID for event delegation -->
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status">  Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button - Text dynamically updated -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section"> <!-- No 'active' initially -->
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <!-- Stat cards will be populated by JS -->
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <!-- Button hidden, click avatar instead -->
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline-secondary" id="cancelProfileBtn">Cancel</button> <!-- Use Bootstrap outline -->
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <!-- Tabs remain the same -->
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                     <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light">
                                     <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div>
                                     <span class="theme-label">Light</span>
                                 </div>
                                 <div class="theme-option" data-theme="dark">
                                     <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div>
                                     <span class="theme-label">Dark</span>
                                 </div>
                                 <div class="theme-option" data-theme="system">
                                    <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div>
                                    <span class="theme-label">System</span>
                                 </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div>
                                <span class="setting-item-label">High Contrast Mode</span>
                                <p class="setting-item-description">Increase text visibility for accessibility.</p>
                            </div>
                            <div class="setting-item-control">
                                <label class="switch">
                                    <input type="checkbox" id="highContrastToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Reuse data-form for layout -->
                             <div class="form-group">
                                 <label for="languageSelect">Language</label>
                                 <select id="languageSelect" class="form-select"> <!-- Use form-select -->
                                     <option value="en">English (US)</option>
                                     <option value="ar"> (Arabic)</option>
                                     <option value="es">Espaol (Spanish)</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="regionSelect">Region / Timezone</label>
                                 <select id="regionSelect" class="form-select"> <!-- Use form-select -->
                                     <option value="utc">UTC</option>
                                     <option value="est">EST (UTC-5)</option>
                                     <option value="pst">PST (UTC-8)</option>
                                     <option value="cet">CET (UTC+1)</option>
                                     <option value="eet">EET (UTC+2)</option>
                                     <option value="ast">AST (UTC+3) - Riyadh</option>
                                 </select>
                             </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                 <label for="timeFormatSelect">Time Format</label>
                                 <select id="timeFormatSelect" class="form-select"> <!-- Use form-select -->
                                     <option value="12h">12-hour (e.g., 3:00 PM)</option>
                                     <option value="24h">24-hour (e.g., 15:00)</option>
                                 </select>
                             </div>
                              <div class="form-group">
                                 <label for="dateFormatSelect">Date Format</label>
                                 <select id="dateFormatSelect" class="form-select"> <!-- Use form-select -->
                                     <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                     <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                     <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                     <option value="Month D, YYYY">Month D, YYYY</option>
                                 </select>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Toast Notifications</span>
                                 <p class="setting-item-description">Show brief confirmation messages for actions.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="toastToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Sound Notifications</span>
                                 <p class="setting-item-description">Play a sound for new notifications and activities.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="soundToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="form-group">
                             <label for="notificationToneSelect">Notification Tone</label>
                             <select id="notificationToneSelect" class="form-select" disabled> <!-- Use form-select, Disabled for now -->
                                 <option value="default">Default</option>
                                 <option value="tone1">Tone 1 (Placeholder)</option>
                                 <option value="tone2">Tone 2 (Placeholder)</option>
                             </select>
                             <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p>
                         </div>
                         <div class="form-group">
                             <label class="settings-label">Keyboard Shortcuts</label>
                             <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p>
                             <button class="btn btn-outline-secondary btn-sm" disabled>View Shortcuts</button> <!-- Use BS outline -->
                         </div>
                     </div>

                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                     <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group">
                                 <label for="accountEmail">Current Email</label>
                                 <input type="email" id="accountEmail" class="form-control" value="" readonly>
                             </div>
                             <div class="form-group">
                                <label for="changeEmail">New Email Address</label>
                                <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <!-- Keep disabled, needs backend -->
                                <p class="setting-item-description">Changing email requires backend verification.</p>
                            </div>
                             <div class="form-group" style="grid-column: span 2;">
                                <label for="accountConfirmPassword">Confirm Password (to change email)</label>
                                <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> <!-- Keep disabled -->
                            </div>
                            <div class="form-actions" style="grid-column: span 2;">
                                <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> <!-- Keep disabled -->
                            </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Account Notifications</span>
                                 <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="accountNotificationsToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                     <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group">
                                 <label for="currentPassword">Current Password</label>
                                 <input type="password" id="currentPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="newPassword">New Password</label>
                                 <input type="password" id="newPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="confirmPassword">Confirm New Password</label>
                                 <input type="password" id="confirmPassword" class="form-control">
                             </div>
                             <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Change Password</button> <!-- Removed disabled -->
                             </div>
                         </form>
                     </div>

                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status d-flex align-items-center gap-2 mb-2"> <!-- Added display flex -->
                             <span class="status-indicator disabled" id="twoFaStatusIndicator" style="width: 10px; height: 10px; border-radius: 50%; display:inline-block; vertical-align: middle;"></span>
                             <span id="twoFaStatusText">2FA is currently Disabled</span>
                         </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>

                         <!-- Placeholder for 2FA Setup UI -->
                         <div id="twoFaSetupSection" style="display: block;"> <!-- Initially visible -->
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none;">
                                 <h5>Choose Setup Method:</h5>
                                 <div class="two-fa-actions d-flex gap-2 mb-3"> <!-- Added display flex -->
                                      <button class="btn btn-outline-secondary" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button>
                                      <button class="btn btn-outline-secondary" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button>
                                 </div>
                                 <!-- Authenticator App Setup -->
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p>
                                     <div class="qr-code-placeholder" style="width: 150px; height: 150px; border: 1px solid var(--light-gray); display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; color: var(--gray);">QR Code</div>
                                     <p>2. Enter the 6-digit code generated by your app below.</p>
                                     <div class="form-group">
                                        <label for="authCode">Verification Code</label>
                                        <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6" style="max-width: 150px;">
                                    </div>
                                     <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> <!-- Removed disabled -->
                                 </div>
                                  <!-- SMS Setup -->
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p>
                                     <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button>
                                     <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup">
                                        <label for="smsCode">SMS Verification Code</label>
                                        <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6" style="max-width: 150px;">
                                     </div>
                                     <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button>
                                 </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none;"> <!-- Visible when enabled -->
                              <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p>
                              <div class="two-fa-actions d-flex gap-2"> <!-- Added display flex -->
                                 <button class="btn btn-outline-secondary" disabled>View Recovery Codes</button> <!-- Keep disabled for demo -->
                                 <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="sessionDuration">Session Duration (minutes)</label>
                                <input type="number" id="sessionDuration" class="form-control" value="60" min="15">
                                <p class="setting-item-description">Set how long a login session remains active.</p>
                            </div>
                            <div class="form-group">
                                <label for="idleTimeout">Idle Timeout (minutes)</label>
                                <input type="number" id="idleTimeout" class="form-control" value="15" min="5">
                                <p class="setting-item-description">Automatically logout after inactivity.</p>
                            </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                             <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> <!-- Removed disabled -->
                         </div>
                     </div>

                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Email Notifications</span>
                                 <p class="setting-item-description">Receive summaries and important alerts via email.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="emailNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable In-App Notifications</span>
                                 <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="inAppNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <!-- Placeholder for Push Notifications -->
                          <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span>
                                 <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="pushNotificationsToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group">
                            <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label>
                            <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label>
                            <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label>
                            <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label>
                            <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label>
                            <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <!-- Placeholder for Priority Settings -->
                         <div class="form-group">
                            <label for="notificationPriority">Minimum Notification Priority</label>
                            <select id="notificationPriority" class="form-select" disabled> <!-- Use form-select -->
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                            <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p>
                         </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>


                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                     <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <div class="team-list" id="teamList"> <!-- Team List populated by JS --> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-select" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline-secondary" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                     <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn btn-outline-secondary" disabled><i class="fab fa-slack"></i> Connect Slack</button>
                            <button class="btn btn-outline-secondary" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button>
                            <button class="btn btn-outline-secondary" disabled><i class="fab fa-github"></i> Connect GitHub</button>
                         </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Allow External Sharing Links</span>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="externalSharingToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <button class="btn btn-outline-secondary" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline-secondary" disabled>Set Default Permissions</button>
                     </div>
                 </div>


                 <!-- Danger Zone Panel -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3>
                     <p>These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item border p-3 rounded mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2"> <!-- Added styling -->
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p class="mb-0">This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item border p-3 rounded mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2"> <!-- Added styling -->
                         <div>
                            <h5>Delete Account</h5>
                            <p class="mb-0">Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for other feature sections (like Task Management, Scheduling etc) -->
             <div id="featureSectionsContainer" class="content-section"> <!-- No 'active' initially -->
                 <!-- Content loaded dynamically here -->
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications"></button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
                 <!-- Notifications populated by JS -->
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline-secondary btn-sm" id="markAllReadBtn">Mark All as Read</button> <!-- Use BS outline -->
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline-secondary" id="cancelConfirmBtn">Cancel</button> <!-- Use BS outline -->
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button> <!-- Default to danger, can be changed -->
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="memberModalTitle">Member Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group">
                         <label for="memberFirstName">First Name</label>
                         <input type="text" id="memberFirstName" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberLastName">Last Name</label>
                         <input type="text" id="memberLastName" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberEmail">Email</label>
                         <input type="email" id="memberEmail" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberRole">Role</label>
                         <select id="memberRole" class="form-select" required> <!-- Use form-select -->
                             <option value="member">Member</option>
                             <option value="supervisor">Supervisor</option>
                             <option value="senior">Senior</option>
                             <option value="admin">Admin</option>
                         </select>
                     </div>
                      <div class="form-group">
                         <label for="memberTitle">Job Title</label>
                         <input type="text" id="memberTitle" class="form-control">
                     </div>
                      <div class="form-group">
                         <label for="memberDepartment">Department</label>
                         <input type="text" id="memberDepartment" class="form-control">
                     </div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;"> <!-- Span full width -->
                     <button type="button" class="btn btn-outline-secondary" data-close-modal>Cancel</button> <!-- Use BS outline -->
                     <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Project Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;"> <!-- Single column for project form -->
                    <div class="form-group">
                         <label for="projectName">Project Name</label>
                         <input type="text" id="projectName" class="form-control" required>
                     </div>
                    <div class="form-group">
                         <label for="projectDescription">Description</label>
                         <textarea id="projectDescription" class="form-control" rows="3"></textarea>
                     </div>
                     <div class="form-group">
                         <label for="projectParticipantsInput">Participants (Separate with | )</label>
                         <input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S.">
                     </div>
                    <div class="form-group">
                        <label for="projectImageInput">Image URL (Optional)</label>
                        <input type="url" id="projectImageInput" class="form-control" placeholder="https://...">
                    </div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Nested grid for dates/status -->
                         <div class="form-group">
                            <label for="projectStartDate">Start Date</label>
                            <input type="date" id="projectStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="projectDueDate">Due Date</label>
                            <input type="date" id="projectDueDate" class="form-control">
                        </div>
                         <div class="form-group">
                             <label for="projectStatus">Status</label>
                             <select id="projectStatus" class="form-select" required> <!-- Use form-select -->
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                             </select>
                         </div>
                        <div class="form-group">
                            <label for="projectProgress">Progress (%)</label>
                            <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                        </div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <!-- Single column form actions -->
                     <button type="button" class="btn btn-outline-secondary" data-close-modal>Cancel</button> <!-- Use BS outline -->
                     <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ================================= -->
    <!-- TEMPLATES FOR DYNAMIC FEATURES    -->
    <!-- ================================= -->

    <!-- Container for Task Management CSS and JS -->
    <template id="taskManagementAssets">
        <style id="task-management-styles">
            /* --- PASTE CSS FROM task.txt HERE --- */
            #featureSectionsContainer.task-management-feature * { box-sizing: border-box; }
            #featureSectionsContainer.task-management-feature .task-management-content { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--white); color: var(--text-color); line-height: 1.6; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
            /* Dark mode adjustment for task content */
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: var(--light); }

            #featureSectionsContainer.task-management-feature .task-management-content .container { max-width: 1200px; margin: 0 auto; padding: 0; /* Remove extra padding */ }
            #featureSectionsContainer.task-management-feature .task-management-content h1 { color: var(--primary-dark); margin-bottom: 25px; text-align: center; font-weight: 600; }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content h1 { color: var(--primary); }

            #featureSectionsContainer.task-management-feature .task-management-content .btn { /* Use global .btn */ }
            #featureSectionsContainer.task-management-feature .task-management-content .btn i { font-size: 0.9em; }

            #featureSectionsContainer.task-management-feature .task-management-content .controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 30px; padding: 15px; background-color: var(--light); border-radius: 6px; gap: 15px; }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .controls { background-color: var(--primary-light); }

            #featureSectionsContainer.task-management-feature .task-management-content .search-container { position: relative; display: flex; align-items: center; flex-grow: 1; min-width: 200px; }
            #featureSectionsContainer.task-management-feature .task-management-content #search-input { /* Use global .form-control */ padding-right: 2.5rem; }
            #featureSectionsContainer.task-management-feature .task-management-content .search-icon { position: absolute; right: 12px; color: var(--gray); pointer-events: none; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters { display: flex; flex-wrap: wrap; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters select { /* Use global .form-select */ min-width: 150px; }

            #featureSectionsContainer.task-management-feature .task-management-content .task-list { margin-top: 20px; display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
            #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { text-align: center; color: var(--gray); padding: 40px 20px; font-size: 1.1em; background-color: var(--light); border-radius: 6px; grid-column: 1 / -1; }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { background-color: var(--primary-light); }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--white); border: 1px solid var(--light-gray); border-left: 5px solid var(--primary); border-radius: 6px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: box-shadow 0.3s ease, transform 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--light); border-color: var(--light-gray); border-left-color: var(--primary); }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); transform: translateY(-2px); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { font-size: 1.25em; margin-bottom: 10px; color: var(--primary-dark); word-break: break-word; }
             body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { color: var(--primary); }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card p { margin-bottom: 8px; color: var(--gray); font-size: 0.95em; word-break: break-word; line-height: 1.5; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: var(--gray); font-size: 0.9em; margin-bottom: 15px; max-height: 80px; overflow-y: auto; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: var(--text-color); min-width: 90px; display: inline-block; margin-right: 5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links { font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links span { display: inline-block; margin-right: 5px; margin-bottom: 3px; word-break: break-all; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: var(--primary); text-decoration: none; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a:hover { text-decoration: underline; }

            #featureSectionsContainer.task-management-feature .task-management-content .task-meta { font-size: 0.85em; color: var(--gray); margin-top: 15px; border-top: 1px solid var(--light-gray); padding-top: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta > div { display: flex; flex-wrap: wrap; gap: 5px 15px; margin-bottom: 5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta span { white-space: nowrap; }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-High { border-left-color: var(--danger); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Medium { border-left-color: var(--warning); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Low { border-left-color: var(--success); }

            #featureSectionsContainer.task-management-feature .task-management-content .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; color: white; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; }
            #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); color: #333;}
             body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); }
            #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: var(--info); }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: var(--primary); }
            #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: var(--success); }

            #featureSectionsContainer.task-management-feature .task-management-content .overdue-indicator { color: var(--danger); font-weight: bold; margin-left: 5px; font-size: 0.9em; }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--light); border-left-color: var(--gray); }
             body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }

            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3 { color: var(--gray); text-decoration: line-through; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta { color: var(--gray); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--text-color); }
             body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--gray); }

            #featureSectionsContainer.task-management-feature .task-management-content .task-actions { margin-top: 15px; text-align: right; border-top: 1px solid var(--light-gray); padding-top: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { background: none; border: none; font-size: 1.2em; padding: 5px 8px; margin-left: 10px; vertical-align: middle; color: var(--gray); cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button:hover { transform: scale(1.1); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: var(--primary); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: var(--danger); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn:hover { color: color-mix(in srgb, var(--danger) 80%, black 20%); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: var(--success); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn:hover { color: color-mix(in srgb, var(--success) 80%, black 20%); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: var(--warning); }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn:hover { color: color-mix(in srgb, var(--warning) 80%, black 20%); }

            #featureSectionsContainer.task-management-feature .modal { /* Use global .modal styles */ }
            #featureSectionsContainer.task-management-feature .modal-content { /* Use global .modal-content styles */ max-width: 650px; }
            #featureSectionsContainer.task-management-feature .modal-content .close-btn { /* Use global .close-modal */ }
            #featureSectionsContainer.task-management-feature .modal-content #modal-title { /* Use global .modal-title */ }
            #featureSectionsContainer.task-management-feature .modal-content #task-form { margin-top: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-group { /* Use global .form-group */ }
            #featureSectionsContainer.task-management-feature .modal-content .form-group label { /* Use global .form-group label */ }
            #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="text"],
            #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="date"],
            #featureSectionsContainer.task-management-feature .modal-content #task-form textarea,
            #featureSectionsContainer.task-management-feature .modal-content #task-form select { /* Use global .form-control / .form-select */ }
            #featureSectionsContainer.task-management-feature .modal-content #task-form textarea { resize: vertical; min-height: 80px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row > div { flex: 1; min-width: 200px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-actions { /* Use global .form-actions */ }
             /* --- END OF PASTED CSS --- */
        </style>
        <script>
            // --- PASTE JS LOGIC FROM task.txt HERE (will be wrapped) ---
            function initializeTaskManagementFeature(container) {
                 // --- DOM Elements ---
                const taskContentContainer = container.querySelector('.task-management-content');
                if (!taskContentContainer) { console.error("Task Management content container not found!"); return { cleanup: () => {} }; }
                const addTaskBtn = taskContentContainer.querySelector('#add-task-btn');
                // *** IMPORTANT: Find modal relative to the *document body* or a known static parent,
                // *** because it's likely appended there by Bootstrap, not inside the container.
                // *** Let's assume the modal HTML exists outside the template for now.
                // *** If modal HTML IS inside the template, we need to ensure Bootstrap targets THAT specific modal.
                // *** For now, let's use a global ID assumption and see if it works.
                const taskModal = document.getElementById('task-modal'); // Assume global modal ID temporarily
                const closeModalBtn = taskModal?.querySelector('.close-btn');
                const cancelBtn = taskModal?.querySelector('#cancel-btn'); // Find cancel within modal
                const taskForm = taskModal?.querySelector('#task-form'); // Find form within modal
                const taskListDiv = taskContentContainer.querySelector('#task-list');
                const modalTitle = taskModal?.querySelector('#modal-title');
                const saveTaskBtn = taskModal?.querySelector('#save-task-btn');
                const taskIdInput = taskModal?.querySelector('#task-id');
                const taskNameInput = taskModal?.querySelector('#task-name');
                const taskDescriptionInput = taskModal?.querySelector('#task-description');
                const taskLinksInput = taskModal?.querySelector('#task-links');
                const taskAssignedBySelect = taskModal?.querySelector('#task-assigned-by');
                const taskAssignedToSelect = taskModal?.querySelector('#task-assigned-to');
                const taskStartDateInput = taskModal?.querySelector('#task-start-date');
                const taskDueDateInput = taskModal?.querySelector('#task-due-date');
                const taskPrioritySelect = taskModal?.querySelector('#task-priority');
                const taskStatusSelect = taskModal?.querySelector('#task-status');
                const searchInput = taskContentContainer.querySelector('#search-input');
                const filterStatusSelect = taskContentContainer.querySelector('#filter-status');
                const filterPrioritySelect = taskContentContainer.querySelector('#filter-priority');
                const filterAssignedToSelect = taskContentContainer.querySelector('#filter-assigned-to');

                 // Add null checks for robustness
                 if (!addTaskBtn || !taskModal || !closeModalBtn || !taskListDiv || !taskForm || !modalTitle || !saveTaskBtn || !taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect || !searchInput || !filterStatusSelect || !filterPrioritySelect || !filterAssignedToSelect || !cancelBtn) {
                    console.error("Essential Task Management elements missing within the loaded feature container or its modal.");
                    return { cleanup: () => {} };
                 }
                 // Get Bootstrap Modal instance AFTER ensuring the element exists
                const bsTaskModal = bootstrap.Modal.getOrCreateInstance(taskModal);


                let tasks = []; let boundCloseOnEscape = null; let boundCloseOnOutsideClick = null; let boundFormSubmit = null; let boundAddClick = null; let boundSearchInput = null; let boundFilterChange = null; let boundTaskListClick = null;

                const loadTasks = () => { const storedTasks = localStorage.getItem('dashboard_tasks'); if (storedTasks) { try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); } } else { tasks = getDefaultTasks(); } renderTasks(); };
                function getDefaultTasks() { return [ { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure the base project structure.", links: "https://nodejs.org, project-docs/setup.md", assignedBy: "Nada", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null }, { id: 2, name: "Design UI Mockups", description: "Create mockups for main dashboard pages using Figma.", links: "https://figma.com/file/xyz", assignedBy: "Yousef", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs for user authentication and task management.", links: "api-docs/v1", assignedBy: "Self Assigned", assignedTo: "Yousef", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides and demo script for the upcoming client meeting.", links: "shared-drive/client-meeting-july", assignedBy: "Nada", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null }, { id: 5, name: "Review Code Submission", description: "Review the 'feature/login' branch pull request on GitHub.", links: "https://github.com/org/repo/pull/42, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" }, { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Users unable to login using special characters in password field. Investigate and resolve.", links: "jira-123", assignedBy: "Yousef", assignedTo: "Yousef", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } ]; }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };
                const formatDate = (dateString) => { if (!dateString) return 'N/A'; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) return 'Invalid Date'; const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; const timeFormat = localStorage.getItem('timeFormat') || '12h'; const year = date.getFullYear(); const month = date.getMonth() + 1; const day = date.getDate(); const monthPadded = String(month).padStart(2, '0'); const dayPadded = String(day).padStart(2, '0'); const monthName = date.toLocaleDateString(undefined, { month: 'short' }); switch (dateFormat) { case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`; case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`; case 'Month D, YYYY': return `${monthName} ${day}, ${year}`; case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`; } } catch (e) { console.error("Error formatting date:", e); return 'Invalid Date'; } };
                const getCurrentDate = () => { return new Date().toLocaleDateString('en-CA'); };
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T00:00:00Z'); const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); if (isNaN(dueDate.getTime())) return false; return dueDate < todayUTC; } catch(e) { console.error("Error checking overdue:", e); return false; } };
                const renderTasks = () => { if (!taskListDiv) return; taskListDiv.innerHTML = ''; const searchTerm = searchInput ? searchInput.value.toLowerCase() : ''; const statusFilter = filterStatusSelect ? filterStatusSelect.value : 'all'; const priorityFilter = filterPrioritySelect ? filterPrioritySelect.value : 'all'; const assignedToFilter = filterAssignedToSelect ? filterAssignedToSelect.value : 'all'; let tasksToDisplay = tasks.filter(task => { const taskStatus = task.status || ''; const taskPriority = task.priority || ''; const taskAssignedTo = task.assignedTo || ''; const statusMatch = statusFilter === 'all' || taskStatus === statusFilter; const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter; const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter; return statusMatch && priorityMatch && assignedToMatch; }); if (searchTerm) { tasksToDisplay = tasksToDisplay.filter(task => { const nameMatch = (task.name || '').toLowerCase().includes(searchTerm); const descMatch = (task.description || '').toLowerCase().includes(searchTerm); const linksMatch = (task.links || '').toLowerCase().includes(searchTerm); const assignedToMatch = (task.assignedTo || '').toLowerCase().includes(searchTerm); const assignedByMatch = (task.assignedBy || '').toLowerCase().includes(searchTerm); return nameMatch || descMatch || linksMatch || assignedToMatch || assignedByMatch; }); } if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks">No tasks found.</p>'; return; } tasksToDisplay.sort((a, b) => { const statusOrder = { "Pending": 1, "In Progress": 1, "Completed": 2 }; const statusA = statusOrder[a.status] || 3; const statusB = statusOrder[b.status] || 3; if (statusA !== statusB) return statusA - statusB; const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00Z') : null; const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00Z') : null; const dateValA = dateA && !isNaN(dateA) ? dateA.getTime() : Infinity; const dateValB = dateB && !isNaN(dateB) ? dateB.getTime() : Infinity; if (dateValA !== dateValB) return dateValA - dateValB; const priorityOrder = { High: 3, Medium: 2, Low: 1 }; const priorityA = priorityOrder[a.priority] || 0; const priorityB = priorityOrder[b.priority] || 0; return priorityB - priorityA; }); tasksToDisplay.forEach(task => { const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue'); const overdue = isOverdue(task); const overdueText = overdue ? `<span class="overdue-indicator">(Overdue!)</span>` : ''; let linksHTML = 'N/A'; if (task.links && task.links.trim()) { linksHTML = task.links.split(',').map(l => l.trim()).filter(l => l).map(link => { let href = link; let isUrl = false; try { const url = new URL(link.startsWith('http') ? link : `http://${link}`); if(url.hostname && (url.hostname.includes('.') || url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))) { isUrl = true; href = url.protocol + "//" + url.hostname + url.pathname + url.search + url.hash; } else { href = link; } } catch (_) { isUrl = false; href = link; } const displayText = link.length > 35 ? link.substring(0, 32) + '...' : link; return isUrl ? `<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>` : `<span title="${link}">${displayText}</span>`; }).join(' '); } taskCard.innerHTML = `<h3>${task.name || 'Unnamed'}</h3> ${task.description ? `<p class="description">${task.description}</p>` : ''} <p><strong>Links:</strong> <span class="links">${linksHTML}</span></p> <p><strong>By:</strong> ${task.assignedBy || 'N/A'}</p> <p><strong>To:</strong> ${task.assignedTo || 'N/A'}</p> <div class="task-meta"> <div> <span><strong>Start:</strong> ${formatDate(task.startDate)}</span> <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span> </div> <div> <span><strong>Priority:</strong> ${task.priority || 'N/A'}</span> <span><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${task.status || 'N/A'}</span></span> </div> ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''} </div> <div class="task-actions"> <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button> <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button> ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`} </div>`; taskListDiv.appendChild(taskCard); }); };
                 const showModal = () => { if (!bsTaskModal) return; bsTaskModal.show(); document.body.style.overflow = 'hidden'; }; // Changed to flex
                 const hideModal = () => { if (!bsTaskModal) return; bsTaskModal.hide(); if (taskForm) taskForm.reset(); if (taskIdInput) taskIdInput.value = ''; if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; document.body.style.overflow = ''; };
                 const openAddModal = () => { hideModal(); if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; if (taskStatusSelect) taskStatusSelect.value = "Pending"; if (taskPrioritySelect) taskPrioritySelect.value = "Medium"; showModal(); if (taskNameInput) taskNameInput.focus(); };
                const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task) { console.error("Task not found for edit:", id); return; }; hideModal(); if (modalTitle) modalTitle.textContent = "Edit Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Update Task"; taskIdInput.value = task.id; taskNameInput.value = task.name; taskDescriptionInput.value = task.description || ''; taskLinksInput.value = task.links || ''; taskAssignedBySelect.value = task.assignedBy; taskAssignedToSelect.value = task.assignedTo; taskStartDateInput.value = task.startDate || ''; taskDueDateInput.value = task.dueDate || ''; taskPrioritySelect.value = task.priority; taskStatusSelect.value = task.status; showModal(); taskNameInput.focus(); };
                 boundFormSubmit = (event) => { event.preventDefault(); const taskId = taskIdInput.value ? parseInt(taskIdInput.value) : Date.now(); const currentTask = tasks.find(t => t.id === taskId); const newStatus = taskStatusSelect.value; let completionDate = currentTask?.completionDate || null; if (newStatus === 'Completed') { if (!taskIdInput.value || (currentTask && currentTask.status !== 'Completed')) { completionDate = getCurrentDate(); } } else { completionDate = null; } const startDate = taskStartDateInput.value; const dueDate = taskDueDateInput.value; if (startDate && dueDate && new Date(dueDate) < new Date(startDate)) { alert("Due Date cannot be before Start Date."); taskDueDateInput.focus(); return; } const taskData = { id: taskId, name: taskNameInput.value.trim(), description: taskDescriptionInput.value.trim(), links: taskLinksInput.value.trim(), assignedBy: taskAssignedBySelect.value, assignedTo: taskAssignedToSelect.value, startDate: startDate || null, dueDate: dueDate || null, priority: taskPrioritySelect.value, status: newStatus, completionDate: completionDate }; if (!taskData.name) { alert("Task Name is required."); taskNameInput.focus(); return; } if (taskIdInput.value) { const index = tasks.findIndex(task => task.id === taskData.id); if (index > -1) { tasks[index] = taskData; } else { console.warn(`Task ${taskData.id} not found for edit.`); tasks.push(taskData); } } else { tasks.push(taskData); } saveTasks(); renderTasks(); hideModal(); };
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); if (confirm(`Delete task: "${taskToDelete?.name || id}"?`)) { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); } };
                const toggleTaskStatus = (id) => { tasks = tasks.map(task => { if (task.id === id) { if (task.status === 'Completed') { return { ...task, status: 'Pending', completionDate: null }; } else { return { ...task, status: 'Completed', completionDate: getCurrentDate() }; } } return task; }); saveTasks(); renderTasks(); };

                // --- Event Listener Binding ---
                 boundAddClick = openAddModal;
                 addTaskBtn.addEventListener('click', boundAddClick);
                 closeModalBtn.addEventListener('click', hideModal);
                 cancelBtn.addEventListener('click', hideModal);
                 taskForm.addEventListener('submit', boundFormSubmit);

                 // Close modal on outside click
                 boundCloseOnOutsideClick = (event) => { if (event.target === taskModal) { hideModal(); } };
                 taskModal.addEventListener('click', boundCloseOnOutsideClick); // Use the actual modal element

                 // Close modal on Escape key
                 boundCloseOnEscape = (event) => { if (event.key === 'Escape' && taskModal && taskModal.classList.contains('show')) { hideModal(); } }; // Check if modal is shown by BS
                 document.addEventListener('keydown', boundCloseOnEscape);

                 // Filters and Search
                 boundSearchInput = renderTasks;
                 boundFilterChange = renderTasks;
                 searchInput.addEventListener('input', boundSearchInput);
                 filterStatusSelect.addEventListener('change', boundFilterChange);
                 filterPrioritySelect.addEventListener('change', boundFilterChange);
                 filterAssignedToSelect.addEventListener('change', boundFilterChange);

                 // Task list click delegation
                 boundTaskListClick = (event) => {
                     const target = event.target;
                     const taskCard = target.closest('.task-card');
                     if (!taskCard) return;
                     const taskId = parseInt(taskCard.dataset.taskId);
                     if (target.closest('.edit-btn')) { event.stopPropagation(); openEditModal(taskId); }
                     else if (target.closest('.delete-btn')) { event.stopPropagation(); deleteTask(taskId); }
                     else if (target.closest('.complete-btn') || target.closest('.reopen-btn')) { event.stopPropagation(); toggleTaskStatus(taskId); }
                 };
                 taskListDiv.addEventListener('click', boundTaskListClick);


                // --- Initial Load ---
                loadTasks();

                // --- Cleanup Function ---
                const cleanup = () => {
                    console.log("Cleaning up Task Management listeners and resources...");
                    addTaskBtn?.removeEventListener('click', boundAddClick);
                    closeModalBtn?.removeEventListener('click', hideModal);
                    cancelBtn?.removeEventListener('click', hideModal);
                    taskForm?.removeEventListener('submit', boundFormSubmit);
                    taskModal?.removeEventListener('click', boundCloseOnOutsideClick);
                    document.removeEventListener('keydown', boundCloseOnEscape);
                    searchInput?.removeEventListener('input', boundSearchInput);
                    filterStatusSelect?.removeEventListener('change', boundFilterChange);
                    filterPrioritySelect?.removeEventListener('change', boundFilterChange);
                    filterAssignedToSelect?.removeEventListener('change', boundFilterChange);
                    taskListDiv?.removeEventListener('click', boundTaskListClick);

                    // Dispose Bootstrap modal instance if it exists
                    const taskModalInstance = bootstrap.Modal.getInstance(taskModal);
                    if (taskModalInstance) {
                        taskModalInstance.dispose();
                    }

                    // Ensure body scroll is restored if modal was open
                    document.body.style.overflow = '';
                    console.log("Task Management cleanup complete.");
                };

                 return { cleanup };
            }
            // --- END OF PASTED JS LOGIC ---
        </script>
    </template>

              "File Sharing".                .

```html
    <!-- !!! NEW: Template for File Sharing Feature !!! -->
    <template id="fileSharingAssets">
        <style id="file-sharing-styles">
            /* --- Scoped and Mapped File Sharing Styles --- */
            #featureSectionsContainer.file-sharing-feature {
                /* Add a wrapper div inside if needed for specific container styling */
                 padding: 0; /* Remove padding from the main container */
            }
             #featureSectionsContainer.file-sharing-feature .fs-content-wrapper {
                 /* Add padding here if needed, or rely on Bootstrap container */
                 padding: 1.5rem; /* Example padding */
             }

            #featureSectionsContainer.file-sharing-feature .card {
                border: none; /* Remove default card border */
                border-radius: 0.5rem; /* Softer border radius */
                box-shadow: 0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06); /* Match dashboard shadow */
                background-color: var(--white); /* Use dashboard variable */
                margin-bottom: 1.5rem; /* Add some bottom margin */
            }
            #featureSectionsContainer.file-sharing-feature .card-header {
                 background-color: var(--white); /* Use dashboard variable */
                 border-bottom: 1px solid var(--light-gray); /* Use dashboard variable */
                 padding: 0.75rem 1.25rem;
            }
            #featureSectionsContainer.file-sharing-feature .fancy-header-title {
                background: var(--feature-file-sharing-header-bg); /* Use specific var */
                color: white;
                padding: 10px 20px; /* Increased padding */
                border-radius: 50px;
                display: inline-block;
                font-weight: 600;
                font-size: 1.1rem; /* Slightly larger */
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                transition: transform 0.2s ease;
            }
            #featureSectionsContainer.file-sharing-feature .fancy-header-title:hover {
                transform: scale(1.02); /* Subtle hover effect */
            }
            #featureSectionsContainer.file-sharing-feature .card-header .d-flex {
                align-items: center;
            }
            #featureSectionsContainer.file-sharing-feature .file-icon {
                font-size: 1.6rem; /* Slightly larger icons */
                vertical-align: middle;
                margin-right: 10px;
                width: 25px; /* Fixed width for alignment */
                text-align: center;
            }
            /* Specific Icon Colors - Use dashboard variables */
            #featureSectionsContainer.file-sharing-feature .file-icon.text-danger { color: var(--danger) !important; }
            #featureSectionsContainer.file-sharing-feature .file-icon.text-success { color: var(--success) !important; }
            #featureSectionsContainer.file-sharing-feature .file-icon.text-warning { color: var(--warning) !important; }
            #featureSectionsContainer.file-sharing-feature .file-icon.text-primary { color: var(--primary) !important; } /* For Docs etc */
            #featureSectionsContainer.file-sharing-feature .file-icon.text-info { color: var(--info) !important; } /* For other types */

            #featureSectionsContainer.file-sharing-feature .action-buttons .btn {
                margin: 0 3px; /* Slightly more space */
                transition: all 0.2s ease-in-out;
                border-radius: 50px; /* Pill shape buttons */
                padding: 0.25rem 0.6rem; /* Adjust padding */
                font-size: 0.8rem; /* Slightly smaller icon buttons */
            }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn:hover {
                transform: translateY(-2px); /* Lift effect */
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
             }
             /* Loading spinner style */
            #featureSectionsContainer.file-sharing-feature .action-btn .loading-spinner { display: none; margin: 0 2px; }
            #featureSectionsContainer.file-sharing-feature .action-btn.loading .original-icon { display: none; }
            #featureSectionsContainer.file-sharing-feature .action-btn.loading .loading-spinner { display: inline-block; }
             /* Filters Area */
            #featureSectionsContainer.file-sharing-feature .filters-section {
                background-color: var(--white); /* Use dashboard variable */
                padding: 1rem 1.25rem;
                border-radius: 0.375rem;
                border: 1px solid var(--light-gray); /* Use dashboard variable */
                margin-bottom: 1.5rem; /* More space below filters */
            }
            #featureSectionsContainer.file-sharing-feature .filters-section .form-label {
                font-size: 0.8rem;
                color: var(--secondary); /* Use dashboard variable */
                margin-bottom: 0.25rem;
            }
            #featureSectionsContainer.file-sharing-feature .filters-section .form-control-sm,
            #featureSectionsContainer.file-sharing-feature .filters-section .form-select-sm {
                 font-size: 0.875rem;
            }
             /* Recent Uploads */
            #featureSectionsContainer.file-sharing-feature #recentUploadsSection {
                background-color: var(--white); /* Use dashboard variable */
                border: 1px solid var(--light-gray); /* Use dashboard variable */
                border-radius: 0.375rem;
                padding: 1rem 1.25rem;
            }
            #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 {
                color: var(--primary); /* Use dashboard variable */
                margin-bottom: 10px;
                font-weight: 600;
            }
            #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item {
                 border-bottom: 1px dashed #eee !important;
                 padding: 8px 0 !important;
                 background-color: transparent !important; /* Ensure bg is transparent */
                 border-top: none !important; border-left: none !important; border-right: none !important;
                 color: var(--text-color); /* Ensure text color */
            }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item:last-child { border-bottom: 0 !important; }
            #featureSectionsContainer.file-sharing-feature .time-ago {
                font-style: normal; /* Removed italic */
                font-size: 0.85em;
                color: var(--secondary); /* Softer color */
            }
            /* Table Styling */
            #featureSectionsContainer.file-sharing-feature .table {
                margin-bottom: 0; /* Remove default bottom margin if inside card body */
                 background-color: var(--white); /* Ensure table bg is white */
                 border-color: var(--light-gray); /* Ensure table border matches */
            }
            #featureSectionsContainer.file-sharing-feature .table thead {
                 background-color: var(--light) !important; /* Use dashboard light variable */
                 color: var(--secondary); /* Use dashboard secondary variable */
                 text-transform: uppercase;
                 font-size: 0.75rem;
                 letter-spacing: 0.5px;
                 border-bottom: 2px solid var(--light-gray); /* Use dashboard variable */
            }
             /* Explicitly set tbody border color */
            #featureSectionsContainer.file-sharing-feature .table > :not(caption) > * > * {
                 border-bottom-width: 1px;
                 border-color: var(--light-gray);
             }

            #featureSectionsContainer.file-sharing-feature .table tbody tr td {
                 vertical-align: middle;
                 padding: 0.85rem 0.75rem; /* Adjust padding */
                 /* border-bottom: 1px solid var(--light-gray) !important; Ensure border color - Removed, handled above */
                 border-top: none !important; /* Remove Bootstrap's default top border */
                 color: var(--text-color); /* Ensure text color */
            }
             /* Remove top border from first row */
            #featureSectionsContainer.file-sharing-feature .table tbody tr:first-child td {
                 border-top: none !important;
             }

            #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * {
                 background-color: var(--feature-file-sharing-hover-bg) !important; /* Use specific var */
                 cursor: default; /* Indicate row isn't clickable unless intended */
            }
            #featureSectionsContainer.file-sharing-feature .file-name {
                font-weight: 500;
                color: var(--dark); /* Use dashboard dark */
            }
            /* Badge Styling - Use Bootstrap text-bg-* for better contrast */
            #featureSectionsContainer.file-sharing-feature .badge {
                 font-size: 0.75em;
                 padding: 0.35em 0.6em;
                 font-weight: 500;
            }
            /* Upload Area */
            #featureSectionsContainer.file-sharing-feature .upload-area {
                border: 2px dashed var(--primary); /* Use dashboard primary */
                padding: 30px;
                text-align: center;
                margin-bottom: 20px;
                cursor: pointer;
                background-color: var(--light); /* Use dashboard light */
                border-radius: 8px;
                transition: background-color 0.2s ease, border-color 0.2s ease;
            }
            #featureSectionsContainer.file-sharing-feature .upload-area:hover {
                background-color: var(--feature-file-sharing-hover-bg); /* Use specific var */
                border-color: color-mix(in srgb, var(--primary) 90%, black 10%); /* Slightly darker primary */
            }
            #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary); } /* Use dashboard primary */

            /* Progress Bar Status Colors */
            #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar { background-color: var(--primary); } /* Default */
            #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-success { background-color: var(--success) !important; }
            #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-danger { background-color: var(--danger) !important; }
            /* SweetAlert Customization */
            /* SweetAlert Customization */
             .swal2-popup { font-size: 0.9rem !important; background-color: var(--white); color: var(--text-color); border: 1px solid var(--light-gray);}
             .swal2-title { color: var(--text-color);}
             .swal2-html-container { color: var(--gray);}
             .swal2-confirm { background-color: var(--success) !important; }
             .swal2-cancel { background-color: var(--danger) !important; }
             /* Dark Mode Scoped SweetAlert */
             body.dark-theme .swal2-popup { background-color: var(--light) !important; color: var(--text-color) !important; border-color: var(--light-gray); }
             body.dark-theme .swal2-title { color: var(--text-color) !important; }
             body.dark-theme .swal2-html-container { color: var(--gray) !important; }


             /* Dark Mode Adjustments for File Sharing */
             body.dark-theme #featureSectionsContainer.file-sharing-feature .card,
             body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section,
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table,
             body.dark-theme #featureSectionsContainer.file-sharing-feature .modal-content {
                 background-color: var(--light) !important;
                 border-color: var(--light-gray) !important;
                 color: var(--text-color) !important;
             }
            body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header {
                 background-color: var(--light) !important; border-bottom-color: var(--light-gray) !important;
             }
            body.dark-theme #featureSectionsContainer.file-sharing-feature .fancy-header-title { background: var(--primary) !important; }
            body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section .form-label { color: var(--gray) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 { color: var(--primary) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom-color: var(--light-gray) !important; color: var(--text-color) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name { color: var(--text-color) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .text-muted { color: var(--gray) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .time-ago { color: var(--gray) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table thead { background-color: var(--primary-light) !important; color: var(--gray) !important; border-bottom-color: var(--light-gray) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table tbody tr td { color: var(--text-color) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table > :not(caption) > * > * { border-color: var(--light-gray) !important; } /* Dark table borders */
             body.dark-theme #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--feature-file-sharing-hover-bg) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--primary-light) !important; border-color: var(--primary) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--light) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .progress { background-color: var(--light-gray) !important; }


             /* Responsive Table for File Sharing */
            @media (max-width: 768px) {
                 #featureSectionsContainer.file-sharing-feature .table thead { display: none; }
                 #featureSectionsContainer.file-sharing-feature .table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid var(--light-gray); border-radius: 0.375rem; padding: 0.5rem; background-color: var(--white); }
                 body.dark-theme #featureSectionsContainer.file-sharing-feature .table tbody tr { background-color: var(--light) !important; border-color: var(--light-gray); }
                 #featureSectionsContainer.file-sharing-feature .table tbody td { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.25rem; border: none !important; /* Remove all internal borders */ text-align: right; } /* Align right */
                 /* Add border back only between items */
                 #featureSectionsContainer.file-sharing-feature .table tbody td:not(:last-child) {
                     border-bottom: 1px dashed var(--light-gray) !important;
                 }
                 #featureSectionsContainer.file-sharing-feature .table tbody td::before { content: attr(data-label); font-weight: bold; margin-right: 1rem; color: var(--gray); text-align: left; /* Align label left */ flex-grow: 1; white-space: nowrap; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(1)::before { content: 'Type'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2)::before { content: 'File'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(3)::before { content: 'Date'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4)::before { content: 'Tags'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(5)::before { content: 'Uploader'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6)::before { content: 'Actions'; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) { flex-direction: column; align-items: flex-end; } /* Stack file name/size */
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) .file-name { width: 100%; text-align: right; word-break: break-all; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(2) small { margin-top: 0.25rem; width: 100%; text-align: right; }
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4) { flex-wrap: wrap; justify-content: flex-end; } /* Wrap tags */
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(4) .badge { margin-left: 2px; margin-bottom: 2px; } /* Stack badges */
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6) { padding-top: 0.8rem; padding-bottom: 0.8rem; } /* More padding for actions */
                 #featureSectionsContainer.file-sharing-feature .table tbody td:nth-child(6) .action-buttons { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 5px; }
             }
        </style>
        <!-- File Sharing HTML Content (Extracted from file) -->
        <div class="fs-content-wrapper"> <!-- Added wrapper -->
            <!-- Start File Sharing Component -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap"> <!-- Added flex-wrap -->
                     <h5 class="mb-0 fancy-header-title me-3"><i class="fas fa-folder-open me-2"></i>File Management</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#fsUploadFileModal"> <!-- Changed ID -->
                        <i class="fas fa-upload me-1"></i> Upload New File
                    </button>
                </div>

                <div class="card-body pt-3">
                    <!-- Filters Section -->
                    <div class="row filters-section gy-2 align-items-end">
                        <div class="col-md-4">
                             <label for="fsFileSearchInput" class="form-label">Search by Name</label> <!-- Changed ID -->
                            <div class="input-group input-group-sm search-input">
                                <input type="text" class="form-control form-control-sm" placeholder="Enter file name..." id="fsFileSearchInput"> <!-- Changed ID -->
                                 <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                        <div class="col-md-2">
                             <label for="fsFileTypeFilter" class="form-label">File Type</label> <!-- Changed ID -->
                             <select class="form-select form-select-sm" id="fsFileTypeFilter" title="Filter by Type"> <!-- Changed ID -->
                                <option value="" selected>All Types</option>
                                <option value="PDF">PDF</option>
                                <option value="Image">Image</option>
                                <option value="Video">Video</option>
                                <option value="Archive">Archive</option>
                                <option value="Document">Document</option>
                                <option value="Spreadsheet">Spreadsheet</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="fsUploadDateFilter" class="form-label">Upload Date</label> <!-- Changed ID -->
                            <input type="date" class="form-control form-control-sm" id="fsUploadDateFilter" title="Filter by Upload Date"> <!-- Changed ID -->
                        </div>
                        <div class="col-md-2" id="fsUserFilterContainer" style="display: none;"> <!-- Changed ID -->
                            <label for="fsUserFilter" class="form-label">Uploader</label> <!-- Changed ID -->
                             <select class="form-select form-select-sm" id="fsUserFilter" title="Filter by Uploader"> <!-- Changed ID -->
                                <option value="" selected>All Users</option>
                                <!-- User options populated by JS -->
                            </select>
                        </div>
                         <div class="col-md-1 text-end">
                            <button class="btn btn-sm btn-outline-secondary" id="fsResetFiltersBtn" title="Reset Filters"> <!-- Changed ID -->
                                <i class="fas fa-sync-alt"></i>
                            </button>
                         </div>
                    </div>

                    <!-- Recent Uploads Section -->
                    <div class="mb-4 p-3" id="recentUploadsSection">
                        <h6><i class="fas fa-history me-1"></i> Recent Uploads</h6>
                        <ul class="list-group list-group-flush" id="fsRecentUploadsList"> <!-- Added ID -->
                            <!-- Populated by JS -->
                            <li class="list-group-item"><span class="text-muted">Loading recent uploads...</span></li>
                        </ul>
                    </div>

                    <!-- Files Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 5%;">Type</th>
                                    <th scope="col" style="width: 30%;">File Name</th>
                                    <th scope="col" style="width: 18%;">Upload Date</th>
                                    <th scope="col" style="width: 17%;">Tags</th>
                                    <th scope="col" style="width: 15%;">Uploader</th>
                                    <th scope="col" class="text-center" style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fsFileTableBody"> <!-- Changed ID -->
                                <!-- Rows populated by JS -->
                                <tr id="fsNoResultsRow" style="display: none;"> <!-- Changed ID -->
                                     <td colspan="6" class="text-center text-muted fst-italic py-4">No files found matching your criteria.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination (Optional) -->
                    <nav aria-label="File list navigation" class="mt-3 d-flex justify-content-center">
                        <!-- Pagination placeholder -->
                    </nav>

                </div> <!-- End card-body -->
            </div> <!-- End card -->
            <!-- End File Sharing Component -->

             <!-- ========== Modals (Prefixed IDs - these need to be outside the feature container usually) ========== -->
             <!-- IMPORTANT: Modals are typically placed outside the main content flow, often near the end of <body>
                          to avoid z-index issues. We'll keep them here in the template for encapsulation,
                          but Bootstrap might move them. Ensure the JS targets them correctly. -->
             <!-- Modal: Upload New File -->
              <div class="modal fade" id="fsUploadFileModal" tabindex="-1" aria-labelledby="fsUploadFileModalLabel" aria-hidden="true">
                 <div class="modal-dialog">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title" id="fsUploadFileModalLabel"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New File</h5>
                             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                         </div>
                         <div class="modal-body">
                             <div class="upload-area" id="fsDropZone"> <!-- Changed ID -->
                                 <p><i class="fas fa-cloud-upload-alt fa-3x mb-2"></i></p>
                                 <p>Drag & drop files here or click to select</p>
                                 <input type="file" id="fsFileInputHidden" multiple hidden> <!-- Changed ID -->
                             </div>
                             <div class="mb-3">
                                 <label for="fsFileInputManual" class="form-label">Or select file(s):</label> <!-- Changed ID -->
                                 <input class="form-control form-control-sm" type="file" id="fsFileInputManual" multiple> <!-- Changed ID -->
                             </div>
                             <div class="mb-3">
                                 <label for="fsFileTagsInput" class="form-label"><i class="fas fa-tags me-1"></i>Add Tags (comma-separated):</label> <!-- Changed ID -->
                                 <input type="text" class="form-control form-control-sm" id="fsFileTagsInput" placeholder="e.g., reports, important, 2024"> <!-- Changed ID -->
                             </div>
                             <div id="fsUploadProgressContainer" class="mt-3" style="display: none;"> <!-- Changed ID -->
                                  <div class="d-flex justify-content-between">
                                     <small id="fsUploadFileName" class="text-muted">Uploading file...</small> <!-- Changed ID -->
                                     <small id="fsUploadPercentage" class="text-muted">0%</small> <!-- Changed ID -->
                                  </div>
                                 <div class="progress mt-1" style="height: 10px;">
                                     <div id="fsUploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div> <!-- Changed ID -->
                                 </div>
                                 <small id="fsUploadStatus" class="text-muted d-block mt-1"></small> <!-- Changed ID -->
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                             <button type="button" class="btn btn-sm btn-primary" id="fsStartUploadButton">Start Upload</button> <!-- Changed ID -->
                         </div>
                     </div>
                 </div>
             </div>

             <!-- Modal: File Preview -->
             <div class="modal fade" id="fsFilePreviewModal" tabindex="-1" aria-labelledby="fsFilePreviewModalLabel" aria-hidden="true"> <!-- Changed ID -->
                 <div class="modal-dialog modal-xl modal-dialog-centered">
                     <div class="modal-content">
                         <div class="modal-header">
                             <h5 class="modal-title" id="fsFilePreviewModalLabel">File Preview</h5> <!-- Changed ID -->
                             <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                         </div>
                         <div class="modal-body text-center" style="min-height: 400px; max-height: 80vh; overflow-y: auto;">
                             <div id="fsPreviewContent"> <!-- Changed ID -->
                                  <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                                     <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                                  </div>
                             </div>
                         </div>
                          <div class="modal-footer justify-content-start py-2">
                              <small class="text-muted me-3" id="fsPreviewFileName">File Name: </small> <!-- Changed ID -->
                              <small class="text-muted" id="fsPreviewFileType">Type: </small> <!-- Changed ID -->
                          </div>
                     </div>
                 </div>
             </div>

        </div> <!-- End fs-content-wrapper -->

        <script>
            // --- Encapsulated File Sharing JS ---
            function initializeFileSharingFeature(container) {
                console.log("Initializing File Sharing feature inside container:", container);

                // --- DOM Elements (Scoped to container's content) ---
                 const contentWrapper = container.querySelector('.fs-content-wrapper'); // Target the wrapper
                 if (!contentWrapper) {
                     console.error("File Sharing content wrapper (.fs-content-wrapper) not found!");
                     return { cleanup: () => {} };
                 }

                const fileTableBody = contentWrapper.querySelector('#fsFileTableBody');
                const fileSearchInput = contentWrapper.querySelector('#fsFileSearchInput');
                const fileTypeFilter = contentWrapper.querySelector('#fsFileTypeFilter');
                const uploadDateFilter = contentWrapper.querySelector('#fsUploadDateFilter');
                const userFilter = contentWrapper.querySelector('#fsUserFilter');
                const userFilterContainer = contentWrapper.querySelector('#fsUserFilterContainer');
                const noResultsRow = contentWrapper.querySelector('#fsNoResultsRow');
                const resetFiltersBtn = contentWrapper.querySelector('#fsResetFiltersBtn');
                const recentUploadsList = contentWrapper.querySelector('#fsRecentUploadsList');

                // Upload Modal Elements (Assume they are potentially moved by Bootstrap, search globally or relative to body if needed)
                 const uploadModalElement = document.getElementById('fsUploadFileModal'); // Search globally by ID
                 const uploadFileModal = uploadModalElement ? bootstrap.Modal.getOrCreateInstance(uploadModalElement) : null; // Use getOrCreateInstance
                 const startUploadButton = uploadModalElement?.querySelector('#fsStartUploadButton');
                 const uploadProgressContainer = uploadModalElement?.querySelector('#fsUploadProgressContainer');
                 const uploadProgressBar = uploadModalElement?.querySelector('#fsUploadProgressBar');
                 const uploadStatus = uploadModalElement?.querySelector('#fsUploadStatus');
                 const uploadFileName = uploadModalElement?.querySelector('#fsUploadFileName');
                 const uploadPercentage = uploadModalElement?.querySelector('#fsUploadPercentage');
                 const fileInputManual = uploadModalElement?.querySelector('#fsFileInputManual');
                 const fileInputHidden = uploadModalElement?.querySelector('#fsFileInputHidden');
                 const dropZone = contentWrapper.querySelector('#fsDropZone'); // Drop zone is inside content
                 const fileTagsInput = uploadModalElement?.querySelector('#fsFileTagsInput');

                 // Preview Modal Elements (Search globally)
                 const previewModalElement = document.getElementById('fsFilePreviewModal');
                 const filePreviewModal = previewModalElement ? bootstrap.Modal.getOrCreateInstance(previewModalElement) : null; // Use getOrCreateInstance
                 const previewContent = previewModalElement?.querySelector('#fsPreviewContent');
                 const previewFileName = previewModalElement?.querySelector('#fsPreviewFileName');
                 const previewFileType = previewModalElement?.querySelector('#fsPreviewFileType');


                 // Add null checks for crucial elements
                 if (!fileTableBody || !fileSearchInput || !fileTypeFilter || !uploadDateFilter || !userFilter || !userFilterContainer || !noResultsRow || !resetFiltersBtn || !recentUploadsList || !dropZone) {
                    console.error("Essential File Sharing elements are missing!");
                    return { cleanup: () => {} };
                 }
                 if (!uploadModalElement || !previewModalElement) {
                     console.warn("File Sharing modals not found. Upload/Preview might not work.");
                 }


                // --- State ---
                let mockFilesData = []; // Store file data locally for the feature
                let recentUploadsIntervalId = null;
                let boundFilterHandler = applyFilters; // Assign function directly
                let boundTableClickHandler = null;
                let boundUploadHandler = null;
                let boundPreviewHandler = null;
                let boundResetHandler = resetFilters;
                let boundDropZoneClick = null;
                let boundDropEvents = {};
                let boundManualFileChange = null;
                let boundModalHidden = null; // For preview modal cleanup

                 // --- Mock Data & Initial Setup ---
                 function generateMockFileData() {
                    // Use previously defined mock data generation logic
                    mockFilesData = [
                         { id: 1, name: 'Monthly Performance Report.pdf', size: '2.5 MB', uploadDate: '2024-05-25T10:30:00Z', type: 'PDF', tags: ['Reports', 'Monthly'], uploader: 'Mohamed Elmenisy', url: 'path/to/report.pdf' },
                         { id: 2, name: 'New Product Photo.jpg', size: '800 KB', uploadDate: '2024-05-24T15:15:00Z', type: 'Image', tags: ['Products', 'Design'], uploader: 'Nada Mahmoud', url: 'path/to/image.jpg' },
                         { id: 3, name: 'Project Resources.zip', size: '15.2 MB', uploadDate: '2024-05-23T09:00:00Z', type: 'Archive', tags: ['Project X'], uploader: 'Yousef Ahmed', url: 'path/to/archive.zip' },
                         { id: 4, name: 'Meeting Agenda.pdf', size: '150 KB', uploadDate: '2024-05-22T11:00:00Z', type: 'PDF', tags: ['Meetings'], uploader: 'Esraa Lashin', url: 'path/to/agenda.pdf' },
                         { id: 5, name: 'Team Photo.png', size: '1.2 MB', uploadDate: '2024-05-26T09:00:00Z', type: 'Image', tags: ['Team'], uploader: 'Bassant Badr', url: 'path/to/team.png' },
                         { id: 6, name: 'Quarterly_Report_Q1.pdf', size: '3.1 MB', uploadDate: new Date(Date.now() - 5 * 60 * 1000).toISOString(), type: 'PDF', tags: ['Reports', 'Quarterly'], uploader: 'Mohamed Elmenisy', url: 'path/to/q1_report.pdf' },
                         { id: 7, name: 'New_Company_Logo.png', size: '450 KB', uploadDate: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), type: 'Image', tags: ['Branding', 'Design'], uploader: 'Nada Mahmoud', url: 'path/to/new_logo.png' },
                         { id: 8, name: 'Final_Project_Assets.zip', size: '25.8 MB', uploadDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), type: 'Archive', tags: ['Project Y', 'Assets'], uploader: 'Yousef Ahmed', url: 'path/to/project_y.zip' },
                     ];
                     console.log("Generated Mock File Data:", mockFilesData);
                     populateUserFilter(); // Populate user filter after generating data
                     renderFileTable(); // Render table initially
                     renderRecentUploads(); // Render recent uploads
                 }

                function populateUserFilter() {
                     if (!userFilter) return;
                     const uploaders = [...new Set(mockFilesData.map(file => file.uploader))];
                     // Keep "All Users" option, clear others
                     userFilter.innerHTML = '<option value="" selected>All Users</option>';
                     uploaders.sort().forEach(uploader => {
                         const option = document.createElement('option');
                         option.value = uploader;
                         option.textContent = uploader;
                         userFilter.appendChild(option);
                     });
                 }

                // --- Rendering Functions ---
                 function renderFileTable() {
                     if (!fileTableBody) { console.error("File table body not found"); return; }
                     fileTableBody.innerHTML = ''; // Clear existing rows except 'no results'

                     // Apply filters directly to the data source before rendering
                     const searchTerm = fileSearchInput ? fileSearchInput.value.toLowerCase().trim() : '';
                     const selectedType = fileTypeFilter ? fileTypeFilter.value : '';
                     const selectedDate = uploadDateFilter ? uploadDateFilter.value : '';
                     const selectedUser = userFilter ? userFilter.value : '';
                     const isAdmin = true; // Assume admin for filtering demo

                     const filesToRender = mockFilesData.filter(file => {
                        const fileName = file.name.toLowerCase();
                        const fileType = file.type || '';
                        const uploadDate = file.uploadDate.substring(0, 10); // YYYY-MM-DD
                        const uploader = file.uploader || '';

                        const nameMatch = searchTerm === '' || fileName.includes(searchTerm);
                        const typeMatch = selectedType === '' || fileType === selectedType;
                        const dateMatch = selectedDate === '' || uploadDate === selectedDate;
                        const userMatch = (!isAdmin || selectedUser === '' || uploader === selectedUser);

                        return nameMatch && typeMatch && dateMatch && userMatch;
                     });


                     if (filesToRender.length === 0) {
                         if(noResultsRow) noResultsRow.style.display = ''; // Display as table-row or default
                         return;
                     }
                     if(noResultsRow) noResultsRow.style.display = 'none';


                     filesToRender.forEach(file => {
                         const row = document.createElement('tr');
                         row.dataset.fileId = file.id;
                         // Add data attributes needed for filtering (even though filtering happens before render now)
                         row.dataset.fileType = file.type;
                         row.dataset.uploadDate = file.uploadDate.substring(0, 10);
                         row.dataset.uploader = file.uploader;

                         const tagsHTML = file.tags.map(tag => `<span class="badge text-bg-${getTagColor(tag)} me-1">${tag}</span>`).join('');
                         const iconData = getFileIcon(file.type);
                         const formattedDate = formatFullDateTime(file.uploadDate); // Use dashboard's formatter

                         row.innerHTML = `
                             <td data-label="Type"><i class="${iconData.icon} file-icon ${iconData.color}" title="${file.type}"></i></td>
                             <td data-label="File">
                                 <strong class="file-name">${file.name}</strong>
                                 <small class="d-block text-muted">Size: ${file.size}</small>
                             </td>
                             <td data-label="Date" class="upload-date">${formattedDate}</td>
                             <td data-label="Tags">${tagsHTML}</td>
                             <td data-label="Uploader" class="uploader-shared">${file.uploader}</td>
                             <td data-label="Actions" class="text-center action-buttons">
                                 <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="${file.id}" data-file-url="${file.url}">
                                     <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                 </button>
                                 ${['PDF', 'Image'].includes(file.type) ? `
                                 <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#fsFilePreviewModal" data-file-type="${file.type}" data-file-url="${file.url}" data-file-name="${file.name}">
                                     <i class="fas fa-eye"></i>
                                 </button>` : ''}
                                 <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="${file.id}">
                                     <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                 </button>
                             </td>
                         `;
                         fileTableBody.appendChild(row);
                     });
                     // applyFilters(); // No need to call applyFilters here anymore
                 }

                 function getFileIcon(type) {
                    switch(type) {
                         case 'PDF': return { icon: 'fas fa-file-pdf', color: 'text-danger' };
                         case 'Image': return { icon: 'fas fa-file-image', color: 'text-success' };
                         case 'Video': return { icon: 'fas fa-file-video', color: 'text-warning' };
                         case 'Archive': return { icon: 'fas fa-file-zipper', color: 'text-warning' };
                         case 'Document': return { icon: 'fas fa-file-word', color: 'text-primary' };
                         case 'Spreadsheet': return { icon: 'fas fa-file-excel', color: 'text-success' };
                         default: return { icon: 'fas fa-file', color: 'text-secondary' };
                     }
                 }

                function getTagColor(tag) {
                    // Simple logic to assign colors based on tag hash or keywords
                    if (tag.toLowerCase().includes('report')) return 'primary';
                    if (tag.toLowerCase().includes('important')) return 'danger';
                    if (tag.toLowerCase().includes('design')) return 'info';
                    if (tag.toLowerCase().includes('team')) return 'success';
                    return 'secondary'; // Default
                 }

                 function renderRecentUploads() {
                    if (!recentUploadsList) return;
                    const recentFiles = mockFilesData
                        .sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate))
                        .slice(0, 3); // Get latest 3

                    recentUploadsList.innerHTML = '';
                    if (recentFiles.length === 0) {
                         recentUploadsList.innerHTML = '<li class="list-group-item"><span class="text-muted">No recent uploads.</span></li>';
                         return;
                    }

                    recentFiles.forEach(file => {
                        const li = document.createElement('li');
                        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                        li.dataset.timestamp = file.uploadDate;
                        const iconData = getFileIcon(file.type);
                        li.innerHTML = `
                           <div><i class="${iconData.icon} file-icon ${iconData.color}"></i> ${file.name}</div>
                           <small class="text-muted time-ago">calculating...</small>
                        `;
                        recentUploadsList.appendChild(li);
                    });
                     updateRelativeTimes(); // Initial time calculation
                 }


                // --- Filtering Logic ---
                function applyFilters() {
                     // Re-render the table with current filters applied
                     renderFileTable();
                 }

                // --- Reset Filters ---
                function resetFilters() {
                     if(fileSearchInput) fileSearchInput.value = '';
                     if(fileTypeFilter) fileTypeFilter.value = '';
                     if(uploadDateFilter) uploadDateFilter.value = '';
                     if(userFilter) userFilter.value = '';
                     applyFilters();
                }

                // --- Live Timestamp Update ---
                function timeAgoFS(isoTimestamp) { // Renamed to avoid conflict
                    if (!isoTimestamp) return 'Invalid date';
                    const past = new Date(isoTimestamp);
                    if (isNaN(past.getTime())) { console.warn("Invalid date encountered:", isoTimestamp); return 'Invalid date'; }
                    const now = new Date();
                    const diffInSeconds = Math.floor((now - past) / 1000);

                    if (diffInSeconds < 5) return 'just now';
                    if (diffInSeconds < 60) return `${diffInSeconds} seconds ago`;
                    const minutes = Math.floor(diffInSeconds / 60);
                    if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                    const hours = Math.floor(minutes / 60);
                    if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    const days = Math.floor(hours / 24);
                    if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;

                     // Use dashboard's date formatter for older dates
                     return formatDateForDisplay(past);
                }

                function updateRelativeTimes() {
                     // Use contentWrapper to scope the query
                     const timeElements = contentWrapper.querySelectorAll('#recentUploadsSection .time-ago');
                     timeElements.forEach(el => {
                         const timestamp = el.closest('li')?.dataset.timestamp;
                         el.textContent = timeAgoFS(timestamp);
                     });
                 }

                // --- Action Button Handlers ---
                 boundTableClickHandler = function(event) {
                     const button = event.target.closest('.action-btn');
                     if (!button) return;

                     if (button.classList.contains('loading')) return;

                     const fileId = parseInt(button.dataset.fileId);
                     const row = button.closest('tr'); // May be null if row removed
                     const file = mockFilesData.find(f => f.id === fileId);
                     const fileName = file ? file.name : 'this file';

                     // --- Download Action ---
                     if (button.classList.contains('download-btn')) {
                         const fileUrl = button.dataset.fileUrl;
                         if (!fileUrl || fileUrl === 'path/to/...') {
                             console.error(`Download failed: URL missing for file ID ${fileId}.`);
                              // Use global showToast
                              if (typeof showToast === 'function') {
                                 showToast('Could not download file: URL missing.', 'error');
                              } else {
                                  Swal.fire({ icon: 'error', title: 'Download Error', text: 'Could not download the file. URL is missing.' });
                              }
                             return;
                         }

                         button.classList.add('loading'); button.disabled = true;
                         console.log(`Attempting download for file ID: ${fileId}, URL: ${fileUrl}`);
                         try {
                             const link = document.createElement('a');
                             link.href = fileUrl; link.setAttribute('download', fileName);
                             document.body.appendChild(link); link.click(); document.body.removeChild(link);
                              console.log(`Download initiated for: ${fileName}`);
                         } catch (error) {
                             console.error('Error triggering download:', error);
                             if (typeof showToast === 'function') {
                                 showToast('An error occurred starting the download.', 'error');
                              } else {
                                Swal.fire({ icon: 'error', title: 'Download Failed', text: 'An error occurred starting the download.' });
                             }
                         } finally {
                              setTimeout(() => { button.classList.remove('loading'); button.disabled = false; }, 500);
                         }
                     }

                     // --- Delete Action ---
                     else if (button.classList.contains('delete-btn')) {
                         // Use SweetAlert from the global scope
                         Swal.fire({
                             title: 'Are you sure?', html: `Delete file: <br><strong>${fileName}</strong>`, icon: 'warning',
                             showCancelButton: true, confirmButtonColor: 'var(--success)', cancelButtonColor: 'var(--danger)', // Use dashboard vars
                             confirmButtonText: '<i class="fas fa-check me-1"></i> Yes, delete it!', cancelButtonText: '<i class="fas fa-times me-1"></i> Cancel'
                         }).then((result) => {
                             if (result.isConfirmed) {
                                 button.classList.add('loading'); button.disabled = true;
                                 console.log(`Attempting delete for file ID: ${fileId}`);
                                 // Simulate backend delete
                                 setTimeout(() => {
                                     const deleteSuccess = Math.random() > 0.1; // 90% success rate
                                     if (deleteSuccess) {
                                         console.log(`Successfully deleted file ID: ${fileId}`);
                                         mockFilesData = mockFilesData.filter(f => f.id !== fileId); // Remove from mock data
                                         if (row) { // Only animate if row still exists
                                             row.style.opacity = '0';
                                             setTimeout(() => {
                                                 renderFileTable(); // Re-render the table based on updated data
                                                 renderRecentUploads(); // Update recent uploads list
                                                 Swal.fire('Deleted!', `"${fileName}" has been deleted.`, 'success');
                                             }, 300);
                                         } else {
                                             renderFileTable(); // Re-render if row somehow missing
                                             renderRecentUploads();
                                             Swal.fire('Deleted!', `"${fileName}" has been deleted.`, 'success');
                                         }

                                     } else {
                                         console.error(`Failed to delete file ID: ${fileId}`);
                                         button.classList.remove('loading'); button.disabled = false;
                                         Swal.fire('Error!', 'Could not delete the file. Please try again.', 'error');
                                     }
                                 }, 1000);
                             }
                         });
                     }
                 };


                 // --- Preview Modal Logic ---
                  boundPreviewHandler = function (event) {
                     const button = event.relatedTarget; // Button that triggered the modal
                     if (!button || !button.classList.contains('preview-btn')) return;

                     const fileUrl = button.getAttribute('data-file-url');
                     const fileType = button.getAttribute('data-file-type');
                     const fileNameAttr = button.getAttribute('data-file-name'); // Get name from data attribute

                     if (!previewFileName || !previewFileType || !previewContent) return;

                     previewFileName.textContent = `File Name: ${fileNameAttr || 'N/A'}`; // Use attribute
                     previewFileType.textContent = `Type: ${fileType ? fileType.toUpperCase() : 'N/A'}`;
                     previewContent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; // Show spinner

                     if (fileUrl && fileUrl !== 'path/to/...') {
                         setTimeout(() => { // Small delay for spinner visibility
                             if (fileType === 'Image') {
                                 previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" alt="Preview of ${fileNameAttr}" style="max-height: 75vh;">`;
                             } else if (fileType === 'PDF') {
                                 previewContent.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="650px"><p class="text-warning p-4">Preview not available. Your browser might not support PDF embedding or the file is inaccessible. <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Download PDF</a></p></object>`;
                             } else {
                                 previewContent.innerHTML = `<p class="text-warning p-4">Preview is not available for this file type (${fileType}).</p>`;
                             }
                         }, 300);
                     } else {
                          previewContent.innerHTML = `<p class="text-danger p-4">Could not load preview. File URL is missing or invalid.</p>`;
                     }
                  };

                 // Clear preview content when modal is hidden
                 boundModalHidden = function() {
                     if (previewContent) {
                         previewContent.innerHTML = ''; // Clear preview area
                     }
                     // Also reset upload progress UI
                     if (uploadProgressContainer) uploadProgressContainer.style.display = 'none';
                     if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                     if (uploadStatus) uploadStatus.textContent = '';
                     if (uploadFileName) uploadFileName.textContent = '';
                     if (uploadPercentage) uploadPercentage.textContent = '';
                     if (fileInputManual) fileInputManual.value = '';
                     if (fileInputHidden) fileInputHidden.value = '';
                     if (fileTagsInput) fileTagsInput.value = '';
                 };


                // --- Upload Modal Logic ---
                 boundUploadHandler = function() {
                    // Ensure elements exist before proceeding
                    if (!fileInputManual || !fileInputHidden || !fileTagsInput || !uploadFileName || !uploadProgressContainer || !uploadProgressBar || !uploadPercentage || !uploadStatus || !currentUser) {
                        console.error("Upload cannot proceed: Required elements or user data missing.");
                        Swal.fire('Error', 'Cannot initiate upload due to a configuration issue.', 'error');
                        return;
                    }

                    const filesToUpload = fileInputManual.files.length > 0 ? fileInputManual.files : fileInputHidden.files;
                    if (filesToUpload.length === 0) {
                        Swal.fire('No File Selected', 'Please select at least one file to upload.', 'warning');
                        return;
                    }
                    const firstFile = filesToUpload[0];
                    const tags = fileTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);

                    console.log("Starting upload for:", firstFile.name, "Tags:", tags);
                    uploadFileName.textContent = `Uploading: ${firstFile.name}`;
                    uploadProgressContainer.style.display = 'block';
                    uploadProgressBar.style.width = '0%';
                    uploadProgressBar.classList.remove('bg-success', 'bg-danger');
                    uploadProgressBar.classList.add('progress-bar-animated');
                    uploadPercentage.textContent = '0%';
                    uploadStatus.textContent = 'Initializing...';
                    uploadStatus.className = 'text-muted d-block mt-1';

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 15;
                        progress = Math.min(progress, 100);

                        uploadProgressBar.style.width = progress + '%';
                        uploadProgressBar.setAttribute('aria-valuenow', progress);
                        uploadPercentage.textContent = Math.round(progress) + '%';

                        if (progress >= 100) {
                            clearInterval(interval);
                            const uploadSuccess = Math.random() > 0.2;

                            uploadProgressBar.classList.remove('progress-bar-animated');
                            if(uploadSuccess) {
                                uploadStatus.textContent = 'Upload successful!';
                                uploadStatus.className = 'text-success d-block mt-1 fw-bold';
                                uploadProgressBar.classList.add('bg-success');

                                // --- Add new file to mock data and re-render ---
                                const newFile = {
                                    id: Date.now(), // Simple unique ID
                                    name: firstFile.name,
                                    size: `${(firstFile.size / (1024*1024)).toFixed(1)} MB`, // Simulate size
                                    uploadDate: new Date().toISOString(),
                                    type: getFileTypeFromName(firstFile.name),
                                    tags: tags,
                                    uploader: currentUser?.name || 'Current User', // Use logged-in user
                                    url: `path/to/${firstFile.name}` // Simulate URL
                                };
                                mockFilesData.unshift(newFile); // Add to beginning
                                renderFileTable(); // Re-render the table
                                renderRecentUploads(); // Update recent uploads
                                if (uploadFileModal) {
                                    setTimeout(() => uploadFileModal.hide(), 1500);
                                }

                            } else {
                                uploadStatus.textContent = 'Upload failed. Please try again.';
                                uploadStatus.className = 'text-danger d-block mt-1 fw-bold';
                                uploadProgressBar.classList.add('bg-danger');
                            }
                            // Reset file inputs and tags only after completion (success or fail)
                            if(fileInputManual) fileInputManual.value = '';
                            if(fileInputHidden) fileInputHidden.value = '';
                            if(fileTagsInput) fileTagsInput.value = '';
                            // Reset dropzone text might be needed if visually changed
                        }
                    }, 300);
                 };


                function getFileTypeFromName(fileName) {
                     const extension = fileName.split('.').pop().toLowerCase();
                     if (['pdf'].includes(extension)) return 'PDF';
                     if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(extension)) return 'Image';
                     if (['mp4', 'mov', 'avi', 'mkv'].includes(extension)) return 'Video';
                     if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension)) return 'Archive';
                     if (['doc', 'docx'].includes(extension)) return 'Document';
                     if (['xls', 'xlsx'].includes(extension)) return 'Spreadsheet';
                     return 'Other';
                 }

                // Drag and Drop Logic
                 boundDropZoneClick = () => { if (fileInputHidden) fileInputHidden.click(); };
                 const preventDefaults = (e) => { e.preventDefault(); e.stopPropagation(); };
                 const highlight = () => dropZone?.classList.add('bg-primary-subtle', 'border-primary'); // Use Bootstrap classes for highlight
                 const unhighlight = () => dropZone?.classList.remove('bg-primary-subtle', 'border-primary');
                 const handleDrop = (e) => { let dt = e.dataTransfer; let files = dt.files; if(fileInputHidden) { fileInputHidden.files = files; console.log("Files dropped:", files); showToast(`${files.length} file(s) selected via drop.`,'info');} };
                 boundDropEvents = { preventDefaults, highlight, unhighlight, handleDrop };

                 // Manual file input change mirrors hidden input
                 boundManualFileChange = () => { if (fileInputManual && fileInputHidden) { fileInputHidden.files = fileInputManual.files; showToast(`${fileInputManual.files.length} file(s) selected manually.`,'info'); } };

                // --- Initial setup and bindings ---
                generateMockFileData(); // Load initial data
                updateRelativeTimes(); // Initial time calculation
                recentUploadsIntervalId = setInterval(updateRelativeTimes, 60000); // Update every minute

                // --- Admin Check ---
                const isAdminCheck = true; // Replace with actual check if needed
                if (isAdminCheck && userFilterContainer) {
                    userFilterContainer.style.display = 'block';
                } else if(userFilterContainer) {
                    userFilterContainer.style.display = 'none';
                }

                 // Bind event listeners
                fileSearchInput.addEventListener('input', boundFilterHandler);
                fileTypeFilter.addEventListener('change', boundFilterHandler);
                uploadDateFilter.addEventListener('change', boundFilterHandler);
                userFilter.addEventListener('change', boundFilterHandler);
                resetFiltersBtn.addEventListener('click', boundResetHandler);
                fileTableBody.addEventListener('click', boundTableClickHandler);
                 // Use event delegation for preview buttons if dynamically added
                 // (already handled by BS data attributes, but good practice)

                 if(previewModalElement) {
                     previewModalElement.addEventListener('show.bs.modal', boundPreviewHandler);
                     previewModalElement.addEventListener('hidden.bs.modal', boundModalHidden); // Cleanup preview
                 }
                 if(uploadModalElement) {
                     uploadModalElement.addEventListener('hidden.bs.modal', boundModalHidden); // Cleanup upload progress
                 }

                 if(startUploadButton) startUploadButton.addEventListener('click', boundUploadHandler);

                // Drag & Drop Listeners
                 dropZone.addEventListener('click', boundDropZoneClick);
                 ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                     dropZone.addEventListener(eventName, boundDropEvents.preventDefaults, false);
                     // Attach to body only if needed globally, otherwise keep scoped
                     // document.body.addEventListener(eventName, boundDropEvents.preventDefaults, false);
                 });
                 ['dragenter', 'dragover'].forEach(eventName => {
                     dropZone.addEventListener(eventName, boundDropEvents.highlight, false);
                 });
                 ['dragleave', 'drop'].forEach(eventName => {
                     dropZone.addEventListener(eventName, boundDropEvents.unhighlight, false);
                 });
                 dropZone.addEventListener('drop', boundDropEvents.handleDrop, false);

                 if (fileInputManual) { fileInputManual.addEventListener('change', boundManualFileChange); }

                // --- Cleanup Function ---
                 const cleanup = () => {
                     console.log("Cleaning up File Sharing feature listeners and resources...");
                     if (recentUploadsIntervalId) clearInterval(recentUploadsIntervalId);
                     fileSearchInput?.removeEventListener('input', boundFilterHandler);
                     fileTypeFilter?.removeEventListener('change', boundFilterHandler);
                     uploadDateFilter?.removeEventListener('change', boundFilterHandler);
                     userFilter?.removeEventListener('change', boundFilterHandler);
                     resetFiltersBtn?.removeEventListener('click', boundResetHandler);
                     fileTableBody?.removeEventListener('click', boundTableClickHandler);
                     previewModalElement?.removeEventListener('show.bs.modal', boundPreviewHandler);
                     previewModalElement?.removeEventListener('hidden.bs.modal', boundModalHidden);
                     uploadModalElement?.removeEventListener('hidden.bs.modal', boundModalHidden);
                     startUploadButton?.removeEventListener('click', boundUploadHandler);

                     // Drag & Drop Cleanup
                     if(dropZone) {
                         dropZone.removeEventListener('click', boundDropZoneClick);
                         ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                             dropZone.removeEventListener(eventName, boundDropEvents.preventDefaults, false);
                             // document.body.removeEventListener(eventName, boundDropEvents.preventDefaults, false);
                         });
                         ['dragenter', 'dragover'].forEach(eventName => {
                             dropZone.removeEventListener(eventName, boundDropEvents.highlight, false);
                         });
                         ['dragleave', 'drop'].forEach(eventName => {
                             dropZone.removeEventListener(eventName, boundDropEvents.unhighlight, false);
                         });
                         dropZone.removeEventListener('drop', boundDropEvents.handleDrop, false);
                     }
                     if (fileInputManual) { fileInputManual.removeEventListener('change', boundManualFileChange); }

                     // Dispose Bootstrap modals if they exist
                     if (uploadFileModal) uploadFileModal.dispose();
                     if (filePreviewModal) filePreviewModal.dispose();


                     console.log("File Sharing cleanup complete.");
                 };

                return { cleanup }; // Return cleanup function
            }
        </script>
    </template>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- =============================== -->
    <!-- MAIN DASHBOARD SCRIPT (Continued) -->
    <!-- =============================== -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements (Continued from previous code) ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            // *** Select ALL potential top-level content sections ***
            const contentSections = document.querySelectorAll('.content-area > .content-section');
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder'); // Keep reference to placeholder
            const featureTitleEl = featurePlaceholder?.querySelector('#featureTitle'); // Use optional chaining
            const featureDescEl = featurePlaceholder?.querySelector('#featureDescription');
            const featureLoadingEl = featurePlaceholder?.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder?.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModal = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModal = document.getElementById('projectModal'); // NEW: Project Modal
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button


            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables (Continued) ---
            let currentUser = null;
            let currentFeature = 'dashboard'; // Default feature
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false;
            let showToasts = true;
            let playSounds = true;
            let currentScheduleWeekOffset = 0;
            let scheduleMinWeekOffset = 0;
            let mockScheduleData = {};
            let currentFeatureCleanup = null; // Stores the cleanup function
            let MOCK_PROJECTS_DATA = [];
            let MOCK_TASKS = []; // Add mock tasks state if not already present

            // --- Mock Data (Continued) ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
            ];

            // --- Initialization (Continued) ---
            function initDashboard() {
                currentUser = { ...MOCK_USERS[0] };
                console.log("Initializing dashboard for:", currentUser.name);
                applyStoredPreferences();
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation();
                startDynamicUpdates();
                setupResponsiveSidebar();
                update2FA_UI();
            }

            // --- UI Updates (Continued) ---
            // ... (Existing updateUserUI, updateProfileForm, formatRole functions) ...
            function updateUserUI() {
                 if (!currentUser) return;

                 // Top Nav User Menu
                 document.getElementById('userName').textContent = currentUser.name;
                 document.getElementById('userAvatar').textContent = currentUser.initials;
                  if (currentUser.avatar) {
                     document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                     document.getElementById('userAvatar').textContent = ''; // Clear initials if avatar exists
                 } else {
                     document.getElementById('userAvatar').style.backgroundImage = 'none';
                     document.getElementById('userAvatar').textContent = currentUser.initials;
                 }

                 // Welcome Section
                 document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                 document.getElementById('userInfoName').textContent = currentUser.name;
                 document.getElementById('userEmail').textContent = currentUser.email;
                 document.getElementById('profileAvatar').textContent = currentUser.initials;
                 if (currentUser.avatar) {
                     document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                      document.getElementById('profileAvatar').textContent = '';
                 } else {
                     document.getElementById('profileAvatar').style.backgroundImage = 'none';
                     document.getElementById('profileAvatar').textContent = currentUser.initials;
                 }

                 // User Role Title
                 const roleTitle = document.getElementById('userInfoRoleTitle');
                 roleTitle.textContent = formatRole(currentUser.role);
                 roleTitle.className = `user-info-title role-${currentUser.role}`; // Apply role class

                 // Profile Page Elements
                 updateProfileForm();
                 profileAvatarLarge.textContent = currentUser.initials;
                 if (currentUser.avatar) {
                     profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                      profileAvatarLarge.textContent = '';
                 } else {
                     profileAvatarLarge.style.backgroundImage = 'none';
                     profileAvatarLarge.textContent = currentUser.initials;
                 }
                 // Update Account panel email display
                 if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;


                 // Admin specific elements
                 const teamSettingsTab = document.getElementById('teamSettingsTab');
                 const dangerZoneTab = document.getElementById('dangerZoneTab');
                  if (currentUser.role === 'admin') {
                     if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; // Use flex for tabs
                     if (dangerZoneTab) dangerZoneTab.style.display = 'flex';
                 } else {
                     if (teamSettingsTab) teamSettingsTab.style.display = 'none';
                      if (dangerZoneTab) dangerZoneTab.style.display = 'none';
                      // Hide team panel if not admin and trying to access it directly
                      if (currentFeature === 'settings' && currentSettingsTab === 'team') {
                          activateSettingsTab('preferences'); // Default to preferences
                      }
                      if (currentFeature === 'settings' && currentSettingsTab === 'danger') {
                          activateSettingsTab('preferences');
                      }
                 }

                 // Update 2FA UI based on current user status
                 update2FA_UI();
                 if(userPhoneNumberForSms) userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
             }

             function updateProfileForm() {
                 if (!currentUser || !firstNameInput || !lastNameInput || !fullNameDisplay || !jobTitleInput || !emailDisplay || !phoneInput || !departmentInput) return;
                 const nameParts = currentUser.name.split(' ');
                 firstNameInput.value = nameParts[0] || '';
                 lastNameInput.value = nameParts.slice(1).join(' ') || '';
                 fullNameDisplay.value = currentUser.name; // Update readonly full name
                 jobTitleInput.value = currentUser.title || '';
                 emailDisplay.value = currentUser.email || '';
                 phoneInput.value = currentUser.phone || '';
                 departmentInput.value = currentUser.department || '';
             }

             function formatRole(role) {
                 if (!role) return 'Member';
                 return role.charAt(0).toUpperCase() + role.slice(1); // Capitalize first letter
             }


            // --- Preferences & Settings Logic (Continued) ---
            // ... (Existing applyStoredPreferences, setTheme, setContrast, applyLanguage, applyDateTimeFormat, applyToastPreference, applySoundPreference functions) ...

            // --- Navigation & Content Loading (REVISED) ---
             function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                 console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));

                 // --- 1. Cleanup previous feature FIRST ---
                 removeTaskManagementStyles();
                 removeTeamMembersStyles();
                 removeProjectsStyles();
                 removeFileSharingStyles();
                 if (typeof currentFeatureCleanup === 'function') {
                     currentFeatureCleanup(); // Call cleanup function
                     currentFeatureCleanup = null; // Reset cleanup function
                     console.log("Previous feature cleanup executed.");
                 } else {
                    console.log("No cleanup function to execute for previous feature.");
                 }

                 currentFeature = featureId;

                 // --- 2. Update Menu Items ---
                 menuItems.forEach(item => {
                     item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                 });

                 // --- 3. Hide ALL content sections explicitly ---
                 if(dashboardContent) dashboardContent.classList.remove('active');
                 if(profileContent) profileContent.classList.remove('active');
                 if(settingsContent) settingsContent.classList.remove('active');
                 if(featureSectionsContainer) featureSectionsContainer.classList.remove('active'); // Also hide the container initially

                 // Reset feature container completely
                 if(featureSectionsContainer) {
                     featureSectionsContainer.innerHTML = ''; // Clear dynamic content
                     featureSectionsContainer.className = 'content-section'; // Reset classes
                     // Re-append the placeholder structure if it exists
                     if(featurePlaceholder) {
                         featureSectionsContainer.appendChild(featurePlaceholder);
                         featurePlaceholder.style.display = 'none'; // Hide placeholder by default now
                         if(featureLoadingEl) featureLoadingEl.style.display = 'none';
                         if(featureErrorEl) featureErrorEl.style.display = 'none';
                     }
                 }

                 // --- 4. Determine and Show the correct section ---
                 let targetSection = null;
                 let isFeatureSection = false;

                 if (featureId === 'dashboard') {
                     targetSection = dashboardContent;
                     backButton.style.display = 'none';
                 } else if (featureId === 'profile') {
                     targetSection = profileContent;
                     backButton.style.display = 'flex';
                     backButtonText.textContent = 'Back to Dashboard';
                     updateProfileForm(); // Update form when showing profile
                 } else if (featureId === 'settings') {
                     targetSection = settingsContent;
                     backButton.style.display = 'flex';
                     backButtonText.textContent = 'Back to Dashboard';
                     // Determine the correct tab, defaulting safely
                     let targetTab = settingsTab || currentSettingsTab || 'preferences';
                     if (currentUser.role !== 'admin' && (targetTab === 'team' || targetTab === 'danger')) {
                         targetTab = 'preferences'; // Force non-admins away from restricted tabs
                     }
                     currentSettingsTab = targetTab; // Update state
                     activateSettingsTab(currentSettingsTab); // Activate the correct panel
                     update2FA_UI(); // Update security UI elements
                 } else {
                     // Handle other features dynamically loaded into the container
                     targetSection = featureSectionsContainer;
                     isFeatureSection = true;
                     backButton.style.display = 'flex';
                     backButtonText.textContent = 'Back to Dashboard';
                     loadFeatureContent(featureId); // Load the specific feature's content and JS
                 }

                 // --- 5. Activate the target section ---
                 if (targetSection) {
                     targetSection.classList.add('active');
                     console.log(`Section activated: ${targetSection.id}`);
                 } else {
                     console.warn(`No target section found for feature: ${featureId}`);
                     // Optionally show a default or error state
                     if(dashboardContent) dashboardContent.classList.add('active'); // Fallback to dashboard
                 }

                 // --- 6. Mobile/UI Adjustments ---
                 if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                     sidebar.classList.remove('active');
                     // mainContent.classList.remove('sidebar-active'); // No longer needed if sidebar overlays
                     if(closeSidebar) closeSidebar.style.display = 'none';
                 }
                 userDropdown.classList.remove('active');
                 userDropdownOpen = false;

                 // --- 7. Update History ---
                 if (!skipHistory) {
                     updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null);
                 }

                 // --- 8. Scroll to top ---
                 window.scrollTo(0, 0); // Ensure user sees the top of the new section
             }


            function activateSettingsTab(tabId) {
                console.log(`Activating settings tab: ${tabId}`);
                // Ensure the tabId is valid, default if not (redundant check, but safe)
                const validTabs = ['preferences', 'account', 'security', 'notifications', 'team', 'collaboration', 'danger'];
                if (!validTabs.includes(tabId)) {
                    tabId = 'preferences';
                }
                 // Handle restricted tabs for non-admins
                if (currentUser.role !== 'admin' && (tabId === 'team' || tabId === 'danger')) {
                     tabId = 'preferences'; // Force non-admins away
                 }

                currentSettingsTab = tabId; // Update state

                document.querySelectorAll('.settings-tab').forEach(tab => {
                    // Ensure tab exists before modifying classList
                    if (tab) {
                        tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
                    }
                });
                document.querySelectorAll('.settings-panel').forEach(panel => {
                    if (panel) {
                         panel.classList.toggle('active', panel.id === `${tabId}Panel`);
                    }
                });

                // Specific actions when a tab is activated
                if (tabId === 'team' && currentUser.role === 'admin') { loadTeamMembers(); } // Load team members if applicable
                if (tabId === 'security') { update2FA_UI(); }
                if (tabId === 'account' && accountEmailDisplay) { accountEmailDisplay.value = currentUser.email; }
             }

             function loadFeatureContent(featureId) {
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';

                 // Ensure placeholder is correctly managed
                 if(featurePlaceholder) {
                     featurePlaceholder.style.display = 'flex'; // Show placeholder initially
                     if(featureTitleEl) featureTitleEl.textContent = '';
                     if(featureDescEl) featureDescEl.textContent = '';
                     if(featureLoadingEl) featureLoadingEl.style.display = 'block'; // Show loading spinner
                     if(featureErrorEl) featureErrorEl.style.display = 'none'; // Hide previous errors
                 }
                 featureSectionsContainer.innerHTML = ''; // Clear previous content safely
                 featureSectionsContainer.className = 'content-section active'; // Reset to base + active
                 if(featurePlaceholder) featureSectionsContainer.appendChild(featurePlaceholder); // Add placeholder back

                 console.log(`Loading content for: ${featureName} (${featureId})`);

                 setTimeout(() => { // Simulate loading delay
                     try {
                         if(featureLoadingEl) featureLoadingEl.style.display = 'none'; // Hide loading

                         let templateId = '';
                         let initFunction = null;
                         let styleId = '';
                         let contentHTML = ''; // For features without templates

                         // Add feature-specific class FIRST
                         featureSectionsContainer.classList.add(`${featureId}-feature`);

                         // Determine how to load based on featureId
                         if (featureId === 'team-members-view') {
                             contentHTML = getTeamMembersHTML();
                             initFunction = initializeTeamMembersFeature;
                         } else if (featureId === 'projects') {
                             contentHTML = getProjectsHTML();
                             initFunction = initializeProjectsFeature;
                         } else if (featureId === 'employee-scheduling') {
                             contentHTML = getEmployeeScheduleHTML();
                             initFunction = initializeEmployeeScheduleLogic;
                         } else if (featureId === 'task-management') {
                             templateId = 'taskManagementAssets';
                             styleId = 'injected-task-management-styles';
                             // Init function name derived later
                         } else if (featureId === 'file-sharing') {
                             templateId = 'fileSharingAssets';
                             styleId = 'injected-file-sharing-styles';
                             // Init function name derived later
                         } else {
                            // Keep placeholder for other unimplemented features
                             if(featurePlaceholder) featurePlaceholder.style.display = 'flex';
                             if(featureTitleEl) featureTitleEl.textContent = featureName;
                             if(featureDescEl) featureDescEl.textContent = `Content for ${featureName} would be loaded here.`;
                             console.warn(`No specific loading logic for feature: ${featureId}`);
                             return; // Exit early
                         }

                         // Clear the container *before* adding new content (except placeholder)
                         featureSectionsContainer.innerHTML = '';
                         if(featurePlaceholder) featureSectionsContainer.appendChild(featurePlaceholder); // Keep placeholder reference

                         // If using a template (Task Management, File Sharing)
                         if (templateId) {
                             const template = document.getElementById(templateId);
                             if (!template) { throw new Error(`${templateId} template not found!`); }

                             // Inject Styles
                             const styleContent = template.content.querySelector('style'); // Get first style tag
                             if (styleContent) {
                                 // Check if style already exists before adding
                                 if (!document.getElementById(styleId)) {
                                     const styleTag = document.createElement('style');
                                     styleTag.id = styleId;
                                     styleTag.textContent = styleContent.textContent;
                                     document.head.appendChild(styleTag);
                                     console.log(`${featureName} styles injected.`);
                                 } else {
                                     console.log(`${featureName} styles already exist.`);
                                 }
                             } else { console.warn(`${featureName} styles not found in template.`); }

                             // Inject HTML
                             const contentNodes = template.content.cloneNode(true);
                             contentNodes.querySelectorAll('style, script').forEach(el => el.remove());
                             // Append the actual content, replacing the placeholder
                             featureSectionsContainer.innerHTML = ''; // Clear placeholder before adding real content
                             featureSectionsContainer.appendChild(contentNodes);

                             // Initialize JS
                             const scriptContent = template.content.querySelector('script');
                             if (scriptContent) {
                                 try {
                                     const featureInitFunctionName = `initialize${featureId.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}Feature`;
                                     const initFunc = new Function(`${scriptContent.textContent}\n return ${featureInitFunctionName};`)();
                                     if (typeof initFunc === 'function') {
                                         const result = initFunc(featureSectionsContainer); // Pass the container
                                         currentFeatureCleanup = result?.cleanup;
                                         console.log(`${featureName} JS initialized.`);
                                     } else { console.error(`${featureInitFunctionName} function not found in script.`); }
                                 } catch (e) { console.error(`Error initializing ${featureName} script:`, e); throw e; }
                             } else { console.warn(`${featureName} script not found in template.`); }
                         }
                         // If HTML/JS are directly generated
                         else if (contentHTML) {
                            featureSectionsContainer.innerHTML = contentHTML; // Replace placeholder with generated HTML
                             if (initFunction && typeof initFunction === 'function') {
                                 const result = initFunction(featureSectionsContainer); // Initialize directly
                                 currentFeatureCleanup = result?.cleanup; // Store cleanup if returned
                                 console.log(`${featureName} JS initialized directly.`);
                             }
                         }

                         // Hide placeholder if content was successfully loaded
                         if(featurePlaceholder) featurePlaceholder.style.display = 'none';

                     } catch (error) {
                         console.error(`Error loading feature ${featureId}:`, error);
                         featureSectionsContainer.innerHTML = ''; // Clear potentially broken content
                         if(featurePlaceholder) {
                             featureSectionsContainer.appendChild(featurePlaceholder); // Ensure placeholder is back
                             featurePlaceholder.style.display = 'flex'; // Show placeholder again on error
                             if(featureErrorEl) {
                                 featureErrorEl.textContent = `Failed to load ${featureName}. Error: ${error.message}`;
                                 featureErrorEl.style.display = 'block';
                             }
                              if(featureLoadingEl) featureLoadingEl.style.display = 'none';
                              if(featureTitleEl) featureTitleEl.textContent = 'Error';
                              if(featureDescEl) featureDescEl.textContent = '';
                         }
                     }
                 }, 150); // Reduced delay slightly
             }


            // --- Data Loading & Simulation (Continued) ---
            function loadInitialData() {
                 loadDashboardStats();
                 loadRecentActivities();
                 loadNotifications();
                 loadMockProjects();
                 loadMockTasks(); // Make sure tasks are loaded for search etc.
                 if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') { loadTeamMembers(); }
             }

             function loadMockTasks() { // Added function to load tasks into state
                 const storedTasks = localStorage.getItem('dashboard_tasks');
                 if (storedTasks) { try { MOCK_TASKS = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); MOCK_TASKS = []; } }
                 else {
                    // Use default tasks if none in storage
                     MOCK_TASKS = [ { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 }, { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 }, { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 }, { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 }, ];
                 }
                 console.log("Mock tasks loaded into MOCK_TASKS");
             }


            // --- Feature Cleanup Functions ---
             function removeTaskManagementStyles() { const injectedStyle = document.getElementById('injected-task-management-styles'); if (injectedStyle) { injectedStyle.remove(); console.log("Task styles removed."); } }
             function removeTeamMembersStyles() { /* Placeholder if specific styles were injected */ }
             function removeProjectsStyles() { /* Placeholder if specific styles were injected */ }
             function removeFileSharingStyles() {
                 const injectedStyle = document.getElementById('injected-file-sharing-styles');
                 if (injectedStyle) {
                     injectedStyle.remove();
                     console.log("File Sharing styles removed.");
                 }
             }

            // --- Utility Functions (Continued) ---
            // ... (Existing timeAgo, formatDateForDisplay, formatFullDateTime, generateMockActivities, generateMockNotifications, showConfirmModal, hideConfirmModal, showSuccessMessage, showToast functions) ...

            // --- START: Team Members Feature (Continued) ---
            // ... (Existing getTeamMembersHTML, initializeTeamMembersFeature functions) ...

            // --- START: Projects Feature (Continued) ---
            // ... (Existing getProjectsHTML, renderProjects, handleDeleteProject, openProjectModal, handleSaveProject, initializeProjectsFeature functions) ...

            // --- Employee Scheduling Logic (Make sure renderSchedule is globally accessible or passed correctly) ---
            let renderSchedule; // Declare globally within the main script scope
            function initializeEmployeeScheduleLogic(container) { // Accept container
                console.log("Initializing Employee Schedule Logic...");
                 const calculateOffsets = () => { const today = new Date(); const mayFirst2025 = new Date(2025, 4, 1); mayFirst2025.setHours(0, 0, 0, 0); const currentDayOfWeek = today.getDay(); const diffToSunday = today.getDate() - currentDayOfWeek; const startOfCurrentWeek = new Date(today); startOfCurrentWeek.setDate(diffToSunday); startOfCurrentWeek.setHours(0, 0, 0, 0); const mayFirstDayOfWeek = mayFirst2025.getDay(); const diffToMayFirstSunday = mayFirst2025.getDate() - mayFirstDayOfWeek; const startOfMayFirstWeek = new Date(mayFirst2025); startOfMayFirstWeek.setDate(diffToMayFirstSunday); startOfMayFirstWeek.setHours(0, 0, 0, 0); const msPerDay = 24 * 60 * 60 * 1000; const weeksDifference = Math.round((startOfMayFirstWeek.getTime() - startOfCurrentWeek.getTime()) / (7 * msPerDay)); console.log(`Current Week Start: ${startOfCurrentWeek.toDateString()}`); console.log(`Target Week Start: ${startOfMayFirstWeek.toDateString()}`); console.log(`Calculated offset: ${weeksDifference}`); currentScheduleWeekOffset = weeksDifference; scheduleMinWeekOffset = weeksDifference; };
                calculateOffsets();
                const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const weekDisplay = container.querySelector('#weekDisplay'); // Scope to container
                const scheduleTableBody = container.querySelector('#scheduleTableBody');
                const scheduleThead = container.querySelector('.schedule-table thead tr');
                const prevWeekBtn = container.querySelector('#prevWeekBtn');
                const nextWeekBtn = container.querySelector('#nextWeekBtn');
                const saveScheduleBtn = container.querySelector('#saveScheduleBtn');
                const sendRemindersBtn = container.querySelector('#sendRemindersBtn');
                 // Assume modal is global or correctly targeted by Bootstrap
                 const editShiftModalElement = document.getElementById('editShiftModal'); // Find globally
                 const editShiftModal = editShiftModalElement ? bootstrap.Modal.getOrCreateInstance(editShiftModalElement) : null;
                 const editShiftForm = editShiftModalElement?.querySelector('#editShiftForm');
                 const shiftTypeSelect = editShiftModalElement?.querySelector('#shiftType');
                 const editShiftEmployeeIdInput = editShiftModalElement?.querySelector('#editShiftEmployeeId');
                 const editShiftDayIndexInput = editShiftModalElement?.querySelector('#editShiftDayIndex');
                 const editShiftWeekOffsetInput = editShiftModalElement?.querySelector('#editShiftWeekOffset');
                 const editShiftModalTitle = editShiftModalElement?.querySelector('#editShiftModalTitle');

                function getWeekDates(weekOffset = 0) { const baseDate = new Date(); const startOfWeek = new Date(baseDate); const dayOfWeek = baseDate.getDay(); const diff = baseDate.getDate() - dayOfWeek; startOfWeek.setDate(diff + (weekOffset * 7)); startOfWeek.setHours(0,0,0,0); const dates = []; for (let i = 0; i < 7; i++) { const date = new Date(startOfWeek); date.setDate(startOfWeek.getDate() + i); dates.push(date); } return dates; }

                 // Assign to the globally declared renderSchedule
                 renderSchedule = function(weekOffset) {
                     console.log(`Rendering schedule offset: ${weekOffset}`);
                     if (isNaN(weekOffset)) { weekOffset = currentScheduleWeekOffset; }
                     const weekDates = getWeekDates(weekOffset); const start = weekDates[0]; const end = weekDates[6]; if(weekDisplay) weekDisplay.textContent = `${formatDateForDisplay(start)} - ${formatDateForDisplay(end)}`;
                     if (prevWeekBtn) { prevWeekBtn.disabled = weekOffset <= scheduleMinWeekOffset; }
                     if(scheduleThead) { scheduleThead.innerHTML = '<th>Employee</th>'; weekDates.forEach((date, index) => { scheduleThead.innerHTML += `<th><div class="day-header"><span class="day-name">${days[index]}</span><span class="day-date">${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric'})}</span></div></th>`; }); }
                     if(scheduleTableBody) { scheduleTableBody.innerHTML = ''; if (MOCK_USERS.length === 0) { scheduleTableBody.innerHTML = `<tr><td colspan="8">No employees found.</td></tr>`; return; }
                         MOCK_USERS.forEach(employee => {
                             const row = document.createElement('tr'); row.innerHTML = `<td class="employee-name">${employee.name}</td>`;
                             for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                                 const cell = document.createElement('td'); const scheduleKey = `${employee.id}-${weekOffset}-${dayIndex}`; const isWeekend = dayIndex === 5 || dayIndex === 6; let shiftType; let isEditable = currentUser.role === 'admin' && !isWeekend;
                                 if (isWeekend) { shiftType = 'off'; mockScheduleData[scheduleKey] = 'off'; cell.classList.add('weekend-cell'); }
                                 else { if (!mockScheduleData[scheduleKey]) { const shiftTypes = ['morning', 'afternoon', 'night', 'off', 'sick', 'vacation']; mockScheduleData[scheduleKey] = shiftTypes[Math.floor(Math.random() * shiftTypes.length)]; } shiftType = mockScheduleData[scheduleKey]; }
                                 const shiftDiv = document.createElement('div'); shiftDiv.classList.add('shift');
                                 if (isWeekend) { shiftDiv.classList.add('shift-weekend-off'); } else { shiftDiv.classList.add(`shift-${shiftType.replace('_', '-')}`); }
                                 shiftDiv.textContent = getShiftText(shiftType);
                                 if (isEditable) { shiftDiv.classList.add('editable'); shiftDiv.dataset.employeeId = employee.id; shiftDiv.dataset.employeeName = employee.name; shiftDiv.dataset.dayIndex = dayIndex; shiftDiv.dataset.weekOffset = weekOffset; shiftDiv.dataset.date = formatDateForDisplay(weekDates[dayIndex]); shiftDiv.title = `Edit ${employee.name}'s shift`; shiftDiv.addEventListener('click', handleEditShiftClick); } // Add listener here
                                 else if (isWeekend) { shiftDiv.title = "Weekend Off"; }
                                 cell.appendChild(shiftDiv); row.appendChild(cell);
                             } scheduleTableBody.appendChild(row);
                         });
                    }
                 }

                function getShiftText(type) { switch (type) { case 'morning': return '9AM-5PM'; case 'afternoon': return '12PM-8PM'; case 'night': return '8PM-4AM'; case 'off': return 'OFF'; case 'sick': return 'Sick'; case 'vacation': return 'Vacation'; default: return 'N/A'; } }
                function handleEditShiftClick(event) { // This function handles the click
                     const target = event.target; if (!target.classList.contains('editable')) return; const employeeId = target.dataset.employeeId; const dayIndex = target.dataset.dayIndex; const weekOffset = target.dataset.weekOffset; const employeeName = target.dataset.employeeName; const dateStr = target.dataset.date; const scheduleKey = `${employeeId}-${weekOffset}-${dayIndex}`; const currentShift = mockScheduleData[scheduleKey] || 'morning';
                     // Populate modal fields
                     if (editShiftEmployeeIdInput) editShiftEmployeeIdInput.value = employeeId;
                     if (editShiftDayIndexInput) editShiftDayIndexInput.value = dayIndex;
                     if (editShiftWeekOffsetInput) editShiftWeekOffsetInput.value = weekOffset;
                     if (shiftTypeSelect) shiftTypeSelect.value = currentShift;
                     if (editShiftModalTitle) editShiftModalTitle.textContent = `Edit ${employeeName}'s Shift on ${days[dayIndex] || dateStr}`;
                     // Show modal
                     if (editShiftModal) editShiftModal.show();
                 }

                 // Bind main button listeners
                 let boundPrevWeek = null, boundNextWeek = null, boundSave = null, boundSend = null, boundFormSubmit = null;
                 if (prevWeekBtn) { boundPrevWeek = () => { if (currentScheduleWeekOffset > scheduleMinWeekOffset) { currentScheduleWeekOffset--; renderSchedule(currentScheduleWeekOffset); } }; prevWeekBtn.addEventListener('click', boundPrevWeek); }
                 if (nextWeekBtn) { boundNextWeek = () => { currentScheduleWeekOffset++; renderSchedule(currentScheduleWeekOffset); }; nextWeekBtn.addEventListener('click', boundNextWeek); }
                 if (saveScheduleBtn) { boundSave = () => { showConfirmModal('Save Schedule', 'Save changes?', () => { saveScheduleBtn.disabled = true; saveScheduleBtn.innerHTML = '<span class="spinner"></span> Saving...'; console.log("Saving schedule...", mockScheduleData); setTimeout(() => { showToast("Schedule saved!", "success"); saveScheduleBtn.disabled = false; saveScheduleBtn.innerHTML = '<i class="fas fa-save"></i> Save Schedule'; }, 1000); }, 'btn-primary'); }; saveScheduleBtn.addEventListener('click', boundSave); }
                 if (sendRemindersBtn) { boundSend = handleSendReminders; sendRemindersBtn.addEventListener('click', boundSend); }

                 // Bind modal form submit listener
                 if (editShiftForm) {
                     boundFormSubmit = (event) => { event.preventDefault(); const employeeId = editShiftEmployeeIdInput.value; const dayIndex = editShiftDayIndexInput.value; const weekOffset = editShiftWeekOffsetInput.value; const newShiftType = shiftTypeSelect.value; const scheduleKey = `${employeeId}-${weekOffset}-${dayIndex}`; mockScheduleData[scheduleKey] = newShiftType; renderSchedule(parseInt(weekOffset)); if(editShiftModal) editShiftModal.hide(); showToast("Shift updated."); };
                     editShiftForm.addEventListener('submit', boundFormSubmit);
                 }

                 renderSchedule(currentScheduleWeekOffset); // Initial render

                 // Cleanup function for scheduling
                 const cleanup = () => {
                     console.log("Cleaning up Employee Scheduling listeners...");
                     if(prevWeekBtn && boundPrevWeek) prevWeekBtn.removeEventListener('click', boundPrevWeek);
                     if(nextWeekBtn && boundNextWeek) nextWeekBtn.removeEventListener('click', boundNextWeek);
                     if(saveScheduleBtn && boundSave) saveScheduleBtn.removeEventListener('click', boundSave);
                     if(sendRemindersBtn && boundSend) sendRemindersBtn.removeEventListener('click', boundSend);
                     if(editShiftForm && boundFormSubmit) editShiftForm.removeEventListener('submit', boundFormSubmit);
                     // We don't need to remove listeners on the dynamically created shift divs
                     // as they are removed when the table is re-rendered.
                     if (editShiftModal) editShiftModal.dispose(); // Dispose BS modal
                     console.log("Employee Scheduling cleanup complete.");
                 };
                 return { cleanup }; // Return cleanup
            }

            // --- Start Application ---
            initDashboard(); // <<<<<<<< ENSURE THIS IS CALLED AT THE END
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255, 255, 255, 0.9);
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: rgba(255, 255, 255, 0.2);
        }

        /* [Previous CSS content remains unchanged...] */

        /* New fixes and improvements */
        
        /* Feature pages positioning fix */
        .feature-page {
            display: none;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-left: 0;
            margin-top: 20px;
            width: 100%;
        }

        .feature-page.active {
            display: block;
        }

        /* Real-time activity indicator */
        .realtime-indicator {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Role-based title styling */
        .role-title {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .role-admin {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .role-manager {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .role-member {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        /* Notification fixes */
        .notification-badge {
            /* Existing styles... */
            display: none; /* Hidden by default */
        }

        .has-notifications .notification-badge {
            display: flex; /* Only show when notifications exist */
        }

        /* [Rest of existing CSS remains unchanged...] */
    </style>
</head>
<body class="blue-theme">
    <!-- [Previous HTML structure remains unchanged...] -->

    <script>
        // Enhanced data structure
        const appData = {
            currentUser: {
                id: 1,
                firstName: "Mohamed",
                lastName: "Elmenisy",
                email: "m.elsayed@thechefz.co",
                role: "admin", // admin, manager, member
                phone: "+201234567890",
                department: "Management",
                jobTitle: "Team Manager",
                avatar: "",
                lastActive: Date.now()
            },
            teamMembers: [
                // Existing team members...
            ],
            activities: [
                // Existing activities...
            ],
            notifications: [
                // Existing notifications...
            ],
            settings: {
                theme: "blue",
                language: "en",
                timezone: "UTC+2",
                dateFormat: "DD/MM/YYYY",
                twoFactorEnabled: true,
                emailNotifications: true,
                pushNotifications: true,
                taskNotifications: true,
                deadlineReminders: true,
                layoutDensity: "normal",
                fontSize: "medium"
            }
        };

        // Role title mapping
        const roleTitles = {
            admin: "Administrator",
            manager: "Team Manager", 
            member: "Team Member"
        };

        // Initialize the dashboard with all fixes
        function initDashboard() {
            loadSavedData();
            updateUserInterface();
            setupEventListeners();
            startRealTimeUpdates();
        }

        // Load all saved data from localStorage
        function loadSavedData() {
            const savedData = localStorage.getItem('teamFlowData');
            if (savedData) {
                Object.assign(appData, JSON.parse(savedData));
            }
            applySettings();
            updateProfileDisplay();
        }

        // Save all data to localStorage
        function saveData() {
            localStorage.setItem('teamFlowData', JSON.stringify(appData));
        }

        // Update UI based on current data
        function updateUserInterface() {
            // Update user profile
            document.getElementById('userName').textContent = `${appData.currentUser.firstName} ${appData.currentUser.lastName}`;
            document.getElementById('welcomeName').textContent = appData.currentUser.firstName;
            document.querySelector('.user-info-title').textContent = roleTitles[appData.currentUser.role] || appData.currentUser.jobTitle;
            document.querySelector('.user-info-title').className = `role-title role-${appData.currentUser.role}`;
            
            // Update stats
            document.getElementById('teamMembersCount').textContent = appData.teamMembers.length;
            document.getElementById('tasksCompleted').textContent = appData.currentUser.tasksCompleted;
            
            // Update avatar if exists
            if (appData.currentUser.avatar) {
                updateAvatar(appData.currentUser.avatar);
            }
            
            // Load activities and notifications
            loadActivities();
            loadNotifications();
            
            // Apply current settings to forms
            document.getElementById('languageSelect').value = appData.settings.language;
            document.getElementById('timezoneSelect').value = appData.settings.timezone;
            document.getElementById('dateFormatSelect').value = appData.settings.dateFormat;
            document.getElementById('themeSelect').value = appData.settings.theme;
            // ... other settings
        }

        // Update profile display in all locations
        function updateProfileDisplay() {
            const fullName = `${appData.currentUser.firstName} ${appData.currentUser.lastName}`;
            
            // Update all name displays
            document.getElementById('userName').textContent = fullName;
            document.getElementById('welcomeName').textContent = appData.currentUser.firstName;
            document.querySelector('.user-info-name').textContent = fullName;
            
            // Update role/title display
            const roleTitle = roleTitles[appData.currentUser.role] || appData.currentUser.jobTitle;
            const roleElement = document.querySelector('.user-info-title');
            roleElement.textContent = roleTitle;
            roleElement.className = `user-info-title role-title role-${appData.currentUser.role}`;
            
            // Update form fields
            document.getElementById('firstName').value = appData.currentUser.firstName;
            document.getElementById('lastName').value = appData.currentUser.lastName;
            document.getElementById('jobTitle').value = appData.currentUser.jobTitle;
            document.getElementById('phone').value = appData.currentUser.phone;
            document.getElementById('department').value = appData.currentUser.department;
        }

        // Apply system settings to UI
        function applySettings() {
            // Theme
            document.body.className = `${appData.settings.theme}-theme`;
            
            // Language (would need i18n implementation)
            // Timezone (would need moment.js or similar)
            // Other settings...
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Profile form auto-save
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProfile();
            });
            
            // Profile field auto-save on change
            document.querySelectorAll('#profileForm input, #profileForm select').forEach(field => {
                field.addEventListener('change', function() {
                    saveProfileField(this.id, this.value);
                });
            });
            
            // Avatar upload
            document.getElementById('profileAvatarInput').addEventListener('change', handleAvatarUpload);
            
            // Settings auto-save
            document.querySelectorAll('.settings-panel input, .settings-panel select').forEach(setting => {
                setting.addEventListener('change', function() {
                    saveSetting(this.id, this.value || this.checked);
                });
            });
            
            // [Rest of existing event listeners...]
        }

        // Real-time updates
        function startRealTimeUpdates() {
            // Update activity timestamps every minute
            updateActivityTimes();
            setInterval(updateActivityTimes, 60000);
            
            // Add live indicator to activity section
            const activityHeader = document.querySelector('.activity-section .section-title');
            if (!document.querySelector('.realtime-indicator')) {
                const liveBadge = document.createElement('span');
                liveBadge.className = 'realtime-indicator';
                liveBadge.textContent = 'LIVE';
                activityHeader.appendChild(liveBadge);
            }
        }

        // Enhanced activity time updates
        function updateActivityTimes() {
            const now = Date.now();
            document.querySelectorAll('.activity-time').forEach((el, index) => {
                if (appData.activities[index]) {
                    el.textContent = formatTimeDifference(appData.activities[index].timestamp, now);
                }
            });
        }

        // [Rest of the existing JavaScript functions with improvements...]

        // Initialize the dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>

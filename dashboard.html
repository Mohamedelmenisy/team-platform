<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <style>
        /* --- ALL CSS FROM dashboard.txt REMAINS HERE --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a; /* Dark blue */
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a; /* Dark blue */
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Used for admin role title color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-light);
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--sidebar-divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            color: var(--white);
            font-size: 1.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .menu-title {
            padding: 0.75rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.5px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
        }

        .menu-item:hover {
            background-color: var(--sidebar-hover);
            color: var(--white);
        }

        .menu-item.active {
            background-color: var(--sidebar-active);
            color: var(--white);
            border-left-color: var(--white);
        }

        .menu-item i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .menu-divider {
            height: 1px;
            background-color: var(--sidebar-divider);
            margin: 1rem 1.5rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
        }

        /* Top Navigation */
        .top-nav {
            background-color: var(--white);
            padding: var(--normal-padding) 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 90;
            transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }

        .search-bar { position: relative; width: 400px; }
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background-color: var(--white);
            color: var(--dark);
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results {
            position: absolute; top: 100%; left: 0; width: 100%;
            background-color: var(--white); border: 1px solid var(--light-gray);
            border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100; display: none; max-height: 300px; overflow-y: auto;
        }
        .search-results.active { display: block; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); }
        .search-result-item:hover { background-color: var(--primary-light); }

        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge {
            position: absolute; top: -5px; right: -5px; background-color: var(--danger);
            color: white; border-radius: 50%; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 600;
        }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: 600; cursor: pointer; background-size: cover; background-position: center;
        }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--dark); }
        .user-status {
            font-size: 0.8rem;
            color: var(--success);
            margin-left: 0.5rem;
            font-weight: 600;
            text-shadow: 0 0 4px rgba(16, 185, 129, 0.4);
        }

        .user-dropdown {
            position: absolute; top: 100%; right: 0; background-color: var(--white);
            border: 1px solid var(--light-gray); border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none;
        }
        .user-dropdown.active { display: block; }
        .dropdown-item {
            padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem;
            color: var(--dark); text-decoration: none; transition: background-color 0.2s;
        }
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; }

        /* Content Area */
        .content-area {
            padding: 2rem;
            min-height: calc(100vh - 70px);
            transition: padding 0.3s ease;
        }
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }

        /* Welcome Section */
        .welcome-section {
            background-color: var(--primary-dark);
            color: var(--white); padding: 2rem;
            border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background-color 0.3s ease;
        }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }

        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        body.compact .welcome-title { font-size: 1.25rem; }

        .welcome-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.25rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}

        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }

        .user-info-avatar {
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center;
            position: relative; cursor: default;
        }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }

        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; }
        body.compact .user-info-name { font-size: 1rem; }

        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; }
        .user-info-title.role-admin { color: var(--team-manager); }
        body.compact .user-info-title { font-size: 0.8rem; }

        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }

        /* Stats Section */
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }

        .stat-card {
            background-color: var(--white); border-radius: 8px; padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative; overflow: hidden;
        }
        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0.9;
        }

        .stat-title { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { color: var(--primary); }

        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        body.compact .stat-value { font-size: 1.5rem; }

        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }

        /* Activity Section */
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }

        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        body.compact .section-title { font-size: 1.1rem; }

        .live-badge {
            display: inline-flex; align-items: center; background-color: var(--danger); color: white;
            padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;
            margin-left: 0.5rem; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }

        .activity-list { list-style: none; padding-left: 0; } /* Ensure no default padding */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity {
             background-color: rgba(37, 99, 235, 0.08);
             animation: highlightNewActivity 2.5s ease-out forwards;
        }
        @keyframes highlightNewActivity {
            0% { background-color: rgba(37, 99, 235, 0.15); }
            100% { background-color: transparent; }
        }

        .activity-icon {
            width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s;
        }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }

        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--dark); }
        body.compact .activity-message { font-size: 0.9rem; }

        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }

        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 1; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; }
        .delete-activity:hover { background-color: rgba(239, 68, 68, 0.1); }

        /* Generic Content Sections (Profile, Settings, Features) */
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        .content-section.active { display: block; }
        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }

        /* Section Headers (used in Profile, Settings, Features) */
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; }
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }

        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }

        /* --- Profile Section Specific Styles --- */
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge {
            width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light);
            color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 3rem; background-size: cover; background-position: center;
            margin-bottom: 1rem;
            border: 3px solid var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #uploadPhotoButton { margin-top: 0.5rem;}

        /* Forms (Profile, Settings) */
        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }

        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }

        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); transition: margin-bottom 0.3s ease, font-size 0.3s ease; }
        body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }

        .form-control {
            width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px;
            font-size: 1rem; background-color: var(--white); color: var(--dark);
            transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }

        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Settings Content Specifics */
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }

        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }

        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* Team Management Panel */
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--dark); margin-bottom: 1rem; }

        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }

        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }

        .member-avatar {
            width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray);
            margin-right: 1rem; display: flex; align-items: center; justify-content: center;
            font-weight: 600; background-size: cover; background-position: center;
            color: var(--primary-dark);
            transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s;
            flex-shrink: 0;
        }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }

        .member-details { flex: 1; min-width: 0; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-email { font-size: 0.8rem; }

        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; }
        body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }

        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        /* Add Member Form */
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }

        /* Theme Classes */
        body.light-theme {
            --primary-light: #f1f5f9;
            --light: #ffffff;
            --white: #ffffff;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            background-color: var(--primary-light);
        }
        body.dark-theme {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --primary-light: #1e293b;
            --light: #334155;
            --white: #0f172a;
            --dark: #e2e8f0;
            --gray: #94a3b8;
            --light-gray: #334155;
            background-color: var(--white);
        }
        body.dark-theme .top-nav { background-color: var(--primary-light); border-bottom-color: var(--light-gray); }
        body.dark-theme .stat-card,
        body.dark-theme .activity-section,
        body.dark-theme .content-section,
        body.dark-theme .team-member-card,
        body.dark-theme .add-member-form,
        body.dark-theme #featureSections .schedule-controls, /* Dark theme schedule */
        body.dark-theme #featureSections .schedule-container,
        body.dark-theme #featureSections .schedule-table tbody td,
        body.dark-theme #featureSections .employee-name,
        body.dark-theme #featureSections .modal-content
        { background-color: var(--primary-light); }

         /* Adjust hover/specific backgrounds for dark theme schedule */
        body.dark-theme #featureSections .schedule-table tbody tr:hover td,
        body.dark-theme #featureSections .schedule-table tbody tr:hover .employee-name
        { background-color: var(--light); } /* Use lighter dark for hover */
        body.dark-theme #featureSections .employee-name { border-right-color: var(--light-gray); }

        body.dark-theme .search-bar input,
        body.dark-theme .form-control,
        body.dark-theme #featureSections .form-control /* Dark theme forms */
         { background-color: var(--light); border-color: var(--light-gray); color: var(--dark); }

        body.dark-theme .form-control[readonly],
        body.dark-theme #featureSections .form-control[readonly]
        { background-color: #293548; } /* Slightly darker readonly */

        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item:hover { background-color: var(--light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .confirm-container { background-color: var(--light); }
        body.dark-theme .theme-option div { border-color: var(--light-gray); }
        body.dark-theme .theme-option[data-theme="dark"] div { border-color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--light); }
        body.dark-theme .notifications-footer { background-color: var(--primary-light); }
        body.dark-theme .welcome-section { background-color: var(--primary-dark); color: var(--dark); } /* Use dark text on dark blue */
         body.dark-theme .user-info-title { color: var(--gray); } /* Lighter gray */
         body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email { color: var(--gray); }
        body.dark-theme .welcome-subtitle { color: var(--gray); }
        body.dark-theme #featureSections .toast { background-color: var(--light); color: var(--dark); } /* Adjust toast for dark */
        body.dark-theme #featureSections .toast.toast-success { border-left-color: var(--success); background-color: var(--light); color: var(--success); }
        body.dark-theme #featureSections .toast.toast-danger { border-left-color: var(--danger); background-color: var(--light); color: var(--danger); }

        body.blue-theme {
            --primary-light: #dbeafe;
            --light: #f8fafc; /* Use light from root */
            --white: #ffffff;
            --dark: #1e293b;
            background-color: var(--primary-light);
        }
         body.blue-theme #featureSections .schedule-controls, /* Ensure default theme backgrounds */
         body.blue-theme #featureSections .schedule-container,
         body.blue-theme #featureSections .schedule-table tbody td,
         body.blue-theme #featureSections .employee-name,
         body.blue-theme #featureSections .modal-content,
         body.blue-theme #featureSections .form-control
         { background-color: var(--white); }
         body.blue-theme #featureSections .schedule-table tbody tr:hover td,
         body.blue-theme #featureSections .schedule-table tbody tr:hover .employee-name
         { background-color: var(--light); }
         body.blue-theme #featureSections .employee-name { border-right-color: var(--light-gray); }
         body.blue-theme #featureSections .form-control[readonly] { background-color: var(--light-gray); }


        /* Theme Selection Options */
        .theme-option { display: flex; flex-direction: column; align-items: center; }
        .theme-option div {
            width: 60px; height: 40px;
            border: 2px solid var(--light-gray); border-radius: 6px; cursor: pointer;
            transition: border-color 0.2s;
        }
        .theme-option span { text-align: center; display: block; margin-top: 0.5rem; font-size: 0.9rem; color: var(--dark); }
        .theme-option:hover div { border-color: var(--primary); }
        .theme-option.selected div { border-color: var(--primary); border-width: 3px; }

        /* Notifications Modal */
        .notifications-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end;
        }
        .notifications-container {
            width: 400px; max-width: 100%; background-color: var(--white); height: 100vh;
            overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }

        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: center; cursor: pointer; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.05); font-weight: 500; }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s; margin-left: auto; padding: 0.5rem; flex-shrink: 0; }
        .delete-notification:hover { opacity: 1; }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }

        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .confirm-container {
            background-color: var(--white); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px;
            max-width: 90%; padding: 2rem;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }

        /* Success Message */
        .success-message {
            position: fixed; top: 20px; right: 20px; background-color: var(--success);
            color: white; padding: 1rem 1.5rem; border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex;
            align-items: center; gap: 0.75rem; z-index: 1200;
            transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); width: 250px; }
            .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; }
            .search-bar { width: 250px; }
            .team-member-card { flex-wrap: wrap; }
        }
        @media (max-width: 768px) {
            .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; }
            .search-bar { width: 100%; order: 2; }
            .user-menu { width: 100%; justify-content: space-between; order: 1; }
            .content-area { padding: 1.5rem; }
            .data-form { grid-template-columns: 1fr; }
            .form-actions { grid-column: span 1; }
            .user-info { flex-direction: column; text-align: center; }
            .user-info-avatar { margin-bottom: 1rem; }
            .stats-section { grid-template-columns: 1fr; }
            .settings-tabs { flex-wrap: wrap; }
            .settings-tab { padding: 0.5rem 1rem; }
            .confirm-container { width: 90%; }
            .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .member-role { margin: 0.5rem 0; }
            .member-actions { margin-top: 0.5rem; }
            .profile-avatar-section { margin-bottom: 1.5rem; }
            #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
        }
        @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
        }

        /* Back button Styles */
        .back-button {
            display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary);
            font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem;
            border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent;
            font-size: 0.9rem;
        }
        .back-button:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }

        /* Notification sound */
        #notificationSound { display: none; }

        /* Helper class */
        .d-none { display: none !important; }

        /* Connection status in sidebar */
        .connection-status {
            padding: 0.75rem 1.5rem;
            margin-top: auto;
            border-top: 1px solid var(--sidebar-divider);
            display: flex; align-items: center; gap: 0.5rem;
            color: rgba(16, 185, 129, 0.9);
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--success); animation: pulseStatus 2s infinite;
        }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* Password error message */
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }

        /* Loading spinner */
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }

         /* Placeholder styling */
        .placeholder-content {
            text-align: center; padding: 4rem 2rem; color: var(--gray);
            border: 2px dashed var(--light-gray); border-radius: 8px;
            margin-top: 2rem; min-height: 300px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; }

         /* Feature-specific styles can be included here or within the loaded HTML's <style> */
         /* Example: Schedule specific styles might need adjustments */
         #featureSections .main-container { /* Styles for loaded schedule container */ }
         #featureSections .schedule-table { /* Styles for loaded schedule table */ }
         /* ... etc ... */

    </style>
</head>
<body class="blue-theme">
    <!-- HTML Structure Remains the Same -->
    <audio id="notificationSound" preload="auto">...</audio>
    <div class="success-message" id="successMessage">...</div>
    <aside class="sidebar" id="sidebar">...</aside>
    <main class="main-content">
        <nav class="top-nav">...</nav>
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;">...</div>
            <div id="dashboardContent" class="content-section active">...</div>
            <div class="content-section" id="profileContent">...</div>
            <div class="content-section" id="settingsContent">...</div>
            <div id="featureSectionsContainer" style="display: none;">
                <div id="featureSections" class="content-section">
                     <div class="placeholder-content" id="featurePlaceholder">...</div>
                </div>
            </div>
        </div>
    </main>
    <div class="notifications-modal" id="notificationsModal">...</div>
    <div class="confirm-modal" id="confirmModal">...</div>

    <script>
        // ======================================================
        // == START: Employee Schedule Specific JavaScript ==
        // == (Moved from employee-scheduling.txt) ==
        // ======================================================
        function initializeEmployeeSchedule(currentUserData, teamMembersData) {
            console.log("Initializing Employee Schedule...");
            const container = document.getElementById('featureSections').querySelector('#employeeScheduleContainer');
            if (!container) {
                console.error("Employee schedule container (#employeeScheduleContainer) not found within #featureSections!");
                const featurePlaceholder = document.getElementById('featurePlaceholder');
                const featureTitle = document.getElementById('featureTitle');
                const featureDescription = document.getElementById('featureDescription');
                const featureErrorMessage = featurePlaceholder?.querySelector('.error-message');
                if(featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                    featureTitle.textContent = "Error Initializing Schedule";
                    featureDescription.textContent = "Could not find the main schedule container element. Initialization aborted.";
                    featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = 'Container element missing.';
                    featurePlaceholder.style.display = 'flex';
                }
                return;
            }
            console.log("Schedule container found:", container);

            // --- DOM Elements (scoped to the container) ---
            const employeeModal = container.querySelector('#employeeModal');
            const shiftModal = container.querySelector('#shiftModal');
            const addEmployeeBtn = container.querySelector('#addEmployeeBtn');
            const sendRemindersBtn = container.querySelector('#sendRemindersBtn');
            const closeEmployeeModal = container.querySelector('#closeEmployeeModal');
            const closeShiftModal = container.querySelector('#closeShiftModal');
            const cancelEmployeeBtn = container.querySelector('#cancelEmployeeBtn');
            const cancelShiftBtn = container.querySelector('#cancelShiftBtn');
            const employeeForm = container.querySelector('#employeeForm');
            const shiftForm = container.querySelector('#shiftForm');
            const shiftTypeSelect = container.querySelector('#shiftType');
            const customShiftGroup = container.querySelector('#customShiftGroup');
            const prevWeekBtn = container.querySelector('#prevWeekBtn');
            const nextWeekBtn = container.querySelector('#nextWeekBtn');
            const weekDisplay = container.querySelector('#weekDisplay');
            const saveScheduleBtn = container.querySelector('#saveScheduleBtn');
            const scheduleTableBody = container.querySelector('#scheduleTableBody');
            const shiftDateInput = container.querySelector('#shiftDate');
            const toastNotification = container.querySelector('#scheduleToastNotification');

            const editEmpIdInput = container.querySelector('#editEmpId');
            const editDayInput = container.querySelector('#editDay');
            const editCellIdInput = container.querySelector('#editCellId');
            const shiftEmployeeDisplayInput = container.querySelector('#shiftEmployeeDisplay');

            // --- Error Check: Verify critical elements ---
            if (!employeeModal || !shiftModal || !scheduleTableBody || !toastNotification || !shiftForm || !employeeForm || !weekDisplay) {
                console.error("Initialization failed: One or more critical modal/form/table elements not found.", {
                    employeeModal, shiftModal, scheduleTableBody, toastNotification, shiftForm, employeeForm, weekDisplay
                });
                const featurePlaceholder = document.getElementById('featurePlaceholder');
                const featureTitle = document.getElementById('featureTitle');
                const featureDescription = document.getElementById('featureDescription');
                 const featureErrorMessage = featurePlaceholder?.querySelector('.error-message');
                if(featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                    featureTitle.textContent = "Error Initializing Schedule";
                    featureDescription.textContent = "Essential components (modals, table body, etc.) are missing. Initialization aborted.";
                    featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = 'Essential component missing.';
                    featurePlaceholder.style.display = 'flex';
                }
                return;
            }
            console.log("All critical schedule elements found.");

            // --- State & Data ---
            let currentUser = currentUserData;
            let employees = Array.isArray(teamMembersData)
                ? teamMembersData.map(member => ({
                    id: member.id, name: member.name, email: member.email, role: member.role }))
                : [];

            // Schedule Data - Load from localStorage or default
             let scheduleData = JSON.parse(localStorage.getItem('scheduleData')) || {
                 // Keep the example data as default if nothing in storage
                 "1-mon": { type: "morning", text: "9AM-5PM", notes: "" }, "1-tue": { type: "morning", text: "9AM-5PM", notes: "" }, "1-wed": { type: "afternoon", text: "12PM-8PM", notes: "" }, "1-thu": { type: "morning", text: "9AM-5PM", notes: "" }, "1-fri": { type: "day-off", text: "OFF", notes: "" }, "1-sat": { type: "night", text: "5PM-1AM", notes: "" }, "1-sun": { type: "night", text: "5PM-1AM", notes: "" },
                 "2-mon": { type: "afternoon", text: "12PM-8PM", notes: "" }, "2-tue": { type: "morning", text: "9AM-5PM", notes: "" }, "2-wed": { type: "morning", text: "9AM-5PM", notes: "" }, "2-thu": { type: "afternoon", text: "12PM-8PM", notes: "" }, "2-fri": { type: "morning", text: "9AM-5PM", notes: "" }, "2-sat": { type: "day-off", text: "OFF", notes: "" }, "2-sun": { type: "day-off", text: "OFF", notes: "" },
                 "3-mon": { type: "night", text: "5PM-1AM", notes: "" }, "3-tue": { type: "night", text: "5PM-1AM", notes: "" }, "3-wed": { type: "day-off", text: "OFF", notes: "" }, "3-thu": { type: "morning", text: "9AM-5PM", notes: "" }, "3-fri": { type: "afternoon", text: "12PM-8PM", notes: "" }, "3-sat": { type: "morning", text: "9AM-5PM", notes: "" }, "3-sun": { type: "sick-leave", text: "SICK", notes: "" },
                 "4-mon": { type: "vacation", text: "VAC", notes: "" }, "4-tue": { type: "vacation", text: "VAC", notes: "" }, "4-wed": { type: "morning", text: "9AM-5PM", notes: "" }, "4-thu": { type: "night", text: "5PM-1AM", notes: "" }, "4-fri": { type: "night", text: "5PM-1AM", notes: "" }, "4-sat": { type: "day-off", text: "OFF", notes: "" }, "4-sun": { type: "morning", text: "9AM-5PM", notes: "" },
             };

             function saveScheduleData() {
                 localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
             }

            // Start week logic (use passed preferences)
            let currentWeekStart = getStartOfWeek(new Date()); // Start with current week

             // Date range (adjust as needed)
             const minDate = new Date(currentWeekStart.getFullYear() -1, 0, 1); // Start of previous year
             const maxDate = new Date(currentWeekStart.getFullYear() + 1, 11, 31); // End of next year


            // --- Helper Functions ---
             function showToast(message, type = 'success') {
                 if (!toastNotification) { console.warn("Toast element not found."); return; }
                 toastNotification.textContent = message;
                 toastNotification.className = 'toast'; // Reset classes
                 if (type === 'success') {
                    toastNotification.classList.add('toast-success');
                 } else if (type === 'danger') {
                    toastNotification.classList.add('toast-danger');
                 }
                 toastNotification.classList.add('show');

                 if (toastNotification.timerId) clearTimeout(toastNotification.timerId);
                 toastNotification.timerId = setTimeout(() => {
                     toastNotification.classList.remove('show');
                     toastNotification.timerId = null;
                 }, 3000);
             }

             function getStartOfWeek(date) {
                 const dt = new Date(date);
                 const weekStartDay = currentUserData?.preferences?.weekStart === 'sun' ? 0 : 0; // Default Sunday
                 const dayOfWeek = dt.getDay(); // 0=Sun, 1=Mon...
                 const diff = dt.getDate() - dayOfWeek + (dayOfWeek < weekStartDay ? weekStartDay - 7 : weekStartDay);
                 dt.setDate(diff);
                 dt.setHours(0, 0, 0, 0);
                 return dt;
             }


            // --- Core Logic ---
            function renderSchedule() {
                console.log("Rendering schedule for week starting:", currentWeekStart.toDateString());
                if (!scheduleTableBody) { console.error("Cannot render: table body missing."); return; }
                scheduleTableBody.innerHTML = ''; // Clear

                updateWeekDisplayAndHeaders();

                if (employees.length === 0) {
                    const emptyRow = scheduleTableBody.insertRow();
                    const cell = emptyRow.insertCell();
                    cell.colSpan = 8; cell.textContent = "No employees found.";
                    cell.style.textAlign = 'center'; cell.style.padding = '2rem'; cell.style.color = 'var(--gray)';
                    applyRolePermissions();
                    return;
                }

                employees.forEach(emp => {
                    if (!emp || typeof emp.id === 'undefined' || !emp.name) {
                         console.warn("Skipping invalid employee data:", emp);
                         return; // Skip rendering if employee data is incomplete
                    }
                    const row = scheduleTableBody.insertRow();
                    row.insertCell().outerHTML = `<td class="employee-name">${emp.name}</td>`; // Use outerHTML for class

                    ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach(day => {
                        const cell = row.insertCell();
                        cell.className = "admin-controls";
                        cell.dataset.emp = emp.id;
                        cell.dataset.day = day;
                        const cellId = `cell-${emp.id}-${day}-${currentWeekStart.getTime()}`;
                        cell.id = cellId;

                        const shiftKey = `${emp.id}-${day}`; // Simplified key for example
                        const shiftInfo = scheduleData[shiftKey];

                        const editSpan = document.createElement('span');
                        editSpan.className = 'edit-shift';
                        editSpan.textContent = '(edit)';
                        editSpan.style.display = 'none'; // Hide initially

                        if (shiftInfo) {
                            const shiftDiv = createShiftDiv(shiftInfo.type, shiftInfo.text);
                            cell.appendChild(shiftDiv);
                        }
                         cell.appendChild(editSpan); // Always add the edit span
                    });
                });

                setupEditShiftListeners();
                applyRolePermissions();
                console.log("Schedule render complete.");
            }

            function createShiftDiv(type, text) {
                const shiftDiv = document.createElement('div');
                shiftDiv.className = 'shift';
                shiftDiv.textContent = text || '';
                 const typeClassMap = {
                    'morning': 'shift-morning', 'afternoon': 'shift-afternoon', 'night': 'shift-night',
                    'day-off': 'day-off', 'sick-leave': 'sick-leave', 'vacation': 'vacation',
                    'custom': 'shift-morning' // Default style for custom
                };
                shiftDiv.classList.add(typeClassMap[type] || 'shift-morning'); // Add class or default
                return shiftDiv;
            }

            function updateWeekDisplayAndHeaders() {
                if (!weekDisplay) return;

                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const options = { month: 'short', day: 'numeric' };
                const startStr = currentWeekStart.toLocaleDateString(currentUserData?.preferences?.language || 'en-US', options);
                const endStr = weekEnd.toLocaleDateString(currentUserData?.preferences?.language || 'en-US', options);
                const year = currentWeekStart.getFullYear();
                weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;

                const dateHeaderCells = container.querySelectorAll('.day-date');
                const nameHeaderCells = container.querySelectorAll('.day-name');
                const tempDate = new Date(currentWeekStart);
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                dateHeaderCells.forEach((cell, index) => {
                    if (index < days.length) {
                         const dateStr = tempDate.toLocaleDateString(currentUserData?.preferences?.language || 'en-US', { month: 'short', day: 'numeric' });
                        cell.textContent = dateStr;
                         if (nameHeaderCells[index]) nameHeaderCells[index].textContent = days[index];
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                });

                const prevWeekTest = new Date(currentWeekStart); prevWeekTest.setDate(prevWeekTest.getDate() - 7);
                if (prevWeekBtn) prevWeekBtn.disabled = prevWeekTest < minDate;

                const nextWeekTestEnd = new Date(weekEnd); nextWeekTestEnd.setDate(nextWeekTestEnd.getDate() + 1);
                if (nextWeekBtn) nextWeekBtn.disabled = nextWeekTestEnd > maxDate;
            }

            function applyRolePermissions() {
                console.log("Applying role permissions. Role:", currentUser?.role);
                 const isAdminOrSupervisor = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';

                if (addEmployeeBtn) addEmployeeBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';
                if (sendRemindersBtn) sendRemindersBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';
                if (saveScheduleBtn) saveScheduleBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';

                container.querySelectorAll('.edit-shift').forEach(el => {
                    el.style.display = isAdminOrSupervisor ? 'inline' : 'none';
                });
                 console.log("Admin buttons display set.");

            }

             // --- Event Listener Setup ---
             let isEditShiftListenerAttached = false; // Flag to prevent duplicate listeners
             function setupEditShiftListeners() {
                 if (!scheduleTableBody || isEditShiftListenerAttached) return; // Exit if no body or already attached
                 console.log("Setting up edit shift listeners on table body.");

                 scheduleTableBody.addEventListener('click', handleTableBodyClick);
                 isEditShiftListenerAttached = true; // Set the flag
                 console.log("Event listener added to schedule table body.");
             }

             // Remove listener when the feature is deactivated (optional but good practice)
             function removeEditShiftListeners() {
                 if (scheduleTableBody && isEditShiftListenerAttached) {
                     scheduleTableBody.removeEventListener('click', handleTableBodyClick);
                     isEditShiftListenerAttached = false;
                     console.log("Removed event listener from schedule table body.");
                 }
             }
             // TODO: Call removeEditShiftListeners() when navigating away from this feature in dashboard.js

             function handleTableBodyClick(event) {
                 if (event.target.classList.contains('edit-shift')) {
                     console.log("Edit shift clicked via delegation on:", event.target);
                     handleEditShiftClick(event.target); // Pass the clicked span
                 }
             }


            function handleEditShiftClick(buttonElement) {
                 if (!buttonElement) return;
                 console.log("handleEditShiftClick called for button:", buttonElement);
                const cell = buttonElement.closest('td.admin-controls');
                if (!cell) { console.error("Could not find parent cell."); return; }
                 console.log("Parent cell found:", cell.id);

                const empId = parseInt(cell.dataset.emp); // Use dataset
                const day = cell.dataset.day;       // Use dataset
                const cellId = cell.id;

                if (isNaN(empId) || !day) { console.error("Invalid empId or day from cell dataset."); return; }

                if (!shiftModal || !shiftEmployeeDisplayInput || !editEmpIdInput || !editDayInput || !editCellIdInput || !shiftDateInput || !shiftTypeSelect || !customShiftGroup) {
                     console.error("Shift modal or its internal elements are missing.");
                     showToast("Error: Cannot open edit dialog.", "danger"); return;
                 }

                const employee = employees.find(e => e.id === empId);
                const daysOfWeek = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
                const dayIndex = daysOfWeek.indexOf(day);

                if (employee && dayIndex !== -1) {
                     console.log(`Editing shift for Employee ID: ${empId}, Day: ${day}, Cell: ${cellId}`);
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + dayIndex);

                    shiftEmployeeDisplayInput.value = employee.name || 'Unknown';
                    editEmpIdInput.value = empId;
                    editDayInput.value = day;
                    editCellIdInput.value = cellId;

                    const formattedDate = date.toISOString().split('T')[0];
                    shiftDateInput.value = formattedDate;

                    const shiftKey = `${empId}-${day}`;
                    const currentShiftInfo = scheduleData[shiftKey];
                    const currentType = currentShiftInfo ? currentShiftInfo.type : 'clear';
                    const currentCustomText = currentShiftInfo && currentShiftInfo.type === 'custom' ? currentShiftInfo.text : '';
                    const currentNotes = currentShiftInfo ? currentShiftInfo.notes : '';

                    shiftTypeSelect.value = currentType;
                    customShiftGroup.style.display = currentType === 'custom' ? 'block' : 'none';
                    container.querySelector('#customShift').value = currentCustomText;
                    container.querySelector('#shiftNotes').value = currentNotes;

                     console.log("Showing shift modal.");
                    shiftModal.style.display = 'flex';
                } else {
                    console.error(`Could not find employee (ID: ${empId}) or invalid day index (${dayIndex}).`);
                }
            }

             function addEmployeeToSystem(name, email, role) {
                 console.log(`Attempting to add employee: ${name}, ${email}, Role: ${role}`);

                 if (!name || !email || !email.includes('@') || !role) {
                     showToast('Name, valid email, and role are required.', 'danger'); return false;
                 }
                 if (employees.some(e => e.email.toLowerCase() === email.toLowerCase())) {
                     showToast('Employee with this email already exists.', 'danger'); return false;
                 }

                 // --- Integration Point (Simulated) ---
                 // In a real app, this should update the main `teamMembers` array in dashboard.js
                 // and trigger a save (`saveData()`).
                 const newEmployeeId = teamMembersData.length > 0 ? Math.max(...teamMembersData.map(m => m.id)) + 1 : 1;
                 const newMember = { id: newEmployeeId, name, email, role, initials: name.split(' ').map(n=>n[0]).join('') };

                 // Update the array PASSED IN from the dashboard temporarily for this view
                 teamMembersData.push(newMember); // Modify the array reference passed in
                 // Update the local 'employees' copy used by the schedule render
                 employees = teamMembersData.map(member => ({ ...member }));

                 console.log("Dashboard teamMembersData (simulated update):", teamMembersData);
                 console.log("Local schedule employees updated:", employees);
                 // --- End Simulation ---

                 renderSchedule(); // Re-render schedule view
                 showToast(`Employee ${name} added.`, 'success');

                 // Optionally, navigate to the main team list?
                 // setActiveFeature('settings', 'team'); // Need access to this function

                 return true;
             }

            // --- Event Listeners ---
            if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => {
                 const newWeekStart = new Date(currentWeekStart); newWeekStart.setDate(newWeekStart.getDate() - 7);
                 if (newWeekStart >= minDate) { currentWeekStart = newWeekStart; renderSchedule(); }
            });
            if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => {
                 const nextWeekStart = new Date(currentWeekStart); nextWeekStart.setDate(nextWeekStart.getDate() + 7);
                 const nextWeekEnd = new Date(nextWeekStart); nextWeekEnd.setDate(nextWeekEnd.getDate() + 6);
                 if (nextWeekEnd <= maxDate) { currentWeekStart = nextWeekStart; renderSchedule(); }
            });
            if (shiftTypeSelect) shiftTypeSelect.addEventListener('change', function() {
                if (customShiftGroup) customShiftGroup.style.display = this.value === 'custom' ? 'block' : 'none';
            });

            // Modal Controls
            if (addEmployeeBtn) addEmployeeBtn.addEventListener('click', () => { if (employeeModal) employeeModal.style.display = 'flex'; });
            if (closeEmployeeModal) closeEmployeeModal.addEventListener('click', () => { if (employeeModal) employeeModal.style.display = 'none'; });
            if (cancelEmployeeBtn) cancelEmployeeBtn.addEventListener('click', () => { if (employeeModal) employeeModal.style.display = 'none'; });
            if (closeShiftModal) closeShiftModal.addEventListener('click', () => { if (shiftModal) shiftModal.style.display = 'none'; });
            if (cancelShiftBtn) cancelShiftBtn.addEventListener('click', () => { if (shiftModal) shiftModal.style.display = 'none'; });

             // Global click listener only for modals within this container
             container.addEventListener('click', function(event) {
                 if (employeeModal && event.target == employeeModal) employeeModal.style.display = 'none';
                 if (shiftModal && event.target == shiftModal) shiftModal.style.display = 'none';
             });


            // Add Employee Form
            if (employeeForm) employeeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = container.querySelector('#empName');
                const emailInput = container.querySelector('#empEmail');
                const roleSelect = container.querySelector('#empRole');
                if (nameInput && emailInput && roleSelect) {
                    if (addEmployeeToSystem(nameInput.value.trim(), emailInput.value.trim(), roleSelect.value)) {
                        employeeForm.reset();
                        if (employeeModal) employeeModal.style.display = 'none';
                    }
                }
            });

            // Edit Shift Form
            if (shiftForm) shiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log("Shift form submitted.");
                const empId = parseInt(editEmpIdInput.value);
                const day = editDayInput.value;
                const cellId = editCellIdInput.value;
                const shiftTypeValue = shiftTypeSelect.value;
                const customShiftText = container.querySelector('#customShift').value.trim();
                const notes = container.querySelector('#shiftNotes').value.trim();
                const cell = container.querySelector(`#${cellId}`);

                if (!cell || isNaN(empId) || !day) {
                     console.error("Error saving shift: Missing data or cell not found:", cellId);
                     showToast('Error saving shift. Cell reference lost.', 'danger'); return;
                }
                 console.log(`Saving shift for EmpID: ${empId}, Day: ${day}, CellID: ${cellId}, Type: ${shiftTypeValue}`);

                const shiftKey = `${empId}-${day}`;
                let shiftText = ''; let effectiveType = shiftTypeValue;

                switch(shiftTypeValue) {
                    case 'morning': shiftText = '9AM-5PM'; break;
                    case 'afternoon': shiftText = '12PM-8PM'; break;
                    case 'night': shiftText = '5PM-1AM'; break;
                    case 'day-off': shiftText = 'OFF'; break;
                    case 'sick-leave': shiftText = 'SICK'; break;
                    case 'vacation': shiftText = 'VAC'; break;
                    case 'custom': shiftText = customShiftText || 'Custom'; if (!customShiftText) effectiveType = 'morning'; break;
                    case 'clear':
                        delete scheduleData[shiftKey]; saveScheduleData(); // Save after delete
                        const existingShiftClear = cell.querySelector('.shift');
                        if (existingShiftClear) cell.removeChild(existingShiftClear);
                        showToast('Shift cleared.', 'success');
                        if (shiftModal) shiftModal.style.display = 'none';
                        console.log("Updated Schedule Data:", scheduleData); return;
                }

                scheduleData[shiftKey] = { type: effectiveType, text: shiftText, notes: notes };
                saveScheduleData(); // Save after update

                const existingShiftUpdate = cell.querySelector('.shift');
                if (existingShiftUpdate) cell.removeChild(existingShiftUpdate);
                const newShiftDiv = createShiftDiv(effectiveType, shiftText);
                const editSpan = cell.querySelector('.edit-shift');
                if (editSpan) cell.insertBefore(newShiftDiv, editSpan); else cell.appendChild(newShiftDiv);

                showToast('Shift updated.', 'success');
                if (shiftModal) shiftModal.style.display = 'none';
                console.log("Updated Schedule Data:", scheduleData);
            });

            // Save Schedule Button
            if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', () => {
                console.log("--- SAVING SCHEDULE ---");
                saveScheduleData(); // Save to localStorage (or send to server)
                showToast('Schedule saved.', 'success');
            });

            // Send Reminders Button
            if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', () => {
                 const subject = encodeURIComponent('Upcoming Work Schedule Reminder');
                 let body = `Dear Team,\n\nSchedule for the week of ${weekDisplay ? weekDisplay.textContent : 'current week'}:\n`;
                 employees.forEach(emp => {
                     body += `\n${emp.name}:\n`; let hasShift = false;
                     ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].forEach((day, index) => {
                         const shiftKey = `${emp.id}-${day}`; const shiftInfo = scheduleData[shiftKey];
                         if (shiftInfo) { const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; body += `  ${dayNames[index]}: ${shiftInfo.text}\n`; hasShift = true; }
                     }); if (!hasShift) body += `  No shifts assigned.\n`;
                 });
                 body += `\nBest regards,\n${currentUser.name}`;
                 const recipientEmails = employees.map(e => e.email).filter(Boolean).join(',');
                 if (recipientEmails) {
                     const mailtoLink = `mailto:?bcc=${recipientEmails}&subject=${subject}&body=${encodeURIComponent(body)}`;
                     window.open(mailtoLink, '_blank'); showToast('Reminder email prepared.', 'success');
                 } else { showToast('No employee emails found.', 'danger'); }
            });

            // --- Initial Setup ---
            try {
                renderSchedule(); // Initial render
            } catch (error) {
                 console.error("Error during initial schedule render:", error);
                 showToast("Failed to load schedule view.", "danger");
                 const featurePlaceholder = document.getElementById('featurePlaceholder');
                 const featureTitle = document.getElementById('featureTitle');
                 const featureDescription = document.getElementById('featureDescription');
                 const featureErrorMessage = featurePlaceholder?.querySelector('.error-message');
                 if(featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                     featureTitle.textContent = "Error Loading Schedule";
                     featureDescription.textContent = `An error occurred: ${error.message}`;
                     featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = error.message;
                     featurePlaceholder.style.display = 'flex';
                 }
            }
            console.log("Employee Schedule Initialized Successfully.");
        } // --- End of initializeEmployeeSchedule ---

        // ======================================================
        // == END: Employee Schedule Specific JavaScript ==
        // ======================================================


        // ======================================================
        // == START: Dashboard Core JavaScript ==
        // ======================================================
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsBody = document.getElementById('notificationsBody');
            const closeNotifications = document.getElementById('closeNotifications');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const userAvatar = document.getElementById('userAvatar');
            const userProfileDetails = document.querySelector('.user-profile-details');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const welcomeName = document.getElementById('welcomeName');
            const userDropdown = document.getElementById('userDropdown');
            const profileLink = document.getElementById('profileLink');
            const settingsLink = document.getElementById('settingsLink');
            const logoutLink = document.getElementById('logoutLink');
            const contentSections = document.querySelectorAll('.content-section');
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featureSections = document.getElementById('featureSections');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder?.querySelector('.loading-indicator'); // Added optional chaining
            const featureErrorMessage = featurePlaceholder?.querySelector('.error-message'); // Added optional chaining
            const profileForm = document.getElementById('profileForm');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const uploadPhotoButton = document.getElementById('uploadPhotoButton');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingsPanels = document.querySelectorAll('.settings-panel');
            const preferencesForm = document.getElementById('preferencesForm');
            const accountForm = document.getElementById('accountForm');
            const securityForm = document.getElementById('securityForm');
            const notificationsForm = document.getElementById('notificationsForm');
            const teamList = document.getElementById('teamList');
            const inviteMemberForm = document.getElementById('inviteMemberForm');
            const themeOptions = document.querySelectorAll('.theme-option');
            const layoutDensitySelect = document.getElementById('layoutDensity');
            const weekStartSelect = document.getElementById('weekStart');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const teamMembersCount = document.getElementById('teamMembersCount');
            const tasksCompleted = document.getElementById('tasksCompleted');
            const activeProjects = document.getElementById('activeProjects');
            const upcomingDeadlines = document.getElementById('upcomingDeadlines');
            const userInfoRoleTitle = document.getElementById('userInfoRoleTitle');
            const backButton = document.getElementById('backButton');
            const notificationSound = document.getElementById('notificationSound');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
            const cancelAccountBtn = document.getElementById('cancelAccountBtn');
            const cancelSecurityBtn = document.getElementById('cancelSecurityBtn');
            const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const currentPasswordError = document.getElementById('currentPasswordError');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const teamMembersTrend = document.getElementById('teamMembersTrend');
            const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
            const activeProjectsTrend = document.getElementById('activeProjectsTrend');
            const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
            const soundNotificationsSwitch = document.getElementById('soundNotifications');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const teamSettingsTab = document.getElementById('teamSettingsTab');
            const dangerZoneTab = document.getElementById('dangerZoneTab');

             // --- State Variables ---
            let currentUser = {};
            let teamMembers = []; // Holds confirmed team members
            let activities = [];
            let notifications = [];
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences'; // Default settings tab
            let activityIntervalId = null;
            let confirmCallback = null; // Store callback for confirmation modal
            let cancelCallback = null; // Store callback for cancel confirmation

            // --- Constants ---
            const MAX_ACTIVITIES_DISPLAYED = 5;
            const UPDATE_INTERVAL = 60000; // 60 seconds
            const SIMULATED_DELAY = 800; // ms for fake API calls
            const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500; // ms, matches animation duration
            const DEFAULT_USER = { // Default user if localStorage is empty
                 id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co',
                 title: 'Administrator', department: 'Management', phone: '+201234567890',
                 avatar: '', initials: 'ME', role: 'admin', password: 'password123', // !! INSECURE EXAMPLE PASSWORD !!
                 preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' },
                 notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } },
                 security: { twoFactorEnabled: true },
                 stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' }
            };


            // --- Initialization ---
            function initDashboard() {
                loadData();
                updateUserUI();
                loadTeamMembers();
                loadActivities();
                loadNotifications();
                updateStats();
                applyUserPreferences();
                applyRBAC();
                handleInitialNavigation();
                startActivityTimeUpdater();
                setupEventListeners();
                 console.log("Dashboard Initialized. Current User:", currentUser); // Log user data on init
            }

            // --- Data Handling ---
             function loadData() {
                const storedUser = JSON.parse(localStorage.getItem('currentUser')) || DEFAULT_USER;
                currentUser = deepMerge(DEFAULT_USER, storedUser); // Use deep merge

                 // Ensure default team members if none are stored
                teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [
                     { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', role: 'admin', initials: 'ME', avatar: '' },
                     { id: 2, name: 'Yousef', email: 'yousef@example.com', role: 'member', initials: 'Y', avatar: '' },
                     { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'member', initials: 'EL', avatar: '' },
                     { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'member', initials: 'BB', avatar: '' }
                ];
                activities = JSON.parse(localStorage.getItem('activities')) || [];
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
             }

             // Helper function for deep merging objects (handles nested objects)
             function deepMerge(target, source) {
                 const output = { ...target };
                 if (isObject(target) && isObject(source)) {
                     Object.keys(source).forEach(key => {
                         if (isObject(source[key])) {
                             if (!(key in target)) {
                                 Object.assign(output, { [key]: source[key] });
                             } else {
                                 output[key] = deepMerge(target[key], source[key]);
                             }
                         } else {
                             Object.assign(output, { [key]: source[key] });
                         }
                     });
                 }
                 return output;
             }
             function isObject(item) {
                 return (item && typeof item === 'object' && !Array.isArray(item));
             }


             function saveData() {
                 try {
                     localStorage.setItem('currentUser', JSON.stringify(currentUser));
                     localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                     localStorage.setItem('activities', JSON.stringify(activities));
                     localStorage.setItem('notifications', JSON.stringify(notifications));
                     console.log("Data saved to localStorage.");
                 } catch (e) {
                     console.error("Error saving data to localStorage:", e);
                     // Potentially show an error message to the user if storage is full
                     showConfirmModal({ title: "Storage Error", message: "Could not save data. Local storage might be full.", confirmText: "OK", confirmClass: "btn-primary", onConfirm: hideConfirmModal });
                 }
             }
             function clearUserData() {
                 localStorage.removeItem('currentUser');
                 localStorage.removeItem('teamMembers');
                 localStorage.removeItem('activities');
                 localStorage.removeItem('notifications');
                 localStorage.removeItem('scheduleData'); // Also clear schedule data
                 console.log("User data cleared from localStorage.");
             }


            // --- UI Update Functions ---
            // (updateUserUI, applyUserPreferences, applyRBAC, loadSettingsFormData, updateStats, updateTrendIndicator, updateNotificationBadge - Keep these as they were)
            // ... (Keep the existing UI update functions) ...
            function updateUserUI() {
                const nameParts = currentUser.name.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Top Nav & Welcome
                userName.textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email; // Ensure welcome email is updated
                welcomeName.textContent = firstName;

                // User Info Section (in Dashboard Welcome)
                document.querySelector('.user-info-name').textContent = currentUser.name;
                const roleTitles = { 'admin': 'Administrator', 'senior': 'Senior', 'supervisor': 'Supervisor', 'member': 'Member' };
                const roleTitle = roleTitles[currentUser.role] || 'Member';
                userInfoRoleTitle.textContent = roleTitle; // Update specific welcome role title
                // Apply role-specific styling to welcome title
                userInfoRoleTitle.classList.remove('role-admin'); // Clear previous class
                if (currentUser.role === 'admin') {
                    userInfoRoleTitle.classList.add('role-admin'); // Add admin class for red color
                }


                // Profile Form
                document.getElementById('firstName').value = firstName;
                document.getElementById('lastName').value = lastName;
                document.getElementById('jobTitle').value = currentUser.title || '';
                document.getElementById('phone').value = currentUser.phone || '';
                document.getElementById('department').value = currentUser.department || '';
                document.getElementById('email').value = currentUser.email; // Readonly email
                fullNameDisplay.value = currentUser.name; // Update readonly full name display

                // Account Settings Form (Readonly fields)
                document.getElementById('acc_firstName').value = firstName;
                document.getElementById('acc_lastName').value = lastName;
                document.getElementById('acc_email').value = currentUser.email;

                // Avatars (Small top, Small Welcome, Large Profile)
                const initials = currentUser.initials || (firstName ? firstName[0] : '') + (lastName ? lastName[0] : '');
                [userAvatar, profileAvatar, profileAvatarLarge].forEach(el => {
                    if(el){ // Check if element exists
                        if (currentUser.avatar) {
                            el.style.backgroundImage = `url(${currentUser.avatar})`;
                            el.textContent = ''; // Clear initials if image exists
                            el.style.backgroundColor = ''; // Clear bg color if image exists
                        } else {
                            el.style.backgroundImage = 'none';
                            el.textContent = initials.toUpperCase();
                            // Set appropriate background color based on theme if no image
                            el.style.backgroundColor = el === profileAvatarLarge ? 'var(--primary-light)' : 'var(--primary)';
                            if (el === profileAvatarLarge) el.style.color = 'var(--primary-dark)';
                            else el.style.color = 'white';
                        }
                    }
                });
            }

            function applyUserPreferences() {
                // Theme
                const theme = currentUser?.preferences?.theme || 'blue';
                document.body.className = ''; // Clear existing theme/layout classes
                document.body.classList.add(`${theme}-theme`);
                console.log("Applied theme:", theme);

                // Layout
                const layout = currentUser?.preferences?.layoutDensity || 'normal';
                document.body.classList.add(layout);
                console.log("Applied layout:", layout);

                // Update theme selector UI
                themeOptions.forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.theme === theme);
                });
                // Update layout selector UI
                if(layoutDensitySelect) layoutDensitySelect.value = layout;
                // Update settings form fields with current data
                loadSettingsFormData();
            }

            function applyRBAC() {
                const isAdmin = currentUser?.role === 'admin';
                const isSupervisor = currentUser?.role === 'supervisor';
                console.log(`Applying RBAC: isAdmin=${isAdmin}, isSupervisor=${isSupervisor}`);

                // Settings Tabs
                if (dangerZoneTab) {
                    dangerZoneTab.style.display = isAdmin ? 'block' : 'none';
                    dangerZoneTab.classList.toggle('disabled', !isAdmin);
                }
                // Example: Team Management visible to Admin/Supervisor
                 if (teamSettingsTab) {
                     const showTeamTab = isAdmin || isSupervisor;
                     teamSettingsTab.style.display = showTeamTab ? 'block' : 'none';
                     teamSettingsTab.classList.toggle('disabled', !showTeamTab);
                 }

                // Activity Deletion (buttons handled in loadActivities)

                // Team Management Actions (handled in loadTeamMembers)

                // Notification Deletion (handled in loadNotifications/updateBadge)

                // Account Deletion Button
                const deleteAccountBtn = document.getElementById('deleteAccountBtn');
                if (deleteAccountBtn) {
                    // Keep it disabled as it's a placeholder, but logic would be:
                    // deleteAccountBtn.disabled = !isAdmin;
                }
                 // Apply to potentially loaded dynamic content (like schedule buttons)
                 // This might be called again after dynamic content loads if necessary
                 const scheduleContainer = document.getElementById('employeeScheduleContainer');
                 if (scheduleContainer && currentFeature === 'employee-scheduling'){
                     const scheduleAddBtn = scheduleContainer.querySelector('#addEmployeeBtn');
                     const scheduleRemindBtn = scheduleContainer.querySelector('#sendRemindersBtn');
                     const scheduleSaveBtn = scheduleContainer.querySelector('#saveScheduleBtn');
                     const editSpans = scheduleContainer.querySelectorAll('.edit-shift');

                     if(scheduleAddBtn) scheduleAddBtn.style.display = isAdmin || isSupervisor ? 'inline-flex' : 'none';
                     if(scheduleRemindBtn) scheduleRemindBtn.style.display = isAdmin || isSupervisor ? 'inline-flex' : 'none';
                     if(scheduleSaveBtn) scheduleSaveBtn.style.display = isAdmin || isSupervisor ? 'inline-flex' : 'none';
                     editSpans.forEach(el => el.style.display = isAdmin || isSupervisor ? 'inline' : 'none');
                 }
            }

            function loadSettingsFormData() {
                 // Ensure structures exist using optional chaining and nullish coalescing
                 currentUser.preferences = currentUser.preferences ?? {};
                 currentUser.security = currentUser.security ?? {};
                 currentUser.notificationPreferences = currentUser.notificationPreferences ?? { email: {}, push: {} };
                 currentUser.notificationPreferences.email = currentUser.notificationPreferences.email ?? {};
                 currentUser.notificationPreferences.push = currentUser.notificationPreferences.push ?? {};

                // Preferences
                document.getElementById('selectedTheme').value = currentUser.preferences.theme ?? 'blue';
                if(layoutDensitySelect) layoutDensitySelect.value = currentUser.preferences.layoutDensity ?? 'normal';
                document.getElementById('language').value = currentUser.preferences.language ?? 'en';
                document.getElementById('dateFormat').value = currentUser.preferences.dateFormat ?? 'dd/mm/yyyy';
                if(weekStartSelect) weekStartSelect.value = currentUser.preferences.weekStart ?? 'sun';

                // Account
                document.getElementById('timezone').value = currentUser.preferences.timezone ?? 'cairo';

                // Security
                document.getElementById('twoFactorAuth').checked = currentUser.security.twoFactorEnabled ?? true;
                currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = '';
                currentPasswordError.style.display = 'none'; passwordMatchError.style.display = 'none';

                // Notifications
                document.getElementById('emailTasks').checked = currentUser.notificationPreferences.email.tasks ?? true;
                document.getElementById('emailDeadlines').checked = currentUser.notificationPreferences.email.deadlines ?? true;
                document.getElementById('emailUpdates').checked = currentUser.notificationPreferences.email.updates ?? false;
                document.getElementById('pushMessages').checked = currentUser.notificationPreferences.push.messages ?? true;
                document.getElementById('pushTeamUpdates').checked = currentUser.notificationPreferences.push.teamUpdates ?? false;
                if(soundNotificationsSwitch) soundNotificationsSwitch.checked = currentUser.preferences.soundNotifications ?? true;
            }

            function updateStats() {
                const stats = currentUser?.stats ?? {};
                 if (teamMembersCount) teamMembersCount.textContent = teamMembers.length;
                 if (tasksCompleted) tasksCompleted.textContent = stats.tasksCompleted ?? 0;
                 if (activeProjects) activeProjects.textContent = stats.activeProjects ?? 0;
                 if (upcomingDeadlines) upcomingDeadlines.textContent = stats.upcomingDeadlines ?? 0;

                if (currentUser?.stats) currentUser.stats.teamMembers = teamMembers.length;

                 // Update trends only if elements exist
                 if(teamMembersTrend) updateTrendIndicator(teamMembersTrend, stats.teamMembersTrend);
                 if(tasksCompletedTrend) updateTrendIndicator(tasksCompletedTrend, stats.tasksCompletedTrend);
                 if(activeProjectsTrend) updateTrendIndicator(activeProjectsTrend, stats.activeProjectsTrend);
                 if(upcomingDeadlinesTrend) updateTrendIndicator(upcomingDeadlinesTrend, stats.upcomingDeadlinesTrend);
            }

            function updateTrendIndicator(element, trendValue) {
                 if(!element) return; // Exit if element doesn't exist
                const trend = trendValue || 'neutral';
                let iconClass = 'fa-minus'; let trendClass = 'trend-neutral';
                let percentageValue = Math.floor(Math.random() * (trend === 'up' ? 50 : trend === 'down' ? 30 : 5)) + (trend === 'neutral' ? 0 : 1);
                let percentage = `${percentageValue}%`;

                if (trend === 'up') { iconClass = 'fa-arrow-up'; trendClass = 'trend-up'; }
                else if (trend === 'down') { iconClass = 'fa-arrow-down'; trendClass = 'trend-down'; }
                else { percentage = '0%'; }

                element.innerHTML = `<i class="fas ${iconClass}"></i> ${percentage}`;
                element.className = `stat-trend ${trendClass}`;
            }

            function updateNotificationBadge() {
                 if (!notificationBadge || !deleteAllNotificationsBtn) return; // Check elements
                const unreadCount = notifications.filter(n => !n.read).length;
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
                deleteAllNotificationsBtn.style.display = notifications.length > 0 && (currentUser?.role === 'admin' || currentUser?.role === 'supervisor') ? 'inline-flex' : 'none';
            }


            // --- Feature/Section Loading ---
             function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`Activating feature: ${featureId}, Tab: ${settingsTab}`);

                 // --- RBAC Checks ---
                 if (featureId === 'settings') {
                     const targetTab = settingsTab || currentSettingsTab || 'preferences';
                     if (targetTab === 'danger' && currentUser?.role !== 'admin') {
                         console.warn("Access denied: Danger Zone requires admin.");
                         setActiveFeature('dashboard'); return; // Redirect
                     }
                     if (targetTab === 'team' && !(currentUser?.role === 'admin' || currentUser?.role === 'supervisor')) {
                         console.warn("Access denied: Team Management requires admin/supervisor.");
                         setActiveFeature('dashboard'); return; // Redirect
                     }
                 }
                 // Add other feature-specific RBAC checks if needed

                 currentFeature = featureId;
                 currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);

                 // Update URL
                 let hash = `#${featureId}`;
                 if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                 if (window.location.hash !== hash) history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);

                 // Update Sidebar Menu
                 menuItems.forEach(item => item.classList.remove('active'));
                 const activeMenuItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`);
                 if (activeMenuItem) activeMenuItem.classList.add('active');

                 // Show/Hide Content Sections
                 contentSections.forEach(section => section.classList.remove('active'));
                 featureSectionsContainer.style.display = 'none';

                 // --- Dynamic Loading Logic ---
                 if (featureId === 'dashboard') {
                     dashboardContent.classList.add('active');
                     updateStats(); loadActivities();
                 } else if (featureId === 'profile') {
                     profileContent.classList.add('active');
                     updateUserUI();
                 } else if (featureId === 'settings') {
                     settingsContent.classList.add('active');
                     applyRBAC(); // Re-apply for tabs
                     activateSettingsTab(currentSettingsTab || 'preferences');
                 } else {
                     // Handle other features
                     featureSectionsContainer.style.display = 'block'; // Show container
                     featureSections.innerHTML = ''; // Clear previous
                      // Ensure placeholder elements exist before using them
                     if (featurePlaceholder && featureTitle && featureDescription && featureLoadingIndicator && featureErrorMessage) {
                        featureSections.appendChild(featurePlaceholder); // Add placeholder back
                        featureTitle.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`;
                        featureDescription.textContent = '';
                        featureLoadingIndicator.style.display = 'block';
                        featureErrorMessage.style.display = 'none';
                        featurePlaceholder.style.display = 'flex';
                    } else {
                         console.error("Placeholder elements missing, cannot show loading state.");
                         featureSections.innerHTML = '<p style="text-align:center; padding: 2rem; color: var(--gray);">Loading...</p>'; // Basic fallback
                     }


                     const filePath = `sections/${featureId}.html`;
                     console.log(`Fetching: ${filePath}`);

                     fetch(filePath)
                         .then(response => {
                             if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
                             return response.text();
                         })
                         .then(html => {
                             featureSections.innerHTML = html; // Inject HTML
                             featureSections.classList.add('active'); // Make section visible

                             // --- Call Initialization Function ---
                             if (featureId === 'employee-scheduling') {
                                 if (typeof initializeEmployeeSchedule === 'function') {
                                     try {
                                         console.log("Calling initializeEmployeeSchedule...");
                                         initializeEmployeeSchedule(
                                             JSON.parse(JSON.stringify(currentUser || DEFAULT_USER)),
                                             JSON.parse(JSON.stringify(teamMembers || []))
                                         );
                                     } catch (err) {
                                         console.error(`Error executing initializeEmployeeSchedule:`, err);
                                          if (featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                                            featureTitle.textContent = `Error Initializing ${featureId.replace(/-/g, ' ')}`;
                                            featureDescription.textContent = `Initialization failed. Check console. Error: ${err.message}`;
                                            if(featureLoadingIndicator) featureLoadingIndicator.style.display = 'none';
                                            featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = err.message;
                                            featurePlaceholder.style.display = 'flex';
                                        }
                                     }
                                 } else {
                                     console.error(`Critical Error: initializeEmployeeSchedule function not found!`);
                                     if (featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                                        featureTitle.textContent = `Error Initializing ${featureId.replace(/-/g, ' ')}`;
                                        featureDescription.textContent = `Setup script (initializeEmployeeSchedule) missing or failed to load.`;
                                        if(featureLoadingIndicator) featureLoadingIndicator.style.display = 'none';
                                        featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = 'Initialization function missing.';
                                        featurePlaceholder.style.display = 'flex';
                                     }
                                 }
                             }
                             // else if (featureId === 'other-feature') { /* Call other initializers */ }

                             // --- Hide Placeholder (if no error) ---
                             if (featureLoadingIndicator) featureLoadingIndicator.style.display = 'none';
                             if (featurePlaceholder && featureErrorMessage && featureErrorMessage.style.display !== 'block') {
                                 featurePlaceholder.style.display = 'none';
                             }
                         })
                         .catch(error => {
                             console.error(`Error loading feature '${featureId}' from '${filePath}':`, error);
                             if (featurePlaceholder && featureTitle && featureDescription && featureErrorMessage) {
                                featureTitle.textContent = `Error Loading ${featureId.replace(/-/g, ' ')}`;
                                featureDescription.textContent = `Could not load content. Error: ${error.message}`;
                                if(featureLoadingIndicator) featureLoadingIndicator.style.display = 'none';
                                featureErrorMessage.style.display = 'block'; featureErrorMessage.textContent = error.message;
                                featurePlaceholder.style.display = 'flex';
                             }
                             featureSections.classList.add('active'); // Still show section for error message
                         });
                 }

                 // Show/Hide Back Button
                 backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';
                 window.scrollTo(0, 0); // Scroll to top
             }


            // --- Other Dashboard Functions ---
            // (activateSettingsTab, handleInitialNavigation, loadActivities, loadNotifications, getTimeAgo, updateActivityTimes, startActivityTimeUpdater, loadTeamMembers, showConfirmModal, hideConfirmModal, handleProfileSave, handleProfileCancel, handleSettingsSave, handleSettingsCancel, handleInviteMember, handleEditMemberClick, handleDeleteMemberClick, handleDeleteActivityClick, handleDeleteAllActivities, markNotificationAsRead, handleMarkAllNotificationsRead, handleDeleteNotificationClick, handleDeleteAllNotifications, handleAvatarUpload, handleLogout, addActivity, addNotification, playNotificationSound, showSuccessMessage, setupEventListeners, handleSearch)
            // ... (Keep the rest of the dashboard functions as they were, ensuring they use correct selectors and handle potential null elements) ...
            function activateSettingsTab(tabId) {
                 // RBAC check
                 if (tabId === 'danger' && currentUser?.role !== 'admin') {
                     console.warn("Denied access to Danger Zone."); activateSettingsTab('preferences'); return;
                 }
                  if (tabId === 'team' && !(currentUser?.role === 'admin' || currentUser?.role === 'supervisor')) {
                     console.warn("Denied access to Team Management."); activateSettingsTab('preferences'); return;
                 }

                 currentSettingsTab = tabId;
                 settingsTabs.forEach(t => {
                     t.classList.remove('active');
                     if (!t.classList.contains('disabled') && t.dataset.tab === tabId) {
                         t.classList.add('active');
                     }
                 });
                 settingsPanels.forEach(p => p.classList.toggle('active', p.id === `${tabId}Panel`));

                 if (currentFeature === 'settings' && window.location.hash !== `#settings-${tabId}`) {
                     history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`);
                 }
                 if (tabId === 'team') loadTeamMembers();
                 else if (tabId === 'account') updateUserUI();
                 else if (['preferences', 'security', 'notifications'].includes(tabId)) loadSettingsFormData();
            }

            function handleInitialNavigation() {
                 const hash = window.location.hash.substring(1);
                 let featureId = 'dashboard'; let settingsTab = null;
                 if (hash) {
                     if (hash.startsWith('settings-')) {
                         featureId = 'settings';
                         settingsTab = hash.split('-')[1] || 'preferences';
                     } else {
                         const validFeature = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile';
                         if (validFeature) featureId = hash;
                     }
                 }
                 setActiveFeature(featureId, settingsTab);
            }

            function loadActivities(showAll = false) {
                if(!activityList) return; // Element check
                activityList.innerHTML = '';
                const canDeleteAny = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';

                if (activities.length === 0) {
                    activityList.innerHTML = `<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>`;
                     if(viewAllActivity) viewAllActivity.style.display = 'none';
                     if(deleteAllActivity) deleteAllActivity.style.display = 'none';
                    return;
                }

                const activitiesToShow = showAll ? activities : activities.slice().reverse().slice(0, MAX_ACTIVITIES_DISPLAYED);

                activitiesToShow.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    if (activity.isNew) { li.classList.add('new-activity'); delete activity.isNew; setTimeout(() => { li.classList.remove('new-activity'); }, NEW_ACTIVITY_HIGHLIGHT_DURATION); }
                    li.dataset.id = activity.id;
                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon || 'fa-info-circle'}"></i></div>
                        <div class="activity-content">
                            <div class="activity-message">${activity.message}</div>
                            <div class="activity-time" data-timestamp="${activity.timestamp}">${getTimeAgo(activity.timestamp)}</div>
                        </div>
                        <div class="activity-actions"> ${canDeleteAny ? `<i class="fas fa-trash delete-activity" title="Delete Activity"></i>` : ''} </div>
                    `;
                    if (!showAll) activityList.prepend(li); else activityList.appendChild(li);
                });

                activityList.querySelectorAll('.delete-activity').forEach(button => button.addEventListener('click', handleDeleteActivityClick));

                if(viewAllActivity) viewAllActivity.style.display = activities.length > MAX_ACTIVITIES_DISPLAYED && !showAll ? 'inline' : 'none';
                if(deleteAllActivity) deleteAllActivity.style.display = activities.length > 0 && canDeleteAny ? 'inline' : 'none';
            }

            function loadNotifications() {
                 if(!notificationsBody) return; // Element check
                 notificationsBody.innerHTML = '';
                 updateNotificationBadge();

                 if (notifications.length === 0) {
                    notificationsBody.innerHTML = `<div class="no-notifications-message">No notifications yet.</div>`;
                    return;
                 }
                 const canDeleteAny = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';

                 notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-list-item ${notification.read ? '' : 'unread'}`;
                    item.dataset.id = notification.id;
                    item.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon || 'fa-bell'}"></i></div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${getTimeAgo(notification.timestamp)}</div>
                        </div>
                        ${canDeleteAny ? `<i class="fas fa-trash delete-notification" title="Delete Notification"></i>` : ''}
                    `;
                    item.addEventListener('click', (e) => { if (!e.target.classList.contains('delete-notification')) markNotificationAsRead(notification.id, item); });
                    const deleteBtn = item.querySelector('.delete-notification');
                    if (deleteBtn) deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNotificationClick(notification.id); });
                    notificationsBody.appendChild(item);
                 });
            }

            function getTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                try { const now=new Date(),date=new Date(timestamp); if(isNaN(date.getTime()))return'Invalid date'; const s=Math.floor((now-date)/1e3); if(s<0)return'In the future'; let i=Math.floor(s/31536e3); if(i>=1)return date.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); i=Math.floor(s/2592e3); if(i>=1)return`${i} month${i==1?'':'s'} ago`; i=Math.floor(s/604800); if(i>=1)return`${i} week${i==1?'':'s'} ago`; i=Math.floor(s/86400); if(i>=1)return`${i} day${i==1?'':'s'} ago`; i=Math.floor(s/3600); if(i>=1)return`${i} hour${i==1?'':'s'} ago`; i=Math.floor(s/60); if(i>=1)return`${i} min${i==1?'':'s'} ago`; return s<10?'Just now':`${Math.floor(s)} secs ago`; } catch (e) { console.error("Error formatting time:",e); return "Error"; }
            }

            function updateActivityTimes() {
                if(activityList) activityList.querySelectorAll('.activity-time[data-timestamp]').forEach(el=>{const t=el.dataset.timestamp;if(t)el.textContent=getTimeAgo(t)});
                if(notificationsBody) notificationsBody.querySelectorAll('.notification-time').forEach(el=>{const item=el.closest('.notification-list-item'); const id=item?.dataset.id; if(id){const n=notifications.find(n=>n.id==id);if(n?.timestamp)el.textContent=getTimeAgo(n.timestamp)}});
            }

            function startActivityTimeUpdater() {
                if(activityIntervalId)clearInterval(activityIntervalId); updateActivityTimes(); activityIntervalId=setInterval(updateActivityTimes,UPDATE_INTERVAL);
            }

            function loadTeamMembers() {
                 if (!teamList) { console.warn("Team list element not found."); return; }
                 teamList.innerHTML = '';
                 const canManageGlobal = currentUser?.role === 'admin' || currentUser?.role === 'supervisor';
                 const canDeleteGlobal = currentUser?.role === 'admin';

                 if (teamMembers.length === 0) {
                     teamList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--gray);">No team members yet. Invite one below.</div>`;
                 } else {
                     teamMembers.forEach(member => {
                         if(!member || typeof member.id === 'undefined') { console.warn("Skipping invalid member data:", member); return; }

                         const memberCard = document.createElement('div');
                         memberCard.className = 'team-member-card'; memberCard.dataset.id = member.id;

                         const canManageThis = (canManageGlobal && !['admin', 'supervisor'].includes(member.role)) || (canDeleteGlobal && member.id !== currentUser?.id);
                         const canDeleteThis = canDeleteGlobal && member.id !== currentUser?.id;

                         let avatarContent = member.initials || member.email?.substring(0, 2).toUpperCase() || '??';
                         let avatarStyle = '';
                         if (member.avatar) { avatarStyle = `background-image: url(${member.avatar});`; avatarContent = ''; }

                         const role = member.role || 'member';
                         const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);

                         memberCard.innerHTML = `
                             <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                             <div class="member-details">
                                 <div class="member-name">${member.name || 'Unnamed Member'}</div>
                                 <div class="member-email">${member.email || 'No Email'}</div>
                             </div>
                             <div class="member-role role-${role}">${roleDisplay}</div>
                             <div class="member-actions">
                                 ${canManageThis ? `<button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-edit"></i></button>` : ''}
                                 ${canDeleteThis ? `<button class="btn btn-danger btn-sm delete-member" title="Delete Member"><i class="fas fa-trash"></i></button>` : ''}
                             </div>`;
                         teamList.appendChild(memberCard);
                     });
                     teamList.querySelectorAll('.edit-member').forEach(btn => btn.addEventListener('click', handleEditMemberClick));
                     teamList.querySelectorAll('.delete-member').forEach(btn => btn.addEventListener('click', handleDeleteMemberClick));
                 }
                 updateStats();
             }

            function showConfirmModal(config) {
                 if(!confirmModal) return; // Element check
                 confirmTitle.textContent = config.title || 'Confirm Action';
                 confirmMessage.innerHTML = config.message || 'Are you sure?';
                 confirmBtn.textContent = config.confirmText || 'Confirm';
                 cancelConfirmBtn.textContent = config.cancelText || 'Cancel';
                 confirmBtn.className = `btn ${config.confirmClass || 'btn-danger'}`;
                 confirmCallback = config.onConfirm || null;
                 cancelCallback = config.onCancel || null;
                 confirmModal.style.display = 'flex'; confirmBtn.focus();
            }
            function hideConfirmModal() { if(confirmModal) confirmModal.style.display = 'none'; confirmCallback=null; cancelCallback=null; }

            function handleProfileSave(e) {
                 e.preventDefault();
                 showConfirmModal({ title:'Save Profile Changes?', message:'Save changes to your profile?', confirmText:'Save', confirmClass:'btn-primary',
                     onConfirm: () => {
                         const firstName=document.getElementById('firstName').value.trim(); const lastName=document.getElementById('lastName').value.trim();
                         currentUser.name=`${firstName} ${lastName}`; currentUser.initials=(firstName?firstName[0]:'')+(lastName?lastName[0]:'');
                         currentUser.title=document.getElementById('jobTitle').value; currentUser.phone=document.getElementById('phone').value; currentUser.department=document.getElementById('department').value;
                         saveData(); updateUserUI(); addActivity('fa-user-edit','Updated profile information.'); showSuccessMessage('Profile updated!'); hideConfirmModal();
                     }, onCancel: hideConfirmModal
                 });
            }
            function handleProfileCancel() {
                const name = `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`;
                const title=document.getElementById('jobTitle').value; const phone=document.getElementById('phone').value; const department=document.getElementById('department').value;
                const isDirty=name!==currentUser.name || title!==(currentUser.title||'') || phone!==(currentUser.phone||'') || department!==(currentUser.department||'');
                if(!isDirty){ setActiveFeature('dashboard'); return; }
                showConfirmModal({ title:'Discard Profile Changes?', message:'Unsaved edits will be lost.', confirmText:'Discard', confirmClass:'btn-danger',
                     onConfirm: () => { updateUserUI(); hideConfirmModal(); setActiveFeature('dashboard'); }, onCancel: hideConfirmModal });
            }

            function handleSettingsSave(formId, panelId, successMsg) {
                 const form = document.getElementById(formId); if(!form) return;
                 const saveButton = form.querySelector('button[type="submit"]'); const spinner = form.querySelector('.spinner'); const loadingText = form.querySelector('.loading-text'); const btnText = form.querySelector('.btn-text');
                 if(saveButton) saveButton.disabled=true; if(spinner) spinner.style.display='inline-block'; if(loadingText) loadingText.style.display='inline'; if(btnText) btnText.style.display='none';
                 setTimeout(() => { try { let activityMessage=''; let valuesToSave={};
                     if (panelId==='preferencesPanel') { /* Collect prefs data */ currentUser.preferences.theme=document.getElementById('selectedTheme').value; currentUser.preferences.layoutDensity=layoutDensitySelect.value; currentUser.preferences.language=document.getElementById('language').value; currentUser.preferences.dateFormat=document.getElementById('dateFormat').value; currentUser.preferences.weekStart=weekStartSelect.value; valuesToSave={...currentUser.preferences}; activityMessage='Updated preferences.'; }
                     else if (panelId==='accountPanel') { /* Collect account data */ currentUser.preferences.timezone=document.getElementById('timezone').value; valuesToSave={timezone:currentUser.preferences.timezone}; activityMessage='Updated account settings.'; }
                     else if (panelId==='securityPanel') { /* Collect security data */ currentUser.security=currentUser.security??{}; const original2FA=currentUser.security.twoFactorEnabled; currentUser.security.twoFactorEnabled=document.getElementById('twoFactorAuth').checked; const currentPass=currentPasswordInput.value, newPass=newPasswordInput.value, confirmPass=confirmPasswordInput.value; valuesToSave={twoFactorEnabled:currentUser.security.twoFactorEnabled}; activityMessage='Updated security settings.'; currentPasswordError.style.display='none'; passwordMatchError.style.display='none'; if(newPass||confirmPass||currentPass){ if(!currentPass){currentPasswordError.textContent='Current password required';currentPasswordError.style.display='block';currentPasswordInput.focus();throw new Error('Current pwd missing.');} if(currentPass!==currentUser.password){currentPasswordError.textContent='Current password incorrect';currentPasswordError.style.display='block';currentPasswordInput.focus();throw new Error('Incorrect current pwd.');} if(!newPass){passwordMatchError.textContent='New password empty';passwordMatchError.style.display='block';newPasswordInput.focus();throw new Error('New pwd empty.');} if(newPass.length<8){passwordMatchError.textContent='Min 8 chars';passwordMatchError.style.display='block';newPasswordInput.focus();throw new Error('New pwd too short.');} if(newPass!==confirmPass){passwordMatchError.textContent='Passwords mismatch';passwordMatchError.style.display='block';confirmPasswordInput.focus();throw new Error('Pwd mismatch.');} currentUser.password=newPass; activityMessage='Changed password.'; valuesToSave.passwordChanged=true; currentPasswordInput.value=''; newPasswordInput.value=''; confirmPasswordInput.value=''; } else if(original2FA!==currentUser.security.twoFactorEnabled){ activityMessage='Updated 2FA setting.'; } }
                     else if (panelId==='notificationsPanel') { /* Collect notification data */ currentUser.notificationPreferences=currentUser.notificationPreferences??{email:{},push:{}}; currentUser.notificationPreferences.email=currentUser.notificationPreferences.email??{}; currentUser.notificationPreferences.push=currentUser.notificationPreferences.push??{}; currentUser.notificationPreferences.email.tasks=document.getElementById('emailTasks').checked; currentUser.notificationPreferences.email.deadlines=document.getElementById('emailDeadlines').checked; currentUser.notificationPreferences.email.updates=document.getElementById('emailUpdates').checked; currentUser.notificationPreferences.push.messages=document.getElementById('pushMessages').checked; currentUser.notificationPreferences.push.teamUpdates=document.getElementById('pushTeamUpdates').checked; currentUser.preferences.soundNotifications=soundNotificationsSwitch.checked; valuesToSave={...currentUser.notificationPreferences, soundNotifications: currentUser.preferences.soundNotifications}; activityMessage='Updated notifications.'; }
                     console.log(`Saving settings for ${panelId}:`,valuesToSave); saveData(); applyUserPreferences(); if(activityMessage) addActivity('fa-cogs',activityMessage); showSuccessMessage(successMsg||'Settings saved!');
                 } catch(error){ console.error(`Error saving ${panelId}:`,error.message); if(!error.message.includes('pwd')&&!error.message.includes('mismatch')&&!error.message.includes('missing'))showConfirmModal({title:"Save Error",message:`Could not save: ${error.message}`,confirmText:"OK",confirmClass:"btn-primary",onConfirm:hideConfirmModal}); }
                 finally { if(saveButton)saveButton.disabled=false; if(spinner)spinner.style.display='none'; if(loadingText)loadingText.style.display='none'; if(btnText)btnText.style.display='inline'; }
                 }, SIMULATED_DELAY);
            }
            function handleSettingsCancel(panelId) { showConfirmModal({ title:`Discard ${panelId.replace('Panel','')} Changes?`, message:'Unsaved changes lost.', confirmText:'Discard', confirmClass:'btn-danger', onConfirm:()=>{loadSettingsFormData();applyUserPreferences();hideConfirmModal();}, onCancel:hideConfirmModal }); }

            function handleInviteMember(e) {
                 e.preventDefault();
                 const emailInput=document.getElementById('inviteMemberEmail'); const roleSelect=document.getElementById('inviteMemberRole');
                 const email=emailInput.value.trim(); const role=roleSelect.value;
                 if(!email||!email.includes('@')){alert('Valid email required.');emailInput.focus();return;}
                 if(teamMembers.some(m=>m.email.toLowerCase()===email.toLowerCase())){alert('Email already exists.');emailInput.focus();return;}
                 if(role==='admin'&&currentUser?.role!=='admin'){alert('Only Admins can invite Admins.');roleSelect.focus();return;}
                 if(currentUser?.role==='supervisor'&&(role==='admin'||role==='supervisor')){alert('Supervisors cannot invite Admins/Supervisors.');roleSelect.focus();return;}
                 console.log(`--- SIMULATING INVITE --- To: ${email}, Role: ${role} ---`);
                 addActivity('fa-paper-plane',`${currentUser.name} invited ${email} as ${role}.`); showSuccessMessage(`Invitation sent to ${email}.`); if(inviteMemberForm)inviteMemberForm.reset();
            }

            function handleEditMemberClick(e) {
                 const card=e.target.closest('.team-member-card'); const memberId=parseInt(card?.dataset.id); const member=teamMembers.find(m=>m.id===memberId); if(!member)return;
                 const newName=prompt("Enter new name:",member.name||''); if(newName===null)return; // Cancelled
                 let newRole=member.role; const isAdmin=currentUser?.role==='admin'; const isSupervisor=currentUser?.role==='supervisor'; let canChangeRole=false; let allowedRolesPrompt='';
                 if(isAdmin&&member.id!==currentUser?.id){canChangeRole=true;allowedRolesPrompt='member, senior, supervisor, admin';}
                 else if(isSupervisor&&!['admin','supervisor'].includes(member.role)){canChangeRole=true;allowedRolesPrompt='member, senior';}
                 if(canChangeRole){ const promptedRole=prompt(`Enter new role (${allowedRolesPrompt}):`,member.role); if(promptedRole!==null){ const cleanRole=promptedRole.trim().toLowerCase(); if(allowedRolesPrompt.split(', ').includes(cleanRole)){newRole=cleanRole;} else{alert('Invalid role or permission denied.');}}}
                 else if(member.id!==currentUser?.id){alert("Permission denied to change role.");}
                 member.name=newName.trim()||'Unnamed Member'; member.role=newRole; member.initials=member.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()||member.email?.substring(0,2).toUpperCase()||'??';
                 saveData(); loadTeamMembers(); addActivity('fa-user-edit',`Updated details for ${member.email}`); showSuccessMessage('Member updated.');
            }

            function handleDeleteMemberClick(e) {
                 const card=e.target.closest('.team-member-card'); const memberId=parseInt(card?.dataset.id); const member=teamMembers.find(m=>m.id===memberId); if(!member)return;
                 if(currentUser?.role!=='admin'){alert('Only admins can delete members.');return;} if(member.id===currentUser?.id){alert("Cannot delete yourself.");return;}
                 showConfirmModal({ title:'Delete Team Member?', message:`Remove <strong>${member.name||member.email}</strong>?`, confirmText:'Delete', confirmClass:'btn-danger',
                     onConfirm:()=>{ const email=member.email; teamMembers=teamMembers.filter(m=>m.id!==memberId); saveData(); loadTeamMembers(); addActivity('fa-user-minus',`Removed member: ${email}`); addNotification('fa-user-minus',`Member removed: ${email}`); showSuccessMessage('Member deleted.'); hideConfirmModal(); }, onCancel:hideConfirmModal });
            }

            function handleDeleteActivityClick(e) {
                const li=e.target.closest('.activity-item'); const id=parseInt(li?.dataset.id); if(!id)return;
                if(!(currentUser?.role==='admin'||currentUser?.role==='supervisor')){alert('Deletion restricted.');return;}
                showConfirmModal({ title:'Delete Activity?', message:'Delete this record?', confirmText:'Delete', confirmClass:'btn-danger',
                     onConfirm:()=>{ activities=activities.filter(a=>a.id!==id); saveData(); loadActivities(viewAllActivity?.style.display==='none'&&activities.length>MAX_ACTIVITIES_DISPLAYED); showSuccessMessage('Activity deleted.'); hideConfirmModal(); }, onCancel:hideConfirmModal });
            }

            function handleDeleteAllActivities() {
                 if(!(currentUser?.role==='admin'||currentUser?.role==='supervisor')){alert('Deletion restricted.');return;} if(activities.length===0){showSuccessMessage('No activities.');return;}
                 showConfirmModal({ title:'Delete ALL Activities?', message:`Delete ALL ${activities.length} records?`, confirmText:'Delete All', confirmClass:'btn-danger',
                     onConfirm:()=>{ activities=[]; saveData(); loadActivities(); showSuccessMessage('All activities deleted.'); hideConfirmModal(); }, onCancel:hideConfirmModal });
            }

            function markNotificationAsRead(id, itemEl) { const n=notifications.find(n=>n.id==id); if(n&&!n.read){ n.read=true; saveData(); itemEl.classList.remove('unread'); updateNotificationBadge(); } }
            function handleMarkAllNotificationsRead() { let changed=false; notifications.forEach(n=>{if(!n.read){n.read=true;changed=true;}}); if(changed){saveData();loadNotifications();showSuccessMessage('Marked all read.');}else{showSuccessMessage('No unread.');} }

            function handleDeleteNotificationClick(id) { if(!(currentUser?.role==='admin'||currentUser?.role==='supervisor')){alert('Deletion restricted.');return;} showConfirmModal({ title:'Delete Notification?', message:'Delete this item?', confirmText:'Delete', confirmClass:'btn-danger', onConfirm:()=>{ notifications=notifications.filter(n=>n.id!=id); saveData(); loadNotifications(); showSuccessMessage('Notification deleted.'); hideConfirmModal(); }, onCancel:hideConfirmModal }); }
            function handleDeleteAllNotifications() { if(!(currentUser?.role==='admin'||currentUser?.role==='supervisor')){alert('Deletion restricted.');return;} if(notifications.length===0){showSuccessMessage('No notifications.');return;} showConfirmModal({ title:'Delete ALL Notifications?', message:`Delete ALL ${notifications.length} items?`, confirmText:'Delete All', confirmClass:'btn-danger', onConfirm:()=>{ notifications=[]; saveData(); loadNotifications(); showSuccessMessage('All notifications deleted.'); hideConfirmModal(); }, onCancel:hideConfirmModal }); }

            function handleAvatarUpload(e) {
                const file=e.target.files?.[0]; if(!file)return;
                if(!file.type.startsWith('image/')){alert('Image files only.');return;} if(file.size>2*1024*1024){alert('Max 2MB.');return;}
                const reader=new FileReader(); reader.onload=ev=>{ const url=ev.target?.result; if(!url)return; showConfirmModal({ title:'Update Profile Picture?', message:'Set this image?', confirmText:'Set Picture', confirmClass:'btn-primary', onConfirm:()=>{ currentUser.avatar=url; saveData(); updateUserUI(); addActivity('fa-camera','Changed profile picture.'); showSuccessMessage('Picture updated.'); hideConfirmModal(); }, onCancel:()=>{ if(profileAvatarInput)profileAvatarInput.value=null; hideConfirmModal(); } }); }; reader.onerror=()=>{alert('Error reading file.');} reader.readAsDataURL(file);
            }

            function handleLogout() { showConfirmModal({ title:'Logout?', message:'Sure you want to logout?', confirmText:'Logout', confirmClass:'btn-danger', onConfirm:()=>{ showSuccessMessage("Logging out..."); setTimeout(()=>{window.location.href='login.html';},500); }, onCancel:hideConfirmModal }); }

            function addActivity(icon, message) { const newAct={id:Date.now(),icon,message,timestamp:new Date().toISOString(),isNew:true}; activities.push(newAct); activities.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); saveData(); if(currentFeature==='dashboard')loadActivities(viewAllActivity?.style.display==='none'&&activities.length>MAX_ACTIVITIES_DISPLAYED); }
            function addNotification(icon, message) { const newNot={id:Date.now(),icon,message,timestamp:new Date().toISOString(),read:false}; notifications.unshift(newNot); saveData(); updateNotificationBadge(); if(notificationsModal?.style.display==='flex')loadNotifications(); if(currentUser?.preferences?.soundNotifications)playNotificationSound(); }
            function playNotificationSound() { if(notificationSound?.play)notificationSound.play().catch(e=>console.warn('Sound play fail:',e)); }
            function showSuccessMessage(message) { successMessageText.textContent=message; successMessage.classList.add('show'); setTimeout(()=>{successMessage.classList.remove('show');},3000); }


            // --- Setup Event Listeners ---
             function setupEventListeners() {
                 // Sidebar
                 menuItems.forEach(item=>item.addEventListener('click',e=>{ e.preventDefault(); setActiveFeature(item.dataset.feature); }));
                 // Back Button
                 if(backButton) backButton.addEventListener('click',()=>setActiveFeature('dashboard'));
                 // Browser Nav
                 window.addEventListener('popstate',e=>{ if(e.state)setActiveFeature(e.state.feature,e.state.tab); else handleInitialNavigation(); });
                 // Search
                 if(searchInput){ searchInput.addEventListener('input',handleSearch); searchInput.addEventListener('focus',handleSearch); }
                 document.addEventListener('click',e=>{ if(!e.target.closest('.search-bar') && searchResults) { searchResults.classList.remove('active'); searchResults.innerHTML=''; } });
                 // User Dropdown
                 if(userAvatar) userAvatar.addEventListener('click',()=>userDropdown?.classList.toggle('active'));
                 if(userProfileDetails) userProfileDetails.addEventListener('click',()=>userDropdown?.classList.toggle('active'));
                 if(profileLink) profileLink.addEventListener('click',e=>{e.preventDefault();userDropdown?.classList.remove('active');setActiveFeature('profile');});
                 if(settingsLink) settingsLink.addEventListener('click',e=>{e.preventDefault();userDropdown?.classList.remove('active');setActiveFeature('settings');});
                 if(logoutLink) logoutLink.addEventListener('click',e=>{e.preventDefault();userDropdown?.classList.remove('active');handleLogout();});
                 document.addEventListener('click',e=>{ if(!e.target.closest('.user-profile') && userDropdown) userDropdown.classList.remove('active'); });
                 // Notifications Modal
                 if(notificationIcon) notificationIcon.addEventListener('click',()=>{ if(notificationsModal){ notificationsModal.style.display='flex'; loadNotifications(); }});
                 if(closeNotifications) closeNotifications.addEventListener('click',()=>{ if(notificationsModal) notificationsModal.style.display='none'; });
                 if(notificationsModal) notificationsModal.addEventListener('click',e=>{ if(e.target===notificationsModal) notificationsModal.style.display='none'; });
                 if(markAllReadBtn) markAllReadBtn.addEventListener('click',handleMarkAllNotificationsRead);
                 if(deleteAllNotificationsBtn) deleteAllNotificationsBtn.addEventListener('click',handleDeleteAllNotifications);
                 // Activity List
                 if(viewAllActivity) viewAllActivity.addEventListener('click',()=>loadActivities(true));
                 if(deleteAllActivity) deleteAllActivity.addEventListener('click',handleDeleteAllActivities);
                 // Profile Form
                 if(profileForm) profileForm.addEventListener('submit',handleProfileSave);
                 if(cancelProfileBtn) cancelProfileBtn.addEventListener('click',handleProfileCancel);
                 if(uploadPhotoButton) uploadPhotoButton.addEventListener('click',()=>profileAvatarInput?.click());
                 if(profileAvatarInput) profileAvatarInput.addEventListener('change',handleAvatarUpload);
                 // Settings Tabs
                 settingsTabs.forEach(tab=>tab.addEventListener('click',()=>{ if(!tab.classList.contains('disabled')) activateSettingsTab(tab.dataset.tab); }));
                 // Settings Forms
                 if(preferencesForm) preferencesForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('preferencesForm','preferencesPanel','Preferences saved.');});
                 if(cancelPreferencesBtn) cancelPreferencesBtn.addEventListener('click',()=>handleSettingsCancel('preferencesPanel'));
                 if(accountForm) accountForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('accountForm','accountPanel','Account settings saved.');});
                 if(cancelAccountBtn) cancelAccountBtn.addEventListener('click',()=>handleSettingsCancel('accountPanel'));
                 if(securityForm) securityForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('securityForm','securityPanel','Security settings updated.');});
                 if(cancelSecurityBtn) cancelSecurityBtn.addEventListener('click',()=>handleSettingsCancel('securityPanel'));
                 if(notificationsForm) notificationsForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('notificationsForm','notificationsPanel','Notification settings saved.');});
                 if(cancelNotificationsBtn) cancelNotificationsBtn.addEventListener('click',()=>handleSettingsCancel('notificationsPanel'));
                 // Theme/Layout Live Apply
                 themeOptions.forEach(option=>option.addEventListener('click',function(){ const theme=this.dataset.theme; document.getElementById('selectedTheme').value=theme; themeOptions.forEach(opt=>opt.classList.remove('selected')); this.classList.add('selected'); document.body.className=''; document.body.classList.add(`${theme}-theme`); document.body.classList.add(layoutDensitySelect?.value||'normal'); applyRBAC(); }));
                 if(layoutDensitySelect) layoutDensitySelect.addEventListener('change',function(){ const density=this.value; document.body.classList.remove('compact','normal','spacious'); document.body.classList.add(density); const currentTheme=document.getElementById('selectedTheme')?.value||'blue'; document.body.classList.add(`${currentTheme}-theme`); applyRBAC(); });
                 // Team Invite Form
                 if(inviteMemberForm) inviteMemberForm.addEventListener('submit',handleInviteMember);
                 // Confirm Modal
                 if(confirmBtn) confirmBtn.addEventListener('click',()=>{ if(confirmCallback)confirmCallback(); });
                 if(cancelConfirmBtn) cancelConfirmBtn.addEventListener('click',()=>{ if(cancelCallback)cancelCallback(); hideConfirmModal(); });
                 if(confirmModal) confirmModal.addEventListener('click',e=>{ if(e.target===confirmModal)hideConfirmModal(); });
                 document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&confirmModal?.style.display==='flex')hideConfirmModal(); });
                 console.log("Dashboard Event Listeners Setup.");
             }


             // --- Search Function ---
             function handleSearch() {
                 if (!searchInput || !searchResults) return;
                 const searchTerm = searchInput.value.toLowerCase().trim();
                 searchResults.innerHTML = ''; searchResults.classList.remove('active');
                 if (searchTerm.length < 2) return;

                 const matchingUsers = teamMembers.filter(m => (m.name || '').toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm));
                 const matchingActivities = activities.filter(a => a.message.toLowerCase().includes(searchTerm));

                 if (matchingUsers.length === 0 && matchingActivities.length === 0) {
                     searchResults.innerHTML = `<div class="search-result-item" style="color: var(--gray);">No results found.</div>`;
                     searchResults.classList.add('active'); return;
                 }
                 searchResults.classList.add('active');

                 if (matchingUsers.length > 0) {
                     const header = document.createElement('div'); header.innerHTML = '<strong>Team Members</strong>'; header.style.cssText='padding:0.5rem 1rem 0.25rem; font-size:0.8rem; color:var(--gray);'; searchResults.appendChild(header);
                     matchingUsers.slice(0, 3).forEach(user => {
                         const item = document.createElement('div'); item.className='search-result-item'; item.innerHTML=`<i class="fas fa-user" style="margin-right:0.5rem;color:var(--primary);"></i> ${user.name} (${user.email})`;
                         item.onclick=()=>{ setActiveFeature('settings','team'); searchResults.classList.remove('active'); searchInput.value=''; }; searchResults.appendChild(item); });
                 }
                 if (matchingActivities.length > 0) {
                     const header = document.createElement('div'); header.innerHTML = '<strong>Recent Activities</strong>'; header.style.cssText='padding:0.5rem 1rem 0.25rem; font-size:0.8rem; color:var(--gray);'; searchResults.appendChild(header);
                     matchingActivities.slice(0, 3).forEach(activity => {
                         const item = document.createElement('div'); item.className='search-result-item'; item.innerHTML=`<i class="fas ${activity.icon||'fa-info-circle'}" style="margin-right:0.5rem;color:var(--secondary);"></i> ${activity.message.substring(0,50)}...`;
                         item.onclick=()=>{ setActiveFeature('dashboard'); const el=activityList?.querySelector(`.activity-item[data-id="${activity.id}"]`); if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.transition='background-color 0.3s ease-out'; el.style.backgroundColor='var(--primary-light)'; setTimeout(()=>el.style.backgroundColor='',1500); } searchResults.classList.remove('active'); searchInput.value=''; }; searchResults.appendChild(item); });
                 }
             }


            // --- Run Initialization ---
            initDashboard();

        }); // --- End of DOMContentLoaded ---
        // ======================================================
        // == END: Dashboard Core JavaScript ==
        // ======================================================
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome (Dashboard already includes it) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon - Ensuring it's present -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->

    <!-- JS Libraries (Needed for some features) - Defer loading -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script>


    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --info: #0dcaf0; /* Added for consistency */
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */

            /* High Contrast Variables (Initial basic setup) */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable (for request ✅ 2️⃣) - Aliased to existing variables */
            --text-color: var(--dark);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6; /* Light gray for weekend cells */
             --schedule-weekend-text: #9ca3af; /* Muted text for weekend OFF */
             /* Light Mode Shift Colors */
             --shift-morning-bg: #dbeafe;
             --shift-morning-text: #1e40af;
             --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe;
             --shift-afternoon-text: #0c4a6e;
             --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe;
             --shift-night-text: #5b21b6;
             --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4;
             --shift-off-text: #166534;
             --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2;
             --shift-sick-text: #991b1b;
             --shift-sick-border: #fecaca;
             --shift-vacation-bg: #ffedd5;
             --shift-vacation-text: #9a3412;
             --shift-vacation-border: #fed7aa;

            /* --- Team Members Feature Specific Variables (mapped from original) --- */
            --feature-team-bg: var(--white); /* Section background - use white for light mode */
            --feature-team-card-bg: var(--white);            /* Card background */
            --feature-team-border-color: var(--light-gray);       /* Border color */
            --feature-team-shadow-color: rgba(0, 0, 0, 0.05); /* Reduced shadow intensity */
            --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); /* Subtle shadow increase on hover */
            --feature-team-text-primary: var(--dark);       /* Names */
            --feature-team-text-secondary: var(--gray);     /* Emails */
            --feature-team-title-text: var(--dark);         /* Title text */
            --feature-team-title-bg: var(--light);     /* Soft Gray title background - use light */
            --feature-team-admin-color: var(--danger);        /* Slightly softer deep red */
            --feature-team-supervisor-color: var(--primary);   /* Professional blue */
            --feature-team-senior-color: var(--success);       /* Professional green */
            --feature-team-member-color: var(--gray);       /* Professional gray */
            --feature-team-card-border-radius: 12px;    /* Slightly more rounded */
            --feature-team-section-padding: 1.5rem; /* Match dashboard spacious padding */
            --feature-team-card-padding: 1.25rem;          /* Increased card padding slightly */
            --feature-team-grid-gap: 1.5rem;              /* Match dashboard grid gap */

            /* --- Projects Feature Specific Variables (mapped from original) --- */
            --feature-projects-body-bg: var(--primary-light);
            --feature-projects-card-bg: var(--white);
            --feature-projects-text-color: var(--text-color);
            --feature-projects-text-muted: var(--gray);
            --feature-projects-heading-color: var(--primary-dark);
            --feature-projects-border-color: var(--light-gray);
            --feature-projects-shadow-color: rgba(0, 0, 0, 0.08);
            --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12);
            --feature-projects-input-bg: var(--white);
            --feature-projects-input-border: var(--light-gray);
            --feature-projects-input-focus-border: var(--primary);
            --feature-projects-input-focus-shadow: rgba(37, 99, 235, 0.1);
            --feature-projects-primary-color: var(--primary);
            --feature-projects-primary-hover: var(--primary-dark);
            --feature-projects-primary-text: var(--white);
            --feature-projects-success-bg: #dcfce7; /* Light Green Bg */
            --feature-projects-success-text: #15803d; /* Dark Green Text */
            --feature-projects-success-progress: var(--success);
            --feature-projects-warning-bg: #fef3c7; /* Light Yellow Bg */
            --feature-projects-warning-text: #a16207; /* Dark Yellow Text */
            --feature-projects-warning-progress: var(--warning);
            --feature-projects-warning-btn-text: var(--dark); /* Dark text for yellow button */
            --feature-projects-info-bg: #e0f2fe; /* Light Blue Bg */
            --feature-projects-info-text: #075985; /* Dark Blue Text */
            --feature-projects-info-progress: var(--primary);
            --feature-projects-secondary-bg: var(--light-gray);
            --feature-projects-secondary-text: var(--gray);
            --feature-projects-secondary-progress: var(--gray);
            --feature-projects-danger-color: var(--danger);
            --feature-projects-danger-hover: #dc2626;
            --feature-projects-danger-text: var(--white);
            --feature-projects-progress-bar-bg: var(--light-gray);
            --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5); /* Use dashboard modal */

            /* --- START: Feature Specific Variables (from integrated files) --- */
             /* File Sharing & Others using similar vars*/
            --app-primary: var(--primary); /* Map to dashboard primary */
            --app-secondary: var(--gray); /* Map to dashboard gray */
            --app-success: var(--success); /* Map to dashboard success */
            --app-danger: var(--danger); /* Map to dashboard danger */
            --app-warning: var(--warning); /* Map to dashboard warning */
            --app-info: var(--info); /* Map to dashboard info */
            --app-light: var(--light); /* Map to dashboard light */
            --app-dark: var(--dark); /* Map to dashboard dark */
            --app-hover-bg: #eef4ff;
            --app-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%);
            /* Project Tracking & Reports using chart vars */
            --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-gray: #9E9E9E; --chart-purple: #9C27B0; --chart-cyan: #00BCD4; --chart-background: #F5F7FA; --chart-fill-opacity: 0.7; --chart-radar-fill-opacity: 0.15;
            --status-completed-bg: rgba(76, 175, 80, 0.15); --status-completed-text: #388E3C; --status-inprogress-bg: rgba(33, 150, 243, 0.15); --status-inprogress-text: #1976D2; --status-delayed-bg: rgba(255, 193, 7, 0.15); --status-delayed-text: #FFA000; --status-pending-bg: rgba(158, 158, 158, 0.15); --status-pending-text: #616161;
            --priority-high-bg: rgba(244, 67, 54, 0.15); --priority-high-text: #D32F2F; --priority-medium-bg: rgba(255, 193, 7, 0.15); --priority-medium-text: #FFA000; --priority-low-bg: rgba(76, 175, 80, 0.15); --priority-low-text: #388E3C;
            /* --- END: Feature Specific Variables --- */
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode (Existing + Refined) --- */
        body.high-contrast {
             --hc-text: #000000;
             --hc-background: #ffffff;
             --hc-primary: #0000ff;
             --hc-secondary: #008000;
             --hc-link: #0000ee;
             --hc-border: #000000;
             --dark: var(--hc-text);
             --light: var(--hc-background);
             --gray: var(--hc-text);
             --light-gray: var(--hc-border);
             --white: var(--hc-background);
             --primary: var(--hc-primary);
             --primary-dark: var(--hc-primary);
             --primary-light: #e0e0ff;
             --secondary: var(--hc-secondary);
             --success: var(--hc-secondary);
             --warning: #ffa500; /* Orange */
             --danger: #ff0000; /* Red */
             --info: #0000ee; /* Blue for HC */
             --sidebar-bg: var(--hc-background);
             --sidebar-text: var(--hc-text);
             --sidebar-hover: #e0e0e0;
             --sidebar-active: #c0c0c0;
             --sidebar-divider: var(--hc-border);
             --text-color: var(--hc-text);
             --schedule-weekend-bg: #dddddd; /* HC weekend BG */
             --schedule-weekend-text: var(--hc-text); /* HC weekend text */
             /* Mapped Feature Variables for HC */
             --feature-team-bg: var(--hc-background);
             --feature-team-card-bg: var(--hc-background);
             --feature-team-border-color: var(--hc-border);
             --feature-team-shadow-color: transparent;
             --feature-team-hover-shadow-color: transparent;
             --feature-team-text-primary: var(--hc-text);
             --feature-team-text-secondary: var(--hc-text);
             --feature-team-title-text: var(--hc-text);
             --feature-team-title-bg: var(--hc-background);
             --feature-team-admin-color: var(--danger);
             --feature-team-supervisor-color: var(--hc-primary);
             --feature-team-senior-color: var(--hc-secondary);
             --feature-team-member-color: var(--hc-text);
             --feature-projects-card-bg: var(--hc-background);
             --feature-projects-text-color: var(--hc-text);
             --feature-projects-text-muted: var(--hc-text);
             --feature-projects-heading-color: var(--hc-text);
             --feature-projects-border-color: var(--hc-border);
             --feature-projects-shadow-color: transparent;
             --feature-projects-shadow-hover-color: transparent;
             --feature-projects-input-bg: var(--hc-background);
             --feature-projects-input-border: var(--hc-border);
             --feature-projects-primary-color: var(--hc-primary);
             --feature-projects-primary-text: var(--hc-background);
             --feature-projects-success-bg: var(--hc-background);
             --feature-projects-success-text: var(--hc-secondary);
             --feature-projects-success-progress: var(--hc-secondary);
             --feature-projects-warning-bg: var(--hc-background);
             --feature-projects-warning-text: var(--hc-text);
             --feature-projects-warning-progress: var(--warning);
             --feature-projects-warning-btn-text: var(--hc-text);
             --feature-projects-info-bg: var(--hc-background);
             --feature-projects-info-text: var(--hc-primary);
             --feature-projects-info-progress: var(--hc-primary);
             --feature-projects-secondary-bg: var(--hc-background);
             --feature-projects-secondary-text: var(--hc-text);
             --feature-projects-secondary-progress: var(--hc-text);
             --feature-projects-danger-color: var(--danger);
             --feature-projects-danger-text: var(--hc-background);
             --feature-projects-progress-bar-bg: var(--hc-background);
              /* HC Shift Colors */
             --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border);
             --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border);
             --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border);
             --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border);
             --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border);
             --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border);
             /* HC File Sharing, Project Tracking, Reports Analytics */
             --app-primary: var(--hc-primary); --app-secondary: var(--hc-text); --app-success: var(--hc-secondary); --app-danger: var(--danger); --app-warning: var(--warning); --app-info: var(--hc-primary); --app-light: var(--hc-background); --app-dark: var(--hc-text); --app-hover-bg: #e0e0e0; --app-header-bg: var(--hc-primary);
             --chart-green: var(--hc-secondary); --chart-blue: var(--hc-primary); --chart-orange: var(--warning); --chart-red: var(--danger); --chart-gray: var(--hc-text); --chart-purple: #800080; --chart-cyan: var(--hc-primary); --chart-background: var(--hc-background);
             --status-completed-bg: transparent; --status-completed-text: var(--hc-secondary); --status-inprogress-bg: transparent; --status-inprogress-text: var(--hc-primary); --status-delayed-bg: transparent; --status-delayed-text: var(--warning); --status-pending-bg: transparent; --status-pending-text: var(--hc-text);
             --priority-high-bg: transparent; --priority-high-text: var(--danger); --priority-medium-bg: transparent; --priority-medium-text: var(--warning); --priority-low-bg: transparent; --priority-low-text: var(--hc-secondary);


             color: var(--text-color);
             background-color: var(--hc-background);
        }
        body.high-contrast .welcome-section,
        body.high-contrast .stat-card,
        body.high-contrast .top-nav,
        body.high-contrast .sidebar,
        body.high-contrast .activity-section,
        body.high-contrast .content-section,
        /* High Contrast for Feature Wrappers and specific internal elements */
        body.high-contrast #featureSectionsContainer > div[class*="-feature-wrapper"],
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section,
        body.high-contrast #featureSectionsContainer.projects-feature .project-card,
        body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper,
        body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-management-content,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
        body.high-contrast #featureSectionsContainer.filesharing-feature .card,
        body.high-contrast #featureSectionsContainer.filesharing-feature .filters-section,
        body.high-contrast #featureSectionsContainer.filesharing-feature #recentUploadsSection,
        body.high-contrast #featureSectionsContainer.filesharing-feature .upload-area,
        body.high-contrast #featureSectionsContainer.filesharing-feature .table,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .card,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-filters-section,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .chart-container,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-reminders,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .card,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-filters-section,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .chart-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table-container,
        body.high-contrast #featureSectionsContainer.data-management-feature /* Placeholder HC */
        {
            background: var(--hc-background) !important; /* Important to override specifics */
            border: 1px solid var(--hc-border);
            color: var(--text-color) !important; /* Important for text */
            box-shadow: none !important; /* Remove shadows in HC */
        }
        /* Modals in High Contrast */
        body.high-contrast .modal-content,
        body.high-contrast #featureSectionsContainer.filesharing-feature .modal-content
        {
             background-color: var(--hc-background);
             border: 2px solid var(--hc-border);
             color: var(--hc-text);
        }
        body.high-contrast .btn,
        body.high-contrast .form-control,
        body.high-contrast .search-bar input,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-filter input, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.projects-feature .project-search-input, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.projects-feature .project-filter-select,
        body.high-contrast #featureSectionsContainer.task-management-feature #search-input, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.task-management-feature .filters select,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form input,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form textarea,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form select,
        /* START: HC styles for inputs in newly added features */
        body.high-contrast #featureSectionsContainer.filesharing-feature .form-control,
        body.high-contrast #featureSectionsContainer.filesharing-feature .form-select,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .form-select,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .form-control
        /* END: HC styles for inputs */
        {
            border: 1px solid var(--hc-border);
            background: var(--hc-background);
            color: var(--text-color);
        }
        body.high-contrast .btn-primary,
        body.high-contrast #featureSectionsContainer.projects-feature .add-project-btn, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.task-management-feature .btn-primary, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.team-members-feature .add-team-member-btn,
        body.high-contrast #featureSectionsContainer.filesharing-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.employee-scheduling .btn-primary,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-primary /* Add if needed */
         {
            background-color: var(--hc-primary); color: var(--hc-background); border: 1px solid var(--hc-border);
        }
        body.high-contrast .btn-danger,
        body.high-contrast #featureSectionsContainer.filesharing-feature .btn-outline-danger,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-outline-danger
        { background-color: var(--danger); color: var(--hc-background); border: 1px solid var(--hc-border); }

        body.high-contrast .btn-warning { background-color: var(--warning); color: var(--hc-text); border: 1px solid var(--hc-border); }

        body.high-contrast .btn-success,
        body.high-contrast #featureSectionsContainer.filesharing-feature .btn-outline-success,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-outline-success
         { background-color: var(--hc-secondary); color: var(--hc-background); border: 1px solid var(--hc-border); }

        body.high-contrast .btn-info,
        body.high-contrast #featureSectionsContainer.filesharing-feature .btn-outline-info
        { background-color: var(--hc-primary); color: var(--hc-background); border: 1px solid var(--hc-border); } /* Map info to primary */

        body.high-contrast .btn-outline,
        body.high-contrast #featureSectionsContainer.filesharing-feature .btn-outline-secondary,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-outline-secondary,
        body.high-contrast #featureSectionsContainer.employee-scheduling .btn-outline
        { background: var(--hc-background); color: var(--hc-primary); border: 1px solid var(--hc-primary); }

        body.high-contrast .logo { color: var(--text-color); }
        body.high-contrast .logo-icon { color: var(--hc-primary); }
        body.high-contrast .menu-item { color: var(--text-color); border-left-color: transparent; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0; border-left-color: var(--hc-primary); color: var(--hc-text); }
        body.high-contrast .stat-card { border-left-width: 3px; background: var(--hc-background) !important; } /* Reset gradient */
        body.high-contrast .welcome-section { background: var(--hc-background); border: 1px solid var(--hc-border); color: var(--hc-text) !important;}
        body.high-contrast .welcome-section * { color: var(--hc-text) !important; } /* Force text color inside */
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text) !important; } /* Reset role color */

        body.high-contrast #featureSectionsContainer.team-members-feature .member-role, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.projects-feature .project-status, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.task-management-feature .status-badge, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.filesharing-feature .badge, /* File sharing badges */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .status-badge, /* Project Tracking badges */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .priority-badge,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .badge /* Reports badges */
         {
            border: 1px solid var(--hc-border); color: var(--hc-text) !important; background: none !important; padding: 3px 8px;
        }
        body.high-contrast #featureSectionsContainer.projects-feature .progress-bar { /* HC for Projects */
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast #featureSectionsContainer.projects-feature .progress-bar-container { background: var(--hc-background); border: 1px solid var(--hc-border); }
        body.high-contrast #featureSectionsContainer.projects-feature .project-participants span { /* HC for Projects */
             border: 1px solid var(--hc-border); color: var(--hc-text); background: none;
        }
         body.high-contrast .theme-preview { border: 2px solid var(--hc-border); background: var(--hc-background) !important; /* Override inline styles */ }
         body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary); }
         body.high-contrast .switch .slider { background-color: #999; border: 1px solid var(--hc-border); }
         body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary); }
         body.high-contrast .switch .slider:before { background-color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th { background: var(--hc-background); color: var(--hc-text); border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border: 1px solid var(--hc-border); background: var(--hc-background) !important; /* Override nth-child */ }
         body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name { background: var(--hc-background); border-right: 2px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-name,
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-date { color: var(--hc-text); }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift { border: 1px solid var(--hc-border); background: none !important; color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift-weekend-off { border: none; font-style: normal; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
         body.high-contrast #featureSectionsContainer.task-management-feature .modal-content,
         body.high-contrast #featureSectionsContainer.task-management-feature .controls { border: 1px solid var(--hc-border); }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card { border-left-width: 3px; }
         /* START: HC Table Styles */
        body.high-contrast .table,
        body.high-contrast #featureSectionsContainer.filesharing-feature .table,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table {
            border: 1px solid var(--hc-border);
            background-color: var(--hc-background) !important;
        }
        body.high-contrast .table thead,
        body.high-contrast #featureSectionsContainer.filesharing-feature .table thead,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table thead,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table thead {
             background-color: var(--hc-background) !important;
             border-bottom: 2px solid var(--hc-border);
             color: var(--hc-text) !important;
        }
        body.high-contrast .table tbody tr td,
        body.high-contrast #featureSectionsContainer.filesharing-feature .table tbody tr td,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table tbody td,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table tbody td {
            color: var(--hc-text) !important;
            border-color: var(--hc-border);
            vertical-align: middle;
        }
        body.high-contrast .table-hover > tbody > tr:hover > * {
            background-color: #e0e0e0 !important; /* HC hover */
            color: var(--hc-text) !important;
        }
        body.high-contrast #featureSectionsContainer.filesharing-feature .fancy-header-title,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-fancy-title {
            background: var(--hc-primary) !important;
            color: var(--hc-background) !important;
            border: 1px solid var(--hc-border);
        }
        body.high-contrast #featureSectionsContainer.filesharing-feature .file-icon {
             color: var(--hc-text) !important; /* Override specific colors */
        }
        body.high-contrast #featureSectionsContainer.filesharing-feature .upload-area {
             border: 2px dashed var(--hc-border);
             background-color: var(--hc-background);
        }
        body.high-contrast #featureSectionsContainer.filesharing-feature .upload-area i {
             color: var(--hc-text);
        }
        body.high-contrast #featureSectionsContainer.project-tracking-feature .chart-container canvas,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .chart-container canvas {
            border: 1px solid var(--hc-border); /* Add border to charts in HC */
        }
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar {
             border: 1px solid var(--hc-border);
             color: var(--hc-text) !important; /* Ensure text is readable */
             background: none !important;
        }
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table .progress,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table .progress {
             background: var(--hc-background);
             border: 1px solid var(--hc-border);
        }
        /* END: HC Table Styles */
        /* HC Pagination */
        body.high-contrast .pt-pagination button,
        body.high-contrast .pt-pagination span {
            border: 1px solid var(--hc-border);
            background-color: var(--hc-background);
            color: var(--hc-text);
        }
        body.high-contrast .pt-pagination button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }
        body.high-contrast .pt-pagination button:disabled {
            background-color: var(--hc-background);
            opacity: 0.6;
        }
        body.high-contrast .pt-pagination span.pt-page-info { border: none; background: none; }
        /* HC Charts */
        body.high-contrast .chart-title { color: var(--hc-text); }


        /* --- Sidebar Styles (Existing) --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles (Existing) --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles (Existing) --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; /* Smooth background transition */
        }
        /* ... other existing welcome, stats, activity styles ... */
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; color: inherit; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); }
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--secondary); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--white); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary); /* Colored border instead of top gradient */
            color: var(--dark); /* Ensure text inside uses appropriate theme color */
        }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--secondary); background: var(--stat-card-bg-2); }
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }

        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-title { font-size: 0.9rem; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        .stat-card:nth-child(1) .stat-value { color: #1e40af; }
        .stat-card:nth-child(2) .stat-value { color: #15803d; }
        .stat-card:nth-child(3) .stat-value { color: #b45309; }
        .stat-card:nth-child(4) .stat-value { color: #b91c1c; }

        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-color); } /* Use text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--text-color); } /* Use text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .activity-item:hover .delete-activity { opacity: 1; }
        .delete-activity:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }

        /* --- Profile & Settings Sections Styles (Existing) --- */
        .content-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; display: none; animation: fadeInContent 0.4s ease-in-out; } /* Hidden by default */
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem;} /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use text-color */
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; } /* Added justify-content */
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-warning { background-color: var(--warning); color: var(--primary-dark); } /* Warning button style */
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        /* Settings Sub-section */
        .settings-subsection { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--light-gray); }
        .settings-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-subsection h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 1rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; /* Default: Label takes full width */ }
        @media (min-width: 768px) { .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; } }
        .setting-item-label { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; } }


        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        /* Settings Panel Team Member Card Style */
        #settingsContent .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact #settingsContent .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious #settingsContent .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        #settingsContent .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        #settingsContent .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact #settingsContent .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        #settingsContent .member-details { flex: 1; min-width: 0; }
        #settingsContent .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use text-color */
        body.compact #settingsContent .member-name { font-size: 0.9rem; }
        #settingsContent .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact #settingsContent .member-email { font-size: 0.8rem; }
        #settingsContent .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact #settingsContent .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        #settingsContent .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        #settingsContent .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); }
        #settingsContent .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        #settingsContent .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        #settingsContent .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #settingsContent .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */
        .btn.loading .btn-text { display: none; } /* Hide original text when loading */

        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }

        /* --- Theme Styles & Dark Mode Overrides (Existing) --- */
        body.light-theme { /* ... existing light theme overrides ... */ --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; --text-color: var(--dark); background-color: var(--primary-light); }
        body.dark-theme { /* ... existing dark theme base ... */
             --primary: #3b82f6;
             --primary-dark: #1e40af;
             --primary-light: #1e293b;
             --light: #334155; /* Slightly lighter background for cards/sections */
             --white: #0f172a; /* Darkest background for body */
             --dark: #e2e8f0; /* Light text */
             --gray: #94a3b8; /* Lighter gray text */
             --light-gray: #475569; /* Darker borders/dividers */
             --text-color: var(--dark); /* Update text-color for dark mode */
             --schedule-weekend-bg: #262f3e; /* Darker gray for weekend cells */
             --schedule-weekend-text: #6b7280; /* Muted dark text for weekend OFF */
              /* Dark Mode Shift Colors */
             --shift-morning-bg: #1e3a8a;
             --shift-morning-text: #dbeafe;
             --shift-morning-border: #2563eb;
             --shift-afternoon-bg: #0e7490;
             --shift-afternoon-text: #ecfeff;
             --shift-afternoon-border: #22d3ee;
             --shift-night-bg: #581c87;
             --shift-night-text: #f3e8ff;
             --shift-night-border: #a855f7;
             --shift-off-bg: #064e3b;
             --shift-off-text: #d1fae5;
             --shift-off-border: #34d399;
             --shift-sick-bg: #881337;
             --shift-sick-text: #fecdd3;
             --shift-sick-border: #fb7185;
             --shift-vacation-bg: #7c2d12;
             --shift-vacation-text: #ffedd5;
             --shift-vacation-border: #fb923c;
             /* Mapped File Sharing, PT, RA Dark Variables */
             --app-primary: var(--primary); --app-secondary: var(--gray); --app-success: #4ade80; --app-danger: #f87171; --app-warning: #fcd34d; --app-info: #67e8f9; --app-light: var(--light); --app-dark: var(--dark); --app-hover-bg: #475569; --app-header-bg: linear-gradient(90deg, var(--primary-dark) 0%, #3b82f6 100%);
             --chart-green: #86efac; --chart-blue: #93c5fd; --chart-orange: #fcd34d; --chart-red: #fca5a5; --chart-gray: var(--gray); --chart-purple: #c084fc; --chart-cyan: #67e8f9; --chart-background: var(--light);
             --status-completed-bg: rgba(76, 175, 80, 0.2); --status-completed-text: #a7f3d0; --status-inprogress-bg: rgba(33, 150, 243, 0.2); --status-inprogress-text: #bfdbfe; --status-delayed-bg: rgba(255, 193, 7, 0.2); --status-delayed-text: #fde68a; --status-pending-bg: rgba(158, 158, 158, 0.2); --status-pending-text: var(--gray);
             --priority-high-bg: rgba(244, 67, 54, 0.2); --priority-high-text: #fecaca; --priority-medium-bg: rgba(255, 193, 7, 0.2); --priority-medium-text: #fde68a; --priority-low-bg: rgba(76, 175, 80, 0.2); --priority-low-text: #a7f3d0;


             background-color: var(--white); /* Use darkest for body */
             color: var(--text-color); /* Default text color */
            /* Mapped Team Members Dark Theme Variables */
            --feature-team-bg: var(--white); /* Darkest */
            --feature-team-card-bg: var(--light); /* Lighter dark */
            --feature-team-border-color: var(--light-gray);
            --feature-team-text-primary: var(--text-color);
            --feature-team-text-secondary: var(--gray);
            --feature-team-title-text: var(--text-color);
            --feature-team-title-bg: var(--light);
            /* Role colors remain the same (assuming they contrast well) */
            /* Mapped Projects Dark Theme Variables */
            --feature-projects-body-bg: var(--white);
            --feature-projects-card-bg: var(--light);
            --feature-projects-text-color: var(--text-color);
            --feature-projects-text-muted: var(--gray);
            --feature-projects-heading-color: #a5b4fc; /* Brighter heading in dark */
            --feature-projects-border-color: var(--light-gray);
            --feature-projects-input-bg: var(--primary-light);
            --feature-projects-input-border: var(--light-gray);
            --feature-projects-success-bg: #14532d; /* Darker green bg */
            --feature-projects-success-text: #a7f3d0; /* Lighter green text */
            --feature-projects-success-progress: #4ade80; /* Brighter Green */
            --feature-projects-warning-bg: #7f5d11; /* Darker orange/brown */
            --feature-projects-warning-text: #fef3c7; /* Lighter orange/brown text */
            --feature-projects-warning-progress: #facc15; /* Brighter Yellow */
            --feature-projects-warning-btn-text: #1f2937; /* Keep dark text */
            --feature-projects-info-bg: #1e40af; /* Darker blue */
            --feature-projects-info-text: #dbeafe; /* Lighter blue text */
            --feature-projects-info-progress: #60a5fa; /* Lighter Blue */
            --feature-projects-secondary-bg: #4b5563; /* Darker gray */
            --feature-projects-secondary-text: #d1d5db; /* Lighter gray text */
            --feature-projects-secondary-progress: var(--gray);
            --feature-projects-danger-color: #f87171; /* Lighter red */
            --feature-projects-danger-hover: #ef4444;
            --feature-projects-progress-bar-bg: var(--light-gray);
        }
        /* ... other existing dark theme overrides ... */
        body.dark-theme .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); } /* Lighter BG for nav */
        body.dark-theme .stat-card,
        body.dark-theme .activity-section,
        body.dark-theme .content-section,
        body.dark-theme #settingsContent .team-member-card,
        body.dark-theme .add-member-form,
        /* Dark theme for feature containers */
        body.dark-theme #featureSectionsContainer > div[class*="-feature-wrapper"], /* Base for wrappers */
        body.dark-theme #featureSectionsContainer.filesharing-feature .card,
        body.dark-theme #featureSectionsContainer.filesharing-feature .filters-section,
        body.dark-theme #featureSectionsContainer.filesharing-feature #recentUploadsSection,
        body.dark-theme #featureSectionsContainer.filesharing-feature .upload-area,
        body.dark-theme #featureSectionsContainer.filesharing-feature .table,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-filters-section,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .chart-container,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container,
        body.dark-theme #featureSectionsContainer.data-management-feature /* Placeholder */
        { background-color: var(--light); border-color: var(--light-gray); } /* Lighter BG for content cards */

        /* Dark theme for modals */
        body.dark-theme .modal-content,
        body.dark-theme #featureSectionsContainer.filesharing-feature .modal-content /* Apply to feature modals too */
        { background-color: var(--light); color: var(--text-color); border: 1px solid var(--light-gray);}

        body.dark-theme .search-bar input, body.dark-theme .form-control,
        /* Dark theme for feature inputs */
        body.dark-theme #featureSectionsContainer.filesharing-feature .form-control,
        body.dark-theme #featureSectionsContainer.filesharing-feature .form-select,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .form-select,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .form-control
        { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); } /* Even darker BG for inputs */
        body.dark-theme .form-control[readonly] { background-color: var(--light); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item { color: var(--text-color); } /* Ensure search result text is light */
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item { color: var(--text-color); } /* Ensure dropdown text is light */
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--light); } /* Lighter BG for notifications panel */
        body.dark-theme .notification-list-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); } /* Slightly more visible unread */
        body.dark-theme .confirm-container { background-color: var(--light); color: var(--text-color); } /* Modal background and default text */
        body.dark-theme .theme-option .theme-preview { border-color: var(--light-gray); background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%); /* Adjust preview */ }
        body.dark-theme .theme-option .light-preview { background: var(--light) !important; }
        body.dark-theme .theme-option .dark-preview { background: var(--white) !important; }
        body.dark-theme .theme-option .system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray);}
        body.dark-theme .theme-option.selected .theme-preview { border-color: var(--primary); }
        body.dark-theme .theme-option .theme-label { color: var(--text-color); }
        body.dark-theme .back-button { color: var(--primary); } /* Use primary color for link */
        body.dark-theme .back-button:hover { background-color: var(--light); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--light); border-top-color: var(--light-gray); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white) !important; } /* Welcome section retains white text */
        body.dark-theme .welcome-section * { color: var(--white) !important; } /* Force inner text white */
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; } /* Inherit white */
        body.dark-theme .user-info-name { color: inherit; } /* Inherit white */
        body.dark-theme .user-info-title { color: var(--gray) !important; } /* Role title uses gray */
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager) !important; }
        body.dark-theme .user-info-email span { color: inherit; } /* Inherit white */
        body.dark-theme .stat-card { background: var(--light); color: var(--text-color);} /* Dark theme stat card background, ensure text color */
        body.dark-theme .stat-title { color: var(--text-color); } /* Ensure stat title is light */
        /* Specific stat value colors adjusted for dark theme */
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; }
        body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; }
        body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; }
        body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; } /* Adjust icon color */
        body.dark-theme .activity-item { border-bottom-color: var(--light-gray); }
        body.dark-theme .activity-message { color: var(--text-color); } /* Activity text */
        body.dark-theme .activity-time { color: var(--gray); } /* Activity time */
        body.dark-theme .activity-item.new-activity { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(239, 68, 68, 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--text-color); } /* Text label */
        body.dark-theme #profileAvatarLarge { background-color: var(--light); color: var(--text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); } /* Profile intro text */
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--light-gray); }
        body.dark-theme .placeholder-content h2 { color: var(--text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--text-color); } /* Ensure error text readable */
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--text-color); } /* Form labels */
        body.dark-theme .settings-subsection h4 { color: #93c5fd; } /* Lighter primary */
        body.dark-theme .setting-item-label { color: var(--text-color); } /* Setting item title */
        body.dark-theme .setting-item-description { color: var(--gray); } /* Setting item description */
        body.dark-theme .qr-code-placeholder { border-color: var(--light-gray); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; } /* Ensure danger button stands out */
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); } /* Danger zone description */
        body.dark-theme .checkbox-group { border-color: var(--light-gray); }
        body.dark-theme .checkbox-group label { color: var(--text-color); } /* Checkbox label text */
        body.dark-theme .confirm-title { color: var(--text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: #93c5fd; } /* Lighter primary */
        body.dark-theme #settingsContent .team-member-card .member-name { color: var(--text-color); }
        body.dark-theme #settingsContent .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--text-color); } /* Ensure bold text is readable */
        body.dark-theme .user-name { color: var(--text-color); } /* Top nav user name */
        body.dark-theme .toast { background-color: var(--light); color: var(--text-color); } /* Dark theme toast */
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }

        /* --- Dark Theme: Employee Scheduling --- */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-bottom-color: var(--light-gray);} /* Adjusted for better contrast */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--text-color); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); } /* Darker even row background */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; } /* Hover effect */
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--white); border-right-color: var(--light-gray); color: var(--text-color); } /* Dark sticky column bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: var(--text-color); } /* Day name text color */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; } /* Dark weekend bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; font-style: italic;}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title { color: #93c5fd; }
        /* Dark theme shift colors defined in :root.dark-theme */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border);}


        /* --- Dark Theme: Task Management (Existing + Overrides) --- */
        body.dark-theme #featureSectionsContainer.task-management-feature { background-color: var(--white); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-page-header { background-color: var(--primary-dark); color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content h1 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .controls { background-color: var(--primary-light); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content #search-input,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .filters select { background-color: var(--white); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .search-icon { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { background-color: var(--primary-light); color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--light); border-color: var(--light-gray); border-left-color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-High { border-left-color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Medium { border-left-color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Low { border-left-color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card p { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-meta { color: var(--gray); border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-badge { color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); color: #333; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: #3b82f6; color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: var(--success); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta,
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn:hover { color: #a71d2a; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn:hover { color: #1e7e34; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn:hover { color: #d39e00; }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal { background-color: rgba(0, 0, 0, 0.7); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn:hover { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content #modal-title { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content label { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="text"],
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="date"],
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content textarea,
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .form-actions { border-top-color: var(--light-gray); }

        /* --- Dark Theme: Team Members Feature --- */
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-members-section { background-color: var(--feature-team-bg); border-color: var(--feature-team-border-color);}
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-members-section-header { background-color: var(--feature-team-title-bg); color: var(--feature-team-title-text); border-bottom-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-filter input[type="text"] { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-filter input[type="text"]::placeholder { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-member-card { background-color: var(--feature-team-card-bg); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .team-member-card:hover { border-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .member-name { color: var(--feature-team-text-primary); }
        body.dark-theme #featureSectionsContainer.team-members-view-feature .member-email { color: var(--feature-team-text-secondary); }
        /* Role colors might need slight adjustment for dark mode if contrast is low, but using existing vars for now */
        body.dark-theme #featureSectionsContainer.team-members-view-feature .member-role.role-member { background-color: #4b5563; color: #d1d5db;} /* Example adjustment */

        /* --- Dark Theme: Projects Feature --- */
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--feature-projects-card-bg); border-left-color: var(--feature-projects-primary-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-controls { background-color: var(--feature-projects-card-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-search-input,
        body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-projects-input-border); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-card { background-color: var(--feature-projects-card-bg); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--feature-projects-progress-bar-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info i { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); color: var(--feature-projects-text-color); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-actions { border-top-color: var(--feature-projects-border-color); }
        /* Dark theme table headers for features */
        body.dark-theme #featureSectionsContainer.filesharing-feature .table thead,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table thead,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table thead {
            background-color: var(--primary-light) !important;
            color: var(--gray);
        }
        body.dark-theme #featureSectionsContainer.filesharing-feature .table-hover > tbody > tr:hover > *,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .table-hover > tbody > tr:hover > * {
             background-color: var(--light-gray) !important;
        }
        body.dark-theme #featureSectionsContainer.filesharing-feature .fancy-header-title,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-fancy-title {
             background: var(--app-header-bg); /* Keep original gradient or adjust */
             color: var(--white);
        }
        body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon {
            /* Use specific colors for dark theme if needed */
             color: inherit;
        }
         body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon.text-danger { color: var(--app-danger) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon.text-success { color: var(--app-success) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon.text-warning { color: var(--app-warning) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon.text-primary { color: var(--app-primary) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .file-icon.text-info { color: var(--app-info) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .upload-area {
             background-color: var(--primary-light); border-color: var(--light-gray);
         }
         body.dark-theme #featureSectionsContainer.filesharing-feature .upload-area i { color: var(--primary); }
         body.dark-theme #featureSectionsContainer.filesharing-feature .badge { color: var(--dark); /* Ensure text is readable */}
         body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-primary { background-color: var(--app-primary) !important; color: white !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-secondary { background-color: var(--app-secondary) !important; color: white !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-warning { background-color: var(--app-warning) !important; color: var(--dark) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-info { background-color: var(--app-info) !important; color: var(--dark) !important; }
         body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-dark { background-color: var(--dark) !important; color: var(--light) !important; }
         body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-medium { color: #1f2937 !important; } /* Darker text for dark orange */
         body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-medium { color: #1f2937 !important; } /* Darker text for dark orange */


        /* --- Notifications Modal, Confirm Modal, Utils (Existing) --- */
        /* ... existing styles for these elements ... */
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-modal.active { display: flex; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start; /* Align top */ cursor: pointer; position: relative; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.08); font-weight: 500; } /* Adjusted unread bg slightly */
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); } /* Dark theme unread */
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        body.dark-theme .notification-icon-wrapper { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa;}
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--text-color); line-height: 1.4; } /* Use text-color */
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0; /* Hidden by default */ transition: opacity 0.2s; position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem; background: var(--white); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .notification-list-item:hover .delete-notification { opacity: 0.6; } /* Show on hover */
        .delete-notification:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); }
        body.dark-theme .delete-notification { background: var(--light); }
        body.dark-theme .delete-notification:hover { background: rgba(239, 68, 68, 0.2); }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); flex-wrap: wrap; gap: 0.5rem; } /* Added wrap */
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-modal.active { display: flex; }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); } /* Use text-color */
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; }
        .d-none { display: none !important; }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s, color 0.3s; }
        .placeholder-content h2 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .placeholder-content p { color: var(--gray); } /* Ensure placeholder text uses gray */
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; text-align: left; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; max-width: 100%; overflow-wrap: break-word; }


        /* --- Generic Modal Styles (Existing + Edit Member/Add Member) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1050; /* Higher than confirm modal */
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--white); width: 100%; max-width: 550px; /* Slightly wider for member form */
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem; max-height: 90vh; overflow-y: auto; animation: zoomIn 0.3s ease-out;
            color: var(--text-color); /* Default text color for modal content */
        }
        /* Specific modal content width */
        .modal#filePreviewModal .modal-content { max-width: 1140px; /* Bootstrap XL */}
        .modal#uploadFileModal .modal-content { max-width: 500px; /* Bootstrap default */ }
        .modal#projectModal .modal-content { max-width: 700px; /* Custom wider */ }
        .modal#editShiftModal .modal-content { max-width: 450px; } /* Shift edit modal */
        .modal#task-modal .modal-content { max-width: 650px; } /* Task modal */

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray);
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        body.dark-theme .modal-title { color: #93c5fd; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1;}
        .close-modal:hover { color: var(--danger); }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- Checkbox Group (Existing) --- */
         .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: 6px; }
         .checkbox-group label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--text-color); }
         .checkbox-group input[type="checkbox"] { width: auto; margin-right: 0.25rem; }
         .settings-link { color: var(--primary); text-decoration: none; cursor: pointer; }
         .settings-link:hover { text-decoration: underline; color: var(--primary-dark); }

        /* --- Toast (Existing) --- */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1300; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }

        /* --- Employee Scheduling Table Refinements --- */
        #featureSectionsContainer.employee-scheduling-feature .schedule-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center; /* Align items vertically */
            margin-bottom: 1.5rem;
        }
        /* Container for the main control buttons */
        #featureSectionsContainer.employee-scheduling-feature .schedule-controls .week-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        /* Container for admin buttons (Save, Send Reminders) */
        #featureSectionsContainer.employee-scheduling-feature .schedule-controls .admin-actions {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 0.5rem; /* Space between stacked buttons */
            margin-left: auto; /* Push to the right */
        }
        @media (max-width: 768px) { /* On mobile, stack everything */
            #featureSectionsContainer.employee-scheduling-feature .schedule-controls {
                 flex-direction: column;
                 align-items: stretch;
            }
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .week-nav {
                 justify-content: space-between; /* Space out Prev/Next */
                 width: 100%;
             }
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .admin-actions {
                 margin-left: 0; /* Remove auto margin */
                 width: 100%;
             }
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .admin-actions .btn {
                 width: 100%;
                 justify-content: center;
             }
        }

        #featureSectionsContainer.employee-scheduling-feature .schedule-container {
            margin-top: 1rem;
            overflow-x: auto; /* Enable horizontal scroll on container */
            border: 1px solid var(--light-gray); /* Add border to container */
            border-radius: 8px;
            background-color: var(--white); /* Ensure container has BG */
        }
        body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-container {
            border-color: var(--light-gray);
            background-color: var(--light);
        }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table {
            width: 100%;
            min-width: 900px; /* Ensure enough width for 7 days + employee */
            border-collapse: separate; /* Use separate for sticky */
            border-spacing: 0;
        }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th {
            padding: 0.8rem 0.75rem; /* Adjust padding */
            text-align: center;
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--primary-dark);
            border-right: 1px solid var(--primary-dark); /* Add right border */
        }
         #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th:last-child { border-right: none; }
         #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th:first-child { /* Employee Header */
            position: sticky; left: 0; z-index: 11 !important; border-right: 2px solid var(--primary-dark); background-color: var(--primary);
         }
         body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th:first-child { background-color: var(--primary-dark); border-right: 2px solid var(--light-gray); }

        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody td {
            padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--light-gray); border-right: 1px solid var(--light-gray); vertical-align: middle; transition: background-color 0.2s; color: var(--text-color); white-space: nowrap;
        }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody td:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td { background-color: #f9fafb; }
        body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td { background-color: var(--primary-light); }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td { background-color: #f0f9ff; }
        body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td { background-color: #475569; }
        #featureSectionsContainer.employee-scheduling-feature .employee-name { /* Sticky employee name cell */
            font-weight: 600; text-align: left; position: sticky; left: 0; z-index: 5; background-color: var(--white); border-right: 2px solid var(--gray);
        }
        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; }
         body.dark-theme #featureSectionsContainer.employee-scheduling-feature .employee-name { background-color: var(--white); border-right-color: var(--light-gray); }
         body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); }
         #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; }
         body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }

        #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        #featureSectionsContainer.employee-scheduling-feature .shift { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; min-width: 70px; border: 1px solid transparent; cursor: default; }
        #featureSectionsContainer.employee-scheduling-feature .shift.editable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #featureSectionsContainer.employee-scheduling-feature .shift.editable:hover { transform: scale(1.05); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        #featureSectionsContainer.employee-scheduling-feature .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent !important; font-style: italic; border: none; cursor: default; font-weight: normal; }
         /* Apply Shift Colors using Variables */
        #featureSectionsContainer.employee-scheduling-feature .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border); }
        #featureSectionsContainer.employee-scheduling-feature .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border); }
        #featureSectionsContainer.employee-scheduling-feature .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border); }
        #featureSectionsContainer.employee-scheduling-feature .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border); }
        #featureSectionsContainer.employee-scheduling-feature .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border); }
        #featureSectionsContainer.employee-scheduling-feature .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border); }
        #featureSectionsContainer.employee-scheduling-feature .day-header { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling-feature .day-name { font-weight: 600; font-size: 0.9rem; color: inherit; }
        #featureSectionsContainer.employee-scheduling-feature .day-date { font-size: 0.8rem; opacity: 0.8; color: inherit; }
        /* --- END: Employee Scheduling Table Refinements --- */

        /* --- START: Appearance & Theme Refinements --- */
        #preferencesPanel .theme-options-container {
            display: flex; /* Arrange horizontally */
            gap: 1.5rem; /* Space between options */
            margin-top: 0.5rem;
            flex-wrap: wrap; /* Allow wrapping if needed */
            justify-content: flex-start; /* Align to start */
            margin-bottom: 1.5rem; /* Add space below */
            padding: 0.5rem 0; /* Add vertical padding */
        }
        #preferencesPanel .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem; /* More padding for better click area */
            border-radius: 8px; /* Slightly more rounded */
            transition: background-color 0.2s, box-shadow 0.2s;
            min-width: 100px; /* Ensure minimum width */
            border: 2px solid transparent; /* Add border for selected state */
            background-color: var(--light); /* Subtle background */
        }
        body.dark-theme #preferencesPanel .theme-option {
            background-color: var(--light);
        }
        #preferencesPanel .theme-option:hover {
             background-color: var(--primary-light);
             box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        body.dark-theme #preferencesPanel .theme-option:hover {
            background-color: var(--light-gray);
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #preferencesPanel .theme-option.selected {
             border-color: var(--primary);
             background-color: var(--primary-light);
        }
         body.dark-theme #preferencesPanel .theme-option.selected {
             background-color: var(--primary-dark);
             border-color: var(--primary);
         }
        #preferencesPanel .theme-option .theme-preview {
            width: 60px;
            height: 40px;
            border: 1px solid var(--gray); /* Simple border for preview box */
            border-radius: 6px;
            transition: border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 0.75rem; /* Increased Space between preview and label */
            background-color: var(--white); /* Default background */
            overflow: hidden; /* Needed for gradient preview */
        }
        #preferencesPanel .theme-option .theme-label {
            text-align: center;
            display: block;
            font-size: 0.9rem;
            font-weight: 500; /* Make label slightly bolder */
            color: var(--text-color);
        }
         body.dark-theme #preferencesPanel .theme-option .theme-label {
             color: var(--text-color);
         }
        /* Specific theme previews */
        #preferencesPanel .theme-preview.light-preview { background-color: #f8fafc; color: #1e293b; border-color: var(--light-gray);}
        #preferencesPanel .theme-preview.dark-preview { background-color: #0f172a; color: #e2e8f0; border-color: var(--gray);}
        #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, #f8fafc 50%, #0f172a 50%); color: var(--gray); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview { border-color: var(--light-gray); }
        body.dark-theme #preferencesPanel .theme-preview.light-preview { background: var(--light) !important; color: var(--dark); border-color: var(--light-gray);}
        body.dark-theme #preferencesPanel .theme-preview.dark-preview { background: var(--white) !important; color: var(--dark); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray); border-color: var(--gray);}
        /* --- END: Appearance & Theme Refinements --- */

         /* --- Responsive (Existing + Refinements) --- */
         /* ... existing responsive styles ... */
         @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); width: 250px; box-shadow: none; }
             .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
             .main-content { margin-left: 0; }
             .search-bar { width: 250px; }
             .main-content.sidebar-active { margin-left: 250px; } /* Adjust main content when sidebar is open */
             .sidebar-toggle { display: block; /* Show hamburger */ position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
             .top-nav { padding-left: 60px; } /* Make space for hamburger */
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature .task-management-content .task-list { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
            #featureSectionsContainer.task-management-feature .task-management-content .container { padding: 20px; }
            /* Responsive: Team Members */
            #featureSectionsContainer.team-members-view-feature .team-members-list { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .projects-header { flex-direction: column; align-items: stretch; }
            #featureSectionsContainer.projects-feature .projects-title-wrapper { width: auto; }
            #featureSectionsContainer.projects-feature .project-controls { justify-content: flex-start; }
            /* Responsive: File Sharing */
            #featureSectionsContainer.filesharing-feature .filters-section .col-md-1 { text-align: left !important; }
         }
         @media (min-width: 993px) { .sidebar-toggle { display: none; } }
         @media (max-width: 768px) {
             .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; padding-left: 1rem; }
             .search-bar { width: 100%; order: 2; }
             .user-menu { width: 100%; justify-content: space-between; order: 1; }
             .content-area { padding: 1.5rem; }
             .data-form { grid-template-columns: 1fr; }
             .form-actions { grid-column: span 1; }
             .user-info { flex-direction: column; text-align: center; }
             .user-info-avatar { margin-bottom: 1rem; }
             .stats-section { grid-template-columns: 1fr; }
             .settings-tabs { flex-wrap: nowrap; overflow-x: auto; }
             .settings-tab { padding: 0.5rem 1rem; flex-shrink: 0; }
             .confirm-container { width: 90%; }
             #settingsContent .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; } /* Settings list */
             #settingsContent .member-role { margin: 0.5rem 0; }
             #settingsContent .member-actions { margin-top: 0.5rem; width: 100%; justify-content: flex-end; } /* Adjust actions on mobile */
             .profile-avatar-section { margin-bottom: 1.5rem; }
             #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .week-nav { justify-content: space-between; width: 100%; } /* Space out Prev/Next */
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .admin-actions { margin-left: 0; width: 100%; } /* Reset margin, full width */
             #featureSectionsContainer.employee-scheduling-feature .schedule-controls .admin-actions .btn { width: 100%; justify-content: center; }
             #featureSectionsContainer.employee-scheduling-feature .schedule-page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
             /* Employee Schedule Table Responsive Fixes */
             #featureSectionsContainer.employee-scheduling-feature .schedule-table { border-spacing: 0; /* Needed for sticky */ }
             #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th,
             #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody td { white-space: nowrap; /* Prevent wrapping */ }
             #featureSectionsContainer.employee-scheduling-feature .employee-name { position: sticky !important; left: 0; z-index: 5 !important; border-right: 1px solid var(--feature-projects-border-color); background-color: var(--white); }
             body.dark-theme #featureSectionsContainer.employee-scheduling-feature .employee-name { background-color: var(--white); border-right-color: var(--light-gray); }
             #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th:first-child { position: sticky !important; left: 0; z-index: 11 !important; background-color: var(--primary); } /* Ensure header sticky bg */
             body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table thead th:first-child { background-color: var(--primary-dark); } /* Dark theme header sticky bg */
             #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; } /* Light mode */
             body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); } /* Dark mode */
             #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; } /* Light mode hover */
             body.dark-theme #featureSectionsContainer.employee-scheduling-feature .schedule-table tbody tr:hover td.employee-name { background-color: #475569; } /* Dark mode hover */
             /* End Employee Schedule Responsive Fixes */
             .modal-content { width: 95%; padding: 1.5rem;}
             .notifications-container { width: 100%; max-width: 100%; }
             .sidebar-toggle { top: 10px; left: 10px; }
             .top-nav { padding-top: 60px; }
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature .task-management-content .controls { flex-direction: column; align-items: stretch; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .search-container { margin: 0; }
            #featureSectionsContainer.task-management-feature .task-management-content #add-task-btn { width: 100%; margin-left: 0; order: -1; margin-bottom: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters { flex-direction: column; width: 100%; gap: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content .filters select { width: 100%; min-width: unset; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-list { grid-template-columns: 1fr; }
            #featureSectionsContainer.task-management-feature .modal-content { width: 95%; padding: 20px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row { flex-direction: column; gap: 15px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-row > div { min-width: unset; }
            #featureSectionsContainer.task-management-feature .task-management-content h1 { font-size: 1.8em; }
            /* Responsive: Team Members */
             #featureSectionsContainer.team-members-view-feature .team-content-area,
             #featureSectionsContainer.team-members-view-feature .team-members-section-header { padding-left: 15px; padding-right: 15px; }
             #featureSectionsContainer.team-members-view-feature .team-members-section-header h2 { font-size: 1.5rem;}
             #featureSectionsContainer.team-members-view-feature .team-members-section-header { padding-top: 18px; padding-bottom: 18px; }
             #featureSectionsContainer.team-members-view-feature .team-filter { max-width: none; } /* Full width filter */
             #featureSectionsContainer.team-members-view-feature .team-member-card { /* Feature view card */ flex-direction: column; align-items: flex-start; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .projects-list { grid-template-columns: 1fr; gap: 20px; }
            #featureSectionsContainer.projects-feature .project-controls { flex-direction: column; align-items: stretch; }
            #featureSectionsContainer.projects-feature .project-search-input,
            #featureSectionsContainer.projects-feature .project-filter-select,
            #featureSectionsContainer.projects-feature .add-project-btn { width: 100%; box-sizing: border-box; }
            #featureSectionsContainer.projects-feature .project-card-image { height: 160px; }
            #featureSectionsContainer.projects-feature .project-name { font-size: 1.25em; }
            #featureSectionsContainer.projects-feature .project-actions .btn { padding: 7px 12px; font-size: 0.8em; }
             #preferencesPanel .theme-options-container { justify-content: center; /* Center themes on small screens */ }
            /* Responsive: File Sharing */
            #featureSectionsContainer.filesharing-feature .filters-section .row > div { margin-bottom: 10px; }
            #featureSectionsContainer.filesharing-feature .fancy-header-title { font-size: 1rem; padding: 8px 15px; }
            /* Responsive: Project Tracking */
            #featureSectionsContainer.project-tracking-feature .pt-filters-section .row > div { margin-bottom: 10px; }
            #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-md-4,
            #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-md-8 { width: 100%; }
            #featureSectionsContainer.project-tracking-feature .pt-fancy-title { font-size: 1rem; padding: 8px 15px; }
            /* Responsive: Reports Analytics */
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .d-flex { flex-direction: column; align-items: stretch !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group,
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { width: 100%; margin-bottom: 10px; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { max-width: none; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section button[type="submit"] { width: 100%; }
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { font-size: 1rem; padding: 8px 15px; }
         }
         @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
             .user-menu { gap: 1rem; }
             .user-name { display: none; } /* Hide name on very small screens */
             .user-status { margin-left: 0; }
             .notifications-footer { flex-direction: column; gap: 0.5rem; }
             .notifications-footer .btn { width: 100%; justify-content: center; }
            /* Responsive: Task Management */
            #featureSectionsContainer.task-management-feature { padding: 10px; }
            #featureSectionsContainer.task-management-feature .task-management-content { padding: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .btn { font-size: 0.95em; padding: 9px 15px; }
            #featureSectionsContainer.task-management-feature .modal-content .form-actions .btn { padding: 10px 20px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card { padding: 15px; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { font-size: 1.15em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-card p,
            #featureSectionsContainer.task-management-feature .task-management-content .task-card .description,
            #featureSectionsContainer.task-management-feature .task-management-content .task-meta { font-size: 0.9em; }
            #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { font-size: 1.1em; margin-left: 8px; }
            #featureSectionsContainer.task-management-feature .modal-content { padding: 20px 15px; }
            #featureSectionsContainer.task-management-feature .modal-content #modal-title { font-size: 1.5em; margin-bottom: 20px; }
            /* Responsive: Team Members */
             #featureSectionsContainer.team-members-view-feature .team-members-list { grid-template-columns: 1fr; gap: 15px; }
             #featureSectionsContainer.team-members-view-feature .team-member-card { padding: 18px; } /* Use original padding */
             #featureSectionsContainer.team-members-view-feature .member-name { font-size: 1.1rem; }
             #featureSectionsContainer.team-members-view-feature .member-email { font-size: 0.85rem; margin-bottom: 12px; }
             #featureSectionsContainer.team-members-view-feature .member-role { font-size: 0.8rem; padding: 3px 8px; }
            /* Responsive: Projects */
            #featureSectionsContainer.projects-feature .project-actions .btn { flex-grow: 1; justify-content: center; } /* Make buttons fill width */
         }

        /* --- START: Adapted Team Members Styles (Refined) --- */
        /* Scope all styles to the feature container */
        #featureSectionsContainer.team-members-view-feature .team-members-section {
            background-color: var(--feature-team-bg);
            border-radius: var(--feature-team-card-border-radius);
            /*max-width: 1200px; /* REMOVED - Let container handle max-width */
            /*margin: 0 auto; /* REMOVED - Let container handle margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid var(--feature-team-border-color);
        }
        #featureSectionsContainer.team-members-view-feature .team-members-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: var(--feature-team-title-bg);
            color: var(--feature-team-title-text);
            margin: 0;
            padding: 1.1rem var(--feature-team-section-padding); /* Consistent padding */
            font-weight: 600;
            text-align: left;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--feature-team-border-color);
        }
        #featureSectionsContainer.team-members-view-feature .team-members-section-header h2 {
            font-size: 1.5rem; /* Match dashboard section title */
            margin: 0; /* Remove default margin */
        }
        #featureSectionsContainer.team-members-view-feature .add-team-member-btn {
             /* Use dashboard button styles */
        }
        #featureSectionsContainer.team-members-view-feature .team-content-area {
            padding: var(--feature-team-section-padding);
        }
        #featureSectionsContainer.team-members-view-feature .team-filter {
            margin-bottom: 1.5rem; /* Consistent margin */
            max-width: 400px;
        }
        #featureSectionsContainer.team-members-view-feature .team-filter input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem; /* Match dashboard input padding */
            border: 1px solid var(--feature-team-border-color);
            border-radius: 6px; /* Match dashboard radius */
            background-color: var(--white); /* Use var */
            box-sizing: border-box;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            color: var(--text-color); /* Use dashboard text color */
        }
        #featureSectionsContainer.team-members-view-feature .team-filter input[type="text"]::placeholder {
            color: var(--gray); /* Use var */
        }
        #featureSectionsContainer.team-members-view-feature .team-filter input[type="text"]:focus {
            outline: none;
            border-color: var(--primary); /* Use var */
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); /* Use var */
        }
        #featureSectionsContainer.team-members-view-feature .team-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--feature-team-grid-gap);
        }
        #featureSectionsContainer.team-members-view-feature .team-member-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: var(--feature-team-card-bg);
            border: 1px solid var(--feature-team-border-color);
            border-radius: var(--feature-team-card-border-radius);
            padding: var(--feature-team-card-padding);
            box-shadow: 0 3px 8px var(--feature-team-shadow-color);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out;
            overflow: hidden;
        }
        #featureSectionsContainer.team-members-view-feature .team-member-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--feature-team-hover-shadow-color);
            border-color: var(--gray); /* Slightly darker border */
        }
        #featureSectionsContainer.team-members-view-feature .member-info { width: 100%; }
        #featureSectionsContainer.team-members-view-feature .member-name {
            font-size: 1.15rem; font-weight: 600;
            color: var(--feature-team-text-primary);
            margin: 0 0 5px 0; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        #featureSectionsContainer.team-members-view-feature .member-email {
            font-size: 0.88rem; color: var(--feature-team-text-secondary);
            margin: 0 0 14px 0; word-break: break-all; line-height: 1.4;
        }
        #featureSectionsContainer.team-members-view-feature .member-role {
            font-size: 0.85rem; font-weight: 500; margin: 0;
            padding: 4px 10px; border-radius: 6px;
            display: inline-block; line-height: 1.3;
            /* Use background colors for roles */
            color: #fff; /* White text on colored background */
        }
        #featureSectionsContainer.team-members-view-feature .member-role.role-admin { background-color: var(--feature-team-admin-color); }
        #featureSectionsContainer.team-members-view-feature .member-role.role-supervisor { background-color: var(--feature-team-supervisor-color); }
        #featureSectionsContainer.team-members-view-feature .member-role.role-senior { background-color: var(--feature-team-senior-color); }
        #featureSectionsContainer.team-members-view-feature .member-role.role-member { background-color: var(--feature-team-member-color); }
        #featureSectionsContainer.team-members-view-feature .team-member-card.hidden-by-filter { display: none; }
        /* --- END: Adapted Team Members Styles --- */


        /* --- START: Adapted Projects Styles (Refined) --- */
        #featureSectionsContainer.projects-feature #projects-section {
            width: 100%;
            /* max-width: 1200px; REMOVED */
            /* margin: 0 auto; REMOVED */
        }
        #featureSectionsContainer.projects-feature .projects-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        #featureSectionsContainer.projects-feature .projects-title-wrapper {
            background-color: var(--feature-projects-card-bg); /* Use variable */
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--feature-projects-shadow-color); /* Use variable */
            flex-grow: 1;
            border-left: 5px solid var(--feature-projects-primary-color); /* Use variable */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .projects-title-wrapper h2 {
            color: var(--feature-projects-heading-color); /* Use variable */
            margin: 0;
            font-weight: 600;
            font-size: 1.8em;
            transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--feature-projects-card-bg); /* Use variable */
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--feature-projects-shadow-color); /* Use variable */
            transition: background-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-search-input,
        #featureSectionsContainer.projects-feature .project-filter-select {
            padding: 9px 13px;
            border: 1px solid var(--feature-projects-input-border); /* Use variable */
            border-radius: 6px;
            font-size: 0.9em;
            background-color: var(--feature-projects-input-bg); /* Use variable */
            color: var(--feature-projects-text-color); /* Use variable */
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-search-input:focus,
        #featureSectionsContainer.projects-feature .project-filter-select:focus {
            outline: none;
            border-color: var(--feature-projects-input-focus-border); /* Use variable */
            box-shadow: 0 0 0 0.2rem var(--feature-projects-input-focus-shadow); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .project-search-input { min-width: 200px; }
        #featureSectionsContainer.projects-feature .project-filter-select {
             appearance: none;
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); /* Default arrow */
             background-repeat: no-repeat;
             background-position: right 0.75rem center;
             background-size: 16px 12px;
             padding-right: 2.5rem;
        }
         /* Dark mode arrow */
        body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23cccccc' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); /* Lighter arrow */
        }
        #featureSectionsContainer.projects-feature .add-project-btn {
            /* Use dashboard .btn styles implicitly */
            background-color: var(--feature-projects-primary-color); /* Use variable */
            color: var(--feature-projects-primary-text); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .add-project-btn:hover {
            background-color: var(--feature-projects-primary-hover); /* Use variable */
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }
        #featureSectionsContainer.projects-feature .projects-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
        }
        #featureSectionsContainer.projects-feature .project-card {
            background-color: var(--feature-projects-card-bg); /* Use variable */
            border-radius: 12px; /* Use original rounded corners */
            border: 1px solid var(--feature-projects-border-color); /* Use variable */
            box-shadow: 0 6px 12px var(--feature-projects-shadow-color); /* Use variable */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 10px 20px var(--feature-projects-shadow-hover-color); /* Use variable */
        }
        #featureSectionsContainer.projects-feature .project-card-image {
            height: 180px; background-size: cover; background-position: center; position: relative;
        }
        #featureSectionsContainer.projects-feature .project-card-body {
            padding: 25px; display: flex; flex-direction: column; flex-grow: 1;
        }
        #featureSectionsContainer.projects-feature .project-name {
            font-size: 1.4em; font-weight: 600;
            color: var(--feature-projects-heading-color); /* Use variable */
            margin-top: 0; margin-bottom: 10px; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .progress-bar-container {
            width: 100%; height: 10px;
            background-color: var(--feature-projects-progress-bar-bg); /* Use variable */
            border-radius: 5px; overflow: hidden; margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .progress-bar {
            height: 100%; background-color: var(--feature-projects-primary-color); /* Use variable */
            border-radius: 5px; transition: width 0.4s ease, background-color 0.3s ease;
            text-align: center; color: var(--feature-projects-primary-text); /* Use variable */
            font-size: 0.75em; font-weight: 500; line-height: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        #featureSectionsContainer.projects-feature .status-completed ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-success-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .status-in-progress ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-warning-progress); color: var(--feature-projects-warning-btn-text); }
        #featureSectionsContainer.projects-feature .status-active ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-info-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .status-pending ~ .progress-bar-container .progress-bar { background-color: var(--feature-projects-secondary-progress); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .project-info {
            font-size: 0.9em; color: var(--feature-projects-text-muted); /* Use variable */
            margin-bottom: 12px; line-height: 1.6; display: flex;
            align-items: flex-start; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-info i {
            margin-right: 10px; color: var(--feature-projects-text-muted); /* Use variable */
            width: 18px; text-align: center; margin-top: 3px; transition: color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-participants span {
            display: inline-block;
            background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); /* Mix color for tag */
            color: var(--feature-projects-text-color); /* Use variable */
            padding: 4px 10px; border-radius: 15px; font-size: 0.8em;
            margin-right: 6px; margin-bottom: 6px; white-space: nowrap;
            border: 1px solid var(--feature-projects-border-color); /* Use variable */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .project-participants .participant-list { flex: 1; }
        #featureSectionsContainer.projects-feature .project-status {
            display: inline-block; padding: 6px 14px; border-radius: 15px;
            font-size: 0.8em; font-weight: 600; text-transform: uppercase;
            margin-bottom: 15px; align-self: flex-start;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        #featureSectionsContainer.projects-feature .project-actions {
            margin-top: auto; padding-top: 15px;
            border-top: 1px solid var(--feature-projects-border-color); /* Use variable */
            display: flex; gap: 10px; transition: border-color 0.3s ease;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }
        #featureSectionsContainer.projects-feature .project-actions .btn {
            /* Use dashboard .btn styles */
            font-size: 0.85em;
        }
        #featureSectionsContainer.projects-feature .project-actions .btn i { font-size: 0.9em; }
        #featureSectionsContainer.projects-feature .btn-view { background-color: var(--feature-projects-primary-color); color: var(--feature-projects-primary-text); }
        #featureSectionsContainer.projects-feature .btn-view:hover { background-color: var(--feature-projects-primary-hover); }
        #featureSectionsContainer.projects-feature .btn-edit { background-color: var(--feature-projects-warning-progress); color: var(--feature-projects-warning-btn-text); }
        #featureSectionsContainer.projects-feature .btn-edit:hover { background-color: color-mix(in srgb, var(--feature-projects-warning-progress) 90%, black 10%); }
        #featureSectionsContainer.projects-feature .btn-delete { background-color: var(--feature-projects-danger-color); color: var(--feature-projects-danger-text); }
        #featureSectionsContainer.projects-feature .btn-delete:hover { background-color: var(--feature-projects-danger-hover); }
        #featureSectionsContainer.projects-feature .btn:disabled,
        #featureSectionsContainer.projects-feature .btn[disabled] {
            opacity: 0.5; cursor: not-allowed; box-shadow: none;
            background-color: var(--feature-projects-secondary-progress);
            color: var(--feature-projects-secondary-text);
        }
         /* --- END: Adapted Projects Styles --- */

         /* --- Feature Wrapper Style (for margin/padding consistency) --- */
        #featureSectionsContainer > div[class*="-feature-wrapper"] {
            /* Removed padding/margin/bg/shadow - Handled by internal feature structure now */
            animation: fadeInContent 0.4s ease-in-out;
        }
         /* --- Danger Zone Styling --- */
        .danger-zone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--light-gray);
            flex-wrap: wrap; /* Allow wrapping */
            gap: 1rem; /* Add gap */
        }
        .danger-zone-item:last-child { border-bottom: none; }
        .danger-zone-item > div { flex-grow: 1; } /* Allow text block to grow */
        .danger-zone-item h5 { margin-bottom: 0.25rem; color: var(--danger); font-weight: 600; }
        .danger-zone-item p { margin-bottom: 0; color: var(--gray); font-size: 0.9rem; }
        .danger-zone-item .btn { flex-shrink: 0; /* Prevent button from shrinking */ }

         /* 2FA Status Indicators */
        .two-fa-status { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .two-fa-status .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .two-fa-status .status-indicator.enabled { background-color: var(--success); }
        .two-fa-status .status-indicator.disabled { background-color: var(--gray); }
        .two-fa-setup { margin-top: 1rem; padding: 1rem; border: 1px dashed var(--light-gray); border-radius: 6px; background-color: var(--light); }
        .two-fa-actions { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .qr-code-placeholder { width: 150px; height: 150px; background-color: var(--light-gray); border: 1px solid var(--gray); display: flex; align-items: center; justify-content: center; margin: 1rem auto; color: var(--gray); font-style: italic; }


    </style>
</head>
<!-- Apply theme class from localStorage -->
<body class=""> <!-- Start with no specific theme, JS will apply -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle (Visible on smaller screens) -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Success/Toast message container -->
    <div class="toast" id="toastMessage">Toast message</div>
    <!-- Success message (Specific style from original) -->
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
            <!-- Optional: Close button inside sidebar for mobile -->
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none; background: none; border: none; color: white; font-size: 1.2rem; position: absolute; top: 1.5rem; right: 1rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <!-- Sidebar items remain the same, ensure data-feature attributes are correct -->
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span>
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults">
                    <!-- Search results will be populated here -->
                 </div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer"> <!-- Added ID for event delegation -->
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status"> • Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button - Text dynamically updated -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content (CORE) -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <!-- Stat cards will be populated by JS -->
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content (CORE) -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <!-- Button hidden, click avatar instead -->
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content (CORE) -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <!-- Tabs remain the same -->
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                     <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light">
                                     <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div>
                                     <span class="theme-label">Light</span>
                                 </div>
                                 <div class="theme-option" data-theme="dark">
                                     <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div>
                                     <span class="theme-label">Dark</span>
                                 </div>
                                 <div class="theme-option" data-theme="system">
                                    <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div>
                                    <span class="theme-label">System</span>
                                 </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div>
                                <span class="setting-item-label">High Contrast Mode</span>
                                <p class="setting-item-description">Increase text visibility for accessibility.</p>
                            </div>
                            <div class="setting-item-control">
                                <label class="switch">
                                    <input type="checkbox" id="highContrastToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Reuse data-form for layout -->
                             <div class="form-group">
                                 <label for="languageSelect">Language</label>
                                 <select id="languageSelect" class="form-control">
                                     <option value="en">English (US)</option>
                                     <option value="ar">العربية (Arabic)</option>
                                     <option value="es">Español (Spanish)</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="regionSelect">Region / Timezone</label>
                                 <select id="regionSelect" class="form-control">
                                     <option value="utc">UTC</option>
                                     <option value="est">EST (UTC-5)</option>
                                     <option value="pst">PST (UTC-8)</option>
                                     <option value="cet">CET (UTC+1)</option>
                                     <option value="eet">EET (UTC+2)</option>
                                     <option value="ast">AST (UTC+3) - Riyadh</option>
                                 </select>
                             </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                 <label for="timeFormatSelect">Time Format</label>
                                 <select id="timeFormatSelect" class="form-control">
                                     <option value="12h">12-hour (e.g., 3:00 PM)</option>
                                     <option value="24h">24-hour (e.g., 15:00)</option>
                                 </select>
                             </div>
                              <div class="form-group">
                                 <label for="dateFormatSelect">Date Format</label>
                                 <select id="dateFormatSelect" class="form-control">
                                     <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                     <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                     <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                     <option value="Month D, YYYY">Month D, YYYY</option>
                                 </select>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Toast Notifications</span>
                                 <p class="setting-item-description">Show brief confirmation messages for actions.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="toastToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Sound Notifications</span>
                                 <p class="setting-item-description">Play a sound for new notifications and activities.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="soundToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="form-group">
                             <label for="notificationToneSelect">Notification Tone</label>
                             <select id="notificationToneSelect" class="form-control" disabled> <!-- Disabled for now -->
                                 <option value="default">Default</option>
                                 <option value="tone1">Tone 1 (Placeholder)</option>
                                 <option value="tone2">Tone 2 (Placeholder)</option>
                             </select>
                             <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p>
                         </div>
                         <div class="form-group">
                             <label class="settings-label">Keyboard Shortcuts</label>
                             <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p>
                             <button class="btn btn-outline btn-sm" disabled>View Shortcuts</button>
                         </div>
                     </div>

                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                     <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group">
                                 <label for="accountEmail">Current Email</label>
                                 <input type="email" id="accountEmail" class="form-control" value="" readonly>
                             </div>
                             <div class="form-group">
                                <label for="changeEmail">New Email Address</label>
                                <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <!-- Keep disabled, needs backend -->
                                <p class="setting-item-description">Changing email requires backend verification.</p>
                            </div>
                             <div class="form-group" style="grid-column: span 2;">
                                <label for="accountConfirmPassword">Confirm Password (to change email)</label>
                                <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> <!-- Keep disabled -->
                            </div>
                            <div class="form-actions" style="grid-column: span 2;">
                                <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> <!-- Keep disabled -->
                            </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Account Notifications</span>
                                 <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="accountNotificationsToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                     <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group">
                                 <label for="currentPassword">Current Password</label>
                                 <input type="password" id="currentPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="newPassword">New Password</label>
                                 <input type="password" id="newPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="confirmPassword">Confirm New Password</label>
                                 <input type="password" id="confirmPassword" class="form-control">
                             </div>
                             <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Change Password</button> <!-- Removed disabled -->
                             </div>
                         </form>
                     </div>

                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status">
                             <span class="status-indicator disabled" id="twoFaStatusIndicator"></span>
                             <span id="twoFaStatusText">2FA is currently Disabled</span>
                         </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>

                         <!-- Placeholder for 2FA Setup UI -->
                         <div id="twoFaSetupSection" style="display: block;"> <!-- Initially visible -->
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none;">
                                 <h5>Choose Setup Method:</h5>
                                 <div class="two-fa-actions">
                                      <button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button>
                                      <button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button>
                                 </div>
                                 <!-- Authenticator App Setup -->
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p>
                                     <div class="qr-code-placeholder">QR Code Placeholder</div>
                                     <p>2. Enter the 6-digit code generated by your app below.</p>
                                     <div class="form-group">
                                        <label for="authCode">Verification Code</label>
                                        <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6">
                                    </div>
                                     <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> <!-- Removed disabled -->
                                 </div>
                                  <!-- SMS Setup -->
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p>
                                     <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button>
                                     <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup">
                                        <label for="smsCode">SMS Verification Code</label>
                                        <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6">
                                     </div>
                                     <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button>
                                 </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none;"> <!-- Visible when enabled -->
                              <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p>
                              <div class="two-fa-actions">
                                 <button class="btn btn-outline" disabled>View Recovery Codes</button> <!-- Keep disabled for demo -->
                                 <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="sessionDuration">Session Duration (minutes)</label>
                                <input type="number" id="sessionDuration" class="form-control" value="60" min="15">
                                <p class="setting-item-description">Set how long a login session remains active.</p>
                            </div>
                            <div class="form-group">
                                <label for="idleTimeout">Idle Timeout (minutes)</label>
                                <input type="number" id="idleTimeout" class="form-control" value="15" min="5">
                                <p class="setting-item-description">Automatically logout after inactivity.</p>
                            </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                             <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> <!-- Removed disabled -->
                         </div>
                     </div>

                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Email Notifications</span>
                                 <p class="setting-item-description">Receive summaries and important alerts via email.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="emailNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable In-App Notifications</span>
                                 <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="inAppNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <!-- Placeholder for Push Notifications -->
                          <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span>
                                 <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="pushNotificationsToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group">
                            <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label>
                            <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label>
                            <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label>
                            <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label>
                            <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label>
                            <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <!-- Placeholder for Priority Settings -->
                         <div class="form-group">
                            <label for="notificationPriority">Minimum Notification Priority</label>
                            <select id="notificationPriority" class="form-control" disabled>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                            <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p>
                         </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>


                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                     <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <div class="team-list" id="teamList"> <!-- Team List populated by JS --> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                     <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Connect Slack</button>
                            <button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button>
                            <button class="btn btn-outline" disabled><i class="fab fa-github"></i> Connect GitHub</button>
                         </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Allow External Sharing Links</span>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="externalSharingToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <button class="btn btn-outline" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline" disabled>Set Default Permissions</button>
                     </div>
                 </div>


                 <!-- Danger Zone Panel -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3>
                     <p>These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p>This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Delete Account</h5>
                            <p>Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for ALL other feature sections (Loaded Dynamically) -->
             <div id="featureSectionsContainer" class="content-section"> <!-- Initially hidden by default -->
                 <!-- Content loaded dynamically here -->
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications">×</button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
                 <!-- Notifications populated by JS -->
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button> <!-- Default to danger, can be changed -->
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="memberModalTitle">Member Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group">
                         <label for="memberFirstName">First Name</label>
                         <input type="text" id="memberFirstName" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberLastName">Last Name</label>
                         <input type="text" id="memberLastName" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberEmail">Email</label>
                         <input type="email" id="memberEmail" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="memberRole">Role</label>
                         <select id="memberRole" class="form-control" required>
                             <option value="member">Member</option>
                             <option value="supervisor">Supervisor</option>
                             <option value="senior">Senior</option>
                             <option value="admin">Admin</option>
                         </select>
                     </div>
                      <div class="form-group">
                         <label for="memberTitle">Job Title</label>
                         <input type="text" id="memberTitle" class="form-control">
                     </div>
                      <div class="form-group">
                         <label for="memberDepartment">Department</label>
                         <input type="text" id="memberDepartment" class="form-control">
                     </div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;"> <!-- Span full width -->
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Project Details</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;"> <!-- Single column for project form -->
                    <div class="form-group">
                         <label for="projectName">Project Name</label>
                         <input type="text" id="projectName" class="form-control" required>
                     </div>
                    <div class="form-group">
                         <label for="projectDescription">Description</label>
                         <textarea id="projectDescription" class="form-control" rows="3"></textarea>
                     </div>
                     <div class="form-group">
                         <label for="projectParticipantsInput">Participants (Separate with | )</label>
                         <input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S.">
                     </div>
                    <div class="form-group">
                        <label for="projectImageInput">Image URL (Optional)</label>
                        <input type="url" id="projectImageInput" class="form-control" placeholder="https://...">
                    </div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Nested grid for dates/status -->
                         <div class="form-group">
                            <label for="projectStartDate">Start Date</label>
                            <input type="date" id="projectStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="projectDueDate">Due Date</label>
                            <input type="date" id="projectDueDate" class="form-control">
                        </div>
                         <div class="form-group">
                             <label for="projectStatus">Status</label>
                             <select id="projectStatus" class="form-control" required>
                                <option value="pending">Pending</option>
                                <option value="active">Active</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                             </select>
                         </div>
                        <div class="form-group">
                            <label for="projectProgress">Progress (%)</label>
                            <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                        </div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <!-- Single column form actions -->
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Edit Modal (used by Employee Scheduling) -->
     <div class="modal" id="editShiftModal">
         <div class="modal-content">
             <div class="modal-header"> <h3 class="modal-title" id="editShiftModalTitle">Edit Shift</h3> <button class="close-modal" data-close-modal>×</button> </div>
             <form id="editShiftForm">
                 <input type="hidden" id="editShiftEmployeeId"> <input type="hidden" id="editShiftDayIndex"> <input type="hidden" id="editShiftWeekOffset">
                 <div class="form-group">
                     <label for="shiftType">Shift Type</label>
                     <select id="shiftType" class="form-control"> <option value="morning">Morning (9AM-5PM)</option> <option value="afternoon">Afternoon (12PM-8PM)</option> <option value="night">Night (8PM-4AM)</option> <option value="off">Day Off</option> <option value="sick">Sick Leave</option> <option value="vacation">Vacation</option> </select>
                 </div>
                 <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary">Save Shift</button> </div>
             </form>
         </div>
     </div>

    <!-- Task Modal (Used by Task Management) -->
     <div id="task-modal" class="modal task-management-feature"> <!-- Add feature class for scoping -->
         <div class="modal-content">
             <span class="close-btn">×</span>
             <h2 id="modal-title">Add New Task</h2>
             <form id="task-form">
                 <input type="hidden" id="task-id">
                 <div class="form-group"> <label for="task-name">Task Name:</label> <input type="text" id="task-name" required> </div>
                 <div class="form-group"> <label for="task-description">Description:</label> <textarea id="task-description" rows="3"></textarea> </div>
                 <div class="form-group"> <label for="task-links">Links:</label> <input type="text" id="task-links" placeholder="e.g., https://example.com, jira-123"> </div>
                 <div class="form-group form-row">
                     <div> <label for="task-assigned-by">Assigned By:</label> <select id="task-assigned-by" required> <option value="Nada">Nada</option> <option value="Yousef">Yousef</option> <option value="Self Assigned">Self Assigned</option> </select> </div>
                     <div> <label for="task-assigned-to">Assigned To:</label> <select id="task-assigned-to" required> <option value="Mohamed Elmenisy">Mohamed Elmenisy</option> <option value="Yousef">Yousef</option> <option value="Esraa Lashin">Esraa Lashin</option> <option value="Bassant Badr">Bassant Badr</option> </select> </div>
                 </div>
                 <div class="form-group form-row">
                     <div> <label for="task-start-date">Start Date:</label> <input type="date" id="task-start-date"> </div>
                     <div> <label for="task-due-date">Due Date:</label> <input type="date" id="task-due-date"> </div>
                 </div>
                 <div class="form-group form-row">
                     <div> <label for="task-priority">Priority:</label> <select id="task-priority" required> <option value="Low">Low</option> <option value="Medium">Medium</option> <option value="High">High</option> </select> </div>
                     <div> <label for="task-status">Status:</label> <select id="task-status" required> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> </select> </div>
                 </div>
                 <div class="form-actions"> <button type="submit" id="save-task-btn" class="btn btn-primary">Save Task</button> <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button> </div>
             </form>
         </div>
     </div>

     <!-- File Sharing Modals -->
      <div class="modal fade filesharing-feature" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true"> <!-- Add feature class -->
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="uploadFileModalLabel"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New File</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <div class="upload-area" id="dropZone">
                          <p><i class="fas fa-cloud-upload-alt fa-3x mb-2"></i></p>
                          <p>Drag & drop files here or click to select</p>
                          <input type="file" id="fileInputHidden" multiple hidden>
                      </div>
                      <div class="mb-3">
                          <label for="fileInputManual" class="form-label">Or select file(s):</label>
                          <input class="form-control form-control-sm" type="file" id="fileInputManual" multiple>
                      </div>
                      <div class="mb-3">
                          <label for="fileTagsInput" class="form-label"><i class="fas fa-tags me-1"></i>Add Tags (comma-separated):</label>
                          <input type="text" class="form-control form-control-sm" id="fileTagsInput" placeholder="e.g., reports, important, 2024">
                      </div>
                      <div id="uploadProgressContainer" class="mt-3" style="display: none;">
                           <div class="d-flex justify-content-between">
                              <small id="uploadFileName" class="text-muted">Uploading file...</small>
                              <small id="uploadPercentage" class="text-muted">0%</small>
                           </div>
                          <div class="progress mt-1" style="height: 10px;"> <!-- Thinner progress bar -->
                              <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                          <small id="uploadStatus" class="text-muted d-block mt-1"></small>
                      </div>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-sm btn-outline" data-bs-dismiss="modal">Cancel</button> <!-- Generic outline -->
                      <button type="button" class="btn btn-sm btn-primary" id="startUploadButton">Start Upload</button>
                  </div>
              </div>
          </div>
      </div>
      <div class="modal fade filesharing-feature" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true"> <!-- Add feature class -->
          <div class="modal-dialog modal-xl modal-dialog-centered">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="filePreviewModalLabel">File Preview</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body text-center" style="min-height: 400px; max-height: 80vh; overflow-y: auto;">
                      <div id="previewContent">
                           <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                              <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                           </div>
                      </div>
                  </div>
                   <div class="modal-footer justify-content-start py-2">
                       <small class="text-muted me-3" id="previewFileName">File Name: </small>
                       <small class="text-muted" id="previewFileType">Type: </small>
                   </div>
              </div>
          </div>
      </div>


    <!-- ==================== FEATURE TEMPLATES START ==================== -->

    <!-- Container for Task Management CSS and JS -->
    <template id="taskManagementAssets">
        <style id="task-management-styles">
            /* Paste Task Management CSS Here */
            /* ... (CSS from task.txt, ensure selectors are scoped if needed, e.g. #featureSectionsContainer.task-management-feature .container) ... */
              #featureSectionsContainer.task-management-feature * { box-sizing: border-box; }
              #featureSectionsContainer.task-management-feature { /* Add specific feature background/padding if needed */ }
              #featureSectionsContainer.task-management-feature .task-page-header { background-color: var(--primary-dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 8px 8px 0 0; margin-bottom: 1.5rem; }
              #featureSectionsContainer.task-management-feature .task-page-title { margin: 0; font-size: 1.4rem; }
              #featureSectionsContainer.task-management-feature .task-management-content { font-family: inherit; background-color: var(--white); color: var(--text-color); line-height: 1.6; padding: 1.5rem; border-radius: 0 0 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
              body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: var(--light); }
              /* Reuse dashboard button styles */
              #featureSectionsContainer.task-management-feature .btn { /* Inherits from dashboard */ }
              #featureSectionsContainer.task-management-feature .btn-primary { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .btn-secondary { background-color: var(--secondary); color: white; } /* Example secondary */
              body.dark-theme #featureSectionsContainer.task-management-feature .btn-secondary { background-color: var(--gray); }
              #featureSectionsContainer.task-management-feature .btn-danger { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .btn-warning { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .btn-success { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .btn-info { background-color: var(--info); color: white; }
              #featureSectionsContainer.task-management-feature .controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding: 1rem; background-color: var(--light); border-radius: 6px; gap: 1rem; border: 1px solid var(--light-gray); }
              body.dark-theme #featureSectionsContainer.task-management-feature .controls { background-color: var(--primary-light); border-color: var(--light-gray);}
              #featureSectionsContainer.task-management-feature .search-container { position: relative; display: flex; align-items: center; flex-grow: 1; min-width: 200px; }
              #featureSectionsContainer.task-management-feature #search-input { /* Inherits .form-control */ padding-right: 2.5rem; }
              #featureSectionsContainer.task-management-feature .search-icon { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); pointer-events: none; }
              #featureSectionsContainer.task-management-feature .filters { display: flex; flex-wrap: wrap; gap: 0.75rem; }
              #featureSectionsContainer.task-management-feature .filters select { /* Inherits .form-control */ min-width: 150px; appearance: auto; /* Use browser default dropdown arrow */}
              #featureSectionsContainer.task-management-feature .task-list { margin-top: 1.5rem; display: grid; gap: 1.25rem; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
              #featureSectionsContainer.task-management-feature .no-tasks { text-align: center; color: var(--gray); padding: 3rem 1rem; font-size: 1.1em; background-color: var(--light); border-radius: 6px; grid-column: 1 / -1; border: 1px dashed var(--light-gray); }
              body.dark-theme #featureSectionsContainer.task-management-feature .no-tasks { background-color: var(--primary-light); border-color: var(--light-gray);}
              #featureSectionsContainer.task-management-feature .task-card { background-color: var(--white); border: 1px solid var(--light-gray); border-left: 5px solid var(--primary); border-radius: 6px; padding: 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.06); transition: box-shadow 0.3s ease, transform 0.2s ease; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card { background-color: var(--light); border-color: var(--light-gray); border-left-color: var(--primary); }
              #featureSectionsContainer.task-management-feature .task-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-3px); }
              #featureSectionsContainer.task-management-feature .task-card h3 { font-size: 1.15em; margin: 0 0 0.75rem 0; color: var(--primary-dark); word-break: break-word; font-weight: 600; }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card h3 { color: #a5b4fc; }
              #featureSectionsContainer.task-management-feature .task-card p { margin: 0 0 0.5rem 0; color: var(--gray); font-size: 0.9rem; word-break: break-word; line-height: 1.5; }
              #featureSectionsContainer.task-management-feature .task-card .description { color: var(--text-color); font-size: 0.9em; margin-bottom: 1rem; max-height: 80px; overflow-y: auto; background-color: var(--light); padding: 0.5rem; border-radius: 4px;}
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card .description { background-color: var(--primary-light); }
              #featureSectionsContainer.task-management-feature .task-card strong { color: var(--dark); min-width: 80px; display: inline-block; font-weight: 500;}
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card strong { color: var(--text-color); }
              #featureSectionsContainer.task-management-feature .task-card .links { font-size: 0.85em; word-break: break-all; }
              #featureSectionsContainer.task-management-feature .task-card .links a { display: inline-block; margin-right: 5px; margin-bottom: 3px; color: var(--primary); text-decoration: none; }
              #featureSectionsContainer.task-management-feature .task-card .links a:hover { text-decoration: underline; color: var(--primary-dark);}
              #featureSectionsContainer.task-management-feature .task-card .links span { display: inline-block; margin-right: 5px; margin-bottom: 3px; color: var(--gray); }
              #featureSectionsContainer.task-management-feature .task-meta { font-size: 0.8em; color: var(--gray); margin-top: 1rem; border-top: 1px solid var(--light-gray); padding-top: 1rem; }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-meta { border-top-color: var(--light-gray); }
              #featureSectionsContainer.task-management-feature .task-meta > div { display: flex; flex-wrap: wrap; gap: 5px 15px; margin-bottom: 5px; }
              #featureSectionsContainer.task-management-feature .task-meta span { white-space: nowrap; }
              #featureSectionsContainer.task-management-feature .task-card.priority-High { border-left-color: var(--danger); }
              #featureSectionsContainer.task-management-feature .task-card.priority-Medium { border-left-color: var(--warning); }
              #featureSectionsContainer.task-management-feature .task-card.priority-Low { border-left-color: var(--success); }
              #featureSectionsContainer.task-management-feature .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; color: white; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle;}
              #featureSectionsContainer.task-management-feature .status-Pending { background-color: var(--warning); color: var(--dark);}
              #featureSectionsContainer.task-management-feature .status-InProgress { background-color: var(--info); }
              #featureSectionsContainer.task-management-feature .status-Completed { background-color: var(--success); }
              #featureSectionsContainer.task-management-feature .overdue-indicator { color: var(--danger); font-weight: bold; margin-left: 5px; font-size: 0.9em; }
              #featureSectionsContainer.task-management-feature .task-card.status-Completed { background-color: #f8f9fa; border-left-color: var(--gray); opacity: 0.8; }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }
              #featureSectionsContainer.task-management-feature .task-card.status-Completed h3 { color: var(--gray); text-decoration: line-through; }
              #featureSectionsContainer.task-management-feature .task-card.status-Completed p,
              #featureSectionsContainer.task-management-feature .task-card.status-Completed .description,
              #featureSectionsContainer.task-management-feature .task-card.status-Completed .task-meta { color: var(--gray); }
              #featureSectionsContainer.task-management-feature .task-card.status-Completed strong { color: var(--gray); }
              #featureSectionsContainer.task-management-feature .task-actions { margin-top: 1rem; text-align: right; border-top: 1px solid var(--light-gray); padding-top: 1rem; }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-actions { border-top-color: var(--light-gray); }
              #featureSectionsContainer.task-management-feature .task-actions button { background: none; border: none; font-size: 1.1em; padding: 5px 7px; margin-left: 8px; vertical-align: middle; color: var(--gray); cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
              #featureSectionsContainer.task-management-feature .task-actions button:hover { transform: scale(1.1); }
              #featureSectionsContainer.task-management-feature .task-actions .edit-btn:hover { color: var(--primary); }
              #featureSectionsContainer.task-management-feature .task-actions .delete-btn { color: var(--danger); }
              #featureSectionsContainer.task-management-feature .task-actions .delete-btn:hover { color: #c82333; }
              #featureSectionsContainer.task-management-feature .task-actions .complete-btn { color: var(--success); }
              #featureSectionsContainer.task-management-feature .task-actions .complete-btn:hover { color: #1e7e34; }
              #featureSectionsContainer.task-management-feature .task-actions .reopen-btn { color: var(--warning); }
              #featureSectionsContainer.task-management-feature .task-actions .reopen-btn:hover { color: #d39e00; }
              #featureSectionsContainer.task-management-feature .modal { /* Inherits general .modal styles */ z-index: 1060; /* Ensure above other modals */ }
              #featureSectionsContainer.task-management-feature .modal-content { /* Inherits general .modal-content */ }
              #featureSectionsContainer.task-management-feature .modal-content .close-btn { /* Inherits general .close-modal */ }
              #featureSectionsContainer.task-management-feature .modal-content #modal-title { /* Inherits general .modal-title */ }
              #featureSectionsContainer.task-management-feature .modal-content #task-form { margin-top: 1.5rem; }
              #featureSectionsContainer.task-management-feature .modal-content .form-group { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .modal-content .form-group label { /* Inherits */ }
              #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="text"],
              #featureSectionsContainer.task-management-feature .modal-content #task-form input[type="date"],
              #featureSectionsContainer.task-management-feature .modal-content #task-form textarea,
              #featureSectionsContainer.task-management-feature .modal-content #task-form select { /* Inherits .form-control */ }
              #featureSectionsContainer.task-management-feature .modal-content #task-form textarea { resize: vertical; min-height: 80px; }
              #featureSectionsContainer.task-management-feature .modal-content .form-row { display: flex; flex-wrap: wrap; gap: 1rem; }
              #featureSectionsContainer.task-management-feature .modal-content .form-row > div { flex: 1; min-width: 200px; }
              #featureSectionsContainer.task-management-feature .modal-content .form-actions { /* Inherits */ }
        </style>
        <div class="task-management-feature-wrapper"> <!-- Add feature class -->
             <!-- Paste Task Management HTML Body Content Here -->
             <div class="task-page-header"> <h2 class="task-page-title">Task Management</h2> </div>
             <div class="task-management-content">
                 <!-- Container added for consistent padding/max-width -->
                 <!-- Controls -->
                 <div class="controls">
                     <button id="add-task-btn" class="btn btn-primary"><i class="fas fa-plus"></i> New Task</button>
                     <div class="search-container">
                         <input type="text" id="search-input" placeholder="Search tasks..." class="form-control">
                         <i class="fas fa-search search-icon"></i>
                     </div>
                     <div class="filters">
                         <select id="filter-status" class="form-control">
                             <option value="all">Status: All</option>
                             <option value="Pending">Pending</option>
                             <option value="In Progress">In Progress</option>
                             <option value="Completed">Completed</option>
                         </select>
                         <select id="filter-priority" class="form-control">
                             <option value="all">Priority: All</option>
                             <option value="High">High</option>
                             <option value="Medium">Medium</option>
                             <option value="Low">Low</option>
                         </select>
                         <select id="filter-assigned-to" class="form-control">
                             <option value="all">Assigned To: All</option>
                             <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                             <option value="Yousef Ahmed">Yousef Ahmed</option>
                             <option value="Esraa Lashin">Esraa Lashin</option>
                             <option value="Bassant Badr">Bassant Badr</option>
                         </select>
                     </div>
                 </div>

                 <!-- Task List -->
                 <div id="task-list" class="task-list">
                     <p class="no-tasks">Loading tasks...</p>
                 </div>

                 <!-- Modal defined outside the wrapper, but styled with feature class -->

             </div>
             <!-- End Task Management HTML -->
        </div>
        <script>
            // --- PASTE JS LOGIC FROM task.txt HERE (will be wrapped) ---
            // Make sure this function is globally accessible or called correctly
            function initializeTaskManagementFeature(container) {
                 // --- DOM Elements ---
                const taskContentContainer = container.querySelector('.task-management-content');
                if (!taskContentContainer) { console.error("Task Management content container not found!"); return { cleanup: () => {} }; }
                const addTaskBtn = taskContentContainer.querySelector('#add-task-btn');
                 // Select modals from the main document body, not just the container
                 const taskModal = document.getElementById('task-modal');
                 const closeModalBtn = taskModal?.querySelector('.close-btn');
                 const cancelBtn = taskModal?.querySelector('#cancel-btn'); // Look in modal
                 const taskForm = taskModal?.querySelector('#task-form');
                 const taskListDiv = taskContentContainer.querySelector('#task-list');
                 const modalTitle = taskModal?.querySelector('#modal-title');
                 const saveTaskBtn = taskModal?.querySelector('#save-task-btn');
                 const taskIdInput = taskModal?.querySelector('#task-id');
                 const taskNameInput = taskModal?.querySelector('#task-name');
                 const taskDescriptionInput = taskModal?.querySelector('#task-description');
                 const taskLinksInput = taskModal?.querySelector('#task-links');
                 const taskAssignedBySelect = taskModal?.querySelector('#task-assigned-by');
                 const taskAssignedToSelect = taskModal?.querySelector('#task-assigned-to');
const taskStartDateInput = taskModal?.querySelector('#task-start-date');
                 const taskDueDateInput = taskModal?.querySelector('#task-due-date');
                 const taskPrioritySelect = taskModal?.querySelector('#task-priority');
                 const taskStatusSelect = taskModal?.querySelector('#task-status');
                 const searchInput = taskContentContainer.querySelector('#search-input');
                 const filterStatusSelect = taskContentContainer.querySelector('#filter-status');
                 const filterPrioritySelect = taskContentContainer.querySelector('#filter-priority');
                 const filterAssignedToSelect = taskContentContainer.querySelector('#filter-assigned-to');

                 // Robust check for essential elements
                 if (!addTaskBtn || !taskModal || !closeModalBtn || !taskListDiv || !taskForm || !modalTitle || !saveTaskBtn || !taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect) {
                     console.error("Essential Task Management elements missing. Cannot initialize.");
                     // Optionally display an error message in the container
                     container.innerHTML = '<p class="error-message">Error: Task Management UI components failed to load correctly.</p>';
                     return { cleanup: () => {} }; // Return empty cleanup
                 }

                let tasks = [];
                let boundCloseOnEscape = null;
                let boundCloseOnOutsideClick = null;
                let boundTaskListClickHandler = null;
                let taskModalInstance = null; // Bootstrap modal instance

                // --- Load & Save Tasks ---
                const loadTasks = () => {
                    const storedTasks = localStorage.getItem('dashboard_tasks');
                    if (storedTasks) {
                        try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); }
                    } else { tasks = getDefaultTasks(); }
                    renderTasks();
                };
                function getDefaultTasks() {
                     // Provides more detailed descriptions and realistic links
                     return [
                         { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure the base application structure for the new client project. Ensure all dependencies are up to date.", links: "https://nodejs.org", assignedBy: "Nada", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null },
                         { id: 2, name: "Design UI Mockups", description: "Create mockups for main pages including dashboard, settings, and project view using Figma. Focus on user experience and modern design principles.", links: "https://figma.com", assignedBy: "Yousef Ahmed", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, // Corrected assigner
                         { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs for user authentication, project management, and task handling. Include basic CRUD operations.", links: "", assignedBy: "Self Assigned", assignedTo: "Yousef Ahmed", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, // Corrected assignee
                         { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides outlining project progress, key milestones achieved, and next steps. Include mockups and API progress.", links: "", assignedBy: "Nada", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null },
                         { id: 5, name: "Review Code Submission", description: "Review the 'feature/login' branch submitted by Yousef Ahmed. Check for code quality, security vulnerabilities, and adherence to style guide.", links: "https://github.com, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" },
                         { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Investigate and fix the login issue reported where special characters in passwords cause authentication failure.", links: "jira-123", assignedBy: "Yousef Ahmed", assignedTo: "Yousef Ahmed", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } // Corrected assigner/assignee
                     ];
                }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };

                // --- Utility Functions (Use dashboard's global functions) ---
                const formatDate = window.formatDateForDisplay || function(d) { try { return new Date(d + 'T00:00:00').toLocaleDateString() } catch (e) { return d || 'N/A' } };
                const getCurrentDate = () => { return new Date().toLocaleDateString('en-CA'); }; // YYYY-MM-DD format
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T00:00:00Z'); const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); if (isNaN(dueDate.getTime())) return false; return dueDate < todayUTC; } catch(e) { console.error("Error checking overdue:", e); return false; } };

                // --- Rendering Logic ---
                const renderTasks = () => {
                     if (!taskListDiv) return;
                     taskListDiv.innerHTML = '';
                     const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                     const statusFilter = filterStatusSelect ? filterStatusSelect.value : 'all';
                     const priorityFilter = filterPrioritySelect ? filterPrioritySelect.value : 'all';
                     const assignedToFilter = filterAssignedToSelect ? filterAssignedToSelect.value : 'all';

                     // Filtering
                     let tasksToDisplay = tasks.filter(task => {
                         const taskStatus = task.status || '';
                         const taskPriority = task.priority || '';
                         const taskAssignedTo = task.assignedTo || '';

                         const statusMatch = statusFilter === 'all' || taskStatus === statusFilter;
                         const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter;
                         const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter;

                         const searchMatch = searchTerm === '' || (
                             (task.name || '').toLowerCase().includes(searchTerm) ||
                             (task.description || '').toLowerCase().includes(searchTerm) ||
                             (task.links || '').toLowerCase().includes(searchTerm) ||
                             (task.assignedTo || '').toLowerCase().includes(searchTerm) ||
                             (task.assignedBy || '').toLowerCase().includes(searchTerm)
                         );

                         return statusMatch && priorityMatch && assignedToMatch && searchMatch;
                     });

                     // Sorting
                     tasksToDisplay.sort((a, b) => { const statusOrder = { "Pending": 1, "In Progress": 1, "Completed": 2 }; const statusA = statusOrder[a.status] || 3; const statusB = statusOrder[b.status] || 3; if (statusA !== statusB) return statusA - statusB; const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00Z') : null; const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00Z') : null; const dateValA = dateA && !isNaN(dateA) ? dateA.getTime() : Infinity; const dateValB = dateB && !isNaN(dateB) ? dateB.getTime() : Infinity; if (dateValA !== dateValB) return dateValA - dateValB; const priorityOrder = { High: 3, Medium: 2, Low: 1 }; const priorityA = priorityOrder[a.priority] || 0; const priorityB = priorityOrder[b.priority] || 0; return priorityB - priorityA; });

                     // Displaying
                     if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks">No tasks found matching your criteria.</p>'; return; }
                     tasksToDisplay.forEach(task => {
                         const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue');
                         const overdue = isOverdue(task); const overdueText = overdue ? `<span class="overdue-indicator">(Overdue!)</span>` : '';
                         let linksHTML = 'N/A'; if (task.links && task.links.trim()) { linksHTML = task.links.split(',').map(l => l.trim()).filter(l => l).map(link => { let href = link; let isUrl = false; try { const url = new URL(link.startsWith('http') ? link : `http://${link}`); if(url.hostname && (url.hostname.includes('.') || url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))) { isUrl = true; href = url.protocol + "//" + url.hostname + url.pathname + url.search + url.hash; } else { href = link; } } catch (_) { isUrl = false; href = link; } const displayText = link.length > 35 ? link.substring(0, 32) + '...' : link; return isUrl ? `<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>` : `<span title="${link}">${displayText}</span>`; }).join(' '); }

                         taskCard.innerHTML = `
                         <h3>${task.name || 'Unnamed'}</h3>
                         ${task.description ? `<p class="description">${task.description}</p>` : ''}
                         <p><strong>Links:</strong> <span class="links">${linksHTML}</span></p>
                         <p><strong>By:</strong> ${task.assignedBy || 'N/A'}</p>
                         <p><strong>To:</strong> ${task.assignedTo || 'N/A'}</p>
                         <div class="task-meta">
                             <div>
                                 <span><strong>Start:</strong> ${formatDate(task.startDate)}</span>
                                 <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span>
                             </div>
                             <div>
                                 <span><strong>Priority:</strong> ${task.priority || 'N/A'}</span>
                                 <span><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${task.status || 'N/A'}</span></span>
                             </div>
                             ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''}
                         </div>
                         <div class="task-actions">
                             <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                             <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                             ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`}
                         </div>`;

                         taskListDiv.appendChild(taskCard);
                    }); // End forEach task
                }; // End renderTasks


                // --- Modal Logic ---
                if (taskModal) {
                    taskModalInstance = new bootstrap.Modal(taskModal); // Initialize Bootstrap modal
                }

                const showModal = () => { taskModalInstance?.show(); };
                const hideModal = () => { taskModalInstance?.hide(); /* Bootstrap handles backdrop/esc */ };

                // Reset form on modal hide (Bootstrap event)
                taskModal?.addEventListener('hidden.bs.modal', () => {
                    if (taskForm) taskForm.reset();
                    if (taskIdInput) taskIdInput.value = '';
                    if (modalTitle) modalTitle.textContent = "Add New Task";
                    if (saveTaskBtn) saveTaskBtn.textContent = "Save Task";
                });


                const openAddModal = () => {
                    // Reset specific fields before showing
                    if (taskIdInput) taskIdInput.value = '';
                    if (modalTitle) modalTitle.textContent = "Add New Task";
                    if (saveTaskBtn) saveTaskBtn.textContent = "Save Task";
                    if (taskStatusSelect) taskStatusSelect.value = "Pending";
                    if (taskPrioritySelect) taskPrioritySelect.value = "Medium";
                    // Add default assignees/dates if needed
                    if (taskForm) taskForm.reset(); // Reset other fields
                    showModal();
                    if (taskNameInput) taskNameInput.focus();
                };

                const openEditModal = (id) => {
                    const task = tasks.find(t => t.id === id);
                    if (!task) { console.error("Task not found for edit:", id); return; }

                    if (!taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect || !modalTitle || !saveTaskBtn) {
                        console.error("Cannot open edit: modal elements missing."); return;
                    };

                    // Set form values
                    taskIdInput.value = task.id;
                    taskNameInput.value = task.name;
                    taskDescriptionInput.value = task.description || '';
                    taskLinksInput.value = task.links || '';
                    taskAssignedBySelect.value = task.assignedBy || 'Self Assigned'; // Default if missing
                    taskAssignedToSelect.value = task.assignedTo || ''; // Default if missing
                    taskStartDateInput.value = task.startDate || '';
                    taskDueDateInput.value = task.dueDate || '';
                    taskPrioritySelect.value = task.priority || 'Medium'; // Default if missing
                    taskStatusSelect.value = task.status || 'Pending'; // Default if missing
                    modalTitle.textContent = "Edit Task";
                    saveTaskBtn.textContent = "Update Task";

                    showModal();
                    taskNameInput.focus();
                 };

                // --- Form Submission ---
                const handleFormSubmit = (event) => {
                    event.preventDefault();
                    if (!taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect) { console.error("Submit error: form elements missing."); window.showToast?.("An error occurred submitting the form.", "error"); return; }
                    const taskId = taskIdInput.value ? parseInt(taskIdInput.value) : Date.now(); const currentTask = tasks.find(t => t.id === taskId); const newStatus = taskStatusSelect.value; let completionDate = currentTask?.completionDate || null;
                    if (newStatus === 'Completed') { if (!taskIdInput.value || (currentTask && currentTask.status !== 'Completed')) { completionDate = getCurrentDate(); } } else { completionDate = null; }
                    const startDate = taskStartDateInput.value; const dueDate = taskDueDateInput.value;
                    if (startDate && dueDate && new Date(dueDate) < new Date(startDate)) { window.showToast?.("Due Date cannot be before Start Date.", "error"); taskDueDateInput.focus(); return; }
                    const taskData = { id: taskId, name: taskNameInput.value.trim(), description: taskDescriptionInput.value.trim(), links: taskLinksInput.value.trim(), assignedBy: taskAssignedBySelect.value, assignedTo: taskAssignedToSelect.value, startDate: startDate || null, dueDate: dueDate || null, priority: taskPrioritySelect.value, status: newStatus, completionDate: completionDate };
                    if (!taskData.name) { window.showToast?.("Task Name is required.", "error"); taskNameInput.focus(); return; }
                    if (taskIdInput.value) { const index = tasks.findIndex(task => task.id === taskData.id); if (index > -1) { tasks[index] = taskData; } else { console.warn(`Task ${taskData.id} not found for edit.`); tasks.push(taskData); } } else { tasks.push(taskData); }
                    saveTasks(); renderTasks(); hideModal();
                    window.showToast?.(`Task "${taskData.name}" ${taskIdInput.value ? 'updated' : 'added'}.`, 'success');
                };

                 // --- Task Actions (Delegated Listener) ---
                const handleTaskListClick = (event) => {
                    const target = event.target;
                    const taskCard = target.closest('.task-card');
                    if (!taskCard) return;
                    const taskId = parseInt(taskCard.dataset.taskId);
                    if (!taskId) return;

                    if (target.closest('.edit-btn')) { openEditModal(taskId); }
                    else if (target.closest('.delete-btn')) { deleteTask(taskId); }
                    else if (target.closest('.complete-btn') || target.closest('.reopen-btn')) { toggleTaskStatus(taskId); }
                };

                // --- Action Handlers ---
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); if (!taskToDelete) return; window.showConfirmModal(`Delete Task`, `Are you sure you want to delete the task: "${taskToDelete.name}"?`, () => { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); window.showToast?.('Task deleted.', 'success'); }); };
                const toggleTaskStatus = (id) => { const taskIndex = tasks.findIndex(task => task.id === id); if (taskIndex === -1) return; const task = tasks[taskIndex]; if (task.status === 'Completed') { tasks[taskIndex] = { ...task, status: 'Pending', completionDate: null }; window.showToast?.(`Task "${task.name}" reopened.`, 'info'); } else { tasks[taskIndex] = { ...task, status: 'Completed', completionDate: getCurrentDate() }; window.showToast?.(`Task "${task.name}" marked as completed.`, 'success'); } saveTasks(); renderTasks(); };


                // --- Event Listeners Setup ---
                addTaskBtn.addEventListener('click', openAddModal);
                // closeModalBtn listener is handled by Bootstrap via data-bs-dismiss
                if (cancelBtn) cancelBtn.addEventListener('click', hideModal); // Still useful if modal backdrop click is disabled
                taskForm.addEventListener('submit', handleFormSubmit);

                // Add delegated listener to task list
                 boundTaskListClickHandler = handleTaskListClick;
                 taskListDiv.addEventListener('click', boundTaskListClickHandler);

                // Filter and Search Listeners
                if (searchInput) searchInput.addEventListener('input', renderTasks);
                if (filterStatusSelect) filterStatusSelect.addEventListener('change', renderTasks);
                if (filterPrioritySelect) filterPrioritySelect.addEventListener('change', renderTasks);
                if (filterAssignedToSelect) filterAssignedToSelect.addEventListener('change', renderTasks);

                // Initial Load
                loadTasks();

                // --- Cleanup Function ---
                const cleanup = () => {
                     console.log("Cleaning up Task Management...");
                     // Remove specific listeners
                     addTaskBtn?.removeEventListener('click', openAddModal);
                     cancelBtn?.removeEventListener('click', hideModal);
                     taskForm?.removeEventListener('submit', handleFormSubmit);
                     if (boundTaskListClickHandler) taskListDiv?.removeEventListener('click', boundTaskListClickHandler);
                     searchInput?.removeEventListener('input', renderTasks);
                     filterStatusSelect?.removeEventListener('change', renderTasks);
                     filterPrioritySelect?.removeEventListener('change', renderTasks);
                     filterAssignedToSelect?.removeEventListener('change', renderTasks);
                     taskModalInstance?.dispose(); // Dispose Bootstrap modal
                     taskModal?.remove(); // Remove modal from DOM
                     console.log("Task Management cleanup complete.");
                };

                 return { cleanup }; // Return the cleanup function
            }
             // Expose initializer globally
             window.initializeTaskManagementFeature = initializeTaskManagementFeature;
            // --- END OF PASTED JS LOGIC ---
        </script>
    </template>
    <!-- ==================== END: Task Management Template ==================== -->

    <!-- ==================== START: File Sharing Template ==================== -->
    <template id="fileSharingAssets">
        <style id="filesharing-styles">
            /* Paste CSS from filesharing.txt here, scoped */
            #featureSectionsContainer.filesharing-feature .container-fluid { padding: 0 !important; } /* Override container padding */
            #featureSectionsContainer.filesharing-feature { background-color: transparent; /* Inherit from dashboard */ font-family: inherit; } /* Inherit from dashboard */

            #featureSectionsContainer.filesharing-feature .card { border: none; border-radius: 0.5rem; background-color: var(--white); margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.filesharing-feature .card { background-color: var(--light); }
            #featureSectionsContainer.filesharing-feature .card-header { background-color: var(--white); border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .card-header { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.filesharing-feature .fancy-header-title { background: var(--app-header-bg); color: white; padding: 10px 20px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease; }
            #featureSectionsContainer.filesharing-feature .fancy-header-title:hover { transform: scale(1.02); }
            #featureSectionsContainer.filesharing-feature .card-header .d-flex { align-items: center; }
            #featureSectionsContainer.filesharing-feature .file-icon { font-size: 1.6rem; vertical-align: middle; margin-right: 10px; width: 25px; text-align: center; }
            #featureSectionsContainer.filesharing-feature .file-icon.text-danger { color: var(--app-danger) !important; }
            #featureSectionsContainer.filesharing-feature .file-icon.text-success { color: var(--app-success) !important; }
            #featureSectionsContainer.filesharing-feature .file-icon.text-warning { color: var(--app-warning) !important; }
            #featureSectionsContainer.filesharing-feature .file-icon.text-primary { color: var(--app-primary) !important; }
            #featureSectionsContainer.filesharing-feature .file-icon.text-info { color: var(--app-info) !important; }
            #featureSectionsContainer.filesharing-feature .action-buttons .btn { margin: 0 3px; transition: all 0.2s ease-in-out; border-radius: 50px; padding: 0.25rem 0.6rem; font-size: 0.8rem; }
            #featureSectionsContainer.filesharing-feature .action-buttons .btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            #featureSectionsContainer.filesharing-feature .action-btn .loading-spinner { display: none; margin: 0 2px; }
            #featureSectionsContainer.filesharing-feature .action-btn.loading .original-icon { display: none; }
            #featureSectionsContainer.filesharing-feature .action-btn.loading .loading-spinner { display: inline-block; }
            #featureSectionsContainer.filesharing-feature .filters-section { background-color: var(--white); padding: 1rem 1.25rem; border-radius: 0.375rem; border: 1px solid var(--light-gray); margin-bottom: 1.5rem; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .filters-section { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.filesharing-feature .filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; }
            #featureSectionsContainer.filesharing-feature .filters-section .form-control-sm,
            #featureSectionsContainer.filesharing-feature .filters-section .form-select-sm { font-size: 0.875rem; }
             #featureSectionsContainer.filesharing-feature #recentUploadsSection { background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0.375rem; padding: 1rem 1.25rem; }
            body.dark-theme #featureSectionsContainer.filesharing-feature #recentUploadsSection { background-color: var(--light); border-color: var(--light-gray); }
            #featureSectionsContainer.filesharing-feature #recentUploadsSection h6 { color: var(--app-primary); margin-bottom: 10px; font-weight: 600; }
             body.dark-theme #featureSectionsContainer.filesharing-feature #recentUploadsSection h6 { color: #a5b4fc;}
            #featureSectionsContainer.filesharing-feature #recentUploadsSection .list-group-item { border-bottom: 1px dashed var(--light-gray) !important; padding: 8px 0 !important; background-color: transparent !important; border-top: none !important; border-left: none !important; border-right: none !important; transition: background-color 0.2s; color: var(--text-color); }
            body.dark-theme #featureSectionsContainer.filesharing-feature #recentUploadsSection .list-group-item { border-bottom-color: var(--light-gray) !important;}
            #featureSectionsContainer.filesharing-feature #recentUploadsSection .list-group-item:hover { background-color: var(--app-hover-bg) !important; }
             body.dark-theme #featureSectionsContainer.filesharing-feature #recentUploadsSection .list-group-item:hover { background-color: var(--light-gray) !important; }
            #featureSectionsContainer.filesharing-feature #recentUploadsSection .list-group-item:last-child { border-bottom: 0 !important; }
            #featureSectionsContainer.filesharing-feature .time-ago { font-style: normal; font-size: 0.85em; color: var(--app-secondary); }
            #featureSectionsContainer.filesharing-feature .table { margin-bottom: 0; background-color: var(--white); /* Ensure table bg is white */ }
            body.dark-theme #featureSectionsContainer.filesharing-feature .table { background-color: var(--light); }
            #featureSectionsContainer.filesharing-feature .table thead { background-color: var(--app-light) !important; color: var(--app-secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
            body.dark-theme #featureSectionsContainer.filesharing-feature .table thead { background-color: var(--primary-light) !important; color: var(--gray); border-bottom-color: var(--light-gray);}
            #featureSectionsContainer.filesharing-feature .table tbody tr td { vertical-align: middle; padding: 0.85rem 0.75rem; color: var(--text-color);}
            #featureSectionsContainer.filesharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--app-hover-bg) !important; cursor: default; }
             body.dark-theme #featureSectionsContainer.filesharing-feature .table-hover > tbody > tr:hover > * { background-color: var(--light-gray) !important; }
            #featureSectionsContainer.filesharing-feature .file-name { font-weight: 500; color: var(--app-dark); }
             body.dark-theme #featureSectionsContainer.filesharing-feature .file-name { color: var(--text-color); }
            #featureSectionsContainer.filesharing-feature .badge { font-size: 0.75em; padding: 0.35em 0.6em; font-weight: 500; }
            /* Badge Styling - using text-bg-* for better contrast */
            #featureSectionsContainer.filesharing-feature .text-bg-primary { background-color: var(--app-primary) !important; color: white !important; }
            #featureSectionsContainer.filesharing-feature .text-bg-secondary { background-color: var(--app-secondary) !important; color: white !important; }
            #featureSectionsContainer.filesharing-feature .text-bg-success { background-color: var(--app-success) !important; color: white !important; }
            #featureSectionsContainer.filesharing-feature .text-bg-danger { background-color: var(--app-danger) !important; color: white !important; }
            #featureSectionsContainer.filesharing-feature .text-bg-warning { background-color: var(--app-warning) !important; color: var(--app-dark) !important; } /* Dark text on yellow */
            #featureSectionsContainer.filesharing-feature .text-bg-info { background-color: var(--app-info) !important; color: var(--app-dark) !important; } /* Dark text on cyan */
            #featureSectionsContainer.filesharing-feature .text-bg-light { background-color: var(--app-light) !important; color: var(--app-dark) !important; }
            #featureSectionsContainer.filesharing-feature .text-bg-dark { background-color: var(--app-dark) !important; color: var(--app-light) !important; }
            /* Dark theme overrides for badges */
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-primary { background-color: var(--app-primary) !important; color: white !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-secondary { background-color: var(--app-secondary) !important; color: white !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-success { background-color: var(--app-success) !important; color: white !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-danger { background-color: var(--app-danger) !important; color: white !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-warning { background-color: var(--app-warning) !important; color: var(--dark) !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-info { background-color: var(--app-info) !important; color: var(--dark) !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-light { background-color: var(--light-gray) !important; color: var(--dark) !important; }
            body.dark-theme #featureSectionsContainer.filesharing-feature .text-bg-dark { background-color: var(--dark) !important; color: var(--light) !important; }

            #featureSectionsContainer.filesharing-feature .upload-area { border: 2px dashed var(--app-primary); padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background-color: var(--app-light); border-radius: 8px; transition: background-color 0.2s ease, border-color 0.2s ease; }
             body.dark-theme #featureSectionsContainer.filesharing-feature .upload-area { background-color: var(--primary-light); border-color: var(--light-gray); }
            #featureSectionsContainer.filesharing-feature .upload-area:hover { background-color: var(--app-hover-bg); border-color: var(--primary); }
             body.dark-theme #featureSectionsContainer.filesharing-feature .upload-area:hover { background-color: var(--light-gray); border-color: var(--primary); }
            #featureSectionsContainer.filesharing-feature .upload-area i { color: var(--app-primary); }
            #featureSectionsContainer.filesharing-feature #uploadProgressContainer .progress-bar.bg-success { background-color: var(--app-success) !important; }
            #featureSectionsContainer.filesharing-feature #uploadProgressContainer .progress-bar.bg-danger { background-color: var(--app-danger) !important; }
            #featureSectionsContainer.filesharing-feature #uploadProgressContainer .progress-bar { background-color: var(--app-primary); }
            #featureSectionsContainer.filesharing-feature .swal2-confirm { background-color: var(--app-success) !important; color: white !important; border: none;}
            #featureSectionsContainer.filesharing-feature .swal2-cancel { background-color: var(--app-danger) !important; color: white !important; border: none;}
            #featureSectionsContainer.filesharing-feature .swal2-popup { font-size: 0.9rem !important; background-color: var(--white); color: var(--text-color); border-radius: 8px;}
            body.dark-theme #featureSectionsContainer.filesharing-feature .swal2-popup { background-color: var(--light); color: var(--text-color); }
            #featureSectionsContainer.filesharing-feature .text-muted { color: var(--gray) !important; }

        </style>
        <div class="filesharing-feature-wrapper"> <!-- Wrapper for scoping -->
            <!-- Start File Sharing Component -->
            <div class="card shadow-sm">
                <div class="card-header">
                     <h5 class="mb-0 fancy-header-title"><i class="fas fa-folder-open me-2"></i>File Management</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                        <i class="fas fa-upload me-1"></i> Upload New File
                    </button>
                </div>

                <div class="card-body pt-3"> <!-- Reduced top padding -->

                    <!-- Filters Section -->
                    <div class="row filters-section gy-2 align-items-end">
                        <div class="col-md-4">
                             <label for="fileSearchInput" class="form-label">Search by Name</label>
                            <div class="input-group input-group-sm search-input">
                                <input type="text" class="form-control form-control-sm" placeholder="Enter file name..." id="fileSearchInput">
                                 <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                        <div class="col-md-2">
                             <label for="fileTypeFilter" class="form-label">File Type</label>
                             <select class="form-select form-select-sm" id="fileTypeFilter" title="Filter by Type">
                                <option value="" selected>All Types</option>
                                <option value="PDF">PDF</option>
                                <option value="Image">Image</option>
                                <option value="Video">Video</option>
                                <option value="Archive">Archive</option>
                                <option value="Document">Document</option>
                                <option value="Spreadsheet">Spreadsheet</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="uploadDateFilter" class="form-label">Upload Date</label>
                            <input type="date" class="form-control form-control-sm" id="uploadDateFilter" title="Filter by Upload Date">
                        </div>
                        <div class="col-md-2" id="userFilterContainer" style="display: none;">
                            <label for="userFilter" class="form-label">Uploader</label>
                             <select class="form-select form-select-sm" id="userFilter" title="Filter by Uploader">
                                <option value="" selected>All Users</option>
                                <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                                <option value="Nada Mahmoud">Nada Mahmoud</option>
                                <option value="Yousef Ahmed">Yousef Ahmed</option>
                                <option value="Esraa Lashin">Esraa Lashin</option>
                                <option value="Bassant Badr">Bassant Badr</option>
                            </select>
                        </div>
                         <div class="col-md-1 text-end">
                            <button class="btn btn-sm btn-outline" id="resetFiltersBtn" title="Reset Filters"> <!-- Use generic outline -->
                                <i class="fas fa-sync-alt"></i>
                            </button>
                         </div>
                    </div>

                    <!-- Recent Uploads Section -->
                    <div class="mb-4 p-3" id="recentUploadsSection">
                        <h6><i class="fas fa-history me-1"></i> Recent Uploads</h6>
                        <ul class="list-group list-group-flush">
                            <!-- Timestamps fixed and auto-updating -->
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 5 * 60 * 1000).toISOString()}">
                               <div><i class="fas fa-file-pdf file-icon text-danger"></i> Quarterly_Report_Q1.pdf</div>
                               <small class="text-muted time-ago">calculating...</small>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()}">
                               <div><i class="fas fa-file-image file-icon text-success"></i> New_Company_Logo.png</div>
                               <small class="text-muted time-ago">calculating...</small>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()}">
                               <div><i class="fas fa-file-zipper file-icon text-warning"></i> Final_Project_Assets.zip</div>
                               <small class="text-muted time-ago">calculating...</small>
                            </li>
                        </ul>
                    </div>

                    <!-- Files Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 5%;">Type</th>
                                    <th scope="col" style="width: 30%;">File Name</th>
                                    <th scope="col" style="width: 18%;">Upload Date</th>
                                    <th scope="col" style="width: 17%;">Tags</th>
                                    <th scope="col" style="width: 15%;">Uploader</th>
                                    <th scope="col" class="text-center" style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fileTableBody">
                                <!-- Rows with data attributes -->
                                <tr data-file-type="PDF" data-upload-date="2024-05-25" data-uploader="Mohamed Elmenisy">
                                    <td><i class="fas fa-file-pdf file-icon text-danger" title="PDF"></i></td>
                                    <td>
                                        <strong class="file-name">Monthly Performance Report.pdf</strong>
                                        <small class="d-block text-muted">Size: 2.5 MB</small>
                                    </td>
                                    <td class="upload-date">May 25, 2024, 10:30 AM</td>
                                    <td>
                                        <span class="badge text-bg-primary">Reports</span>
                                        <span class="badge text-bg-secondary">Monthly</span>
                                    </td>
                                    <td class="uploader-shared">Mohamed Elmenisy</td>
                                    <td class="text-center action-buttons">
                                        <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="1" data-file-url="path/to/report.pdf">
                                            <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="PDF" data-file-url="path/to/report.pdf">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="1">
                                            <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                    </td>
                                </tr>
                                <tr data-file-type="Image" data-upload-date="2024-05-24" data-uploader="Nada Mahmoud">
                                    <td><i class="fas fa-file-image file-icon text-success" title="Image"></i></td>
                                    <td>
                                        <strong class="file-name">New Product Photo.jpg</strong>
                                        <small class="d-block text-muted">Size: 800 KB</small>
                                    </td>
                                    <td class="upload-date">May 24, 2024, 03:15 PM</td>
                                    <td>
                                        <span class="badge text-bg-warning">Products</span>
                                        <span class="badge text-bg-info">Design</span>
                                    </td>
                                    <td class="uploader-shared">Nada Mahmoud</td>
                                    <td class="text-center action-buttons">
                                       <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="2" data-file-url="path/to/image.jpg">
                                            <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="Image" data-file-url="path/to/image.jpg">
                                           <i class="fas fa-eye"></i>
                                        </button>
                                       <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="2">
                                            <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                    </td>
                                </tr>
                                <tr data-file-type="Archive" data-upload-date="2024-05-23" data-uploader="Yousef Ahmed"> <!-- Name Fixed -->
                                    <td><i class="fas fa-file-zipper file-icon text-warning" title="Archive"></i></td>
                                    <td>
                                        <strong class="file-name">Project Resources.zip</strong>
                                        <small class="d-block text-muted">Size: 15.2 MB</small>
                                    </td>
                                    <td class="upload-date">May 23, 2024, 09:00 AM</td>
                                    <td><span class="badge text-bg-dark">Project X</span></td>
                                    <td class="uploader-shared">Yousef Ahmed</td> <!-- Name Fixed -->
                                    <td class="text-center action-buttons">
                                        <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="3" data-file-url="path/to/archive.zip">
                                            <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                       <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="3">
                                            <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                    </td>
                                </tr>
                                 <tr data-file-type="PDF" data-upload-date="2024-05-22" data-uploader="Esraa Lashin">
                                    <td><i class="fas fa-file-pdf file-icon text-danger" title="PDF"></i></td>
                                    <td>
                                        <strong class="file-name">Meeting Agenda.pdf</strong>
                                        <small class="d-block text-muted">Size: 150 KB</small>
                                    </td>
                                    <td class="upload-date">May 22, 2024, 11:00 AM</td>
                                    <td><span class="badge text-bg-info">Meetings</span></td>
                                    <td class="uploader-shared">Esraa Lashin</td>
                                    <td class="text-center action-buttons">
                                        <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="4" data-file-url="path/to/agenda.pdf">
                                            <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="PDF" data-file-url="path/to/agenda.pdf">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                       <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="4">
                                            <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                    </td>
                                </tr>
                                 <tr data-file-type="Image" data-upload-date="2024-05-26" data-uploader="Bassant Badr">
                                    <td><i class="fas fa-file-image file-icon text-success" title="Image"></i></td>
                                    <td>
                                        <strong class="file-name">Team Photo.png</strong>
                                        <small class="d-block text-muted">Size: 1.2 MB</small>
                                    </td>
                                    <td class="upload-date">May 26, 2024, 09:00 AM</td>
                                    <td><span class="badge text-bg-secondary">Team</span></td>
                                    <td class="uploader-shared">Bassant Badr</td>
                                    <td class="text-center action-buttons">
                                        <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="5" data-file-url="path/to/team.png">
                                            <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="Image" data-file-url="path/to/team.png">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                       <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="5">
                                            <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                        </button>
                                    </td>
                                </tr>
                                <tr id="noResultsRow" style="display: none;">
                                     <td colspan="6" class="text-center text-muted fst-italic py-4">No files found matching your criteria.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination (Optional) -->
                    <nav aria-label="File list navigation" class="mt-3 d-flex justify-content-center">
                        <!-- <ul class="pagination pagination-sm"> -->
                            <!-- Pagination items here -->
                        <!-- </ul> -->
                    </nav>

                </div> <!-- End card-body -->
            </div> <!-- End card -->
            <!-- End File Sharing Component -->
            <!-- Modals defined outside the wrapper -->
        </div> <!-- End Wrapper -->
        <script>
            function initializeFileSharingFeature(container) {
                console.log("Initializing File Sharing...");
                 // Use container.querySelector to scope elements
                const fileTableBody = container.querySelector('#fileTableBody');
                const fileSearchInput = container.querySelector('#fileSearchInput');
                const fileTypeFilter = container.querySelector('#fileTypeFilter');
                const uploadDateFilter = container.querySelector('#uploadDateFilter');
                const userFilter = container.querySelector('#userFilter');
                const userFilterContainer = container.querySelector('#userFilterContainer');
                const noResultsRow = container.querySelector('#noResultsRow');
                const resetFiltersBtn = container.querySelector('#resetFiltersBtn');
                const recentUploadsList = container.querySelector('#recentUploadsSection .list-group');
                 // Select modals from the main document body using their IDs
                 const uploadFileModalEl = document.getElementById('uploadFileModal');
                 const filePreviewModalEl = document.getElementById('filePreviewModal');
                 // Select controls within the upload modal
                const startUploadButton = uploadFileModalEl?.querySelector('#startUploadButton');
                const uploadProgressContainer = uploadFileModalEl?.querySelector('#uploadProgressContainer');
                const uploadProgressBar = uploadFileModalEl?.querySelector('#uploadProgressBar');
                const uploadStatus = uploadFileModalEl?.querySelector('#uploadStatus');
                const uploadFileName = uploadFileModalEl?.querySelector('#uploadFileName');
                const uploadPercentage = uploadFileModalEl?.querySelector('#uploadPercentage');
                const fileInputManual = uploadFileModalEl?.querySelector('#fileInputManual');
                const fileInputHidden = uploadFileModalEl?.querySelector('#fileInputHidden');
                const dropZone = uploadFileModalEl?.querySelector('#dropZone');

                let relativeTimeIntervalId = null;
                let filePreviewModalInstance = null;
                let uploadFileModalInstance = null;
                let boundTableClickHandler = null;
                let boundPreviewShowHandler = null;
                let boundPreviewHideHandler = null;
                let boundUploadHandler = null;
                let boundDropHighlightHandler = null;
                let boundDropUnhighlightHandler = null;
                let boundDropHandler = null;
                let boundDropZoneClickHandler = null;
                let boundFileInputManualChangeHandler = null;
                const dragDropEventTypes = ['dragenter', 'dragover', 'dragleave', 'drop'];
                const dragHighlightEventTypes = ['dragenter', 'dragover'];
                const dragUnhighlightEventTypes = ['dragleave', 'drop'];


                 // Check for Bootstrap and SweetAlert2
                if (typeof bootstrap === 'undefined') { console.error('Bootstrap JS not loaded!'); return { cleanup: () => {} }; }
                if (typeof Swal === 'undefined') { console.error('SweetAlert2 not loaded!'); return { cleanup: () => {} }; }


                // --- Admin Check (Example - Reuse dashboard's logic if possible, or redefine) ---
                 // Use dashboard's currentUser if available
                 const isAdmin = window.currentUser?.role === 'admin';
                if (isAdmin && userFilterContainer) {
                    userFilterContainer.style.display = 'block';
                } else if(userFilterContainer) {
                    userFilterContainer.style.display = 'none'; // Ensure it's hidden if not admin
                }

                // --- Filtering Logic ---
                function applyFilters() {
                    if (!fileTableBody || !fileSearchInput || !fileTypeFilter || !uploadDateFilter || !userFilter) return; // Check required elements
                    const searchTerm = fileSearchInput.value.toLowerCase().trim();
                    const selectedType = fileTypeFilter.value;
                    const selectedDate = uploadDateFilter.value;
                    const selectedUser = userFilter.value;

                    let hasVisibleRows = false;
                    const rows = fileTableBody.querySelectorAll('tr:not(#noResultsRow)');

                    rows.forEach(row => {
                        const fileNameElement = row.querySelector('.file-name');
                        const uploaderElement = row.querySelector('.uploader-shared');

                        const fileName = fileNameElement ? fileNameElement.textContent.toLowerCase() : '';
                        const fileType = row.dataset.fileType || '';
                        const uploadDate = row.dataset.uploadDate || '';
                        const uploader = row.dataset.uploader || (uploaderElement ? uploaderElement.textContent : '');

                        const nameMatch = searchTerm === '' || fileName.includes(searchTerm);
                        const typeMatch = selectedType === '' || fileType === selectedType;
                        const dateMatch = selectedDate === '' || uploadDate === selectedDate;
                        const userMatch = (!isAdmin || selectedUser === '' || uploader === selectedUser);

                        if (nameMatch && typeMatch && dateMatch && userMatch) {
                            row.style.display = '';
                            hasVisibleRows = true;
                        } else {
                            row.style.display = 'none';
                        }
                    });

                    if(noResultsRow) {
                        noResultsRow.style.display = hasVisibleRows ? 'none' : '';
                    }
                }

                // --- Reset Filters ---
                function resetFilters() {
                     if(fileSearchInput) fileSearchInput.value = '';
                     if(fileTypeFilter) fileTypeFilter.value = '';
                     if(uploadDateFilter) uploadDateFilter.value = '';
                     if(userFilter) userFilter.value = '';
                     applyFilters();
                }

                // --- Live Timestamp Update ---
                 // Use global timeAgo function
                 window.timeAgoFS = window.timeAgo || function(isoTimestamp) { /* Fallback */ return isoTimestamp; };
                 function updateRelativeTimesFS() {
                     if (!recentUploadsList) return;
                     const timeElements = recentUploadsList.querySelectorAll('.time-ago');
                     timeElements.forEach(el => { const timestamp = el.closest('li')?.dataset.timestamp; el.textContent = window.timeAgoFS(timestamp); });
                 }

                // --- Action Button Handlers ---
                 boundTableClickHandler = (event) => { // Store handler for removal
                     const button = event.target.closest('.action-btn');
                     if (!button) return;
                     if (button.classList.contains('loading')) return;

                     const fileId = button.dataset.fileId;
                     const row = button.closest('tr');
                     const fileNameElement = row?.querySelector('.file-name');
                     const fileName = fileNameElement ? fileNameElement.textContent : 'this file';

                     if (button.classList.contains('download-btn')) {
                         const fileUrl = button.dataset.fileUrl;
                         if (!fileUrl || fileUrl === 'path/to/...' || fileUrl.trim() === '') { console.error(`Download failed: File URL missing for ID ${fileId}.`); Swal.fire({icon: 'error', title: 'Download Error', text: 'URL is missing.' }); return; }
                         button.classList.add('loading'); button.disabled = true; console.log(`Attempting download: ID ${fileId}, URL ${fileUrl}`);
                         try { const link = document.createElement('a'); link.href = fileUrl; link.setAttribute('download', fileName); document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log(`Download initiated: ${fileName}`); }
                         catch (error) { console.error('Download error:', error); Swal.fire({icon: 'error', title: 'Download Failed', text: 'Error starting download.'}); }
                         finally { setTimeout(() => { button.classList.remove('loading'); button.disabled = false; }, 500); }
                     }
                     else if (button.classList.contains('delete-btn')) {
                         // Use global showConfirmModal if available
                         const confirmFunction = window.showConfirmModal || function(title, msg, cb, btnClass) { if(confirm(msg)) cb(); };
                         confirmFunction('Delete File', `Are you sure you want to delete the file: <br><strong>${fileName}</strong>?`, () => {
                             button.classList.add('loading'); button.disabled = true; console.log(`Attempting delete: ID ${fileId}`);
                             setTimeout(() => { // Simulate backend call
                                 const deleteSuccess = Math.random() > 0.1;
                                 if (deleteSuccess) { console.log(`Deleted ID: ${fileId}`); row.style.opacity = '0'; setTimeout(() => { row.remove(); applyFilters(); Swal.fire('Deleted!', `"${fileName}" deleted.`, 'success'); }, 300); }
                                 else { console.error(`Failed to delete ID: ${fileId}`); button.classList.remove('loading'); button.disabled = false; Swal.fire('Error!', 'Could not delete file.', 'error'); }
                             }, 1000);
                         }, 'btn-danger'); // Use danger class for confirm button
                     }
                 };

                // --- Preview Modal Logic ---
                boundPreviewShowHandler = (event) => {
                     if (!filePreviewModalEl) return;
                     const button = event.relatedTarget; // Button that triggered the modal
                     if (!button) return; // Should not happen with data-bs-toggle

                     const fileUrl = button.getAttribute('data-file-url');
                     const fileType = button.getAttribute('data-file-type');
                     const row = button.closest('tr');
                     const fileNameElement = row?.querySelector('.file-name');
                     const fileName = fileNameElement ? fileNameElement.textContent : 'N/A';
                     const previewContent = filePreviewModalEl.querySelector('#previewContent');
                     const previewFileNameEl = filePreviewModalEl.querySelector('#previewFileName');
                     const previewFileTypeEl = filePreviewModalEl.querySelector('#previewFileType');

                     if(previewFileNameEl) previewFileNameEl.textContent = `File Name: ${fileName}`;
                     if(previewFileTypeEl) previewFileTypeEl.textContent = `Type: ${fileType ? fileType.toUpperCase() : 'N/A'}`;
                     if(previewContent) previewContent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                     if (fileUrl && fileUrl !== 'path/to/...' && fileUrl.trim() !== '' && previewContent) {
                         setTimeout(() => {
                             if (fileType === 'Image') { previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" alt="Preview of ${fileName}" style="max-height: 75vh;">`; }
                             else if (fileType === 'PDF') { previewContent.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="650px"><p class="text-warning p-4">Preview not available. Your browser might not support PDF embedding or the file is inaccessible. <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Download PDF</a></p></object>`; }
                             else { previewContent.innerHTML = `<p class="text-warning p-4">Preview is not available for this file type (${fileType}).</p>`; }
                         }, 300);
                     } else if(previewContent) { previewContent.innerHTML = `<p class="text-danger p-4">Could not load preview. URL missing or invalid.</p>`; }
                };
                boundPreviewHideHandler = () => {
                     if (!filePreviewModalEl) return;
                     const previewContent = filePreviewModalEl.querySelector('#previewContent');
                     if(previewContent) previewContent.innerHTML = '';
                };

                // --- Upload Modal Logic ---
                 boundUploadHandler = () => {
                     if (!fileInputManual || !fileInputHidden || !uploadProgressContainer || !uploadProgressBar || !uploadFileName || !uploadPercentage || !uploadStatus) {
                         console.error("Upload elements missing."); return;
                     }
                     const filesToUpload = fileInputManual.files.length > 0 ? fileInputManual.files : fileInputHidden.files;
                     if (filesToUpload.length === 0) { Swal.fire('No File Selected', 'Please select at least one file.', 'warning'); return; }
                     const firstFile = filesToUpload[0];
                     console.log("Starting upload for:", firstFile.name);
                     uploadFileName.textContent = `Uploading: ${firstFile.name}`; uploadProgressContainer.style.display = 'block'; uploadProgressBar.style.width = '0%'; uploadProgressBar.classList.remove('bg-success', 'bg-danger'); uploadProgressBar.classList.add('progress-bar-animated'); uploadPercentage.textContent = '0%'; uploadStatus.textContent = 'Initializing...'; uploadStatus.className = 'text-muted d-block mt-1';
                     let progress = 0; const interval = setInterval(() => { progress += Math.random() * 15; progress = Math.min(progress, 100); uploadProgressBar.style.width = progress + '%'; uploadProgressBar.setAttribute('aria-valuenow', progress); uploadPercentage.textContent = Math.round(progress) + '%'; if (progress >= 100) { clearInterval(interval); const uploadSuccess = Math.random() > 0.2; uploadProgressBar.classList.remove('progress-bar-animated'); if(uploadSuccess) { uploadStatus.textContent = 'Upload successful!'; uploadStatus.className = 'text-success d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-success'); /* TODO: Add file to table */ uploadFileModalInstance?.hide(); window.showToast?.('File uploaded successfully!', 'success');} else { uploadStatus.textContent = 'Upload failed.'; uploadStatus.className = 'text-danger d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-danger'); window.showToast?.('File upload failed.', 'error'); } if(fileInputManual) fileInputManual.value = ''; if(fileInputHidden) fileInputHidden.value = ''; } }, 300);
                 };
                 // Drag & Drop
                 const preventDefaults = (e) => { e.preventDefault(); e.stopPropagation(); };
                 boundDropHighlightHandler = (e) => { dropZone?.classList.add('highlight'); }; // Add a .highlight class in CSS if needed
                 boundDropUnhighlightHandler = (e) => { dropZone?.classList.remove('highlight'); };
                 boundDropHandler = (e) => { let dt = e.dataTransfer; let files = dt.files; if (fileInputHidden) { fileInputHidden.files = files; /* Assign dropped files */ } handleUpload(); }; // Trigger upload on drop
                 boundDropZoneClickHandler = () => fileInputHidden?.click();
                 boundFileInputManualChangeHandler = () => { if(fileInputManual.files.length > 0) boundUploadHandler(); }; // Trigger upload if files selected manually

                // --- Event Listeners Setup ---
                if(fileSearchInput) fileSearchInput.addEventListener('input', applyFilters);
                if(fileTypeFilter) fileTypeFilter.addEventListener('change', applyFilters);
                if(uploadDateFilter) uploadDateFilter.addEventListener('change', applyFilters);
                if(userFilter) userFilter.addEventListener('change', applyFilters);
                if(resetFiltersBtn) resetFiltersBtn.addEventListener('click', resetFilters);
                if(fileTableBody) fileTableBody.addEventListener('click', boundTableClickHandler);

                // Modals need to be initialized using elements from the main document
                 if (filePreviewModalEl) {
                     filePreviewModalInstance = bootstrap.Modal.getOrCreateInstance(filePreviewModalEl);
                     filePreviewModalEl.addEventListener('show.bs.modal', boundPreviewShowHandler);
                     filePreviewModalEl.addEventListener('hidden.bs.modal', boundPreviewHideHandler);
                 }
                if (uploadFileModalEl) {
                     uploadFileModalInstance = bootstrap.Modal.getOrCreateInstance(uploadFileModalEl);
                 }

                if (startUploadButton) startUploadButton.addEventListener('click', boundUploadHandler);
                 // Drag & Drop Listeners
                 if (dropZone) {
                     dragDropEventTypes.forEach(eventName => { dropZone.addEventListener(eventName, preventDefaults, false); /* document.body listener removed for isolation */ });
                     dragHighlightEventTypes.forEach(eventName => dropZone.addEventListener(eventName, boundDropHighlightHandler, false));
                     dragUnhighlightEventTypes.forEach(eventName => dropZone.addEventListener(eventName, boundDropUnhighlightHandler, false));
                     dropZone.addEventListener('drop', boundDropHandler, false);
                     dropZone.addEventListener('click', boundDropZoneClickHandler);
                 }
                 if (fileInputManual) fileInputManual.addEventListener('change', boundFileInputManualChangeHandler);

                // Initial update for relative times
                updateRelativeTimesFS();
                relativeTimeIntervalId = setInterval(updateRelativeTimesFS, 60000);

                // --- Cleanup Function ---
                const cleanup = () => {
                     console.log("Cleaning up File Sharing...");
                     clearInterval(relativeTimeIntervalId);
                     // Remove listeners
                     fileSearchInput?.removeEventListener('input', applyFilters);
                     fileTypeFilter?.removeEventListener('change', applyFilters);
                     uploadDateFilter?.removeEventListener('change', applyFilters);
                     userFilter?.removeEventListener('change', applyFilters);
                     resetFiltersBtn?.removeEventListener('click', resetFilters);
                     if (boundTableClickHandler) fileTableBody?.removeEventListener('click', boundTableClickHandler);
                     if (filePreviewModalEl) {
                         filePreviewModalEl.removeEventListener('show.bs.modal', boundPreviewShowHandler);
                         filePreviewModalEl.removeEventListener('hidden.bs.modal', boundPreviewHideHandler);
                     }
                     if (startUploadButton) startUploadButton.removeEventListener('click', boundUploadHandler);
                     if (dropZone) {
                         dragDropEventTypes.forEach(eventName => dropZone.removeEventListener(eventName, preventDefaults, false));
                         dragHighlightEventTypes.forEach(eventName => dropZone.removeEventListener(eventName, boundDropHighlightHandler, false));
                         dragUnhighlightEventTypes.forEach(eventName => dropZone.removeEventListener(eventName, boundDropUnhighlightHandler, false));
                         dropZone.removeEventListener('drop', boundDropHandler, false);
                         dropZone.removeEventListener('click', boundDropZoneClickHandler);
                     }
                     if (fileInputManual) fileInputManual.removeEventListener('change', boundFileInputManualChangeHandler);

                     // Dispose Modals if they exist BUT DO NOT REMOVE THEM from the main DOM
                     // Let Bootstrap handle them if the user navigates back
                     // filePreviewModalInstance?.dispose();
                     // uploadFileModalInstance?.dispose();

                     console.log("File Sharing cleanup complete.");
                };

                return { cleanup };
            }
             // Expose initializer globally
             window.initializeFileSharingFeature = initializeFileSharingFeature;
        </script>
    </template>
    <!-- ==================== END: File Sharing Template ==================== -->

    <!-- ==================== START: Project Tracking Template ==================== -->
    <template id="projectTrackingAssets">
        <style id="project-tracking-styles">
            /* Paste CSS from Project Tracking.txt here, scoped */
             #featureSectionsContainer.project-tracking-feature { /* Basic wrapper */ }
             #featureSectionsContainer.project-tracking-feature #project-tracking-section { /* Main container */ }
             #featureSectionsContainer.project-tracking-feature body { background-color: transparent; font-family: inherit; }

            /* --- Consistent Color Palette --- */
            /* :root variables are inherited from dashboard */

             #featureSectionsContainer.project-tracking-feature #project-tracking-section .card { border: none; border-radius: 0.5rem; margin-bottom: 1.5rem; background-color: var(--white); } /* Set background */
             body.dark-theme #featureSectionsContainer.project-tracking-feature #project-tracking-section .card { background-color: var(--light); }
            #featureSectionsContainer.project-tracking-feature #project-tracking-section .card-header { background-color: var(--white); border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature #project-tracking-section .card-header { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-fancy-title { background: var(--app-header-bg); color: white; padding: 10px 20px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 0; }
            #featureSectionsContainer.project-tracking-feature .pt-fancy-title i { margin-right: 10px; }
            #featureSectionsContainer.project-tracking-feature .pt-filters-section { background-color: var(--white); padding: 0.75rem 1.25rem; border-radius: 0.375rem; border: 1px solid var(--light-gray); margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-filters-section { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; font-weight: 500; }
            #featureSectionsContainer.project-tracking-feature .pt-filters-section .form-select-sm { font-size: 0.875rem; }
            #featureSectionsContainer.project-tracking-feature #resetProjectFiltersBtn { /* Uses dashboard btn-outline */ }
            #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 300px; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
            #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-title { font-weight: 600; color: var(--gray); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
            #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--white); padding: 15px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 300px; display: flex; flex-direction: column; }
            body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--primary); font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid var(--light-gray); padding-bottom: 8px; }
            body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: #a5b4fc; border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-reminders ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
            #featureSectionsContainer.project-tracking-feature .pt-reminders li { padding: 8px 5px; border-bottom: 1px dashed var(--light-gray); font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; color: var(--text-color); }
            body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li { border-bottom-color: var(--light-gray); }
            #featureSectionsContainer.project-tracking-feature .pt-reminders li:last-child { border-bottom: none; }
            #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--app-hover-bg); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--light-gray); }
            #featureSectionsContainer.project-tracking-feature .pt-reminders .deadline { font-size: 0.8em; color: var(--danger); font-weight: 500; }
            #featureSectionsContainer.project-tracking-feature .pt-reminders .days-left { font-size: 0.75em; color: var(--gray); font-style: italic; }
            #featureSectionsContainer.project-tracking-feature .pt-table-container { background-color: var(--white); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-table-container h5 { color: var(--primary); margin-bottom: 15px; font-weight: 600; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container h5 { color: #a5b4fc; }
            #featureSectionsContainer.project-tracking-feature .pt-table thead { background-color: var(--app-light) !important; color: var(--app-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table thead { background-color: var(--primary-light) !important; color: var(--gray); border-bottom-color: var(--light-gray);}
            #featureSectionsContainer.project-tracking-feature .pt-table tbody td { vertical-align: middle; font-size: 0.875rem; padding: 0.7rem 0.75rem; color: var(--text-color);}
            #featureSectionsContainer.project-tracking-feature .pt-table th[data-sort-by] { cursor: pointer; }
            #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon { margin-left: 5px; color: #ccc; font-size: 0.8em; display: inline-block; width: 10px; text-align: center; }
            #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon.active { color: var(--primary); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon.active { color: #a5b4fc; }
            #featureSectionsContainer.project-tracking-feature .pt-table .project-name { font-weight: 500; color: var(--dark); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .project-name { color: var(--text-color); }
            #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { display: inline-block; background-color: var(--light-gray); color: var(--gray); font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-right: 3px; margin-bottom: 2px; white-space: nowrap; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { background-color: var(--light-gray); color: var(--dark); }
            #featureSectionsContainer.project-tracking-feature .pt-table .progress-cell { min-width: 120px; }
            #featureSectionsContainer.project-tracking-feature .pt-table .progress { height: 14px; background-color: var(--light-gray); border-radius: 7px; overflow: hidden; position: relative; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .progress { background-color: var(--light-gray); }
            #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar { font-size: 0.8rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; color: white; } /* Adjusted size and color */
            #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-high { background-color: var(--chart-green) !important; }
            #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-medium { background-color: var(--chart-orange) !important; color: var(--dark) !important; } /* Dark text on orange */
            #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-low { background-color: var(--chart-red) !important; }
            #featureSectionsContainer.project-tracking-feature .pt-table .status-badge,
            #featureSectionsContainer.project-tracking-feature .pt-table .priority-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; display: inline-block; text-align: center; }
            #featureSectionsContainer.project-tracking-feature .pt-table .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .status-inprogress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .status-delayed { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .priority-high { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .priority-medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); }
            #featureSectionsContainer.project-tracking-feature .pt-table .priority-low { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
             /* Dark theme badge overrides */
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-completed { color: var(--status-completed-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-inprogress { color: var(--status-inprogress-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-delayed { color: var(--status-delayed-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .status-pending { color: var(--status-pending-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-high { color: var(--priority-high-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-medium { color: var(--priority-medium-text) !important; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .priority-low { color: var(--priority-low-text) !important; }

            #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
            #featureSectionsContainer.project-tracking-feature .pt-pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 5px; }
            #featureSectionsContainer.project-tracking-feature .pt-pagination button,
            #featureSectionsContainer.project-tracking-feature .pt-pagination span { padding: 8px 12px; border: 1px solid var(--light-gray); background-color: var(--white); border-radius: 4px; font-size: 14px; color: var(--text-color); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button,
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination span { background-color: var(--light); border-color: var(--light-gray); color: var(--text-color); }
            #featureSectionsContainer.project-tracking-feature .pt-pagination button { cursor: pointer; transition: background-color 0.2s ease; }
            #featureSectionsContainer.project-tracking-feature .pt-pagination button:hover:not(:disabled) { background-color: var(--light-gray); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button:hover:not(:disabled) { background-color: var(--light-gray); }
            #featureSectionsContainer.project-tracking-feature .pt-pagination button:disabled { cursor: not-allowed; opacity: 0.6; background-color: var(--light); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-pagination button:disabled { background-color: var(--primary-light); }
            #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-page-info { border: none; background: none; padding: 8px 5px; }
            #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-current-page { font-weight: bold; }

            @media (max-width: 992px) {
                 #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container,
                 #featureSectionsContainer.project-tracking-feature .pt-reminders { height: 280px; }
             }
            @media (max-width: 768px) {
                  #featureSectionsContainer.project-tracking-feature #project-tracking-section .card-header { flex-direction: column; align-items: flex-start; }
                  #featureSectionsContainer.project-tracking-feature .pt-filters-section .row > div { margin-bottom: 10px; }
                  #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-md-4,
                  #featureSectionsContainer.project-tracking-feature .pt-visualizations .col-md-8 { width: 100%; }
                  #featureSectionsContainer.project-tracking-feature .pt-reminders { margin-bottom: 1.5rem; }
                  #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 100px; }
            }

        </style>
        <div class="project-tracking-feature-wrapper"> <!-- Wrapper for scoping -->
            <div id="project-tracking-section">

                <!-- Section Header -->
                <div class="card-header bg-white border-0 mb-3">
                    <h2 class="pt-fancy-title"><i class="fas fa-tasks me-2"></i> Project Tracking</h2>
                </div>

                <!-- Filters -->
                <div class="pt-filters-section">
                    <div class="row gy-2 align-items-end">
                        <div class="col-md-4">
                            <label for="project-status-filter" class="form-label">Filter by Status:</label>
                            <select class="form-select form-select-sm" id="project-status-filter">
                                <option value="" selected>All Statuses</option>
                                <option value="Completed">Completed</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Delayed">Delayed</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="project-team-filter" class="form-label">Filter by Team/Member:</label>
                            <select class="form-select form-select-sm" id="project-team-filter">
                                <option value="" selected>All Teams/Members</option>
                                <!-- Options populated dynamically by JS -->
                                <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                                <option value="Yousef Ahmed">Yousef Ahmed</option>
                                <option value="Esraa Lashin">Esraa Lashin</option>
                                <option value="Bassant Badr">Bassant Badr</option>
                             </select>
                        </div>
                        <div class="col-md-2">
                             <label for="project-priority-filter" class="form-label">Filter by Priority:</label>
                            <select class="form-select form-select-sm" id="project-priority-filter">
                                <option value="" selected>All Priorities</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-2 text-end">
                             <button class="btn btn-sm btn-outline w-100" id="resetProjectFiltersBtn" title="Reset Filters"> <!-- Use generic outline -->
                                <i class="fas fa-sync-alt me-1"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Visualizations & Reminders -->
                <div class="row g-3 pt-visualizations">
                     <div class="col-lg-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <p class="chart-title">Project Status Distribution</p>
                                    <canvas id="projectStatusPieChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                     <p class="chart-title">Overall Progress Trend (Simulated)</p>
                                     <canvas id="projectProgressLineChart"></canvas>
                                </div>
                            </div>
                        </div>
                     </div>
                     <div class="col-lg-4">
                         <div class="pt-reminders">
                             <h6><i class="fas fa-bell me-1 text-warning"></i> Upcoming Deadlines (Next 7 Days)</h6>
                             <ul id="upcomingDeadlinesList">
                                 <li class="text-muted text-center pt-5">Loading deadlines...</li>
                             </ul>
                         </div>
                     </div>
                </div>


                <!-- Project Table -->
                <div class="mt-4 pt-table-container">
                     <h5><i class="fas fa-list-check me-2"></i> Project Details</h5>
                     <div class="table-responsive">
                        <table class="table table-sm table-hover table-striped align-middle pt-table" id="projectTrackingTable">
                            <thead>
                                <tr>
                                    <th data-sort-by="name">Project Name <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort-by="startDate">Start Date <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort-by="endDate">End Date <i class="fas fa-sort sort-icon"></i></th>
                                    <th>Assigned Team</th>
                                    <th class="text-center progress-cell" data-sort-by="progress">Progress (%) <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="text-center" data-sort-by="status">Status <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="text-center" data-sort-by="priority">Priority <i class="fas fa-sort sort-icon"></i></th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="projectTableBody">
                                 <tr>
                                     <td colspan="8" class="text-center p-4 text-muted">
                                         <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                         </div>
                                         Loading project data...
                                     </td>
                                 </tr>
                            </tbody>
                        </table>
                     </div>
                     <div class="pt-pagination" id="projectPaginationControls"></div>
                </div>

            </div> <!-- End #project-tracking-section -->
        </div> <!-- End Wrapper -->
        <script>
            // Make sure this function is globally available or called correctly
            function initializeProjectTrackingFeature(container) {
                console.log("Initializing Project Tracking...");
                // Check for Chart.js dependency
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded! Project Tracking charts cannot be displayed.');
                    // Optionally display a message to the user in the chart containers
container.querySelector('#projectStatusPieChart')?.parentElement.insertAdjacentHTML('beforeend', '<p class="text-danger text-center small p-3">Chart library not loaded.</p>');
                    container.querySelector('#projectProgressLineChart')?.parentElement.insertAdjacentHTML('beforeend', '<p class="text-danger text-center small p-3">Chart library not loaded.</p>');
                    // Do not return immediately, allow table functionality to proceed if possible
                 }

                // --- Data Source (Needs actual data) ---
                let projectData = [
                    { id: 1, name: "Website Redesign", startDate: "2024-01-15", endDate: "2024-06-30", assignedTeam: ["Mohamed Elmenisy", "Esraa Lashin"], progress: 85, status: "In Progress", priority: "High", notes: "Phase 3 ongoing" },
                    { id: 2, name: "Mobile App Dev", startDate: "2024-03-01", endDate: "2024-09-15", assignedTeam: ["Yousef Ahmed", "Bassant Badr"], progress: 40, status: "In Progress", priority: "High", notes: "Backend API integration needed" },
                    { id: 3, name: "Marketing Campaign Q3", startDate: "2024-07-01", endDate: "2024-09-30", assignedTeam: ["Nada Mahmoud", "Bassant Badr"], progress: 10, status: "Pending", priority: "Medium", notes: "Planning stage" },
                    { id: 4, name: "Infrastructure Upgrade", startDate: "2024-02-01", endDate: "2024-05-31", assignedTeam: ["Mohamed Elmenisy"], progress: 100, status: "Completed", priority: "High", notes: "Deployed successfully" },
                    { id: 5, name: "Internal Training", startDate: "2024-06-10", endDate: "2024-07-10", assignedTeam: ["Nada Mahmoud"], progress: 60, status: "Delayed", priority: "Low", notes: "Module 2 needs review" },
                    { id: 6, name: "Client Portal Launch", startDate: "2024-05-01", endDate: "2024-08-31", assignedTeam: ["Yousef Ahmed", "Esraa Lashin", "Mohamed Elmenisy"], progress: 75, status: "In Progress", priority: "Medium", notes: "User testing feedback pending" },
                    { id: 7, name: "Data Analysis Pipeline", startDate: "2024-08-01", endDate: "2024-11-30", assignedTeam: ["Yousef Ahmed"], progress: 5, status: "Pending", priority: "Medium", notes: "" },
                    { id: 8, name: "HR System Integration", startDate: "2024-04-15", endDate: "2024-07-15", assignedTeam: ["Nada Mahmoud", "Mohamed Elmenisy"], progress: 95, status: "In Progress", priority: "Low", notes: "Final checks" },
                ];
                // Expose filtered data globally for date format changes
                window.filteredProjectData = [...projectData];
                let currentPage = 1;
                const rowsPerPage = 5;
                let currentSortColumn = 'endDate';
                let currentSortDirection = 'asc';

                // --- DOM Elements (Scoped) ---
                const statusFilter = container.querySelector('#project-status-filter');
                const teamFilter = container.querySelector('#project-team-filter');
                const priorityFilter = container.querySelector('#project-priority-filter');
                const resetFiltersBtn = container.querySelector('#resetProjectFiltersBtn');
                const tableBody = container.querySelector('#projectTableBody');
                const paginationControls = container.querySelector('#projectPaginationControls');
                const deadlinesList = container.querySelector('#upcomingDeadlinesList');
                const tableHeaders = container.querySelectorAll("#projectTrackingTable th[data-sort-by]");
                const pieChartCanvas = container.querySelector('#projectStatusPieChart');
                const lineChartCanvas = container.querySelector('#projectProgressLineChart');

                // --- Chart Instances ---
                let statusPieChartInstance = null;
                let progressLineChartInstance = null;

                // --- Utility Functions (Use Dashboard's if available) ---
                const formatDatePT = window.formatDateForDisplay || function(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString + 'T00:00:00'); return date.toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric' }); };
                const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                const rgbaColor = (c, alpha) => { if (!c) return 'rgba(0,0,0,0.1)'; if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; };

                // --- Badge/Class Helpers ---
                function getStatusBadgeClass(status) { switch (status?.toLowerCase()) { case 'completed': return 'status-completed'; case 'in progress': return 'status-inprogress'; case 'delayed': return 'status-delayed'; case 'pending': return 'status-pending'; default: return ''; } }
                function getPriorityBadgeClass(priority) { switch (priority?.toLowerCase()) { case 'high': return 'priority-high'; case 'medium': return 'priority-medium'; case 'low': return 'priority-low'; default: return ''; } }
                function getProgressBgClass(progress) { if (progress >= 80) return 'bg-progress-high'; if (progress >= 50) return 'bg-progress-medium'; return 'bg-progress-low'; }
                function getProgressTextColor(progress) { return (progress >= 50 && progress < 80) ? '#212529' : '#fff'; }

                // --- Chart Rendering ---
                // Expose globally for theme changes
                window.renderProjectStatusPieChart = function(data) {
                    if (typeof Chart === 'undefined' || !pieChartCanvas) return;
                    const ctx = pieChartCanvas.getContext('2d');
                    if (!ctx) return;
                    const statusCounts = data.reduce((acc, project) => { acc[project.status] = (acc[project.status] || 0) + 1; return acc; }, {});
                    const labels = Object.keys(statusCounts);
                    const chartData = Object.values(statusCounts);
                    const backgroundColors = labels.map(label => { switch (label.toLowerCase()) { case 'completed': return getCssVar('--chart-green'); case 'in progress': return getCssVar('--chart-blue'); case 'delayed': return getCssVar('--chart-orange'); case 'pending': return getCssVar('--chart-gray'); default: return getCssVar('--app-secondary'); } });
                    const config = { type: 'pie', data: { labels: labels, datasets: [{ data: chartData, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: getCssVar('--text-color') } } } } }; // Added text color
                    if (statusPieChartInstance) statusPieChartInstance.destroy();
                    statusPieChartInstance = new Chart(ctx, config);
                }
                // Expose globally for theme changes
                window.renderProjectProgressLineChart = function() { // Keeps simulated data
                     if (typeof Chart === 'undefined' || !lineChartCanvas) return;
                     const ctx = lineChartCanvas.getContext('2d'); if (!ctx) return;
                     const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']; const data = [20, 35, 50, 60, 75, 80]; // SIMULATED
                     const config = { type: 'line', data: { labels: labels, datasets: [{ label: 'Overall Progress %', data: data, borderColor: getCssVar('--chart-blue'), backgroundColor: rgbaColor(getCssVar('--chart-blue'), 0.1), fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks:{color: getCssVar('--text-color')}, grid: {color: getCssVar('--light-gray')} }, x: { ticks:{color: getCssVar('--text-color')}, grid: {color: getCssVar('--light-gray')} } }, plugins: { legend: { display: false } } } }; // Added text/grid color
                     if (progressLineChartInstance) progressLineChartInstance.destroy(); progressLineChartInstance = new Chart(ctx, config);
                }

                // --- Reminders List Rendering ---
                // Expose globally for date format changes
                window.renderUpcomingDeadlines = function(data) {
                    if (!deadlinesList) return; deadlinesList.innerHTML = '';
                    const today = new Date(); today.setHours(0, 0, 0, 0); const sevenDaysFromNow = new Date(today); sevenDaysFromNow.setDate(today.getDate() + 7);
                    const upcoming = data.filter(project => { if (!project.endDate || project.status === 'Completed') return false; const endDate = new Date(project.endDate + 'T00:00:00'); return endDate >= today && endDate <= sevenDaysFromNow; }).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                    if (upcoming.length === 0) { deadlinesList.innerHTML = '<li class="text-muted text-center pt-5">No upcoming deadlines found.</li>'; return; }
                    upcoming.forEach(project => { const li = document.createElement('li'); const endDate = new Date(project.endDate + 'T00:00:00'); const diffTime = Math.abs(endDate - today); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const daysLeftText = diffDays === 0 ? 'Due Today' : `${diffDays} day${diffDays > 1 ? 's' : ''} left`; li.innerHTML = `<span>${project.name}</span><span class="text-end"><span class="deadline me-2">${formatDatePT(project.endDate)}</span><span class="days-left">(${daysLeftText})</span></span>`; deadlinesList.appendChild(li); });
                }

                // --- Table Rendering ---
                function renderTable() {
                    if (!tableBody) return;
                    tableBody.innerHTML = '';
                     if (window.filteredProjectData.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-muted fst-italic">No projects found matching criteria.</td></tr>`; renderPagination(); return; }
                    const totalItems = window.filteredProjectData.length; const totalPages = Math.ceil(totalItems / rowsPerPage); if (currentPage > totalPages && totalPages > 0) currentPage = totalPages; else if (currentPage < 1) currentPage = 1; const startIndex = (currentPage - 1) * rowsPerPage; const endIndex = startIndex + rowsPerPage; const pageData = window.filteredProjectData.slice(startIndex, endIndex);
                    pageData.forEach(project => {
                        const row = document.createElement('tr');
                        const statusClass = getStatusBadgeClass(project.status); const priorityClass = getPriorityBadgeClass(project.priority); const progressBg = getProgressBgClass(project.progress); const progressTextClr = getProgressTextColor(project.progress);
                        const teamHtml = project.assignedTeam.map(member => `<span>${member}</span>`).join('');
                        row.innerHTML = `
                            <td><div class="project-name">${project.name}</div></td>
                            <td>${formatDatePT(project.startDate)}</td>
                            <td>${formatDatePT(project.endDate)}</td>
                            <td class="assigned-team">${teamHtml}</td>
                            <td class="text-center progress-cell">
                                <div class="progress" role="progressbar" aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100">
                                    <div class="progress-bar ${progressBg}" style="width: ${project.progress}%; color: ${progressTextClr};">${project.progress}%</div>
                                </div>
                            </td>
                            <td class="text-center"><span class="status-badge ${statusClass}">${project.status}</span></td>
                            <td class="text-center"><span class="priority-badge ${priorityClass}">${project.priority}</span></td>
                            <td class="notes-cell" title="${project.notes || ''}">${project.notes || '-'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    renderPagination(); updateSortIcons();
                }

                // --- Pagination Rendering ---
                function renderPagination() { if (!paginationControls) return; paginationControls.innerHTML = ''; const totalItems = window.filteredProjectData.length; if (totalItems <= rowsPerPage) return; const totalPages = Math.ceil(totalItems / rowsPerPage); const createButton = (text, page, disabled = false) => { const button = document.createElement('button'); button.innerHTML = text; button.disabled = disabled; button.addEventListener('click', () => { currentPage = page; renderTable(); }); return button; }; paginationControls.appendChild(createButton('<i class="fas fa-chevron-left"></i> Prev', currentPage - 1, currentPage === 1)); const pageInfo = document.createElement('span'); pageInfo.className = 'pt-page-info'; pageInfo.innerHTML = `Page <span class="pt-current-page">${currentPage}</span> of ${totalPages}`; paginationControls.appendChild(pageInfo); paginationControls.appendChild(createButton('Next <i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages)); }

                // --- Sorting Logic ---
                function updateSortIcons() { tableHeaders.forEach(th => { const icon = th.querySelector('.sort-icon'); if (!icon) return; const columnKey = th.getAttribute('data-sort-by'); icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down', 'active'); if (columnKey === currentSortColumn) { icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'); icon.classList.add('active'); } else { icon.classList.add('fa-sort'); } }); }
                function handleSortClick(event) { const header = event.currentTarget; const columnKey = header.getAttribute('data-sort-by'); if (!columnKey) return; if (currentSortColumn === columnKey) { currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc'; } else { currentSortColumn = columnKey; currentSortDirection = 'asc'; } applyFiltersAndSort(); }

                // --- Combined Filter & Sort Function ---
                // Expose globally for date format changes
                window.applyFiltersAndSort = function() {
                    if (!statusFilter || !teamFilter || !priorityFilter) return; // Check elements exist
                    const statusValue = statusFilter.value; const teamValue = teamFilter.value; const priorityValue = priorityFilter.value;
                    let tempFilteredData = projectData.filter(project => { const statusMatch = !statusValue || project.status === statusValue; const teamMatch = !teamValue || project.assignedTeam.includes(teamValue); const priorityMatch = !priorityValue || project.priority === priorityValue; return statusMatch && teamMatch && priorityMatch; });
                    tempFilteredData.sort((a, b) => { let valA = a[currentSortColumn]; let valB = b[currentSortColumn]; if (currentSortColumn === 'startDate' || currentSortColumn === 'endDate') { valA = new Date(valA + 'T00:00:00'); valB = new Date(valB + 'T00:00:00'); } else if (currentSortColumn === 'progress') { valA = Number(valA); valB = Number(valB); } else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } else if (currentSortColumn === 'priority') { const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 }; valA = priorityOrder[a.priority] || 0; valB = priorityOrder[b.priority] || 0; } if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1; if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1; return 0; });
                    window.filteredProjectData = tempFilteredData; // Update global filtered data
                    currentPage = 1;
                    renderTable();
                    window.renderProjectStatusPieChart(window.filteredProjectData);
                    window.renderUpcomingDeadlines(window.filteredProjectData);
                    window.renderProjectProgressLineChart();
                }

                // --- Reset Filters ---
                function resetFilters() { if (!statusFilter || !teamFilter || !priorityFilter) return; statusFilter.value = ''; teamFilter.value = ''; priorityFilter.value = ''; window.applyFiltersAndSort(); }

                 // --- Dynamic Team Filter Options ---
                 function populateTeamFilter() {
                     if (!teamFilter) return;
                     const teamMembers = [...new Set(projectData.flatMap(p => p.assignedTeam))].sort();
                     teamFilter.innerHTML = '<option value="" selected>All Teams/Members</option>'; // Reset
                     teamMembers.forEach(member => {
                         const option = document.createElement('option');
                         option.value = member;
                         option.textContent = member;
                         teamFilter.appendChild(option);
                     });
                 }

                 // --- Event Listeners Setup ---
                const boundSortHandler = handleSortClick;
                tableHeaders.forEach(th => th.addEventListener('click', boundSortHandler));
                statusFilter?.addEventListener('change', window.applyFiltersAndSort); // Use global
                teamFilter?.addEventListener('change', window.applyFiltersAndSort); // Use global
                priorityFilter?.addEventListener('change', window.applyFiltersAndSort); // Use global
                resetFiltersBtn?.addEventListener('click', resetFilters);


                 // --- Initial Render ---
                 populateTeamFilter();
                 window.applyFiltersAndSort(); // Initial render with data

                // --- Cleanup Function ---
                const cleanup = () => {
                    console.log("Cleaning up Project Tracking...");
                    tableHeaders.forEach(th => th.removeEventListener('click', boundSortHandler));
                    statusFilter?.removeEventListener('change', window.applyFiltersAndSort);
                    teamFilter?.removeEventListener('change', window.applyFiltersAndSort);
                    priorityFilter?.removeEventListener('change', window.applyFiltersAndSort);
                    resetFiltersBtn?.removeEventListener('click', resetFilters);
                    statusPieChartInstance?.destroy();
                    progressLineChartInstance?.destroy();
                    statusPieChartInstance = null;
                    progressLineChartInstance = null;
                    // Remove global functions
                    delete window.renderProjectStatusPieChart;
                    delete window.renderProjectProgressLineChart;
                    delete window.renderUpcomingDeadlines;
                    delete window.applyFiltersAndSort;
                    delete window.filteredProjectData;
                    console.log("Project Tracking cleanup complete.");
                };

                return { cleanup };
            }
            // Expose initializer globally
            window.initializeProjectTrackingFeature = initializeProjectTrackingFeature;
        </script>
    </template>
    <!-- ==================== END: Project Tracking Template ==================== -->

    <!-- ==================== START: Reports & Analytics Template ==================== -->
    <template id="reportsAnalyticsAssets">
        <style id="reports-analytics-styles">
            /* Paste CSS from Reports & Analytics.txt here, scoped */
            #featureSectionsContainer.reports-analytics-feature { /* Basic wrapper */ }
            #featureSectionsContainer.reports-analytics-feature body { background-color: transparent; font-family: inherit; }

            #featureSectionsContainer.reports-analytics-feature #reports-analytics-section .card { border: none; border-radius: 0.5rem; margin-bottom: 1.5rem; }
            #featureSectionsContainer.reports-analytics-feature #reports-analytics-section .card-header { background-color: var(--white); border-bottom: 1px solid var(--light-gray); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature #reports-analytics-section .card-header { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--app-header-bg); color: white; padding: 10px 20px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 0; }
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title i { margin-right: 10px; }
            #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn { font-size: 0.8rem; padding: 0.375rem 0.75rem; }
            #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn i { margin-right: 5px; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section { background-color: var(--white); padding: 0.75rem 1.25rem; border-radius: 0.375rem; border: 1px solid var(--light-gray); margin-bottom: 1.5rem; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group .btn { font-size: 0.85rem; padding: 0.375rem 0.85rem; }
             /* Ensure button group outline buttons use dashboard style */
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-check + .btn-outline-secondary { background-color: transparent; border-color: var(--secondary); color: var(--secondary); }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-check:checked + .btn-outline-secondary { background-color: var(--secondary); color: white; }
              body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-check + .btn-outline-secondary { border-color: var(--gray); color: var(--gray); }
              body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-check:checked + .btn-outline-secondary { background-color: var(--secondary); color: var(--white); border-color: var(--success); }

            #featureSectionsContainer.reports-analytics-feature .ra-filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; font-weight: 500; }
            #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { font-size: 0.85rem; padding: 0.375rem 0.75rem; max-width: 150px; }
            #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); height: 350px; display: flex; flex-direction: column; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.reports-analytics-feature .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
            #featureSectionsContainer.reports-analytics-feature .chart-title { font-weight: 600; color: var(--gray); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
            #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--white); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--light); border-color: var(--light-gray);}
            #featureSectionsContainer.reports-analytics-feature .ra-table-container h5 { color: var(--primary); margin-bottom: 15px; font-weight: 600; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container h5 { color: #a5b4fc; }
            #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--app-light) !important; color: var(--app-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--light-gray); }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--primary-light) !important; color: var(--gray); border-bottom-color: var(--light-gray);}
            #featureSectionsContainer.reports-analytics-feature .ra-table tbody td { vertical-align: middle; font-size: 0.875rem; padding-top: 0.6rem; padding-bottom: 0.6rem; color: var(--text-color); }
            #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { font-weight: 500; color: var(--dark); padding-left: 5px; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { color: var(--text-color);}
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress { height: 14px; background-color: var(--light-gray); min-width: 100px; border-radius: 7px; overflow: hidden; position: relative; }
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .progress { background-color: var(--light-gray); }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar { font-size: 0.8rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; color: white; } /* Adjusted size */
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-high { background-color: var(--chart-green) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-medium { background-color: var(--chart-orange) !important; color: var(--dark) !important; } /* Darker text on orange */
            #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-low { background-color: var(--chart-red) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .metric-value { font-weight: 500; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-success { color: var(--chart-green) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-danger { color: var(--chart-red) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-info { color: var(--chart-blue) !important; }
            #featureSectionsContainer.reports-analytics-feature .ra-table .text-warning { color: var(--chart-orange) !important; }
             /* Dark theme text color overrides */
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .text-success { color: var(--chart-green) !important; } /* Already bright */
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .text-danger { color: var(--chart-red) !important; } /* Already bright */
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .text-info { color: var(--chart-blue) !important; } /* Already bright */
             body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .text-warning { color: var(--chart-orange) !important; } /* Already bright */
            @media (max-width: 768px) {
                 #featureSectionsContainer.reports-analytics-feature .chart-container { height: 300px; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section .d-flex { flex-direction: column; align-items: stretch !important; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group,
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { width: 100%; margin-bottom: 10px; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { max-width: none; }
                 #featureSectionsContainer.reports-analytics-feature .ra-filters-section button[type="submit"] { width: 100%; }
                 #featureSectionsContainer.reports-analytics-feature #reports-analytics-section .card-header { flex-direction: column; align-items: flex-start; }
                 #featureSectionsContainer.reports-analytics-feature .ra-export-buttons { margin-top: 10px; width: 100%; text-align: right; }
            }

        </style>
        <div class="reports-analytics-feature-wrapper"> <!-- Wrapper for scoping -->
             <div id="reports-analytics-section">

                <!-- Section Header with Export Buttons -->
                <div class="card-header bg-white border-0 mb-3">
                    <h2 class="ra-fancy-title"><i class="fas fa-chart-pie me-2"></i> Reports & Analytics</h2>
                    <div class="ra-export-buttons">
                         <button id="exportPdfBtn" class="btn btn-sm btn-outline-danger"> <!-- Use specific outlines -->
                             <i class="fas fa-file-pdf"></i> Export PDF
                         </button>
                         <button id="exportExcelBtn" class="btn btn-sm btn-outline-success">
                             <i class="fas fa-file-excel"></i> Export Excel
                         </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="ra-filters-section">
                    <form id="reports-filter-form">
                         <div class="row gy-2 align-items-end">
                            <div class="col-md-auto">
                                <label class="form-label">Quick Period:</label>
                                <div class="btn-group w-100" role="group" aria-label="Report Period" id="periodBtnGroup">
                                    <input type="radio" class="btn-check" name="period" id="period-day" autocomplete="off" value="day">
                                    <label class="btn btn-sm btn-outline-secondary" for="period-day">Day</label>
                                    <input type="radio" class="btn-check" name="period" id="period-week" autocomplete="off" value="week" checked>
                                    <label class="btn btn-sm btn-outline-secondary" for="period-week">Week</label>
                                    <input type="radio" class="btn-check" name="period" id="period-month" autocomplete="off" value="month">
                                    <label class="btn btn-sm btn-outline-secondary" for="period-month">Month</label>
                                </div>
                            </div>
                             <div class="col-md">
                                <label for="report-start-date" class="form-label">Start Date:</label>
                                <input type="date" class="form-control form-control-sm" id="report-start-date" name="startDate" required>
                            </div>
                             <div class="col-md">
                                <label for="report-end-date" class="form-label">End Date:</label>
                                <input type="date" class="form-control form-control-sm" id="report-end-date" name="endDate" required>
                            </div>
                             <div class="col-md-auto">
                                <button type="submit" class="btn btn-sm btn-primary w-100">
                                    <i class="fas fa-sync-alt me-1"></i> Update Report
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Charts Section -->
                <div class="row g-4">
                    <div class="col-lg-4 col-md-6">
                         <div class="chart-container">
                             <p class="chart-title">Task Completion Rate (%)</p>
                             <canvas id="taskCompletionChart"></canvas>
                         </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                         <div class="chart-container">
                             <p class="chart-title">Overdue Tasks Count</p>
                             <canvas id="overdueTasksChart"></canvas>
                         </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="chart-container">
                             <p class="chart-title">Files Uploaded by Employee</p>
                             <canvas id="filesUploadedChart"></canvas>
                         </div>
                    </div>
                    <div class="col-lg-12">
                         <div class="chart-container" style="height: 400px;">
                             <p class="chart-title">Employee Performance Comparison</p>
                             <canvas id="performanceComparisonChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Employee Summary Table Section -->
                <div class="mt-4 ra-table-container">
                     <h5><i class="fas fa-users me-2"></i> Employee Performance Summary</h5>
                     <div class="table-responsive">
                        <table class="table table-sm table-hover table-striped align-middle ra-table" id="employeeSummaryTable">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th class="text-center">Tasks Completed (%)</th>
                                    <th class="text-center">Overdue Tasks</th>
                                    <th class="text-center">Files Uploaded</th>
                                    <th class="text-center">Activity Score</th>
                                </tr>
                            </thead>
                            <tbody id="employeeSummaryTableBody">
                                 <tr><td colspan="5" class="text-center p-4 text-muted"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div><span class="ms-2">Loading employee data...</span></td></tr>
                            </tbody>
                        </table>
                     </div>
                </div>

            </div> <!-- End #reports-analytics-section -->
        </div> <!-- End Wrapper -->
        <script>
             // Make sure this function is globally available or called correctly
            function initializeReportsAnalyticsFeature(container) {
                console.log("Initializing Reports & Analytics...");
                 // Check dependencies
                 if (typeof Chart === 'undefined') {
                     console.error('Chart.js not loaded! Reports charts cannot be displayed.');
                     container.querySelectorAll('.chart-container canvas').forEach(canvas => {
container.querySelectorAll('.chart-container canvas').forEach(canvas => {
                           canvas.parentElement.insertAdjacentHTML('beforeend', '<p class="text-danger text-center small p-3">Chart library not loaded.</p>');
                     });
                     // Do not return immediately, allow table/export functionality
                 }
                 if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') { console.warn('jsPDF not loaded, PDF export disabled.'); }
                 else if (typeof jspdf.jsPDF.autoTable !== 'function') { console.warn('jsPDF AutoTable plugin not loaded, PDF export table formatting might fail.'); }

                // --- Sample Data ---
                const employeePerformanceData = [ { id: 1, name: "Mohamed Elmenisy", tasksCompleted: 85, tasksOverdue: 3, filesUploaded: 15, activityScore: 9.2, performanceMetrics: [8.5, 9, 7, 9.2, 8.4] }, { id: 3, name: "Yousef Ahmed", tasksCompleted: 70, tasksOverdue: 8, filesUploaded: 8, activityScore: 7.5, performanceMetrics: [7, 6, 6, 7.5, 6.6] }, { id: 4, name: "Esraa Lashin", tasksCompleted: 45, tasksOverdue: 12, filesUploaded: 5, activityScore: 6.1, performanceMetrics: [4.5, 5, 5, 6.1, 5.1] }, { id: 5, name: "Bassant Badr", tasksCompleted: 91, tasksOverdue: 2, filesUploaded: 18, activityScore: 9.5, performanceMetrics: [9.1, 9.5, 8, 9.5, 9.0] }, ];
                // Expose globally for theme changes
                window.currentFilteredReportData = [...employeePerformanceData];

                // --- DOM Elements (Scoped) ---
                const filterForm = container.querySelector('#reports-filter-form');
                const startDateInput = container.querySelector('#report-start-date');
                const endDateInput = container.querySelector('#report-end-date');
                const periodBtnGroup = container.querySelector('#periodBtnGroup');
                const tableBody = container.querySelector('#employeeSummaryTableBody');
                const exportPdfBtn = container.querySelector('#exportPdfBtn');
                const exportExcelBtn = container.querySelector('#exportExcelBtn');
                const taskCompletionCanvas = container.querySelector('#taskCompletionChart');
                const overdueTasksCanvas = container.querySelector('#overdueTasksChart');
                const filesUploadedCanvas = container.querySelector('#filesUploadedChart');
                const performanceComparisonCanvas = container.querySelector('#performanceComparisonChart');

                // --- Chart Instances ---
                let taskCompletionChartInstance = null; let overdueTasksChartInstance = null; let filesUploadedChartInstance = null; let performanceComparisonChartInstance = null;

                // --- Utility Functions ---
                const formatDateInput = (date) => { const d = new Date(date); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const year = d.getFullYear(); return `${year}-${month}-${day}`; };
                const formatReportDate = (dateString) => { if (!dateString) return 'N/A'; const parts = dateString.split('-'); if (parts.length === 3) { return `${parts[1]}/${parts[2]}/${parts[0]}`; } return dateString; };
                const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                const rgbaColor = (c, alpha) => { if (!c) return 'rgba(0,0,0,0.1)'; if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; };

                // --- Chart Rendering Functions (Using Updated Colors) ---
                // Expose globally for theme changes
                window.renderTaskCompletionChart = function(data) { if (typeof Chart === 'undefined' || !taskCompletionCanvas) return; const ctx = taskCompletionCanvas.getContext('2d'); if (!ctx) return; const avgCompletion = data.length > 0 ? Math.round(data.reduce((sum, emp) => sum + emp.tasksCompleted, 0) / data.length) : 0; const chartData = { labels: ['Completed', 'Remaining'], datasets: [{ data: [avgCompletion, 100 - avgCompletion], backgroundColor: [ getCssVar('--chart-green'), getCssVar('--light-gray')], borderColor: [getCssVar('--white')], borderWidth: 2 }] }; if (taskCompletionChartInstance) taskCompletionChartInstance.destroy(); taskCompletionChartInstance = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` } } } } }); }
                window.renderOverdueTasksChart = function(data) { if (typeof Chart === 'undefined' || !overdueTasksCanvas) return; const ctx = overdueTasksCanvas.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const overdueData = data.map(emp => emp.tasksOverdue); if (overdueTasksChartInstance) overdueTasksChartInstance.destroy(); overdueTasksChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Overdue Tasks', data: overdueData, backgroundColor: getCssVar('--chart-red'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 2, color: getCssVar('--text-color') }, grid:{ color: getCssVar('--light-gray')}}, x: { ticks:{ color: getCssVar('--text-color') }, grid:{ color: getCssVar('--light-gray')}} }, plugins: { legend: { display: false } } } }); }
                window.renderFilesUploadedChart = function(data) { if (typeof Chart === 'undefined' || !filesUploadedCanvas) return; const ctx = filesUploadedCanvas.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const filesData = data.map(emp => emp.filesUploaded); if (filesUploadedChartInstance) filesUploadedChartInstance.destroy(); filesUploadedChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Files Uploaded', data: filesData, backgroundColor: getCssVar('--chart-blue'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks:{ color: getCssVar('--text-color') }, grid:{ color: getCssVar('--light-gray')} }, y: { ticks:{ color: getCssVar('--text-color') }, grid:{ color: getCssVar('--light-gray')}} }, plugins: { legend: { display: false } } } }); }
                window.renderPerformanceComparisonChart = function(data) { if (typeof Chart === 'undefined' || !performanceComparisonCanvas) return; const ctx = performanceComparisonCanvas.getContext('2d'); if (!ctx) return; const labels = ['Completion', 'Timeliness', 'Files Mgmt', 'Activity', 'Overall Score']; const datasets = data.map((emp, index) => { const metricsData = emp.performanceMetrics || [ emp.tasksCompleted / 10, 10 - (emp.tasksOverdue / 2), emp.filesUploaded / 2, emp.activityScore, ((emp.tasksCompleted / 10) + (10 - (emp.tasksOverdue / 2)) + (emp.filesUploaded / 2) + emp.activityScore) / 4]; const clampedData = metricsData.map(score => Math.max(0, Math.min(10, score || 0))); const colors = [getCssVar('--chart-blue'), getCssVar('--chart-green'), getCssVar('--chart-purple'), getCssVar('--chart-orange'), getCssVar('--chart-cyan'), getCssVar('--chart-red')]; const color = colors[index % colors.length]; const bgFill = rgbaColor(color, getCssVar('--chart-radar-fill-opacity')); return { label: emp.name, data: clampedData, fill: true, backgroundColor: bgFill, borderColor: color, pointBackgroundColor: color, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: color } }); if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy(); performanceComparisonChartInstance = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, elements: { line: { borderWidth: 2 } }, scales: { r: { angleLines: { display: true, color: getCssVar('--light-gray') }, grid: { color: getCssVar('--light-gray')}, suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 10 }, color: getCssVar('--text-color') }, ticks: { backdropColor: 'rgba(0,0,0,0)', color: getCssVar('--text-color'), stepSize: 2 } } }, plugins: { legend: { position: 'top', labels: { color: getCssVar('--text-color') } } } } }); } // Added text/grid colors

                // --- UPDATED Table Rendering ---
                function renderEmployeeSummaryTable(data) {
                    if (!tableBody) return; tableBody.innerHTML = '';
                    if (!data || data.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted fst-italic">No employee data found.</td></tr>`; return; }
                    data.forEach((emp) => {
                        const row = document.createElement('tr');
                        let scoreBadgeClass = 'text-bg-secondary'; let scoreText = 'Average';
                        if (emp.activityScore >= 9) { scoreBadgeClass = 'text-bg-success'; scoreText = 'Excellent'; }
                        else if (emp.activityScore >= 7.5) { scoreBadgeClass = 'text-bg-warning'; scoreText = 'Good'; }
                        else if (emp.activityScore < 6.5) { scoreBadgeClass = 'text-bg-danger'; scoreText = 'Needs Improv.'; }
                        const completion = emp.tasksCompleted; let progressBgClass = ''; let progressTextColor = '#fff';
                        if (completion >= 80) { progressBgClass = 'bg-progress-high'; } else if (completion >= 50) { progressBgClass = 'bg-progress-medium'; progressTextColor = '#212529'; } else { progressBgClass = 'bg-progress-low'; }
                        row.innerHTML = `
                            <td> <div class="employee-name">${emp.name}</div> </td>
                            <td class="text-center"> <div class="progress" role="progressbar" aria-label="Completion rate for ${emp.name}" aria-valuenow="${completion}" aria-valuemin="0" aria-valuemax="100"> <div class="progress-bar ${progressBgClass}" style="width: ${completion}%; color: ${progressTextColor};"> ${completion}% </div> </div> </td>
                            <td class="text-center"><span class="metric-value ${emp.tasksOverdue === 0 ? 'text-success' : emp.tasksOverdue <= 5 ? 'text-warning' : 'text-danger'}">${emp.tasksOverdue}</span></td>
                            <td class="text-center"><span class="metric-value text-info">${emp.filesUploaded}</span></td>
                            <td class="text-center"><span class="badge ${scoreBadgeClass}">${scoreText}</span></td> `;
                        tableBody.appendChild(row);
                    });
                }

                // --- Filtering Logic (Simulation) ---
                function applyFilters() { const startDate = startDateInput.value; const endDate = endDateInput.value; console.log("Applying filters for period:", startDate, "to", endDate); window.currentFilteredReportData = [...employeePerformanceData]; window.renderTaskCompletionChart(window.currentFilteredReportData); window.renderOverdueTasksChart(window.currentFilteredReportData); window.renderFilesUploadedChart(window.currentFilteredReportData); window.renderPerformanceComparisonChart(window.currentFilteredReportData); renderEmployeeSummaryTable(window.currentFilteredReportData); }
                function setPeriodDates(period) { const today = new Date(); let startDate, endDate = new Date(); switch (period) { case 'day': startDate = new Date(today); break; case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break; case 'week': default: const firstDay = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1); startDate = new Date(new Date(today).setDate(firstDay)); break; } startDateInput.value = formatDateInput(startDate); endDateInput.value = formatDateInput(endDate); applyFilters(); }

                // --- Export Functions ---
                function generateCsv(tableElement, filename = 'report.csv') { let csv = []; const rows = tableElement.querySelectorAll("thead tr, tbody tr"); for (let i = 0; i < rows.length; i++) { const row = [], cols = rows[i].querySelectorAll("td, th"); for (let j = 0; j < cols.length; j++) { let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/(\s\s)/gm, " ").trim(); if (cols[j].querySelector('.progress')) { const progressBar = cols[j].querySelector('.progress-bar'); data = progressBar ? progressBar.innerText.trim() : '0%'; } data = data.replace(/"/g, '""'); if (data.includes(',')) data = `"${data}"`; row.push(data); } csv.push(row.join(",")); } const csvFile = new Blob([csv.join("\n")], { type: "text/csv" }); const downloadLink = document.createElement("a"); downloadLink.download = filename; downloadLink.href = window.URL.createObjectURL(csvFile); downloadLink.style.display = "none"; document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink); }
                function generatePdf(tableElement, filename = 'report.pdf') {
                     if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') { window.showToast?.('jsPDF library not loaded.', 'error'); return; }
                     const { jsPDF } = jspdf; const doc = new jsPDF({ orientation: 'landscape' });
                     const startDateValue = startDateInput.value; const endDateValue = endDateInput.value; const startDateFormatted = formatReportDate(startDateValue); const endDateFormatted = formatReportDate(endDateValue); const dateRangeText = `Period: ${startDateFormatted} - ${endDateFormatted}`; const reportTitle = "Employee Performance Report";
                     doc.setFontSize(16); doc.text(reportTitle, 14, 16); doc.setFontSize(10); doc.setTextColor(100); doc.text(dateRangeText, 14, 22); doc.setTextColor(0);
                     if (typeof doc.autoTable !== 'function') { window.showToast?.('jsPDF AutoTable plugin not loaded.', 'error'); return; }
                     const head = [['Employee', 'Completion (%)', 'Overdue', 'Files', 'Score']]; const body = []; const rows = tableElement.querySelectorAll("tbody tr");
                     rows.forEach(row => { const rowData = []; const cells = row.querySelectorAll("td"); rowData.push(cells[0] ? cells[0].innerText.trim() : ''); rowData.push(cells[1] ? cells[1].querySelector('.progress-bar')?.innerText.trim() || '0%' : '0%'); rowData.push(cells[2] ? cells[2].innerText.trim() : '0'); rowData.push(cells[3] ? cells[3].innerText.trim() : '0'); rowData.push(cells[4] ? cells[4].querySelector('.badge')?.innerText.trim() || '' : ''); body.push(rowData); });
                     const tableStartY = 28; doc.autoTable({ head: head, body: body, startY: tableStartY, theme: 'grid', styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' }, columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 'auto', halign: 'center'}, 2: { cellWidth: 'auto', halign: 'center'}, 3: { cellWidth: 'auto', halign: 'center'}, 4: { cellWidth: 'auto', halign: 'center'} } });
                     doc.save(filename);
                 }

                // --- Initialization and Event Listeners ---
                const boundApplyFilters = applyFilters; // To remove listener later
                const boundPeriodChange = (event) => { if (event.target.name === 'period') { setPeriodDates(event.target.value); } };
                const boundExportPdf = () => { const table = container.querySelector('#employeeSummaryTable'); if (table) { generatePdf(table, `Employee_Summary_${formatDateInput(new Date())}.pdf`); } else { window.showToast?.('Summary table not found.', 'error'); } };
                const boundExportCsv = () => { const table = container.querySelector('#employeeSummaryTable'); if (table) { generateCsv(table, `Employee_Summary_${formatDateInput(new Date())}.csv`); } else { window.showToast?.('Summary table not found.', 'error'); } };

                if (filterForm) { setPeriodDates('week'); filterForm.addEventListener('submit', (event) => { event.preventDefault(); applyFilters(); }); }
                if (periodBtnGroup) periodBtnGroup.addEventListener('change', boundPeriodChange);
                if (exportPdfBtn) exportPdfBtn.addEventListener('click', boundExportPdf);
                if (exportExcelBtn) exportExcelBtn.addEventListener('click', boundExportCsv);
                applyFilters(); // Initial Render

                // --- Cleanup Function ---
                const cleanup = () => {
                    console.log("Cleaning up Reports & Analytics...");
                    filterForm?.removeEventListener('submit', applyFilters); // Assuming 'applyFilters' is the handler
                    periodBtnGroup?.removeEventListener('change', boundPeriodChange);
                    exportPdfBtn?.removeEventListener('click', boundExportPdf);
                    exportExcelBtn?.removeEventListener('click', boundExportCsv);
                    taskCompletionChartInstance?.destroy();
                    overdueTasksChartInstance?.destroy();
                    filesUploadedChartInstance?.destroy();
                    performanceComparisonChartInstance?.destroy();
                    taskCompletionChartInstance = null; overdueTasksChartInstance = null; filesUploadedChartInstance = null; performanceComparisonChartInstance = null;
                    // Remove global functions/data specific to this feature
                     delete window.renderTaskCompletionChart;
                     delete window.renderOverdueTasksChart;
                     delete window.renderFilesUploadedChart;
                     delete window.renderPerformanceComparisonChart;
                     delete window.currentFilteredReportData;
                    console.log("Reports & Analytics cleanup complete.");
                };

                return { cleanup };
            }
            // Expose initializer globally
            window.initializeReportsAnalyticsFeature = initializeReportsAnalyticsFeature;
        </script>
    </template>
    <!-- ==================== END: Reports & Analytics Template ==================== -->

    <!-- ==================== START: Data Management Template (Placeholder) ==================== -->
    <template id="dataManagementAssets">
         <style id="data-management-styles">
             #featureSectionsContainer.data-management-feature .data-management-feature-wrapper { /* Match dashboard padding */ }
             #featureSectionsContainer.data-management-feature .placeholder-content {
                padding: 3rem;
                text-align: center;
                border: 2px dashed var(--light-gray);
                border-radius: 8px;
                background-color: var(--white);
                color: var(--gray);
             }
             body.dark-theme #featureSectionsContainer.data-management-feature .placeholder-content {
                background-color: var(--light);
                border-color: var(--light-gray);
             }
             #featureSectionsContainer.data-management-feature .placeholder-content h3 {
                 color: var(--text-color);
                 margin-bottom: 1rem;
             }
         </style>
        <div class="data-management-feature-wrapper">
             <div class="section-main-header">
                 <h2 class="section-main-title">Data Management</h2>
             </div>
             <div class="placeholder-content">
                <h3><i class="fas fa-cogs me-2"></i>Data Management Feature</h3>
                <p>This section is under construction. Functionality for managing application data (e.g., backups, imports, exports) will be available here.</p>
             </div>
        </div>
        <script>
            // Make sure this function is globally available or called correctly
            function initializeDataManagementFeature(container) {
                console.log("Initializing Data Management Placeholder...");
                // No complex JS needed for placeholder
                const cleanup = () => {
                    console.log("Cleaning up Data Management Placeholder...");
                };
                return { cleanup };
            }
             // Expose initializer globally
             window.initializeDataManagementFeature = initializeDataManagementFeature;
        </script>
    </template>
    <!-- ==================== END: Data Management Template ==================== -->

    <!-- Add Templates for other features like team-calendar, deadline-tracking, innovation-hub -->
    <template id="teamCalendarAssets">
        <style id="team-calendar-styles"> /* Placeholder styles */ #featureSectionsContainer.team-calendar-feature .placeholder-content { padding: 2rem; text-align: center; color: var(--gray); } </style>
        <div class="team-calendar-feature-wrapper">
            <div class="section-main-header"><h2 class="section-main-title">Team Calendar</h2></div>
            <div class="placeholder-content"><h3><i class="fas fa-calendar-alt me-2"></i>Team Calendar</h3><p>Feature coming soon.</p></div>
        </div>
        <script> function initializeTeamCalendarFeature(c){ console.log("Init Team Calendar"); return { cleanup: () => console.log("Clean Team Calendar") }; } window.initializeTeamCalendarFeature=initializeTeamCalendarFeature; </script>
    </template>
     <template id="deadlineTrackingAssets">
        <style id="deadline-tracking-styles"> /* Placeholder styles */ #featureSectionsContainer.deadline-tracking-feature .placeholder-content { padding: 2rem; text-align: center; color: var(--gray); } </style>
        <div class="deadline-tracking-feature-wrapper">
             <div class="section-main-header"><h2 class="section-main-title">Deadline Tracking</h2></div>
             <div class="placeholder-content"><h3><i class="fas fa-clock me-2"></i>Deadline Tracking</h3><p>Feature coming soon.</p></div>
        </div>
        <script> function initializeDeadlineTrackingFeature(c){ console.log("Init Deadline Tracking"); return { cleanup: () => console.log("Clean Deadline Tracking") }; } window.initializeDeadlineTrackingFeature=initializeDeadlineTrackingFeature; </script>
    </template>
     <template id="innovationHubAssets">
        <style id="innovation-hub-styles"> /* Placeholder styles */ #featureSectionsContainer.innovation-hub-feature .placeholder-content { padding: 2rem; text-align: center; color: var(--gray); } </style>
        <div class="innovation-hub-feature-wrapper">
             <div class="section-main-header"><h2 class="section-main-title">Innovation Hub</h2></div>
             <div class="placeholder-content"><h3><i class="fas fa-lightbulb me-2"></i>Innovation Hub</h3><p>Feature coming soon.</p></div>
        </div>
        <script> function initializeInnovationHubFeature(c){ console.log("Init Innovation Hub"); return { cleanup: () => console.log("Clean Innovation Hub") }; } window.initializeInnovationHubFeature=initializeInnovationHubFeature; </script>
    </template>
     <!-- Template for Team Members View -->
     <template id="teamMembersAssets">
         <style id="team-members-view-styles">
            /* Paste specific CSS for team-members-view feature */
             /* Using styles from the #featureSectionsContainer.team-members-view-feature block */
         </style>
          <div class="team-members-view-feature-wrapper">
            <!-- Paste HTML Structure from getTeamMembersHTML() here -->
            <div class="team-members-section">
                 <div class="team-members-section-header">
                    <h2>Team Members</h2>
                    <button class="btn btn-primary add-team-member-btn"><i class="fas fa-user-plus"></i> Add Member</button>
                 </div>
                 <div class="team-content-area">
                     <div class="team-filter">
                         <input type="text" id="teamSearchInputFeature" placeholder="Search team by name, email, or role..." aria-label="Search team members" class="form-control">
                     </div>
                     <div class="team-members-list team-list-display" id="teamListContainerFeature">
                         <p style="color: var(--gray);">Loading team members...</p>
                     </div>
                 </div>
             </div>
          </div>
         <script>
             // JS initialization function for team-members-view
             // This script content is similar/identical to initializeTeamMembersFeature defined earlier
             // Ensure it's defined correctly or reused. For simplicity, reusing the definition:
             // function initializeTeamMembersFeature(container) { ... }
             // window.initializeTeamMembersFeature = initializeTeamMembersFeature; // Already done
         </script>
     </template>

     <!-- Template for Projects View -->
     <template id="projectsAssets">
         <style id="projects-view-styles">
             /* Paste specific CSS for projects feature */
              /* Using styles from the #featureSectionsContainer.projects-feature block */
         </style>
         <div class="projects-feature-wrapper">
              <!-- Paste HTML Structure from getProjectsHTML() here -->
              <section id="projects-section">
                 <div class="projects-header">
                     <div class="projects-title-wrapper"><h2>Projects</h2></div>
                     <div class="project-controls">
                         <input type="search" placeholder="Search Projects..." class="project-search-input form-control" id="projectSearchInputFeature">
                         <select class="project-filter-select form-control" id="projectFilterSelectFeature">
                             <option value="all">All Statuses</option>
                             <option value="active">Active</option>
                             <option value="in-progress">In Progress</option>
                             <option value="completed">Completed</option>
                             <option value="pending">Pending</option>
                         </select>
                         <button class="btn add-project-btn" id="addProjectBtnFeature"> <i class="fas fa-plus-circle"></i> Add Project </button>
                     </div>
                 </div>
                 <div class="projects-list" id="projectsListContainerFeature">
                     <p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">Loading projects...</p>
                 </div>
             </section>
         </div>
         <script>
             // JS initialization function for projects feature
             // This script content is similar/identical to initializeProjectsFeature defined earlier
             // Ensure it's defined correctly or reused. For simplicity, reusing the definition:
             // function initializeProjectsFeature(container) { ... }
             // window.initializeProjectsFeature = initializeProjectsFeature; // Already done
         </script>
     </template>

      <!-- Template for Employee Scheduling View -->
     <template id="employeeSchedulingAssets">
         <style id="employee-scheduling-styles">
             /* Paste specific CSS for employee-scheduling feature */
              /* Using styles from the #featureSectionsContainer.employee-scheduling-feature block */
         </style>
         <div class="employee-scheduling-feature-wrapper">
             <!-- Paste HTML Structure from getEmployeeScheduleHTML() here -->
             <div class="schedule-page-header section-main-header">
                 <h2 class="schedule-page-title section-main-title">Employee Scheduling</h2>
                 <div class="admin-actions"> <!-- Group admin buttons -->
                    <button class="btn btn-primary" id="saveScheduleBtn">
                        <i class="fas fa-save"></i> Save Schedule
                    </button>
                     <button class="btn btn-success" id="sendRemindersBtn">
                         <i class="fas fa-envelope"></i> Send Reminders
                     </button>
                 </div>
             </div>
             <div class="schedule-controls">
                 <div class="week-nav"> <!-- Group nav buttons -->
                     <button class="btn btn-outline" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev</button>
                     <span id="weekDisplay" style="margin: 0 1rem; font-weight: 500;">Loading...</span>
                     <button class="btn btn-outline" id="nextWeekBtn">Next <i class="fas fa-chevron-right"></i></button>
                 </div>
             </div>
             <div class="schedule-container">
                 <table class="schedule-table">
                     <thead> <tr> <th>Employee</th> <!-- Days headers populated by JS --> </tr> </thead>
                     <tbody id="scheduleTableBody"> <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td></tr> </tbody>
                 </table>
             </div>
             <!-- Modal defined outside -->
         </div>
         <script>
             // JS initialization function for employee-scheduling feature
             // This script content is similar/identical to initializeEmployeeScheduleLogic defined earlier
             // Ensure it's defined correctly or reused. For simplicity, reusing the definition:
             // function initializeEmployeeScheduleLogic(container) { ... }
             // window.initializeEmployeeScheduleLogic = initializeEmployeeScheduleLogic; // Already done
         </script>
     </template>


    <!-- ==================== FEATURE TEMPLATES END ==================== -->


    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children: dashboard, profile, settings, feature container
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = document.getElementById('featureTitle');
            const featureDescEl = document.getElementById('featureDescription');
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModalEl = document.getElementById('notificationsModal'); // Get modal element
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModalEl = document.getElementById('confirmModal'); // Get modal element
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModalEl = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModalEl = document.getElementById('projectModal'); // NEW: Project Modal Element
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button


            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // Bootstrap Modal Instances
            let confirmModalInstance = null;
            let memberModalInstance = null;
            let projectModalInstance = null;
            let notificationsModalInstance = null;


            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let currentFeatureCleanup = null; // Stores the cleanup function for the loaded feature
            let MOCK_PROJECTS_DATA = []; // To store projects data


            // --- Mock Data ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [ // Renamed to avoid conflict
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            const MOCK_TASKS = [
                { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
            ];

            // --- Initialization ---
            function initDashboard() {
                // Simulate loading current user (using the first mock user)
                currentUser = { ...MOCK_USERS[0] }; // Use a copy
                console.log("Initializing dashboard for:", currentUser.name);

                // Initialize Bootstrap Modals
                 if (confirmModalEl) confirmModalInstance = new bootstrap.Modal(confirmModalEl);
                 if (memberModalEl) memberModalInstance = new bootstrap.Modal(memberModalEl);
                 if (projectModalEl) projectModalInstance = new bootstrap.Modal(projectModalEl);
                 if (notificationsModalEl) notificationsModalInstance = new bootstrap.Modal(notificationsModalEl);
                 // Feature-specific modals (like File Sharing) will be initialized within their respective `initialize...` functions


                applyStoredPreferences(); // Apply theme, contrast etc. *before* other UI updates
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Navigate based on URL hash first
                startDynamicUpdates(); // Start intervals for data refresh
                setupResponsiveSidebar();
            }

            // --- UI Updates ---
            function updateUserUI() {
                if (!currentUser) return;

                // Top Nav User Menu
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.initials;
                 if (currentUser.avatar) {
                    document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                    document.getElementById('userAvatar').textContent = ''; // Clear initials if avatar exists
                } else {
                    document.getElementById('userAvatar').style.backgroundImage = 'none';
                    document.getElementById('userAvatar').textContent = currentUser.initials;
                }

                // Welcome Section
                document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userInfoName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) {
                    document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                     document.getElementById('profileAvatar').textContent = '';
                } else {
                    document.getElementById('profileAvatar').style.backgroundImage = 'none';
                    document.getElementById('profileAvatar').textContent = currentUser.initials;
                }

                // User Role Title
                const roleTitle = document.getElementById('userInfoRoleTitle');
                roleTitle.textContent = formatRole(currentUser.role);
                roleTitle.className = `user-info-title role-${currentUser.role}`; // Apply role class

                // Profile Page Elements
                updateProfileForm();
                profileAvatarLarge.textContent = currentUser.initials;
                if (currentUser.avatar) {
                    profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                     profileAvatarLarge.textContent = '';
                } else {
                    profileAvatarLarge.style.backgroundImage = 'none';
                    profileAvatarLarge.textContent = currentUser.initials;
                }
                // Update Account panel email display
                if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;


                // Admin specific elements
                const teamSettingsTab = document.getElementById('teamSettingsTab');
                const dangerZoneTab = document.getElementById('dangerZoneTab');
                 if (currentUser.role === 'admin') {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; // Use flex for tabs
                    if (dangerZoneTab) dangerZoneTab.style.display = 'flex';
                } else {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'none';
                     if (dangerZoneTab) dangerZoneTab.style.display = 'none';
                     // Hide team panel if not admin and trying to access it directly
                     if (currentFeature === 'settings' && currentSettingsTab === 'team') {
                         activateSettingsTab('preferences'); // Default to preferences
                     }
                     if (currentFeature === 'settings' && currentSettingsTab === 'danger') {
                         activateSettingsTab('preferences');
                     }
                }

                // Update 2FA UI based on current user status
                update2FA_UI();
                 if (userPhoneNumberForSms) { // Check if element exists
                    userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
                }
            }

            function updateProfileForm() {
                if (!currentUser) return;
                const nameParts = currentUser.name.split(' ');
                firstNameInput.value = nameParts[0] || '';
                lastNameInput.value = nameParts.slice(1).join(' ') || '';
                fullNameDisplay.value = currentUser.name; // Update readonly full name
                jobTitleInput.value = currentUser.title || '';
                emailDisplay.value = currentUser.email || '';
                phoneInput.value = currentUser.phone || '';
                departmentInput.value = currentUser.department || '';
            }

            function formatRole(role) {
                if (!role) return 'Member';
                return role.charAt(0).toUpperCase() + role.slice(1); // Capitalize first letter
            }

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() {
                // Theme
                const storedTheme = localStorage.getItem('theme') || 'system'; // Default to system
                setTheme(storedTheme);

                // Contrast
                const storedContrast = localStorage.getItem('highContrast') === 'true';
                setContrast(storedContrast);
                if (highContrastToggle) highContrastToggle.checked = storedContrast;

                // Language
                const storedLang = localStorage.getItem('language') || 'en';
                if (languageSelect) languageSelect.value = storedLang;
                applyLanguage(storedLang);

                 // Region/Timezone (Just set the dropdown)
                 const storedRegion = localStorage.getItem('region') || 'utc';
                 if (regionSelect) regionSelect.value = storedRegion;

                // Date/Time Format
                const storedTimeFormat = localStorage.getItem('timeFormat') || '12h';
                const storedDateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                if (timeFormatSelect) timeFormatSelect.value = storedTimeFormat;
                if (dateFormatSelect) dateFormatSelect.value = storedDateFormat;
                applyDateTimeFormat(storedTimeFormat, storedDateFormat);

                 // Toast Notifications
                const storedToastPref = localStorage.getItem('showToasts');
                // Default to true if not set
                showToasts = storedToastPref === null ? true : (storedToastPref === 'true');
                if (toastToggle) toastToggle.checked = showToasts;

                // Sound Notifications
                const storedSoundPref = localStorage.getItem('playSounds');
                playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true');
                if (soundToggle) soundToggle.checked = playSounds;

            }

            function setTheme(theme) {
                 console.log("Setting theme:", theme);
                 document.body.classList.remove('light-theme', 'dark-theme'); // Remove existing theme classes

                 if (theme === 'system') {
                    // Use matchMedia to detect system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.classList.add(prefersDark ? 'dark-theme' : 'light-theme');
                    console.log("System prefers dark:", prefersDark);
                 } else {
                     document.body.classList.add(`${theme}-theme`);
                 }

                 // Update selection state in UI
                 themeOptions.forEach(option => {
                     option.classList.toggle('selected', option.dataset.theme === theme);
                 });

                 localStorage.setItem('theme', theme); // Save preference
                 // Re-render charts if necessary for the new theme
                 if(window.currentFeature === 'project-tracking' && typeof window.renderProjectStatusPieChart === 'function') {
                     window.renderProjectStatusPieChart(window.filteredProjectData || []);
                     window.renderProjectProgressLineChart(); // Assumes simulated data or needs access to data
                 }
                  if(window.currentFeature === 'reports-analytics' && typeof window.renderTaskCompletionChart === 'function') {
                      window.renderTaskCompletionChart(window.currentFilteredReportData || []);
                      window.renderOverdueTasksChart(window.currentFilteredReportData || []);
                      window.renderFilesUploadedChart(window.currentFilteredReportData || []);
                      window.renderPerformanceComparisonChart(window.currentFilteredReportData || []);
                 }
            }


            function setContrast(enabled) {
                 console.log("Setting high contrast:", enabled);
                 document.body.classList.toggle('high-contrast', enabled);
                 localStorage.setItem('highContrast', enabled);
            }

             function applyLanguage(lang) {
                 console.log("Applying language:", lang);
                 // --- Simulation ---
                 document.documentElement.lang = lang; // Set HTML lang attribute

                 if (lang === 'ar') {
                     document.body.dir = 'rtl'; // Basic RTL support
                     if (document.getElementById('welcomeName')) document.getElementById('welcomeName').textContent = "مستخدم"; // Example
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "لوحة التحكم";
                     if (document.querySelector('[data-feature="projects"] span')) document.querySelector('[data-feature="projects"] span').textContent = "المشاريع";
                     if (document.querySelector('[data-feature="team-members-view"] span')) document.querySelector('[data-feature="team-members-view"] span').textContent = "أعضاء الفريق";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "الإعدادات";
                     // Add more translations as needed
                 } else {
                     document.body.dir = 'ltr';
                      if (document.getElementById('welcomeName') && currentUser) document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "Dashboard";
                     if (document.querySelector('[data-feature="projects"] span')) document.querySelector('[data-feature="projects"] span').textContent = "Projects";
                     if (document.querySelector('[data-feature="team-members-view"] span')) document.querySelector('[data-feature="team-members-view"] span').textContent = "Team Members";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "Settings";
                     // Add more translations
                 }
                 localStorage.setItem('language', lang);
                 // --- End Simulation ---
             }

             function applyDateTimeFormat(timeFormat, dateFormat) {
                console.log("Applying DateTime Format:", timeFormat, dateFormat);
                localStorage.setItem('timeFormat', timeFormat);
                localStorage.setItem('dateFormat', dateFormat);
                // Re-render any visible dates/times if needed
                if (currentFeature === 'dashboard' && activityList.children.length > 0 && activities.length > 0) { loadRecentActivities(showingAllActivities); }
                if (currentFeature === 'dashboard' && notifications.length > 0) { renderNotifications(); }
                 if (currentFeature === 'employee-scheduling') {
                     const scheduleTableBody = document.getElementById('scheduleTableBody');
                     if (scheduleTableBody && typeof window.renderSchedule === 'function') { window.renderSchedule(currentScheduleWeekOffset); }
                 }
                 if (currentFeature === 'projects') { // Re-render projects if visible
                    const container = document.getElementById('featureSectionsContainer'); // Get the main container
                     if(container && container.classList.contains('projects-feature') && typeof window.renderProjects === 'function') { // Check if projects feature is active
                        window.renderProjects(container); // Pass container to render function
                     }
                 }
                 if (currentFeature === 'filesharing') { // Re-render filesharing if visible
                      if(typeof window.updateRelativeTimesFS === 'function') {
                          window.updateRelativeTimesFS();
                      }
                      // Might need to re-render the main table if dates are displayed differently
                 }
                  if (currentFeature === 'project-tracking') { // Re-render project tracking if visible
                      if(typeof window.applyFiltersAndSort === 'function') {
                          window.applyFiltersAndSort(); // This should re-render the table with new date format
                      }
                      if(typeof window.renderUpcomingDeadlines === 'function') {
                          window.renderUpcomingDeadlines(window.filteredProjectData || []); // Re-render deadlines
                      }
                 }
                  if (currentFeature === 'task-management') { // Re-render tasks if visible
                     if(typeof window.renderTasks === 'function') {
                          window.renderTasks();
                     }
                  }
             }

             function applyToastPreference(enabled) {
                 console.log("Applying toast preference:", enabled);
                 showToasts = enabled;
                 localStorage.setItem('showToasts', enabled);
             }

             function applySoundPreference(enabled) {
                 console.log("Applying sound preference:", enabled);
                 playSounds = enabled;
                 localStorage.setItem('playSounds', enabled);
             }


            // --- Navigation & Content Loading ---
             function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));

                // --- Cleanup previous feature ---
                const previousFeatureId = currentFeature; // Store previous feature ID
                 removeInjectedStyles(previousFeatureId); // Remove specific styles if they exist
                 if (typeof currentFeatureCleanup === 'function') {
                     console.log(`Cleaning up feature: ${previousFeatureId}`);
                     currentFeatureCleanup(); // Call the cleanup function for the previous feature
                     currentFeatureCleanup = null; // Reset cleanup function
                 }
                // --- End Cleanup ---

                currentFeature = featureId;
                 window.currentFeature = featureId; // Make accessible globally if needed by feature JS

                // Update Menu Items
                menuItems.forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                });

                // Hide all top-level content sections first
                contentSections.forEach(section => section.classList.remove('active'));
                featureSectionsContainer.innerHTML = ''; // Clear dynamic content area always
                featureSectionsContainer.className = 'content-section'; // Reset classes


                // Show the correct section
                let targetSection = null;
                let isCoreSection = false;

                if (featureId === 'dashboard') {
                    targetSection = dashboardContent;
                    isCoreSection = true;
                } else if (featureId === 'profile') {
                    targetSection = profileContent;
                    isCoreSection = true;
                     updateProfileForm();
                } else if (featureId === 'settings') {
                    targetSection = settingsContent;
                    isCoreSection = true;
                    currentSettingsTab = settingsTab || (currentUser.role === 'admin' ? 'preferences' : 'preferences');
                     if (currentUser.role !== 'admin' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) {
                         currentSettingsTab = 'preferences';
                     }
                    activateSettingsTab(currentSettingsTab);
                     update2FA_UI();
                } else {
                    // Handle other features - load into feature container
                    targetSection = featureSectionsContainer;
                    loadFeatureContent(featureId);
                }

                // Activate the target section and manage back button
                if (targetSection) {
                    targetSection.classList.add('active');
                    backButton.style.display = isCoreSection && featureId !== 'dashboard' ? 'inline-flex' : (isCoreSection ? 'none' : 'inline-flex');
                    if (backButton.style.display === 'inline-flex') {
                         backButtonText.textContent = 'Back to Dashboard';
                    }
                } else {
                    // Fallback if no target section found (shouldn't happen with current logic)
                     dashboardContent.classList.add('active'); // Default to dashboard
                     backButton.style.display = 'none';
                }


                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                    if(closeSidebar) closeSidebar.style.display = 'none';
                }
                // Close user dropdown if open
                userDropdown.classList.remove('active');
                userDropdownOpen = false;

                if (!skipHistory) {
                    updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null);
                }
             }


            function activateSettingsTab(tabId) {
                console.log(`Activating settings tab: ${tabId}`);
                currentSettingsTab = tabId; // Update state
                settingsContent.querySelectorAll('.settings-tab').forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId));
                settingsContent.querySelectorAll('.settings-panel').forEach(panel => panel.classList.toggle('active', panel.id === `${tabId}Panel`));
                if (tabId === 'team' && currentUser.role === 'admin') { loadTeamMembers(); } // Load team members if applicable
                 if (tabId === 'security') { update2FA_UI(); }
                 if (tabId === 'account' && accountEmailDisplay) { accountEmailDisplay.value = currentUser.email; }
            }

            function getFeatureTemplateId(featureId) {
                // Simple mapping, can be extended
                switch (featureId) {
                    case 'task-management': return 'taskManagementAssets';
                    case 'file-sharing': return 'fileSharingAssets';
                    case 'project-tracking': return 'projectTrackingAssets';
                    case 'reports-analytics': return 'reportsAnalyticsAssets';
                    case 'data-management': return 'dataManagementAssets';
                    case 'team-members-view': return 'teamMembersAssets'; // Added
                    case 'projects': return 'projectsAssets'; // Added
                    case 'employee-scheduling': return 'employeeSchedulingAssets'; // Added
                    case 'team-calendar': return 'teamCalendarAssets';
                    case 'deadline-tracking': return 'deadlineTrackingAssets';
                    case 'innovation-hub': return 'innovationHubAssets';
                    default: return null;
                }
            }

            function getFeatureInitializer(featureId) {
                 // Map featureId to its JS initialization function (now attached to window)
                 switch (featureId) {
                    case 'task-management': return window.initializeTaskManagementFeature;
                    case 'file-sharing': return window.initializeFileSharingFeature;
                    case 'project-tracking': return window.initializeProjectTrackingFeature;
                    case 'reports-analytics': return window.initializeReportsAnalyticsFeature;
                    case 'data-management': return window.initializeDataManagementFeature;
                    case 'team-members-view': return window.initializeTeamMembersFeature;
                    case 'projects': return window.initializeProjectsFeature;
                    case 'employee-scheduling': return window.initializeEmployeeScheduleLogic;
                    case 'team-calendar': return window.initializeTeamCalendarFeature;
                    case 'deadline-tracking': return window.initializeDeadlineTrackingFeature;
                    case 'innovation-hub': return window.initializeInnovationHubFeature;
                    default: return null;
                 }
             }

             function injectStyles(featureId, cssContent) {
                 const styleId = `injected-${featureId}-styles`;
                 if (document.getElementById(styleId)) return; // Already injected

                 const styleTag = document.createElement('style');
                 styleTag.id = styleId;
                 styleTag.textContent = cssContent;
                 document.head.appendChild(styleTag);
                 console.log(`${featureId} styles injected.`);
             }

             function removeInjectedStyles(featureId) {
                 const styleId = `injected-${featureId}-styles`;
                 const styleTag = document.getElementById(styleId);
                 if (styleTag) {
                     styleTag.remove();
                     console.log(`${featureId} styles removed.`);
                 }
             }


            function loadFeatureContent(featureId) {
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : featureId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format name

                 // Clear previous content and show loading state within the feature container
                 featureSectionsContainer.innerHTML = ''; // Clear previous content first
                 featureSectionsContainer.className = `content-section active ${featureId}-feature`; // Set base + active + specific feature class
                 featureSectionsContainer.appendChild(featurePlaceholder); // Add placeholder back
                 featurePlaceholder.style.display = 'flex'; // Show placeholder
                 featureLoadingEl.style.display = 'block'; // Show loading indicator inside placeholder
                 featureErrorEl.style.display = 'none'; // Hide error message
                 featureTitleEl.textContent = `Loading ${featureName}...`;
                 featureDescEl.textContent = '';


                 console.log(`Loading content for: ${featureName} (${featureId})`);

                 const templateId = getFeatureTemplateId(featureId); // Get template ID
                 const template = templateId ? document.getElementById(templateId) : null;

                 setTimeout(() => { // Simulate loading delay
                     try {
                         if (template) {
                             featureSectionsContainer.innerHTML = ''; // Clear loading/placeholder

                             // Inject Styles from Template
                             const styleContent = template.content.querySelector('style');
                             if (styleContent) {
                                 injectStyles(featureId, styleContent.textContent);
                             } else { console.warn(`${featureId} styles not found in template.`); }

                             // Inject HTML Content from Template
                             const htmlWrapper = template.content.querySelector('div[class*="-feature-wrapper"]'); // Find the main wrapper div
                             if (htmlWrapper) {
                                 featureSectionsContainer.appendChild(htmlWrapper.cloneNode(true)); // Append cloned content
                             } else {
                                 console.warn(`${featureId} HTML content wrapper not found in template.`);
                                 // Fallback: Inject everything if wrapper not found (less ideal)
                                 const contentClone = document.importNode(template.content, true);
                                 // Remove style and script before appending HTML
                                 contentClone.querySelectorAll('style, script').forEach(el => el.remove());
                                 featureSectionsContainer.appendChild(contentClone);
                             }

                             // Execute JS Initializer from Template
                             // IMPORTANT: The <script> inside the template *must* define the initializer on the window object
                             // e.g., window.initializeMyFeature = function(container) { ... }
                             const initializer = getFeatureInitializer(featureId);
                             if (initializer && typeof initializer === 'function') {
                                 try {
                                     const initResult = initializer(featureSectionsContainer); // Pass the container
                                     currentFeatureCleanup = initResult?.cleanup; // Store the cleanup function
                                     console.log(`${featureName} JS initialized.`);
                                 } catch (e) {
                                     console.error(`Error executing ${featureId} script:`, e);
                                     featureSectionsContainer.innerHTML = ''; // Clear potentially broken content
                                     featureSectionsContainer.appendChild(featurePlaceholder); // Show placeholder again
                                     featurePlaceholder.style.display = 'flex';
                                     featureLoadingEl.style.display = 'none';
                                     featureTitleEl.textContent = `Error Loading ${featureName}`;
                                     featureErrorEl.textContent = `Failed to initialize ${featureName}. Check console for details.`;
                                     featureErrorEl.style.display = 'block';
                                 }
                             } else {
                                 console.warn(`${featureId} initializer function not found or not a function.`);
                                 // Feature might not have complex JS, which is okay
                                 currentFeatureCleanup = () => { console.log(`No specific cleanup for ${featureId}`); }; // Default cleanup
                             }

                         } else {
                             // Default placeholder for unimplemented/missing features
                              featureSectionsContainer.innerHTML = ''; // Clear loading
                              featureSectionsContainer.appendChild(featurePlaceholder); // Re-add placeholder
                              featurePlaceholder.style.display = 'flex';
                              featureLoadingEl.style.display = 'none'; // Hide loading indicator
                              featureTitleEl.textContent = featureName;
                              featureDescEl.textContent = `Content for ${featureName} is not yet available.`;
                             console.warn(`Template not found for feature: ${featureId}`);
                         }

                     } catch (error) {
                         console.error(`Error loading feature ${featureId}:`, error);
                         featureSectionsContainer.innerHTML = ''; // Clear loading/placeholder
                         featureSectionsContainer.appendChild(featurePlaceholder); // Show placeholder again on error
                         featurePlaceholder.style.display = 'flex';
                         featureLoadingEl.style.display = 'none';
                         featureTitleEl.textContent = `Error Loading ${featureName}`;
                         featureErrorEl.textContent = `Failed to load ${featureName}. Error: ${error.message}`;
                         featureErrorEl.style.display = 'block';
                     }
                 }, 150); // Reduced delay
             }


            function updateBrowserHistory(featureId, settingsTab = null) {
                let hash = `#${featureId}`;
                if (featureId === 'settings' && settingsTab) {
                    hash += `-${settingsTab}`;
                }
                if (window.location.hash !== hash) {
                    // Use replaceState for settings tabs to avoid messy history? Or pushState for everything?
                    // Using pushState for now for simplicity.
                    window.history.pushState({ feature: featureId, tab: settingsTab }, '', hash);
                }
            }

            function handleInitialNavigation() {
                const hash = window.location.hash.substring(1);
                console.log(`Handling navigation for hash: ${hash}`);
                let featureId = 'dashboard';
                let settingsTab = null;

                if (hash) {
                    if (hash.startsWith('settings-')) {
                        const parts = hash.split('-');
                        featureId = parts[0]; // should be 'settings'
                        settingsTab = parts[1];
                        // Validate if settingsTab is a valid tab ID
                        const validTabs = Array.from(settingsContent.querySelectorAll('.settings-tab')).map(t => t.dataset.tab);
                        if (!validTabs.includes(settingsTab)) {
                            settingsTab = 'preferences'; // Default if invalid
                        }
                    } else {
                        const knownFeature = Array.from(menuItems).some(item => item.getAttribute('data-feature') === hash);
                        if (knownFeature) { featureId = hash; }
                         else {
                            // If hash doesn't match a known feature or settings format, default to dashboard
                            featureId = 'dashboard';
                            window.history.replaceState({ feature: 'dashboard', tab: null }, '', '#dashboard'); // Correct the hash
                        }
                    }
                }
                setActiveFeature(featureId, settingsTab, true); // Skip history update on initial load
            }


            window.addEventListener('popstate', function(event) {
                console.log("Popstate event:", event.state, window.location.hash);
                handleInitialNavigation(); // Re-evaluate based on the new hash/state
            });


            // --- Data Loading & Simulation ---
            function loadInitialData() {
                loadDashboardStats();
                loadRecentActivities();
                loadNotifications();
                loadMockProjects(); // Load project data into state
                if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') { loadTeamMembers(); }
            }

             function loadMockProjects() {
                 MOCK_PROJECTS_DATA = [
                    { id: "alpha001", name: "Project Alpha", status: "in-progress", description:"Complete phase 1 development and initial QA testing.", participants: "Mohamed Elmenisy|Esraa Lashin", img: "https://images.unsplash.com/photo-1517048676732-d65bc937f952?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 65, startDate: "2023-08-15", dueDate:"2024-08-30", updatedDate: "2024-07-10", editable: true },
                    { id: "web002", name: "Website Redesign", status: "completed", description:"Full redesign and deployment of the company website.", participants: "Esraa Lashin|Bassant Badr", img: "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 100, startDate: "2023-05-01", dueDate:"2024-01-15", updatedDate: "2024-01-20", editable: false },
                    { id: "mobile003", name: "Mobile App V2", status: "active", description:"Develop version 2 of the mobile application with new features.", participants: "Yousef Ahmed|Nada Mahmoud|Mohamed Elmenisy", img: "https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 20, startDate: "2024-02-20", dueDate:"2024-10-31", updatedDate: "2024-07-05", editable: true },
                    { id: "mktg004", name: "Q4 Marketing Plan", status: "pending", description:"Develop and finalize the marketing strategy for the fourth quarter.", participants: "Bassant Badr|Nada Mahmoud", img: "https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 0, startDate: "2024-09-01", dueDate:"2024-09-20", updatedDate: "2024-07-12", editable: true },
                    { id: "infra005", name: "Server Migration", status: "in-progress", description:"Migrate existing servers to new cloud infrastructure.", participants: "Mohamed Elmenisy", img: "https://images.unsplash.com/photo-1580894742597-87bc8789db3d?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 85, startDate: "2024-06-10", dueDate:"2024-07-31", updatedDate: "2024-07-15", editable: true }
                ];
                console.log("Mock projects loaded into MOCK_PROJECTS_DATA");
            }

            function loadDashboardStats() {
                 console.log("Loading dashboard stats...");
                 setTimeout(() => {
                     const teamMembersCount = MOCK_USERS.length;
                     const tasksCompleted = MOCK_TASKS.filter(t => t.status === 'Completed').length + Math.floor(Math.random() * 50);
                     const activeProjects = MOCK_PROJECTS_DATA.filter(p => p.status === 'active' || p.status === 'in-progress').length; // Count active & in-progress
                     const upcomingDeadlines = Math.floor(Math.random() * 10);
                     updateStatCard('teamMembersCount', 'Team Members', 'fas fa-users', teamMembersCount, Math.random() * 10 - 5);
                     updateStatCard('tasksCompleted', 'Tasks Completed', 'fas fa-check-circle', tasksCompleted, Math.random() * 20);
                     updateStatCard('activeProjects', 'Active Projects', 'fas fa-project-diagram', activeProjects, Math.random() * 5 - 2);
                     updateStatCard('upcomingDeadlines', 'Upcoming Deadlines', 'fas fa-calendar-times', upcomingDeadlines, Math.random() * 15 - 10);
                 }, 300);
            }

            function updateStatCard(id, title, iconClass, value, trendPercent) {
                 const cardIndex = ['teamMembersCount', 'tasksCompleted', 'activeProjects', 'upcomingDeadlines'].indexOf(id);
                 if (cardIndex === -1 || !statsSection || !statsSection.children[cardIndex]) return;
                 const card = statsSection.children[cardIndex];
                 let trendClass = 'trend-neutral'; let trendIcon = 'fas fa-minus';
                 if (trendPercent > 1) { trendClass = 'trend-up'; trendIcon = 'fas fa-arrow-up'; }
                 else if (trendPercent < -1) { trendClass = 'trend-down'; trendIcon = 'fas fa-arrow-down'; }
                 card.innerHTML = `
                    <div class="stat-title"><i class="${iconClass}"></i>${title}</div>
                    <div class="stat-value">
                        <span>${value}</span>
                        <span class="stat-trend ${trendClass}">
                            <i class="${trendIcon}"></i> ${trendPercent !== 0 ? Math.abs(trendPercent).toFixed(0) + '%' : ''}
                        </span>
                    </div>`;
            }

            function loadRecentActivities(showAll = false) {
                console.log("Loading recent activities...");
                if (!activityList) return; // Check if element exists
                if (activities.length === 0) {
                    const now = Date.now();
                    activities = generateMockActivities(15, now);
                }
                showingAllActivities = showAll;
                const activitiesToDisplay = showAll ? activities : activities.slice(0, maxActivitiesToShow);
                activityList.innerHTML = '';
                if (activitiesToDisplay.length === 0) {
                    activityList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>';
                    if (deleteAllActivity) deleteAllActivity.style.display = 'none';
                    if (viewAllActivity) viewAllActivity.style.display = 'none';
                     return;
                }
                activitiesToDisplay.forEach((activity, index) => {
                    const li = document.createElement('li'); li.classList.add('activity-item'); li.dataset.id = activity.id;
                    if (activity.isNew) { li.classList.add('new-activity'); setTimeout(() => { activity.isNew = false; const currentLi = activityList.querySelector(`[data-id='${activity.id}']`); if (currentLi) currentLi.classList.remove('new-activity'); }, 2500); }
                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon}"></i></div>
                        <div class="activity-content"> <div class="activity-message">${activity.message}</div> <div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div> </div>
                        <div class="activity-actions"> <i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i> </div>`;
                    activityList.appendChild(li);
                });
                 if (deleteAllActivity) deleteAllActivity.style.display = activities.length > 0 ? 'inline-block' : 'none';
                 if (viewAllActivity) {
                     viewAllActivity.textContent = showAll ? 'Show Less' : 'Show All';
                     viewAllActivity.style.display = activities.length > maxActivitiesToShow ? 'inline-block' : 'none';
                 }
            }

            function loadNotifications() {
                 console.log("Loading notifications...");
                  if (!notificationsBody || !noNotificationsMessage) return; // Check elements
                 if (notifications.length === 0) { const now = Date.now(); notifications = generateMockNotifications(8, now); }
                 renderNotifications();
            }

            function renderNotifications() {
                 if (!notificationsBody || !noNotificationsMessage || !notificationBadge || !markAllReadBtn || !deleteAllNotificationsBtn) return;
                 notificationsBody.innerHTML = ''; const unreadCount = notifications.filter(n => n.unread).length;
                 if (notifications.length === 0) { noNotificationsMessage.textContent = 'You have no notifications.'; noNotificationsMessage.style.display = 'block'; notificationBadge.style.display = 'none'; notificationBadge.textContent = '0'; markAllReadBtn.disabled = true; deleteAllNotificationsBtn.disabled = true; return; }
                 noNotificationsMessage.style.display = 'none'; markAllReadBtn.disabled = unreadCount === 0; deleteAllNotificationsBtn.disabled = false;
                 notifications.forEach(notification => {
                     const div = document.createElement('div'); div.classList.add('notification-list-item'); div.dataset.id = notification.id; if (notification.unread) { div.classList.add('unread'); }
                     div.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div>
                        <div class="notification-content"> <div class="notification-message">${notification.message}</div> <div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div> </div>
                        <i class="fas fa-times delete-notification" title="Delete Notification"></i>`;
                    notificationsBody.appendChild(div);
                 });
                 notificationBadge.textContent = unreadCount; notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }

             function loadTeamMembers(container) {
                 const isSettingsView = !container; // Determine view based on container presence
                 const teamListContainer = container ? container.querySelector('.team-list-display') : document.getElementById('teamList');

                 if (!teamListContainer) {
                     console.error("Team list container not found for", isSettingsView ? "Settings" : "Feature View");
                     return;
                 }

                 console.log("Loading team members for", isSettingsView ? "Settings" : "Feature View");
                 teamListContainer.innerHTML = '<p style="color: var(--gray);">Loading...</p>'; // Loading indicator

                 setTimeout(() => {
                     teamListContainer.innerHTML = ''; // Clear loading
                     if (MOCK_USERS.length === 0) {
                         teamListContainer.innerHTML = '<p style="color: var(--gray);">No team members found.</p>';
                         return;
                     }
                     MOCK_USERS.forEach(member => {
                         const card = document.createElement('div');
                         // Apply correct base class based on view
                         card.classList.add(isSettingsView ? 'team-member-card' : 'team-member-card');
                         card.dataset.id = member.id;
                         card.dataset.name = member.name;
                         card.dataset.role = member.role;
                         card.dataset.email = member.email;

                         const avatarStyle = member.avatar ? `background-image: url('${member.avatar}')` : '';
                         const avatarContent = member.avatar ? '' : member.initials;

                         if (!isSettingsView) { // Feature view (grid card) - uses feature CSS
                             card.innerHTML = `
                                <div class="member-info">
                                    <h4 class="member-name">${member.name}</h4>
                                    <p class="member-email">${member.email}</p>
                                    <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                                </div>
                             `;
                         } else { // Settings view (list item) - uses settings CSS
                             card.innerHTML = `
                                <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                                <div class="member-details">
                                    <div class="member-name">${member.name}</div>
                                    <div class="member-email">${member.email}</div>
                                </div>
                                <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                                ${currentUser.role === 'admin' && currentUser.id !== member.id ? `
                                <div class="member-actions">
                                    <button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                ` : '<div class="member-actions" style="width: 70px;">&nbsp;</div>'} <!-- Placeholder for alignment -->
                             `;
                         }
                         teamListContainer.appendChild(card);
                     });
                 }, 300);
             }


            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() {
                if (activityIntervalId) clearInterval(activityIntervalId);
                activityIntervalId = setInterval(() => {
                    const newActivity = generateMockActivities(1, Date.now())[0]; newActivity.isNew = true;
                    activities.unshift(newActivity); if (activities.length > 50) activities.pop();
                    if (currentFeature === 'dashboard') { loadRecentActivities(showingAllActivities); }
                    showToast(`New Activity: ${newActivity.message.substring(0, 30)}...`);
                }, Math.random() * 10000 + 10000);

                 if (notificationIntervalId) clearInterval(notificationIntervalId);
                 notificationIntervalId = setInterval(() => {
                    const newNotification = generateMockNotifications(1, Date.now())[0]; newNotification.unread = true;
                    notifications.unshift(newNotification); if (notifications.length > 30) notifications.pop();
                    renderNotifications(); playNotificationSound();
                 }, Math.random() * 20000 + 20000);

                 if (statsIntervalId) clearInterval(statsIntervalId);
                 statsIntervalId = setInterval(loadDashboardStats, 30000);

                 if (welcomeBgIntervalId) clearInterval(welcomeBgIntervalId);
                 welcomeBgIntervalId = setInterval(changeWelcomeBackground, 15000);
            }

            function changeWelcomeBackground() {
                const backgrounds = ['--welcome-bg-1', '--welcome-bg-2', '--welcome-bg-3'];
                const currentBgVar = getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim();
                let currentIndex = backgrounds.indexOf(currentBgVar); if (currentIndex === -1) currentIndex = 0;
                const nextIndex = (currentIndex + 1) % backgrounds.length;
                document.documentElement.style.setProperty('--welcome-bg-current', `var(${backgrounds[nextIndex]})`);
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                 if (sidebarToggle) { sidebarToggle.addEventListener('click', () => { sidebar.classList.add('active'); mainContent.classList.add('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'block'; }); }
                 if (closeSidebar) { closeSidebar.addEventListener('click', () => { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); closeSidebar.style.display = 'none'; }); }
                 document.addEventListener('click', (event) => { if (window.innerWidth <= 992 && sidebar.classList.contains('active')) { const isClickInsideSidebar = sidebar.contains(event.target); const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target); if (!isClickInsideSidebar && !isClickOnToggler) { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } } });
                menuItems.forEach(item => item.addEventListener('click', function(e) { e.preventDefault(); const featureId = this.getAttribute('data-feature'); setActiveFeature(featureId); }));
                document.body.addEventListener('click', function(e) { const target = e.target; if (target.closest('.settings-tab') && !target.closest('.settings-tab.active')) { const tabId = target.closest('.settings-tab').getAttribute('data-tab'); activateSettingsTab(tabId); updateBrowserHistory('settings', tabId); } else if (target.closest('.settings-link') && target.closest('.settings-link').dataset.tabTarget) { e.preventDefault(); const tabId = target.closest('.settings-link').dataset.tabTarget; setActiveFeature('settings', tabId); } });
                backButton.addEventListener('click', function() { setActiveFeature('dashboard'); });
                userProfileContainer.addEventListener('click', function(e) { if (e.target.closest('.dropdown-item')) { const feature = e.target.closest('.dropdown-item').getAttribute('data-feature'); if (feature) { setActiveFeature(feature); } return; } userDropdownOpen = !userDropdownOpen; userDropdown.classList.toggle('active', userDropdownOpen); });
                 document.addEventListener('click', function(event) { if (!userProfileContainer.contains(event.target) && userDropdownOpen) { userDropdown.classList.remove('active'); userDropdownOpen = false; } });
                searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch);
                 document.addEventListener('click', (event) => { if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) { searchResultsContainer.classList.remove('active'); } });
                 searchResultsContainer.addEventListener('click', (event) => { const targetItem = event.target.closest('.search-result-item'); if (targetItem && targetItem.dataset.feature) { const featureId = targetItem.dataset.feature; const itemId = targetItem.dataset.id; console.log(`Search result: Feature=${featureId}, ID=${itemId}`); setActiveFeature(featureId); searchResultsContainer.classList.remove('active'); searchInput.value = ''; } });
                notificationIcon.addEventListener('click', () => { notificationsModalInstance?.show(); });
                closeNotifications.addEventListener('click', () => { notificationsModalInstance?.hide(); });
                 // Bootstrap handles backdrop click dismissal for its modals

                 notificationsBody.addEventListener('click', (event) => { const target = event.target; const notificationItem = target.closest('.notification-list-item'); const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null; if (target.classList.contains('delete-notification') && notificationId) { showConfirmModal('Delete Notification', 'Are you sure?', () => { notifications = notifications.filter(n => n.id !== notificationId); renderNotifications(); showToast('Notification deleted.', 'success'); }); } else if (notificationItem && notificationId) { const notification = notifications.find(n => n.id === notificationId); if (notification && notification.unread) { notification.unread = false; renderNotifications(); } console.log(`Clicked notification ${notificationId}`); } });
                 markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
                 deleteAllNotificationsBtn.addEventListener('click', () => { if (notifications.length === 0) return; showConfirmModal('Delete All Notifications', 'Are you sure?', () => { notifications = []; renderNotifications(); showToast('All notifications deleted.', 'success'); }); });
                 activityList.addEventListener('click', (event) => { const target = event.target; if (target.classList.contains('delete-activity')) { const activityItem = target.closest('.activity-item'); const activityId = activityItem ? parseInt(activityItem.dataset.id) : null; if (activityId) { activities = activities.filter(a => a.id !== activityId); loadRecentActivities(showingAllActivities); showToast('Activity deleted.'); } } });
                viewAllActivity.addEventListener('click', () => { loadRecentActivities(!showingAllActivities); });
                deleteAllActivity.addEventListener('click', () => { if (activities.length === 0) return; showConfirmModal('Delete All Activities', 'Are you sure?', () => { activities = []; loadRecentActivities(false); showToast('All activities deleted.'); }); });
                profileAvatarLarge.addEventListener('click', () => { profileAvatarInput.click(); });
                 profileAvatarInput.addEventListener('change', handleAvatarUpload);
                 profileForm.addEventListener('submit', handleProfileSave);
                 cancelProfileBtn.addEventListener('click', handleProfileCancel);
                 firstNameInput.addEventListener('input', updateFullNameDisplay);
                 lastNameInput.addEventListener('input', updateFullNameDisplay);
                 logoutLink.addEventListener('click', handleLogout);

                 // Team Management Actions (Settings Panel)
                 const teamListContainer = document.getElementById('teamList');
                 if (teamListContainer) {
                    teamListContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        const memberCard = target.closest('.team-member-card'); // Look for the card in settings list
                        const memberId = memberCard ? parseInt(memberCard.dataset.id) : null;
                        if (!memberId || memberId === currentUser.id) return; // Cannot edit/remove self from here
                        if (target.closest('.edit-member')) { openMemberModal(memberId); } // Use generic modal
                        else if (target.closest('.remove-member')) { handleRemoveMember(memberId); }
                    });
                 }
                 // Use generic member modal/form for Add/Edit
                 if (memberForm) { memberForm.addEventListener('submit', handleSaveMember); }
                 if(memberModalEl) {
                     memberModalEl.querySelectorAll('[data-close-modal]').forEach(btn => { btn.addEventListener('click', () => memberModalInstance?.hide()); });
                     // Bootstrap handles backdrop click
                 }
                 const inviteMemberForm = document.getElementById('inviteMemberForm');
                 if (inviteMemberForm) { inviteMemberForm.addEventListener('submit', handleInviteMember); }

                // Project Modal Listeners
                 if (projectForm) { projectForm.addEventListener('submit', handleSaveProject); }
                 if (projectModalEl) {
                     projectModalEl.querySelectorAll('[data-close-modal]').forEach(btn => {
                         btn.addEventListener('click', () => projectModalInstance?.hide());
                     });
                      // Bootstrap handles backdrop click
                 }


                 // Settings Controls Listeners
                 themeOptions.forEach(option => { option.addEventListener('click', () => setTheme(option.dataset.theme)); });
                 if (highContrastToggle) { highContrastToggle.addEventListener('change', (e) => setContrast(e.target.checked)); }
                 if (languageSelect) { languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value)); }
                 if (regionSelect) { regionSelect.addEventListener('change', (e) => localStorage.setItem('region', e.target.value)); }
                 if (timeFormatSelect || dateFormatSelect) { const applyDateTimeListener = () => { applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value); }; if (timeFormatSelect) timeFormatSelect.addEventListener('change', applyDateTimeListener); if (dateFormatSelect) dateFormatSelect.addEventListener('change', applyDateTimeListener); }
                 if (toastToggle) { toastToggle.addEventListener('change', (e) => applyToastPreference(e.target.checked)); }
                 if (soundToggle) { soundToggle.addEventListener('change', (e) => applySoundPreference(e.target.checked)); }
                if(savePreferencesBtn) savePreferencesBtn.addEventListener('click', handleSavePreferences);
                if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
                if(saveAccountSettingsBtn) saveAccountSettingsBtn.addEventListener('click', handleSaveAccountSettings);
                if(saveSessionSettingsBtn) saveSessionSettingsBtn.addEventListener('click', handleSaveSessionSettings);
                if(saveNotificationSettingsBtn) saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);
                 if (enable2faBtn) enable2faBtn.addEventListener('click', handleEnable2FA);
                 if (setupAuthAppBtn) setupAuthAppBtn.addEventListener('click', showAuthAppSetup);
                 if (setupSmsBtn) setupSmsBtn.addEventListener('click', showSmsSetup);
                 if (verifyAuthCodeBtn) verifyAuthCodeBtn.addEventListener('click', handleVerifyAuthCode);
                 if (sendSmsCodeBtn) sendSmsCodeBtn.addEventListener('click', handleSendSmsCode);
                 if (verifySmsCodeBtn) verifySmsCodeBtn.addEventListener('click', handleVerifySmsCode);
                 if (disable2faBtn) disable2faBtn.addEventListener('click', handleDisable2FA);
                 if(logoutAllDevicesBtn) logoutAllDevicesBtn.addEventListener('click', handleLogoutAllDevices);
                 if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);
                cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                confirmBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmModal(); });
            }

            // --- Specific Feature Logic ---
            function setupResponsiveSidebar() { /* Handled in setupEventListeners */ }

            // --- Search Logic ---
            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase(); searchResultsContainer.innerHTML = '';
                if (searchTerm.length < 2) { searchResultsContainer.classList.remove('active'); return; }
                console.log(`Searching for: ${searchTerm}`); const results = [];
                MOCK_USERS.forEach(user => { if (user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) { results.push({ type: 'User', id: user.id, name: user.name, description: user.email, icon: 'fa-user', feature: 'team-members-view' }); } });
                MOCK_PROJECTS_DATA.forEach(project => { if (project.name.toLowerCase().includes(searchTerm)) { results.push({ type: 'Project', id: project.id, name: project.name, description: `Status: ${project.status}`, icon: 'fa-briefcase', feature: 'projects' }); } });
                MOCK_TASKS.forEach(task => { if (task.name.toLowerCase().includes(searchTerm)) { const projectName = MOCK_PROJECTS.find(p => p.id === task.project)?.name || 'Unknown Project'; results.push({ type: 'Task', id: task.id, name: task.name, description: `Project: ${projectName} | Status: ${task.status}`, icon: 'fa-tasks', feature: 'task-management' }); } });
                menuItems.forEach(item => { const featureName = item.querySelector('span')?.textContent; const featureId = item.getAttribute('data-feature'); if (featureName && featureId && featureName.toLowerCase().includes(searchTerm)) { if (!results.some(r => r.feature === featureId && r.type !== 'User' && r.type !== 'Project' && r.type !== 'Task')) { results.push({ type: 'Feature', id: null, name: featureName, description: 'Navigate to section', icon: item.querySelector('i')?.className.split(' ')[1] || 'fa-compass', feature: featureId }); } } });
                if (results.length > 0) { results.slice(0, 10).forEach(result => { const item = document.createElement('div'); item.classList.add('search-result-item'); item.dataset.feature = result.feature; if (result.id) item.dataset.id = result.id; item.innerHTML = `<i class="fas ${result.icon}"></i> <div> <strong>${result.name}</strong> <small>(${result.type})</small><br> <span style="font-size: 0.8em; color: var(--gray);">${result.description}</span> </div>`; searchResultsContainer.appendChild(item); }); searchResultsContainer.classList.add('active'); }
                else { searchResultsContainer.innerHTML = '<div class="search-result-item" style="text-align: center; color: var(--gray); cursor: default;">No results found.</div>'; searchResultsContainer.classList.add('active'); }
            }

            // --- Profile Logic ---
            function handleAvatarUpload(event) { const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { const imageUrl = e.target.result; profileAvatarLarge.style.backgroundImage = `url(${imageUrl})`; profileAvatarLarge.textContent = ''; document.getElementById('userAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('userAvatar').textContent = ''; document.getElementById('profileAvatar').style.backgroundImage = `url(${imageUrl})`; document.getElementById('profileAvatar').textContent = ''; currentUser.avatar = imageUrl; showToast('Avatar preview updated. Save changes to persist.'); }; reader.readAsDataURL(file); } else if (file) { showToast('Please select a valid image file.', 'error'); } }
            function updateFullNameDisplay() { fullNameDisplay.value = `${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim(); }
             function handleProfileSave(event) { event.preventDefault(); console.log("Saving profile..."); showConfirmModal( 'Save Profile Changes', 'Are you sure?', () => { console.log("Profile save confirmed."); const saveButtonText = saveProfileBtn.querySelector('.btn-text'); const spinner = saveProfileBtn.querySelector('.spinner'); saveProfileBtn.disabled = true; if (saveButtonText) saveButtonText.style.display = 'none'; if (spinner) spinner.style.display = 'inline-block'; setTimeout(() => { currentUser.name = fullNameDisplay.value; currentUser.title = jobTitleInput.value; currentUser.phone = phoneInput.value; currentUser.department = departmentInput.value; if (!currentUser.avatar) { const nameParts = currentUser.name.split(' '); currentUser.initials = (nameParts[0]?.[0] || '') + (nameParts[1]?.[0] || ''); } if (userPhoneNumberForSms) userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available'; updateUserUI(); saveProfileBtn.disabled = false; if (saveButtonText) saveButtonText.style.display = 'inline'; if (spinner) spinner.style.display = 'none'; showSuccessMessage('Profile updated successfully!'); }, 1000); }, 'btn-primary' ); }
             function handleProfileCancel() { showConfirmModal( 'Cancel Changes', 'Discard changes?', () => { updateProfileForm(); showToast('Changes discarded.'); }, 'btn-warning' ); }

             // --- Settings Save Logic ---
             function handleSavePreferences() { showConfirmModal('Save Preferences', 'Save Appearance/Localization?', () => { console.log("Saving Preferences..."); showToast('Preferences saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveAccountSettings() { showConfirmModal('Save Account Settings', 'Save notification settings?', () => { console.log("Saving Account Settings..."); const enableNotifications = document.getElementById('accountNotificationsToggle').checked; console.log("Account Notifications Enabled:", enableNotifications); showToast('Account settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleChangePassword(event) {
                 event.preventDefault(); // Prevent default form submission
                  showConfirmModal('Change Password', 'Are you sure you want to attempt to change your password?', () => {
                     console.log("Changing password...");
                     const currentPass = document.getElementById('currentPassword').value;
                     const newPass = document.getElementById('newPassword').value;
                     const confirmPass = document.getElementById('confirmPassword').value;
                     if (!currentPass || !newPass || !confirmPass) { showToast('Please fill in all password fields.', 'error'); return; }
                     if (newPass !== confirmPass) { showToast('New passwords do not match.', 'error'); return; }
                     if (newPass.length < 8) { showToast('New password must be at least 8 characters.', 'error'); return; }
                     showToast('Attempting password change...', 'info');
                     setTimeout(() => {
                         const success = Math.random() > 0.2;
                         if (success) {
                             showSuccessMessage('Password changed successfully!');
                             document.getElementById('currentPassword').value = ''; document.getElementById('newPassword').value = ''; document.getElementById('confirmPassword').value = '';
                         } else { showToast('Password change failed. Incorrect current password?', 'error'); }
                     }, 1500);
                  }, 'btn-danger');
             }
             function handleSaveSessionSettings() { showConfirmModal('Save Session Settings', 'Save session duration and idle timeout?', () => { console.log("Saving Session Settings..."); const sessionDuration = document.getElementById('sessionDuration').value; const idleTimeout = document.getElementById('idleTimeout').value; console.log("Session Duration:", sessionDuration, "Idle Timeout:", idleTimeout); showToast('Session settings saved (simulated).', 'success'); }, 'btn-primary'); }
             function handleSaveNotificationSettings() { showConfirmModal('Save Notification Settings', 'Save notification delivery/types?', () => { console.log("Saving Notification Settings..."); const emailEnabled = document.getElementById('emailNotificationsToggle').checked; const inAppEnabled = document.getElementById('inAppNotificationsToggle').checked; const pushEnabled = document.getElementById('pushNotificationsToggle').checked; const selectedTypes = Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb => cb.value); console.log("Email:", emailEnabled, "InApp:", inAppEnabled, "Types:", selectedTypes); showToast('Notification settings saved (simulated).', 'success'); }, 'btn-primary'); }

             // --- 2FA Logic (Simulation) ---
             function update2FA_UI() { if (!currentUser || !twoFaStatusIndicator || !twoFaStatusText || !twoFaSetupSection || !twoFaManagementSection) return; const isEnabled = currentUser.twoFaEnabled; twoFaStatusIndicator.className = `status-indicator ${isEnabled ? 'enabled' : 'disabled'}`; twoFaStatusText.textContent = `2FA is currently ${isEnabled ? 'Enabled' : 'Disabled'}`; twoFaSetupSection.style.display = isEnabled ? 'none' : 'block'; twoFaManagementSection.style.display = isEnabled ? 'block' : 'none'; if (twoFaSetupOptions) twoFaSetupOptions.style.display = 'none'; if (authAppSetup) authAppSetup.style.display = 'none'; if (smsSetup) smsSetup.style.display = 'none'; }
             function handleEnable2FA() { if(twoFaSetupOptions) twoFaSetupOptions.style.display = 'block'; if(enable2faBtn) enable2faBtn.style.display = 'none'; }
             function showAuthAppSetup() { if(authAppSetup) authAppSetup.style.display = 'block'; if(smsSetup) smsSetup.style.display = 'none'; }
             function showSmsSetup() { if(authAppSetup) authAppSetup.style.display = 'none'; if(smsSetup) smsSetup.style.display = 'block'; if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none'; }
             function handleVerifyAuthCode() { const authCodeInput = document.getElementById('authCode'); if (!authCodeInput) return; const code = authCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { showToast('Verifying code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); showToast('2FA enabled via Authenticator App!', 'success'); }, 1000); } else { showToast('Invalid code. Please enter 6 digits.', 'error'); } }
             function handleSendSmsCode() { showToast('Sending SMS code...', 'info'); setTimeout(() => { showToast('SMS code sent (simulated).', 'success'); if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'block'; if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'inline-flex'; }, 1500); }
             function handleVerifySmsCode() { const smsCodeInput = document.getElementById('smsCode'); if (!smsCodeInput) return; const code = smsCodeInput.value; if (code && code.length === 6 && /^\d+$/.test(code)) { showToast('Verifying SMS code...', 'info'); setTimeout(() => { currentUser.twoFaEnabled = true; update2FA_UI(); showToast('2FA enabled via SMS!', 'success'); }, 1000); } else { showToast('Invalid SMS code. Please enter 6 digits.', 'error'); } }
             function handleDisable2FA() { showConfirmModal('Disable 2FA', 'Are you sure? This reduces security.', () => { currentUser.twoFaEnabled = false; update2FA_UI(); if(enable2faBtn) enable2faBtn.style.display = 'inline-flex'; showToast('2FA disabled.'); }, 'btn-danger'); }

             // --- Danger Zone Logic ---
             function handleLogoutAllDevices() { showConfirmModal('Logout From All Devices', 'End all other sessions?', () => { showToast('Logging out from other devices...', 'info'); setTimeout(() => { showSuccessMessage('Logged out from other devices.'); }, 1500); }, 'btn-warning'); }
             function handleDeleteAccount() { showConfirmModal('Delete Account', 'IRREVERSIBLE! Delete all data?', () => { showConfirmModal('Final Confirmation', 'Are you absolutely sure?', () => { console.warn("Account Deletion Confirmed (Simulated)"); showToast('Deleting account...', 'error'); setTimeout(() => { alert("Account Deleted (Simulated). Redirecting..."); handleLogout(new Event('click')); }, 2000); }, 'btn-danger'); }, 'btn-danger'); }

             // --- Notification Logic ---
             function markAllNotificationsAsRead() { if (notifications.some(n => n.unread)) { notifications.forEach(n => n.unread = false); renderNotifications(); showToast('All notifications marked as read.'); } }
             function playNotificationSound() { if (!playSounds) return; try { if (notificationSound && notificationSound.paused) { notificationSound.play().catch(e => console.warn("Audio play failed:", e)); } } catch(e) { console.warn("Audio error:", e); } }

             // --- Logout Logic ---
             function handleLogout(event) { event.preventDefault(); showConfirmModal( 'Confirm Logout', 'Are you sure?', () => { console.log("Logging out..."); clearInterval(activityIntervalId); clearInterval(notificationIntervalId); clearInterval(statsIntervalId); clearInterval(welcomeBgIntervalId); showSuccessMessage('Logout successful! Redirecting...'); setTimeout(() => { window.location.href = 'login.html'; }, 1500); }, 'btn-danger' ); }

            // --- Team Management Logic ---
             function handleInviteMember(event) {
                 event.preventDefault();
                 const emailInput = document.getElementById('inviteEmail');
                 const roleInput = document.getElementById('inviteRole');
                 const email = emailInput ? emailInput.value : null;
                 const role = roleInput ? roleInput.value : null;
                 const inviteButton = event.target.querySelector('button[type="submit"]');

                 if (!email || !role || !/\S+@\S+\.\S+/.test(email)) { // Basic email validation
                     showToast('Please provide a valid email and role.', 'error');
                     return;
                 }
                 // Check if email already exists
                 if (MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                     showToast('A user with this email already exists.', 'error');
                     return;
                 }

                 console.log(`Inviting ${email} as ${role}`);
                 if (inviteButton) { inviteButton.disabled = true; inviteButton.innerHTML = '<span class="spinner"></span> Sending...'; }

                 setTimeout(() => {
                    const newId = MOCK_USERS.length > 0 ? Math.max(...MOCK_USERS.map(u => u.id)) + 1 : 1;
                    const nameParts = email.split('@')[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1));
                    const newUser = { id: newId, name: nameParts.join(' ') || 'New User', email: email, title: formatRole(role), department: 'Pending', phone: '', avatar: '', initials: (nameParts[0]?.[0] || 'N') + (nameParts[1]?.[0] || 'U'), role: role, twoFaEnabled: false };
                    MOCK_USERS.push(newUser);
                    loadTeamMembers(); // Refresh list in settings
                     // Refresh team members view if active
                     if(currentFeature === 'team-members-view' && typeof window.initializeTeamMembersFeature === 'function') { // Use global init function check
                         const container = document.getElementById('featureSectionsContainer');
                         loadTeamMembers(container);
                     }
                    loadDashboardStats();
                    showToast(`Invitation sent to ${email}.`, 'success');
                    if (inviteButton) { inviteButton.disabled = false; inviteButton.innerHTML = 'Invite'; }
                    if (emailInput) emailInput.value = ''; if (roleInput) roleInput.value = 'member';
                 }, 1000);
             }

            function openMemberModal(memberId = null) { // Handles both Add and Edit
                 const isEditing = memberId !== null;
                 const member = isEditing ? MOCK_USERS.find(u => u.id === memberId) : null;

                 if (isEditing && !member) {
                     showToast("Error: Member not found.", "error");
                     return;
                 }

                 memberForm.reset(); // Clear previous data
                 document.getElementById('memberId').value = isEditing ? member.id : '';
                 document.getElementById('memberEmail').readOnly = isEditing; // Can't edit email

                 if (isEditing) {
                     const nameParts = member.name.split(' ');
                     document.getElementById('memberFirstName').value = nameParts[0] || '';
                     document.getElementById('memberLastName').value = nameParts.slice(1).join(' ') || '';
                     document.getElementById('memberEmail').value = member.email;
                     document.getElementById('memberRole').value = member.role;
                     document.getElementById('memberTitle').value = member.title || '';
                     document.getElementById('memberDepartment').value = member.department || '';
                     memberModalTitle.textContent = `Edit ${member.name}`;
                     saveMemberBtn.textContent = 'Save Changes';
                 } else {
                     // Add Mode - Fields are cleared by reset()
                     memberModalTitle.textContent = `Add New Member`;
                     saveMemberBtn.textContent = 'Add Member';
                     document.getElementById('memberEmail').readOnly = false; // Allow email input for new member
                 }
                 memberModalInstance?.show(); // Use Bootstrap instance
             }

             function handleSaveMember(event) {
                event.preventDefault();
                const memberId = document.getElementById('memberId').value ? parseInt(document.getElementById('memberId').value) : null;
                const firstName = document.getElementById('memberFirstName').value.trim();
                const lastName = document.getElementById('memberLastName').value.trim();
                const email = document.getElementById('memberEmail').value.trim();
                const role = document.getElementById('memberRole').value;
                const title = document.getElementById('memberTitle').value.trim();
                const department = document.getElementById('memberDepartment').value.trim();
                const isEditing = memberId !== null;

                if (!firstName || !lastName || !email || !role) {
                    showToast('Please fill in First Name, Last Name, Email, and Role.', 'error');
                    return;
                }
                 if (!/\S+@\S+\.\S+/.test(email)) {
                     showToast('Please enter a valid email address.', 'error');
                    return;
                 }
                 // Prevent duplicate email on add (unless editing self)
                 if (!isEditing && MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                     showToast('A user with this email already exists.', 'error');
                     return;
                 }

                const memberData = {
                    id: isEditing ? memberId : Date.now(), // Generate new ID if adding
                    name: `${firstName} ${lastName}`,
                    email: email,
                    role: role,
                    title: title,
                    department: department,
                    // Preserve existing phone/avatar/2fa or set defaults
                    phone: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.phone || '' : '',
                    avatar: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.avatar || '' : '',
                    initials: (firstName?.[0] || '') + (lastName?.[0] || ''),
                    twoFaEnabled: isEditing ? MOCK_USERS.find(u=>u.id === memberId)?.twoFaEnabled || false : false
                };
                 // Update initials if name changed and no avatar
                 if (!memberData.avatar) {
                     memberData.initials = (firstName?.[0] || '') + (lastName?.[0] || '');
                 }


                console.log(`${isEditing ? 'Saving' : 'Adding'} member:`, memberData);
                showToast(`${isEditing ? 'Saving' : 'Adding'} member...`, 'info');

                setTimeout(() => {
                    if (isEditing) {
                        const memberIndex = MOCK_USERS.findIndex(u => u.id === memberId);
                        if (memberIndex > -1) {
                            MOCK_USERS[memberIndex] = memberData;
                            // If editing current user, update the main UI immediately
                            if (currentUser && currentUser.id === memberId) {
                                currentUser = { ...memberData }; // Update global current user state
                                updateUserUI();
                            }
                         } else { console.error("Error finding member to edit"); }
                    } else {
                        MOCK_USERS.push(memberData);
                    }

                    loadTeamMembers(); // Refresh settings list
                     if(currentFeature === 'team-members-view' && typeof window.initializeTeamMembersFeature === 'function') {
                         const container = document.getElementById('featureSectionsContainer');
                         loadTeamMembers(container);
                     } // Refresh feature view if active
                    loadDashboardStats(); // Update team count
                    showToast(`Member ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
                    memberModalInstance?.hide(); // Use Bootstrap instance
                 }, 1000);
             }

            function handleRemoveMember(memberId) {
                 const memberToRemove = MOCK_USERS.find(u => u.id === memberId);
                 showConfirmModal('Remove Team Member', `Are you sure you want to remove ${memberToRemove?.name || 'this member'}?`, () => {
                    showToast(`Removing ${memberToRemove?.name || 'member'}...`, 'info');
                    setTimeout(() => {
                        MOCK_USERS = MOCK_USERS.filter(u => u.id !== memberId);
                        loadTeamMembers(); // Refresh settings list
                         if(currentFeature === 'team-members-view' && typeof window.initializeTeamMembersFeature === 'function') {
                             const container = document.getElementById('featureSectionsContainer');
                             loadTeamMembers(container);
                         } // Refresh feature view
                        loadDashboardStats(); // Update dashboard stats
                         if (currentFeature === 'employee-scheduling' && typeof window.renderSchedule === 'function') { const scheduleTableBody = document.getElementById('scheduleTableBody'); if(scheduleTableBody) { window.renderSchedule(currentScheduleWeekOffset); } }
                        showToast('Team member removed.', 'success');
                    }, 500);
                 }, 'btn-danger');
            }

            // --- Employee Scheduling (Placeholder Function) ---
            window.initializeEmployeeScheduleLogic = function(container) {
                 // Reuse the previously defined function
                 return initializeEmployeeScheduleLogic(container);
            };


            // --- Projects Feature (Placeholder Function) ---
             window.initializeProjectsFeature = function(container) {
                 // Reuse the previously defined function
                 return initializeProjectsFeature(container);
             };


            // --- Utility Functions ---
            function timeAgo(timestamp) { if (!(timestamp instanceof Date)) { const date = new Date(timestamp); if (isNaN(date.getTime())) return ''; timestamp = date; } const now = new Date(); const secondsPast = (now.getTime() - timestamp.getTime()) / 1000; if (secondsPast < 10) { return 'Just now'; } if (secondsPast < 60) { return parseInt(secondsPast) + 's ago'; } if (secondsPast < 3600) { return parseInt(secondsPast / 60) + 'm ago'; } if (secondsPast < 3600 * 24) { return parseInt(secondsPast / 3600) + 'h ago'; } return formatDateForDisplay(timestamp); }
            function formatDateForDisplay(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; const year = date.getFullYear(); const month = date.getMonth() + 1; const day = date.getDate(); const monthPadded = String(month).padStart(2, '0'); const dayPadded = String(day).padStart(2, '0'); const monthName = date.toLocaleDateString(undefined, { month: 'short' }); try { switch (dateFormat) { case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`; case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`; case 'Month D, YYYY': return `${monthName} ${day}, ${year}`; case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`; } } catch (e) { console.error("Error formatting date:", e); return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`; } }
            function formatFullDateTime(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const formattedDate = formatDateForDisplay(date); const timeFormat = localStorage.getItem('timeFormat') || '12h'; const options = { hour: 'numeric', minute: 'numeric', hour12: timeFormat === '12h' }; try { const formattedTime = date.toLocaleTimeString(undefined, options); return `${formattedDate}, ${formattedTime}`; } catch (e) { console.error("Error formatting time:", e); return formattedDate; } }
            function generateMockActivities(count, baseTimestampMillis) { const nowMillis = baseTimestampMillis || Date.now(); const newActivities = []; let users = MOCK_USERS.map(u => u.name.split(' ')[0]); if (users.length === 0) users.push('System'); const actions = ['updated profile', 'completed task', 'added project', 'commented on task', 'uploaded file', 'joined team']; const icons = ['fa-user-edit', 'fa-check-circle', 'fa-plus-circle', 'fa-comment', 'fa-upload', 'fa-user-plus']; const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`); const projects = MOCK_PROJECTS_DATA.map(p => `'${p.name}'`); const files = ['doc.pdf', 'img.png', 'sheet.xlsx', 'pres.pptx']; for (let i = 0; i < count; i++) { const user = users[Math.floor(Math.random() * users.length)]; const actionIndex = Math.floor(Math.random() * actions.length); let message = `${user} ${actions[actionIndex]}`; if (actions[actionIndex].includes('task') && tasks.length > 0) { message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`; } else if (actions[actionIndex].includes('project') && projects.length > 0) { message += ` ${projects[Math.floor(Math.random() * projects.length)]}`; } else if (actions[actionIndex].includes('file') && files.length > 0) { message += ` ${files[Math.floor(Math.random() * files.length)]}`; } let timestampMillis; if (count === 1) { timestampMillis = nowMillis - Math.random() * 1000 * 10; } else { timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.5 + 300000); } timestampMillis = Math.min(timestampMillis, nowMillis); newActivities.push({ id: nowMillis + i + Math.floor(Math.random()*1000), icon: icons[actionIndex], message: message, timestamp: new Date(timestampMillis), isNew: false }); } return count > 1 ? newActivities.sort((a, b) => b.timestamp - a.timestamp) : newActivities; }
            function generateMockNotifications(count, baseTimestampMillis) { const nowMillis = baseTimestampMillis || Date.now(); const newNotifications = []; const types = [ { msg: 'New task assigned:', icon: 'fa-tasks', type: 'task' }, { msg: 'Project deadline approaching:', icon: 'fa-clock', type: 'project' }, { msg: 'Mentioned you:', icon: 'fa-comment-dots', type: 'comment' }, { msg: 'System update:', icon: 'fa-info-circle', type: 'system' }, { msg: 'File shared:', icon: 'fa-file-alt', type: 'file' }, ]; const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`); const projects = MOCK_PROJECTS_DATA.map(p => `'${p.name}'`); let users = MOCK_USERS.map(u => u.name.split(' ')[0]); if (users.length === 0) users.push('System'); const files = ['report.docx', 'logo.svg', 'data.csv']; for (let i = 0; i < count; i++) { const typeInfo = types[Math.floor(Math.random() * types.length)]; let message = typeInfo.msg; if (typeInfo.type === 'task' && tasks.length > 0) message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`; else if (typeInfo.type === 'project' && projects.length > 0) message += ` ${projects[Math.floor(Math.random() * projects.length)]}`; else if (typeInfo.type === 'comment' && users.length > 0) message += ` by ${users[Math.floor(Math.random() * users.length)]}`; else if (typeInfo.type === 'file' && files.length > 0 && users.length > 0) message += ` ${files[Math.floor(Math.random() * files.length)]} by ${users[Math.floor(Math.random() * users.length)]}`; let timestampMillis; if (count === 1) { timestampMillis = nowMillis - Math.random() * 1000 * 15; } else { timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.8 + 180000); } timestampMillis = Math.min(timestampMillis, nowMillis); newNotifications.push({ id: nowMillis + i + 10000 + Math.floor(Math.random()*1000), icon: typeInfo.icon, message: message, timestamp: new Date(timestampMillis), unread: count === 1 ? true : Math.random() > 0.3 }); } return count > 1 ? newNotifications.sort((a, b) => b.timestamp - a.timestamp) : newNotifications; }
             // Make showConfirmModal globally accessible
             window.showConfirmModal = function(title, message, onConfirm, buttonClass = 'btn-danger') {
                 confirmTitle.textContent = title; confirmMessage.innerHTML = message; confirmCallback = onConfirm;
                 confirmBtn.className = 'btn'; // Reset classes
                 confirmBtn.classList.add(buttonClass); // Add desired class
                 confirmModalInstance?.show(); // Use Bootstrap instance
             }
             function hideConfirmModal() { confirmModalInstance?.hide(); confirmCallback = null; } // Use Bootstrap instance
             function showSuccessMessage(message) { successMessageText.textContent = message; successMessage.classList.add('show'); setTimeout(() => { successMessage.classList.remove('show'); }, 3000); }
             // Make showToast globally accessible for features
             window.showToast = function(message, type = 'info') { if (!showToasts && type !== 'error') { console.log("Toast suppressed:", message); return; } toastMessage.textContent = message; toastMessage.className = 'toast'; if (type === 'success') { toastMessage.classList.add('success'); } else if (type === 'error') { toastMessage.classList.add('error'); } toastMessage.classList.add('show'); setTimeout(() => { toastMessage.classList.remove('show'); }, 3000); }
              // Make date formatting function global
             window.formatDateForDisplay = formatDateForDisplay;
             window.formatFullDateTime = formatFullDateTime;
             window.timeAgo = timeAgo;
             window.getCurrentDate = getCurrentDate; // Make globally available if needed


            // --- Start Application ---
            initDashboard();
        });
    </script>
</body>
</html>

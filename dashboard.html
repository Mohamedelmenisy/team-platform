<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <!-- !!! CSS الخاص بجدول الموظفين - يجب أن يكون الملف موجوداً بنفس المجلد !!! -->
    <link rel="stylesheet" href="employee-scheduling.css">
    <!-- <link rel="stylesheet" href="projects.css"> -->

    <style>
        /* --- أنماط الداشبورد الأساسية (نسخة كاملة من finaaaal.txt) --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a; --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2); --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444; --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem; --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554); --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46); --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8); --welcome-bg-current: var(--welcome-bg-1); --hc-text: #000000; --hc-background: #ffffff; --hc-primary: #0000ff; --hc-secondary: #008000; --hc-link: #0000ee; --hc-border: #000000; --text-color: var(--dark); --schedule-weekend-bg: #f3f4f6; --schedule-weekend-text: #9ca3af;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        body.high-contrast { /* ... (High Contrast Styles) ... */ }
        .sidebar { /* ... (Sidebar Styles) ... */ }
        .main-content { /* ... (Main Content Styles) ... */ }
        .top-nav { /* ... (Top Nav Styles) ... */ }
        .search-bar { /* ... (Search Bar Styles) ... */ }
        .user-menu { /* ... (User Menu Styles) ... */ }
        .content-area { /* ... (Content Area Styles) ... */ }
        .welcome-section { /* ... (Welcome Section Styles) ... */ }
        .stats-section { /* ... (Stats Section Styles) ... */ }
        .activity-section { /* ... (Activity Section Styles) ... */ }
        .content-section { /* ... (Generic Content Section Styles - Default hidden) ... */ display: none; animation: fadeInContent 0.4s ease-in-out; }
        .content-section.active { display: block; } /* Show active section */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-main-header { /* ... (Section Header Styles) ... */ }
        .profile-header-text { /* ... (Profile Styles) ... */ }
        .profile-avatar-section { /* ... */ }
        .data-form { /* ... (Form Styles) ... */ }
        .form-group { /* ... */ }
        .form-control { /* ... */ }
        .form-actions { /* ... */ }
        .btn { /* ... (Button Styles) ... */ }
        .settings-tabs { /* ... (Settings Styles) ... */ }
        .settings-tab { /* ... */ }
        .settings-panel { /* ... */ }
        .settings-subsection { /* ... */ }
        .setting-item { /* ... */ }
        .switch { /* ... (Switch Toggle Styles) ... */ }
        .team-management { /* ... (Team Management Styles) ... */ }
        .team-list { /* ... */ }
        .team-member-card { /* ... */ }
        .member-avatar { /* ... */ }
        .member-details { /* ... */ }
        .member-role { /* ... */ }
        .member-actions { /* ... */ }
        .add-member-form { /* ... */ }
        /* ... (Theme Styles - Light, Dark, Blue) ... */
        body.light-theme { /* ... */ } body.dark-theme { /* ... */ } body.blue-theme { /* ... */ }
        .theme-options-container { /* ... (Theme Selection Styles) ... */ }
        .theme-option { /* ... */ }
        .two-fa-status { /* ... (2FA Styles) ... */ }
        .two-fa-setup { /* ... */ }
        .qr-code-placeholder { /* ... */ }
        .two-fa-actions { /* ... */ }
        .danger-zone-item { /* ... (Danger Zone Styles) ... */ }
        .notifications-modal { /* ... (Notifications Modal Styles) ... */ }
        .notifications-container { /* ... */ }
        .confirm-modal { /* ... (Confirm Modal Styles) ... */ }
        .confirm-container { /* ... */ }
        .success-message { /* ... (Success Message Styles) ... */ }
        .back-button { /* ... (Back Button Styles) ... */ }
        #notificationSound { display: none; } .d-none { display: none !important; } .placeholder-content { /* ... (Placeholder Styles) ... */ }
        .modal { /* ... (Generic Modal Styles) ... */ }
        .toast { /* ... (Generic Toast Styles) ... */ }
        /* ... (Responsive Styles @media) ... */
        .checkbox-group { /* ... (Checkbox Group Styles) ... */ }
        .settings-link { /* ... (Settings Link Styles) ... */ }
        .sidebar-toggle { /* ... (Hamburger Styles) ... */ display: none; } /* Hidden by default on desktop */
        @media (max-width: 992px) { .sidebar-toggle { display: block; } /* Show on mobile */ }
        /* --- نهاية أنماط الداشبورد الأساسية --- */

         /* Override to ensure active section is shown */
         .content-section.active {
             display: block !important;
         }

    </style>
</head>
<body class=""> <!-- Theme class added by JS -->

    <!-- Audio, Toast, Success elements -->
    <audio id="notificationSound" preload="auto"><source src="assets/notification.mp3" type="audio/mpeg"></audio>
    <div class="toast" id="toastMessage">Toast message</div>
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i><span id="successMessageText">Success!</span></div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar"><i class="fas fa-bars"></i></button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"> <div class="logo"> <i class="fas fa-users-cog logo-icon"></i> <span>TeamFlow</span> </div> <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar"> <i class="fas fa-times"></i> </button> </div>
        <div class="sidebar-menu">
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reportsAnalytics" class="menu-item" data-feature="reportsAnalytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#teamMembersView" class="menu-item" data-feature="teamMembersView"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <a href="#fileSharing" class="menu-item" data-feature="fileSharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#dataManagement" class="menu-item" data-feature="dataManagement"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#projectTracking" class="menu-item" data-feature="projectTracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#taskManagement" class="menu-item" data-feature="taskManagement"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <div class="menu-title">Team Tools</div>
             <a href="#employeeScheduling" class="menu-item" data-feature="employeeScheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#teamCalendar" class="menu-item" data-feature="teamCalendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#deadlineTracking" class="menu-item" data-feature="deadlineTracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#innovationHub" class="menu-item" data-feature="innovationHub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
        <div class="connection-status"> <div class="status-dot"></div> <span>Online</span> </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Top Nav -->
        <nav class="top-nav"> <!-- ... (Top Nav HTML as in finaaaal.txt) ... --> </nav>

        <!-- Content Area -->
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"> <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span> </div>

            <!-- STATIC Dashboard Section -->
            <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection"> <!-- ... (Welcome content) ... --> </div>
                 <div class="stats-section" id="statsSection"> <!-- Populated by JS --> </div>
                 <div class="activity-section"> <!-- ... (Activity content structure) ... --> <ul class="activity-list" id="activityList"></ul> </div>
            </div>

            <!-- STATIC Profile Section -->
            <div id="profileContent" class="content-section"> <!-- ... (Profile HTML structure) ... --> </div>

             <!-- STATIC Settings Section -->
            <div id="settingsContent" class="content-section">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs"> <!-- ... (Settings Tabs) ... --> </div>
                 <!-- Settings Panels (Empty initially, populated by JS) -->
                 <div class="settings-panel active" id="preferencesPanel"> <p>Loading Preferences...</p> </div>
                 <div class="settings-panel" id="accountPanel"> <p>Loading Account Settings...</p> </div>
                 <div class="settings-panel" id="securityPanel"> <p>Loading Security Settings...</p> </div>
                 <div class="settings-panel" id="notificationsPanel"> <p>Loading Notifications Settings...</p> </div>
                 <div class="settings-panel" id="teamPanel"> <p>Loading Team Management...</p> </div>
                 <div class="settings-panel" id="collaborationPanel"> <p>Loading Collaboration Settings...</p> </div>
                 <div class="settings-panel" id="dangerPanel"> <p>Loading Danger Zone...</p> </div>
            </div>

            <!-- ======================================= -->
            <!-- == EMBEDDED Employee Scheduling Section == -->
            <!-- ======================================= -->
            <div id="employeeSchedulingContent" class="content-section feature-section">
                <!-- HTML الخاص بـ Employee Scheduling (من الإجابة السابقة) -->
                 <div class="employee-schedule-section">
                     <div class="schedule-page-header section-main-header">
                         <h2 class="schedule-page-title section-main-title">Employee Scheduling</h2>
                         <button class="btn btn-primary" id="saveScheduleBtn" style="display: none;"> <i class="fas fa-save"></i> Save Schedule </button>
                     </div>
                     <div class="schedule-controls">
                         <button class="btn btn-outline" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev</button>
                         <span id="weekDisplay" style="margin: 0 1rem; font-weight: 500;">Loading...</span>
                         <button class="btn btn-outline" id="nextWeekBtn">Next <i class="fas fa-chevron-right"></i></button>
                         <button class="btn btn-success" id="sendRemindersBtn" style="margin-left: auto; display: none;"> <i class="fas fa-envelope"></i> Send Reminders </button>
                         <button class="btn btn-secondary" id="addNewEmployeeBtn_schedule" style="display: none;"> <i class="fas fa-user-plus"></i> Add Employee </button>
                     </div>
                     <div class="schedule-container">
                         <table class="schedule-table">
                             <thead> <tr> <th>Employee</th> <!-- Day headers added by JS --> </tr> </thead>
                             <tbody id="scheduleTableBody"> <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td></tr> </tbody>
                         </table>
                     </div>
                     <!-- Shift Edit Modal (Scoped within this section) -->
                     <div class="modal" id="editShiftModal">
                         <div class="modal-content">
                             <div class="modal-header">
                                 <h3 class="modal-title" id="editShiftModalTitle">Edit Shift</h3>
                                 <button class="close-modal" data-close-modal>×</button>
                             </div>
                             <form id="editShiftForm">
                                 <input type="hidden" id="editShiftEmployeeId">
                                 <input type="hidden" id="editShiftDayIndex">
                                 <input type="hidden" id="editShiftWeekOffset">
                                 <div class="form-group">
                                     <label for="shiftEmployeeNameDisplay">Employee</label>
                                     <input type="text" id="shiftEmployeeNameDisplay" class="form-control" readonly style="background-color: var(--light-gray); cursor: default;">
                                 </div>
                                 <div class="form-group">
                                     <label for="shiftTypeSelect">Shift Type</label>
                                     <select id="shiftTypeSelect" class="form-control">
                                         <option value="morning">Morning (9AM-5PM)</option>
                                         <option value="afternoon">Afternoon (12PM-8PM)</option>
                                         <option value="night">Night (8PM-4AM)</option>
                                         <option value="off">Day Off</option>
                                         <option value="sick">Sick Leave</option>
                                         <option value="vacation">Vacation</option>
                                     </select>
                                 </div>
                                 <div class="form-actions">
                                      <button type="button" class="btn btn-danger" id="deleteShiftBtn_modal" style="margin-right: auto;">Delete Shift</button>
                                      <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                                      <button type="submit" class="btn btn-primary">Save Shift</button>
                                 </div>
                             </form>
                         </div>
                     </div>
                 </div>
            </div> <!-- End #employeeSchedulingContent -->

            <!-- === Other Embedded Feature Sections (Placeholders) === -->
            <div id="projectsContent" class="content-section feature-section"><h2>Projects (Placeholder)</h2></div>
            <div id="reportsAnalyticsContent" class="content-section feature-section"><h2>Reports (Placeholder)</h2></div>
            <div id="teamMembersViewContent" class="content-section feature-section"><h2>Team Members View (Placeholder)</h2></div>
            <div id="fileSharingContent" class="content-section feature-section"><h2>File Sharing (Placeholder)</h2></div>
            <div id="dataManagementContent" class="content-section feature-section"><h2>Data Management (Placeholder)</h2></div>
            <div id="projectTrackingContent" class="content-section feature-section"><h2>Project Tracking (Placeholder)</h2></div>
            <div id="taskManagementContent" class="content-section feature-section"><h2>Task Management (Placeholder)</h2></div>
            <div id="teamCalendarContent" class="content-section feature-section"><h2>Team Calendar (Placeholder)</h2></div>
            <div id="deadlineTrackingContent" class="content-section feature-section"><h2>Deadline Tracking (Placeholder)</h2></div>
            <div id="innovationHubContent" class="content-section feature-section"><h2>Innovation Hub (Placeholder)</h2></div>

        </div> <!-- End .content-area -->
    </main>

    <!-- Modals -->
    <div class="notifications-modal" id="notificationsModal"> <!-- Structure populated by JS --> </div>
    <div class="confirm-modal" id="confirmModal"> <!-- Structure with placeholders -->
         <div class="confirm-container"> <h3 class="confirm-title" id="confirmTitle">Confirm</h3> <div class="confirm-message" id="confirmMessage">Are you sure?</div> <div class="confirm-actions"> <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button> <button class="btn btn-danger" id="confirmBtn">Confirm</button> </div> </div>
    </div>
    <div class="modal" id="editMemberModal"> <!-- Edit Member Modal Structure (Populated by JS) --> </div>

    <script>
        // ==========================================
        //          DASHBOARD CORE SCRIPT
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM References ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const navLinks = document.querySelectorAll('.menu-item, .dropdown-item[data-feature]');
            const allContentSections = document.querySelectorAll('.content-area > .content-section');
            const backButton = document.getElementById('backButton');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const logoutLink = document.getElementById('logoutLink');
            const toastMessage = document.getElementById('toastMessage');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const notificationSound = document.getElementById('notificationSound');
            // Add references for static content if needed (e.g., welcome card elements)
            const welcomeNameEl = document.getElementById('welcomeName');
            const userInfoNameEl = document.getElementById('userInfoName');
            const userInfoRoleTitleEl = document.getElementById('userInfoRoleTitle');
            const userEmailEl = document.getElementById('userEmail'); // In welcome section
            const userAvatarEl = document.getElementById('userAvatar'); // Top nav
            const profileAvatarWelcomeEl = document.getElementById('profileAvatar'); // Welcome section

            // --- State Variables ---
            let currentUser = null;
            let teamMembers = []; // Holds the list of users
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let confirmCallback = null;
            let showToasts = true;
            let playSounds = true;
            let featureInitialized = {}; // Track component initialization

            // --- Mock Data (Replace with API calls) ---
            const MOCK_USERS_DATA = [ { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin' }, { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'YA', role: 'supervisor' }, { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'EL', role: 'senior' }, { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', title: 'Junior Designer', department: 'Design', phone: '+20155444333', avatar: '', initials: 'BB', role: 'member' }, { id: 5, name: 'Nada Mahmoud', email: 'nada@example.com', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'NM', role: 'member' }, ];

            // --- Initialization ---
            function initDashboard() {
                currentUser = MOCK_USERS_DATA.find(u => u.role === 'admin') || MOCK_USERS_DATA[0];
                teamMembers = MOCK_USERS_DATA;
                if (!currentUser) { console.error("Fatal: No current user."); return; }

                applyStoredPreferences();
                updateUserUI();
                setupEventListeners();
                handleInitialNavigation();
                setupResponsiveSidebar();
                 // Load initial data specifically for the dashboard view
                loadInitialDashboardData();
            }

             // --- Initial Data Loading for Dashboard ---
             function loadInitialDashboardData() {
                console.log("Loading initial dashboard data (Stats, Activity)...");
                 loadDashboardStats();
                 loadRecentActivities();
                 // Load notifications count for badge
                 loadNotifications();
             }

            // --- UI Update & Preferences ---
            function updateUserUI() {
                 if (!currentUser) return;
                 const name = currentUser.name || 'User';
                 const initials = currentUser.initials || '?';
                 const avatarUrl = currentUser.avatar;

                 // Top Nav
                 document.getElementById('userName').textContent = name;
                 userAvatarEl.textContent = initials;
                 if (avatarUrl) { userAvatarEl.style.backgroundImage = `url(${avatarUrl})`; userAvatarEl.textContent = ''; }
                 else { userAvatarEl.style.backgroundImage = 'none'; }

                 // Welcome Section
                 if (welcomeNameEl) welcomeNameEl.textContent = name.split(' ')[0];
                 if (userInfoNameEl) userInfoNameEl.textContent = name;
                 if (userEmailEl) userEmailEl.textContent = currentUser.email || 'No Email';
                 if (userInfoRoleTitleEl) {
                     userInfoRoleTitleEl.textContent = capitalizeFirstLetter(currentUser.role || 'Member');
                     userInfoRoleTitleEl.className = `user-info-title role-${currentUser.role || 'member'}`;
                 }
                 if (profileAvatarWelcomeEl) {
                    profileAvatarWelcomeEl.textContent = initials;
                    if (avatarUrl) { profileAvatarWelcomeEl.style.backgroundImage = `url(${avatarUrl})`; profileAvatarWelcomeEl.textContent = ''; }
                    else { profileAvatarWelcomeEl.style.backgroundImage = 'none'; }
                 }

                 // Profile Form (if it exists - check performed in its handler)
                 updateProfileForm();

                 // Settings (Account email, 2FA status etc. updated when settings panel is initialized/shown)
                 applyRBAC(); // Apply role-based visibility rules
             }

             function applyRBAC() {
                // Controls visibility based on currentUser.role
                 const isAdmin = currentUser.role === 'admin';
                 const isSupervisor = currentUser.role === 'supervisor';

                 // Settings Tabs
                 document.getElementById('teamSettingsTab')?.style.display = (isAdmin || isSupervisor) ? 'flex' : 'none';
                 document.getElementById('dangerZoneTab')?.style.display = isAdmin ? 'flex' : 'none';

                 // Add more controls here as needed (e.g., buttons within sections)
                 // This function might be called again if role changes or UI re-renders.
             }


             function updateProfileForm() {
                 const profileForm = document.getElementById('profileForm');
                 if (!profileForm || !currentUser) return; // Only run if profile section exists and user is loaded

                 const nameParts = currentUser.name.split(' ');
                 document.getElementById('firstName').value = nameParts[0] || '';
                 document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
                 document.getElementById('fullNameDisplay').value = currentUser.name;
                 document.getElementById('jobTitle').value = currentUser.title || '';
                 document.getElementById('email').value = currentUser.email || '';
                 document.getElementById('phone').value = currentUser.phone || '';
                 document.getElementById('department').value = currentUser.department || '';

                 // Update large avatar preview
                 const profileAvatarLarge = document.getElementById('profileAvatarLarge');
                 if (profileAvatarLarge) {
                     profileAvatarLarge.textContent = currentUser.initials || '?';
                     if (currentUser.avatar) {
                         profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                         profileAvatarLarge.textContent = '';
                     } else {
                         profileAvatarLarge.style.backgroundImage = 'none';
                     }
                 }
             }

            function applyStoredPreferences() { /* ... */
                const storedTheme = localStorage.getItem('theme') || 'system';
                setTheme(storedTheme);
                 // Load other prefs like contrast, sounds, toasts
                 const storedContrast = localStorage.getItem('highContrast') === 'true';
                 setContrast(storedContrast); // Apply contrast class
                 const storedSoundPref = localStorage.getItem('playSounds');
                 playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true');
                 const storedToastPref = localStorage.getItem('showToasts');
                 showToasts = storedToastPref === null ? true : (storedToastPref === 'true');

                 // Update toggles if settings panel is already loaded (e.g., on page refresh)
                 initializeSettingsPanels(); // Make sure settings UI is populated before updating toggles
                 const highContrastToggle = document.getElementById('highContrastToggle');
                 const soundToggle = document.getElementById('soundToggle');
                 const toastToggle = document.getElementById('toastToggle');
                 if(highContrastToggle) highContrastToggle.checked = storedContrast;
                 if(soundToggle) soundToggle.checked = playSounds;
                 if(toastToggle) toastToggle.checked = showToasts;
            }

            function setTheme(theme) { /* ... (Apply theme class, save to localStorage) ... */
                document.body.className = ''; // Clear previous
                 let finalTheme = theme;
                 if (theme === 'system') {
                     const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                     finalTheme = prefersDark ? 'dark' : 'light';
                 }
                 document.body.classList.add(`${finalTheme}-theme`);
                 // Re-apply contrast if needed after theme change
                  if (localStorage.getItem('highContrast') === 'true') {
                     document.body.classList.add('high-contrast');
                  }
                 localStorage.setItem('theme', theme); // Save user's choice ('system', 'light', or 'dark')
                  // Update UI selector
                 const themeOptions = document.querySelectorAll('.theme-option');
                 themeOptions.forEach(opt => { opt.classList.toggle('selected', opt.dataset.theme === theme); });
            }

             function setContrast(enabled) {
                 document.body.classList.toggle('high-contrast', enabled);
                 localStorage.setItem('highContrast', enabled);
             }

             function applyLanguage(lang) { /* ... (Simulate language change) ... */ }
             function applyDateTimeFormat(timeFormat, dateFormat) { /* ... (Update localStorage, re-render dates) ... */ }
             function applyToastPreference(enabled) { showToasts = enabled; localStorage.setItem('showToasts', enabled); }
             function applySoundPreference(enabled) { playSounds = enabled; localStorage.setItem('playSounds', enabled); }

            // --- Navigation & Content Activation ---
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId} ${settingsTab ? '/ '+settingsTab : ''}`);

                 // --- RBAC Check ---
                 if (featureId === 'employeeScheduling' && !['admin', 'supervisor'].includes(currentUser.role)) { showToast("Access Denied.", "error"); setActiveFeature('dashboard', null, true); return; }
                 if (featureId === 'settings' && settingsTab === 'team' && !['admin', 'supervisor'].includes(currentUser.role)) { showToast("Access Denied.", "error"); setActiveFeature('settings', 'preferences', true); return; }
                 if (featureId === 'settings' && settingsTab === 'danger' && currentUser.role !== 'admin') { showToast("Access Denied.", "error"); setActiveFeature('settings', 'preferences', true); return; }


                currentFeature = featureId;
                currentSettingsTab = featureId === 'settings' ? (settingsTab || 'preferences') : null;

                // Update Menu
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('data-feature') === featureId);
                });

                // Show/Hide Sections
                let sectionActivated = false;
                allContentSections.forEach(section => {
                    const sectionId = section.id;
                    const expectedId = `${featureId}Content`;

                    if (sectionId === expectedId) {
                        section.classList.add('active');
                        section.style.display = 'block';
                        sectionActivated = true;

                        // Call Initializer if needed
                        const initializerKey = featureId; // Use featureId directly as key
                        if (!featureInitialized[initializerKey]) {
                             // Make sure settings panels are populated before calling initializers within them
                            if(featureId === 'settings') {
                                initializeSettingsPanels(); // Ensure settings HTML is there
                            }
                             // Call specific initializer for the feature section
                             const initializerFunctionName = `initialize${capitalizeFirstLetter(toCamelCase(featureId))}`;
                            if (typeof window[initializerFunctionName] === 'function') {
                                try {
                                    console.log(`Calling initializer: ${initializerFunctionName}`);
                                    window[initializerFunctionName](); // Call component initializer
                                    featureInitialized[initializerKey] = true;
                                } catch (e) { console.error(`Error initializing ${featureId}:`, e); }
                            } else if (featureId !== 'dashboard' && featureId !== 'profile' && featureId !== 'settings') {
                                // Only warn for actual feature sections, not static ones
                                console.warn(`Initializer ${initializerFunctionName} not found for ${featureId}.`);
                            }
                        }

                        // Special handling for settings
                        if (featureId === 'settings') {
                            initializeSettingsPanels(); // Ensure panels are ready
                             activateSettingsTab(currentSettingsTab);
                        }
                         // Update profile form data when shown
                         if (featureId === 'profile') {
                             updateProfileForm();
                         }

                    } else {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    }
                });

                if (!sectionActivated) { console.warn(`Section ${featureId}Content not found.`); setActiveFeature('dashboard', null, true); return; }

                // Update Back Button
                if (backButton) { backButton.style.display = featureId !== 'dashboard' ? 'flex' : 'none'; }

                // Update History
                if (!skipHistory) { updateBrowserHistory(featureId, currentSettingsTab); }

                closeMobileSidebar();
            } // End setActiveFeature


            function activateSettingsTab(tabId) {
                 // Basic validation
                 if (!document.getElementById(`${tabId}Panel`)) {
                     console.warn(`Settings panel not found for tab: ${tabId}. Defaulting to preferences.`);
                     tabId = 'preferences';
                 }
                 console.log("Activating settings tab:", tabId);
                 currentSettingsTab = tabId;

                 document.querySelectorAll('.settings-tab').forEach(tab => {
                     tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
                 });
                 document.querySelectorAll('.settings-panel').forEach(panel => {
                     panel.classList.toggle('active', panel.id === `${tabId}Panel`);
                 });

                 // Initialize content if needed (e.g., load team members)
                 const initKey = `settings_${tabId}`; // Unique key per tab
                 if (!featureInitialized[initKey]) {
                    if (tabId === 'team') {
                         loadTeamMembers();
                         featureInitialized[initKey] = true;
                    } else if (tabId === 'security') {
                         update2FA_UI();
                         featureInitialized[initKey] = true;
                    } else if (tabId === 'account') {
                         const accountEmailDisplay = document.getElementById('accountEmail');
                         if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;
                         featureInitialized[initKey] = true;
                    }
                    // Add initialization for other tabs if necessary
                 }
                 // Update history silently for tab change
                 updateBrowserHistory('settings', tabId);
            }

            function updateBrowserHistory(featureId, settingsTab) { /* ... (Same - use replaceState or pushState) ... */
                let hash = `#${featureId}`;
                if (featureId === 'settings' && settingsTab) { hash += `-${settingsTab}`; }
                if (window.location.hash !== hash) { window.history.replaceState({ feature: featureId, tab: settingsTab }, '', hash); }
            }

            function handleInitialNavigation() { /* ... (Same - parse hash, call setActiveFeature) ... */
                const hash = window.location.hash.substring(1);
                let featureId = 'dashboard'; let settingsTab = null;
                if (hash) {
                    if (hash.startsWith('settings-')) {
                        featureId = 'settings';
                        settingsTab = hash.split('-')[1] || 'preferences';
                        if (!document.getElementById(`${settingsTab}Panel`)) settingsTab = 'preferences';
                    } else if (document.getElementById(`${hash}Content`)) { // Check if static/embedded section exists
                        featureId = hash;
                    }
                }
                setActiveFeature(featureId, settingsTab, true);
            }
            window.addEventListener('popstate', handleInitialNavigation);


            // --- Component Initializers ---

            // ==================================================
            // == EMPLOYEE SCHEDULING COMPONENT LOGIC =========
            // ==================================================
            function initializeEmployeeScheduling() {
                if (featureInitialized.employeeScheduling) return;
                console.log("Initializing Employee Scheduling Component...");
                const section = document.getElementById('employeeSchedulingContent');
                if (!section) { console.error("Scheduling section not found!"); return; }

                // --- DOM Elements (Scoped) ---
                const weekDisplay = section.querySelector('#weekDisplay');
                const scheduleTableBody = section.querySelector('#scheduleTableBody');
                const scheduleThead = section.querySelector('.schedule-table thead tr');
                const prevWeekBtn = section.querySelector('#prevWeekBtn');
                const nextWeekBtn = section.querySelector('#nextWeekBtn');
                const saveScheduleBtn = section.querySelector('#saveScheduleBtn');
                const sendRemindersBtn = section.querySelector('#sendRemindersBtn');
                const addNewEmployeeBtn = section.querySelector('#addNewEmployeeBtn_schedule');
                const editShiftModal = section.querySelector('#editShiftModal');
                const editShiftForm = section.querySelector('#editShiftForm');
                const shiftTypeSelect = section.querySelector('#shiftTypeSelect');
                const editShiftEmployeeIdInput = section.querySelector('#editShiftEmployeeId');
                const editShiftDayIndexInput = section.querySelector('#editShiftDayIndex');
                const editShiftWeekOffsetInput = section.querySelector('#editShiftWeekOffset');
                const editShiftModalTitle = section.querySelector('#editShiftModalTitle');
                const shiftEmployeeNameDisplay = section.querySelector('#shiftEmployeeNameDisplay');
                const deleteShiftBtnModal = section.querySelector('#deleteShiftBtn_modal');

                // Check elements
                if (!weekDisplay || !scheduleTableBody || !scheduleThead || !prevWeekBtn || !nextWeekBtn || !editShiftModal || !editShiftForm || !shiftTypeSelect || !deleteShiftBtnModal) {
                    console.error("Schedule Init Error: Missing essential elements."); return;
                }

                // --- State & Data ---
                let currentScheduleWeekOffset = 0;
                let mockScheduleData = {}; // Load/Save from localStorage? For now, in-memory.
                const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const fullDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

                // --- Helpers ---
                const getWeekDates = (offset=0)=>{ /* ... */ const s=getWeekStartDate(offset); const d=[]; for(let i=0;i<7;i++){const dt=new Date(s); dt.setDate(s.getDate()+i); d.push(dt);} return d;};
                const getWeekStartDate = (offset=0)=>{ /* ... */ const t=new Date(); const wd=t.getDay(); const d=t.getDate()-wd+(offset*7); const s=new Date(t); s.setDate(d); s.setHours(0,0,0,0); return s;};
                const formatDate = (d)=>{ /* ... */ if(!(d instanceof Date)) return ''; return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});};
                const getShiftText = (t)=>{ /* ... */ switch(t){case 'morning':return'9A-5P';case 'afternoon':return'12P-8P';case 'night':return'8P-4A';case 'off':return'OFF';case 'sick':return'Sick';case 'vacation':return'Vacation';default:return'N/A';}};

                // --- Rendering ---
                function renderSchedule(weekOffset) {
                    console.log(`Schedule: Render offset ${weekOffset}`);
                    const weekDates = getWeekDates(weekOffset);
                    weekDisplay.textContent = `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
                    // Add date range limits if needed
                    prevWeekBtn.disabled = false;
                    nextWeekBtn.disabled = false;

                    // Header
                    scheduleThead.innerHTML = '<th>Employee</th>';
                    weekDates.forEach((d, i) => { scheduleThead.innerHTML += `<th><div class="day-header"><span class="day-name">${days[i]}</span><span class="day-date">${formatDate(d)}</span></div></th>`; });

                    // Body
                    scheduleTableBody.innerHTML = '';
                    if (!teamMembers || teamMembers.length === 0) { scheduleTableBody.innerHTML = `<tr><td colspan="8">No team members.</td></tr>`; return; }

                    teamMembers.forEach(employee => {
                        const row = scheduleTableBody.insertRow();
                        const nameCell = row.insertCell(); nameCell.className = 'employee-name'; nameCell.textContent = employee.name;
                        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                            const cell = row.insertCell();
                            const key = `${employee.id}-${weekOffset}-${dayIndex}`;
                            const isWknd = dayIndex === 5 || dayIndex === 6;
                            const canEdit = !isWknd && ['admin', 'supervisor'].includes(currentUser.role);
                            let type = mockScheduleData[key];
                            if (!type) type = isWknd ? 'off' : 'morning';
                            if (isWknd) cell.classList.add('weekend-cell');
                            const shiftDiv = document.createElement('div');
                            shiftDiv.className = `shift ${isWknd ? 'shift-weekend-off' : `shift-${type.replace('_', '-')}`}`;
                            shiftDiv.textContent = getShiftText(type);
                            shiftDiv.title = shiftDiv.textContent;
                            if (canEdit) {
                                shiftDiv.classList.add('editable');
                                shiftDiv.dataset.employeeId = employee.id; shiftDiv.dataset.employeeName = employee.name; shiftDiv.dataset.dayIndex = dayIndex; shiftDiv.dataset.weekOffset = weekOffset; shiftDiv.dataset.date = formatDate(weekDates[dayIndex]); shiftDiv.title = `Edit ${employee.name}'s shift`;
                                // Listener attached via delegation
                            }
                            cell.appendChild(shiftDiv);
                        }
                    });
                } // end renderSchedule

                // --- Event Handlers ---
                function handleWeekChange(dir) { currentScheduleWeekOffset += dir; renderSchedule(currentScheduleWeekOffset); }
                function handleSave() { showConfirmModal('Save Schedule', 'Save changes?', () => { console.log("Saving schedule:", mockScheduleData); showToast('Schedule saved.', 'success'); }); }
                function handleReminders() { console.log("Sending reminders..."); showToast('Reminders sent.'); }
                function handleAddEmp() { showToast("Navigate to Settings > Team"); setActiveFeature('settings', 'team'); }

                function handleEditClick(event) {
                    const target = event.target.closest('.shift.editable');
                    if (!target) return;
                    const { employeeId, employeeName, dayIndex, weekOffset, date } = target.dataset;
                    const key = `${employeeId}-${weekOffset}-${dayIndex}`;
                    editShiftEmployeeIdInput.value = employeeId;
                    editShiftDayIndexInput.value = dayIndex;
                    editShiftWeekOffsetInput.value = weekOffset;
                    shiftTypeSelect.value = mockScheduleData[key] || 'morning';
                    shiftEmployeeNameDisplay.value = employeeName;
                    editShiftModalTitle.textContent = `Edit: ${employeeName} on ${fullDays[dayIndex]} (${date})`;
                    deleteShiftBtnModal.style.display = ['admin', 'supervisor'].includes(currentUser.role) ? 'inline-flex' : 'none';
                    editShiftModal?.classList.add('active');
                }

                function handleFormSubmit(event) {
                    event.preventDefault();
                    const key = `${editShiftEmployeeIdInput.value}-${editShiftWeekOffsetInput.value}-${editShiftDayIndexInput.value}`;
                    mockScheduleData[key] = shiftTypeSelect.value;
                    renderSchedule(parseInt(editShiftWeekOffsetInput.value));
                    editShiftModal?.classList.remove('active');
                    showToast("Shift updated.", "success");
                }

                function handleDeleteShift() {
                     showConfirmModal('Delete Shift', `Delete shift for ${shiftEmployeeNameDisplay.value}? (Set to OFF)`, () => {
                        const key = `${editShiftEmployeeIdInput.value}-${editShiftWeekOffsetInput.value}-${editShiftDayIndexInput.value}`;
                        mockScheduleData[key] = 'off';
                        renderSchedule(parseInt(editShiftWeekOffsetInput.value));
                        editShiftModal?.classList.remove('active');
                        showToast("Shift deleted.", "success");
                     }, 'btn-danger');
                }

                // --- Attach Listeners ---
                prevWeekBtn.addEventListener('click', () => handleWeekChange(-1));
                nextWeekBtn.addEventListener('click', () => handleWeekChange(1));
                if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', handleSave);
                if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', handleReminders);
                if (addNewEmployeeBtn) addNewEmployeeBtn.addEventListener('click', handleAddEmp);
                editShiftForm.addEventListener('submit', handleFormSubmit);
                deleteShiftBtnModal.addEventListener('click', handleDeleteShift);
                scheduleTableBody.addEventListener('click', handleEditClick); // Use delegation
                section.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal')?.classList.remove('active')));
                editShiftModal.addEventListener('click', (e) => { if (e.target === editShiftModal) editShiftModal.classList.remove('active'); });

                // --- Initial Render ---
                renderSchedule(currentScheduleWeekOffset);

                // Role-based visibility for buttons
                const canManage = ['admin', 'supervisor'].includes(currentUser.role);
                if (saveScheduleBtn) saveScheduleBtn.style.display = canManage ? 'flex' : 'none';
                if (sendRemindersBtn) sendRemindersBtn.style.display = canManage ? 'flex' : 'none';
                if (addNewEmployeeBtn) addNewEmployeeBtn.style.display = canManage ? 'flex' : 'none';

                console.log("Employee Scheduling Component Initialized.");
                // featureInitialized.employeeScheduling = true; // Mark as initialized - done in setActiveFeature
            } // End initializeEmployeeScheduling

            // ==================================================
            // == Settings Panels Initialization & Logic ========
            // ==================================================
            function initializeSettingsPanels() {
                 if (featureInitialized.settings) return;
                 console.log("Initializing Settings Panels Content...");
                 // (Populate HTML for Preferences, Account, Security, Notifications, Team, Collaboration, Danger Zone)
                 // (Attach specific listeners for buttons/toggles within settings)
                 // Example for Preferences (keep concise):
                 const prefsPanel = document.getElementById('preferencesPanel');
                 if (prefsPanel && prefsPanel.innerHTML.includes('Loading')) { // Check if not already populated
                     prefsPanel.innerHTML = `
                         <div class="settings-subsection"><h4>Appearance</h4><!-- Theme, Contrast options --></div>
                         <div class="settings-subsection"><h4>Localization</h4><!-- Language, Region, Date/Time selects --></div>
                         <div class="settings-subsection"><h4>Notifications & Sounds</h4><!-- Toast, Sound toggles --></div>
                         <div class="form-actions"><button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button></div>
                     `;
                     // Re-attach necessary listeners after innerHTML change
                     attachSettingsPanelListeners('preferences');
                 }
                 // Populate other panels similarly...

                 featureInitialized.settings = true;
                 // Apply stored preferences to the newly added elements
                 applyStoredPreferences();
                 // Activate the correct initial tab
                 activateSettingsTab(currentSettingsTab);
            }

            function attachSettingsPanelListeners(panelType) {
                // Add specific event listeners after a panel's content is loaded/generated
                // Example for preferences:
                if (panelType === 'preferences') {
                     document.querySelectorAll('#preferencesPanel .theme-option').forEach(option => option.addEventListener('click', () => setTheme(option.dataset.theme)));
                     document.getElementById('highContrastToggle')?.addEventListener('change', (e) => setContrast(e.target.checked));
                     document.getElementById('languageSelect')?.addEventListener('change', (e) => applyLanguage(e.target.value));
                     // ... other listeners ...
                     document.getElementById('savePreferencesBtn')?.addEventListener('click', handleSavePreferences);
                 }
                 // Add listeners for other panels (Account, Security, etc.)
                  else if (panelType === 'security') {
                      document.getElementById('changePasswordForm')?.addEventListener('submit', handleChangePassword);
                      document.getElementById('enable2faBtn')?.addEventListener('click', handleEnable2FA);
                      // ... other 2FA listeners ...
                  }
                  else if (panelType === 'team') {
                      document.getElementById('inviteMemberForm')?.addEventListener('submit', handleInviteMember);
                      document.getElementById('teamList')?.addEventListener('click', handleTeamListActions); // Use delegation
                  }
                  // ... etc.
            }

             // Placeholder Handlers for Settings Actions
             function handleSavePreferences() { showConfirmModal('Save Preferences', 'Save changes?', () => { showToast('Preferences saved.', 'success'); }); }
             function handleSaveAccountSettings() { showConfirmModal('Save Account', 'Save changes?', () => { showToast('Account settings saved.', 'success'); }); }
             function handleChangePassword(e) { e.preventDefault(); showConfirmModal('Change Password', 'Confirm change?', () => { showToast('Password changed (simulated).', 'success'); }); }
             function handleSaveSessionSettings() { showConfirmModal('Save Session', 'Save changes?', () => { showToast('Session settings saved.', 'success'); }); }
             function handleSaveNotificationSettings() { showConfirmModal('Save Notifications', 'Save changes?', () => { showToast('Notification settings saved.', 'success'); }); }
             function handleEnable2FA() { console.log("Enable 2FA clicked"); /* Show setup options */ }
             function showAuthAppSetup() { console.log("Show Auth App setup"); /* Show QR */ }
             function showSmsSetup() { console.log("Show SMS setup"); /* Show phone, send button */ }
             function handleVerifyAuthCode() { console.log("Verify Auth Code"); /* Simulate verify */ }
             function handleSendSmsCode() { console.log("Send SMS Code"); /* Simulate send */ }
             function handleVerifySmsCode() { console.log("Verify SMS Code"); /* Simulate verify */ }
             function handleDisable2FA() { showConfirmModal('Disable 2FA', 'Are you sure?', () => { showToast('2FA disabled.'); }); }
             function handleLogoutAllDevices() { showConfirmModal('Logout All', 'Confirm?', () => { showToast('Logged out elsewhere.'); }); }
             function handleDeleteAccount() { showConfirmModal('Delete Account', 'FINAL WARNING?', () => { showToast('Account deleted (simulated).'); }); }
             function handleInviteMember(e) { e.preventDefault(); console.log("Invite triggered"); showToast('Invite sent.'); }
             function handleTeamListActions(e) { /* Handle edit/remove clicks using delegation */ }


            // --- Utilities ---
            function capitalizeFirstLetter(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
            function toCamelCase(s) { return s.toLowerCase().replace(/([-_][a-z])/g, g => g.toUpperCase().replace('-', '').replace('_', '')); }
            // Add other utilities (timeAgo, formatDate, etc.)

            // --- Start Dashboard ---
            initDashboard();

        }); // End DOMContentLoaded
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */

            /* High Contrast Variables (Initial basic setup) */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable (for request ✅ 2️⃣) - Aliased to existing variables */
            --text-color: var(--dark);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6; /* Light gray for weekend cells */
             --schedule-weekend-text: #9ca3af; /* Muted text for weekend OFF */

             /* Task Management specific */
             --priority-high-bg: #fee2e2; /* Light red */
             --priority-high-text: #b91c1c; /* Dark red */
             --priority-medium-bg: #ffedd5; /* Light orange */
             --priority-medium-text: #c2410c; /* Dark orange */
             --priority-low-bg: #dcfce7; /* Light green */
             --priority-low-text: #166534; /* Dark green */
             --status-todo-bg: #e0e7ff; /* Light indigo */
             --status-todo-text: #3730a3; /* Dark indigo */
             --status-inprogress-bg: #dbeafe; /* Light blue */
             --status-inprogress-text: #1e40af; /* Dark blue */
             --status-completed-bg: #f3f4f6; /* Light gray */
             --status-completed-text: #6b7280; /* Medium gray */
             --status-blocked-bg: #fecaca; /* Light red */
             --status-blocked-text: #991b1b; /* Darker red */
             --task-overdue-text: var(--danger);
             --task-subtask-bg: #fafafa; /* Slightly off-white for subtasks */
             --task-border-color: var(--light-gray);
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* High Contrast Mode */
        body.high-contrast {
             --dark: var(--hc-text);
             --light: var(--hc-background);
             --gray: var(--hc-text); /* Adjust as needed */
             --light-gray: var(--hc-border);
             --white: var(--hc-background);
             --primary: var(--hc-primary);
             --primary-dark: var(--hc-primary);
             --primary-light: #e0e0ff; /* Lighter blue for hc bg */
             --secondary: var(--hc-secondary);
             --sidebar-bg: var(--hc-background);
             --sidebar-text: var(--hc-text);
             --sidebar-hover: #e0e0e0;
             --sidebar-active: #c0c0c0;
             --sidebar-divider: var(--hc-border);
             --text-color: var(--hc-text); /* High contrast text */
             color: var(--text-color);
             background-color: var(--hc-background);
             /* Task Management HC */
             --priority-high-bg: var(--hc-background);
             --priority-high-text: #ff0000; /* Bright Red */
             --priority-medium-bg: var(--hc-background);
             --priority-medium-text: #ffa500; /* Orange */
             --priority-low-bg: var(--hc-background);
             --priority-low-text: #008000; /* Green */
             --status-todo-bg: var(--hc-background);
             --status-todo-text: var(--hc-text);
             --status-inprogress-bg: var(--hc-background);
             --status-inprogress-text: #0000ff; /* Blue */
             --status-completed-bg: var(--hc-background);
             --status-completed-text: var(--hc-text);
             --status-blocked-bg: var(--hc-background);
             --status-blocked-text: #800000; /* Maroon */
             --task-overdue-text: #ff0000;
             --task-subtask-bg: #f0f0f0;
             --task-border-color: var(--hc-border);
        }
         body.high-contrast .welcome-section,
         body.high-contrast .stat-card,
         body.high-contrast .top-nav,
         body.high-contrast .sidebar,
         body.high-contrast .activity-section,
         body.high-contrast .content-section,
         body.high-contrast #featureSectionsContainer.task-management .task-table, /* HC for task table */
         body.high-contrast #featureSectionsContainer.task-management .task-controls /* HC for task controls */
         {
             background: var(--hc-background);
             border: 1px solid var(--hc-border);
             color: var(--text-color);
         }
          body.high-contrast .btn,
          body.high-contrast .form-control,
          body.high-contrast .search-bar input {
              border: 1px solid var(--hc-border);
          }
          body.high-contrast .btn-primary { background-color: var(--hc-primary); color: var(--hc-background); }
          body.high-contrast .logo { color: var(--text-color); }
          body.high-contrast .logo-icon { color: var(--hc-primary); }
          body.high-contrast .menu-item { color: var(--text-color); border-left-color: transparent; }
          body.high-contrast .menu-item.active { background-color: #c0c0c0; border-left-color: var(--hc-primary); }
          body.high-contrast .stat-card { border-left-width: 3px; background: var(--hc-background); } /* Reset gradient */
          body.high-contrast .welcome-section { background: var(--hc-background); }
          /* HC for task elements */
          body.high-contrast .priority-badge,
          body.high-contrast .status-badge { border: 1px solid var(--hc-border); }
          body.high-contrast .task-row.task-overdue .task-due-date,
          body.high-contrast .task-row.task-due-soon .task-due-date { text-decoration: underline; }
          body.high-contrast .task-row.subtask-row { border-left: 3px solid var(--hc-border); }


        /* --- Sidebar Styles --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; /* Smooth background transition */
        }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; color: inherit; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); }
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--secondary); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--white); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary); /* Colored border instead of top gradient */
            color: var(--dark); /* Ensure text inside uses appropriate theme color */
        }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--secondary); background: var(--stat-card-bg-2); }
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }

        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        /* .stat-card::before removed */
        .stat-title { font-size: 0.9rem; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { /* Color set dynamically or removed if not needed per card */ opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        /* Stat value colors are specific and contrast should be checked manually */
        .stat-card:nth-child(1) .stat-value { color: #1e40af; }
        .stat-card:nth-child(2) .stat-value { color: #15803d; }
        .stat-card:nth-child(3) .stat-value { color: #b45309; }
        .stat-card:nth-child(4) .stat-value { color: #b91c1c; }

        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-color); } /* Use text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--text-color); } /* Use text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        /* Delete icon visible by default */
        .delete-activity {
            color: var(--danger);
            cursor: pointer;
            opacity: 0.6; /* Visible by default */
            transition: opacity 0.2s, background-color 0.2s;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .activity-item:hover .delete-activity {
             opacity: 1; /* Already visible, just make fully opaque on hover */
        }
        .delete-activity:hover {
            opacity: 1; background-color: rgba(239, 68, 68, 0.1);
        }

        /* --- Profile & Settings Sections Styles --- */
        .content-section { /* Shared styles already applied */ background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; display: none; animation: fadeInContent 0.4s ease-in-out; } /* Hidden by default */
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem; } /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); flex-grow: 1; } /* Allow title to grow */
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use text-color */
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; } /* Added justify-content */
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-warning { background-color: var(--warning); color: var(--primary-dark); } /* Warning button style */
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        /* Settings Sub-section */
        .settings-subsection {
             margin-top: 2rem;
             padding-top: 1.5rem;
             border-top: 1px solid var(--light-gray);
        }
        .settings-subsection:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        .settings-subsection h4 {
             font-size: 1.1rem;
             font-weight: 600;
             color: var(--primary-dark);
             margin-bottom: 1rem;
        }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; /* Default: Label takes full width */ }
        @media (min-width: 768px) { /* On larger screens, allow side-by-side */
            .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; }
        }
        .setting-item-label { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { /* Stack control below on small screens */
            .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; }
        }


        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        .member-details { flex: 1; min-width: 0; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use text-color */
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-email { font-size: 0.8rem; }
        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        /* Invite form layout adjustment (already likely handled by this CSS) */
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */
         /* Adjust spinner color for outline buttons */
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .btn-success .spinner { border-color: rgba(255,255,255,0.3); border-top-color: white; }
        .btn-warning .spinner { border-color: rgba(0,0,0,0.3); border-top-color: var(--primary-dark); } /* Assuming dark text on warning */
        .btn-danger .spinner { border-color: rgba(255,255,255,0.3); border-top-color: white; }

        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }

        /* --- Theme Styles & Responsive --- */
        body.light-theme { --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; --text-color: var(--dark); background-color: var(--primary-light); }
        body.dark-theme {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --primary-light: #1e293b;
            --light: #334155; /* Slightly lighter background for cards/sections */
            --white: #0f172a; /* Darkest background for body */
            --dark: #e2e8f0; /* Light text */
            --gray: #94a3b8; /* Lighter gray text */
            --light-gray: #475569; /* Darker borders/dividers */
            --text-color: var(--dark); /* Update text-color for dark mode */
            --schedule-weekend-bg: #262f3e; /* Darker gray for weekend cells */
            --schedule-weekend-text: #6b7280; /* Muted dark text for weekend OFF */
            /* Task Dark Theme */
            --priority-high-bg: #372323;
            --priority-high-text: #fca5a5;
            --priority-medium-bg: #422b17;
            --priority-medium-text: #fcd34d;
            --priority-low-bg: #153224;
            --priority-low-text: #86efac;
            --status-todo-bg: #282c4a;
            --status-todo-text: #c7d2fe;
            --status-inprogress-bg: #1e293b;
            --status-inprogress-text: #93c5fd;
            --status-completed-bg: #334155;
            --status-completed-text: #94a3b8;
            --status-blocked-bg: #451a1a;
            --status-blocked-text: #fca5a5;
            --task-overdue-text: #f87171; /* Lighter red */
            --task-subtask-bg: #1c2532;
            --task-border-color: var(--light-gray);
            background-color: var(--white); /* Use darkest for body */
            color: var(--text-color); /* Default text color */
        }
        /* Dark Theme Overrides */
        body.dark-theme .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); } /* Lighter BG for nav */
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme .team-member-card, body.dark-theme .add-member-form { background-color: var(--light); border-color: var(--light-gray); } /* Lighter BG for content cards */
        body.dark-theme .search-bar input, body.dark-theme .form-control { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); } /* Even darker BG for inputs */
        body.dark-theme .form-control[readonly] { background-color: var(--light); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item { color: var(--text-color); } /* Ensure search result text is light */
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item { color: var(--text-color); } /* Ensure dropdown text is light */
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--light); } /* Lighter BG for notifications panel */
        body.dark-theme .notification-list-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); } /* Slightly more visible unread */
        body.dark-theme .confirm-container, body.dark-theme .modal-content { background-color: var(--light); color: var(--text-color); } /* Modal background and default text */
        body.dark-theme .theme-option div { border-color: var(--light-gray); }
        body.dark-theme .theme-option.selected div { border-color: var(--primary); }
        body.dark-theme .back-button { color: var(--primary); } /* Use primary color for link */
        body.dark-theme .back-button:hover { background-color: var(--light); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--light); border-top-color: var(--light-gray); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white); } /* Welcome section retains white text */
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; } /* Inherit white */
        body.dark-theme .user-info-name { color: inherit; } /* Inherit white */
        body.dark-theme .user-info-title { color: var(--gray); } /* Role title uses gray */
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email span { color: inherit; } /* Inherit white */
        body.dark-theme .stat-card { background: var(--light); color: var(--text-color);} /* Dark theme stat card background, ensure text color */
        body.dark-theme .stat-title { color: var(--text-color); } /* Ensure stat title is light */
        /* Specific stat value colors adjusted for dark theme */
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; }
        body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; }
        body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; }
        body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; } /* Adjust icon color */
        body.dark-theme .activity-item { border-bottom-color: var(--light-gray); }
        body.dark-theme .activity-message { color: var(--text-color); } /* Activity text */
        body.dark-theme .activity-time { color: var(--gray); } /* Activity time */
        body.dark-theme .activity-item.new-activity { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(239, 68, 68, 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--text-color); } /* Text label */
        body.dark-theme #profileAvatarLarge { background-color: var(--light); color: var(--text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); } /* Profile intro text */
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--light-gray); }
        body.dark-theme .placeholder-content h2 { color: var(--text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--text-color); } /* Ensure error text readable */
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--text-color); } /* Form labels */
        body.dark-theme .settings-subsection h4 { color: #93c5fd; } /* Lighter primary */
        body.dark-theme .setting-item-label { color: var(--text-color); } /* Setting item title */
        body.dark-theme .setting-item-description { color: var(--gray); } /* Setting item description */
        body.dark-theme .theme-option span { color: var(--text-color); } /* Theme label text */
        body.dark-theme .qr-code-placeholder { border-color: var(--light-gray); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; } /* Ensure danger button stands out */
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); } /* Danger zone description */

        /* Dark Theme Employee Scheduling Specifics */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary); color: white; border-bottom-color: var(--primary-dark);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--text-color); border-color: var(--light-gray); } /* Ensure table cell text is light */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); } /* Darker even row background */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td,
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; } /* Hover effect */
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--white); border-right-color: var(--light-gray); color: var(--text-color); } /* Dark sticky column bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: white; } /* Keep day name white */
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift { /* Adjust shift colors for dark mode if needed, current ones might be okay */ }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg); } /* Dark weekend bg */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; }

        /* Dark Theme Task Management Specifics */
        body.dark-theme #featureSectionsContainer.task-management .task-controls { background-color: var(--light); border-bottom-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management .task-table thead th { background-color: var(--primary); color: white; border-bottom-color: var(--primary-dark);}
        body.dark-theme #featureSectionsContainer.task-management .task-table tbody td { border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management .task-table tbody tr:nth-child(even) td { background-color: var(--primary-light); }
        body.dark-theme #featureSectionsContainer.task-management .task-table tbody tr:hover td { background-color: #475569; }
        body.dark-theme #featureSectionsContainer.task-management .task-row.subtask-row td { background-color: var(--task-subtask-bg); }
        body.dark-theme #featureSectionsContainer.task-management .task-row.subtask-row:nth-child(even) td { background-color: #253040; } /* Darker even subtask */
        body.dark-theme #featureSectionsContainer.task-management .task-row.subtask-row:hover td { background-color: #3e4e63; }
        body.dark-theme #featureSectionsContainer.task-management .task-row.task-overdue .task-due-date { color: var(--task-overdue-text); }
        body.dark-theme #featureSectionsContainer.task-management .priority-badge,
        body.dark-theme #featureSectionsContainer.task-management .status-badge { /* Uses dark theme variables */ }
        body.dark-theme #featureSectionsContainer.task-management .task-title-cell .task-title { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management .task-title-cell .subtask-count { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management .subtask-toggle i { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management .task-row.task-overdue { background-color: rgba(248, 113, 113, 0.1); } /* Slight red tint */


        body.dark-theme .checkbox-group { border-color: var(--light-gray); }
        body.dark-theme .checkbox-group label { color: var(--text-color); } /* Checkbox label text */
        body.dark-theme .confirm-title { color: var(--text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: #93c5fd; } /* Lighter primary */
        body.dark-theme .team-member-card .member-name { color: var(--text-color); }
        body.dark-theme .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--text-color); } /* Ensure bold text is readable */
        body.dark-theme .user-name { color: var(--text-color); } /* Top nav user name */


        /* Theme Selection Styles */
        .theme-options-container { display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap; } /* Added wrap */
        .theme-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .theme-option .theme-preview { width: 60px; height: 40px; border: 2px solid var(--light-gray); border-radius: 6px; transition: border-color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .theme-option .theme-label { text-align: center; display: block; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-color); } /* Use text-color */
        .theme-option:hover .theme-preview { border-color: var(--primary); }
        .theme-option.selected .theme-preview { border-color: var(--primary); border-width: 3px; }
        /* Specific theme previews */
        .theme-preview.light-preview { background-color: #f8fafc; color: #1e293b; }
        .theme-preview.dark-preview { background-color: #0f172a; color: #e2e8f0; }
        .theme-preview.system-preview { background: linear-gradient(45deg, #f8fafc 50%, #0f172a 50%); color: var(--gray); }


        /* 2FA Setup Styles */
        .two-fa-status { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .two-fa-status .status-indicator { width: 10px; height: 10px; border-radius: 50%; }
        .two-fa-status .status-indicator.enabled { background-color: var(--success); }
        .two-fa-status .status-indicator.disabled { background-color: var(--danger); }
        .two-fa-setup { border: 1px dashed var(--light-gray); padding: 1.5rem; border-radius: 6px; margin-top: 1rem; background-color: var(--light); }
        .qr-code-placeholder { width: 150px; height: 150px; border: 2px dashed var(--light-gray); display: flex; align-items: center; justify-content: center; text-align: center; color: var(--gray); font-size: 0.9rem; margin: 1rem auto; }
        .two-fa-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; } /* Added wrap */

        /* Danger Zone Styles */
         .danger-zone-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 1.5rem;
             border: 1px solid var(--danger);
             background-color: rgba(239, 68, 68, 0.05);
             border-radius: 8px;
             margin-bottom: 1rem;
             flex-wrap: wrap; /* Allow wrapping */
         }
         .danger-zone-item div { max-width: 100%; flex-grow: 1; margin-right: 1rem; /* Space before button */ }
         @media (min-width: 768px) { /* Limit width on larger screens */
            .danger-zone-item div { max-width: 70%; }
         }
         .danger-zone-item h5 { color: var(--danger); margin-bottom: 0.25rem; }
         .danger-zone-item p { color: var(--gray); font-size: 0.9rem; }
         .danger-zone-item .btn { flex-shrink: 0; /* Prevent button shrinking */ margin-top: 0.5rem; /* Space when wrapped */}


        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-modal.active { display: flex; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start; /* Align top */ cursor: pointer; position: relative; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.08); font-weight: 500; } /* Adjusted unread bg slightly */
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); } /* Dark theme unread */
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        body.dark-theme .notification-icon-wrapper { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa;}
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--text-color); line-height: 1.4; } /* Use text-color */
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0; /* Hidden by default */ transition: opacity 0.2s; position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem; background: var(--white); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .notification-list-item:hover .delete-notification { opacity: 0.6; } /* Show on hover */
        .delete-notification:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); }
        body.dark-theme .delete-notification { background: var(--light); }
        body.dark-theme .delete-notification:hover { background: rgba(239, 68, 68, 0.2); }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); flex-wrap: wrap; gap: 0.5rem; } /* Added wrap */
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-modal.active { display: flex; }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); } /* Use text-color */
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; }
        .d-none { display: none !important; }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s, color 0.3s; }
        .placeholder-content h2 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .placeholder-content p { color: var(--gray); } /* Ensure placeholder text uses gray */
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; text-align: left; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; max-width: 100%; overflow-wrap: break-word; }

        /* --- Employee Scheduling Scoped Styles --- */
        #featureSectionsContainer.employee-scheduling .schedule-page-header { margin-bottom: 1.5rem; }
        #featureSectionsContainer.employee-scheduling .schedule-page-title {
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: none;
            margin-bottom: 0;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            display: inline-block;
         }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title {
            background-color: var(--light);
            color: #93c5fd;
        }

        #featureSectionsContainer.employee-scheduling .schedule-controls { margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling .schedule-container { margin-top: 1rem; overflow-x: auto; }
        #featureSectionsContainer.employee-scheduling .schedule-table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 0; border: 1px solid var(--light-gray); border-radius: 8px; overflow: hidden; } /* Adjusted min-width for 7 days */
        #featureSectionsContainer.employee-scheduling .schedule-table thead th { padding: 1rem 0.75rem; text-align: center; background-color: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark); }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { border-top-left-radius: 8px; position: sticky; left: 0; z-index: 11 !important; } /* Sticky Employee header */
        #featureSectionsContainer.employee-scheduling .schedule-table thead th:last-child { border-top-right-radius: 8px; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--light-gray); border-right: 1px solid var(--light-gray); vertical-align: middle; transition: background-color 0.2s; color: var(--text-color); } /* Use text-color */
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td { background-color: #f9fafb; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td { background-color: #f0f9ff; }
        #featureSectionsContainer.employee-scheduling .employee-name { font-weight: 600; text-align: left; position: sticky; left: 0; background-color: var(--white); z-index: 5; border-right: 2px solid var(--gray); /* Make divider more prominent */ white-space: nowrap; color: var(--text-color); } /* Use text-color */
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: #f9fafb; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #f0f9ff; }
        /* Weekend Cell Specific Style */
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell {
            background-color: var(--schedule-weekend-bg);
        }
        #featureSectionsContainer.employee-scheduling .shift { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; min-width: 60px; border: 1px solid transparent; cursor: default; }
        #featureSectionsContainer.employee-scheduling .shift.editable { cursor: pointer; transition: transform 0.2s; }
        #featureSectionsContainer.employee-scheduling .shift.editable:hover { transform: scale(1.05); box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        /* Weekend OFF shift style */
        #featureSectionsContainer.employee-scheduling .shift-weekend-off {
            color: var(--schedule-weekend-text);
            background-color: transparent; /* Or keep var(--schedule-weekend-bg) */
            font-style: italic;
            border: none;
            cursor: default;
        }
        #featureSectionsContainer.employee-scheduling .shift-morning { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: #e0f2fe; color: #0c4a6e; border-color: #bae6fd;}
        #featureSectionsContainer.employee-scheduling .shift-night { background-color: #ede9fe; color: #5b21b6; border-color: #ddd6fe; }
        #featureSectionsContainer.employee-scheduling .shift-off { background-color: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        #featureSectionsContainer.employee-scheduling .shift-sick { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: #ffedd5; color: #9a3412; border-color: #fed7aa; }
        #featureSectionsContainer.employee-scheduling .day-header { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling .day-name { font-weight: 600; font-size: 0.9rem; color: white; } /* Day name in header is white */
        #featureSectionsContainer.employee-scheduling .day-date { font-size: 0.8rem; opacity: 0.8; color: rgba(255, 255, 255, 0.8); } /* Date slightly transparent */


        /* --- Task Management Scoped Styles --- */
        #featureSectionsContainer.task-management .task-page-header { margin-bottom: 1.5rem; }
        #featureSectionsContainer.task-management .task-page-title {
             font-size: 1.5rem; font-weight: 600; border-bottom: none; margin-bottom: 0;
             background-color: var(--primary-light); color: var(--primary-dark);
             padding: 0.75rem 1.5rem; border-radius: 6px; display: inline-block;
         }
        body.dark-theme #featureSectionsContainer.task-management .task-page-title { background-color: var(--light); color: #93c5fd; }

        #featureSectionsContainer.task-management .task-controls {
            display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;
            padding: 1rem 1.5rem; margin-bottom: 1.5rem;
            background-color: var(--white); border-radius: 8px;
            border-bottom: 1px solid var(--light-gray); box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #featureSectionsContainer.task-management .task-controls .form-group { margin-bottom: 0; flex-grow: 1; min-width: 150px; }
        #featureSectionsContainer.task-management .task-controls .form-group label { font-size: 0.8rem; margin-bottom: 0.25rem; font-weight: 600; }
        #featureSectionsContainer.task-management .task-controls .form-control { font-size: 0.9rem; padding: 0.5rem 0.75rem; }
        #featureSectionsContainer.task-management .task-controls .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.85rem; }

        #featureSectionsContainer.task-management .task-table-container { overflow-x: auto; }
        #featureSectionsContainer.task-management .task-table {
            width: 100%; min-width: 800px; /* Ensure some width */
            border-collapse: separate; border-spacing: 0;
            border: 1px solid var(--task-border-color); border-radius: 8px; overflow: hidden;
        }
        #featureSectionsContainer.task-management .task-table thead th {
            padding: 0.8rem 1rem; text-align: left; background-color: var(--primary); color: white;
            font-weight: 600; position: sticky; top: 0; z-index: 10;
            border-bottom: 2px solid var(--primary-dark); white-space: nowrap; cursor: pointer;
        }
        #featureSectionsContainer.task-management .task-table thead th i { margin-left: 0.5rem; opacity: 0.6; }
        #featureSectionsContainer.task-management .task-table thead th.sort-asc i,
        #featureSectionsContainer.task-management .task-table thead th.sort-desc i { opacity: 1; }
        #featureSectionsContainer.task-management .task-table thead th:first-child { border-top-left-radius: 8px; }
        #featureSectionsContainer.task-management .task-table thead th:last-child { border-top-right-radius: 8px; text-align: center; }

        #featureSectionsContainer.task-management .task-table tbody td {
            padding: 0.8rem 1rem; vertical-align: middle;
            border-bottom: 1px solid var(--task-border-color);
            transition: background-color 0.2s;
            color: var(--text-color);
        }
        #featureSectionsContainer.task-management .task-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.task-management .task-table tbody tr:nth-child(even) td { background-color: var(--light); }
        #featureSectionsContainer.task-management .task-table tbody tr:hover td { background-color: var(--primary-light); }

        #featureSectionsContainer.task-management .task-row.subtask-row td {
             background-color: var(--task-subtask-bg);
        }
         #featureSectionsContainer.task-management .task-row.subtask-row:nth-child(even) td {
            background-color: #f0f0f0; /* Slightly different even subtask bg */
         }
         #featureSectionsContainer.task-management .task-row.subtask-row:hover td {
             background-color: #e9e9e9;
         }
        #featureSectionsContainer.task-management .task-row.task-overdue { background-color: rgba(239, 68, 68, 0.05); } /* Subtle overdue background */

        #featureSectionsContainer.task-management .task-title-cell { display: flex; align-items: center; gap: 0.5rem; }
        #featureSectionsContainer.task-management .task-title-cell .subtask-toggle { cursor: pointer; color: var(--gray); transition: transform 0.2s; display: inline-block; width: 16px; text-align: center; }
        #featureSectionsContainer.task-management .task-title-cell .subtask-toggle.expanded { transform: rotate(90deg); }
        #featureSectionsContainer.task-management .task-title-cell .task-title { font-weight: 500; color: var(--text-color); flex-grow: 1; }
        #featureSectionsContainer.task-management .task-title-cell .subtask-count { font-size: 0.8rem; color: var(--gray); margin-left: 0.5rem; flex-shrink: 0; }
        #featureSectionsContainer.task-management .task-row.subtask-row .task-title-cell { padding-left: 2.5rem; /* Indent subtasks */ }
        #featureSectionsContainer.task-management .task-row.subtask-row .task-title-cell .subtask-toggle { visibility: hidden; /* Hide toggle for subtasks */ }

        #featureSectionsContainer.task-management .assignee-avatar {
            width: 28px; height: 28px; border-radius: 50%; background-color: var(--light-gray);
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 600; margin-right: 0.5rem; vertical-align: middle;
            background-size: cover; background-position: center; color: var(--primary-dark);
        }
        #featureSectionsContainer.task-management .assignee-name { vertical-align: middle; }

        #featureSectionsContainer.task-management .task-due-date { white-space: nowrap; }
        #featureSectionsContainer.task-management .task-row.task-overdue .task-due-date { color: var(--task-overdue-text); font-weight: bold; }
        #featureSectionsContainer.task-management .task-row.task-due-soon .task-due-date { color: var(--warning); font-weight: bold; } /* Due soon styling */

        #featureSectionsContainer.task-management .priority-badge,
        #featureSectionsContainer.task-management .status-badge {
            padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;
            white-space: nowrap; display: inline-block; text-align: center; min-width: 80px;
        }
        #featureSectionsContainer.task-management .priority-high { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
        #featureSectionsContainer.task-management .priority-medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); }
        #featureSectionsContainer.task-management .priority-low { background-color: var(--priority-low-bg); color: var(--priority-low-text); }

        #featureSectionsContainer.task-management .status-todo { background-color: var(--status-todo-bg); color: var(--status-todo-text); }
        #featureSectionsContainer.task-management .status-inprogress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
        #featureSectionsContainer.task-management .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); text-decoration: line-through; opacity: 0.8; }
        #featureSectionsContainer.task-management .status-blocked { background-color: var(--status-blocked-bg); color: var(--status-blocked-text); }

        #featureSectionsContainer.task-management .task-actions { text-align: center; white-space: nowrap; }
        #featureSectionsContainer.task-management .task-actions .btn-sm { padding: 0.3rem 0.5rem; font-size: 0.8rem; margin: 0 0.15rem; }
        #featureSectionsContainer.task-management .task-actions i { /* Icons inside buttons */ font-size: 0.9em; }

        #featureSectionsContainer.task-management .no-tasks-message { text-align: center; padding: 2rem; color: var(--gray); font-style: italic; }


        /* Generic Modal Styles */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1050; /* Higher than confirm modal */
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--white); width: 100%; max-width: 500px; /* Adjusted size */
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem; max-height: 90vh; overflow-y: auto; animation: zoomIn 0.3s ease-out;
            color: var(--text-color); /* Default text color for modal content */
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray);
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        body.dark-theme .modal-title { color: #93c5fd; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1;}
        .close-modal:hover { color: var(--danger); }

        /* Specific Modal Scoping */
        #featureSectionsContainer.employee-scheduling .modal { /* Use generic modal styles */ }
        #featureSectionsContainer.employee-scheduling .modal-content { /* Use generic modal styles */ }
        #featureSectionsContainer.employee-scheduling .modal-header { /* Use generic modal styles */ }
        #featureSectionsContainer.employee-scheduling .modal-title { /* Use generic modal styles */ }
        #featureSectionsContainer.employee-scheduling .close-modal { /* Use generic modal styles */ }
        #featureSectionsContainer.task-management .modal { /* Use generic modal styles */ }
        #featureSectionsContainer.task-management .modal-content { /* Use generic modal styles */ }
        #featureSectionsContainer.task-management .modal-header { /* Use generic modal styles */ }
        #featureSectionsContainer.task-management .modal-title { /* Use generic modal styles */ }
        #featureSectionsContainer.task-management .close-modal { /* Use generic modal styles */ }

        .toast { /* Generic toast style */ position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1300; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast.info { background-color: var(--primary); } /* Add info style */
        body.dark-theme .toast { background-color: var(--light); color: var(--text-color); } /* Dark theme toast */
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }
        body.dark-theme .toast.info { background-color: var(--primary); color: white; }

        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }


        /* Responsive Overrides */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); width: 250px; box-shadow: none; }
            .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; }
            .search-bar { width: 250px; }
            .team-member-card { flex-wrap: wrap; }
            .main-content.sidebar-active { margin-left: 250px; } /* Adjust main content when sidebar is open */
            .sidebar-toggle { display: block; /* Show hamburger */ position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
            .top-nav { padding-left: 60px; } /* Make space for hamburger */
            #featureSectionsContainer.task-management .task-controls { flex-direction: column; align-items: stretch; } /* Stack controls */
        }
        @media (min-width: 993px) {
             .sidebar-toggle { display: none; } /* Hide hamburger on larger screens */
        }

        @media (max-width: 768px) {
            .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; padding-left: 1rem; /* Reset padding */ }
            .search-bar { width: 100%; order: 2; }
            .user-menu { width: 100%; justify-content: space-between; order: 1; }
            .content-area { padding: 1.5rem; }
            .data-form { grid-template-columns: 1fr; }
            .form-actions { grid-column: span 1; }
            .user-info { flex-direction: column; text-align: center; }
            .user-info-avatar { margin-bottom: 1rem; }
            .stats-section { grid-template-columns: 1fr; }
            .settings-tabs { flex-wrap: nowrap; overflow-x: auto; } /* Prevent wrapping, allow scroll */
            .settings-tab { padding: 0.5rem 1rem; flex-shrink: 0; } /* Prevent shrinking */
            /* setting-item handled above for better wrapping */
            .confirm-container { width: 90%; }
            .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .member-role { margin: 0.5rem 0; }
            .member-actions { margin-top: 0.5rem; }
            .profile-avatar-section { margin-bottom: 1.5rem; }
            #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
            /* Ensure invite form fields stack nicely */
            .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
            .add-member-form .data-form > div { margin-bottom: 1rem; }
            .add-member-form .data-form > div:last-child { margin-top: 0; } /* Remove extra space above button */
            /* Schedule mobile fixes */
            #featureSectionsContainer.employee-scheduling .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
            #featureSectionsContainer.employee-scheduling .schedule-controls .btn { width: 100%; justify-content: center; }
            #featureSectionsContainer.employee-scheduling .schedule-page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            #featureSectionsContainer.employee-scheduling .employee-name { position: static !important; /* Ensure it's not sticky */ border-right: none; border-bottom: 2px solid var(--gray); }
            #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border-right: none; }
            #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { position: sticky; left: 0; z-index: 11 !important; background-color: var(--primary); } /* Ensure sticky header bg */
            body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary); }
            /* Task Management mobile fixes */
            #featureSectionsContainer.task-management .section-main-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            #featureSectionsContainer.task-management .task-table { min-width: auto; } /* Allow shrinking */
            #featureSectionsContainer.task-management .task-table td,
            #featureSectionsContainer.task-management .task-table th { font-size: 0.9rem; padding: 0.6rem 0.8rem; } /* Slightly smaller padding/font */
            #featureSectionsContainer.task-management .assignee-name { display: none; } /* Hide name, keep avatar */
            #featureSectionsContainer.task-management .priority-badge,
            #featureSectionsContainer.task-management .status-badge { min-width: auto; padding: 0.2rem 0.4rem; font-size: 0.75rem; }
            #featureSectionsContainer.task-management .task-row.subtask-row .task-title-cell { padding-left: 1.5rem; } /* Less indent */
            /* Use generic modal styles for responsive */
            .modal-content { width: 95%; padding: 1.5rem;}
            .notifications-container { width: 100%; max-width: 100%; }
            .sidebar-toggle { top: 10px; left: 10px; }
            .top-nav { padding-top: 60px; /* Make space for hamburger */ }
        }
        @media (max-width: 480px) {
            .section-header > div { justify-content: center; width: 100%; }
            .welcome-section { padding: 1.5rem; }
            .stats-section { gap: 0.75rem; }
            .stat-card { padding: 1rem; }
            .user-menu { gap: 1rem; }
            .user-name { display: none; } /* Hide name on very small screens */
            .user-status { margin-left: 0; }
            .notifications-footer { flex-direction: column; gap: 0.5rem; }
            .notifications-footer .btn { width: 100%; justify-content: center; }
            /* Danger zone handled above for better wrapping */
            #featureSectionsContainer.task-management .task-controls { padding: 1rem; }
            #featureSectionsContainer.task-management .task-table td,
            #featureSectionsContainer.task-management .task-table th { padding: 0.5rem; font-size: 0.8rem; } /* Even smaller padding */
            #featureSectionsContainer.task-management .task-actions .btn-sm { margin: 0 0.1rem; }
        }
         /* Checkbox Group for Notification Types */
         .checkbox-group {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
             gap: 0.75rem;
             margin-top: 0.5rem;
             padding: 0.5rem;
             border: 1px solid var(--light-gray);
             border-radius: 6px;
         }
         .checkbox-group label {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-weight: normal; /* Override form-group label weight */
             font-size: 0.9rem;
             margin-bottom: 0; /* Override form-group label margin */
             color: var(--text-color); /* Ensure label text color */
         }
         .checkbox-group input[type="checkbox"] {
             width: auto; /* Override form-control width */
             margin-right: 0.25rem;
         }
         /* Simple link style for settings panel internal links */
         .settings-link {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
         }
         .settings-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
         }

    </style>
</head>
<!-- Apply theme class from localStorage -->
<body class=""> <!-- Start with no specific theme, JS will apply -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle (Visible on smaller screens) -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Success/Toast message container -->
    <div class="toast" id="toastMessage">Toast message</div>
    <!-- Success message (Specific style from original) -->
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </div>
            <!-- Optional: Close button inside sidebar for mobile -->
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none; background: none; border: none; color: white; font-size: 1.2rem; position: absolute; top: 1.5rem; right: 1rem;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <!-- Sidebar items remain the same, ensure data-feature attributes are correct -->
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <!-- ADDED Task Management Link -->
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <!-- REMOVED original Task Management link from here -->
             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
             <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span>
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults">
                    <!-- Search results will be populated here -->
                 </div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer"> <!-- Added ID for event delegation -->
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status"> • Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button - Text dynamically updated -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <!-- Stat cards will be populated by JS -->
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <!-- Button hidden, click avatar instead -->
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <!-- Tabs remain the same -->
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                     <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light">
                                     <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div>
                                     <span class="theme-label">Light</span>
                                 </div>
                                 <div class="theme-option" data-theme="dark">
                                     <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div>
                                     <span class="theme-label">Dark</span>
                                 </div>
                                 <div class="theme-option" data-theme="system">
                                    <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div>
                                    <span class="theme-label">System</span>
                                 </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div>
                                <span class="setting-item-label">High Contrast Mode</span>
                                <p class="setting-item-description">Increase text visibility for accessibility.</p>
                            </div>
                            <div class="setting-item-control">
                                <label class="switch">
                                    <input type="checkbox" id="highContrastToggle">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Reuse data-form for layout -->
                             <div class="form-group">
                                 <label for="languageSelect">Language</label>
                                 <select id="languageSelect" class="form-control">
                                     <option value="en">English (US)</option>
                                     <option value="ar">العربية (Arabic)</option>
                                     <option value="es">Español (Spanish)</option>
                                 </select>
                             </div>
                             <div class="form-group">
                                 <label for="regionSelect">Region / Timezone</label>
                                 <select id="regionSelect" class="form-control">
                                     <option value="utc">UTC</option>
                                     <option value="est">EST (UTC-5)</option>
                                     <option value="pst">PST (UTC-8)</option>
                                     <option value="cet">CET (UTC+1)</option>
                                     <option value="eet">EET (UTC+2)</option>
                                     <option value="ast">AST (UTC+3) - Riyadh</option>
                                 </select>
                             </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group">
                                 <label for="timeFormatSelect">Time Format</label>
                                 <select id="timeFormatSelect" class="form-control">
                                     <option value="12h">12-hour (e.g., 3:00 PM)</option>
                                     <option value="24h">24-hour (e.g., 15:00)</option>
                                 </select>
                             </div>
                              <div class="form-group">
                                 <label for="dateFormatSelect">Date Format</label>
                                 <select id="dateFormatSelect" class="form-control">
                                     <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                     <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                     <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                     <option value="Month D, YYYY">Month D, YYYY</option>
                                 </select>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Toast Notifications</span>
                                 <p class="setting-item-description">Show brief confirmation messages for actions.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="toastToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Sound Notifications</span>
                                 <p class="setting-item-description">Play a sound for new notifications and activities.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="soundToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="form-group">
                             <label for="notificationToneSelect">Notification Tone</label>
                             <select id="notificationToneSelect" class="form-control" disabled> <!-- Disabled for now -->
                                 <option value="default">Default</option>
                                 <option value="tone1">Tone 1 (Placeholder)</option>
                                 <option value="tone2">Tone 2 (Placeholder)</option>
                             </select>
                             <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p>
                         </div>
                         <div class="form-group">
                             <label class="settings-label">Keyboard Shortcuts</label>
                             <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p>
                             <button class="btn btn-outline btn-sm" disabled>View Shortcuts</button>
                         </div>
                     </div>

                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                     <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group">
                                 <label for="accountEmail">Current Email</label>
                                 <input type="email" id="accountEmail" class="form-control" value="" readonly>
                             </div>
                             <div class="form-group">
                                <label for="changeEmail">New Email Address</label>
                                <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <!-- Keep disabled, needs backend -->
                                <p class="setting-item-description">Changing email requires backend verification.</p>
                            </div>
                             <div class="form-group" style="grid-column: span 2;">
                                <label for="accountConfirmPassword">Confirm Password (to change email)</label>
                                <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> <!-- Keep disabled -->
                            </div>
                            <div class="form-actions" style="grid-column: span 2;">
                                <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> <!-- Keep disabled -->
                            </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Account Notifications</span>
                                 <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="accountNotificationsToggle" checked> <!-- Default to checked -->
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                     <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group">
                                 <label for="currentPassword">Current Password</label>
                                 <input type="password" id="currentPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="newPassword">New Password</label>
                                 <input type="password" id="newPassword" class="form-control">
                             </div>
                             <div class="form-group">
                                 <label for="confirmPassword">Confirm New Password</label>
                                 <input type="password" id="confirmPassword" class="form-control">
                             </div>
                             <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Change Password</button> <!-- Removed disabled -->
                             </div>
                         </form>
                     </div>

                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status">
                             <span class="status-indicator disabled" id="twoFaStatusIndicator"></span>
                             <span id="twoFaStatusText">2FA is currently Disabled</span>
                         </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>

                         <!-- Placeholder for 2FA Setup UI -->
                         <div id="twoFaSetupSection" style="display: block;"> <!-- Initially visible -->
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none;">
                                 <h5>Choose Setup Method:</h5>
                                 <div class="two-fa-actions">
                                      <button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button>
                                      <button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button>
                                 </div>
                                 <!-- Authenticator App Setup -->
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p>
                                     <div class="qr-code-placeholder">QR Code Placeholder</div>
                                     <p>2. Enter the 6-digit code generated by your app below.</p>
                                     <div class="form-group">
                                        <label for="authCode">Verification Code</label>
                                        <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6">
                                    </div>
                                     <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> <!-- Removed disabled -->
                                 </div>
                                  <!-- SMS Setup -->
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;">
                                     <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p>
                                     <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button>
                                     <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup">
                                        <label for="smsCode">SMS Verification Code</label>
                                        <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6">
                                     </div>
                                     <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button>
                                 </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none;"> <!-- Visible when enabled -->
                              <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p>
                              <div class="two-fa-actions">
                                 <button class="btn btn-outline" disabled>View Recovery Codes</button> <!-- Keep disabled for demo -->
                                 <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="sessionDuration">Session Duration (minutes)</label>
                                <input type="number" id="sessionDuration" class="form-control" value="60" min="15">
                                <p class="setting-item-description">Set how long a login session remains active.</p>
                            </div>
                            <div class="form-group">
                                <label for="idleTimeout">Idle Timeout (minutes)</label>
                                <input type="number" id="idleTimeout" class="form-control" value="15" min="5">
                                <p class="setting-item-description">Automatically logout after inactivity.</p>
                            </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                             <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> <!-- Removed disabled -->
                         </div>
                     </div>

                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Email Notifications</span>
                                 <p class="setting-item-description">Receive summaries and important alerts via email.</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="emailNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable In-App Notifications</span>
                                 <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="inAppNotificationsToggle" checked>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <!-- Placeholder for Push Notifications -->
                          <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span>
                                 <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="pushNotificationsToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                     </div>

                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group">
                            <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label>
                            <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label>
                            <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label>
                            <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label>
                            <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label>
                            <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <!-- Placeholder for Priority Settings -->
                         <div class="form-group">
                            <label for="notificationPriority">Minimum Notification Priority</label>
                            <select id="notificationPriority" class="form-control" disabled>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                            <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p>
                         </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;">
                         <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> <!-- Removed disabled -->
                     </div>
                 </div>


                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                     <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <div class="team-list" id="teamList"> <!-- Team List populated by JS --> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                     <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Connect Slack</button>
                            <button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button>
                            <button class="btn btn-outline" disabled><i class="fab fa-github"></i> Connect GitHub</button>
                         </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item">
                             <div>
                                 <span class="setting-item-label">Allow External Sharing Links</span>
                             </div>
                             <div class="setting-item-control">
                                 <label class="switch">
                                     <input type="checkbox" id="externalSharingToggle" disabled>
                                     <span class="slider round"></span>
                                 </label>
                             </div>
                         </div>
                         <button class="btn btn-outline" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline" disabled>Set Default Permissions</button>
                     </div>
                 </div>


                 <!-- Danger Zone Panel -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3>
                     <p>These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p>This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Delete Account</h5>
                            <p>Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for other feature sections -->
             <div id="featureSectionsContainer" class="content-section">
                 <!-- Content loaded dynamically here -->
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications">×</button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
                 <!-- Notifications populated by JS -->
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button> <!-- Default to danger, can be changed -->
             </div>
         </div>
    </div>

    <!-- Edit Member Modal -->
    <div class="modal" id="editMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editMemberModalTitle">Edit Team Member</h3>
                <button class="close-modal" data-close-modal>&times;</button>
            </div>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group">
                         <label for="editMemberFirstName">First Name</label>
                         <input type="text" id="editMemberFirstName" class="form-control">
                     </div>
                     <div class="form-group">
                         <label for="editMemberLastName">Last Name</label>
                         <input type="text" id="editMemberLastName" class="form-control">
                     </div>
                     <div class="form-group">
                         <label for="editMemberEmail">Email</label>
                         <input type="email" id="editMemberEmail" class="form-control" readonly> <!-- Usually email is not editable this way -->
                     </div>
                     <div class="form-group">
                         <label for="editMemberRole">Role</label>
                         <select id="editMemberRole" class="form-control">
                             <option value="member">Member</option>
                             <option value="supervisor">Supervisor</option>
                             <option value="senior">Senior</option>
                             <option value="admin">Admin</option>
                         </select>
                     </div>
                      <div class="form-group">
                         <label for="editMemberTitle">Job Title</label>
                         <input type="text" id="editMemberTitle" class="form-control">
                     </div>
                      <div class="form-group">
                         <label for="editMemberDepartment">Department</label>
                         <input type="text" id="editMemberDepartment" class="form-control">
                     </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <!-- Adjust span if using single column form -->
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Add/Edit Task Modal (Reuses Generic Modal Structure) -->
     <div class="modal" id="taskModal">
         <div class="modal-content">
             <div class="modal-header">
                 <h3 class="modal-title" id="taskModalTitle">Add New Task</h3>
                 <button class="close-modal" data-close-modal>&times;</button>
             </div>
             <form id="taskForm">
                 <input type="hidden" id="editTaskId"> <!-- Used for editing -->
                 <div class="data-form" style="grid-template-columns: 1fr;"> <!-- Single column for task details -->
                     <div class="form-group">
                         <label for="taskTitle">Task Title <span style="color: var(--danger)">*</span></label>
                         <input type="text" id="taskTitle" class="form-control" required>
                     </div>
                     <div class="form-group">
                         <label for="taskDescription">Description</label>
                         <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                     </div>
                 </div>
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;"> <!-- Two columns for details -->
                     <div class="form-group">
                         <label for="taskAssignee">Assignee</label>
                         <select id="taskAssignee" class="form-control">
                             <option value="">Unassigned</option>
                             <!-- Assignees populated by JS -->
                         </select>
                     </div>
                     <div class="form-group">
                         <label for="taskDueDate">Due Date</label>
                         <input type="date" id="taskDueDate" class="form-control">
                     </div>
                     <div class="form-group">
                         <label for="taskPriority">Priority</label>
                         <select id="taskPriority" class="form-control">
                             <option value="low">Low</option>
                             <option value="medium" selected>Medium</option>
                             <option value="high">High</option>
                         </select>
                     </div>
                     <div class="form-group">
                         <label for="taskStatus">Status</label>
                         <select id="taskStatus" class="form-control">
                             <option value="todo">To Do</option>
                             <option value="inprogress">In Progress</option>
                             <option value="completed">Completed</option>
                             <option value="blocked">Blocked</option>
                         </select>
                     </div>
                 </div>
                 <div class="form-actions" style="grid-column: span 1;">
                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                     <button type="submit" class="btn btn-primary">Save Task</button>
                 </div>
             </form>
         </div>
     </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = document.getElementById('featureTitle');
            const featureDescEl = document.getElementById('featureDescription');
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const editMemberModal = document.getElementById('editMemberModal');
            const editMemberForm = document.getElementById('editMemberForm');
            const taskModal = document.getElementById('taskModal'); // Task Modal
            const taskForm = document.getElementById('taskForm'); // Task Form

            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let mockTasks = []; // Task Management data
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let taskCheckIntervalId = null; // For checking due dates
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let taskFilters = { status: '', priority: '', assigneeId: '', dueDate: '' }; // Task filter state
            let taskSort = { column: 'dueDate', direction: 'asc' }; // Task sort state


            // --- Mock Data ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'YA', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'EL', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', title: 'Junior Designer', department: 'Design', phone: '+20155444333', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
                 // *** FIX 4️⃣: Add Nada Mahmoud ***
                 { id: 5, name: 'Nada Mahmoud', email: 'nada@example.com', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'NM', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            // Task Management Mock Data - Including requested assignees and subtasks
            function initializeMockTasks() {
                const today = new Date();
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
                const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                const lastWeek = new Date(today); lastWeek.setDate(today.getDate() - 7);

                // Helper to get user ID by name fragment
                const getUserId = (nameFragment) => {
                    const user = MOCK_USERS.find(u => u.name.toLowerCase().includes(nameFragment.toLowerCase()));
                    return user ? user.id : null;
                }

                mockTasks = [
                    { id: 301, title: 'Design Landing Page Mockups', description: 'Create 3 variations for the new landing page.', assigneeId: getUserId('Bassant'), dueDate: formatInputDate(tomorrow), priority: 'high', status: 'inprogress', subtasks: [
                        { id: 3011, parentId: 301, title: 'Wireframe Concept 1', status: 'completed' },
                        { id: 3012, parentId: 301, title: 'Wireframe Concept 2', status: 'inprogress' },
                        { id: 3013, parentId: 301, title: 'Final Polish', status: 'todo' },
                    ], isExpanded: false },
                    { id: 302, title: 'Develop Authentication API', description: 'Setup JWT authentication endpoints.', assigneeId: getUserId('Esraa'), dueDate: formatInputDate(nextWeek), priority: 'high', status: 'todo', subtasks: [], isExpanded: false },
                    { id: 303, title: 'User Testing Setup', description: 'Prepare test scripts and schedule sessions.', assigneeId: getUserId('Yousef'), dueDate: formatInputDate(nextWeek), priority: 'medium', status: 'todo', subtasks: [
                         { id: 3031, parentId: 303, title: 'Write Test Scenarios', status: 'todo' },
                         { id: 3032, parentId: 303, title: 'Recruit Testers', status: 'todo' },
                    ], isExpanded: false },
                    { id: 304, title: 'Review Marketing Copy', description: 'Review and approve copy for the upcoming campaign.', assigneeId: getUserId('Nada'), dueDate: formatInputDate(yesterday), priority: 'medium', status: 'completed', subtasks: [], isExpanded: false }, // Example completed
                    { id: 305, title: 'Fix Button Alignment on Profile Page', description: 'The save button is slightly off.', assigneeId: getUserId('Esraa'), dueDate: formatInputDate(today), priority: 'low', status: 'inprogress', subtasks: [], isExpanded: false },
                    { id: 306, title: 'Plan Q3 Roadmap', description: 'Outline key initiatives for the next quarter.', assigneeId: getUserId('Mohamed'), dueDate: formatInputDate(lastWeek), priority: 'high', status: 'blocked', subtasks: [], isExpanded: false }, // Example overdue and blocked
                    { id: 307, title: 'Create Social Media Graphics', description: '', assigneeId: getUserId('Bassant'), dueDate: null, priority: 'low', status: 'todo', subtasks: [], isExpanded: false }, // No due date
                ];
            }

            // --- Initialization ---
            function initDashboard() {
                // Simulate loading current user (using the first mock user)
                currentUser = { ...MOCK_USERS[0] }; // Use a copy
                console.log("Initializing dashboard for:", currentUser.name);

                initializeMockTasks(); // Initialize tasks AFTER users are defined

                applyStoredPreferences(); // Apply theme, contrast etc. *before* other UI updates
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Navigate based on URL hash first
                startDynamicUpdates(); // Start intervals for data refresh
                setupResponsiveSidebar();
            }

            // --- UI Updates ---
            function updateUserUI() {
                if (!currentUser) return;

                // Top Nav User Menu
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.initials;
                 if (currentUser.avatar) {
                    document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                    document.getElementById('userAvatar').textContent = ''; // Clear initials if avatar exists
                } else {
                    document.getElementById('userAvatar').style.backgroundImage = 'none';
                    document.getElementById('userAvatar').textContent = currentUser.initials;
                }

                // Welcome Section
                document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userInfoName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) {
                    document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                     document.getElementById('profileAvatar').textContent = '';
                } else {
                    document.getElementById('profileAvatar').style.backgroundImage = 'none';
                    document.getElementById('profileAvatar').textContent = currentUser.initials;
                }

                // User Role Title
                const roleTitle = document.getElementById('userInfoRoleTitle');
                roleTitle.textContent = formatRole(currentUser.role);
                roleTitle.className = `user-info-title role-${currentUser.role}`; // Apply role class

                // Profile Page Elements
                updateProfileForm();
                profileAvatarLarge.textContent = currentUser.initials;
                if (currentUser.avatar) {
                    profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                     profileAvatarLarge.textContent = '';
                } else {
                    profileAvatarLarge.style.backgroundImage = 'none';
                    profileAvatarLarge.textContent = currentUser.initials;
                }
                // Update Account panel email display
                if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;


                // Admin specific elements
                const teamSettingsTab = document.getElementById('teamSettingsTab');
                const dangerZoneTab = document.getElementById('dangerZoneTab');
                 if (currentUser.role === 'admin') {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; // Use flex for tabs
                    if (dangerZoneTab) dangerZoneTab.style.display = 'flex';
                } else {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'none';
                     if (dangerZoneTab) dangerZoneTab.style.display = 'none';
                     // Hide team panel if not admin and trying to access it directly
                     if (currentFeature === 'settings' && currentSettingsTab === 'team') {
                         activateSettingsTab('preferences'); // Default to preferences
                     }
                     if (currentFeature === 'settings' && currentSettingsTab === 'danger') {
                         activateSettingsTab('preferences');
                     }
                }

                // Update 2FA UI based on current user status
                update2FA_UI();
                userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
            }

            function updateProfileForm() {
                if (!currentUser) return;
                const nameParts = currentUser.name.split(' ');
                firstNameInput.value = nameParts[0] || '';
                lastNameInput.value = nameParts.slice(1).join(' ') || '';
                fullNameDisplay.value = currentUser.name; // Update readonly full name
                jobTitleInput.value = currentUser.title || '';
                emailDisplay.value = currentUser.email || '';
                phoneInput.value = currentUser.phone || '';
                departmentInput.value = currentUser.department || '';
            }

            function formatRole(role) {
                if (!role) return 'Member';
                return role.charAt(0).toUpperCase() + role.slice(1); // Capitalize first letter
            }

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() {
                // Theme
                const storedTheme = localStorage.getItem('theme') || 'system'; // Default to system
                setTheme(storedTheme);

                // Contrast
                const storedContrast = localStorage.getItem('highContrast') === 'true';
                setContrast(storedContrast);
                if (highContrastToggle) highContrastToggle.checked = storedContrast;

                // Language
                const storedLang = localStorage.getItem('language') || 'en';
                if (languageSelect) languageSelect.value = storedLang;
                applyLanguage(storedLang);

                 // Region/Timezone (Just set the dropdown)
                 const storedRegion = localStorage.getItem('region') || 'utc';
                 if (regionSelect) regionSelect.value = storedRegion;

                // Date/Time Format
                const storedTimeFormat = localStorage.getItem('timeFormat') || '12h';
                const storedDateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                if (timeFormatSelect) timeFormatSelect.value = storedTimeFormat;
                if (dateFormatSelect) dateFormatSelect.value = storedDateFormat;
                applyDateTimeFormat(storedTimeFormat, storedDateFormat);

                 // Toast Notifications
                const storedToastPref = localStorage.getItem('showToasts');
                // Default to true if not set
                showToasts = storedToastPref === null ? true : (storedToastPref === 'true');
                if (toastToggle) toastToggle.checked = showToasts;

                // Sound Notifications
                const storedSoundPref = localStorage.getItem('playSounds');
                playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true');
                if (soundToggle) soundToggle.checked = playSounds;

            }

            function setTheme(theme) {
                 console.log("Setting theme:", theme);
                 document.body.classList.remove('light-theme', 'dark-theme'); // Remove existing theme classes

                 if (theme === 'system') {
                    // Use matchMedia to detect system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.classList.add(prefersDark ? 'dark-theme' : 'light-theme');
                 } else {
                     document.body.classList.add(`${theme}-theme`);
                 }

                 // Update selection state in UI
                 themeOptions.forEach(option => {
                     option.classList.toggle('selected', option.dataset.theme === theme);
                 });

                 localStorage.setItem('theme', theme); // Save preference
            }

            function setContrast(enabled) {
                 console.log("Setting high contrast:", enabled);
                 document.body.classList.toggle('high-contrast', enabled);
                 localStorage.setItem('highContrast', enabled);
            }

             function applyLanguage(lang) {
                 console.log("Applying language:", lang);
                 // --- Simulation ---
                 // In a real app, this would trigger loading translation files
                 // and updating all text elements. Here, we just update a few examples.
                 document.documentElement.lang = lang; // Set HTML lang attribute

                 if (lang === 'ar') {
                     document.body.dir = 'rtl'; // Basic RTL support
                     if (document.getElementById('welcomeName')) document.getElementById('welcomeName').textContent = "مستخدم"; // Example
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "لوحة التحكم";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "الإعدادات";
                     // Update more labels as needed for simulation
                 } else {
                     document.body.dir = 'ltr';
                      // Revert to English if needed (assuming English is the base)
                      if (document.getElementById('welcomeName') && currentUser) document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "Dashboard";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "Settings";
                 }
                 localStorage.setItem('language', lang);
                 // --- End Simulation ---
             }

             function applyDateTimeFormat(timeFormat, dateFormat) {
                console.log("Applying DateTime Format:", timeFormat, dateFormat);
                // Store preferences for use by formatting functions
                localStorage.setItem('timeFormat', timeFormat);
                localStorage.setItem('dateFormat', dateFormat);
                // Re-render any visible dates/times if needed (e.g., activity list, tasks)
                if (currentFeature === 'dashboard') {
                    if (activityList.children.length > 0 && activities.length > 0) {
                        loadRecentActivities(showingAllActivities);
                    }
                    if (notifications.length > 0) {
                        renderNotifications(); // Refresh notifications too
                    }
                }
                 // Re-render schedule if visible
                 if (currentFeature === 'employee-scheduling') {
                     const scheduleTableBody = document.getElementById('scheduleTableBody');
                     if (scheduleTableBody) {
                         renderSchedule(currentScheduleWeekOffset);
                     }
                 }
                  // Re-render tasks if visible
                 if (currentFeature === 'task-management') {
                     const taskTableBody = document.getElementById('taskTableBody');
                     if (taskTableBody) {
                         applyTaskFiltersAndSort(); // Re-renders table with new format
                     }
                 }
             }

             function applyToastPreference(enabled) {
                 console.log("Applying toast preference:", enabled);
                 showToasts = enabled;
                 localStorage.setItem('showToasts', enabled);
             }

             function applySoundPreference(enabled) {
                 console.log("Applying sound preference:", enabled);
                 playSounds = enabled;
                 localStorage.setItem('playSounds', enabled);
             }


            // --- Navigation & Content Loading ---
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));
                currentFeature = featureId;

                // Update Menu Items
                menuItems.forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                });

                // Hide all top-level content sections first
                contentSections.forEach(section => section.classList.remove('active'));

                // Reset feature container styles and content
                featureSectionsContainer.classList.remove('employee-scheduling', 'task-management'); // Remove specific feature classes
                featureSectionsContainer.innerHTML = ''; // Clear dynamic content
                featurePlaceholder.style.display = 'flex'; // Show placeholder by default
                featureLoadingEl.style.display = 'none';
                featureErrorEl.style.display = 'none';
                // Add placeholder back to the container temporarily
                featureSectionsContainer.appendChild(featurePlaceholder);


                // Show the correct section
                let targetSection = null;
                let isFeatureSection = false;

                if (featureId === 'dashboard') {
                    targetSection = dashboardContent;
                    backButton.style.display = 'none';
                } else if (featureId === 'profile') {
                    targetSection = profileContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                     updateProfileForm(); // Ensure form has latest data when navigating here
                } else if (featureId === 'settings') {
                    targetSection = settingsContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    currentSettingsTab = settingsTab || (currentUser.role === 'admin' ? 'preferences' : 'preferences'); // Default tab
                    // Ensure non-admins don't land on restricted tabs
                     if (currentUser.role !== 'admin' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) {
                         currentSettingsTab = 'preferences';
                     }
                    activateSettingsTab(currentSettingsTab);
                     update2FA_UI(); // Ensure 2FA UI is correct when settings are shown
                } else {
                    // Handle other features - load into feature container
                    isFeatureSection = true;
                    targetSection = featureSectionsContainer;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';

                    // Load content for the feature
                    loadFeatureContent(featureId);
                }

                // Activate the target section (dashboard, profile, settings, or feature container)
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                // If it was a feature section, the placeholder inside might still be visible until content loads
                if (isFeatureSection) {
                    featurePlaceholder.style.display = 'none'; // Hide placeholder now that container is active
                }

                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                    if(closeSidebar) closeSidebar.style.display = 'none';
                }

                // Close user dropdown if open
                userDropdown.classList.remove('active');
                userDropdownOpen = false;


                if (!skipHistory) {
                    updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null);
                }
            }

            function activateSettingsTab(tabId) {
                console.log(`Activating settings tab: ${tabId}`);
                currentSettingsTab = tabId; // Update state

                // Update tabs visual state
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
                });

                // Update panels visibility
                document.querySelectorAll('.settings-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.id === `${tabId}Panel`);
                });

                // Load team list if team tab is activated
                if (tabId === 'team' && currentUser.role === 'admin') {
                     loadTeamMembers();
                }
                 // Update 2FA UI if security tab is activated
                 if (tabId === 'security') {
                     update2FA_UI();
                 }
                 // Update Account panel email if account tab is activated
                 if (tabId === 'account' && accountEmailDisplay) {
                     accountEmailDisplay.value = currentUser.email;
                 }
            }

            function loadFeatureContent(featureId) {
                const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';

                featurePlaceholder.style.display = 'none'; // Ensure placeholder is hidden
                featureLoadingEl.style.display = 'block'; // Show loading
                featureErrorEl.style.display = 'none';
                featureSectionsContainer.innerHTML = ''; // Clear previous content
                featureSectionsContainer.classList.remove('employee-scheduling', 'task-management'); // Reset class
                 // Add loading indicator to container while clearing
                featureSectionsContainer.appendChild(featurePlaceholder);
                featurePlaceholder.style.display = 'flex';
                featureTitleEl.textContent = '';
                featureDescEl.textContent = '';


                console.log(`Loading content for: ${featureName}`);

                // Simulate loading delay
                setTimeout(() => {
                    try {
                        featureLoadingEl.style.display = 'none';
                        featurePlaceholder.style.display = 'none'; // Hide placeholder before adding content
                        let contentHTML = '';

                        // Specific loading logic for features
                        if (featureId === 'employee-scheduling') {
                            featureSectionsContainer.classList.add('employee-scheduling'); // Add class for scoping CSS
                            contentHTML = getEmployeeScheduleHTML();
                            featureSectionsContainer.innerHTML = contentHTML;
                            initializeEmployeeScheduleLogic(); // Attach JS logic for this feature
                        }
                        // *** NEW: Load Task Management ***
                        else if (featureId === 'task-management') {
                            featureSectionsContainer.classList.add('task-management'); // Add class for scoping CSS
                            contentHTML = getTaskManagementHTML();
                            featureSectionsContainer.innerHTML = contentHTML;
                            initializeTaskManagementLogic(); // Attach JS logic for task management
                        }
                        // Add cases for other features here
                        // else if (featureId === 'projects') { ... }
                        else {
                            // Default placeholder for unimplemented features
                            featureSectionsContainer.innerHTML = ''; // Clear loading indicator
                            featurePlaceholder.style.display = 'flex';
                            featureTitleEl.textContent = featureName;
                            featureDescEl.textContent = `Content for ${featureName} would be loaded here. This feature is not yet implemented.`;
                            featureSectionsContainer.appendChild(featurePlaceholder); // Re-add placeholder
                        }

                    } catch (error) {
                        console.error(`Error loading feature ${featureId}:`, error);
                        featureLoadingEl.style.display = 'none';
                        featurePlaceholder.style.display = 'flex'; // Show placeholder again on error
                        featureErrorEl.textContent = `Failed to load ${featureName}. Error: ${error.message}`;
                        featureErrorEl.style.display = 'block';
                        featureSectionsContainer.appendChild(featurePlaceholder); // Show placeholder with error
                    }
                }, 500); // Simulate network delay
            }


            function updateBrowserHistory(featureId, settingsTab = null) {
                let hash = `#${featureId}`;
                if (featureId === 'settings' && settingsTab) {
                    hash += `-${settingsTab}`;
                }
                // Only push state if the hash is actually changing
                if (window.location.hash !== hash) {
                    // Use pushState for smoother navigation feel without page jumps
                    window.history.pushState({ feature: featureId, tab: settingsTab }, '', hash);
                }
            }

            function handleInitialNavigation() {
                const hash = window.location.hash.substring(1);
                console.log(`Handling navigation for hash: ${hash}`);
                let featureId = 'dashboard';
                let settingsTab = null;

                if (hash) {
                    if (hash.startsWith('settings-')) {
                        const parts = hash.split('-');
                        featureId = parts[0];
                        settingsTab = parts[1];
                    } else {
                        // Check if the hash corresponds to a known feature
                        const knownFeature = Array.from(menuItems).some(item => item.getAttribute('data-feature') === hash);
                        if (knownFeature) {
                            featureId = hash;
                        }
                        // else, default to dashboard
                    }
                }
                setActiveFeature(featureId, settingsTab, true); // Skip history update on initial load
            }

            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                console.log("Popstate event:", event.state, window.location.hash);
                // Re-parse the hash to determine where to navigate
                handleInitialNavigation();
            });


            // --- Data Loading & Simulation ---
            function loadInitialData() {
                loadDashboardStats();
                loadRecentActivities();
                loadNotifications();
                // Load team members only if settings/team tab is initially active and user is admin
                 if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') {
                     loadTeamMembers();
                 }
            }

            function loadDashboardStats() {
                 console.log("Loading dashboard stats...");
                 // Simulate API call
                 setTimeout(() => {
                     const teamMembersCount = MOCK_USERS.length; // Uses the current MOCK_USERS array length
                     // Calculate completed tasks (including subtasks)
                     let tasksCompleted = 0;
                     mockTasks.forEach(task => {
                         if (task.status === 'completed') tasksCompleted++;
                         task.subtasks.forEach(subtask => {
                             if (subtask.status === 'completed') tasksCompleted++;
                         })
                     });
                     tasksCompleted += Math.floor(Math.random() * 10); // Add some randomness

                     const activeProjects = MOCK_PROJECTS.filter(p => p.status === 'Active').length;
                     const upcomingDeadlines = mockTasks.filter(t => {
                         if (!t.dueDate) return false;
                         const dueDate = parseInputDate(t.dueDate);
                         const today = new Date(); today.setHours(0,0,0,0);
                         const sevenDays = new Date(today); sevenDays.setDate(today.getDate() + 7);
                         return dueDate >= today && dueDate <= sevenDays && t.status !== 'completed';
                     }).length;

                     updateStatCard('teamMembersCount', 'Team Members', 'fas fa-users', teamMembersCount, Math.random() * 10 - 5); // Random trend +/- 5%
                     updateStatCard('tasksCompleted', 'Tasks Completed', 'fas fa-check-circle', tasksCompleted, Math.random() * 20); // Random trend 0-20%
                     updateStatCard('activeProjects', 'Active Projects', 'fas fa-project-diagram', activeProjects, Math.random() * 5 - 2); // Random trend +/- 2%
                     updateStatCard('upcomingDeadlines', 'Upcoming Deadlines', 'fas fa-calendar-times', upcomingDeadlines, Math.random() * 15 - 10); // Random trend +/- 10%
                 }, 300);
            }

            function updateStatCard(id, title, iconClass, value, trendPercent) {
                 // Find the card within the stats section - more robust than fixed IDs
                 const cardIndex = ['teamMembersCount', 'tasksCompleted', 'activeProjects', 'upcomingDeadlines'].indexOf(id);
                 if (cardIndex === -1 || !statsSection || !statsSection.children[cardIndex]) return; // Add checks

                 const card = statsSection.children[cardIndex];

                 let trendClass = 'trend-neutral';
                 let trendIcon = 'fas fa-minus';
                 if (trendPercent > 1) {
                     trendClass = 'trend-up';
                     trendIcon = 'fas fa-arrow-up';
                 } else if (trendPercent < -1) {
                     trendClass = 'trend-down';
                     trendIcon = 'fas fa-arrow-down';
                 }

                 card.innerHTML = `
                    <div class="stat-title"><i class="${iconClass}"></i>${title}</div>
                    <div class="stat-value">
                        <span>${value}</span>
                        <span class="stat-trend ${trendClass}">
                            <i class="${trendIcon}"></i> ${trendPercent !== 0 ? Math.abs(trendPercent).toFixed(0) + '%' : ''}
                        </span>
                    </div>
                `;
            }

            function loadRecentActivities(showAll = false) {
                console.log("Loading recent activities...");
                // Simulate fetching activities
                // Generate initial activities only once if needed
                if (activities.length === 0) {
                    const now = Date.now(); // Get current time for generation
                    activities = generateMockActivities(15, now); // Generate sorted initial activities
                }

                showingAllActivities = showAll;
                const activitiesToDisplay = showAll ? activities : activities.slice(0, maxActivitiesToShow);

                activityList.innerHTML = ''; // Clear current list

                if (activitiesToDisplay.length === 0) {
                    activityList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>';
                    deleteAllActivity.style.display = 'none';
                    viewAllActivity.style.display = 'none';
                    return;
                }

                activitiesToDisplay.forEach((activity, index) => {
                    const li = document.createElement('li');
                    li.classList.add('activity-item');
                    li.dataset.id = activity.id;
                    if (activity.isNew) {
                         li.classList.add('new-activity');
                         // Remove the 'new' status after animation
                         setTimeout(() => {
                            activity.isNew = false;
                             // Check if the element still exists before removing class
                            const currentLi = activityList.querySelector(`[data-id='${activity.id}']`);
                            if (currentLi) currentLi.classList.remove('new-activity');
                         }, 2500);
                    }

                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon}"></i></div>
                        <div class="activity-content">
                            <div class="activity-message">${activity.message}</div>
                            <div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div>
                        </div>
                        <div class="activity-actions">
                            <i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i>
                        </div>
                    `;
                    activityList.appendChild(li);
                });

                 // Show/Hide buttons based on state
                 deleteAllActivity.style.display = activities.length > 0 ? 'inline-block' : 'none';
                 viewAllActivity.textContent = showAll ? 'Show Less' : 'Show All';
                 viewAllActivity.style.display = activities.length > maxActivitiesToShow ? 'inline-block' : 'none';

                 // Add event listeners for delete icons (delegated)
                 // Done in setupEventListeners
            }

            function loadNotifications() {
                 console.log("Loading notifications...");
                 // Simulate fetching notifications
                 if (notifications.length === 0) {
                     const now = Date.now(); // Get current time for generation
                     notifications = generateMockNotifications(8, now); // Generate sorted initial notifications
                 }

                 renderNotifications();
            }

            function renderNotifications() {
                 notificationsBody.innerHTML = ''; // Clear current list
                 const unreadCount = notifications.filter(n => n.unread).length;

                 if (notifications.length === 0) {
                     noNotificationsMessage.textContent = 'You have no notifications.';
                     noNotificationsMessage.style.display = 'block';
                     notificationBadge.style.display = 'none';
                     notificationBadge.textContent = '0';
                     markAllReadBtn.disabled = true;
                     deleteAllNotificationsBtn.disabled = true;
                     return;
                 }

                 noNotificationsMessage.style.display = 'none';
                 markAllReadBtn.disabled = unreadCount === 0;
                 deleteAllNotificationsBtn.disabled = false;

                 notifications.forEach(notification => {
                     const div = document.createElement('div');
                     div.classList.add('notification-list-item');
                     div.dataset.id = notification.id;
                     if (notification.unread) {
                         div.classList.add('unread');
                     }

                     div.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div>
                        </div>
                        <i class="fas fa-times delete-notification" title="Delete Notification"></i>
                    `;
                    notificationsBody.appendChild(div);
                 });

                 // Update badge
                 notificationBadge.textContent = unreadCount;
                 notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

                 // Add event listeners (delegated)
                 // Done in setupEventListeners
            }

             function loadTeamMembers() {
                 const teamListContainer = document.getElementById('teamList');
                 if (!teamListContainer) return;

                 console.log("Loading team members for settings...");
                 teamListContainer.innerHTML = '<p style="color: var(--gray);">Loading...</p>'; // Loading indicator

                 // Simulate API call
                 setTimeout(() => {
                     teamListContainer.innerHTML = ''; // Clear loading
                     if (MOCK_USERS.length === 0) {
                         teamListContainer.innerHTML = '<p style="color: var(--gray);">No team members found.</p>';
                         return;
                     }

                     MOCK_USERS.forEach(member => {
                         const card = document.createElement('div');
                         card.classList.add('team-member-card');
                         card.dataset.id = member.id;

                         const avatarStyle = member.avatar ? `background-image: url('${member.avatar}')` : '';
                         const avatarContent = member.avatar ? '' : member.initials;

                         card.innerHTML = `
                            <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div class="member-details">
                                <div class="member-name">${member.name}</div>
                                <div class="member-email">${member.email}</div>
                            </div>
                            <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                            ${currentUser.id !== member.id ? ` <!-- Don't show actions for self -->
                            <div class="member-actions">
                                <button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            ` : '<div class="member-actions" style="width: 70px;"></div>' /* Placeholder for alignment */}
                        `;
                         teamListContainer.appendChild(card);
                     });

                     // Add event listeners for edit/remove (delegated)
                 }, 500);
             }


            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() {
                // Simulate new activity every 10-20 seconds
                if (activityIntervalId) clearInterval(activityIntervalId);
                activityIntervalId = setInterval(() => {
                    const newActivity = generateMockActivities(1, Date.now())[0]; // Use current time
                    newActivity.isNew = true; // Mark as new
                    activities.unshift(newActivity); // Add to beginning
                    if (activities.length > 50) activities.pop(); // Limit history size
                    if (currentFeature === 'dashboard') { // Only update UI if dashboard is visible
                       loadRecentActivities(showingAllActivities); // Refresh list
                    }
                    showToast(`New Activity: ${newActivity.message.substring(0, 30)}...`, 'info');
                    playNotificationSound();
                }, Math.random() * 10000 + 10000);

                // Simulate new notification every 20-40 seconds
                 if (notificationIntervalId) clearInterval(notificationIntervalId);
                 notificationIntervalId = setInterval(() => {
                    const newNotification = generateMockNotifications(1, Date.now())[0]; // Use current time
                    newNotification.unread = true;
                    notifications.unshift(newNotification); // Add to beginning
                    if (notifications.length > 30) notifications.pop(); // Limit history
                    renderNotifications(); // Always refresh notification list & badge
                    playNotificationSound(); // Play sound for new notification
                 }, Math.random() * 20000 + 20000);

                // Simulate stats changing every 30 seconds
                 if (statsIntervalId) clearInterval(statsIntervalId);
                 statsIntervalId = setInterval(loadDashboardStats, 30000);

                 // Simulate Welcome section background change every 15 seconds
                 if (welcomeBgIntervalId) clearInterval(welcomeBgIntervalId);
                 welcomeBgIntervalId = setInterval(changeWelcomeBackground, 15000);

                 // Check task due dates periodically (e.g., every minute)
                 if (taskCheckIntervalId) clearInterval(taskCheckIntervalId);
                 taskCheckIntervalId = setInterval(checkTaskDueDates, 60 * 1000);
            }

            function changeWelcomeBackground() {
                const backgrounds = ['--welcome-bg-1', '--welcome-bg-2', '--welcome-bg-3'];
                // Get current background from computed style (more reliable)
                const currentBgVar = getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim();
                let currentIndex = backgrounds.indexOf(currentBgVar);
                if (currentIndex === -1) currentIndex = 0; // Default if not found

                const nextIndex = (currentIndex + 1) % backgrounds.length;
                document.documentElement.style.setProperty('--welcome-bg-current', `var(${backgrounds[nextIndex]})`);
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                // Sidebar Toggle
                 if (sidebarToggle) {
                     sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.add('active');
                         mainContent.classList.add('sidebar-active');
                         if(closeSidebar) closeSidebar.style.display = 'block'; // Show close button inside
                    });
                 }
                 if (closeSidebar) {
                     closeSidebar.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                        mainContent.classList.remove('sidebar-active');
                        closeSidebar.style.display = 'none';
                     });
                 }
                 // Close sidebar if clicking outside on mobile
                 document.addEventListener('click', (event) => {
                    if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                        const isClickInsideSidebar = sidebar.contains(event.target);
                        const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target);
                        if (!isClickInsideSidebar && !isClickOnToggler) {
                            sidebar.classList.remove('active');
                            mainContent.classList.remove('sidebar-active');
                            if(closeSidebar) closeSidebar.style.display = 'none';
                        }
                    }
                 });


                // Menu Items
                menuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const featureId = this.getAttribute('data-feature');
                        ```javascript
                        setActiveFeature(featureId);
                    });
                });

                // Settings Tabs & Links within settings panels
                 document.body.addEventListener('click', function(e) { // Delegate to body for links inside panels
                    const target = e.target;
                    // Handle direct tab clicks
                    if (target.closest('.settings-tab') && !target.closest('.settings-tab.active')) {
                        const tabId = target.closest('.settings-tab').getAttribute('data-tab');
                        activateSettingsTab(tabId);
                        updateBrowserHistory('settings', tabId);
                    }
                    // Handle clicks on links that target a settings tab (e.g., from Account to Security)
                    else if (target.closest('.settings-link') && target.closest('.settings-link').dataset.tabTarget) {
                        e.preventDefault();
                        const tabId = target.closest('.settings-link').dataset.tabTarget;
                         setActiveFeature('settings', tabId); // Use setActiveFeature to ensure panel switch
                    }
                 });

                // Back Button
                backButton.addEventListener('click', function() {
                    setActiveFeature('dashboard');
                });

                // User Dropdown Toggle
                userProfileContainer.addEventListener('click', function(e) {
                     // Prevent clicks on links inside dropdown from closing it immediately
                     if (e.target.closest('.dropdown-item')) {
                         // Allow default link behavior or handle navigation
                         const feature = e.target.closest('.dropdown-item').getAttribute('data-feature');
                         if (feature) {
                             setActiveFeature(feature);
                             // Keep dropdown open - Note: setActiveFeature might close it,
                             // so we might need to reopen or prevent closing in setActiveFeature
                             // For now, let setActiveFeature handle closing it.
                         } else if (e.target.closest('#logoutLink')) {
                            // Logout handled below by its own listener
                         }
                         // Optionally: e.stopPropagation(); if links handled purely by JS
                         return; // Let link handlers below work
                     }
                     userDropdownOpen = !userDropdownOpen;
                     userDropdown.classList.toggle('active', userDropdownOpen);
                });

                // Close dropdown if clicking outside
                 document.addEventListener('click', function(event) {
                     if (!userProfileContainer.contains(event.target) && userDropdownOpen) {
                         userDropdown.classList.remove('active');
                         userDropdownOpen = false;
                     }
                 });

                // Search Input & Results
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('focus', handleSearch); // Show results on focus if input exists
                 // Hide search results when clicking outside
                 document.addEventListener('click', (event) => {
                    if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) {
                        searchResultsContainer.classList.remove('active');
                    }
                 });
                 // Handle clicking on a search result item (Event Delegation)
                 searchResultsContainer.addEventListener('click', (event) => {
                     const targetItem = event.target.closest('.search-result-item');
                     if (targetItem && targetItem.dataset.feature) {
                         const featureId = targetItem.dataset.feature;
                         const itemId = targetItem.dataset.id; // Optional ID for specific item
                         console.log(`Search result clicked: Feature=${featureId}, ID=${itemId}`);
                         // Navigate to the feature/item
                         setActiveFeature(featureId);
                         // Potentially scroll to or highlight the item if ID is present (needs implementation for tasks)
                          if (featureId === 'task-management' && itemId) {
                              // Highlight or focus task - implementation needed in renderTaskTable
                          }
                         searchResultsContainer.classList.remove('active');
                         searchInput.value = ''; // Clear search input
                     }
                 });

                // Notifications Modal
                notificationIcon.addEventListener('click', () => {
                     notificationsModal.classList.add('active');
                     // Optionally mark notifications as read when opened
                     // markAllNotificationsAsRead();
                });
                closeNotifications.addEventListener('click', () => {
                    notificationsModal.classList.remove('active');
                });
                 notificationsModal.addEventListener('click', (event) => { // Close on backdrop click
                    if (event.target === notificationsModal) {
                        notificationsModal.classList.remove('active');
                    }
                 });

                 // Notification Actions (Event Delegation)
                 notificationsBody.addEventListener('click', (event) => {
                     const target = event.target;
                     const notificationItem = target.closest('.notification-list-item');
                     const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null;

                     if (target.classList.contains('delete-notification') && notificationId) {
                         // Delete single notification
                         showConfirmModal('Delete Notification', 'Are you sure you want to delete this notification?', () => {
                             notifications = notifications.filter(n => n.id !== notificationId);
                             renderNotifications();
                             showToast('Notification deleted.', 'success');
                         });
                     } else if (notificationItem && notificationId) {
                         // Mark single as read on click
                         const notification = notifications.find(n => n.id === notificationId);
                         if (notification && notification.unread) {
                             notification.unread = false;
                             renderNotifications(); // Update UI immediately
                         }
                         // Optional: Navigate to related content if applicable
                         console.log(`Clicked notification ${notificationId}`);
                          // Example: If notification relates to a task, navigate
                          // if (notification.relatedFeature === 'task-management' && notification.relatedId) {
                          //    setActiveFeature('task-management');
                          //    // Highlight task notification.relatedId
                          //}
                     }
                 });

                 markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
                 deleteAllNotificationsBtn.addEventListener('click', () => {
                     if (notifications.length === 0) return;
                     showConfirmModal('Delete All Notifications', 'Are you sure you want to delete ALL notifications? This cannot be undone.', () => {
                         notifications = [];
                         renderNotifications();
                         showToast('All notifications deleted.', 'success');
                     });
                 });

                // Activity List Actions (Event Delegation)
                 activityList.addEventListener('click', (event) => {
                     const target = event.target;
                     if (target.classList.contains('delete-activity')) {
                         const activityItem = target.closest('.activity-item');
                         const activityId = activityItem ? parseInt(activityItem.dataset.id) : null;
                         if (activityId) {
                             // No confirmation for single activity delete for simplicity
                             activities = activities.filter(a => a.id !== activityId);
                             loadRecentActivities(showingAllActivities); // Refresh list
                             showToast('Activity deleted.', 'info'); // Use info toast
                         }
                     }
                 });

                viewAllActivity.addEventListener('click', () => {
                    loadRecentActivities(!showingAllActivities);
                });

                deleteAllActivity.addEventListener('click', () => {
                    if (activities.length === 0) return;
                    showConfirmModal('Delete All Activities', 'Are you sure you want to delete ALL activities? This cannot be undone.', () => {
                        activities = [];
                        loadRecentActivities(false); // Refresh list (will show empty state)
                        showToast('All activities deleted.', 'info'); // Use info toast
                    });
                });

                // Profile Form Handling
                 profileAvatarLarge.addEventListener('click', () => {
                    profileAvatarInput.click(); // Trigger hidden file input
                 });
                 profileAvatarInput.addEventListener('change', handleAvatarUpload);

                 profileForm.addEventListener('submit', handleProfileSave);
                 cancelProfileBtn.addEventListener('click', handleProfileCancel);

                 // Update full name display when first/last name changes
                 firstNameInput.addEventListener('input', updateFullNameDisplay);
                 lastNameInput.addEventListener('input', updateFullNameDisplay);

                 // Logout Link
                 logoutLink.addEventListener('click', handleLogout);

                 // Team Management Actions (Event Delegation on teamList)
                 const teamListContainer = document.getElementById('teamList');
                 if (teamListContainer) {
                    teamListContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        const memberCard = target.closest('.team-member-card');
                        const memberId = memberCard ? parseInt(memberCard.dataset.id) : null;

                        if (!memberId || memberId === currentUser.id) return; // Ignore clicks not on buttons or on self

                        if (target.closest('.edit-member')) {
                            console.log(`Edit member ${memberId}`);
                            openEditMemberModal(memberId); // Open the edit modal
                        } else if (target.closest('.remove-member')) {
                            console.log(`Remove member ${memberId}`);
                             const memberToRemove = MOCK_USERS.find(u => u.id === memberId);
                             showConfirmModal('Remove Team Member', `Are you sure you want to remove ${memberToRemove?.name || 'this member'}? This will also unassign their tasks.`, () => {
                                // Simulate backend call before updating UI
                                showToast(`Removing ${memberToRemove?.name || 'member'}...`, 'info');
                                setTimeout(() => {
                                    const removedUserId = memberId;
                                    MOCK_USERS = MOCK_USERS.filter(u => u.id !== removedUserId); // Update mock data
                                    // Unassign tasks from the removed user
                                    mockTasks = mockTasks.map(task => {
                                        if (task.assigneeId === removedUserId) {
                                            return { ...task, assigneeId: null }; // Unassign
                                        }
                                        return task;
                                    });

                                    loadTeamMembers(); // Refresh list in settings
                                    loadDashboardStats(); // Update dashboard stats (team count)

                                    // Refresh schedule view if it's currently active
                                    if (currentFeature === 'employee-scheduling') {
                                         const scheduleTableBody = document.getElementById('scheduleTableBody');
                                         if(scheduleTableBody) { // Check if schedule body exists
                                            renderSchedule(currentScheduleWeekOffset); // Re-render schedule with updated user list
                                         }
                                    }
                                    // Refresh task view if it's currently active
                                    if (currentFeature === 'task-management') {
                                        const taskAssigneeFilter = document.getElementById('taskAssigneeFilter');
                                        if (taskAssigneeFilter) populateAssigneeFilter(); // Repopulate filter dropdown
                                        applyTaskFiltersAndSort(); // Re-render tasks
                                    }

                                    showToast('Team member removed.', 'success');
                                }, 500); // Simulate delay
                             }, 'btn-danger');
                        }
                    });
                 }

                 // Edit Member Modal Form Submission
                 if (editMemberForm) {
                     editMemberForm.addEventListener('submit', handleEditMemberSave);
                 }
                 // Edit Member Modal Close Buttons
                 if(editMemberModal) {
                     editMemberModal.querySelectorAll('[data-close-modal]').forEach(btn => {
                         btn.addEventListener('click', () => editMemberModal.classList.remove('active'));
                     });
                     editMemberModal.addEventListener('click', (event) => { // Close on backdrop click
                         if (event.target === editMemberModal) {
                             editMemberModal.classList.remove('active');
                         }
                     });
                 }


                 // Invite Member Form
                 const inviteMemberForm = document.getElementById('inviteMemberForm');
                 if (inviteMemberForm) {
                     inviteMemberForm.addEventListener('submit', handleInviteMember);
                 }

                 // Settings Controls Listeners
                 themeOptions.forEach(option => {
                     option.addEventListener('click', () => setTheme(option.dataset.theme));
                 });
                 if (highContrastToggle) {
                     highContrastToggle.addEventListener('change', (e) => setContrast(e.target.checked));
                 }
                 if (languageSelect) {
                     languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value));
                 }
                 if (regionSelect) {
                    regionSelect.addEventListener('change', (e) => localStorage.setItem('region', e.target.value)); // Just save for now
                 }
                 if (timeFormatSelect || dateFormatSelect) {
                    const applyDateTimeListener = () => {
                        applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value);
                    };
                    if (timeFormatSelect) timeFormatSelect.addEventListener('change', applyDateTimeListener);
                    if (dateFormatSelect) dateFormatSelect.addEventListener('change', applyDateTimeListener);
                 }

                 if (toastToggle) {
                    toastToggle.addEventListener('change', (e) => applyToastPreference(e.target.checked));
                 }
                 if (soundToggle) {
                     soundToggle.addEventListener('change', (e) => applySoundPreference(e.target.checked));
                 }

                // Settings Save Buttons
                if(savePreferencesBtn) savePreferencesBtn.addEventListener('click', handleSavePreferences);
                if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
                if(saveAccountSettingsBtn) saveAccountSettingsBtn.addEventListener('click', handleSaveAccountSettings);
                if(saveSessionSettingsBtn) saveSessionSettingsBtn.addEventListener('click', handleSaveSessionSettings);
                if(saveNotificationSettingsBtn) saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);

                 // 2FA Button Listeners
                 if (enable2faBtn) enable2faBtn.addEventListener('click', handleEnable2FA);
                 if (setupAuthAppBtn) setupAuthAppBtn.addEventListener('click', showAuthAppSetup);
                 if (setupSmsBtn) setupSmsBtn.addEventListener('click', showSmsSetup);
                 if (verifyAuthCodeBtn) verifyAuthCodeBtn.addEventListener('click', handleVerifyAuthCode); // Simulate verification
                 if (sendSmsCodeBtn) sendSmsCodeBtn.addEventListener('click', handleSendSmsCode); // Simulate sending
                 if (verifySmsCodeBtn) verifySmsCodeBtn.addEventListener('click', handleVerifySmsCode); // Simulate verification
                 if (disable2faBtn) disable2faBtn.addEventListener('click', handleDisable2FA);

                 // Danger Zone Button Listeners
                 if(logoutAllDevicesBtn) logoutAllDevicesBtn.addEventListener('click', handleLogoutAllDevices);
                 if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);


                // Confirm Modal Buttons
                cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                confirmBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    hideConfirmModal();
                });

                // --- Task Management Listeners (Added within initializeTaskManagementLogic) ---
                // This includes filters, add button, modal form, table actions, etc.

                 // Add/Edit Task Modal Listeners
                 if (taskModal) {
                     taskModal.querySelectorAll('[data-close-modal]').forEach(btn => {
                         btn.addEventListener('click', () => taskModal.classList.remove('active'));
                     });
                     taskModal.addEventListener('click', (event) => { // Close on backdrop click
                         if (event.target === taskModal) {
                            taskModal.classList.remove('active');
                         }
                     });
                     taskForm.addEventListener('submit', handleTaskFormSubmit);
                 }
            } // End of setupEventListeners

            // --- Specific Feature Logic ---

             function setupResponsiveSidebar() {
                 // Logic moved to setupEventListeners previously
             }

            // --- Search Logic ---
            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                searchResultsContainer.innerHTML = ''; // Clear previous results

                if (searchTerm.length < 2) { // Only search if 2+ characters
                    searchResultsContainer.classList.remove('active');
                    return;
                }

                console.log(`Searching for: ${searchTerm}`);
                const results = [];

                // Search Users
                MOCK_USERS.forEach(user => {
                    if (user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) {
                         results.push({
                             type: 'User',
                             id: user.id,
                             name: user.name,
                             description: user.email,
                             icon: 'fa-user',
                             feature: 'team-members-view' // Feature to navigate to
                         });
                    }
                });

                // Search Projects
                MOCK_PROJECTS.forEach(project => {
                     if (project.name.toLowerCase().includes(searchTerm)) {
                         results.push({
                             type: 'Project',
                             id: project.id,
                             name: project.name,
                             description: `Status: ${project.status}`,
                             icon: 'fa-briefcase',
                             feature: 'projects'
                         });
                     }
                });

                // Search Tasks (including Subtasks)
                 mockTasks.forEach(task => {
                     // Search parent task
                     if (task.title.toLowerCase().includes(searchTerm)) {
                         const assigneeName = MOCK_USERS.find(u => u.id === task.assigneeId)?.name || 'Unassigned';
                         results.push({
                             type: 'Task',
                             id: task.id,
                             name: task.title,
                             description: `Assignee: ${assigneeName} | Status: ${formatStatus(task.status)}`,
                             icon: 'fa-tasks',
                             feature: 'task-management'
                         });
                     }
                     // Search subtasks
                     task.subtasks.forEach(subtask => {
                         if (subtask.title.toLowerCase().includes(searchTerm)) {
                              const assigneeName = MOCK_USERS.find(u => u.id === task.assigneeId)?.name || 'Unassigned'; // Subtasks inherit assignee for now
                             results.push({
                                 type: 'Subtask',
                                 id: subtask.id, // Subtask ID might be different
                                 parentId: task.id, // Link to parent
                                 name: subtask.title,
                                 description: `Parent: ${task.title.substring(0,20)}... | Assignee: ${assigneeName}`,
                                 icon: 'fa-check-square', // Different icon?
                                 feature: 'task-management' // Navigate to task management
                             });
                         }
                     });
                 });

                 // Search Sidebar Features
                 menuItems.forEach(item => {
                     const featureName = item.querySelector('span')?.textContent;
                     const featureId = item.getAttribute('data-feature');
                     if (featureName && featureId && featureName.toLowerCase().includes(searchTerm)) {
                         // Avoid duplicates if already found via other searches
                         if (!results.some(r => r.feature === featureId && !['User', 'Project', 'Task', 'Subtask'].includes(r.type))) {
                             results.push({
                                 type: 'Feature',
                                 id: null,
                                 name: featureName,
                                 description: 'Navigate to section',
                                 icon: item.querySelector('i')?.className.split(' ')[1] || 'fa-compass', // Get icon class
                                 feature: featureId
                             });
                         }
                     }
                 });


                if (results.length > 0) {
                    results.slice(0, 10).forEach(result => { // Limit to 10 results
                        const item = document.createElement('div');
                        item.classList.add('search-result-item');
                        item.dataset.feature = result.feature;
                        if (result.id) item.dataset.id = result.id;
                         if (result.parentId) item.dataset.parentId = result.parentId; // Add parent ID for subtasks

                        item.innerHTML = `
                            <i class="fas ${result.icon}"></i>
                            <div>
                                <strong>${result.name}</strong> <small>(${result.type})</small><br>
                                <span style="font-size: 0.8em; color: var(--gray);">${result.description}</span>
                            </div>
                        `;
                        searchResultsContainer.appendChild(item);
                    });
                    searchResultsContainer.classList.add('active');
                } else {
                    searchResultsContainer.innerHTML = '<div class="search-result-item" style="text-align: center; color: var(--gray); cursor: default;">No results found.</div>';
                    searchResultsContainer.classList.add('active');
                }
            }


            // --- Profile Logic ---
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        // Update UI previews
                        profileAvatarLarge.style.backgroundImage = `url(${imageUrl})`;
                        profileAvatarLarge.textContent = ''; // Hide initials
                        document.getElementById('userAvatar').style.backgroundImage = `url(${imageUrl})`;
                        document.getElementById('userAvatar').textContent = '';
                        document.getElementById('profileAvatar').style.backgroundImage = `url(${imageUrl})`;
                        document.getElementById('profileAvatar').textContent = '';

                        // Simulate saving (update currentUser object)
                        currentUser.avatar = imageUrl;
                        showToast('Avatar preview updated. Save changes to persist.');
                        // In a real app, you'd likely upload the file here and get back a URL
                    }
                    reader.readAsDataURL(file);
                } else if (file) {
                    showToast('Please select a valid image file.', 'error');
                }
            }

            function updateFullNameDisplay() {
                fullNameDisplay.value = `${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim();
            }

             function handleProfileSave(event) {
                 event.preventDefault();
                 console.log("Attempting to save profile...");

                 showConfirmModal(
                     'Save Profile Changes',
                     'Are you sure you want to save these changes to your profile?',
                     () => {
                         console.log("Profile save confirmed.");
                         const saveButtonText = saveProfileBtn.querySelector('.btn-text');
                         const spinner = saveProfileBtn.querySelector('.spinner');

                         saveProfileBtn.disabled = true;
                         if (saveButtonText) saveButtonText.style.display = 'none'; // Hide text
                         if (spinner) spinner.style.display = 'inline-block';

                         // Simulate network delay
                         setTimeout(() => {
                             // Update currentUser object with form values
                             currentUser.name = fullNameDisplay.value;
                             currentUser.title = jobTitleInput.value;
                             currentUser.phone = phoneInput.value;
                             currentUser.department = departmentInput.value;
                             // Email is readonly, Avatar updated separately

                             // Update initials if name changed and no avatar
                             if (!currentUser.avatar) {
                                 const nameParts = currentUser.name.split(' ');
                                 currentUser.initials = (nameParts[0]?.[0] || '') + (nameParts[1]?.[0] || '');
                             }

                              // Update phone number in 2FA section if changed
                              userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';

                             // Refresh UI elements that depend on currentUser
                             updateUserUI();

                             saveProfileBtn.disabled = false;
                             if (saveButtonText) saveButtonText.style.display = 'inline'; // Show text again
                             if (spinner) spinner.style.display = 'none';

                             // Show success message
                             showSuccessMessage('Profile updated successfully!');
                         }, 1000); // Simulate 1 second save time
                     },
                     'btn-primary' // Use primary style for save confirmation
                 );
             }

             function handleProfileCancel() {
                 showConfirmModal(
                     'Cancel Changes',
                     'Are you sure you want to discard your changes to the profile?',
                     () => {
                         // Revert form fields to original currentUser data
                         updateProfileForm();
                         // Revert avatar if it was changed but not saved (requires storing original state or re-fetching)
                          // For simplicity, we'll just revert the text fields here
                         showToast('Changes discarded.', 'info');
                     },
                     'btn-warning' // Use warning style for cancel confirmation
                 );
             }

             // --- Settings Save Logic (with Confirmation) ---
             function handleSavePreferences() {
                 showConfirmModal('Save Preferences', 'Save changes to Appearance and Localization?', () => {
                     console.log("Saving Preferences...");
                     // In a real app, collect values from toggles/selects and send to backend
                     // Example: localStorage is already updated by the individual controls' event listeners
                     showToast('Preferences saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleSaveAccountSettings() {
                 showConfirmModal('Save Account Settings', 'Save changes to account notifications?', () => {
                     console.log("Saving Account Settings...");
                     const enableNotifications = document.getElementById('accountNotificationsToggle').checked;
                     console.log("Account Notifications Enabled:", enableNotifications);
                     // Simulate saving
                     showToast('Account settings saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleChangePassword(event) {
                 event.preventDefault(); // Prevent default form submission
                  showConfirmModal('Change Password', 'Are you sure you want to attempt to change your password?', () => {
                     console.log("Changing password...");
                     const currentPass = document.getElementById('currentPassword').value;
                     const newPass = document.getElementById('newPassword').value;
                     const confirmPass = document.getElementById('confirmPassword').value;
                     const submitButton = changePasswordForm.querySelector('button[type="submit"]');
                     const originalButtonText = submitButton.innerHTML; // Store original button content


                     // Basic validation (add more robust checks in real app)
                     if (!currentPass || !newPass || !confirmPass) {
                         showToast('Please fill in all password fields.', 'error');
                         return;
                     }
                     if (newPass !== confirmPass) {
                         showToast('New passwords do not match.', 'error');
                         return;
                     }
                     if (newPass.length < 8) { // Example minimum length
                         showToast('New password must be at least 8 characters.', 'error');
                         return;
                     }

                     // Show loading state
                     submitButton.disabled = true;
                     submitButton.innerHTML = '<span class="spinner"></span> Changing...';

                     // Simulate backend call
                     setTimeout(() => {
                         // Simulate success/failure
                         const success = Math.random() > 0.2; // 80% success rate
                         if (success) {
                             showSuccessMessage('Password changed successfully!');
                             document.getElementById('currentPassword').value = '';
                             document.getElementById('newPassword').value = '';
                             document.getElementById('confirmPassword').value = '';
                         } else {
                             showToast('Password change failed. Incorrect current password?', 'error');
                         }
                          // Restore button state
                         submitButton.disabled = false;
                         submitButton.innerHTML = originalButtonText;
                     }, 1500);
                  }, 'btn-danger'); // Use danger style for password change confirmation
             }

             function handleSaveSessionSettings() {
                 showConfirmModal('Save Session Settings', 'Save changes to session duration and idle timeout?', () => {
                     console.log("Saving Session Settings...");
                     const sessionDuration = document.getElementById('sessionDuration').value;
                     const idleTimeout = document.getElementById('idleTimeout').value;
                     console.log("Session Duration:", sessionDuration, "Idle Timeout:", idleTimeout);
                     // Simulate saving
                     showToast('Session settings saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleSaveNotificationSettings() {
                  showConfirmModal('Save Notification Settings', 'Save changes to notification delivery and types?', () => {
                     console.log("Saving Notification Settings...");
                     const emailEnabled = document.getElementById('emailNotificationsToggle').checked;
                     const inAppEnabled = document.getElementById('inAppNotificationsToggle').checked;
                     const pushEnabled = document.getElementById('pushNotificationsToggle').checked; // Currently disabled
                     const selectedTypes = Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb => cb.value);

                     console.log("Email Notifications:", emailEnabled);
                     console.log("In-App Notifications:", inAppEnabled);
                     console.log("Selected Types:", selectedTypes);
                     // Simulate saving
                     showToast('Notification settings saved (simulated).', 'success');
                  }, 'btn-primary');
             }


             // --- 2FA Logic (Simulation) ---
             function update2FA_UI() {
                if (!currentUser || !twoFaStatusIndicator || !twoFaStatusText || !twoFaSetupSection || !twoFaManagementSection) return; // Add null checks

                const isEnabled = currentUser.twoFaEnabled;
                twoFaStatusIndicator.className = `status-indicator ${isEnabled ? 'enabled' : 'disabled'}`;
                twoFaStatusText.textContent = `2FA is currently ${isEnabled ? 'Enabled' : 'Disabled'}`;

                twoFaSetupSection.style.display = isEnabled ? 'none' : 'block';
                twoFaManagementSection.style.display = isEnabled ? 'block' : 'none';

                // Reset setup options visibility when UI updates
                 if (twoFaSetupOptions) twoFaSetupOptions.style.display = 'none';
                 if (authAppSetup) authAppSetup.style.display = 'none';
                 if (smsSetup) smsSetup.style.display = 'none';
             }

             function handleEnable2FA() {
                 if(twoFaSetupOptions) twoFaSetupOptions.style.display = 'block';
                 if(enable2faBtn) enable2faBtn.style.display = 'none'; // Hide enable button once options shown
             }
             function showAuthAppSetup() {
                 if(authAppSetup) authAppSetup.style.display = 'block';
                 if(smsSetup) smsSetup.style.display = 'none';
                 // In real app: generate QR code/secret here
             }
             function showSmsSetup() {
                 if(authAppSetup) authAppSetup.style.display = 'none';
                 if(smsSetup) smsSetup.style.display = 'block';
                 // Hide input group initially
                 if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none';
                 if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none';
                 // Clear previous input
                 const smsCodeInput = document.getElementById('smsCode');
                 if (smsCodeInput) smsCodeInput.value = '';
             }

             function handleVerifyAuthCode() {
                 // Simulate verification
                 const authCodeInput = document.getElementById('authCode');
                 if (!authCodeInput) return;
                 const code = authCodeInput.value;
                 if (code && code.length === 6 && /^\d+$/.test(code)) { // Basic check
                     showToast('Verifying code...', 'info');
                     setTimeout(() => {
                         currentUser.twoFaEnabled = true;
                         update2FA_UI();
                         showToast('2FA enabled successfully via Authenticator App!', 'success');
                         authCodeInput.value = ''; // Clear input
                     }, 1000);
                 } else {
                     showToast('Invalid code. Please enter a 6-digit code.', 'error');
                 }
             }
             function handleSendSmsCode() {
                 // Simulate sending code
                 showToast('Sending SMS code...', 'info');
                 setTimeout(() => {
                     showToast('SMS code sent (simulated).', 'success');
                     if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'block';
                     if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'inline-flex';
                 }, 1500);
             }
              function handleVerifySmsCode() {
                  // Simulate verification
                 const smsCodeInput = document.getElementById('smsCode');
                 if (!smsCodeInput) return;
                 const code = smsCodeInput.value;
                 if (code && code.length === 6 && /^\d+$/.test(code)) { // Basic check
                     showToast('Verifying SMS code...', 'info');
                     setTimeout(() => {
                         currentUser.twoFaEnabled = true;
                         update2FA_UI();
                         showToast('2FA enabled successfully via SMS!', 'success');
                         smsCodeInput.value = ''; // Clear input
                         if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none';
                         if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none';
                     }, 1000);
                 } else {
                     showToast('Invalid SMS code. Please enter a 6-digit code.', 'error');
                 }
             }

             function handleDisable2FA() {
                 showConfirmModal('Disable 2FA', 'Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.', () => {
                     currentUser.twoFaEnabled = false;
                     update2FA_UI();
                     if(enable2faBtn) enable2faBtn.style.display = 'inline-flex'; // Show enable button again
                     showToast('2FA disabled.', 'info');
                 }, 'btn-danger');
             }

             // --- Danger Zone Logic ---
             function handleLogoutAllDevices() {
                 showConfirmModal('Logout From All Devices', 'Are you sure you want to end all other active sessions?', () => {
                     // Simulate backend call
                     showToast('Logging out from other devices...', 'info');
                     setTimeout(() => {
                         showSuccessMessage('Successfully logged out from all other devices.');
                     }, 1500);
                 }, 'btn-warning');
             }

             function handleDeleteAccount() {
                 showConfirmModal('Delete Account', 'This action is IRREVERSIBLE. All your data, projects, and settings will be permanently deleted. Are you absolutely sure you want to proceed?', () => {
                     // Double confirmation (example - simplified trigger)
                     showConfirmModal('Final Confirmation', 'This is your absolute last chance. Are you sure?', () => {
                         console.warn("Account Deletion Confirmed (Simulated)");
                         showToast('Deleting account...', 'error');
                         // Simulate logout and redirection
                         setTimeout(() => {
                             alert("Account Deleted (Simulated). You would be redirected now.");
                             handleLogout(new Event('click')); // Trigger logout flow
                         }, 2000);
                     }, 'btn-danger');
                 }, 'btn-danger');
             }


             // --- Notification Logic ---
             function markAllNotificationsAsRead() {
                 if (notifications.some(n => n.unread)) {
                     notifications.forEach(n => n.unread = false);
                     renderNotifications();
                     showToast('All notifications marked as read.', 'info');
                 }
             }

             function playNotificationSound() {
                if (!playSounds) return; // Check preference

                try {
                    // Check if audio context needs user interaction first (common browser policy)
                    if (notificationSound && notificationSound.paused) { // Check if element exists
                        notificationSound.play().catch(e => console.warn("Audio play failed - requires user interaction or unsupported format:", e));
                    }
                 } catch(e) {
                     console.warn("Audio playback error:", e);
                 }
             }

             // --- Activity Logic ---
             // (Handled in loadRecentActivities and event listeners)

             // --- Logout Logic ---
             function handleLogout(event) {
                if (event) event.preventDefault(); // Prevent default if called from link
                 showConfirmModal(
                     'Confirm Logout',
                     'Are you sure you want to log out?',
                     () => {
                         console.log("Logging out...");
                         // Clear intervals
                         clearInterval(activityIntervalId);
                         clearInterval(notificationIntervalId);
                         clearInterval(statsIntervalId);
                         clearInterval(welcomeBgIntervalId);
                         clearInterval(taskCheckIntervalId); // Stop task checking

                         // Show success message
                         showSuccessMessage('Logout successful! Redirecting...');

                         // Simulate redirection after a short delay
                         setTimeout(() => {
                             // Redirect to login page (assuming it exists)
                             window.location.href = 'login.html'; // Or appropriate logout URL
                         }, 1500);
                     },
                     'btn-danger'
                 );
             }

            // --- Team Management Logic ---
             function handleInviteMember(event) {
                 event.preventDefault();
                 const emailInput = document.getElementById('inviteEmail');
                 const roleInput = document.getElementById('inviteRole');
                 const email = emailInput ? emailInput.value : null;
                 const role = roleInput ? roleInput.value : null;
                 const inviteButton = event.target.querySelector('button[type="submit"]');
                 const originalButtonHTML = inviteButton ? inviteButton.innerHTML : 'Invite';

                 if (!email || !role) {
                     showToast('Please provide both email and role.', 'error');
                     return;
                 }
                 // Basic email format check
                 if (!/\S+@\S+\.\S+/.test(email)) {
                     showToast('Please enter a valid email address.', 'error');
                     return;
                 }
                 // Check if email already exists
                 if (MOCK_USERS.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                     showToast('A user with this email already exists.', 'error');
                     return;
                 }


                 console.log(`Inviting ${email} as ${role}`);
                 if (inviteButton) {
                     inviteButton.disabled = true;
                     inviteButton.innerHTML = '<span class="spinner"></span> Sending...'; // Add spinner
                 }

                 // Simulate API call
                 setTimeout(() => {
                    // Add a new mock user (simplified)
                    const newId = MOCK_USERS.length > 0 ? Math.max(...MOCK_USERS.map(u => u.id)) + 1 : 1; // Handle empty array
                    const nameParts = email.split('@')[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1));
                    const newUser = {
                        id: newId,
                        name: nameParts.join(' ') || 'New User',
                        email: email,
                        title: formatRole(role),
                        department: 'Pending',
                        phone: '',
                        avatar: '',
                        initials: (nameParts[0]?.[0] || 'N') + (nameParts[1]?.[0] || 'U'),
                        role: role,
                        twoFaEnabled: false // Default for new users
                    };
                    MOCK_USERS.push(newUser);
                    loadTeamMembers(); // Refresh list
                    loadDashboardStats(); // Update stats

                    showToast(`Invitation sent to ${email}.`, 'success');
                    if (inviteButton) {
                        inviteButton.disabled = false;
                        inviteButton.innerHTML = originalButtonHTML; // Reset button text
                    }
                    if (emailInput) emailInput.value = ''; // Clear form
                    if (roleInput) roleInput.value = 'member';
                 }, 1000);
             }

            function openEditMemberModal(memberId) {
                 const member = MOCK_USERS.find(u => u.id === memberId);
                 if (!member || !editMemberModal) return;

                 // Populate the modal form
                 document.getElementById('editMemberId').value = member.id;
                 const nameParts = member.name.split(' ');
                 document.getElementById('editMemberFirstName').value = nameParts[0] || '';
                 document.getElementById('editMemberLastName').value = nameParts.slice(1).join(' ') || '';
                 document.getElementById('editMemberEmail').value = member.email;
                 document.getElementById('editMemberRole').value = member.role;
                 document.getElementById('editMemberTitle').value = member.title || '';
                 document.getElementById('editMemberDepartment').value = member.department || '';
                 document.getElementById('editMemberModalTitle').textContent = `Edit ${member.name}`;


                 editMemberModal.classList.add('active');
             }

             function handleEditMemberSave(event) {
                event.preventDefault();
                const memberId = parseInt(document.getElementById('editMemberId').value);
                const firstName = document.getElementById('editMemberFirstName').value;
                const lastName = document.getElementById('editMemberLastName').value;
                const role = document.getElementById('editMemberRole').value;
                const title = document.getElementById('editMemberTitle').value;
                const department = document.getElementById('editMemberDepartment').value;
                const submitButton = editMemberForm.querySelector('button[type="submit"]');
                const originalButtonHTML = submitButton.innerHTML;

                console.log(`Saving changes for member ID: ${memberId}`);
                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner"></span> Saving...';

                setTimeout(() => {
                    const memberIndex = MOCK_USERS.findIndex(u => u.id === memberId);
                    if (memberIndex > -1) {
                        const oldName = MOCK_USERS[memberIndex].name;
                        const newName = `${firstName} ${lastName}`.trim();

                        MOCK_USERS[memberIndex] = {
                            ...MOCK_USERS[memberIndex], // Keep existing properties like email, avatar, id
                            name: newName,
                            role: role,
                            title: title,
                            department: department,
                             // Update initials if name changed and no avatar
                            initials: !MOCK_USERS[memberIndex].avatar
                                        ? (firstName?.[0] || '') + (lastName?.[0] || '')
                                        : MOCK_USERS[memberIndex].initials
                        };

                        // Update assignee name in tasks if it changed
                        if (oldName !== newName) {
                            mockTasks = mockTasks.map(task => {
                                if (task.assigneeId === memberId) {
                                    // No need to change assigneeId, just for display purposes later
                                }
                                return task;
                            });
                            // Refresh task view if visible
                            if (currentFeature === 'task-management') {
                                applyTaskFiltersAndSort();
                            }
                        }

                        loadTeamMembers(); // Refresh the list
                        updateUserUI(); // Update own UI if editing self (though usually disabled)
                        showToast('Member details updated successfully!', 'success');
                    } else {
                         showToast('Error: Member not found.', 'error');
                    }
                     // Restore button and close modal
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                    editMemberModal.classList.remove('active');
                 }, 1000);
             }


             // --- Employee Scheduling ---
             function getEmployeeScheduleHTML() {
                 // (Existing function remains the same)
                 return `
                    <div class="schedule-page-header section-main-header">
                        <h2 class="schedule-page-title section-main-title">Employee Scheduling</h2>
                         ${currentUser.role === 'admin' ? `
                         <button class="btn btn-primary" id="saveScheduleBtn">
                             <i class="fas fa-save"></i> Save Schedule
                         </button>` : ''}
                    </div>
                    <div class="schedule-controls">
                        <button class="btn btn-outline" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev</button>
                        <span id="weekDisplay" style="margin: 0 1rem; font-weight: 500;">Loading...</span>
                        <button class="btn btn-outline" id="nextWeekBtn">Next <i class="fas fa-chevron-right"></i></button>
                        ${currentUser.role === 'admin' ? `
                        <button class="btn btn-success" id="sendRemindersBtn" style="margin-left: auto;">
                             <i class="fas fa-envelope"></i> Send Reminders
                         </button>` : ''}
                    </div>
                    <div class="schedule-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <!-- Day headers populated by JS (Sun-Sat) -->
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <!-- Schedule content loaded by JS -->
                                <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Shift Edit Modal (Uses Generic Modal Styles) -->
                    <div class="modal" id="editShiftModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title" id="editShiftModalTitle">Edit Shift</h3>
                                <button class="close-modal" data-close-modal>×</button>
                            </div>
                            <form id="editShiftForm">
                                <input type="hidden" id="editShiftEmployeeId">
                                <input type="hidden" id="editShiftDayIndex">
                                <input type="hidden" id="editShiftWeekOffset">
                                <div class="form-group">
                                    <label for="shiftType">Shift Type</label>
                                    <select id="shiftType" class="form-control">
                                        <option value="morning">Morning (9AM-5PM)</option>
                                        <option value="afternoon">Afternoon (12PM-8PM)</option>
                                        <option value="night">Night (8PM-4AM)</option>
                                        <option value="off">Day Off</option>
                                        <option value="sick">Sick Leave</option>
                                        <option value="vacation">Vacation</option>
                                    </select>
                                </div>
                                <div class="form-actions" style="grid-column: span 1;">
                                     <button type="button" class="btn btn-outline" data-close-modal>Cancel</button>
                                     <button type="submit" class="btn btn-primary">Save Shift</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
             }

            function initializeEmployeeScheduleLogic() {
                // (Existing function remains the same - simplified for brevity)
                console.log("Initializing Employee Schedule Logic...");

                const calculateOffsets = () => {
                    const today = new Date();
                    const mayFirst2025 = new Date(2025, 4, 1); // May 1st
                    mayFirst2025.setHours(0, 0, 0, 0);
                    const currentDayOfWeek = today.getDay();
                    const diffToSunday = today.getDate() - currentDayOfWeek;
                    const startOfCurrentWeek = new Date(today);
                    startOfCurrentWeek.setDate(diffToSunday);
                    startOfCurrentWeek.setHours(0, 0, 0, 0);
                    const mayFirstDayOfWeek = mayFirst2025.getDay();
                    const diffToMayFirstSunday = mayFirst2025.getDate() - mayFirstDayOfWeek;
                    const startOfMayFirstWeek = new Date(mayFirst2025);
                    startOfMayFirstWeek.setDate(diffToMayFirstSunday);
                    startOfMayFirstWeek.setHours(0, 0, 0, 0);
                    const msPerDay = 24 * 60 * 60 * 1000;
                    const weeksDifference = Math.round((startOfMayFirstWeek.getTime() - startOfCurrentWeek.getTime()) / (7 * msPerDay));
                    currentScheduleWeekOffset = weeksDifference;
                    scheduleMinWeekOffset = weeksDifference;
                };
                calculateOffsets();

                const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const weekDisplay = document.getElementById('weekDisplay');
                const scheduleTableBody = document.getElementById('scheduleTableBody');
                const scheduleThead = document.querySelector('.schedule-table thead tr');
                const prevWeekBtn = document.getElementById('prevWeekBtn');
                const nextWeekBtn = document.getElementById('nextWeekBtn');
                const saveScheduleBtn = document.getElementById('saveScheduleBtn');
                const sendRemindersBtn = document.getElementById('sendRemindersBtn');
                const editShiftModal = document.getElementById('editShiftModal');
                const editShiftForm = document.getElementById('editShiftForm');
                const shiftTypeSelect = document.getElementById('shiftType');
                const editShiftEmployeeIdInput = document.getElementById('editShiftEmployeeId');
                const editShiftDayIndexInput = document.getElementById('editShiftDayIndex');
                const editShiftWeekOffsetInput = document.getElementById('editShiftWeekOffset');
                const editShiftModalTitle = document.getElementById('editShiftModalTitle');

                function getWeekDates(weekOffset = 0) {
                    const baseDate = new Date();
                    const startOfWeek = new Date(baseDate);
                    const dayOfWeek = baseDate.getDay();
                    const diff = baseDate.getDate() - dayOfWeek;
                    startOfWeek.setDate(diff + (weekOffset * 7));
                    startOfWeek.setHours(0,0,0,0);
                    const dates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        dates.push(date);
                    }
                    return dates;
                }

                window.renderSchedule = function(weekOffset) { // Make global for access
                     console.log(`Rendering schedule for week offset: ${weekOffset}`);
                     if (isNaN(weekOffset)) { weekOffset = currentScheduleWeekOffset; }
                     const weekDates = getWeekDates(weekOffset);
                     const start = weekDates[0]; const end = weekDates[6];
                     if(weekDisplay) weekDisplay.textContent = `${formatDateForDisplay(start)} - ${formatDateForDisplay(end)}`;
                     if (prevWeekBtn) { prevWeekBtn.disabled = weekOffset <= scheduleMinWeekOffset; }

                     if(scheduleThead) {
                         scheduleThead.innerHTML = '<th>Employee</th>';
                         weekDates.forEach((date, index) => {
                             scheduleThead.innerHTML += `
                                 <th>
                                    <div class="day-header">
                                        <span class="day-name">${days[index]}</span>
                                        <span class="day-date">${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric'})}</span>
                                    </div>
                                 </th>`;
                         });
                     }

                     if(scheduleTableBody) {
                         scheduleTableBody.innerHTML = '';
                         if (MOCK_USERS.length === 0) {
                             scheduleTableBody.innerHTML = `<tr><td colspan="8">No employees found.</td></tr>`; return;
                         }
                         MOCK_USERS.forEach(employee => {
                             const row = document.createElement('tr');
                             row.innerHTML = `<td class="employee-name">${employee.name}</td>`;
                             for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                                 const cell = document.createElement('td');
                                 const scheduleKey = `${employee.id}-${weekOffset}-${dayIndex}`;
                                 const isWeekend = dayIndex >= 5;
                                 let shiftType;
                                 let isEditable = currentUser.role === 'admin' && !isWeekend;

                                 if (isWeekend) {
                                     shiftType = 'off'; mockScheduleData[scheduleKey] = 'off'; cell.classList.add('weekend-cell');
                                 } else {
                                     if (!mockScheduleData[scheduleKey]) {
                                         const shiftTypes = ['morning', 'afternoon', 'night', 'off', 'sick', 'vacation'];
                                         mockScheduleData[scheduleKey] = shiftTypes[Math.floor(Math.random() * shiftTypes.length)];
                                     }
                                     shiftType = mockScheduleData[scheduleKey];
                                 }
                                 const shiftDiv = document.createElement('div');
                                 shiftDiv.classList.add('shift');
                                 if (isWeekend) { shiftDiv.classList.add('shift-weekend-off'); }
                                 else { shiftDiv.classList.add(`shift-${shiftType.replace('_', '-')}`); }
                                 shiftDiv.textContent = getShiftText(shiftType);
                                 if (isEditable) {
                                     shiftDiv.classList.add('editable');
                                     shiftDiv.dataset.employeeId = employee.id; shiftDiv.dataset.employeeName = employee.name;
                                     shiftDiv.dataset.dayIndex = dayIndex; shiftDiv.dataset.weekOffset = weekOffset;
                                     shiftDiv.dataset.date = formatDateForDisplay(weekDates[dayIndex]);
                                     shiftDiv.title = `Click to edit ${employee.name}'s shift on ${days[dayIndex]}`;
                                     shiftDiv.addEventListener('click', handleEditShiftClick);
                                 } else if (isWeekend) { shiftDiv.title = "Weekend Off"; }
                                 cell.appendChild(shiftDiv); row.appendChild(cell);
                             }
                             scheduleTableBody.appendChild(row);
                         });
                    }
                 }

                function getShiftText(type) { /* ... (existing code) ... */
                    switch (type) {
                        case 'morning': return '9AM-5PM'; case 'afternoon': return '12PM-8PM'; case 'night': return '8PM-4AM';
                        case 'off': return 'OFF'; case 'sick': return 'Sick'; case 'vacation': return 'Vacation'; default: return 'N/A';
                    }
                }

                function handleEditShiftClick(event) { /* ... (existing code) ... */
                    const target = event.target;
                    if (!target.classList.contains('editable')) return;
                    const employeeId = target.dataset.employeeId; const dayIndex = target.dataset.dayIndex; const weekOffset = target.dataset.weekOffset;
                    const employeeName = target.dataset.employeeName; const dateStr = target.dataset.date;
                    const scheduleKey = `${employeeId}-${weekOffset}-${dayIndex}`; const currentShift = mockScheduleData[scheduleKey] || 'morning';
                    if (editShiftEmployeeIdInput) editShiftEmployeeIdInput.value = employeeId; if (editShiftDayIndexInput) editShiftDayIndexInput.value = dayIndex;
                    if (editShiftWeekOffsetInput) editShiftWeekOffsetInput.value = weekOffset; if (shiftTypeSelect) shiftTypeSelect.value = currentShift;
                    if (editShiftModalTitle) editShiftModalTitle.textContent = `Edit ${employeeName}'s Shift on ${days[dayIndex] || dateStr}`;
                    if (editShiftModal) editShiftModal.classList.add('active');
                }

                 if (prevWeekBtn) { prevWeekBtn.addEventListener('click', () => { if (currentScheduleWeekOffset > scheduleMinWeekOffset) { currentScheduleWeekOffset--; renderSchedule(currentScheduleWeekOffset); } }); }
                 if (nextWeekBtn) { nextWeekBtn.addEventListener('click', () => { currentScheduleWeekOffset++; renderSchedule(currentScheduleWeekOffset); }); }
                 if (saveScheduleBtn) { saveScheduleBtn.addEventListener('click', () => { /* ... (existing confirm code) ... */ }); }
                 if (sendRemindersBtn) { sendRemindersBtn.addEventListener('click', handleSendReminders); }
                 if (editShiftModal) { /* ... (existing modal close code) ... */ }
                 if (editShiftForm) { editShiftForm.addEventListener('submit', (event) => { /* ... (existing form submit code) ... */ }); }

                 renderSchedule(currentScheduleWeekOffset); // Initial render
            }


             // --- Send Reminders Logic (Simulation) ---
             function handleSendReminders() { // (Existing function remains the same)
                const btn = document.getElementById('sendRemindersBtn'); if (!btn) return;
                 btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Sending...';
                 console.log("Preparing to send schedule reminders...");
                 const weekDates = getWeekDates(currentScheduleWeekOffset); const weekStart = formatDateForDisplay(weekDates[0]); const weekEnd = formatDateForDisplay(weekDates[6]);
                 const emailSubject = `Schedule Reminder for Week: ${weekStart} - ${weekEnd}`; const emailFooter = "\n\nRegards,\nTeam Management System"; const fullDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                 let emailsSent = 0; let emailsFailed = 0;
                 MOCK_USERS.forEach((user, index) => {
                     let userScheduleInfo = `Your schedule for the week starting ${weekStart}:\n`;
                     for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                         const scheduleKey = `${user.id}-${currentScheduleWeekOffset}-${dayIndex}`;
                         const shiftType = mockScheduleData[scheduleKey] || 'off';
                         userScheduleInfo += `- ${fullDays[dayIndex]} (${formatDateForDisplay(weekDates[dayIndex])}): ${getShiftText(shiftType)}\n`;
                     }
                     const emailBody = `Hi ${user.name.split(' ')[0]},\n\nPlease find your work schedule details below. Remember to check the system for any updates.\n\n${userScheduleInfo}\nPlease ensure you log your times accurately.${emailFooter}`;
                     console.log(`--- Sending to: ${user.email} ---`); console.log(`Subject: ${emailSubject}`); console.log(`Body:\n${emailBody}`); console.log(`---------------------------------`);
                     const success = Math.random() > 0.1; if (success) { emailsSent++; } else { emailsFailed++; }
                 });
                 setTimeout(() => {
                     if (emailsFailed > 0) { showToast(`Sent ${emailsSent} reminders. Failed to send ${emailsFailed}.`, "error"); }
                     else { showToast(`Successfully sent ${emailsSent} schedule reminders!`, "success"); }
                     btn.disabled = false; btn.innerHTML = '<i class="fas fa-envelope"></i> Send Reminders';
                 }, 1500 + MOCK_USERS.length * 50);
             }

            // --- Task Management ---
            function getTaskManagementHTML() {
                 return `
                    <div class="task-page-header section-main-header">
                        <h2 class="task-page-title section-main-title">Task Management</h2>
                        <button class="btn btn-primary" id="addTaskBtn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>
                    <div class="task-controls">
                        <div class="form-group">
                            <label for="taskStatusFilter">Status</label>
                            <select id="taskStatusFilter" class="form-control">
                                <option value="">All</option>
                                <option value="todo">To Do</option>
                                <option value="inprogress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskPriorityFilter">Priority</label>
                            <select id="taskPriorityFilter" class="form-control">
                                <option value="">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="taskAssigneeFilter">Assignee</label>
                            <select id="taskAssigneeFilter" class="form-control">
                                <option value="">All</option>
                                <option value="unassigned">Unassigned</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskDueDateFilter">Due Date</label>
                            <input type="date" id="taskDueDateFilter" class="form-control">
                        </div>
                         <button class="btn btn-outline btn-sm" id="clearTaskFiltersBtn" title="Clear Filters">
                             <i class="fas fa-times"></i> Clear
                         </button>
                    </div>
                    <div class="task-table-container">
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th data-sort="title">Task Title <i class="fas fa-sort"></i></th>
                                    <th data-sort="assigneeId">Assignee <i class="fas fa-sort"></i></th>
                                    <th data-sort="dueDate">Due Date <i class="fas fa-sort-down"></i></th> <!-- Default sort -->
                                    <th data-sort="priority">Priority <i class="fas fa-sort"></i></th>
                                    <th data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- Task rows loaded by JS -->
                                <tr><td colspan="6" class="no-tasks-message">Loading tasks...</td></tr>
                            </tbody>
                        </table>
                    </div>
                 `;
            }

             function initializeTaskManagementLogic() {
                console.log("Initializing Task Management Logic...");
                const taskTableBody = document.getElementById('taskTableBody');
                const addTaskBtn = document.getElementById('addTaskBtn');
                const statusFilter = document.getElementById('taskStatusFilter');
                const priorityFilter = document.getElementById('taskPriorityFilter');
                const assigneeFilter = document.getElementById('taskAssigneeFilter');
                const dueDateFilter = document.getElementById('taskDueDateFilter');
                const clearFiltersBtn = document.getElementById('clearTaskFiltersBtn');
                const tableHeaders = document.querySelectorAll('#featureSectionsContainer.task-management .task-table thead th[data-sort]');

                // Populate assignee filter dropdown
                populateAssigneeFilter();

                // Event Listeners for Task Management
                if (addTaskBtn) addTaskBtn.addEventListener('click', () => openTaskModal());
                if (statusFilter) statusFilter.addEventListener('change', handleTaskFilterChange);
                if (priorityFilter) priorityFilter.addEventListener('change', handleTaskFilterChange);
                if (assigneeFilter) assigneeFilter.addEventListener('change', handleTaskFilterChange);
                if (dueDateFilter) dueDateFilter.addEventListener('change', handleTaskFilterChange);
                if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', () => {
                     statusFilter.value = ''; priorityFilter.value = ''; assigneeFilter.value = ''; dueDateFilter.value = '';
                     handleTaskFilterChange(); // Apply cleared filters
                 });
                tableHeaders.forEach(th => th.addEventListener('click', handleTaskSort));

                // Event Delegation for table body actions (edit, delete, toggle subtasks, status change)
                if (taskTableBody) {
                    taskTableBody.addEventListener('click', handleTaskAction);
                }

                applyTaskFiltersAndSort(); // Initial render
                checkTaskDueDates(); // Check statuses on load
            }

            function populateAssigneeFilter() {
                const assigneeFilter = document.getElementById('taskAssigneeFilter');
                if (!assigneeFilter) return;
                // Clear existing options except 'All' and 'Unassigned'
                while (assigneeFilter.options.length > 2) {
                    assigneeFilter.remove(2);
                }
                 // Add current users
                 MOCK_USERS.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    assigneeFilter.appendChild(option);
                 });
            }

             function handleTaskFilterChange() {
                 taskFilters.status = document.getElementById('taskStatusFilter').value;
                 taskFilters.priority = document.getElementById('taskPriorityFilter').value;
                 taskFilters.assigneeId = document.getElementById('taskAssigneeFilter').value;
                 taskFilters.dueDate = document.getElementById('taskDueDateFilter').value;
                 applyTaskFiltersAndSort();
             }

             function handleTaskSort(event) {
                 const targetHeader = event.currentTarget;
                 const column = targetHeader.dataset.sort;

                 // Determine new sort direction
                 let direction = 'asc';
                 if (taskSort.column === column && taskSort.direction === 'asc') {
                     direction = 'desc';
                 }

                 // Update state
                 taskSort.column = column;
                 taskSort.direction = direction;

                 // Update header classes/icons
                 document.querySelectorAll('#featureSectionsContainer.task-management .task-table thead th[data-sort]').forEach(th => {
                     th.classList.remove('sort-asc', 'sort-desc');
                     th.querySelector('i').className = 'fas fa-sort'; // Reset icon
                 });
                 targetHeader.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                 targetHeader.querySelector('i').className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';

                 applyTaskFiltersAndSort();
             }

            function applyTaskFiltersAndSort() {
                let filteredTasks = [...mockTasks]; // Start with a copy

                // Apply Filters
                if (taskFilters.status) {
                    filteredTasks = filteredTasks.filter(task => task.status === taskFilters.status);
                }
                if (taskFilters.priority) {
                    filteredTasks = filteredTasks.filter(task => task.priority === taskFilters.priority);
                }
                if (taskFilters.assigneeId) {
                    if (taskFilters.assigneeId === 'unassigned') {
                        filteredTasks = filteredTasks.filter(task => !task.assigneeId);
                    } else {
                        filteredTasks = filteredTasks.filter(task => task.assigneeId == taskFilters.assigneeId); // Use == for string/number comparison
                    }
                }
                 if (taskFilters.dueDate) {
                     filteredTasks = filteredTasks.filter(task => {
                         if (!task.dueDate) return false; // Exclude tasks without due date
                         // Compare dates directly as strings (YYYY-MM-DD)
                         return task.dueDate === taskFilters.dueDate;
                     });
                 }

                // Apply Sorting
                filteredTasks.sort((a, b) => {
                    let valA = a[taskSort.column];
                    let valB = b[taskSort.column];

                     // Handle null/undefined for sorting (e.g., due date)
                    if (valA === null || valA === undefined) valA = taskSort.direction === 'asc' ? Infinity : -Infinity; // Push nulls to end/start
                    if (valB === null || valB === undefined) valB = taskSort.direction === 'asc' ? Infinity : -Infinity;

                    // Case-insensitive string sort
                    if (typeof valA === 'string' && typeof valB === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    let comparison = 0;
                    if (valA < valB) {
                        comparison = -1;
                    } else if (valA > valB) {
                        comparison = 1;
                    }

                    return taskSort.direction === 'asc' ? comparison : comparison * -1;
                });

                renderTaskTable(filteredTasks);
            }

            function renderTaskTable(tasksToRender) {
                 const taskTableBody = document.getElementById('taskTableBody');
                 if (!taskTableBody) return;
                 taskTableBody.innerHTML = ''; // Clear existing rows

                 if (tasksToRender.length === 0) {
                     taskTableBody.innerHTML = `<tr><td colspan="6" class="no-tasks-message">No tasks match the current filters.</td></tr>`;
                     return;
                 }

                 tasksToRender.forEach(task => {
                     // Render Parent Task Row
                     taskTableBody.appendChild(createTaskRow(task));

                     // Render Subtasks if expanded
                     if (task.isExpanded && task.subtasks.length > 0) {
                         task.subtasks.forEach(subtask => {
                             taskTableBody.appendChild(createTaskRow(subtask, true)); // Pass isSubtask = true
                         });
                     }
                 });
                 checkTaskDueDates(); // Update visual indicators after rendering
            }

            function createTaskRow(taskData, isSubtask = false) {
                const row = document.createElement('tr');
                row.classList.add('task-row');
                row.dataset.taskId = taskData.id;
                if (isSubtask) {
                    row.classList.add('subtask-row');
                    row.dataset.parentId = taskData.parentId; // Store parent ID
                }

                const assignee = MOCK_USERS.find(u => u.id === taskData.assigneeId);
                const assigneeName = assignee ? assignee.name : 'Unassigned';
                const assigneeInitials = assignee ? assignee.initials : '?';
                const assigneeAvatar = assignee ? assignee.avatar : '';

                const dueDate = taskData.dueDate ? parseInputDate(taskData.dueDate) : null;
                const formattedDueDate = dueDate ? formatDateForDisplay(dueDate) : 'No date';

                // Determine if task is overdue or due soon
                const today = new Date(); today.setHours(0,0,0,0);
                let dueDateClass = '';
                if (dueDate && taskData.status !== 'completed') {
                    if (dueDate < today) {
                         row.classList.add('task-overdue'); // Add class to row for background tinting
                         dueDateClass = 'task-overdue'; // Add class specifically to date cell text
                    } else {
                        const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                         if (dueDate.getTime() === today.getTime() || dueDate.getTime() === tomorrow.getTime()) {
                             dueDateClass = 'task-due-soon';
                         }
                    }
                }

                // Subtask toggle logic
                const hasSubtasks = !isSubtask && taskData.subtasks && taskData.subtasks.length > 0;
                const toggleIconClass = hasSubtasks ? (taskData.isExpanded ? 'fa-chevron-down' : 'fa-chevron-right') : 'fa-minus';
                const toggleClass = hasSubtasks ? 'subtask-toggle' + (taskData.isExpanded ? ' expanded' : '') : 'subtask-toggle disabled';
                 const subtaskCountText = hasSubtasks ? `(${taskData.subtasks.filter(st => st.status === 'completed').length}/${taskData.subtasks.length})` : '';

                row.innerHTML = `
                    <td class="task-title-cell">
                        <span class="${toggleClass}" title="${hasSubtasks ? (taskData.isExpanded ? 'Collapse' : 'Expand') + ' Subtasks' : ''}">
                            <i class="fas ${toggleIconClass}"></i>
                        </span>
                        <span class="task-title">${taskData.title || 'No Title'}</span>
                        ${hasSubtasks ? `<span class="subtask-count">${subtaskCountText}</span>` : ''}
                    </td>
                    <td>
                        ${assignee ? `<div class="assignee-avatar" style="${assigneeAvatar ? `background-image: url('${assigneeAvatar}')` : ''}" title="${assigneeName}">${assigneeAvatar ? '' : assigneeInitials}</div>` : '<div class="assignee-avatar" title="Unassigned">?</div>'}
                        <span class="assignee-name">${assigneeName}</span>
                    </td>
                    <td class="task-due-date ${dueDateClass}">${formattedDueDate}</td>
                    <td><span class="priority-badge priority-${taskData.priority}">${formatPriority(taskData.priority)}</span></td>
                    <td><span class="status-badge status-${taskData.status.replace(' ', '')}" data-task-id="${taskData.id}" data-subtask="${isSubtask}" title="Click to change status">${formatStatus(taskData.status)}</span></td>
                    <td class="task-actions">
                         ${!isSubtask ? `
                         <button class="btn btn-outline btn-sm edit-task" title="Edit Task"><i class="fas fa-pencil-alt"></i></button>
                         <button class="btn btn-danger btn-sm delete-task" title="Delete Task"><i class="fas fa-trash-alt"></i></button>
                         ` : `
                          <button class="btn btn-outline btn-sm edit-task" title="Edit Subtask"><i class="fas fa-pencil-alt"></i></button>
                         <button class="btn btn-danger btn-sm delete-task" title="Delete Subtask"><i class="fas fa-trash-alt"></i></button>
                         `}
                    </td>
                `;
                return row;
            }


            function formatPriority(priority) {
                switch (priority) {
                    case 'high': return 'High';
                    case 'medium': return 'Medium';
                    case 'low': return 'Low';
                    default: return 'Medium';
                }
            }
            function formatStatus(status) {
                switch (status) {
                    case 'todo': return 'To Do';
                    case 'inprogress': return 'In Progress';
                    case 'completed': return 'Completed';
                    case 'blocked': return 'Blocked';
                    default: return 'To Do';
                }
            }

            function openTaskModal(taskId = null) {
                taskForm.reset(); // Clear the form
                const modalTitle = document.getElementById('taskModalTitle');
                const taskIdInput = document.getElementById('editTaskId');
                const assigneeSelect = document.getElementById('taskAssignee');
                const submitButton = taskForm.querySelector('button[type="submit"]');

                // Populate Assignee Dropdown
                assigneeSelect.innerHTML = '<option value="">Unassigned</option>'; // Clear previous
                 MOCK_USERS.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    assigneeSelect.appendChild(option);
                 });

                if (taskId) {
                    // Editing existing task or subtask
                    let task = mockTasks.find(t => t.id === taskId);
                    let isSubtask = false;
                    if (!task) { // Check if it's a subtask
                        mockTasks.forEach(parent => {
                            const sub = parent.subtasks.find(st => st.id === taskId);
                            if (sub) {
                                task = sub;
                                isSubtask = true;
                            }
                        });
                    }

                    if (task) {
                        modalTitle.textContent = isSubtask ? "Edit Subtask" : "Edit Task";
                        taskIdInput.value = task.id;
                        document.getElementById('taskTitle').value = task.title;
                        document.getElementById('taskDescription').value = task.description || '';
                        // If subtask, assignee might be inherited or null, handle accordingly
                        document.getElementById('taskAssignee').value = isSubtask ? (mockTasks.find(t => t.id === task.parentId)?.assigneeId || '') : (task.assigneeId || '');
                        document.getElementById('taskDueDate').value = task.dueDate || '';
                        document.getElementById('taskPriority').value = task.priority || 'medium';
                        document.getElementById('taskStatus').value = task.status || 'todo';
                        submitButton.textContent = "Save Changes";
                    } else {
                        showToast("Error: Task not found.", "error");
                        return; // Don't open modal if task not found
                    }
                } else {
                    // Adding new task
                    modalTitle.textContent = "Add New Task";
                    taskIdInput.value = ''; // Clear ID
                    submitButton.textContent = "Save Task";
                }
                taskModal.classList.add('active');
            }

            function handleTaskFormSubmit(event) {
                event.preventDefault();
                const taskId = parseInt(document.getElementById('editTaskId').value); // NaN if empty
                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const assigneeId = parseInt(document.getElementById('taskAssignee').value) || null; // null if empty/NaN
                const dueDate = document.getElementById('taskDueDate').value || null; // null if empty
                const priority = document.getElementById('taskPriority').value;
                const status = document.getElementById('taskStatus').value;
                const submitButton = taskForm.querySelector('button[type="submit"]');
                const originalButtonHTML = submitButton.innerHTML;

                if (!title) {
                    showToast("Task title is required.", "error");
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner"></span> Saving...';

                // Simulate saving
                setTimeout(() => {
                    if (taskId) {
                        // Editing existing task or subtask
                        let taskFound = false;
                        // Find and update parent task
                        mockTasks = mockTasks.map(task => {
                            if (task.id === taskId) {
                                taskFound = true;
                                return { ...task, title, description, assigneeId, dueDate, priority, status };
                            }
                            // Find and update subtask
                            task.subtasks = task.subtasks.map(subtask => {
                                if (subtask.id === taskId) {
                                    taskFound = true;
                                    return { ...subtask, title, description, status }; // Subtasks simpler update for now
                                }
                                return subtask;
                            });
                            return task;
                        });

                        if (taskFound) {
                            showToast("Task updated successfully!", "success");
                            // Check parent task status if a subtask was modified
                            mockTasks.forEach(task => checkTaskStatus(task.id));
                        } else {
                            showToast("Error updating task: Not found.", "error");
                        }

                    } else {
                        // Adding new task
                        const newId = Date.now(); // Simple unique ID
                        const newTask = {
                            id: newId, title, description, assigneeId, dueDate, priority, status,
                            subtasks: [], isExpanded: false
                        };
                        mockTasks.push(newTask);
                        showToast("Task added successfully!", "success");
                    }

                    applyTaskFiltersAndSort(); // Refresh table
                    taskModal.classList.remove('active'); // Close modal
                    submitButton.disabled = false; // Restore button
                    submitButton.innerHTML = originalButtonHTML;
                }, 500); // Simulate delay
            }

             function handleTaskAction(event) {
                 const target = event.target;
                 const taskRow = target.closest('.task-row');
                 if (!taskRow) return;

                 const taskId = parseInt(taskRow.dataset.taskId);
                 const isSubtask = taskRow.classList.contains('subtask-row');

                 // Edit Button
                 if (target.closest('.edit-task')) {
                     openTaskModal(taskId);
                 }
                 // Delete Button
                 else if (target.closest('.delete-task')) {
                    const taskTitle = taskRow.querySelector('.task-title')?.textContent || 'this task';
                     showConfirmModal(`Delete ${isSubtask ? 'Subtask' : 'Task'}`, `Are you sure you want to delete "${taskTitle}"? ${!isSubtask && mockTasks.find(t=>t.id === taskId)?.subtasks.length > 0 ? 'This will also delete its subtasks.' : ''}`, () => {
                         if (isSubtask) {
                             // Find parent and remove subtask
                             const parentId = parseInt(taskRow.dataset.parentId);
                             const parentTask = mockTasks.find(t => t.id === parentId);
                             if (parentTask) {
                                parentTask.subtasks = parentTask.subtasks.filter(st => st.id !== taskId);
                                checkTaskStatus(parentId); // Update parent status
                             }
                         } else {
                             // Remove parent task
                             mockTasks = mockTasks.filter(t => t.id !== taskId);
                         }
                         showToast(`${isSubtask ? 'Subtask' : 'Task'} deleted.`, 'info');
                         applyTaskFiltersAndSort(); // Refresh table
                     }, 'btn-danger');
                 }
                 // Toggle Subtasks
                 else if (target.closest('.subtask-toggle') && !target.closest('.subtask-toggle.disabled')) {
                     const task = mockTasks.find(t => t.id === taskId);
                     if (task) {
                         task.isExpanded = !task.isExpanded;
                         applyTaskFiltersAndSort(); // Re-render to show/hide subtasks
                     }
                 }
                 // Status Badge Click (Cycle through statuses)
                 else if (target.classList.contains('status-badge')) {
                      const currentStatus = mockTasks.find(t => t.id === taskId)?.status || (isSubtask ? mockTasks.flatMap(pt => pt.subtasks).find(st => st.id === taskId)?.status : null);
                      if (currentStatus) {
                          const statuses = ['todo', 'inprogress', 'completed', 'blocked'];
                          const currentIndex = statuses.indexOf(currentStatus);
                          const nextIndex = (currentIndex + 1) % statuses.length;
                          const nextStatus = statuses[nextIndex];

                          // Update status in mock data
                          let updated = false;
                          mockTasks = mockTasks.map(task => {
                              if (task.id === taskId && !isSubtask) {
                                  updated = true;
                                  return { ...task, status: nextStatus };
                              }
                              task.subtasks = task.subtasks.map(subtask => {
                                  if (subtask.id === taskId && isSubtask) {
                                      updated = true;
                                      return { ...subtask, status: nextStatus };
                                  }
                                  return subtask;
                              });
                              return task;
                          });

                          if (updated) {
                             applyTaskFiltersAndSort(); // Refresh UI
                              showToast(`Status changed to ${formatStatus(nextStatus)}`);
                              // Check parent task status if a subtask was modified
                              if (isSubtask) {
                                  checkTaskStatus(parseInt(taskRow.dataset.parentId));
                              } else {
                                checkTaskStatus(taskId); // Check self if parent task status changed
                              }
                          }
                      }
                 }
             }

             function toggleSubtasks(taskId) {
                 const task = mockTasks.find(t => t.id === taskId);
                 if (task) {
                     task.isExpanded = !task.isExpanded;
                     applyTaskFiltersAndSort(); // Re-render the table
                 }
             }

             // Auto-complete parent task if all subtasks are completed
             function checkTaskStatus(parentId) {
                 const parentTask = mockTasks.find(t => t.id === parentId);
                 if (parentTask && parentTask.subtasks.length > 0) {
                     const allSubtasksCompleted = parentTask.subtasks.every(st => st.status === 'completed');
                     if (allSubtasksCompleted && parentTask.status !== 'completed') {
                         parentTask.status = 'completed';
                         showToast(`Task "${parentTask.title.substring(0,20)}..." automatically marked as Completed.`, 'success');
                         applyTaskFiltersAndSort(); // Refresh table
                     }
                     // Optional: If parent is completed, maybe mark all subtasks completed? Or revert parent if one subtask becomes incomplete?
                     // else if (parentTask.status === 'completed' && !allSubtasksCompleted) {
                     //     parentTask.status = 'inprogress'; // Example: Revert if subtask becomes active again
                     //     showToast(`Task "${parentTask.title.substring(0,20)}..." status reverted due to active subtask.`, 'info');
                     //     applyTaskFiltersAndSort();
                     // }
                 }
             }

            // Check for overdue/due soon tasks and trigger notifications/UI updates
            function checkTaskDueDates() {
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                let changed = false;

                mockTasks.forEach(task => {
                    if (task.status === 'completed' || !task.dueDate) return; // Skip completed or date-less tasks

                    const dueDate = parseInputDate(task.dueDate);
                    if (!dueDate) return; // Skip if date parsing failed

                    const isOverdue = dueDate < today;
                    const isDueSoon = dueDate.getTime() === today.getTime() || dueDate.getTime() === tomorrow.getTime();

                    // Check if visual state needs update (row class)
                    const taskRow = document.querySelector(`.task-row[data-task-id="${task.id}"]`);
                    if (taskRow) {
                        const hadOverdueClass = taskRow.classList.contains('task-overdue');
                        const hadDueSoonClass = taskRow.querySelector('.task-due-date')?.classList.contains('task-due-soon');

                        if (isOverdue && !hadOverdueClass) {
                            taskRow.classList.add('task-overdue');
                            taskRow.querySelector('.task-due-date')?.classList.add('task-overdue'); // Ensure text color
                            taskRow.querySelector('.task-due-date')?.classList.remove('task-due-soon'); // Remove due soon if it became overdue
                            showToast(`Task "${task.title.substring(0, 20)}..." is overdue!`, 'error');
                            playNotificationSound();
                            changed = true;
                        } else if (isDueSoon && !hadDueSoonClass && !isOverdue) { // Only add if not already overdue
                            taskRow.querySelector('.task-due-date')?.classList.add('task-due-soon');
                            showToast(`Task "${task.title.substring(0, 20)}..." is due soon!`, 'warning');
                             playNotificationSound();
                            changed = true;
                        }
                         // Optional: Remove classes if date changes or task completed (handled partially by re-render)
                    }
                });

                // Optionally re-render if needed, but classes handle visuals for now
                // if (changed && currentFeature === 'task-management') {
                //    applyTaskFiltersAndSort();
                //}
            }

            // --- Utility Functions ---
            function timeAgo(timestamp) {
                if (!(timestamp instanceof Date)) return ''; // Check if valid date
                const now = new Date();
                const secondsPast = (now.getTime() - timestamp.getTime()) / 1000;

                if (secondsPast < 10) { // Show 'Just now' for very recent items
                    return 'Just now';
                }
                if (secondsPast < 60) {
                    return parseInt(secondsPast) + 's ago'; // Show seconds
                }
                if (secondsPast < 3600) { // Less than an hour
                    return parseInt(secondsPast / 60) + 'm ago';
                }
                 if (secondsPast < 3600 * 24) { // Within 24 hours
                     return parseInt(secondsPast / 3600) + 'h ago';
                 }
                 // Older than a day, show formatted date
                 return formatDateForDisplay(timestamp);
             }

             // Helper to format date based on stored preference
             function formatDateForDisplay(date) {
                 if (!(date instanceof Date)) return ''; // Basic check
                 const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                 const year = date.getFullYear();
                 const month = date.getMonth() + 1; // 0-indexed
                 const day = date.getDate();

                 const monthPadded = String(month).padStart(2, '0');
                 const dayPadded = String(day).padStart(2, '0');
                 const monthName = date.toLocaleDateString(undefined, { month: 'short' }); // e.g., 'Jan'

                 try {
                     switch (dateFormat) {
                         case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`;
                         case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`;
                         case 'Month D, YYYY': return `${monthName} ${day}, ${year}`;
                         case 'MM/DD/YYYY':
                         default:           return `${monthPadded}/${dayPadded}/${year}`;
                     }
                 } catch (e) {
                     console.error("Error formatting date:", e);
                     return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`; // Fallback
                 }
            }

            // Helper to format date for <input type="date"> (YYYY-MM-DD)
            function formatInputDate(date) {
                if (!(date instanceof Date)) return '';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

             // Helper to parse date from <input type="date"> (YYYY-MM-DD)
             function parseInputDate(dateString) {
                 if (!dateString || typeof dateString !== 'string') return null;
                 try {
                     // Important: Create date in UTC to avoid timezone issues with date-only inputs
                     const parts = dateString.split('-');
                     if (parts.length !== 3) return null;
                     const year = parseInt(parts[0]);
                     const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                     const day = parseInt(parts[2]);
                     const date = new Date(Date.UTC(year, month, day));
                     if (isNaN(date.getTime())) return null; // Invalid date
                     return date;
                 } catch (e) {
                     console.error("Error parsing date string:", dateString, e);
                     return null;
                 }
             }


            // Helper to format date and time based on preferences
             function formatFullDateTime(date) {
                 if (!(date instanceof Date)) return '';
                 const formattedDate = formatDateForDisplay(date);
                 const timeFormat = localStorage.getItem('timeFormat') || '12h';
                 const options = {
                     hour: 'numeric',
                     minute: 'numeric',
                     hour12: timeFormat === '12h'
                 };
                 try {
                     const formattedTime = date.toLocaleTimeString(undefined, options);
                     return `${formattedDate}, ${formattedTime}`;
                 } catch (e) {
                      console.error("Error formatting time:", e);
                      return formattedDate; // Fallback to just date
                 }
             }


            function generateMockActivities(count, baseTimestampMillis) {
                const nowMillis = baseTimestampMillis || Date.now(); // Use provided base or current time
                const newActivities = [];
                const users = MOCK_USERS.map(u => u.name.split(' ')[0]);
                 if (users.length === 0) users.push('System'); // Add a default user if empty
                const actions = ['updated profile', 'completed task', 'added a new project', 'commented on task', 'uploaded a file', 'joined the team', 'updated task status', 'assigned task']; // Added task actions
                const icons = ['fa-user-edit', 'fa-check-circle', 'fa-plus-circle', 'fa-comment', 'fa-upload', 'fa-user-plus', 'fa-sync-alt', 'fa-user-check'];
                 const tasks = mockTasks.map(t => `'${t.title.substring(0, 20)}...'`); // Use current tasks
                const projects = MOCK_PROJECTS.map(p => `'${p.name}'`);
                const files = ['document.pdf', 'image.png', 'spreadsheet.xlsx', 'presentation.pptx'];

                for (let i = 0; i < count; i++) {
                    const user = users[Math.floor(Math.random() * users.length)];
                    const actionIndex = Math.floor(Math.random() * actions.length);
                    let message = `${user} ${actions[actionIndex]}`;
                    if (actions[actionIndex].includes('task') && tasks.length > 0) {
                        const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                        message += ` ${randomTask}`;
                         if (actions[actionIndex] === 'assigned task' && users.length > 1) {
                            let assignee = users[Math.floor(Math.random() * users.length)];
                            while (assignee === user) { // Don't assign to self in this message
                                assignee = users[Math.floor(Math.random() * users.length)];
                            }
                             message += ` to ${assignee}`;
                         } else if (actions[actionIndex] === 'updated task status' ) {
                             const statuses = ['To Do', 'In Progress', 'Completed', 'Blocked'];
                              message += ` to ${statuses[Math.floor(Math.random() * statuses.length)]}`;
                         }
                    } else if (actions[actionIndex].includes('project') && projects.length > 0) {
                        message += ` ${projects[Math.floor(Math.random() * projects.length)]}`;
                    } else if (actions[actionIndex].includes('file') && files.length > 0) {
                        message += ` ${files[Math.floor(Math.random() * files.length)]}`;
                    }

                    // Generate timestamp relative to baseTimestampMillis
                    let timestampMillis;
                    if (count === 1) { // If generating a single 'live' activity
                        timestampMillis = nowMillis - Math.random() * 1000 * 10; // Within last 10 seconds
                    } else {
                        timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.5 + 300000); // Min 5 mins ago, spread over hours/days more
                    }
                     timestampMillis = Math.min(timestampMillis, nowMillis); // Ensure no future dates


                    newActivities.push({
                        id: nowMillis + i + Math.floor(Math.random()*1000), // Add random element for more uniqueness
                        icon: icons[actionIndex],
                        message: message,
                        timestamp: new Date(timestampMillis),
                        isNew: false // Set to true when dynamically adding
                    });
                }
                // Only sort if generating initial batch - This ensures correct initial order
                return count > 1 ? newActivities.sort((a, b) => b.timestamp - a.timestamp) : newActivities;
            }


            function generateMockNotifications(count, baseTimestampMillis) {
                 const nowMillis = baseTimestampMillis || Date.now(); // Use provided base or current time
                 const newNotifications = [];
                 const types = [
                     { msg: 'New task assigned:', icon: 'fa-tasks', type: 'task', relatedFeature: 'task-management' },
                     { msg: 'Project deadline approaching:', icon: 'fa-clock', type: 'project', relatedFeature: 'projects' },
                     { msg: 'Mentioned you in comment:', icon: 'fa-comment-dots', type: 'comment', relatedFeature: 'task-management' }, // Assume comment is on task
                     { msg: 'System update scheduled', icon: 'fa-info-circle', type: 'system', relatedFeature: 'dashboard' },
                     { msg: 'File shared with you:', icon: 'fa-file-alt', type: 'file', relatedFeature: 'file-sharing' },
                     { msg: 'Task overdue:', icon: 'fa-exclamation-triangle', type: 'task-alert', relatedFeature: 'task-management'},
                     { msg: 'Task due soon:', icon: 'fa-calendar-day', type: 'task-alert', relatedFeature: 'task-management'}
                 ];
                 const tasks = mockTasks; // Use the actual task objects
                 const projects = MOCK_PROJECTS;
                 const users = MOCK_USERS.map(u => u.name.split(' ')[0]);
                 if (users.length === 0) users.push('System'); // Add default if needed
                 const files = ['report.docx', 'logo.svg', 'data.csv'];

                 for (let i = 0; i < count; i++) {
                     const typeInfo = types[Math.floor(Math.random() * types.length)];
                     let message = typeInfo.msg;
                     let relatedId = null;

                     if (typeInfo.type === 'task' && tasks.length > 0) {
                        const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                        message += ` "${randomTask.title.substring(0,25)}..."`;
                        relatedId = randomTask.id;
                     }
                     else if (typeInfo.type === 'task-alert' && tasks.length > 0) {
                        const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                        message += ` "${randomTask.title.substring(0,25)}..."`;
                        relatedId = randomTask.id;
                     }
                     else if (typeInfo.type === 'project' && projects.length > 0) {
                        const randomProject = projects[Math.floor(Math.random() * projects.length)];
                        message += ` ${randomProject.name}`;
                        relatedId = randomProject.id;
                     }
                     else if (typeInfo.type === 'comment' && users.length > 0 && tasks.length > 0) {
                         const randomTask = tasks[Math.floor(Math.random() * tasks.length)];
                         message += ` by ${users[Math.floor(Math.random() * users.length)]} on task "${randomTask.title.substring(0,20)}..."`;
                         relatedId = randomTask.id; // Link to the task
                     }
                     else if (typeInfo.type === 'file' && files.length > 0 && users.length > 0) {
                         message += ` ${files[Math.floor(Math.random() * files.length)]} by ${users[Math.floor(Math.random() * users.length)]}`;
                         // relatedId could be file ID if implemented
                     }

                      // Generate timestamp (similar logic to activities)
                     let timestampMillis;
                     if (count === 1) { // Live update
                         timestampMillis = nowMillis - Math.random() * 1000 * 15; // Within last 15 seconds
                     } else { // Initial load
                         timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.8 + 180000); // Min 3 mins ago, spread more
                     }
                      timestampMillis = Math.min(timestampMillis, nowMillis); // Ensure not future

                     newNotifications.push({
                         id: nowMillis + i + 10000 + Math.floor(Math.random()*1000), // Unique ID
                         icon: typeInfo.icon,
                         message: message,
                         timestamp: new Date(timestampMillis),
                         unread: count === 1 ? true : Math.random() > 0.3, // New are unread, initial load random
                         relatedFeature: typeInfo.relatedFeature, // Store related feature
                         relatedId: relatedId // Store related item ID
                     });
                 }
                 // Only sort if generating initial batch
                 return count > 1 ? newNotifications.sort((a, b) => b.timestamp - a.timestamp) : newNotifications;
             }

            function showConfirmModal(title, message, onConfirm, buttonClass = 'btn-danger') {
                confirmTitle.textContent = title;
                confirmMessage.innerHTML = message; // Use innerHTML to allow basic formatting if needed
                confirmCallback = onConfirm;

                 // Reset button classes and set the new one
                 confirmBtn.className = 'btn'; // Reset to base class
                 confirmBtn.classList.add(buttonClass); // Add the specific class

                confirmModal.classList.add('active');
            }

            function hideConfirmModal() {
                confirmModal.classList.remove('active');
                confirmCallback = null; // Clear callback
            }

             function showSuccessMessage(message) {
                 successMessageText.textContent = message;
                 successMessage.classList.add('show');
                 setTimeout(() => {
                     successMessage.classList.remove('show');
                 }, 3000); // Hide after 3 seconds
             }

             function showToast(message, type = 'info') { // types: info, success, error, warning
                 // Check preference before showing
                 if (!showToasts && !['error', 'warning'].includes(type)) { // Always show errors/warnings?
                    console.log("Toast suppressed by preference:", message);
                    return;
                 }

                 toastMessage.textContent = message;
                 toastMessage.className = 'toast'; // Reset classes
                 if (type === 'success') toastMessage.classList.add('success');
                 else if (type === 'error') toastMessage.classList.add('error');
                 else if (type === 'warning') toastMessage.classList.add('warning'); // Not used yet, but could be
                 else if (type === 'info') toastMessage.classList.add('info');
                 // Default is dark background if no type matches


                 toastMessage.classList.add('show');

                 setTimeout(() => {
                     toastMessage.classList.remove('show');
                 }, 3000);
             }

            // --- Start Application ---
            initDashboard();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <!-- =========================================== -->
    <!-- == Main Dashboard Styles ================== -->
    <!-- =========================================== -->
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a; --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2); --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444; --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        /* Sidebar Styles */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer; }
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        /* Top Navigation */
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        /* ... (Rest of MAIN dashboard CSS - Search, User Menu, Content Area Base, Welcome, Stats, Activity, Profile, Settings, Modals, Responsive, etc.) ... */
        /* ... (Assume all original dashboard CSS is here and correct) ... */

        /* Content Sections Base Styling */
        .content-section {
             /* Hidden by default using JS display style */
             display: none;
             background-color: var(--white);
             border-radius: 8px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             padding: 2rem;
             transition: padding 0.3s ease, background-color 0.3s ease;
             /* Add margin-top if needed */
             margin-top: 1.5rem;
        }
        .content-section.active {
            display: block; /* Show when active */
        }
        body.compact .content-section { padding: 1rem; margin-top: 1rem;}
        body.spacious .content-section { padding: 3rem; margin-top: 2rem; }

         /* Placeholder Styling (inside dynamic container) */
         .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; /* margin-top: 2rem; - remove if container has margin */ min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: transparent; box-shadow: none; }
         .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; }
         .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
         .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; }

        /* --- Ensure dynamic container itself doesn't interfere --- */
        #featureSectionsContainer { display: none; } /* Hidden by default */
        #featureSections { /* This inner div holds the loaded content or placeholder */ }

    </style>

    <!-- =========================================== -->
    <!-- == Employee Schedule Styles (Separate) ==== -->
    <!-- =========================================== -->
    <style id="employee-schedule-styles">
        /* Styles specific to the loaded employee schedule content */
        /* Paste ALL CSS rules from `employee-schedule.txt`'s <style> tag HERE */
        /* Make sure to remove rules for `html`, `body`, `header` if they exist */
        /* Example start: */
        #featureSections .page-header { /* Scope to loaded section */
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;
        }
        #featureSections .page-title { font-size: 1.8rem; color: var(--primary-dark); font-weight: 700; }
        #featureSections .schedule-controls { /* ... */ }
        #featureSections .week-navigation { /* ... */ }
        /* ... (Paste ALL schedule styles here) ... */
        #featureSections .admin-controls:hover .edit-shift { /* ... */ }
        /* Modal Styles (Keep these global for simplicity or scope with #featureSections if needed) */
        .modal { /* ... */ }
        .modal-content { /* ... */ }
        /* Toast styles (Keep global) */
        .toast { /* ... */ }
        .toast.show { /* ... */ }
        /* Responsive styles specific to schedule */
        @media (max-width: 768px) {
             #featureSections .employee-name { position: static; /* ... */ }
             /* ... other schedule responsive rules ... */
        }
        /* ... (Ensure all schedule styles are correctly pasted here) ... */
    </style>

</head>
<body class="blue-theme">
    <audio id="notificationSound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg"></audio>
    <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i><span id="successMessageText">Action successful!</span></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Sidebar Content (Ensure href="#" and data-feature) -->
        <div class="sidebar-header"><div class="logo"><i class="fas fa-users-cog logo-icon"></i><span>TeamFlow</span></div></div>
        <div class="sidebar-menu">
            <div class="menu-title">Navigation</div>
            <a href="#" class="menu-item active" data-feature="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
            <a href="#" class="menu-item" data-feature="projects"><i class="fas fa-briefcase"></i><span>Projects</span></a>
            <a href="#" class="menu-item" data-feature="reports-analytics"><i class="fas fa-chart-line"></i><span>Reports & Analytics</span></a>
            <a href="#" class="menu-item" data-feature="team-members-view"><i class="fas fa-users"></i><span>Team Members</span></a>
            <div class="menu-title">Core Features</div>
            <a href="#" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
            <a href="#" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a>
            <a href="#" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
            <a href="#" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
            <div class="menu-title">Team Tools</div>
            <a href="#" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
            <a href="#" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a>
            <a href="#" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a>
            <a href="#" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a>
            <div class="menu-divider"></div>
            <a href="#" class="menu-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
            <a href="#" class="menu-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile (from Sidebar)</span></a>
        </div>
        <div class="connection-status"><div class="status-dot"></div><span>Online</span></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav"> <!-- ... Top Nav Content ... --> </nav>

        <!-- Content Area -->
        <div class="content-area">
            <div class="back-button" id="backButton" style="display: none;"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></div>

            <!-- STATIC SECTIONS (Initially only dashboard is active/shown) -->
            <div id="dashboardContent" class="content-section active">
                 <!-- Dashboard content... -->
                 <h2>Dashboard Section</h2>
                 <p>Welcome to the main dashboard.</p>
                 <!-- Include Welcome, Stats, Activity sections here -->
            </div>
            <div class="content-section" id="profileContent">
                <!-- Profile content... -->
                <h2>Profile Section</h2>
                 <p>User profile form goes here.</p>
            </div>
            <div class="content-section" id="settingsContent">
                 <!-- Settings content with tabs and panels... -->
                 <h2>Settings Section</h2>
                 <p>System settings panels go here.</p>
            </div>

            <!-- CONTAINER FOR DYNAMICALLY LOADED FEATURES -->
            <div id="featureSectionsContainer" style="display: none;">
                <div id="featureSections">
                    <!-- Placeholder shown during loading/error -->
                     <div class="placeholder-content content-section" id="featurePlaceholder">
                        <h2 id="featureTitle">Feature Area</h2>
                        <p id="featureDescription">Loading content...</p>
                        <div class="loading-indicator" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
                        <div class="error-message" style="display: none;">Failed to load content.</div>
                    </div>
                    <!-- Dynamically loaded HTML content will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
     <div class="notifications-modal" id="notificationsModal"> <!-- ... --> </div>
     <div class="confirm-modal" id="confirmModal"> <!-- ... --> </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements (Ensure these are selected correctly) ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const staticContentSections = document.querySelectorAll('.main-content > .content-area > .content-section'); // Dashboard, Profile, Settings
            const featureSectionsContainer = document.getElementById('featureSectionsContainer'); // The dynamic DIV container
            const featureSections = document.getElementById('featureSections'); // Where dynamic HTML goes INSIDE the container
            const featurePlaceholder = document.getElementById('featurePlaceholder'); // Placeholder element
            const featureTitle = document.getElementById('featureTitle');
            const featureDescription = document.getElementById('featureDescription');
            const featureLoadingIndicator = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorMessage = featurePlaceholder.querySelector('.error-message');
            const backButton = document.getElementById('backButton');
            const profileLink = document.getElementById('profileLink'); // Dropdown link
            const settingsLink = document.getElementById('settingsLink'); // Dropdown link
            // ... (other specific element selections like forms, buttons, etc.)

            // --- State Variables & Constants ---
            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
            let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences'; let activityIntervalId = null;
            let confirmCallback = null; let cancelCallback = null;
            const DEFAULT_USER = { /* ... default user object ... */ };

            // --- Initialization ---
            function initDashboard() { loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); handleInitialNavigation(); startActivityTimeUpdater(); setupEventListeners(); console.log("Dashboard Initialized."); }

            // --- Data Handling ---
            function loadData() { /* ... load from localStorage, ensure teamMembers have IDs ... */ }
            function saveData() { /* ... save to localStorage ... */ }
            function clearUserData() { /* ... clear localStorage ... */ }

            // --- UI Update Functions ---
            function updateUserUI() { /* ... update user details ... */ }
            function applyUserPreferences() { /* ... apply theme, layout, load settings forms ... */ }
            function applyRBAC() { /* ... show/hide elements based on role ... */ }
            function loadSettingsFormData() { /* ... populate settings forms ... */ }
            function updateStats() { /* ... update dashboard stats ... */ }
            function updateTrendIndicator(element, trend) { /* ... update trend icons ... */ }
            function updateNotificationBadge() { /* ... update notification count ... */ }

            // --- Feature/Section Loading (REVISED AGAIN - Strict Hiding/Showing) ---
             function setActiveFeature(featureId, settingsTab = null) {
                console.log(`%c[NAV] === Activating Feature: ${featureId} ===`, "color: blue; font-weight: bold;");

                // --- 1. Update State & URL ---
                currentFeature = featureId;
                currentSettingsTab = settingsTab || (featureId === 'settings' ? (currentSettingsTab || 'preferences') : null);
                let hash = `#${featureId}`;
                if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                if (window.location.hash !== hash) { history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash); }

                // --- 2. Update Sidebar Active Item ---
                menuItems.forEach(item => item.classList.remove('active'));
                document.querySelector(`.menu-item[data-feature="${featureId}"]`)?.classList.add('active');

                // --- 3. HIDE EVERYTHING FIRST ---
                console.log("%c[NAV] Hiding all content sections...", "color: orange;");
                staticContentSections.forEach(section => section.style.display = 'none');
                featureSectionsContainer.style.display = 'none';
                featureSections.innerHTML = ''; // Clear dynamic content

                // --- 4. DETERMINE TARGET & SHOW/LOAD ---
                let targetStaticElementId = null;
                if (featureId === 'dashboard') targetStaticElementId = 'dashboardContent';
                else if (featureId === 'profile') targetStaticElementId = 'profileContent';
                else if (featureId === 'settings') targetStaticElementId = 'settingsContent';

                if (targetStaticElementId) {
                    // --- Show Static Section ---
                    const elementToShow = document.getElementById(targetStaticElementId);
                    if (elementToShow) {
                        console.log(`%c[NAV] Showing static section: #${targetStaticElementId}`, "color: green;");
                        elementToShow.style.display = 'block';
                        // Refresh content if needed
                        if (featureId === 'dashboard') { updateStats(); loadActivities(/*...*/); }
                        if (featureId === 'profile') { updateUserUI(); }
                        if (featureId === 'settings') { applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }
                    } else {
                        console.error(`%c[ERROR] Static element not found: #${targetStaticElementId}`, "color: red;");
                    }
                } else {
                    // --- Load Dynamic Section ---
                    console.log(`%c[NAV] Preparing dynamic load for: ${featureId}`, "color: purple;");
                    featureSectionsContainer.style.display = 'block'; // Show the main container
                    featureSections.innerHTML = ''; // Ensure it's empty
                    featureSections.appendChild(featurePlaceholder); // Put placeholder inside
                    featurePlaceholder.style.display = 'flex'; // Show placeholder
                    featureTitle.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`;
                    featureDescription.textContent = '';
                    featureLoadingIndicator.style.display = 'block';
                    featureErrorMessage.style.display = 'none';

                    const filePath = `sections/${featureId}.html`; // ENSURE THIS PATH IS CORRECT
                    console.log(`%c[FETCH] Fetching: ${filePath}`, "color: #007acc;");

                    fetch(filePath)
                        .then(response => {
                            console.log(`%c[FETCH] Status for ${filePath}: ${response.status}`, "color: #007acc;");
                            if (!response.ok) { throw new Error(`HTTP ${response.status}`); }
                            return response.text();
                        })
                        .then(htmlContent => {
                            console.log(`%c[FETCH] Success: ${featureId}. Injecting HTML.`, "color: green;");
                            featureSections.innerHTML = htmlContent; // Replace placeholder

                            // --- Call Initializer ---
                             if (featureId === 'employee-scheduling') {
                                if (typeof initializeEmployeeSchedule === 'function') {
                                     try { initializeEmployeeSchedule(JSON.parse(JSON.stringify(currentUser)), JSON.parse(JSON.stringify(teamMembers))); console.log("%c[INIT] OK: initializeEmployeeSchedule", "color: teal;"); } catch (err) { console.error(`%c[INIT ERROR] initializeEmployeeSchedule:`, "color: red;", err); displayInitError(featureId, err); }
                                } else { console.warn(`%c[INIT WARN] initializeEmployeeSchedule not found.`, "color: orange;"); displayInitWarning(featureId); }
                             }
                             // Add other else if for other features
                        })
                        .catch(error => {
                            console.error(`%c[FETCH ERROR] Failed loading ${featureId}:`, "color: red;", error);
                            displayFetchError(featureId, error, filePath);
                        });
                }

                // --- 5. Update Back Button ---
                backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none';

                // --- 6. Scroll Top ---
                window.scrollTo(0, 0);
                 console.log(`%c[NAV] === Activation END: ${featureId} ===`, "color: blue;");
            }

            // Helper functions for displaying errors in placeholder
            function displayFetchError(featureId, error, filePath) {
                featureSections.innerHTML = ''; // Clear dynamic area
                featureSections.appendChild(featurePlaceholder); // Add placeholder back
                featurePlaceholder.style.display = 'flex';
                featureTitle.textContent = `Error Loading: ${featureId}`;
                featureDescription.textContent = `Could not fetch ${filePath}. ${error.message}. Check path & console.`;
                featureLoadingIndicator.style.display = 'none';
                featureErrorMessage.style.display = 'block';
            }
            function displayInitError(featureId, error) {
                 featureSections.innerHTML = ''; // Clear potentially broken content
                 featureSections.appendChild(featurePlaceholder);
                 featurePlaceholder.style.display = 'flex';
                 featureTitle.textContent = `Initialization Error: ${featureId}`;
                 featureDescription.textContent = `Content loaded, but script failed: ${error.message}. Check console.`;
                 featureLoadingIndicator.style.display = 'none';
                 featureErrorMessage.style.display = 'block';
            }
             function displayInitWarning(featureId) {
                 featureSections.innerHTML = ''; // Clear loaded content
                 featureSections.appendChild(featurePlaceholder);
                 featurePlaceholder.style.display = 'flex';
                 featureTitle.textContent = `${featureId} Loaded (No Init Script)`;
                 featureDescription.textContent = `Content might not be fully interactive. Initialization script not found.`;
                 featureLoadingIndicator.style.display = 'none';
                 featureErrorMessage.style.display = 'none'; // It's a warning, not an error
            }


            function activateSettingsTab(tabId) { /* ... (same as before) ... */ }
            function handleInitialNavigation() { /* ... (same as before) ... */ }

            // --- Activity & Notification Loading ---
            function loadActivities(showAll = false) { /* ... (same as before) ... */ }
            function loadNotifications() { /* ... (same as before) ... */ }

            // --- Time Formatting ---
            function getTimeAgo(timestamp) { /* ... (same as before) ... */ }
            function updateActivityTimes() { /* ... (same as before) ... */ }
            function startActivityTimeUpdater() { /* ... (same as before) ... */ }

             // --- Team Management ---
             function loadTeamMembers() { /* ... (same as before) ... */ }

            // --- Modals ---
            function showConfirmModal(config) { /* ... (same as before) ... */ }
            function hideConfirmModal() { /* ... (same as before) ... */ }

             // --- Action Handlers ---
             // IMPORTANT: Ensure all action handlers (save, delete, etc.) are defined here
             // Example:
             function handleProfileSave(e) { /* ... */ }
             function handleProfileCancel() { /* ... */ }
             // ... all other handlers ...
            function handleLogout() { /* ... (same as before) ... */ }

            // --- Utility Functions ---
            function addActivity(icon, message) { /* ... (same as before) ... */ }
            function addNotification(icon, message) { /* ... (same as before) ... */ }
            function playNotificationSound() { /* ... (same as before) ... */ }
            function showSuccessMessage(message) { /* ... (same as before) ... */ }

            // --- Event Listener Setup ---
            function setupEventListeners() {
                console.log("%c[SETUP] Setting up event listeners...", "color: gray;");
                // Sidebar Navigation (Event Delegation)
                sidebar.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        const featureId = menuItem.dataset.feature;
                        if (featureId) {
                            e.preventDefault(); // Prevent default ONLY for handled features
                            console.log(`%c[EVENT] Menu click -> feature: ${featureId}`, "color: darkred;");
                            setActiveFeature(featureId);
                        }
                    }
                });

                 // Dropdown Links
                 profileLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('profile'); });
                 settingsLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); setActiveFeature('settings'); });
                 logoutLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown.classList.remove('active'); handleLogout(); });

                 // Other listeners... (Back Button, Popstate, Search, User Dropdown, Notifications, Modals, Forms, Theme/Layout...)
                 // ... (ensure all previous listeners are correctly added here) ...
                 backButton.addEventListener('click', () => setActiveFeature('dashboard'));
                 window.addEventListener('popstate', (event) => { console.log("%c[EVENT] Popstate", "color: darkred;"); if (event.state) setActiveFeature(event.state.feature, event.state.tab); else handleInitialNavigation(); });
                 // ... rest of the listeners from previous correct versions
            }

             // --- Placeholder Search Function ---
             function handleSearch() { /* ... (same as before) ... */ }

            // ==============================================================
            // == Employee Scheduling Initialization Function ==============
            // ==============================================================
            function initializeEmployeeSchedule(currentUserData, employeesData) {
                 // --- This function remains exactly the same as the previous response ---
                 console.log("initializeEmployeeSchedule called.");
                 // ... (The rest of the function code for schedule logic) ...
            }
            // ============================================================

            // --- Run Initialization ---
            initDashboard();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <!-- Link to the Employee Scheduling CSS -->
    <link rel="stylesheet" href="sections/employee-scheduling.css">

    <style>
        /* --- Paste ALL original CSS from dashboard.txt here --- */
        :root {
            --primary: #2563eb; --primary-dark: #1e3a8a; --primary-light: #dbeafe; --secondary: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --light-gray: #e2e8f0; --white: #ffffff; --sidebar-width: 280px; --sidebar-bg: #1e3a8a; --sidebar-text: rgba(255,255,255,0.9); --sidebar-hover: rgba(255,255,255,0.1); --sidebar-active: rgba(255,255,255,0.2); --sidebar-divider: rgba(255,255,255,0.1); --success: #10b981; --team-manager: #ef4444; --compact-padding: 0.5rem; --normal-padding: 1rem; --spacious-padding: 1.5rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--primary-light); color: var(--dark); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; }
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); }
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; } body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--dark); }
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--dark); }
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: 100%; right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--dark); text-decoration: none; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; }
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; overflow: visible; width: 100%; box-sizing: border-box; } /* overflow: visible added */
        body.compact .content-area { padding: 1rem; } body.spacious .content-area { padding: 3rem; }
        .welcome-section { background-color: var(--primary-dark); color: var(--white); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: padding 0.3s ease, margin-bottom 0.3s ease, background-color 0.3s ease; }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; } body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; }
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; }
        .user-info-title.role-admin { color: var(--team-manager); }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; } body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card { background-color: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; }
        body.compact .stat-card { padding: 1rem; } body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary), var(--secondary)); opacity: 0.9; }
        .stat-title { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { color: var(--primary); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); } .trend-down { color: var(--danger); } .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; } body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; } body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); } .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); } .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; }
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; } body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--dark); }
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 1; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; }
        .delete-activity:hover { background-color: rgba(239, 68, 68, 0.1); }
        .content-section { display: none; background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease, opacity 0.3s ease; }
        #featureSections { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; overflow: visible !important; width: 100%; display: block; box-sizing: border-box; } /* overflow: visible !important added */
        .content-section.active { display: block; animation: fadeInSection 0.4s ease-out; }
        @keyframes fadeInSection { from { opacity: 0; } to { opacity: 1; } }
        body.compact .content-section, body.compact #featureSections { padding: 1rem; } body.spacious .content-section, body.spacious #featureSections { padding: 3rem; }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; }
        body.compact .section-main-header { margin-bottom: 1.5rem; } body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #uploadPhotoButton { margin-top: 0.5rem;}
        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; } body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; } body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); transition: margin-bottom 0.3s ease, font-size 0.3s ease; }
        body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--dark); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; } body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; } body.spacious .form-actions { margin-top: 2rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; } body.spacious .btn { padding: 1rem 2rem; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); } .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; } .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn-secondary { background-color: var(--secondary); color: white; } .btn-secondary:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; } body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; } body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); } .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; } .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); } input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; } .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; } body.compact .team-management { margin-top: 1rem; } body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--dark); margin-bottom: 1rem; }
        .team-list { margin-top: 1rem; } body.compact .team-list { margin-top: 0.75rem; } body.spacious .team-list { margin-top: 1.5rem; }
        .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; } body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        .member-details { flex: 1; min-width: 0; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact .member-email { font-size: 0.8rem; }
        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; }
        body.compact .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); } .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); } .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); } .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; } body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        body.light-theme { --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; background-color: var(--primary-light); }
        body.dark-theme { --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #1e293b; --light: #334155; --white: #0f172a; --dark: #e2e8f0; --gray: #94a3b8; --light-gray: #334155; background-color: var(--white); }
        body.dark-theme .top-nav { background-color: var(--primary-light); border-bottom-color: var(--light-gray); }
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme #featureSections, body.dark-theme .team-member-card, body.dark-theme .add-member-form { background-color: var(--primary-light); }
        body.dark-theme .search-bar input, body.dark-theme .form-control { background-color: var(--light); border-color: var(--light-gray); color: var(--dark); }
        body.dark-theme .form-control[readonly] { background-color: var(--primary-light); }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item:hover { background-color: var(--light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .confirm-container { background-color: var(--light); }
        body.dark-theme .theme-option div { border-color: var(--light-gray); }
        body.dark-theme .theme-option[data-theme="dark"] div { border-color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--light); }
        body.dark-theme .notifications-footer { background-color: var(--primary-light); }
        body.dark-theme .welcome-section { background-color: var(--primary-dark); color: var(--white); }
        body.dark-theme .user-info-title { color: var(--light-gray); }
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email { color: var(--light-gray); }
        body.dark-theme .welcome-subtitle { color: var(--light-gray); }
        body.dark-theme .placeholder-content { background-color: var(--light); border-color: var(--light-gray);}
        body.blue-theme { --primary-light: #dbeafe; --light: #eff6ff; --white: #ffffff; --dark: #1e293b; background-color: var(--primary-light); }
        body.blue-theme #featureSections { background-color: var(--white); } body.blue-theme .placeholder-content { background-color: var(--light); }
        .theme-option { display: flex; flex-direction: column; align-items: center; }
        .theme-option div { width: 60px; height: 40px; border: 2px solid var(--light-gray); border-radius: 6px; cursor: pointer; transition: border-color 0.2s; }
        .theme-option span { text-align: center; display: block; margin-top: 0.5rem; font-size: 0.9rem; color: var(--dark); }
        .theme-option:hover div { border-color: var(--primary); } .theme-option.selected div { border-color: var(--primary); border-width: 3px; }
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--white); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: center; cursor: pointer; }
        .notification-list-item:hover { background-color: var(--light); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.05); font-weight: 500; }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s; margin-left: auto; padding: 0.5rem; flex-shrink: 0; }
        .delete-notification:hover { opacity: 1; }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--light); }
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); } .success-message i { font-size: 1.25rem; }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); width: 250px; } .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); } .main-content { margin-left: 0; } .search-bar { width: 250px; } .team-member-card { flex-wrap: wrap; } }
        @media (max-width: 768px) { .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; } .search-bar { width: 100%; order: 2; } .user-menu { width: 100%; justify-content: space-between; order: 1; } .content-area { padding: 1.5rem; } .data-form { grid-template-columns: 1fr; } .form-actions { grid-column: span 1; } .user-info { flex-direction: column; text-align: center; } .user-info-avatar { margin-bottom: 1rem; } .stats-section { grid-template-columns: 1fr; } .settings-tabs { flex-wrap: wrap; } .settings-tab { padding: 0.5rem 1rem; } .confirm-container { width: 90%; } .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; } .member-role { margin: 0.5rem 0; } .member-actions { margin-top: 0.5rem; } .profile-avatar-section { margin-bottom: 1.5rem; } #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; } .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; } .add-member-form .data-form > div { margin-bottom: 1rem; } .add-member-form .data-form > div:last-child { margin-top: 0; } }
        @media (max-width: 480px) { .section-header > div { justify-content: center; width: 100%; } .welcome-section { padding: 1.5rem; } .stats-section { gap: 0.75rem; } .stat-card { padding: 1rem; } }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; } .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; } .d-none { display: none !important; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }
        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--light-gray); border-radius: 8px; margin-top: 2rem; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--light); }
        .placeholder-content h2 { color: var(--dark); margin-bottom: 1rem; font-weight: 600; }
        .placeholder-content p { margin-bottom: 1.5rem; line-height: 1.6; }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; color: var(--primary); }
        .placeholder-content .loading-indicator i { margin-right: 0.5rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; border: 1px solid var(--danger); padding: 0.75rem 1rem; border-radius: 4px; background-color: rgba(239, 68, 68, 0.05); max-width: 80%; }
    </style>
</head>
<body class="blue-theme">
    <audio id="notificationSound" preload="auto"> <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg"> </audio>
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"> <div class="logo"> <i class="fas fa-users-cog logo-icon"></i> <span>TeamFlow</span> </div> </div>
        <div class="sidebar-menu"> <div class="menu-title">Navigation</div> <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a> <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a> <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a> <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a> <div class="menu-title">Core Features</div> <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a> <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a> <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a> <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a> <div class="menu-title">Team Tools</div> <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a> <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a> <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a> <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a> <div class="menu-divider"></div> <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a> </div>
        <div class="connection-status"> <div class="status-dot"></div> <span>Online</span> </div>
    </aside>
    <main class="main-content">
        <nav class="top-nav"> <div class="search-bar"> <i class="fas fa-search search-icon"></i> <input type="text" placeholder="Search..." id="searchInput" autocomplete="off"> <div class="search-results" id="searchResults"></div> </div> <div class="user-menu"> <div class="notification-icon" id="notificationIcon"> <i class="fas fa-bell"></i> <span class="notification-badge" style="display: none;">0</span> </div> <div class="user-profile"> <div class="user-avatar" id="userAvatar">ME</div> <div class="user-profile-details"> <span class="user-name" id="userName">Mohamed Elmenisy</span> <span class="user-status"> â€¢ Connected</span> </div> <div class="user-dropdown" id="userDropdown"> <a href="#profile" class="dropdown-item" id="profileLink"><i class="fas fa-user"></i><span>Profile</span></a> <a href="#settings" class="dropdown-item" id="settingsLink"><i class="fas fa-cog"></i><span>Settings</span></a> <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a> </div> </div> </div> </nav>
        <div class="content-area">
             <div class="back-button" id="backButton" style="display: none;"> <i class="fas fa-arrow-left"></i> <span>Back to Dashboard</span> </div>
             <div id="dashboardContent" class="content-section active"> <div class="welcome-section"> <h2 class="welcome-title">Welcome, <span id="welcomeName">Mohamed</span>!</h2> <p class="welcome-subtitle">Here's what's happening...</p> <div class="user-info"> <div class="user-info-avatar" id="profileAvatar">ME</div> <div class="user-info-details"> <div class="user-info-name">Mohamed Elmenisy</div> <div class="user-info-title" id="userInfoRoleTitle">Administrator</div> <div class="user-info-email"> <i class="fas fa-envelope"></i> <span id="userEmail">m.elsayed@thechefz.co</span> </div> </div> </div> </div> <div class="stats-section"> <div class="stat-card"> <div class="stat-title"><i class="fas fa-users"></i>Team</div> <div class="stat-value"> <span id="teamMembersCount">0</span> <span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-check-circle"></i>Tasks Done</div> <div class="stat-value"> <span id="tasksCompleted">0</span> <span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-project-diagram"></i>Projects</div> <div class="stat-value"> <span id="activeProjects">0</span> <span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-calendar-times"></i>Deadlines</div> <div class="stat-value"> <span id="upcomingDeadlines">0</span> <span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> </div> <div class="activity-section"> <div class="section-header"> <h3 class="section-title">Activity <span class="live-badge">LIVE</span></h3> <div> <span class="view-all" id="viewAllActivity" style="display: none;">Show All</span> <span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span> </div> </div> <ul class="activity-list" id="activityList"> <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading... </li> </ul> </div> </div>
             <div class="content-section" id="profileContent"> <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div> <p class="profile-header-text">Personal info & security.</p> <div class="profile-avatar-section"> <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark);">Avatar</label> <div id="profileAvatarLarge">ME</div> <button type="button" class="btn btn-outline btn-sm" id="uploadPhotoButton"> <i class="fas fa-upload"></i> Upload </button> <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;"> </div> <form class="data-form" id="profileForm"> <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value="Mohamed"> </div> <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value="Elmenisy"> </div> <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="Mohamed Elmenisy" readonly> </div> <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value="Administrator"> </div> <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="m.elsayed@thechefz.co" readonly> </div> <div class="form-group"> <label for="phone">Phone</label> <input type="tel" id="phone" class="form-control" value="+201234567890"> </div> <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value="Management"> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button> <button type="submit" class="btn btn-primary">Save</button> </div> </form> </div>
             <div class="content-section" id="settingsContent"> <div class="section-main-header"> <h2 class="section-main-title">Settings</h2> </div> <div class="settings-tabs"> <div class="settings-tab active" data-tab="preferences">Prefs</div> <div class="settings-tab" data-tab="account">Account</div> <div class="settings-tab" data-tab="security">Security</div> <div class="settings-tab" data-tab="notifications">Notify</div> <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team</div> <div class="settings-tab" data-tab="collaboration">Collab</div> <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger</div> </div> <div class="settings-panel active" id="preferencesPanel"> <h3 class="section-title">Preferences</h3> <form class="data-form" id="preferencesForm"> <div class="form-group"> <label>Theme</label> <div style="display: flex; gap: 1rem; margin-top: 0.5rem;"> <div class="theme-option" data-theme="light"> <div style="background-color: #f1f5f9;"></div> <span>Light</span> </div> <div class="theme-option" data-theme="dark"> <div style="background-color: #0f172a;"></div> <span>Dark</span> </div> <div class="theme-option selected" data-theme="blue"> <div style="background-color: #dbeafe;"></div> <span>Blue</span> </div> </div> <input type="hidden" id="selectedTheme" value="blue"> </div> <div class="form-group"> <label for="layoutDensity">Layout</label> <select id="layoutDensity" class="form-control"> <option value="compact">Compact</option> <option value="normal" selected>Normal</option> <option value="spacious">Spacious</option> </select> </div> <div class="form-group"> <label for="language">Language</label> <select id="language" class="form-control"> <option value="en" selected>English</option> <option value="ar">Arabic</option> </select> </div> <div class="form-group"> <label for="dateFormat">Date Format</label> <select id="dateFormat" class="form-control"> <option value="mm/dd/yyyy">MM/DD/YYYY</option> <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option> <option value="yyyy-mm-dd">YYYY-MM-DD</option> </select> </div> <div class="form-group"> <label for="region">Region</label> <input type="text" id="region" class="form-control" placeholder="Cairo" disabled> </div> <div class="form-group"> <label for="weekStart">Week Start</label> <select id="weekStart" class="form-control"> <option value="sun" selected>Sunday</option> </select> </div> <div class="form-group" style="grid-column: span 2;"> <label>Homepage (PH)</label> <select id="defaultHomepage" class="form-control" disabled> <option selected>Dashboard</option> </select> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelPreferencesBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="savePreferencesBtn"> <span class="btn-text">Save</span> <div class="spinner" id="preferencesSpinner"></div> <span class="loading-text" id="preferencesLoadingText">Saving...</span> </button> </div> </form> </div> <div class="settings-panel" id="accountPanel"> <h3 class="section-title">Account</h3> <form class="data-form" id="accountForm"> <div class="form-group"> <label>First Name</label> <input type="text" id="acc_firstName" class="form-control" readonly> </div> <div class="form-group"> <label>Last Name</label> <input type="text" id="acc_lastName" class="form-control" readonly> </div> <div class="form-group"> <label>Email</label> <input type="email" id="acc_email" class="form-control" readonly> </div> <div class="form-group"> <label>Timezone</label> <select id="timezone" class="form-control"> <option value="utc">UTC</option> <option value="cairo" selected>Cairo (UTC+2)</option> </select> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelAccountBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveAccountBtn"> <span class="btn-text">Save</span> <div class="spinner" id="accountSpinner"></div> <span class="loading-text" id="accountLoadingText">Saving...</span> </button> </div> <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"> <label style="color: var(--danger);">Account Deletion</label> <p style="color: var(--gray);font-size:.9rem;margin-bottom:1rem;">Permanent action.</p> <button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled>Delete (PH)</button> </div> </form> </div> <div class="settings-panel" id="securityPanel"> <h3 class="section-title">Security</h3> <form class="data-form" id="securityForm"> <div class="form-group" style="grid-column: span 2;"> <label>2FA</label> <div style="display: flex; align-items: center; gap: 1rem;"> <label class="switch"> <input type="checkbox" id="twoFactorAuth" checked> <span class="slider round"></span> </label> <span>Enabled</span> </div> <p style="color: var(--gray);font-size:.9rem;margin-top:.5rem;">Requires code.</p> </div> <div class="form-group"> <label>Current Password</label> <input type="password" id="currentPassword" class="form-control" autocomplete="current-password"> <div class="password-error" id="currentPasswordError">Incorrect</div> </div> <div class="form-group"> <label>New Password</label> <input type="password" id="newPassword" class="form-control" autocomplete="new-password"> <small>Min 8 chars.</small> </div> <div class="form-group"> <label>Confirm New</label> <input type="password" id="confirmPassword" class="form-control" autocomplete="new-password"> <div class="password-error" id="passwordMatchError">Mismatch</div> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelSecurityBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveSecurityBtn"> <span class="btn-text">Update Pwd</span> <div class="spinner" id="securitySpinner"></div> <span class="loading-text" id="securityLoadingText">Updating...</span> </button> </div> <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"> <label>Integrations (PH)</label> <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"> <span>Slack</span> <button class="btn btn-outline" disabled>Connect</button> </div> <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;"> <span>SSO</span> <button class="btn btn-outline" disabled>Configure</button> </div> </div> </form> </div> <div class="settings-panel" id="notificationsPanel"> <h3 class="section-title">Notifications</h3> <form class="data-form" id="notificationsForm"> <div class="form-group"> <label>Email</label> <div style="margin-top:.5rem; display:flex; flex-direction:column; gap:.75rem;"> <div style="display: flex; justify-content: space-between;"> <span>Tasks</span> <label class="switch"> <input type="checkbox" id="emailTasks" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; justify-content: space-between;"> <span>Deadlines</span> <label class="switch"> <input type="checkbox" id="emailDeadlines" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; justify-content: space-between;"> <span>Updates</span> <label class="switch"> <input type="checkbox" id="emailUpdates"> <span class="slider round"></span> </label> </div> <div style="display: flex; justify-content: space-between;"> <span>Summary (PH)</span> <label class="switch"> <input type="checkbox" id="emailSummary" disabled> <span class="slider round"></span> </label> </div> </div> </div> <div class="form-group"> <label>In-App</label> <div style="margin-top:.5rem; display:flex; flex-direction:column; gap:.75rem;"> <div style="display: flex; justify-content: space-between;"> <span>Messages</span> <label class="switch"> <input type="checkbox" id="pushMessages" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; justify-content: space-between;"> <span>Team Updates</span> <label class="switch"> <input type="checkbox" id="pushTeamUpdates"> <span class="slider round"></span> </label> </div> <div style="display: flex; justify-content: space-between;"> <span>Sound</span> <label class="switch"> <input type="checkbox" id="soundNotifications" checked> <span class="slider round"></span> </label> </div> </div> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelNotificationsBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveNotificationsBtn"> <span class="btn-text">Save</span> <div class="spinner" id="notificationsSpinner"></div> <span class="loading-text" id="notificationsLoadingText">Saving...</span> </button> </div> </form> </div> <div class="settings-panel" id="teamPanel"> <div class="team-management"> <h3>Team Members</h3> <div class="team-list" id="teamList"> <div style="text-align:center; padding:2rem; color:var(--gray);">Loading...</div> </div> <div class="add-member-form"> <h4>Invite Member</h4> <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;"> <div class="form-group" style="margin-bottom:0;"> <label for="inviteMemberEmail">Email</label> <input type="email" id="inviteMemberEmail" class="form-control" placeholder="user@example.com" required> </div> <div class="form-group" style="margin-bottom:0;"> <label for="inviteMemberRole">Role</label> <select id="inviteMemberRole" class="form-control" required> <option value="member">Member</option> <option value="senior">Senior</option> <option value="supervisor">Supervisor</option> <option value="admin">Admin</option> </select> </div> <div style="grid-column: 1 / -1; margin-top: 1rem;"> <button type="submit" class="btn btn-primary">Send Invite</button> </div> </form> </div> </div> </div> <div class="settings-panel" id="collaborationPanel"> <h3 class="section-title">Collaboration</h3> <form class="data-form" id="collaborationForm"> <div class="form-group" style="grid-column: span 2;"> <label>Shared Calendar (PH)</label> <p style="color:var(--gray); font-size:.9rem;">Control access.</p> <button type="button" class="btn btn-outline" disabled>Manage</button> </div> <div class="form-group" style="grid-column: span 2;"> <label>Chat Integration (PH)</label> <p style="color:var(--gray); font-size:.9rem;">Connect platform.</p> <button type="button" class="btn btn-outline" disabled>Configure</button> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" disabled>Cancel</button> <button type="submit" class="btn btn-primary" disabled>Save</button> </div> </form> </div> <div class="settings-panel" id="dangerPanel"> <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3> <p style="color: var(--gray);">Permanent actions (Admins only).</p> <div style="margin-top:1.5rem; border:1px solid var(--danger); border-radius:6px; padding:1.5rem; display:flex; flex-direction:column; gap:1.5rem;"> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color:var(--dark);">Delete Team Data (PH)</strong> <p style="color:var(--gray);font-size:.9rem;margin-top:.25rem;">Delete all projects, tasks, files.</p> </div> <button class="btn btn-danger" disabled>Delete Data</button> </div> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color:var(--dark);">Transfer Ownership (PH)</strong> <p style="color:var(--gray);font-size:.9rem;margin-top:.25rem;">Transfer admin control.</p> </div> <button class="btn btn-warning" disabled>Transfer</button> </div> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color:var(--dark);">Delete Workspace (PH)</strong> <p style="color:var(--gray);font-size:.9rem;margin-top:.25rem;">Delete entire workspace.</p> </div> <button class="btn btn-danger" disabled>Delete Workspace</button> </div> </div> </div>
            </div>
            <div id="featureSectionsContainer" style="display: none;"> <div id="featureSections" class="content-section"> <div class="placeholder-content" id="featurePlaceholder"> <h2 id="featureTitle">Feature</h2> <p id="featureDescription">Select a feature.</p> <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div> <div class="error-message" style="display: none;"> <i class="fas fa-exclamation-triangle"></i> Error loading. </div> </div> </div> </div>
        </div>
    </main>
    <div class="notifications-modal" id="notificationsModal"> <div class="notifications-container"> <div class="notifications-header"> <h3 class="notifications-title">Notifications</h3> <button class="close-notifications" id="closeNotifications">&times;</button> </div> <div class="notifications-body" id="notificationsBody"> <div class="no-notifications-message">Loading...</div> </div> <div class="notifications-footer"> <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All Read</button> <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button> </div> </div> </div>
    <div class="confirm-modal" id="confirmModal"> <div class="confirm-container"> <h3 class="confirm-title" id="confirmTitle">Confirm</h3> <div class="confirm-message" id="confirmMessage">Are you sure?</div> <div class="confirm-actions"> <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button> <button class="btn btn-danger" id="confirmBtn">Confirm</button> </div> </div> </div>

    <!-- Include the separated JS file for scheduling -->
    <script src="sections/employee-scheduling.js"></script>

    <!-- Main Dashboard JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar'); const menuItems = document.querySelectorAll('.menu-item'); const searchInput = document.getElementById('searchInput'); const searchResults = document.getElementById('searchResults'); const notificationIcon = document.getElementById('notificationIcon'); const notificationBadge = document.querySelector('.notification-badge'); const notificationsModal = document.getElementById('notificationsModal'); const notificationsBody = document.getElementById('notificationsBody'); const closeNotifications = document.getElementById('closeNotifications'); const markAllReadBtn = document.getElementById('markAllReadBtn'); const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn'); const userAvatar = document.getElementById('userAvatar'); const userProfileDetails = document.querySelector('.user-profile-details'); const userName = document.getElementById('userName'); const userEmail = document.getElementById('userEmail'); const welcomeName = document.getElementById('welcomeName'); const userDropdown = document.getElementById('userDropdown'); const profileLink = document.getElementById('profileLink'); const settingsLink = document.getElementById('settingsLink'); const logoutLink = document.getElementById('logoutLink'); const contentSections = document.querySelectorAll('.content-section'); const dashboardContent = document.getElementById('dashboardContent'); const profileContent = document.getElementById('profileContent'); const settingsContent = document.getElementById('settingsContent'); const featureSectionsContainer = document.getElementById('featureSectionsContainer'); const featureSections = document.getElementById('featureSections'); const featurePlaceholder = document.getElementById('featurePlaceholder'); const featureTitle = document.getElementById('featureTitle'); const featureDescription = document.getElementById('featureDescription'); const featureLoadingIndicator = featurePlaceholder.querySelector('.loading-indicator'); const featureErrorMessage = featurePlaceholder.querySelector('.error-message'); const profileForm = document.getElementById('profileForm'); const cancelProfileBtn = document.getElementById('cancelProfileBtn'); const profileAvatarInput = document.getElementById('profileAvatarInput'); const profileAvatar = document.getElementById('profileAvatar'); const profileAvatarLarge = document.getElementById('profileAvatarLarge'); const uploadPhotoButton = document.getElementById('uploadPhotoButton'); const activityList = document.getElementById('activityList'); const viewAllActivity = document.getElementById('viewAllActivity'); const deleteAllActivity = document.getElementById('deleteAllActivity'); const settingsTabs = document.querySelectorAll('.settings-tab'); const settingsPanels = document.querySelectorAll('.settings-panel'); const preferencesForm = document.getElementById('preferencesForm'); const accountForm = document.getElementById('accountForm'); const securityForm = document.getElementById('securityForm'); const notificationsForm = document.getElementById('notificationsForm'); const teamList = document.getElementById('teamList'); const inviteMemberForm = document.getElementById('inviteMemberForm'); const themeOptions = document.querySelectorAll('.theme-option'); const layoutDensitySelect = document.getElementById('layoutDensity'); const weekStartSelect = document.getElementById('weekStart'); const confirmModal = document.getElementById('confirmModal'); const confirmTitle = document.getElementById('confirmTitle'); const confirmMessage = document.getElementById('confirmMessage'); const cancelConfirmBtn = document.getElementById('cancelConfirmBtn'); const confirmBtn = document.getElementById('confirmBtn'); const teamMembersCount = document.getElementById('teamMembersCount'); const tasksCompleted = document.getElementById('tasksCompleted'); const activeProjects = document.getElementById('activeProjects'); const upcomingDeadlines = document.getElementById('upcomingDeadlines'); const userInfoRoleTitle = document.getElementById('userInfoRoleTitle'); const backButton = document.getElementById('backButton'); const notificationSound = document.getElementById('notificationSound'); const successMessage = document.getElementById('successMessage'); const successMessageText = document.getElementById('successMessageText'); const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn'); const cancelAccountBtn = document.getElementById('cancelAccountBtn'); const cancelSecurityBtn = document.getElementById('cancelSecurityBtn'); const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn'); const currentPasswordInput = document.getElementById('currentPassword'); const newPasswordInput = document.getElementById('newPassword'); const confirmPasswordInput = document.getElementById('confirmPassword'); const currentPasswordError = document.getElementById('currentPasswordError'); const passwordMatchError = document.getElementById('passwordMatchError'); const teamMembersTrend = document.getElementById('teamMembersTrend'); const tasksCompletedTrend = document.getElementById('tasksCompletedTrend'); const activeProjectsTrend = document.getElementById('activeProjectsTrend'); const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend'); const soundNotificationsSwitch = document.getElementById('soundNotifications'); const fullNameDisplay = document.getElementById('fullNameDisplay'); const teamSettingsTab = document.getElementById('teamSettingsTab'); const dangerZoneTab = document.getElementById('dangerZoneTab');

            // --- State Variables ---
            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = []; let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences'; let activityIntervalId = null; let confirmCallback = null; let cancelCallback = null;

            // --- Constants ---
            const MAX_ACTIVITIES_DISPLAYED = 5; const UPDATE_INTERVAL = 60000; const SIMULATED_DELAY = 800; const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500;
            const DEFAULT_USER = { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', password: 'password123', preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' }, notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } }, security: { twoFactorEnabled: true }, stats: { teamMembers: 4, tasksCompleted: 15, activeProjects: 3, upcomingDeadlines: 2, teamMembersTrend: 'neutral', tasksCompletedTrend: 'up', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'down' } };
            const DEFAULT_TEAM = [ { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', role: 'admin', initials: 'ME', avatar: null }, { id: 2, name: 'Yousef', email: 'yousef@example.com', role: 'supervisor', initials: 'Y', avatar: null }, { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'member', initials: 'EL', avatar: null }, { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'member', initials: 'BB', avatar: null } ];

            // --- Initialization ---
            function initDashboard() { loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); handleInitialNavigation(); startActivityTimeUpdater(); setupEventListeners(); }

            // --- Data Handling ---
            function loadData() { const storedUser = JSON.parse(localStorage.getItem('currentUser')); currentUser = { ...DEFAULT_USER, ...storedUser }; currentUser.preferences = { ...DEFAULT_USER.preferences, ...(storedUser?.preferences || {}) }; currentUser.notificationPreferences = { ...DEFAULT_USER.notificationPreferences, ...(storedUser?.notificationPreferences || {}) }; currentUser.notificationPreferences.email = { ...DEFAULT_USER.notificationPreferences.email, ...(storedUser?.notificationPreferences?.email || {}) }; currentUser.notificationPreferences.push = { ...DEFAULT_USER.notificationPreferences.push, ...(storedUser?.notificationPreferences?.push || {}) }; currentUser.security = { ...DEFAULT_USER.security, ...(storedUser?.security || {}) }; currentUser.stats = { ...DEFAULT_USER.stats, ...(storedUser?.stats || {}) }; teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || DEFAULT_TEAM; if (localStorage.getItem('teamMembers') === null) { localStorage.setItem('teamMembers', JSON.stringify(teamMembers)); } if (localStorage.getItem('activities') === null) { activities = generateSampleActivities(); localStorage.setItem('activities', JSON.stringify(activities)); } else { activities = JSON.parse(localStorage.getItem('activities')) || []; } if (localStorage.getItem('notifications') === null) { notifications = generateSampleNotifications(); localStorage.setItem('notifications', JSON.stringify(notifications)); } else { notifications = JSON.parse(localStorage.getItem('notifications')) || []; } currentUser.stats.teamMembers = teamMembers.length; }
            function saveData() { currentUser.stats.teamMembers = teamMembers.length; localStorage.setItem('currentUser', JSON.stringify(currentUser)); localStorage.setItem('teamMembers', JSON.stringify(teamMembers)); localStorage.setItem('activities', JSON.stringify(activities)); localStorage.setItem('notifications', JSON.stringify(notifications)); }
            function clearUserData() { localStorage.removeItem('currentUser'); localStorage.removeItem('teamMembers'); localStorage.removeItem('activities'); localStorage.removeItem('notifications'); }
            function generateSampleActivities() { const s=[{id:Date.now()-50000,icon:'fa-tasks',message:'Yousef completed "Prepare Presentation".',timestamp:new Date(Date.now()-50000).toISOString()},{id:Date.now()-120000,icon:'fa-user-plus',message:'Admin invited bassant@example.com.',timestamp:new Date(Date.now()-120000).toISOString()},{id:Date.now()-3600000,icon:'fa-file-alt',message:'Esraa uploaded "Plan v2.docx".',timestamp:new Date(Date.now()-3600000).toISOString()},{id:Date.now()-86400000,icon:'fa-project-diagram',message:'"Website Redesign" In Progress.',timestamp:new Date(Date.now()-86400000).toISOString()},{id:Date.now()-172800000,icon:'fa-calendar-check',message:'"Phase 1 Delivery" deadline approaching.',timestamp:new Date(Date.now()-172800000).toISOString()}]; return s.sort((a, b)=>new Date(b.timestamp)-new Date(a.timestamp)); }
            function generateSampleNotifications() { return[{id:Date.now()-60000,icon:'fa-comment',message:'Yousef mentioned you in Project Alpha.',timestamp:new Date(Date.now()-60000).toISOString(),read:false},{id:Date.now()-1800000,icon:'fa-calendar-alt',message:'Team meeting tomorrow at 10 AM.',timestamp:new Date(Date.now()-1800000).toISOString(),read:false},{id:Date.now()-7200000,icon:'fa-exclamation-triangle',message:'Task "Final Review" is overdue.',timestamp:new Date(Date.now()-7200000).toISOString(),read:true}]; }

            // --- UI Update Functions ---
            function updateUserUI() { const p=currentUser.name.split(' '),f=p[0]||'',l=p.slice(1).join(' ')||'';userName.textContent=currentUser.name;userEmail.textContent=currentUser.email;welcomeName.textContent=f;document.querySelector('.user-info-name').textContent=currentUser.name;const r={'admin':'Administrator','senior':'Senior','supervisor':'Supervisor','member':'Member'},t=r[currentUser.role]||'Member';userInfoRoleTitle.textContent=t;userInfoRoleTitle.className=`user-info-title ${currentUser.role==='admin'?'role-admin':''}`;document.getElementById('firstName').value=f;document.getElementById('lastName').value=l;document.getElementById('jobTitle').value=currentUser.title||'';document.getElementById('phone').value=currentUser.phone||'';document.getElementById('department').value=currentUser.department||'';document.getElementById('email').value=currentUser.email;fullNameDisplay.value=currentUser.name;document.getElementById('acc_firstName').value=f;document.getElementById('acc_lastName').value=l;document.getElementById('acc_email').value=currentUser.email;const i=currentUser.initials||(f?f[0]:'')+(l?l[0]:'');[userAvatar,profileAvatar,profileAvatarLarge].forEach(el=>{if(currentUser.avatar){el.style.backgroundImage=`url(${currentUser.avatar})`;el.textContent='';el.style.backgroundColor='';}else{el.style.backgroundImage='none';el.textContent=i.toUpperCase();el.style.backgroundColor=el===profileAvatarLarge?'var(--primary-light)':'var(--primary)';el.style.color=el===profileAvatarLarge?'var(--primary-dark)':'white';}}); }
            function applyUserPreferences() { document.body.className='';document.body.classList.add(`${currentUser.preferences?.theme||'blue'}-theme`);document.body.classList.add(currentUser.preferences?.layoutDensity||'normal');themeOptions.forEach(opt=>{opt.classList.toggle('selected',opt.dataset.theme===currentUser.preferences?.theme);});layoutDensitySelect.value=currentUser.preferences?.layoutDensity||'normal';loadSettingsFormData(); }
            function applyRBAC() { const a=currentUser.role==='admin',s=currentUser.role==='supervisor';if(dangerZoneTab){dangerZoneTab.style.display=a?'flex':'none';dangerZoneTab.classList.toggle('disabled',!a);}if(teamSettingsTab){const c=a||s;teamSettingsTab.style.display=c?'flex':'none';teamSettingsTab.classList.toggle('disabled',!c);}const d=document.getElementById('deleteAccountBtn');if(d)d.disabled=!a;if(inviteMemberForm)inviteMemberForm.style.display=(a||s)?'block':'none'; }
            function loadSettingsFormData() { currentUser.preferences=currentUser.preferences||{};currentUser.security=currentUser.security||{};currentUser.notificationPreferences=currentUser.notificationPreferences||{email:{},push:{}};currentUser.notificationPreferences.email=currentUser.notificationPreferences.email||{};currentUser.notificationPreferences.push=currentUser.notificationPreferences.push||{};document.getElementById('selectedTheme').value=currentUser.preferences.theme||'blue';layoutDensitySelect.value=currentUser.preferences.layoutDensity||'normal';document.getElementById('language').value=currentUser.preferences.language||'en';document.getElementById('dateFormat').value=currentUser.preferences.dateFormat||'dd/mm/yyyy';weekStartSelect.value=currentUser.preferences.weekStart||'sun';document.getElementById('timezone').value=currentUser.preferences.timezone||'cairo';document.getElementById('twoFactorAuth').checked=currentUser.security.twoFactorEnabled??true;currentPasswordInput.value='';newPasswordInput.value='';confirmPasswordInput.value='';currentPasswordError.style.display='none';passwordMatchError.style.display='none';document.getElementById('emailTasks').checked=currentUser.notificationPreferences.email.tasks??true;document.getElementById('emailDeadlines').checked=currentUser.notificationPreferences.email.deadlines??true;document.getElementById('emailUpdates').checked=currentUser.notificationPreferences.email.updates??false;document.getElementById('pushMessages').checked=currentUser.notificationPreferences.push.messages??true;document.getElementById('pushTeamUpdates').checked=currentUser.notificationPreferences.push.teamUpdates??false;soundNotificationsSwitch.checked=currentUser.preferences.soundNotifications??true; }
            function updateStats() { const s=currentUser.stats||{};teamMembersCount.textContent=teamMembers.length;tasksCompleted.textContent=s.tasksCompleted??0;activeProjects.textContent=s.activeProjects??0;upcomingDeadlines.textContent=s.upcomingDeadlines??0;if(currentUser.stats)currentUser.stats.teamMembers=teamMembers.length;updateTrendIndicator(teamMembersTrend,s.teamMembersTrend);updateTrendIndicator(tasksCompletedTrend,s.tasksCompletedTrend);updateTrendIndicator(activeProjectsTrend,s.activeProjectsTrend);updateTrendIndicator(upcomingDeadlinesTrend,s.upcomingDeadlinesTrend); }
            function updateTrendIndicator(el,trend){ trend=trend||'neutral';let i='fa-minus',c='trend-neutral',v=trend==='up'?15:trend==='down'?5:0,p=`${v}%`;if(trend==='up'){i='fa-arrow-up';c='trend-up';}else if(trend==='down'){i='fa-arrow-down';c='trend-down';}else{p='0%';}el.innerHTML=`<i class="fas ${i}"></i> ${p}`;el.className=`stat-trend ${c}`; }
            function updateNotificationBadge() { const u=notifications.filter(n=>!n.read).length;if(u>0){notificationBadge.textContent=u>99?'99+':u;notificationBadge.style.display='flex';}else{notificationBadge.style.display='none';}deleteAllNotificationsBtn.style.display=notifications.length>0&&(currentUser.role==='admin'||currentUser.role==='supervisor')?'inline-flex':'none'; }

            // --- Feature/Section Loading (MODIFIED) ---
            function setActiveFeature(featureId, settingsTab = null) {
                 if (featureId === 'settings') { const targetTab = settingsTab || currentSettingsTab || 'preferences'; const tabEl = document.querySelector(`.settings-tab[data-tab="${targetTab}"]`); if (!tabEl || tabEl.classList.contains('disabled') || tabEl.style.display === 'none') { console.warn(`Denied/Invalid tab: ${targetTab}`); setActiveFeature(currentFeature === 'settings' ? 'settings' : 'dashboard', 'preferences'); return; } currentSettingsTab = targetTab; }
                 currentFeature = featureId;
                 let hash = `#${featureId}`; if (featureId === 'settings' && currentSettingsTab) { hash += `-${currentSettingsTab}`; } if (window.location.hash !== hash) { history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash); }
                 menuItems.forEach(item => item.classList.remove('active')); const activeItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`); if (activeItem) activeItem.classList.add('active');
                 contentSections.forEach(section => section.classList.remove('active')); featureSectionsContainer.style.display = 'none'; featurePlaceholder.style.display = 'none';
                 const staticFeatures = { 'dashboard': dashboardContent, 'profile': profileContent, 'settings': settingsContent };
                 if (staticFeatures[featureId]) {
                     staticFeatures[featureId].classList.add('active');
                     if (featureId === 'dashboard') { updateStats(); loadActivities(); } if (featureId === 'profile') { updateUserUI(); } if (featureId === 'settings') { applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); }
                 } else {
                     featureSectionsContainer.style.display = 'block'; featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); featurePlaceholder.style.display = 'flex';
                     const readableName = featureId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); featureTitle.textContent = `Loading ${readableName}...`; featureDescription.textContent = 'Please wait...'; featureLoadingIndicator.style.display = 'block'; featureErrorMessage.style.display = 'none';
                     const htmlPath = `sections/${featureId}.html`;
                     fetch(htmlPath)
                         .then(response => { if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} for ${htmlPath}`); return response.text(); })
                         .then(html => {
                             featureSections.innerHTML = html; featureSections.classList.add('active');
                             const featureContainerElement = document.getElementById('featureSections'); // Get container AFTER inserting HTML
                             if (featureId === 'employee-scheduling') {
                                 if (typeof initializeEmployeeSchedule === 'function') {
                                     try { console.log("Calling initializeEmployeeSchedule with container:", featureContainerElement); initializeEmployeeSchedule( featureContainerElement, JSON.parse(JSON.stringify(currentUser)), JSON.parse(JSON.stringify(teamMembers)) ); } catch (initError) { console.error(`Error executing initializeEmployeeSchedule:`, initError); showFeatureError(`Error initializing ${readableName}: ${initError.message}`); }
                                 } else { console.warn(`Init func not found: initializeEmployeeSchedule`); showFeatureError(`${readableName} loaded, but setup script missing.`); }
                             } else { console.log(`Feature ${featureId} loaded. No specific JS init defined.`); if(featureErrorMessage.style.display !== 'block') { featurePlaceholder.style.display = 'none'; } }
                         })
                         .catch(error => { console.error(`Error loading feature '${featureId}':`, error); showFeatureError(`Could not load ${readableName}. ${error.message}`); });
                 }
                 backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none'; window.scrollTo(0, 0);
             }
             function showFeatureError(message) { featureTitle.textContent = 'Error'; featureDescription.textContent = message; featureLoadingIndicator.style.display = 'none'; featureErrorMessage.style.display = 'block'; featurePlaceholder.style.display = 'flex'; }
             function activateSettingsTab(tabId) { if (tabId === 'danger' && currentUser.role !== 'admin') { activateSettingsTab('preferences'); return; } currentSettingsTab = tabId; settingsTabs.forEach(t => { t.classList.remove('active'); if (!t.classList.contains('disabled') && t.dataset.tab === tabId) { t.classList.add('active'); } }); settingsPanels.forEach(p => p.classList.toggle('active', p.id === `${tabId}Panel`)); if (currentFeature === 'settings' && window.location.hash !== `#settings-${tabId}`) { history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`); } if (tabId === 'team') { loadTeamMembers(); } else if (tabId === 'account') { updateUserUI(); } else if (['preferences', 'security', 'notifications'].includes(tabId)) { loadSettingsFormData(); } }
             function handleInitialNavigation() { const hash = window.location.hash.substring(1); let featureId = 'dashboard', settingsTab = null; if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences'; } else { const valid = [...menuItems].some(item => item.dataset.feature === hash) || hash === 'profile'; if (valid) { featureId = hash; } } } setActiveFeature(featureId, settingsTab); }

            // --- Activity & Notification Loading ---
            function loadActivities(showAll = false) { activityList.innerHTML = ''; const canDel = currentUser.role === 'admin' || currentUser.role === 'supervisor'; if (activities.length === 0) { activityList.innerHTML = `<li style="text-align: center; padding: 2rem; color: var(--gray);">No activity.</li>`; viewAllActivity.style.display = 'none'; deleteAllActivity.style.display = 'none'; return; } const toShow = showAll ? activities : activities.slice().reverse().slice(0, MAX_ACTIVITIES_DISPLAYED); toShow.forEach(act => { const li = document.createElement('li'); li.className = 'activity-item'; if (act.isNew) { li.classList.add('new-activity'); delete act.isNew; setTimeout(() => { li.classList.remove('new-activity'); }, NEW_ACTIVITY_HIGHLIGHT_DURATION); } li.dataset.id = act.id; li.innerHTML = `<div class="activity-icon"><i class="fas ${act.icon || 'fa-info-circle'}"></i></div> <div class="activity-content"> <div class="activity-message">${act.message}</div> <div class="activity-time" data-timestamp="${act.timestamp}">${getTimeAgo(act.timestamp)}</div> </div> <div class="activity-actions"> ${canDel ? `<i class="fas fa-trash delete-activity" title="Delete"></i>` : ''} </div>`; if (!showAll) activityList.prepend(li); else activityList.appendChild(li); }); activityList.querySelectorAll('.delete-activity').forEach(btn => btn.addEventListener('click', handleDeleteActivityClick)); viewAllActivity.style.display = activities.length > MAX_ACTIVITIES_DISPLAYED && !showAll ? 'inline' : 'none'; deleteAllActivity.style.display = activities.length > 0 && canDel ? 'inline' : 'none'; }
            function loadNotifications() { notificationsBody.innerHTML = ''; updateNotificationBadge(); if (notifications.length === 0) { notificationsBody.innerHTML = `<div class="no-notifications-message">No notifications.</div>`; return; } const canDel = currentUser.role === 'admin' || currentUser.role === 'supervisor'; notifications.forEach(n => { const item = document.createElement('div'); item.className = `notification-list-item ${n.read ? '' : 'unread'}`; item.dataset.id = n.id; item.innerHTML = `<div class="notification-icon-wrapper"><i class="fas ${n.icon || 'fa-bell'}"></i></div> <div class="notification-content"> <div class="notification-message">${n.message}</div> <div class="notification-time">${getTimeAgo(n.timestamp)}</div> </div> ${canDel ? `<i class="fas fa-trash delete-notification" title="Delete"></i>` : ''}`; item.addEventListener('click', (e) => { if (!e.target.classList.contains('delete-notification')) markNotificationAsRead(n.id, item); }); const delBtn = item.querySelector('.delete-notification'); if (delBtn) delBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNotificationClick(n.id); }); notificationsBody.appendChild(item); }); }

            // --- Time Formatting ---
            function getTimeAgo(ts) { if (!ts) return '?'; try { const n=new Date(),d=new Date(ts); if(isNaN(d.getTime()))return'?'; const s=Math.floor((n-d)/1000); if(s<0)return 'Future'; let i=Math.floor(s/31536000); if(i>=1)return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); i=Math.floor(s/2592000); if(i>=1)return`${i}mo ago`; i=Math.floor(s/604800); if(i>=1)return`${i}w ago`; i=Math.floor(s/86400); if(i>=1)return`${i}d ago`; i=Math.floor(s/3600); if(i>=1)return`${i}h ago`; i=Math.floor(s/60); if(i>=1)return`${i}m ago`; return s<10?'Now':`${Math.floor(s)}s ago`; } catch(e){return'?';} }
            function updateActivityTimes() { activityList.querySelectorAll('.activity-time[data-timestamp]').forEach(e=>{const t=e.dataset.timestamp;if(t)e.textContent=getTimeAgo(t);}); notificationsBody.querySelectorAll('.notification-time').forEach(e=>{const i=e.closest('.notification-list-item'),d=i?.dataset.id;if(d){const n=notifications.find(x=>x.id==d);if(n?.timestamp)e.textContent=getTimeAgo(n.timestamp);}}); }
            function startActivityTimeUpdater() { if(activityIntervalId)clearInterval(activityIntervalId); updateActivityTimes(); activityIntervalId = setInterval(updateActivityTimes, UPDATE_INTERVAL); }

            // --- Team Management ---
            function loadTeamMembers() { teamList.innerHTML = ''; const c=currentUser.role==='admin'||currentUser.role==='supervisor',d=currentUser.role==='admin'; if (teamMembers.length === 0) { teamList.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--gray);">No members. Invite below.</div>`; } else { teamMembers.forEach(m => { const a=document.createElement('div'); a.className='team-member-card'; a.dataset.id=m.id; const e=(c&&m.role!=='admin'&&m.role!=='supervisor')||(d&&m.id!==currentUser.id),f=d&&m.id!==currentUser.id; let g=m.initials||m.email.substring(0,2).toUpperCase(),h=''; if(m.avatar){h=`background-image:url(${m.avatar});`;g='';} a.innerHTML=`<div class="member-avatar" style="${h}">${g}</div> <div class="member-details"> <div class="member-name">${m.name||'Unnamed'}</div> <div class="member-email">${m.email}</div> </div> <div class="member-role role-${m.role||'member'}">${(m.role||'member').charAt(0).toUpperCase()+(m.role||'member').slice(1)}</div> <div class="member-actions"> ${e?`<button class="btn btn-outline btn-sm edit-member" title="Edit"><i class="fas fa-edit"></i></button>`:''} ${f?`<button class="btn btn-danger btn-sm delete-member" title="Delete"><i class="fas fa-trash"></i></button>`:''} </div>`; teamList.appendChild(a); }); teamList.querySelectorAll('.edit-member').forEach(b=>b.addEventListener('click',handleEditMemberClick)); teamList.querySelectorAll('.delete-member').forEach(b=>b.addEventListener('click',handleDeleteMemberClick)); } updateStats(); }

            // --- Modals ---
            function showConfirmModal(cfg){ confirmTitle.textContent=cfg.title||'Confirm';confirmMessage.innerHTML=cfg.message||'Proceed?';confirmBtn.textContent=cfg.confirmText||'Confirm';cancelConfirmBtn.textContent=cfg.cancelText||'Cancel';confirmBtn.className=`btn ${cfg.confirmClass||'btn-danger'}`;confirmCallback=cfg.onConfirm||null;cancelCallback=cfg.onCancel||null;confirmModal.style.display='flex';confirmBtn.focus(); }
            function hideConfirmModal(){ confirmModal.style.display = 'none'; confirmCallback = null; cancelCallback = null; }

            // --- Action Handlers ---
            function handleProfileSave(e) { e.preventDefault(); showConfirmModal({ title:'Save Profile?', message:'Save changes?', confirmText:'Save', confirmClass:'btn-primary', onConfirm:()=>{ const f=document.getElementById('firstName').value.trim(),l=document.getElementById('lastName').value.trim(); currentUser.name=`${f} ${l}`; currentUser.initials=(f?f[0]:'')+(l?l[0]:''); currentUser.title=document.getElementById('jobTitle').value; currentUser.phone=document.getElementById('phone').value; currentUser.department=document.getElementById('department').value; saveData(); updateUserUI(); addActivity('fa-user-edit','Updated profile.'); showSuccessMessage('Profile updated!'); hideConfirmModal(); }, onCancel:hideConfirmModal }); }
            function handleProfileCancel() { const f=document.getElementById('firstName').value.trim(),l=document.getElementById('lastName').value.trim(),n=`${f} ${l}`,t=document.getElementById('jobTitle').value,p=document.getElementById('phone').value,d=document.getElementById('department').value,i=n!==currentUser.name||t!==(currentUser.title||'')||p!==(currentUser.phone||'')||d!==(currentUser.department||''); if(!i){setActiveFeature('dashboard'); return;} showConfirmModal({ title:'Discard Changes?', message:'Unsaved edits lost?', confirmText:'Discard', confirmClass:'btn-danger', onConfirm:()=>{ updateUserUI(); hideConfirmModal(); setActiveFeature('dashboard'); }, onCancel:hideConfirmModal }); }
            function handleSettingsSave(formId, panelId, successMsg) { const form = document.getElementById(formId); const saveButton = form.querySelector('button[type="submit"]'); const spinner = form.querySelector('.spinner'); const loadingText = form.querySelector('.loading-text'); const btnText = form.querySelector('.btn-text'); saveButton.disabled = true; if(spinner) spinner.style.display = 'inline-block'; if(loadingText) loadingText.style.display = 'inline'; if(btnText) btnText.style.display = 'none'; setTimeout(() => { try { let activityMessage = ''; let valuesToSave = {}; if (panelId === 'preferencesPanel') { currentUser.preferences.theme = document.getElementById('selectedTheme').value; currentUser.preferences.layoutDensity = layoutDensitySelect.value; currentUser.preferences.language = document.getElementById('language').value; currentUser.preferences.dateFormat = document.getElementById('dateFormat').value; currentUser.preferences.weekStart = weekStartSelect.value; valuesToSave = { theme: currentUser.preferences.theme, layoutDensity: currentUser.preferences.layoutDensity, language: currentUser.preferences.language, dateFormat: currentUser.preferences.dateFormat, weekStart: currentUser.preferences.weekStart }; activityMessage = 'Updated preferences settings.'; } else if (panelId === 'accountPanel') { currentUser.preferences.timezone = document.getElementById('timezone').value; valuesToSave = { timezone: currentUser.preferences.timezone }; activityMessage = 'Updated account settings.'; } else if (panelId === 'securityPanel') { currentUser.security = currentUser.security || {}; const original2FA = currentUser.security.twoFactorEnabled; currentUser.security.twoFactorEnabled = document.getElementById('twoFactorAuth').checked; const currentPass = currentPasswordInput.value; const newPass = newPasswordInput.value; const confirmPass = confirmPasswordInput.value; valuesToSave = { twoFactorEnabled: currentUser.security.twoFactorEnabled }; activityMessage = 'Updated security settings.'; currentPasswordError.style.display = 'none'; passwordMatchError.style.display = 'none'; if (newPass || confirmPass || currentPass) { if (!currentPass) { currentPasswordError.textContent = 'Current password required'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Current password missing.'); } if (currentPass !== currentUser.password) { currentPasswordError.textContent = 'Incorrect current password'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Incorrect current password.'); } if (!newPass) { passwordMatchError.textContent = 'New password empty'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password empty.'); } if (newPass.length < 8) { passwordMatchError.textContent = 'Min 8 chars'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password too short.'); } if (newPass !== confirmPass) { passwordMatchError.textContent = 'Passwords do not match'; passwordMatchError.style.display = 'block'; confirmPasswordInput.focus(); throw new Error('New passwords do not match.'); } currentUser.password = newPass; activityMessage = 'Changed password.'; valuesToSave.passwordChanged = true; currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; } else if (original2FA !== currentUser.security.twoFactorEnabled) { activityMessage = 'Updated 2FA setting.'; } } else if (panelId === 'notificationsPanel') { currentUser.notificationPreferences=currentUser.notificationPreferences||{email:{},push:{}}; currentUser.notificationPreferences.email=currentUser.notificationPreferences.email||{}; currentUser.notificationPreferences.push=currentUser.notificationPreferences.push||{}; currentUser.notificationPreferences.email.tasks=document.getElementById('emailTasks').checked; currentUser.notificationPreferences.email.deadlines=document.getElementById('emailDeadlines').checked; currentUser.notificationPreferences.email.updates=document.getElementById('emailUpdates').checked; currentUser.notificationPreferences.push.messages=document.getElementById('pushMessages').checked; currentUser.notificationPreferences.push.teamUpdates=document.getElementById('pushTeamUpdates').checked; currentUser.preferences.soundNotifications=soundNotificationsSwitch.checked; valuesToSave = { emailTasks: currentUser.notificationPreferences.email.tasks, emailDeadlines: currentUser.notificationPreferences.email.deadlines, emailUpdates: currentUser.notificationPreferences.email.updates, pushMessages: currentUser.notificationPreferences.push.messages, pushTeamUpdates: currentUser.notificationPreferences.push.teamUpdates, soundNotifications: currentUser.preferences.soundNotifications }; activityMessage = 'Updated notification settings.'; } console.log(`Saving ${panelId}. Values:`, valuesToSave); saveData(); applyUserPreferences(); if (activityMessage) { addActivity('fa-cogs', activityMessage); } showSuccessMessage(successMsg || 'Settings saved!'); } catch (error) { console.error(`Save error ${panelId}:`, error.message); if (!error.message.includes('password') && !error.message.includes('missing')) { showConfirmModal({ title: "Save Error", message: `Could not save: ${error.message}`, confirmText: "OK", confirmClass: "btn-primary", onConfirm: hideConfirmModal }); } } finally { saveButton.disabled = false; if(spinner) spinner.style.display = 'none'; if(loadingText) loadingText.style.display = 'none'; if(btnText) btnText.style.display = 'inline'; } }, SIMULATED_DELAY); }
            function handleSettingsCancel(panelId) { showConfirmModal({ title: `Discard Changes?`, message: 'Unsaved changes lost?', confirmText: 'Discard', confirmClass: 'btn-danger', onConfirm: () => { loadSettingsFormData(); applyUserPreferences(); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleInviteMember(e) { e.preventDefault(); const emailInput = document.getElementById('inviteMemberEmail'), roleSelect = document.getElementById('inviteMemberRole'); const email = emailInput.value.trim(), role = roleSelect.value; if (!email || !email.includes('@')) { alert('Valid email required.'); emailInput.focus(); return; } if (teamMembers.some(m => m.email.toLowerCase() === email.toLowerCase())) { alert('Member exists.'); emailInput.focus(); return; } if (role === 'admin' && currentUser.role !== 'admin') { alert('Only Admins can invite Admins.'); roleSelect.focus(); return; } if (currentUser.role === 'supervisor' && (role === 'admin' || role === 'supervisor')) { alert('Supervisors cannot invite Admins/Supervisors.'); roleSelect.focus(); return; } const token = `sim_${Date.now()}`; const link = `${window.location.origin}/register.html?token=${token}`; console.log('--- SIM INVITE ---', { To: email, Role: role, Link: link }); addActivity('fa-paper-plane', `${currentUser.name} invited ${email} as ${role}.`); showSuccessMessage(`Invite sent to ${email}.`); inviteMemberForm.reset(); }
            function handleEditMemberClick(e) { const card = e.target.closest('.team-member-card'), id = parseInt(card.dataset.id), m = teamMembers.find(x => x.id === id); if (!m) return; const newName = prompt("New name:", m.name || ''); let newRole = m.role; const isAdmin=currentUser.role==='admin', isSup=currentUser.role==='supervisor'; let canChange=false, allowed=''; if(isAdmin&&m.id!==currentUser.id){canChange=true; allowed='member, senior, supervisor, admin';} else if(isSup&&!['admin','supervisor'].includes(m.role)){canChange=true; allowed='member, senior';} if(canChange){ const promptRole=prompt(`New role (${allowed}):`, m.role); if(promptRole!==null){ const clean=promptRole.trim().toLowerCase(); if(allowed.split(', ').includes(clean)){newRole=clean;} else{alert('Invalid role/permission.');}}} else if(m.id!==currentUser.id){alert("No permission.");} if(newName!==null){m.name=newName.trim()||'Unnamed'; m.role=newRole; m.initials=m.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()||m.email.substring(0,2).toUpperCase(); saveData(); loadTeamMembers(); addActivity('fa-user-edit', `Updated ${m.email}.`); showSuccessMessage('Member updated.');} }
            function handleDeleteMemberClick(e) { const card = e.target.closest('.team-member-card'), id = parseInt(card.dataset.id), m = teamMembers.find(x => x.id === id); if (!m) return; if (currentUser.role !== 'admin') { alert('Only admins can delete.'); return; } if (m.id === currentUser.id) { alert("Cannot delete self."); return; } showConfirmModal({ title: 'Delete Member?', message: `Remove <strong>${m.name||m.email}</strong>?`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { const email = m.email; teamMembers = teamMembers.filter(x => x.id !== id); saveData(); loadTeamMembers(); addActivity('fa-user-minus', `Removed ${email}.`); addNotification('fa-user-minus', `Member removed: ${email}`); showSuccessMessage('Member deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleDeleteActivityClick(e) { const item = e.target.closest('.activity-item'), id = parseInt(item.dataset.id); if (!id) return; if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Restricted.'); return; } showConfirmModal({ title: 'Delete Activity?', message: `Delete this record?`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { activities = activities.filter(a => a.id !== id); saveData(); loadActivities(viewAllActivity.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); showSuccessMessage('Activity deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleDeleteAllActivities() { if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Restricted.'); return; } if (activities.length === 0) { showSuccessMessage('No activities.'); return; } showConfirmModal({ title: 'Delete ALL Activities?', message: `Delete ALL ${activities.length} records? Cannot undo.`, confirmText: 'Delete All', confirmClass: 'btn-danger', onConfirm: () => { activities = []; saveData(); loadActivities(); showSuccessMessage('All deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function markNotificationAsRead(n,i){const o=notifications.find(x=>x.id==n);if(o&&!o.read){o.read=true;saveData();i.classList.remove('unread');updateNotificationBadge();}}
            function handleMarkAllNotificationsRead(){let c=false;notifications.forEach(n=>{if(!n.read){n.read=true;c=true;}});if(c){saveData();loadNotifications();showSuccessMessage('All marked read.');}else{showSuccessMessage('No unread.');}}
            function handleDeleteNotificationClick(n){if(currentUser.role!=='admin'&&currentUser.role!=='supervisor')return;showConfirmModal({title:'Delete?',message:'Delete notification?',confirmText:'Delete',confirmClass:'btn-danger',onConfirm:()=>{notifications=notifications.filter(x=>x.id!=n);saveData();loadNotifications();showSuccessMessage('Notification deleted.');hideConfirmModal();},onCancel:hideConfirmModal});}
            function handleDeleteAllNotifications(){if(currentUser.role!=='admin'&&currentUser.role!=='supervisor')return;if(notifications.length===0){showSuccessMessage('None to delete.');return;}showConfirmModal({title:'Delete ALL?',message:`Delete ALL ${notifications.length}?`,confirmText:'Delete All',confirmClass:'btn-danger',onConfirm:()=>{notifications=[];saveData();loadNotifications();showSuccessMessage('All deleted.');hideConfirmModal();},onCancel:hideConfirmModal});}
            function handleAvatarUpload(e) { const f=e.target.files[0];if(!f)return;if(!f.type.startsWith('image/')){alert('Image only.');return;}if(f.size>2*1024*1024){alert('Max 2MB.');return;}const r=new FileReader();r.onload=function(v){const u=v.target.result;showConfirmModal({title:'Update Pic?',message:'Set as profile pic?',confirmText:'Set',confirmClass:'btn-primary',onConfirm:()=>{currentUser.avatar=u;saveData();updateUserUI();addActivity('fa-camera','Changed picture.');showSuccessMessage('Picture updated.');hideConfirmModal();},onCancel:()=>{profileAvatarInput.value=null;hideConfirmModal();}});}r.onerror=function(){alert('Read error.');}r.readAsDataURL(f); }
            function handleLogout() { showConfirmModal({ title:'Logout?', message:'Sure?', confirmText:'Logout', confirmClass:'btn-danger', onConfirm:()=>{ showSuccessMessage("Logging out..."); setTimeout(()=>{window.location.href='login.html';},500); }, onCancel:hideConfirmModal }); }

            // --- Utility Functions ---
            function addActivity(i,m){const a={id:Date.now(),icon:i,message:m,timestamp:new Date().toISOString(),isNew:true};activities.push(a);activities.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));saveData();if(currentFeature==='dashboard'){loadActivities(viewAllActivity.style.display==='none'&&activities.length>MAX_ACTIVITIES_DISPLAYED);}}
            function addNotification(i,m){const n={id:Date.now(),icon:i,message:m,timestamp:new Date().toISOString(),read:false};notifications.unshift(n);saveData();updateNotificationBadge();if(notificationsModal.style.display==='flex'){loadNotifications();}if(currentUser.preferences?.soundNotifications){playNotificationSound();}}
            function playNotificationSound(){if(notificationSound?.play){notificationSound.currentTime=0;notificationSound.play().catch(e=>{console.warn('Sound fail:',e);});}}
            function showSuccessMessage(m){successMessageText.textContent=m;successMessage.classList.add('show');setTimeout(()=>{successMessage.classList.remove('show');},3000);}
            function setupEventListeners() { menuItems.forEach(i=>i.addEventListener('click',e=>{e.preventDefault();setActiveFeature(i.dataset.feature);})); backButton.addEventListener('click',()=>setActiveFeature('dashboard')); window.addEventListener('popstate',e=>{if(e.state){setActiveFeature(e.state.feature,e.state.tab);}else{handleInitialNavigation();}}); searchInput.addEventListener('input',handleSearch); searchInput.addEventListener('focus',handleSearch); document.addEventListener('click',e=>{if(!e.target.closest('.search-bar')){searchResults.classList.remove('active');searchResults.innerHTML='';}}); userAvatar.addEventListener('click',()=>userDropdown.classList.toggle('active')); userProfileDetails.addEventListener('click',()=>userDropdown.classList.toggle('active')); profileLink.addEventListener('click',e=>{e.preventDefault();userDropdown.classList.remove('active');setActiveFeature('profile');}); settingsLink.addEventListener('click',e=>{e.preventDefault();userDropdown.classList.remove('active');setActiveFeature('settings');}); logoutLink.addEventListener('click',e=>{e.preventDefault();userDropdown.classList.remove('active');handleLogout();}); document.addEventListener('click',e=>{if(!e.target.closest('.user-profile'))userDropdown.classList.remove('active');}); notificationIcon.addEventListener('click',()=>{notificationsModal.style.display='flex';loadNotifications();}); closeNotifications.addEventListener('click',()=>notificationsModal.style.display='none'); notificationsModal.addEventListener('click',e=>{if(e.target===notificationsModal)notificationsModal.style.display='none';}); markAllReadBtn.addEventListener('click',handleMarkAllNotificationsRead); deleteAllNotificationsBtn.addEventListener('click',handleDeleteAllNotifications); viewAllActivity.addEventListener('click',()=>loadActivities(true)); deleteAllActivity.addEventListener('click',handleDeleteAllActivities); profileForm.addEventListener('submit',handleProfileSave); cancelProfileBtn.addEventListener('click',handleProfileCancel); uploadPhotoButton.addEventListener('click',()=>profileAvatarInput.click()); profileAvatarInput.addEventListener('change',handleAvatarUpload); settingsTabs.forEach(t=>t.addEventListener('click',()=>{if(!t.classList.contains('disabled')){activateSettingsTab(t.dataset.tab);}})); preferencesForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('preferencesForm','preferencesPanel','Prefs saved.');}); cancelPreferencesBtn.addEventListener('click',()=>handleSettingsCancel('preferencesPanel')); accountForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('accountForm','accountPanel','Account saved.');}); cancelAccountBtn.addEventListener('click',()=>handleSettingsCancel('accountPanel')); securityForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('securityForm','securityPanel','Security updated.');}); cancelSecurityBtn.addEventListener('click',()=>handleSettingsCancel('securityPanel')); notificationsForm.addEventListener('submit',e=>{e.preventDefault();handleSettingsSave('notificationsForm','notificationsPanel','Notify saved.');}); cancelNotificationsBtn.addEventListener('click',()=>handleSettingsCancel('notificationsPanel')); themeOptions.forEach(o=>{o.addEventListener('click',function(){const t=this.dataset.theme;document.getElementById('selectedTheme').value=t;themeOptions.forEach(opt=>opt.classList.remove('selected'));this.classList.add('selected');document.body.className='';document.body.classList.add(`${t}-theme`);document.body.classList.add(layoutDensitySelect.value||'normal');applyRBAC();});}); layoutDensitySelect.addEventListener('change',function(){const d=this.value;document.body.classList.remove('compact','normal','spacious');document.body.classList.add(d);const c=document.getElementById('selectedTheme').value||'blue';document.body.classList.add(`${c}-theme`);applyRBAC();}); inviteMemberForm.addEventListener('submit',handleInviteMember); confirmBtn.addEventListener('click',()=>{if(confirmCallback)confirmCallback();}); cancelConfirmBtn.addEventListener('click',()=>{if(cancelCallback)cancelCallback();hideConfirmModal();}); confirmModal.addEventListener('click',e=>{if(e.target===confirmModal)hideConfirmModal();}); document.addEventListener('keydown',e=>{if(e.key==='Escape'&&confirmModal.style.display==='flex'){hideConfirmModal();}});}
            function handleSearch() { const searchTerm = searchInput.value.toLowerCase().trim(); searchResults.innerHTML = ''; searchResults.classList.remove('active'); if (searchTerm.length < 2) return; const matchingUsers = teamMembers.filter(m => (m.name || '').toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm)); const matchingActivities = activities.filter(a => a.message.toLowerCase().includes(searchTerm)); searchResults.classList.add('active'); if (matchingUsers.length === 0 && matchingActivities.length === 0) { searchResults.innerHTML = `<div class="search-result-item" style="color: var(--gray);">No results found</div>`; return; } if (matchingUsers.length > 0) { const h = document.createElement('div'); h.innerHTML = '<strong>Members</strong>'; h.style.cssText='padding:.5rem 1rem .25rem;font-size:.8rem;color:var(--gray)'; searchResults.appendChild(h); matchingUsers.slice(0, 3).forEach(u => { const i = document.createElement('div'); i.className = 'search-result-item'; i.innerHTML = `<i class="fas fa-user" style="margin-right:.5rem;color:var(--primary);"></i> ${u.name} (${u.email})`; i.onclick = () => { setActiveFeature('settings', 'team'); searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(i); }); } if (matchingActivities.length > 0) { const h = document.createElement('div'); h.innerHTML = '<strong>Activities</strong>'; h.style.cssText='padding:.5rem 1rem .25rem;font-size:.8rem;color:var(--gray)'; searchResults.appendChild(h); matchingActivities.slice(0, 3).forEach(a => { const i = document.createElement('div'); i.className = 'search-result-item'; i.innerHTML = `<i class="fas ${a.icon || 'fa-info-circle'}" style="margin-right:.5rem;color:var(--secondary);"></i> ${a.message.substring(0, 50)}...`; i.onclick = () => { setActiveFeature('dashboard'); const el = activityList.querySelector(`.activity-item[data-id="${a.id}"]`); if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.transition = 'background-color .3s ease-out'; el.style.backgroundColor = 'var(--primary-light)'; setTimeout(() => { el.style.backgroundColor = ''; }, 1500); } searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(i); }); } }

            // --- Run Initialization ---
            initDashboard();
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon links (Team Management System Icon placeholder) -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981;
            --team-manager: #ef4444; /* Consider renaming if not just for managers */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --status-online: #10b981;
            --status-offline: #ef4444; /* Example */
        }

        /* Base styles ... (Keep existing base styles: *, body, etc.) */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            /* background-color defaults to theme */
            color: var(--dark);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transitions */
        }

        /* Sidebar Styles ... (Keep existing sidebar styles) */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--sidebar-divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            color: var(--white);
            font-size: 1.5rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-title {
            padding: 0.75rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.5px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
        }

        .menu-item:hover {
            background-color: var(--sidebar-hover);
            color: var(--white);
        }

        .menu-item.active {
            background-color: var(--sidebar-active);
            color: var(--white);
            border-left-color: var(--white);
        }

        .menu-item i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .menu-divider {
            height: 1px;
            background-color: var(--sidebar-divider);
            margin: 1rem 1.5rem;
        }

        /* Main Content ... (Keep existing main content styles) */
         .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
            background-color: var(--primary-light); /* Ensure main area also respects theme */
        }

        /* Top Navigation ... (Keep existing top nav styles) */
        .top-nav {
            background-color: var(--white);
            padding: var(--normal-padding) 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 90;
            transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Layout Density for Top Nav */
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }

        /* Search Bar ... (Keep existing search styles) */
        .search-bar { position: relative; width: 400px; }
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background-color: var(--white); /* Theme */
            color: var(--dark); /* Theme */
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results {
            position: absolute; top: 100%; left: 0; width: 100%;
            background-color: var(--white); /* Theme */
            border: 1px solid var(--light-gray); border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none;
            max-height: 300px; overflow-y: auto;
        }
        .search-results.active { display: block; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--dark); /* Theme */ }
        .search-result-item:hover { background-color: var(--primary-light); }


        /* User Menu ... (Keep existing user menu styles) */
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.2rem; /* Slightly larger */ }
        .notification-badge {
            position: absolute; top: -5px; right: -8px; background-color: var(--danger);
            color: white; border-radius: 50%; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 600;
        }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-weight: 600; cursor: pointer; background-size: cover; background-position: center;
        }
        .user-details { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; } /* Group name and status */
        .user-name { font-weight: 500; color: var(--dark); /* Theme */ }
        .user-status { font-size: 0.8rem; color: var(--status-online); font-weight: 500; } /* Added status */
        .user-dropdown {
            position: absolute; top: calc(100% + 5px); right: 0; /* Add spacing */
            background-color: var(--white); /* Theme */
            border: 1px solid var(--light-gray); border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Softer shadow */
            width: 200px; z-index: 100; display: none;
            overflow: hidden; /* Ensure border radius applies */
        }
        .user-dropdown.active { display: block; }
        .dropdown-item {
            padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem;
            color: var(--dark); /* Theme */
            text-decoration: none; transition: background-color 0.2s;
        }
        .dropdown-item:hover { background-color: var(--light); /* Theme */ }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); } /* Theme */

        /* Content Area ... (Keep existing content area styles) */
         .content-area {
            padding: 2rem;
            min-height: calc(100vh - 70px); /* Adjust if top nav height changes */
            transition: padding 0.3s ease;
        }
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }

        /* Welcome Section ... (Keep existing welcome styles) */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); /* Gradient background */
            color: var(--white); padding: 2rem; border-radius: 12px; /* More rounded */
            margin-bottom: 2rem; box-shadow: 0 6px 12px rgba(37, 99, 235, 0.2); /* Enhanced shadow */
            transition: padding 0.3s ease, margin-bottom 0.3s ease;
        }
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar {
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center;
            position: relative; cursor: pointer; border: 3px solid var(--white); /* Add border */
        }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .avatar-upload {
            position: absolute; bottom: 0; right: 0; background-color: var(--white);
            color: var(--primary); width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
            border: 2px solid var(--primary); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        body.compact .avatar-upload { width: 24px; height: 24px; font-size: 0.6rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; }
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; /* color: var(--team-manager); remove specific color? */ font-weight: 600; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; }
        .user-info-email i { color: rgba(255,255,255,0.8); } /* Adjust icon color */

        /* Stats Section ... (Keep existing stats styles) */
        .stats-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
            transition: gap 0.3s ease, margin-bottom 0.3s ease;
        }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background-color: var(--white); /* Theme */
            border-radius: 8px; padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Softer shadow */
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative; overflow: hidden; border: 1px solid var(--light-gray); /* Add subtle border */
        }
        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07); }
        .stat-card::before { /* Top border accent */
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary)); /* Example gradient */
        }
        .stat-title {
            font-size: 0.9rem; color: var(--gray); /* Theme */
            margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;
            transition: font-size 0.3s ease;
        }
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { color: var(--primary); }
        .stat-value {
            font-size: 1.75rem; font-weight: 700; color: var(--dark); /* Theme */
            display: flex; align-items: baseline; /* Align text better */ justify-content: space-between;
            transition: font-size 0.3s ease;
        }
        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.85rem; font-weight: 500; } /* Adjusted size */
        body.compact .stat-trend { font-size: 0.75rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .stat-trend i { margin-right: 0.25rem; font-size: 0.75rem; } /* Trend icon size */

        /* Activity Section ... (Keep existing activity styles, adjusted time) */
        .activity-section {
            background-color: var(--white); /* Theme */
            border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); padding: 1.5rem;
            transition: padding 0.3s ease, background-color 0.3s ease;
            border: 1px solid var(--light-gray); /* Theme */
        }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
            transition: margin-bottom 0.3s ease;
        }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); /* Theme */ display: flex; align-items: center; gap: 0.5rem; }
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { /* Ensure it stays next to title */
            display: inline-flex; align-items: center; background-color: var(--danger); color: white;
            padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;
            /* margin-left: 0.5rem; Removed margin, rely on gap in section-title */
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .view-all, .delete-all { /* Common styles */
            font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s;
            padding: 0.5rem; border-radius: 4px; font-size: 0.85rem;
        }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); margin-left: 0.5rem; } /* Reduced margin */
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; margin-top: 1rem; /* Add space */ }
        .activity-item {
            display: flex; padding: 1rem 0.5rem; /* Adjusted padding */ border-bottom: 1px solid var(--light-gray); /* Theme */
            align-items: flex-start; /* Align icon top */ transition: background-color 0.3s; gap: 1rem; /* Added gap */
        }
        body.compact .activity-item { padding: 0.75rem 0.25rem; }
        body.spacious .activity-item { padding: 1.25rem 0.75rem; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.05); animation: highlight 2s; }
        @keyframes highlight { 0% { background-color: rgba(37, 99, 235, 0.2); } 100% { background-color: rgba(37, 99, 235, 0.05); } }
        .activity-icon {
            width: 36px; height: 36px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary); display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; /* margin-right: 1rem; Removed, use gap */
        }
        body.compact .activity-icon { width: 32px; height: 32px; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--dark); line-height: 1.4; /* Improve readability */ }
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); /* Theme */ margin-top: 0.25rem; } /* Add margin */
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; align-items: center; } /* Align items */
        .delete-activity {
            color: var(--danger); cursor: pointer; opacity: 0.7; /* Subtle visibility */
            transition: opacity 0.2s, background-color 0.2s; padding: 0.4rem; /* Make clickable */
            border-radius: 4px; font-size: 0.9rem;
        }
        .delete-activity:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }


        /* Profile Content ... (Keep existing profile styles) */
        .profile-content {
            display: none; background-color: var(--white); /* Theme */ border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); padding: 2rem; border: 1px solid var(--light-gray); /* Theme */
            transition: padding 0.3s ease, background-color 0.3s ease;
        }
        body.compact .profile-content { padding: 1rem; }
        body.spacious .profile-content { padding: 3rem; }
        .profile-content.active { display: block; }
        .profile-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;
            border-bottom: 1px solid var(--light-gray); padding-bottom: 1rem; /* Add divider */
            transition: margin-bottom 0.3s ease;
        }
        body.compact .profile-header { margin-bottom: 1.5rem; }
        body.spacious .profile-header { margin-bottom: 3rem; }
        .profile-title { font-size: 1.5rem; font-weight: 600; color: var(--dark); /* Theme */ }
        body.compact .profile-title { font-size: 1.25rem; }
        .profile-form {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
            transition: gap 0.3s ease;
        }
        body.compact .profile-form { gap: 1rem; }
        body.spacious .profile-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); /* Theme */ }
        body.compact .form-group label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); /* Theme */
            border-radius: 6px; font-size: 1rem; background-color: var(--white); /* Theme */ color: var(--dark); /* Theme */
            transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease;
        }
        body.compact .form-control { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control { padding: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); opacity: 0.7; cursor: not-allowed; } /* Readonly style */
        .form-actions {
            grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;
            transition: margin-top 0.3s ease;
        }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }

        /* Buttons ... (Keep existing button styles) */
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; /* Center content */ gap: 0.5rem;
        }
        body.compact .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn { padding: 1rem 2rem; }
        .btn i { line-height: 1; /* Fix icon alignment */ }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #0d9f6e; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; } /* Small button variant */

        /* Settings Content ... (Keep existing settings styles, add placeholders) */
        .settings-content {
            display: none; background-color: var(--white); /* Theme */ border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); padding: 2rem; border: 1px solid var(--light-gray); /* Theme */
            transition: padding 0.3s ease, background-color 0.3s ease;
        }
        body.compact .settings-content { padding: 1rem; }
        body.spacious .settings-content { padding: 3rem; }
        .settings-content.active { display: block; }
        .settings-tabs {
            display: flex; border-bottom: 1px solid var(--light-gray); /* Theme */ margin-bottom: 2rem;
            transition: margin-bottom 0.3s ease;
        }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab {
            padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; /* Thicker active border */
            font-weight: 500; color: var(--gray); /* Theme */ transition: all 0.2s; margin-bottom: -1px; /* Align with border */
        }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; /* Emphasize active */ }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: panelFadeIn 0.5s ease; } /* Add fade-in */
        @keyframes panelFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-panel h4 { /* Section titles within panels */
             font-size: 1.1rem; color: var(--primary-dark); margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--light-gray);
        }
        .settings-panel h4:first-child { margin-top: 0; }

        /* Switch Component ... (Keep existing switch styles) */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; } /* Adjust for compact */
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .switch-label { margin-left: 0.75rem; color: var(--dark); } /* Label for switch */

        /* Team Management ... (Keep existing team management styles) */
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        .team-member-card {
            display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); /* Theme */
            border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); /* Theme */
        }
        body.compact .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-left: 3px solid var(--primary); /* Add hover accent */ }
        .member-avatar {
            width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); /* Theme */
            margin-right: 1rem; display: flex; align-items: center; justify-content: center;
            font-weight: 600; background-size: cover; background-position: center; color: var(--dark); /* Theme */
        }
        body.compact .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        .member-details { flex: 1; }
        .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--dark); /* Theme */ }
        body.compact .member-name { font-size: 0.9rem; }
        .member-email { font-size: 0.9rem; color: var(--gray); /* Theme */ }
        body.compact .member-email { font-size: 0.8rem; }
        .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin-left: auto; /* Push to right */ margin-right: 1rem; /* Space before actions */ }
        body.compact .member-role { font-size: 0.7rem; }
        .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .role-senior { background-color: rgba(37, 99, 235, 0.1); color: var(--primary); } /* Adjusted color */
        .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .role-member { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .member-actions { display: flex; gap: 0.5rem; }
        .add-member-form {
            margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); /* Theme */
            border-radius: 8px; background-color: var(--light); /* Theme */
            transition: margin-top 0.3s ease, padding 0.3s ease;
        }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .add-member-form h4 { margin-bottom: 1rem; color: var(--dark); /* Theme */ }

        /* Theme Classes & Theme Specific Adjustments ... (Keep existing themes) */
        body.light-theme {
            --primary-light: #f8fafc;
            --light: #ffffff;
            --white: #ffffff;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --sidebar-bg: #1e3a8a; /* Keep sidebar dark or adjust */
            --sidebar-text: rgba(255,255,255,0.9);
             background-color: var(--primary-light); /* Body background */
        }

        body.dark-theme {
            --primary: #3b82f6; /* Lighter blue for dark */
            --primary-dark: #60a5fa;
            --primary-light: #1e293b;
            --secondary: #10b981;
            --danger: #f87171; /* Lighter red */
            --warning: #fbbf24; /* Lighter yellow */
            --dark: #f1f5f9; /* Text color */
            --light: #334155; /* Card backgrounds */
            --gray: #94a3b8; /* Muted text */
            --light-gray: #475569; /* Borders */
            --white: #1e293b; /* Base card background */
            --sidebar-bg: #0f172a; /* Darker sidebar */
            --sidebar-text: rgba(226, 232, 240, 0.9); /* Lighter text */
            --sidebar-hover: rgba(255,255,255,0.05);
            --sidebar-active: rgba(255,255,255,0.1);
            --sidebar-divider: rgba(255,255,255,0.1);
            background-color: #0f172a; /* Body background */
        }
        /* Add more dark theme specific overrides if needed */
         body.dark-theme .stat-card::before { background: linear-gradient(90deg, var(--primary), var(--secondary));}
         body.dark-theme .form-control[readonly] { background-color: #334155; color: var(--gray); }

        body.blue-theme {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --light: #eff6ff; /* Lighter background for cards */
            --white: #ffffff; /* Card background */
            --dark: #1e293b; /* Text */
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --sidebar-bg: #1e3a8a; /* Keep sidebar consistent */
            --sidebar-text: rgba(255,255,255,0.9);
            background-color: #dbeafe; /* Body background */
        }

        /* Notifications Modal ... (Keep existing notifications styles) */
        .notifications-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end;
        }
        .notifications-container {
            width: 400px; max-width: 100%; background-color: var(--white); /* Theme */
            height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; /* Column layout */
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header {
            padding: 1.5rem; border-bottom: 1px solid var(--light-gray); /* Theme */
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--primary); color: white; flex-shrink: 0; /* Prevent shrinking */
        }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; line-height: 1; }
        .notifications-body { flex-grow: 1; overflow-y: auto; } /* Scrollable body */
        .notification-item {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--light-gray); /* Theme */
            transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start;
        }
        .notification-item:hover { background-color: var(--light); /* Theme */ }
        .notification-item.unread { background-color: rgba(37, 99, 235, 0.05); font-weight: 500; } /* Subtle indication */
        .notification-icon-wrapper {
            width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .notification-content { flex: 1; }
        .notification-message { margin-bottom: 0.25rem; color: var(--dark); /* Theme */ line-height: 1.4; }
        .notification-time { font-size: 0.8rem; color: var(--gray); /* Theme */ }
        .notification-actions { margin-left: auto; } /* Placeholder for actions */
        .delete-notification { /* Style like activity delete */
             color: var(--danger); cursor: pointer; opacity: 0.7;
             transition: opacity 0.2s, background-color 0.2s; padding: 0.4rem;
             border-radius: 4px; font-size: 0.9rem; background: none; border: none;
        }
        .delete-notification:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }
        .notifications-footer { /* Footer for buttons */
            padding: 1rem 1.5rem; border-top: 1px solid var(--light-gray); /* Theme */
            display: flex; justify-content: space-between; background-color: var(--light); /* Theme */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .no-notifications-message { /* Style for empty state */
            text-align: center; padding: 3rem 1rem; color: var(--gray); /* Theme */ font-size: 0.9rem; line-height: 1.5;
        }

        /* Confirm Modal ... (Keep existing confirm modal styles) */
        .confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */ z-index: 1100; display: none;
            justify-content: center; align-items: center; padding: 1rem; /* Padding for small screens */
        }
        .confirm-container {
            background-color: var(--white); /* Theme */ border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 450px; max-width: 95%; padding: 2rem; /* More padding */
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: var(--dark); /* Theme */ border-bottom: 1px solid var(--light-gray); padding-bottom: 0.75rem; }
        .confirm-title.danger { color: var(--danger); } /* Optional class for danger actions */
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.6; color: var(--gray); /* Theme */ font-size: 1rem; }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; }

        /* Success Message ... (Keep existing success message styles) */
        .success-message {
            position: fixed; top: 20px; right: 20px; background-color: var(--success);
            color: white; padding: 1rem 1.5rem; border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; align-items: center;
            gap: 0.75rem; z-index: 1200; transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
        }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }

        /* Responsive Design ... (Keep existing responsive styles) */
         @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); /* Add shadow when open */ }
             .sidebar.active { transform: translateX(0); }
             .main-content { margin-left: 0; }
             .search-bar { width: 250px; }
             .top-nav { padding: var(--normal-padding) 1.5rem; } /* Adjust padding */
             body.compact .top-nav { padding: var(--compact-padding) 1rem; }
             body.spacious .top-nav { padding: var(--spacious-padding) 1.5rem; }
         }

         @media (max-width: 768px) {
             .top-nav { flex-direction: column; align-items: stretch; /* Stretch items */ gap: 1rem; padding: 1rem; }
             .search-bar { width: 100%; }
             .user-menu { width: 100%; justify-content: space-between; }
             .content-area { padding: 1.5rem; }
             body.compact .content-area { padding: 1rem; }
             body.spacious .content-area { padding: 2rem; } /* Adjust spacious on mobile */
             .profile-form { grid-template-columns: 1fr; }
             .form-actions { grid-column: span 1; }
             .user-info { flex-direction: column; text-align: center; }
             .user-info-avatar { margin-bottom: 1rem; }
             .stats-section { grid-template-columns: 1fr; }
             .settings-tabs { overflow-x: auto; /* Allow horizontal scroll */ white-space: nowrap; justify-content: flex-start; }
             .settings-tab { flex-shrink: 0; } /* Prevent shrinking */
             .confirm-container { width: 90%; padding: 1.5rem; }
             .notifications-container { width: 90%; max-width: 350px; } /* Adjust notifications width */
         }

        /* Back button ... (Keep existing back button styles) */
        .back-button {
            display: inline-flex; align-items: center; gap: 0.5rem; color: var(--primary);
            font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; /* More space */
            padding: 0.5rem 1rem; border-radius: 6px; transition: background-color 0.2s;
            background: none; border: 1px solid transparent; /* Prepare for hover */
        }
        .back-button:hover { background-color: var(--primary-light); /* Theme */ border-color: var(--primary); }
        .back-button i { font-size: 0.9rem; }

        /* Notification sound (hidden) */
        #notificationSound { display: none; }

        /* Hidden class */
        .d-none { display: none !important; }

        /* Connection status (Sidebar) ... (Keep existing styles) */
        .connection-status {
            padding: 0.75rem 1.5rem; margin-top: auto; /* Push to bottom */ display: flex; align-items: center;
            gap: 0.5rem; color: rgba(255,255,255,0.7); font-size: 0.85rem; border-top: 1px solid var(--sidebar-divider);
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background-color: var(--success);
            animation: pulseStatus 2s infinite ease-in-out;
        }
        @keyframes pulseStatus { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Admin message styling (Example) */
        .admin-message {
            background-color: rgba(239, 68, 68, 0.05); border-left: 4px solid var(--danger);
            padding: 1rem; margin: 1.5rem 0; border-radius: 0 4px 4px 0;
        }
        .admin-message p { margin: 0; color: var(--danger); font-weight: 500; }

        /* Password error message */
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; font-weight: 500; }

        /* Loading spinner */
        .spinner {
            width: 18px; height: 18px; /* Smaller spinner */
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite; display: none;
        }
        .btn-primary .spinner { border-top-color: white; } /* Ensure contrast */
        .btn-outline .spinner { border: 2px solid rgba(var(--primary-rgb, 37, 99, 235), 0.3); border-top-color: var(--primary); } /* Spinner for outline button */
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Loading text */
        .loading-text { display: none; font-size: 0.9rem; /* color: var(--gray); */ margin-left: 0.5rem; } /* Use button text color */

        /* Helper class for settings section */
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--light-gray); }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { color: var(--dark); font-weight: 500; }
        .setting-description { font-size: 0.85rem; color: var(--gray); margin-top: 0.25rem; }

         /* Theme Option Styling */
        .theme-options-container { display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .theme-option { text-align: center; cursor: pointer; }
        .theme-preview {
            width: 60px; height: 40px; border: 2px solid var(--light-gray);
            border-radius: 6px; margin-bottom: 0.5rem; position: relative; overflow: hidden;
             transition: border-color 0.2s;
        }
         .theme-option.active .theme-preview { border-color: var(--primary); border-width: 3px; }
        .theme-preview span { display: block; height: 100%; } /* For color blocks */
        .theme-option span:not(.theme-preview span) { font-size: 0.85rem; color: var(--dark); }

        /* Placeholder for future settings */
        .placeholder-setting { color: var(--gray); font-style: italic; }

        /* Feature Content Area */
        #featureSections h2 { color: var(--dark); margin-bottom: 1rem; }
        #featureSections p { color: var(--gray); line-height: 1.6; }

    </style>
</head>
<body class="blue-theme"> {/* Default theme */}
    <!-- Notification sound (hidden) -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Success message -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <span id="successMessageText">Action completed successfully!</span>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                {/* Favicon image used here */}
                <img src="https://img.icons8.com/fluency/48/000000/group-task.png" alt="TeamFlow Logo" width="32" height="32">
                <span>TeamFlow</span>
            </div>
            {/* Add sidebar toggle button if needed */}
        </div>

        <div class="sidebar-menu" style="display: flex; flex-direction: column; height: calc(100% - 80px);"> {/* Adjust height based on header */}
            <div style="flex-grow: 1; overflow-y: auto;"> {/* Scrollable menu area */}
                <div class="menu-title">Main Menu</div>
                <a href="#dashboard" class="menu-item active" data-feature="dashboard">
                    <i class="fas fa-tachometer-alt fa-fw"></i> {/* Use fa-fw for fixed width */}
                    <span>Dashboard</span>
                </a>
                <a href="#project-tracking" class="menu-item" data-feature="project-tracking">
                    <i class="fas fa-project-diagram fa-fw"></i>
                    <span>Projects</span>
                </a>
                <a href="#task-management" class="menu-item" data-feature="task-management">
                    <i class="fas fa-tasks fa-fw"></i>
                    <span>Tasks</span>
                </a>
                 <a href="#team-calendar" class="menu-item" data-feature="team-calendar">
                    <i class="fas fa-calendar-alt fa-fw"></i>
                    <span>Calendar</span>
                </a>
                <a href="#file-sharing" class="menu-item" data-feature="file-sharing">
                    <i class="fas fa-file-upload fa-fw"></i>
                    <span>Files</span>
                </a>

                <div class="menu-divider"></div>
                <div class="menu-title">Management</div>
                 <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling">
                    <i class="fas fa-users fa-fw"></i>
                    <span>Team</span>
                </a>
                <a href="#data-management" class="menu-item" data-feature="data-management">
                    <i class="fas fa-database fa-fw"></i>
                    <span>Data</span>
                </a>
                 <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking">
                    <i class="fas fa-clock fa-fw"></i>
                    <span>Deadlines</span>
                </a>
                <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub">
                    <i class="fas fa-lightbulb fa-fw"></i>
                    <span>Innovation</span>
                </a>

                 <div class="menu-divider"></div>
                 <a href="#settings" class="menu-item" data-feature="settings">
                    <i class="fas fa-cog fa-fw"></i>
                    <span>Settings</span>
                </a>
            </div>

            {/* Connection status at the bottom */}
            <div class="connection-status">
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" placeholder="Search..." id="searchInput">
                <div class="search-results" id="searchResults"></div>
            </div>

            <div class="user-menu">
                <div class="notification-icon" id="notificationIcon" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" style="display: none;">0</span> {/* Hidden by default */}
                </div>

                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-details" id="userDetails">
                        <span class="user-name" id="userName">Mohamed Elmenisy</span>
                        <span class="user-status">â€¢ Connected</span> {/* Added Status */}
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#profile" class="dropdown-item" id="profileLink">
                            <i class="fas fa-user fa-fw"></i>
                            <span>Profile</span>
                        </a>
                        <a href="#settings" class="dropdown-item" id="settingsLink">
                            <i class="fas fa-cog fa-fw"></i>
                            <span>Settings</span>
                        </a>
                         <hr style="border: none; border-top: 1px solid var(--light-gray); margin: 0.5rem 0;">
                        <a href="#" class="dropdown-item" id="logoutLink"> {/* Changed href to # initially */}
                            <i class="fas fa-sign-out-alt fa-fw"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Back button (hidden by default) -->
            <button class="back-button" id="backButton" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </button>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="page-content">
                <!-- Welcome Section -->
                <div class="welcome-section">
                    <h2 class="welcome-title">Welcome back, <span id="welcomeName">Mohamed</span>!</h2>
                    <p>Here's a quick overview of your team's activity.</p>
                    <div class="user-info">
                        <div class="user-info-avatar" id="profileAvatar">ME</div>
                        <div class="user-info-details">
                            <div class="user-info-name">Mohamed Elmenisy</div>
                            <div class="user-info-title" id="userRoleTitle">Administrator</div>
                            <div class="user-info-email">
                                <i class="fas fa-envelope"></i>
                                <span id="userEmail">m.elsayed@thechefz.co</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-users"></i>Team Members</div>
                        <div class="stat-value">
                            <span id="teamMembersCount">0</span>
                            <span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> 0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-check-circle"></i>Tasks Completed (Week)</div>
                        <div class="stat-value">
                            <span id="tasksCompleted">0</span>
                            <span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> 0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-project-diagram"></i>Active Projects</div>
                        <div class="stat-value">
                            <span id="activeProjects">0</span>
                             <span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> 0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-calendar-times"></i>Overdue Tasks</div>
                        <div class="stat-value">
                            <span id="upcomingDeadlines">0</span> {/* Renamed ID logically */}
                            <span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> 0%</span>
                        </div>
                    </div>
                </div>

                <!-- Activity Section -->
                <div class="activity-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            Recent Activity
                            <span class="live-badge">LIVE</span>
                        </h3>
                        <div>
                            {/* Buttons now managed by JS based on activity count */}
                            <button class="view-all" id="viewAllActivity" style="display: none;">Show All</button>
                            <button class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</button>
                        </div>
                    </div>
                    <ul class="activity-list" id="activityList">
                        <li class="no-activities-message" style="text-align: center; padding: 2rem; color: var(--gray);">
                            Loading activities...
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content page-content" id="profileContent" style="display: none;">
                <div class="profile-header">
                    <h2 class="profile-title">Profile Settings</h2>
                </div>
                <form class="profile-form" id="profileForm">
                     <div style="grid-column: span 2; display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem;"> {/* Avatar group */}
                        <div class="user-info-avatar" id="profileAvatarLarge" style="width: 100px; height: 100px; font-size: 2rem;">
                            <div class="avatar-upload" id="avatarUploadBtn" title="Change picture">
                                <i class="fas fa-camera"></i>
                                <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('profileAvatarInput').click();">Upload Picture</button>
                            <p class="setting-description" style="margin-top: 0.5rem;">PNG, JPG, GIF up to 2MB.</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" class="form-control" value="Mohamed" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" class="form-control" value="Elmenisy" required>
                    </div>
                    <div class="form-group">
                        <label for="jobTitle">Job Title</label>
                        <input type="text" id="jobTitle" class="form-control" value="Administrator">
                    </div>
                     <div class="form-group">
                        <label for="department">Department</label>
                        <input type="text" id="department" class="form-control" value="Management">
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" class="form-control" value="m.elsayed@thechefz.co" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number (Optional)</label>
                        <input type="tel" id="phone" class="form-control" placeholder="+1 123 456 7890">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span>Save Changes</span>
                             <div class="spinner" id="profileSpinner"></div>
                             <span class="loading-text" id="profileLoadingText">Saving...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Settings Content -->
            <div class="settings-content page-content" id="settingsContent" style="display: none;">
                 <div class="profile-header"> {/* Reusing profile header style */}
                    <h2 class="profile-title">System Settings</h2>
                </div>
                <div class="settings-tabs">
                    <div class="settings-tab active" data-tab="preferences">Preferences</div>
                    <div class="settings-tab" data-tab="account">Account</div>
                    <div class="settings-tab" data-tab="security">Security</div>
                    <div class="settings-tab" data-tab="notifications">Notifications</div>
                    <div class="settings-tab" data-tab="team">Team Management</div>
                    <div class="settings-tab" data-tab="integrations">Integrations</div>
                    <div class="settings-tab" data-tab="danger">Danger Zone</div>
                </div>

                {/* Preferences Panel */}
                <div class="settings-panel active" id="preferencesPanel">
                    <form class="profile-form" id="preferencesForm">
                         <h4>Appearance</h4>
                         <div class="form-group" style="grid-column: span 2;">
                            <label>Theme Color</label>
                            <div class="theme-options-container">
                                <div class="theme-option" data-theme="blue" title="Default Blue">
                                    <div class="theme-preview" style="background-color: #dbeafe; border-color: #2563eb;"></div>
                                    <span>Blue</span>
                                </div>
                                <div class="theme-option" data-theme="light" title="Light Mode">
                                    <div class="theme-preview" style="background-color: #f8fafc; border-color: #e2e8f0;"></div>
                                    <span>Light</span>
                                </div>
                                <div class="theme-option" data-theme="dark" title="Dark Mode">
                                    <div class="theme-preview" style="background-color: #1e293b; border-color: #334155;"></div>
                                    <span>Dark</span>
                                </div>
                                {/* Add more themes here */}
                            </div>
                            <input type="hidden" id="selectedTheme" value="blue">
                        </div>

                         <div class="form-group" style="grid-column: span 2;">
                            <label for="layoutDensity">Layout Density</label>
                             <select id="layoutDensity" class="form-control">
                                <option value="compact">Compact</option>
                                <option value="normal">Normal</option>
                                <option value="spacious">Spacious</option>
                            </select>
                            <p class="setting-description">Adjust the spacing and size of UI elements.</p>
                         </div>

                         <h4>Regional Settings</h4>
                         <div class="form-group">
                            <label for="language">Language</label>
                            <select id="language" class="form-control">
                                <option value="en">English</option>
                                <option value="ar" disabled>Arabic (Coming Soon)</option>
                                {/* Add other languages */}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select id="timezone" class="form-control">
                                <option value="utc">UTC</option>
                                <option value="cairo">Cairo (UTC+2)</option>
                                {/* Add other timezones */}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFormat">Date Format</label>
                            <select id="dateFormat" class="form-control">
                                <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label for="weekStart">Start Week On</label>
                             <select id="weekStart" class="form-control">
                                <option value="sun">Sunday</option>
                                <option value="mon">Monday</option>
                            </select>
                         </div>

                         <h4>Other Preferences</h4>
                         <div class="form-group" style="grid-column: span 2;">
                             <label for="defaultHomepage">Default Homepage</label>
                             <select id="defaultHomepage" class="form-control">
                                <option value="dashboard">Dashboard</option>
                                <option value="tasks">My Tasks</option>
                                <option value="calendar">Calendar</option>
                                {/* Add more options */}
                            </select>
                            <p class="setting-description">Choose the page you see first after logging in.</p>
                         </div>


                         <div class="form-actions">
                            <button type="button" class="btn btn-outline" id="cancelPreferencesBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="savePreferencesBtn">
                                <span>Save Preferences</span>
                                <div class="spinner" id="preferencesSpinner"></div>
                                <span class="loading-text" id="preferencesLoadingText">Saving...</span>
                            </button>
                        </div>
                    </form>
                </div>

                {/* Account Panel (Example - Can be merged or kept separate) */}
                <div class="settings-panel" id="accountPanel">
                     <form id="accountForm">
                        <h4>Basic Account Info</h4>
                         <p class="setting-description" style="margin-bottom: 1rem;">Your basic account information is managed in the <a href="#profile" id="linkToProfile">Profile</a> section.</p>
                        {/* Link to profile or include some basic info here */}
                         <div class="form-group">
                             <label>Email Address</label>
                             <input type="email" class="form-control" value="m.elsayed@thechefz.co" readonly disabled>
                         </div>
                         <div class="form-group">
                             <label>Current Role</label>
                             <input type="text" class="form-control" value="Administrator" readonly disabled>
                         </div>

                        {/* Add Export Data, etc. here if needed */}
                         {/*
                         <div class="form-actions">
                            <button type="button" class="btn btn-outline" id="cancelAccountBtn">Reset Changes</button>
                            <button type="submit" class="btn btn-primary" id="saveAccountBtn">
                                <span>Save Account Settings</span>
                                <div class="spinner" id="accountSpinner"></div>
                                <span class="loading-text" id="accountLoadingText">Saving...</span>
                            </button>
                        </div>
                        */}
                    </form>
                </div>

                 {/* Security Panel */}
                <div class="settings-panel" id="securityPanel">
                    <form class="profile-form" id="securityForm">
                        <h4>Password Management</h4>
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" class="form-control" autocomplete="current-password" required>
                            <div class="password-error" id="currentPasswordError">Current password is incorrect.</div>
                        </div>
                         <div class="form-group"></div> {/* Spacer */}
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" class="form-control" autocomplete="new-password" required minlength="8">
                             <p class="setting-description">Must be at least 8 characters long.</p>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="form-control" autocomplete="new-password" required>
                            <div class="password-error" id="passwordMatchError">Passwords do not match.</div>
                        </div>
                        <div class="form-actions" style="grid-column: span 2;">
                             <button type="button" class="btn btn-outline" id="cancelSecurityPasswordBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveSecurityBtn">
                                <span>Update Password</span>
                                <div class="spinner" id="securitySpinner"></div>
                                <span class="loading-text" id="securityLoadingText">Updating...</span>
                            </button>
                        </div>

                         <h4>Authentication Methods</h4>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                             <div>
                                <span class="setting-label">Two-Factor Authentication (2FA)</span>
                                <p class="setting-description">Add an extra layer of security to your account.</p>
                             </div>
                            <label class="switch">
                                <input type="checkbox" id="twoFactorAuth" disabled> {/* Disabled for demo */}
                                <span class="slider round"></span>
                            </label>
                         </div>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                            <div>
                                <span class="setting-label">Single Sign-On (SSO)</span>
                                <p class="setting-description">Requires organizational setup.</p>
                             </div>
                             <span class="placeholder-setting">Not Configured</span>
                         </div>
                    </form>
                </div>

                {/* Notifications Panel */}
                <div class="settings-panel" id="notificationsPanel">
                    <form class="profile-form" id="notificationsForm">
                         <h4>Email Notifications</h4>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                            <span class="setting-label">Task Assignments & Updates</span>
                            <label class="switch">
                                <input type="checkbox" id="emailTasks">
                                <span class="slider round"></span>
                            </label>
                         </div>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                             <span class="setting-label">Deadline Reminders</span>
                             <label class="switch">
                                <input type="checkbox" id="emailDeadlines">
                                <span class="slider round"></span>
                            </label>
                         </div>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                             <span class="setting-label">Project Updates & Comments</span>
                            <label class="switch">
                                <input type="checkbox" id="emailProjectUpdates">
                                <span class="slider round"></span>
                            </label>
                         </div>
                        <div class="form-group setting-item" style="grid-column: span 2;">
                             <span class="setting-label">System & Team Announcements</span>
                            <label class="switch">
                                <input type="checkbox" id="emailUpdates">
                                <span class="slider round"></span>
                            </label>
                         </div>


                        <h4>Browser Push Notifications</h4>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                            <span class="setting-label">New Messages & Mentions</span>
                            <label class="switch">
                                <input type="checkbox" id="pushMessages">
                                <span class="slider round"></span>
                            </label>
                         </div>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                            <span class="setting-label">Urgent Task Updates</span>
                             <label class="switch">
                                <input type="checkbox" id="pushTasks">
                                <span class="slider round"></span>
                            </label>
                         </div>
                         <div class="form-group setting-item" style="grid-column: span 2;">
                            <span class="setting-label">Team Activity</span>
                             <label class="switch">
                                <input type="checkbox" id="pushTeamUpdates">
                                <span class="slider round"></span>
                            </label>
                         </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" id="cancelNotificationsBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveNotificationsBtn">
                                <span>Save Notifications</span>
                                <div class="spinner" id="notificationsSpinner"></div>
                                <span class="loading-text" id="notificationsLoadingText">Saving...</span>
                            </button>
                        </div>
                    </form>
                </div>

                 {/* Team Management Panel */}
                 <div class="settings-panel" id="teamPanel">
                    <div class="team-management">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                             <h3>Team Members (<span id="teamPanelCount">0</span>)</h3>
                             <button class="btn btn-primary btn-sm" id="inviteMemberBtn">
                                 <i class="fas fa-user-plus"></i> Invite Member
                             </button>
                         </div>
                        <div class="team-list" id="teamList">
                            <div class="no-members-message" style="text-align: center; padding: 2rem; color: var(--gray);">
                                Loading team members...
                            </div>
                        </div>

                        {/* Invite/Add Member Form (Can be shown in a modal) */}
                         <div class="add-member-form" id="addMemberFormContainer" style="display: none;"> {/* Initially hidden */}
                            <h4>Invite New Member</h4>
                            <form id="addMemberForm">
                                <div class="form-group">
                                    <label for="memberEmail">Email Address</label>
                                    <input type="email" id="memberEmail" class="form-control" placeholder="Enter email to invite" required>
                                </div>
                                <div class="form-group">
                                    <label for="memberRole">Assign Role</label>
                                    <select id="memberRole" class="form-control" required>
                                        <option value="member">Member</option>
                                        <option value="senior">Senior</option>
                                        <option value="supervisor">Supervisor</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                     <button type="button" class="btn btn-outline" id="cancelAddMemberBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                                </div>
                            </form>
                        </div>

                        <h4>Collaboration & Permissions</h4>
                         <p class="setting-description placeholder-setting" style="margin-bottom: 1rem;">Role-based permissions configuration (coming soon).</p>
                    </div>
                </div>

                {/* Integrations Panel */}
                <div class="settings-panel" id="integrationsPanel">
                    <h4>Available Integrations</h4>
                    <div class="form-group setting-item">
                        <div>
                            <span class="setting-label"><i class="fab fa-slack" style="color: #4A154B; margin-right: 0.5rem;"></i> Slack</span>
                            <p class="setting-description">Connect TeamFlow to your Slack workspace for notifications.</p>
                        </div>
                        <button class="btn btn-outline btn-sm" disabled>Configure</button>
                    </div>
                     <div class="form-group setting-item">
                        <div>
                            <span class="setting-label"><i class="fab fa-google-drive" style="color: #4285F4; margin-right: 0.5rem;"></i> Google Drive</span>
                            <p class="setting-description">Link Google Drive folders to projects.</p>
                        </div>
                        <button class="btn btn-outline btn-sm" disabled>Configure</button>
                    </div>
                     {/* Add more integrations */}
                     <p class="placeholder-setting" style="margin-top: 1rem;">More integrations coming soon.</p>
                </div>

                 {/* Danger Zone Panel */}
                <div class="settings-panel" id="dangerPanel">
                     <h4>Danger Zone</h4>
                     <p class="setting-description" style="margin-bottom: 1.5rem;">These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="admin-message" style="border-left-color: var(--danger); background-color: rgba(239, 68, 68, 0.05); border-radius: 4px;">
                         <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 600; color: var(--danger);">Delete Account</p>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;">Permanently remove your account and all associated data.</p>
                            </div>
                             <button class="btn btn-danger" disabled>Delete My Account</button>
                         </div>
                     </div>
                      <div class="admin-message" style="border-left-color: var(--danger); background-color: rgba(239, 68, 68, 0.05); border-radius: 4px; margin-top: 1rem;">
                         <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 600; color: var(--danger);">Delete Team Data</p>
                                <p style="font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;">Permanently remove all projects, tasks, and files for the entire team. (Admin Only)</p>
                            </div>
                             <button class="btn btn-danger" disabled>Delete All Team Data</button>
                         </div>
                     </div>
                </div>

            </div>

            <!-- Feature Content Sections -->
            <div id="featureSections" class="page-content" style="display: none;">
                {/* Feature content will be loaded here dynamically */}
                <h2>Feature Placeholder</h2>
                <p>This content area will be populated based on the selected feature.</p>
            </div>
        </div>
    </main>

    <!-- Notifications Modal -->
    <div class="notifications-modal" id="notificationsModal">
        <div class="notifications-container">
            <div class="notifications-header">
                <h3 class="notifications-title">Notifications</h3>
                <button class="close-notifications" id="closeNotifications" title="Close">&times;</button>
            </div>
            <div class="notifications-body" id="notificationsList">
                 <div class="no-notifications-message">
                     Loading notifications...
                 </div>
                {/* Notification items will be loaded here */}
            </div>
             <div class="notifications-footer">
                <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                <button class="btn btn-danger btn-sm" id="deleteAllNotifications">Delete All</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-container">
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
            <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
            <div class="confirm-actions">
                <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button> {/* Default to danger, JS can change class/text */}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModal = document.getElementById('notificationsModal');
            const notificationsList = document.getElementById('notificationsList');
            const closeNotifications = document.getElementById('closeNotifications');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotifications = document.getElementById('deleteAllNotifications');
            const userAvatar = document.getElementById('userAvatar');
            const userDetails = document.getElementById('userDetails'); // Container for name + status
            const userName = document.getElementById('userName');
            // const userStatus = document.querySelector('.user-status'); // Status next to name
            const userEmail = document.getElementById('userEmail');
            const welcomeName = document.getElementById('welcomeName');
            const userDropdown = document.getElementById('userDropdown');
            const profileLink = document.getElementById('profileLink');
            const settingsLink = document.getElementById('settingsLink');
            const logoutLink = document.getElementById('logoutLink');
            const pageContents = document.querySelectorAll('.page-content'); // All content divs
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSections = document.getElementById('featureSections');
            const profileForm = document.getElementById('profileForm');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const avatarUploadBtn = document.getElementById('avatarUploadBtn');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            const settingsPanels = document.querySelectorAll('.settings-panel');
            const preferencesForm = document.getElementById('preferencesForm');
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');
            const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn');
            const securityForm = document.getElementById('securityForm');
            const saveSecurityBtn = document.getElementById('saveSecurityBtn');
            const cancelSecurityPasswordBtn = document.getElementById('cancelSecurityPasswordBtn');
            const notificationsForm = document.getElementById('notificationsForm');
            const saveNotificationsBtn = document.getElementById('saveNotificationsBtn');
            const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn');
            const teamList = document.getElementById('teamList');
            const teamPanelCount = document.getElementById('teamPanelCount');
            const addMemberForm = document.getElementById('addMemberForm');
            const addMemberFormContainer = document.getElementById('addMemberFormContainer');
            const inviteMemberBtn = document.getElementById('inviteMemberBtn');
            const cancelAddMemberBtn = document.getElementById('cancelAddMemberBtn');
            const themeOptions = document.querySelectorAll('.theme-option');
            const selectedThemeInput = document.getElementById('selectedTheme');
            const layoutDensitySelect = document.getElementById('layoutDensity');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const teamMembersCount = document.getElementById('teamMembersCount');
            const tasksCompleted = document.getElementById('tasksCompleted');
            const activeProjects = document.getElementById('activeProjects');
            const upcomingDeadlines = document.getElementById('upcomingDeadlines'); // Renamed from Overdue Tasks ID
            const userRoleTitle = document.getElementById('userRoleTitle');
            const backButton = document.getElementById('backButton');
            const notificationSound = document.getElementById('notificationSound');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const currentPasswordError = document.getElementById('currentPasswordError');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const teamMembersTrend = document.getElementById('teamMembersTrend');
            const tasksCompletedTrend = document.getElementById('tasksCompletedTrend');
            const activeProjectsTrend = document.getElementById('activeProjectsTrend');
            const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend');
            const linkToProfile = document.getElementById('linkToProfile');

            // --- State Variables ---
            let currentUser = null;
            let teamMembers = [];
            let activities = [];
            let notifications = [];
            let currentFeature = 'dashboard'; // Default feature
            let currentSettingsTab = 'preferences'; // Default settings tab
            let confirmCallback = null; // Function to run on confirm
            let activityIntervalId = null; // For clearing the interval
            let statsIntervalId = null; // For stats updates

             // --- Constants ---
             const DEFAULT_USER = {
                id: 1,
                name: 'Mohamed Elmenisy',
                email: 'm.elsayed@thechefz.co',
                title: 'Administrator',
                department: 'Management',
                phone: '+201234567890',
                avatar: '', // Store as base64 or URL
                initials: 'ME',
                role: 'admin', // admin, supervisor, senior, member, guest
                // IMPORTANT: Storing plain password here is ONLY for demo purposes. NEVER do this in production.
                password: 'password123',
                preferences: {
                    language: 'en',
                    timezone: 'cairo',
                    dateFormat: 'dd/mm/yyyy',
                    theme: 'blue',
                    layoutDensity: 'normal',
                    weekStart: 'sun',
                    defaultHomepage: 'dashboard',
                },
                notificationPreferences: {
                    emailTasks: true, emailDeadlines: true, emailProjectUpdates: true, emailUpdates: false,
                    pushMessages: true, pushTasks: true, pushTeamUpdates: false,
                },
                stats: { // Example stats structure
                    teamMembers: 0, tasksCompleted: 15, activeProjects: 3, upcomingDeadlines: 2, // Renamed from overdue
                    teamMembersTrend: 'neutral', tasksCompletedTrend: 'up', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'down',
                },
                security: {
                     twoFactorEnabled: false,
                }
            };
            const MAX_ACTIVITIES_DISPLAY = 5;
            const AUTO_UPDATE_INTERVAL = 60000; // 1 minute for time updates
            const REAL_TIME_SIMULATION_INTERVAL = 15000; // 15 seconds for new activity/stats

            // --- Initialization ---
            function initDashboard() {
                console.log("Initializing Dashboard...");
                loadData();
                applyUserPreferences();
                updateUserUI();
                loadTeamMembers(); // Load team members for Team panel
                loadActivities(); // Load initial activities
                loadNotifications(); // Load initial notifications
                updateStats(); // Load initial stats
                setupEventListeners();
                handleInitialNavigation(); // Set active feature based on URL hash
                startActivityTimeUpdater(); // Start timer for relative time updates
                startRealTimeUpdates(); // Start simulation for new data
                updateNotificationBadge(); // Initial badge count
                console.log("Dashboard Initialized.");
            }

            // --- Data Management (LocalStorage) ---
            function loadData() {
                currentUser = JSON.parse(localStorage.getItem('currentUser')) || DEFAULT_USER;
                teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [];
                activities = JSON.parse(localStorage.getItem('activities')) || [];
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
                 // Ensure essential structures exist
                 currentUser.preferences = currentUser.preferences || DEFAULT_USER.preferences;
                 currentUser.notificationPreferences = currentUser.notificationPreferences || DEFAULT_USER.notificationPreferences;
                 currentUser.stats = currentUser.stats || DEFAULT_USER.stats;
                 currentUser.security = currentUser.security || DEFAULT_USER.security;

                 // Derive initials if missing
                 if (!currentUser.initials && currentUser.name) {
                     currentUser.initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                 }
                 console.log("Data loaded from localStorage or defaults used.");
            }

            function saveData() {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                localStorage.setItem('activities', JSON.stringify(activities));
                localStorage.setItem('notifications', JSON.stringify(notifications));
                 console.log("Data saved to localStorage.");
            }

             // --- UI Updates ---
            function applyUserPreferences() {
                 console.log(`Applying preferences: Theme=${currentUser.preferences.theme}, Density=${currentUser.preferences.layoutDensity}`);
                 // Apply Theme
                 document.body.className = ''; // Clear existing theme/density classes
                 document.body.classList.add(`${currentUser.preferences.theme || 'blue'}-theme`);
                 document.body.classList.add(currentUser.preferences.layoutDensity || 'normal');
                 // Apply layout density (handled by body class)
                 // Other preferences applied when respective forms/UI elements are updated
            }

            function updateUserUI() {
                if (!currentUser) return;
                userName.textContent = currentUser.name;
                // userStatus visible by default with â€¢ Connected text
                welcomeName.textContent = currentUser.name.split(' ')[0];
                document.querySelector('.user-info-name').textContent = currentUser.name;
                document.querySelector('.user-info-email span').textContent = currentUser.email;

                // Update role title
                const roleTitles = { admin: 'Administrator', supervisor: 'Supervisor', senior: 'Senior Member', member: 'Team Member', guest: 'Guest' };
                const userTitle = currentUser.title || roleTitles[currentUser.role] || 'Team Member';
                 if (userRoleTitle) userRoleTitle.textContent = userTitle; // Check if element exists
                 document.querySelector('.user-info-title').textContent = userTitle;


                // Set avatar
                const initials = currentUser.initials || currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                 [userAvatar, profileAvatar, profileAvatarLarge].forEach(avatarElement => {
                     if (avatarElement) {
                         if (currentUser.avatar) {
                            avatarElement.style.backgroundImage = `url(${currentUser.avatar})`;
                            avatarElement.textContent = '';
                        } else {
                            avatarElement.style.backgroundImage = '';
                            avatarElement.textContent = initials;
                        }
                     }
                 });

                // Update Profile Form Fields (if profile content is loaded)
                if (document.getElementById('firstName')) {
                    const nameParts = currentUser.name.split(' ');
                    document.getElementById('firstName').value = nameParts[0];
                    document.getElementById('lastName').value = nameParts.slice(1).join(' ');
                    document.getElementById('jobTitle').value = currentUser.title || '';
                    document.getElementById('phone').value = currentUser.phone || '';
                    document.getElementById('department').value = currentUser.department || '';
                    document.getElementById('email').value = currentUser.email;
                }

                 // Update Settings Form Fields (call specific update functions)
                 updatePreferencesFormUI();
                 updateNotificationsFormUI();
                 updateSecurityFormUI();
                 // Account panel links to profile, less direct data needed

                 console.log("User UI updated.");
            }

            function updatePreferencesFormUI() {
                if (!document.getElementById('preferencesPanel')) return; // Only if panel exists
                // Theme
                themeOptions.forEach(opt => opt.classList.remove('active'));
                const activeThemeOption = document.querySelector(`.theme-option[data-theme="${currentUser.preferences.theme || 'blue'}"]`);
                if (activeThemeOption) activeThemeOption.classList.add('active');
                selectedThemeInput.value = currentUser.preferences.theme || 'blue';
                // Layout Density
                layoutDensitySelect.value = currentUser.preferences.layoutDensity || 'normal';
                // Language, Timezone, Date Format, Week Start, Homepage
                document.getElementById('language').value = currentUser.preferences.language || 'en';
                document.getElementById('timezone').value = currentUser.preferences.timezone || 'cairo';
                document.getElementById('dateFormat').value = currentUser.preferences.dateFormat || 'dd/mm/yyyy';
                document.getElementById('weekStart').value = currentUser.preferences.weekStart || 'sun';
                document.getElementById('defaultHomepage').value = currentUser.preferences.defaultHomepage || 'dashboard';
            }

            function updateNotificationsFormUI() {
                 if (!document.getElementById('notificationsPanel')) return;
                 const prefs = currentUser.notificationPreferences;
                 document.getElementById('emailTasks').checked = prefs.emailTasks;
                 document.getElementById('emailDeadlines').checked = prefs.emailDeadlines;
                 document.getElementById('emailProjectUpdates').checked = prefs.emailProjectUpdates;
                 document.getElementById('emailUpdates').checked = prefs.emailUpdates;
                 document.getElementById('pushMessages').checked = prefs.pushMessages;
                 document.getElementById('pushTasks').checked = prefs.pushTasks; // Added pushTasks
                 document.getElementById('pushTeamUpdates').checked = prefs.pushTeamUpdates;
            }

            function updateSecurityFormUI() {
                if (!document.getElementById('securityPanel')) return;
                 document.getElementById('twoFactorAuth').checked = currentUser.security.twoFactorEnabled;
                 // Clear password fields
                 document.getElementById('currentPassword').value = '';
                 document.getElementById('newPassword').value = '';
                 document.getElementById('confirmPassword').value = '';
                 currentPasswordError.style.display = 'none';
                 passwordMatchError.style.display = 'none';
            }

            function updateStats() {
                 if (!currentUser || !currentUser.stats) return;
                 teamMembersCount.textContent = teamMembers.length; // Get live count from team array
                 currentUser.stats.teamMembers = teamMembers.length; // Update stats object too

                 tasksCompleted.textContent = currentUser.stats.tasksCompleted || 0;
                 activeProjects.textContent = currentUser.stats.activeProjects || 0;
                 upcomingDeadlines.textContent = currentUser.stats.upcomingDeadlines || 0; // Renamed ID

                 updateTrendIndicator(teamMembersTrend, currentUser.stats.teamMembersTrend);
                 updateTrendIndicator(tasksCompletedTrend, currentUser.stats.tasksCompletedTrend);
                 updateTrendIndicator(activeProjectsTrend, currentUser.stats.activeProjectsTrend);
                 updateTrendIndicator(upcomingDeadlinesTrend, currentUser.stats.upcomingDeadlinesTrend);
                  console.log("Stats UI updated.");
            }

            function updateTrendIndicator(element, trend) {
                if (!element) return;
                 // Example trend logic - replace with real data if available
                 let iconClass = 'fa-minus';
                 let trendClass = 'trend-neutral';
                 let percentage = 0; // Default to 0% change

                 // Simulate some change for demo if trend isn't neutral
                 if (trend === 'up') {
                     iconClass = 'fa-arrow-up';
                     trendClass = 'trend-up';
                     percentage = Math.floor(Math.random() * 10) + 1; // 1-10% up
                 } else if (trend === 'down') {
                     iconClass = 'fa-arrow-down';
                     trendClass = 'trend-down';
                      percentage = Math.floor(Math.random() * 10) + 1; // 1-10% down
                 }

                 element.innerHTML = `<i class="fas ${iconClass}"></i> ${percentage}%`;
                 element.className = `stat-trend ${trendClass}`;
            }

            // --- Feature/Section Navigation ---
            function handleInitialNavigation() {
                const hash = window.location.hash.substring(1);
                console.log("Initial hash:", hash);
                if (hash) {
                    // Handle settings tabs like #settings-security
                    if (hash.startsWith('settings-')) {
                        const parts = hash.split('-');
                        currentFeature = parts[0]; // 'settings'
                        currentSettingsTab = parts[1] || 'preferences'; // Default to preferences if tab missing
                        console.log(`Navigating to Settings tab: ${currentSettingsTab}`);
                        setActiveFeature(currentFeature, true); // Pass true to prevent immediate history update
                         // Need a slight delay for the settings content to be displayed before clicking the tab
                        setTimeout(() => {
                            const tabElement = document.querySelector(`.settings-tab[data-tab="${currentSettingsTab}"]`);
                            if (tabElement) {
                                tabElement.click(); // Programmatically click the tab
                            } else {
                                console.warn(`Settings tab '${currentSettingsTab}' not found.`);
                                // Fallback to default tab if specified one doesn't exist
                                document.querySelector('.settings-tab[data-tab="preferences"]').click();
                            }
                        }, 50); // Small delay
                    } else {
                        // Handle regular features like #dashboard, #profile
                         console.log(`Navigating to feature: ${hash}`);
                         setActiveFeature(hash, true); // Prevent history update on initial load
                    }
                } else {
                    // Default to dashboard if no hash
                    console.log("No hash found, navigating to dashboard.");
                    setActiveFeature('dashboard', true);
                }
            }

            function setActiveFeature(feature, isInitialLoad = false) {
                console.log(`Setting active feature: ${feature}`);
                 currentFeature = feature;

                // Update URL hash (unless it's the initial load from hash)
                if (!isInitialLoad) {
                    let newHash = feature;
                    if (feature === 'settings') {
                        newHash = `settings-${currentSettingsTab}`; // Ensure settings hash includes tab
                    }
                     console.log("Updating history state with hash:", newHash);
                    window.history.pushState({ feature: feature, tab: currentSettingsTab }, '', `#${newHash}`);
                }

                 // Show/hide back button
                backButton.style.display = feature !== 'dashboard' ? 'inline-flex' : 'none';

                // Hide all main content sections first
                 pageContents.forEach(content => content.style.display = 'none');

                 // Remove active class from all menu items
                 menuItems.forEach(item => item.classList.remove('active'));

                 // Show the selected content and highlight menu item
                 let targetContent = null;
                 let targetMenuItem = document.querySelector(`.menu-item[data-feature="${feature}"]`);

                 switch (feature) {
                     case 'dashboard':
                         targetContent = dashboardContent;
                         break;
                     case 'profile':
                         targetContent = profileContent;
                         // No direct menu item for profile, handled by dropdown click
                         break;
                     case 'settings':
                         targetContent = settingsContent;
                         if (!targetMenuItem) targetMenuItem = document.querySelector('.menu-item[data-feature="settings"]'); // Find settings menu item
                         // Tab activation is handled separately by click or initial load
                         break;
                     default:
                         // Handle other features dynamically (placeholder)
                         targetContent = featureSections;
                         loadFeatureContent(feature); // Load placeholder content
                         break;
                 }

                 if (targetContent) {
                     targetContent.style.display = 'block';
                      console.log(`Displayed content for: ${feature}`);
                 } else {
                     console.warn(`Content section for feature "${feature}" not found.`);
                      // Show dashboard as fallback?
                      // dashboardContent.style.display = 'block';
                      // feature = 'dashboard';
                      // targetMenuItem = document.querySelector('.menu-item[data-feature="dashboard"]');
                 }

                 if (targetMenuItem) {
                     targetMenuItem.classList.add('active');
                      console.log(`Activated menu item for: ${feature}`);
                 } else if (feature !== 'profile') { // Profile doesn't have a dedicated main menu item
                      console.warn(`Menu item for feature "${feature}" not found.`);
                 }
            }

            function loadFeatureContent(featureName) {
                // Simulate loading content for features like 'file-sharing', 'data-management', etc.
                // In a real app, this might involve an API call or loading an HTML template.
                 console.log(`Loading placeholder content for: ${featureName}`);
                 const title = featureName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                 featureSections.innerHTML = `
                    <h2>${title}</h2>
                    <p>This is the content area for the <strong>${title}</strong> feature. Full functionality would be loaded here.</p>
                    <p>You could include components for:</p>
                    <ul>
                        ${featureName === 'file-sharing' ? '<li>File uploads and listings</li><li>Folder structures</li><li>Sharing options</li>' : ''}
                        ${featureName === 'data-management' ? '<li>Data tables or grids</li><li>Filtering and sorting</li><li>Export options</li>' : ''}
                        ${featureName === 'project-tracking' ? '<li>Project lists</li><li>Gantt charts or timelines</li><li>Status updates</li>' : ''}
                         ${featureName === 'task-management' ? '<li>Task lists (Kanban, List)</li><li>Assignees and due dates</li><li>Filters</li>' : ''}
                         ${featureName === 'employee-scheduling' ? '<li>Team roster</li><li>Shift scheduling</li><li>Time off requests</li>' : ''}
                         ${featureName === 'team-calendar' ? '<li>Shared calendar view</li><li>Event creation</li><li>Meeting scheduling</li>' : ''}
                         ${featureName === 'deadline-tracking' ? '<li>Upcoming deadline list</li><li>Overdue items</li><li>Progress tracking</li>' : ''}
                         ${featureName === 'innovation-hub' ? '<li>Idea submission forms</li><li>Voting/ranking</li><li>Discussion boards</li>' : ''}
                    </ul>
                `;
            }

             // --- Real-time Simulation ---
            function startRealTimeUpdates() {
                // Clear existing interval if running
                if (statsIntervalId) clearInterval(statsIntervalId);

                statsIntervalId = setInterval(() => {
                    // Simulate new activity (20% chance every interval)
                    if (teamMembers.length > 0 && Math.random() < 0.2) {
                        generateSimulatedActivity();
                    }

                    // Simulate stat changes (30% chance)
                    if (Math.random() < 0.3) {
                        simulateStatChanges();
                    }
                }, REAL_TIME_SIMULATION_INTERVAL);
                 console.log("Real-time simulation started.");
            }

            function generateSimulatedActivity() {
                 console.log("Simulating new activity...");
                 const randomMember = teamMembers.length > 0
                     ? teamMembers[Math.floor(Math.random() * teamMembers.length)]
                     : { name: "System" }; // Fallback if no members

                 const activityTypes = [
                     { icon: 'fa-tasks', message: `${randomMember.name} completed a task: "Review design mockups"` },
                     { icon: 'fa-project-diagram', message: `${randomMember.name} updated project "Alpha Launch" status to 'Testing'` },
                     { icon: 'fa-comment', message: `New comment on task "Implement API endpoint" from ${randomMember.name}` },
                     { icon: 'fa-file-upload', message: `${randomMember.name} uploaded a new file: "presentation_v3.pptx"` },
                     { icon: 'fa-calendar-check', message: `Meeting scheduled: "Project Sync" with ${randomMember.name}` }
                 ];
                 const randomActivity = activityTypes[Math.floor(Math.random() * activityTypes.length)];

                 // Add Activity
                 const newActivity = {
                     id: Date.now(),
                     icon: randomActivity.icon,
                     message: randomActivity.message,
                     timestamp: new Date().toISOString()
                 };
                 activities.unshift(newActivity);
                 if (activities.length > 100) activities.pop(); // Limit stored activities

                 // Add Notification
                 const newNotification = {
                     id: newActivity.id, // Use same ID for linking if needed
                     icon: newActivity.icon,
                     message: newActivity.message, // Simple message for demo
                     timestamp: newActivity.timestamp,
                     read: false
                 };
                 notifications.unshift(newNotification);
                 if (notifications.length > 50) notifications.pop(); // Limit stored notifications

                 saveData(); // Save both

                 // Update UI
                 loadActivities(viewAllActivity.style.display === 'none'); // Reload activity list (respecting 'Show All')
                 loadNotifications(); // Reload notifications list (if modal open)
                 updateNotificationBadge(); // Update badge count

                 // Highlight new activity
                 const firstActivityItem = activityList.querySelector('.activity-item:first-child');
                 if (firstActivityItem) {
                     firstActivityItem.classList.add('new-activity');
                     setTimeout(() => firstActivityItem.classList.remove('new-activity'), 2000); // Remove highlight after 2s
                 }

                 // Play sound
                 playNotificationSound();
                 console.log("Simulated activity generated and UI updated.");
            }

            function simulateStatChanges() {
                 console.log("Simulating stat changes...");
                 // Simulate tasks completed change (+/- 3)
                 const tasksChange = Math.floor(Math.random() * 7) - 3; // -3 to +3
                 currentUser.stats.tasksCompleted = Math.max(0, (currentUser.stats.tasksCompleted || 0) + tasksChange);
                 currentUser.stats.tasksCompletedTrend = tasksChange > 0 ? 'up' : tasksChange < 0 ? 'down' : 'neutral';

                 // Simulate overdue tasks change (+/- 1)
                 const deadlineChange = Math.random() < 0.5 ? (Math.random() < 0.6 ? -1 : 1) : 0; // More likely decrease/no change
                 currentUser.stats.upcomingDeadlines = Math.max(0, (currentUser.stats.upcomingDeadlines || 0) + deadlineChange);
                 currentUser.stats.upcomingDeadlinesTrend = deadlineChange > 0 ? 'up' : deadlineChange < 0 ? 'down' : 'neutral';

                 // Simulate active projects change (+/- 1, less frequent)
                 if (Math.random() < 0.2) {
                     const projectChange = Math.random() < 0.5 ? -1 : 1;
                     currentUser.stats.activeProjects = Math.max(0, (currentUser.stats.activeProjects || 0) + projectChange);
                     currentUser.stats.activeProjectsTrend = projectChange > 0 ? 'up' : 'down';
                 } else {
                     currentUser.stats.activeProjectsTrend = 'neutral';
                 }

                 saveData();
                 updateStats();
                 console.log("Simulated stats updated.");
            }

             // --- Activity Feed ---
            function loadActivities(showAll = false) {
                activityList.innerHTML = ''; // Clear current list
                const activitiesToShow = showAll ? activities : activities.slice(0, MAX_ACTIVITIES_DISPLAY);

                if (activities.length === 0) {
                    activityList.innerHTML = `<li class="no-activities-message" style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>`;
                    viewAllActivity.style.display = 'none';
                    deleteAllActivity.style.display = 'none';
                    return;
                }

                 activitiesToShow.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    // Store timestamp for updates
                    li.setAttribute('data-timestamp', activity.timestamp || new Date().toISOString());
                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon || 'fa-info-circle'}"></i></div>
                        <div class="activity-content">
                            <div class="activity-message">${activity.message}</div>
                            <div class="activity-time">${getTimeAgo(activity.timestamp || new Date())}</div>
                        </div>
                        <div class="activity-actions">
                            ${(currentUser.role === 'admin' || currentUser.role === 'supervisor') ?
                                `<button class="delete-activity" data-id="${activity.id}" title="Delete Activity"><i class="fas fa-times"></i></button>` : ''}
                        </div>
                    `;
                    activityList.appendChild(li);
                });

                 // Add event listeners to new delete buttons
                 activityList.querySelectorAll('.delete-activity').forEach(button => {
                    button.addEventListener('click', handleDeleteActivityClick);
                });

                 // Manage visibility of 'Show All' / 'Delete All' buttons
                 viewAllActivity.style.display = (!showAll && activities.length > MAX_ACTIVITIES_DISPLAY) ? 'inline-block' : 'none';
                 viewAllActivity.textContent = `Show All (${activities.length})`; // Update count
                 deleteAllActivity.style.display = (activities.length > 0 && (currentUser.role === 'admin' || currentUser.role === 'supervisor')) ? 'inline-block' : 'none';

                 updateActivityTimes(); // Ensure times are calculated immediately
                 console.log(`Activities loaded. Showing ${showAll ? 'all' : 'first ' + MAX_ACTIVITIES_DISPLAY}.`);
            }

             function handleDeleteActivityClick(event) {
                 const button = event.currentTarget;
                 const activityId = parseInt(button.getAttribute('data-id'));
                 showConfirmModal(
                     'Delete Activity',
                     'Are you sure you want to delete this activity record?',
                     () => deleteActivity(activityId),
                     'Delete',
                     'danger' // Use danger style for confirm button
                 );
             }

             function deleteActivity(activityId) {
                 activities = activities.filter(act => act.id !== activityId);
                 saveData();
                 loadActivities(viewAllActivity.style.display === 'none'); // Reload list respecting Show All state
                 hideConfirmModal();
                 showSuccessMessage('Activity deleted.');
                 console.log(`Activity ${activityId} deleted.`);
             }

             function deleteAllActivities() {
                if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') {
                    showSuccessMessage('Permission denied.', true); // Show as error
                    return;
                }
                 showConfirmModal(
                     'Delete All Activities',
                     'Are you sure you want to delete ALL activity records? This cannot be undone.',
                     () => {
                         activities = [];
                         saveData();
                         loadActivities();
                         hideConfirmModal();
                         showSuccessMessage('All activities deleted.');
                          console.log("All activities deleted.");
                     },
                     'Delete All',
                     'danger'
                 );
             }

             // --- Activity Time Updates ---
            function startActivityTimeUpdater() {
                 // Clear existing interval if running
                if (activityIntervalId) clearInterval(activityIntervalId);

                updateActivityTimes(); // Update immediately
                 activityIntervalId = setInterval(updateActivityTimes, AUTO_UPDATE_INTERVAL); // Update every minute
                 console.log("Activity time updater started.");
            }

             function updateActivityTimes() {
                const timeElements = activityList.querySelectorAll('.activity-time');
                timeElements.forEach(el => {
                    const timestamp = el.closest('.activity-item')?.getAttribute('data-timestamp');
                    if (timestamp) {
                        el.textContent = getTimeAgo(timestamp);
                    }
                });
                 // console.log("Activity times updated."); // Can be noisy
            }

             function getTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                const now = new Date();
                const date = new Date(timestamp);
                const seconds = Math.floor((now - date) / 1000);

                if (isNaN(seconds) || seconds < 0) return 'Just now'; // Handle invalid or future dates

                if (seconds < 60) return `${seconds} second${seconds === 1 ? '' : 's'} ago`;

                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;

                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;

                const days = Math.floor(hours / 24);
                if (days < 7) return `${days} day${days === 1 ? '' : 's'} ago`;

                // For older dates, show formatted date/time based on user pref
                const options = {
                    // year: 'numeric', // Omit year for brevity unless needed
                     month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
                try {
                    // Use user's date format preference logic here if complex formatting needed
                    return date.toLocaleDateString(currentUser.preferences.language || 'en', options);
                } catch (e) {
                    console.error("Error formatting date:", e);
                    return date.toLocaleDateString(); // Fallback
                }
            }

             // --- Notifications ---
            function updateNotificationBadge() {
                const unreadCount = notifications.filter(n => !n.read).length;
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
            }

            function loadNotifications() {
                notificationsList.innerHTML = ''; // Clear existing
                if (notifications.length === 0) {
                    notificationsList.innerHTML = `<div class="no-notifications-message">You're all caught up!</div>`;
                     markAllReadBtn.disabled = true;
                     deleteAllNotifications.disabled = true;
                    return;
                }

                 markAllReadBtn.disabled = notifications.every(n => n.read); // Disable if all read
                 deleteAllNotifications.disabled = false;

                 notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    item.setAttribute('data-id', notification.id);
                    item.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon || 'fa-bell'}"></i></div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${getTimeAgo(notification.timestamp)}</div>
                        </div>
                        <div class="notification-actions">
                             <button class="delete-notification" title="Delete Notification"><i class="fas fa-times"></i></button>
                        </div>
                    `;

                     // Mark as read on click (but not if delete button is clicked)
                     item.addEventListener('click', (e) => {
                         if (!e.target.closest('.delete-notification')) {
                             markNotificationAsRead(notification.id, item);
                         }
                     });

                     // Handle delete button click
                     item.querySelector('.delete-notification').addEventListener('click', (e) => {
                         e.stopPropagation(); // Prevent item click handler
                         showConfirmModal(
                             'Delete Notification',
                             'Are you sure you want to delete this notification?',
                             () => deleteNotification(notification.id),
                             'Delete',
                             'danger'
                         );
                     });

                    notificationsList.appendChild(item);
                });
                 console.log("Notifications loaded.");
            }

             function markNotificationAsRead(id, element) {
                 const notification = notifications.find(n => n.id === id);
                 if (notification && !notification.read) {
                     notification.read = true;
                     saveData();
                     element.classList.remove('unread');
                     updateNotificationBadge();
                      markAllReadBtn.disabled = notifications.every(n => n.read); // Re-check Mark All button state
                      console.log(`Notification ${id} marked as read.`);
                 }
             }

            function markAllNotificationsRead() {
                 let changed = false;
                 notifications.forEach(n => {
                     if (!n.read) {
                         n.read = true;
                         changed = true;
                     }
                 });
                 if (changed) {
                     saveData();
                     // Update UI - simpler to just reload
                     loadNotifications();
                     updateNotificationBadge();
                     showSuccessMessage('All notifications marked as read.');
                      console.log("All notifications marked as read.");
                 }
             }

             function deleteNotification(id) {
                 notifications = notifications.filter(n => n.id !== id);
                 saveData();
                 loadNotifications(); // Reload list
                 updateNotificationBadge();
                 hideConfirmModal();
                 showSuccessMessage('Notification deleted.');
                 console.log(`Notification ${id} deleted.`);
             }

            function deleteAllNotificationsHandler() {
                if (notifications.length === 0) return;
                 showConfirmModal(
                     'Delete All Notifications',
                     'Are you sure you want to delete ALL notifications?',
                     () => {
                         notifications = [];
                         saveData();
                         loadNotifications();
                         updateNotificationBadge();
                         hideConfirmModal();
                         showSuccessMessage('All notifications deleted.');
                          console.log("All notifications deleted.");
                     },
                     'Delete All',
                     'danger'
                 );
             }

            // --- Team Management ---
             function loadTeamMembers() {
                teamList.innerHTML = ''; // Clear current list
                 teamPanelCount.textContent = teamMembers.length; // Update count in panel header

                if (teamMembers.length === 0) {
                    teamList.innerHTML = `<div class="no-members-message" style="text-align: center; padding: 2rem; color: var(--gray);">No team members yet. Invite your first member!</div>`;
                    return;
                }

                 teamMembers.forEach(member => {
                    const card = document.createElement('div');
                    card.className = 'team-member-card';
                    card.setAttribute('data-id', member.id);
                     const initials = member.initials || member.name?.split(' ').map(n=>n[0]).join('').toUpperCase() || member.email.substring(0,2).toUpperCase();
                     const roleClass = `role-${member.role}`;
                     const roleName = member.role.charAt(0).toUpperCase() + member.role.slice(1);

                    card.innerHTML = `
                        <div class="member-avatar" style="${member.avatar ? `background-image: url(${member.avatar})` : ''}">${member.avatar ? '' : initials}</div>
                        <div class="member-details">
                            <div class="member-name">${member.name || member.email}</div>
                            <div class="member-email">${member.email}</div>
                        </div>
                        <div class="member-role ${roleClass}">${roleName}</div>
                        <div class="member-actions">
                             ${currentUser.role === 'admin' || currentUser.role === 'supervisor' ?
                                `<button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-edit"></i></button>` : ''}
                             ${currentUser.role === 'admin' && currentUser.id !== member.id ? // Admins can delete others, but not themselves
                                `<button class="btn btn-danger btn-sm delete-member" title="Remove Member"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    teamList.appendChild(card);
                });

                 // Add event listeners for edit/delete
                 teamList.querySelectorAll('.edit-member').forEach(btn => btn.addEventListener('click', handleEditMemberClick));
                 teamList.querySelectorAll('.delete-member').forEach(btn => btn.addEventListener('click', handleDeleteMemberClick));
                 console.log("Team members loaded.");
            }

             function handleAddMemberSubmit(e) {
                e.preventDefault();
                const emailInput = document.getElementById('memberEmail');
                const roleSelect = document.getElementById('memberRole');
                const email = emailInput.value.trim();
                const role = roleSelect.value;

                if (!email || !email.includes('@')) {
                    alert('Please enter a valid email address.');
                    return;
                }
                 if (teamMembers.some(member => member.email.toLowerCase() === email.toLowerCase())) {
                    alert('A team member with this email already exists.');
                    return;
                }

                 // Simulate adding/inviting
                 const name = email.split('@')[0].replace('.', ' ').replace('_', ' '); // Simple name generation
                 const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                 const newMember = { id: Date.now(), name: name, email: email, role: role, initials: initials, avatar: '' };

                 teamMembers.push(newMember);
                 saveData();
                 loadTeamMembers(); // Reload list
                 updateStats(); // Update dashboard stats

                 // Add Activity Log
                 addActivityLog('fa-user-plus', `${currentUser.name} invited ${email} as a ${role}.`);

                 addMemberForm.reset();
                 addMemberFormContainer.style.display = 'none'; // Hide form after submit
                 showSuccessMessage(`Invitation sent to ${email}.`);
                 console.log(`Member ${email} added/invited.`);
            }

             function handleEditMemberClick(event) {
                 const button = event.currentTarget;
                 const card = button.closest('.team-member-card');
                 const memberId = parseInt(card.getAttribute('data-id'));
                 const member = teamMembers.find(m => m.id === memberId);
                 if (!member) return;

                 // For this example, we'll just log it. A modal would be better.
                 console.log("Editing member:", member);
                 alert(`Edit functionality for ${member.name} not fully implemented in this demo. Check console.`);
                 // TODO: Implement an edit modal similar to handleAddMemberSubmit form
                 // showEditMemberModal(member);
             }

            function handleDeleteMemberClick(event) {
                if (currentUser.role !== 'admin') return; // Only admins can delete

                const button = event.currentTarget;
                const card = button.closest('.team-member-card');
                const memberId = parseInt(card.getAttribute('data-id'));
                 if (memberId === currentUser.id) {
                     alert("You cannot remove yourself.");
                     return;
                 }
                const member = teamMembers.find(m => m.id === memberId);
                if (!member) return;

                showConfirmModal(
                    'Remove Team Member',
                    `Are you sure you want to remove ${member.name || member.email} from the team?`,
                    () => deleteTeamMember(memberId),
                    'Remove',
                    'danger'
                );
            }

            function deleteTeamMember(memberId) {
                 const memberIndex = teamMembers.findIndex(m => m.id === memberId);
                 if (memberIndex === -1) return;

                 const removedMember = teamMembers[memberIndex];
                 teamMembers.splice(memberIndex, 1);

                 saveData();
                 loadTeamMembers(); // Reload list
                 updateStats(); // Update dashboard stats

                 // Add Activity Log
                 addActivityLog('fa-user-minus', `${currentUser.name} removed ${removedMember.name || removedMember.email} from the team.`);

                 hideConfirmModal();
                 showSuccessMessage(`Team member removed.`);
                 console.log(`Member ${memberId} removed.`);
             }

            // --- Forms Handling ---
             function handleProfileFormSubmit(e) {
                 e.preventDefault();
                 showConfirmModal(
                     'Update Profile',
                     'Save changes to your profile information?',
                     () => {
                         showLoading('saveProfileBtn', 'profileSpinner', 'profileLoadingText');
                         // Simulate API delay
                         setTimeout(() => {
                             const updatedUser = { ...currentUser };
                             updatedUser.name = `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`;
                             updatedUser.title = document.getElementById('jobTitle').value.trim();
                             updatedUser.phone = document.getElementById('phone').value.trim();
                             updatedUser.department = document.getElementById('department').value.trim();
                             updatedUser.initials = updatedUser.name.split(' ').map(n => n[0]).join('').toUpperCase();

                             currentUser = updatedUser;
                             saveData();
                             updateUserUI(); // Update header, welcome section, etc.
                             hideLoading('saveProfileBtn', 'profileSpinner', 'profileLoadingText');
                             hideConfirmModal();
                             showSuccessMessage('Profile updated successfully!');
                             addActivityLog('fa-user-edit', 'Updated profile information.');
                             // Optionally navigate back after success
                             // setActiveFeature('dashboard');
                         }, 500); // 0.5 second delay
                     },
                     'Save Changes', // Confirm button text
                     'primary' // Confirm button style
                 );
             }

             function handleProfileCancel() {
                 showConfirmModal(
                     'Cancel Changes',
                     'Discard changes made to your profile?',
                     () => {
                         updateUserUI(); // Reload original data into form
                         hideConfirmModal();
                         // Optionally navigate back
                         // setActiveFeature('dashboard');
                     },
                     'Discard',
                     'outline' // Use outline style for discard
                 );
             }

            function handlePreferencesFormSubmit(e) {
                 e.preventDefault();
                 showConfirmModal(
                     'Save Preferences',
                     'Apply these preference settings?',
                     () => {
                         showLoading('savePreferencesBtn', 'preferencesSpinner', 'preferencesLoadingText');
                         setTimeout(() => {
                             currentUser.preferences.theme = selectedThemeInput.value;
                             currentUser.preferences.layoutDensity = layoutDensitySelect.value;
                             currentUser.preferences.language = document.getElementById('language').value;
                             currentUser.preferences.timezone = document.getElementById('timezone').value;
                             currentUser.preferences.dateFormat = document.getElementById('dateFormat').value;
                             currentUser.preferences.weekStart = document.getElementById('weekStart').value;
                             currentUser.preferences.defaultHomepage = document.getElementById('defaultHomepage').value;

                             saveData();
                             applyUserPreferences(); // Apply theme and density immediately
                             updateUserUI(); // Reflect changes in UI if needed elsewhere
                             hideLoading('savePreferencesBtn', 'preferencesSpinner', 'preferencesLoadingText');
                             hideConfirmModal();
                             showSuccessMessage('Preferences saved.');
                             addActivityLog('fa-palette', `Updated preferences (Theme: ${currentUser.preferences.theme}, Density: ${currentUser.preferences.layoutDensity}).`);
                         }, 500);
                     },
                     'Save', 'primary'
                 );
             }

             function handlePreferencesCancel() {
                 showConfirmModal(
                     'Cancel Changes',
                     'Discard changes to preferences?',
                     () => {
                         updatePreferencesFormUI(); // Reset form to saved values
                         applyUserPreferences(); // Re-apply saved theme/density
                         hideConfirmModal();
                     },
                     'Discard', 'outline'
                 );
             }

             function handleSecurityFormSubmit(e) {
                 e.preventDefault();
                 // Password Change Logic
                  showConfirmModal(
                     'Update Password',
                     'Are you sure you want to change your password?',
                     () => {
                         showLoading('saveSecurityBtn', 'securitySpinner', 'securityLoadingText');
                         const currentPasswordInput = document.getElementById('currentPassword');
                         const newPasswordInput = document.getElementById('newPassword');
                         const confirmPasswordInput = document.getElementById('confirmPassword');

                         // Reset errors
                         currentPasswordError.style.display = 'none';
                         passwordMatchError.style.display = 'none';

                         // Basic validation (Real check needed against backend/hashed password)
                         if (currentPasswordInput.value !== currentUser.password) {
                             currentPasswordError.style.display = 'block';
                             hideLoading('saveSecurityBtn', 'securitySpinner', 'securityLoadingText');
                             hideConfirmModal(); // Hide confirm modal, show error
                             return;
                         }
                         if (newPasswordInput.value.length < 8) {
                              alert("New password must be at least 8 characters long.");
                              hideLoading('saveSecurityBtn', 'securitySpinner', 'securityLoadingText');
                              hideConfirmModal();
                              return;
                         }
                         if (newPasswordInput.value !== confirmPasswordInput.value) {
                             passwordMatchError.style.display = 'block';
                             hideLoading('saveSecurityBtn', 'securitySpinner', 'securityLoadingText');
                             hideConfirmModal();
                             return;
                         }

                         // Simulate update
                         setTimeout(() => {
                             currentUser.password = newPasswordInput.value; // Again, NEVER store plain text
                             saveData();
                             hideLoading('saveSecurityBtn', 'securitySpinner', 'securityLoadingText');
                             hideConfirmModal();
                             securityForm.reset(); // Clear fields
                             updateSecurityFormUI(); // Ensure 2FA toggle is correct state
                             showSuccessMessage('Password updated successfully.');
                             addActivityLog('fa-key', 'Changed account password.');
                         }, 500);
                     },
                     'Update Password', 'primary'
                 );

                 // Handle 2FA toggle if implemented
                 // const twoFactorEnabled = document.getElementById('twoFactorAuth').checked;
                 // if (twoFactorEnabled !== currentUser.security.twoFactorEnabled) {
                 //     // ... logic to enable/disable 2FA ...
                 //     currentUser.security.twoFactorEnabled = twoFactorEnabled;
                 // }
             }

              function handleSecurityCancel() {
                  showConfirmModal(
                     'Cancel Changes',
                     'Discard password change?',
                     () => {
                         updateSecurityFormUI(); // Reset form and errors
                         hideConfirmModal();
                     },
                     'Discard', 'outline'
                 );
             }

            function handleNotificationsFormSubmit(e) {
                 e.preventDefault();
                  showConfirmModal(
                     'Save Notification Settings',
                     'Apply these notification preferences?',
                     () => {
                         showLoading('saveNotificationsBtn', 'notificationsSpinner', 'notificationsLoadingText');
                         setTimeout(() => {
                             currentUser.notificationPreferences.emailTasks = document.getElementById('emailTasks').checked;
                             currentUser.notificationPreferences.emailDeadlines = document.getElementById('emailDeadlines').checked;
                             currentUser.notificationPreferences.emailProjectUpdates = document.getElementById('emailProjectUpdates').checked;
                             currentUser.notificationPreferences.emailUpdates = document.getElementById('emailUpdates').checked;
                             currentUser.notificationPreferences.pushMessages = document.getElementById('pushMessages').checked;
                             currentUser.notificationPreferences.pushTasks = document.getElementById('pushTasks').checked;
                             currentUser.notificationPreferences.pushTeamUpdates = document.getElementById('pushTeamUpdates').checked;

                             saveData();
                             hideLoading('saveNotificationsBtn', 'notificationsSpinner', 'notificationsLoadingText');
                             hideConfirmModal();
                             showSuccessMessage('Notification settings saved.');
                             addActivityLog('fa-bell', 'Updated notification preferences.');
                         }, 500);
                     },
                     'Save', 'primary'
                 );
             }

             function handleNotificationsCancel() {
                 showConfirmModal(
                     'Cancel Changes',
                     'Discard changes to notification settings?',
                     () => {
                         updateNotificationsFormUI(); // Reset form
                         hideConfirmModal();
                     },
                     'Discard', 'outline'
                 );
             }

             // --- Modals ---
            function showConfirmModal(title, message, callback, confirmText = 'Confirm', confirmClass = 'danger') {
                confirmTitle.textContent = title;
                confirmMessage.innerHTML = message; // Use innerHTML if message contains HTML
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `btn btn-${confirmClass}`; // Set button style (primary, danger, outline)
                 confirmTitle.className = confirmClass === 'danger' ? 'confirm-title danger' : 'confirm-title'; // Optional title styling

                confirmCallback = callback; // Store the function to call on confirm

                confirmModal.style.display = 'flex';
                 console.log(`Showing confirm modal: ${title}`);
            }

            function hideConfirmModal() {
                confirmModal.style.display = 'none';
                 confirmCallback = null; // Clear callback
                 console.log("Confirm modal hidden.");
            }

            // --- Helpers ---
             function showLoading(buttonId, spinnerId, textId, isOutline = false) {
                 const button = document.getElementById(buttonId);
                 const spinner = document.getElementById(spinnerId);
                 const text = document.getElementById(textId);
                 const buttonSpan = button?.querySelector('span:not(.loading-text)'); // Get the original text span

                 if (button && spinner && text && buttonSpan) {
                     button.disabled = true;
                     spinner.style.display = 'inline-block';
                     text.style.display = 'inline';
                     buttonSpan.style.display = 'none'; // Hide original text
                 }
             }

             function hideLoading(buttonId, spinnerId, textId) {
                 const button = document.getElementById(buttonId);
                 const spinner = document.getElementById(spinnerId);
                 const text = document.getElementById(textId);
                 const buttonSpan = button?.querySelector('span:not(.loading-text)');

                 if (button && spinner && text && buttonSpan) {
                     button.disabled = false;
                     spinner.style.display = 'none';
                     text.style.display = 'none';
                     buttonSpan.style.display = 'inline'; // Show original text
                 }
             }

            function showSuccessMessage(message, isError = false) {
                successMessageText.textContent = message;
                successMessage.style.backgroundColor = isError ? 'var(--danger)' : 'var(--success)';
                 successMessage.querySelector('i').className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                successMessage.classList.add('show');
                setTimeout(() => {
                    successMessage.classList.remove('show');
                }, 3000);
            }

             function playNotificationSound() {
                 notificationSound.play().catch(error => console.warn("Audio play failed:", error));
             }

             function addActivityLog(icon, message) {
                 const newActivity = {
                     id: Date.now(),
                     icon: icon,
                     message: message,
                     timestamp: new Date().toISOString()
                 };
                 activities.unshift(newActivity);
                  if (activities.length > 100) activities.pop();
                 saveData();
                 // Only reload if dashboard is visible? Or always update underlying data?
                  if (currentFeature === 'dashboard') {
                      loadActivities(viewAllActivity.style.display === 'none');
                  }
                 console.log("Activity logged:", message);
             }


             // --- Event Listeners Setup ---
            function setupEventListeners() {
                 console.log("Setting up event listeners...");
                 // Sidebar Menu
                 menuItems.forEach(item => item.addEventListener('click', handleMenuClick));

                 // Top Nav: Search, Notifications, User Dropdown
                 searchInput.addEventListener('input', handleSearchInput);
                 document.addEventListener('click', handleClickOutside); // For closing search/dropdowns
                 notificationIcon.addEventListener('click', handleNotificationIconClick);
                 closeNotifications.addEventListener('click', () => notificationsModal.style.display = 'none');
                 markAllReadBtn.addEventListener('click', markAllNotificationsRead);
                 deleteAllNotifications.addEventListener('click', deleteAllNotificationsHandler);
                 userDetails.addEventListener('click', () => userDropdown.classList.toggle('active')); // Toggle on name/status click
                 userAvatar.addEventListener('click', () => userDropdown.classList.toggle('active')); // Toggle on avatar click
                 profileLink.addEventListener('click', handleProfileLinkClick);
                 settingsLink.addEventListener('click', handleSettingsLinkClick);
                 logoutLink.addEventListener('click', handleLogout);
                 linkToProfile?.addEventListener('click', handleProfileLinkClick); // Link from Account settings

                 // Back Button
                 backButton.addEventListener('click', () => window.history.back());

                 // Browser Navigation (Back/Forward)
                 window.addEventListener('popstate', handlePopState);

                 // Profile Form
                 profileForm.addEventListener('submit', handleProfileFormSubmit);
                 cancelProfileBtn.addEventListener('click', handleProfileCancel);
                 avatarUploadBtn.addEventListener('click', () => profileAvatarInput.click());
                 profileAvatarInput.addEventListener('change', handleAvatarChange);

                 // Settings Tabs & Forms
                 settingsTabs.forEach(tab => tab.addEventListener('click', handleSettingsTabClick));
                 preferencesForm.addEventListener('submit', handlePreferencesFormSubmit);
                 cancelPreferencesBtn.addEventListener('click', handlePreferencesCancel);
                 securityForm.addEventListener('submit', handleSecurityFormSubmit);
                 cancelSecurityPasswordBtn.addEventListener('click', handleSecurityCancel);
                 notificationsForm.addEventListener('submit', handleNotificationsFormSubmit);
                 cancelNotificationsBtn.addEventListener('click', handleNotificationsCancel);
                 themeOptions.forEach(option => option.addEventListener('click', handleThemeSelection));
                 layoutDensitySelect.addEventListener('change', handleLayoutDensityChange); // Apply density preview

                 // Team Management (in Settings)
                 inviteMemberBtn.addEventListener('click', () => addMemberFormContainer.style.display = 'block');
                 cancelAddMemberBtn.addEventListener('click', () => { addMemberForm.reset(); addMemberFormContainer.style.display = 'none'; });
                 addMemberForm.addEventListener('submit', handleAddMemberSubmit);
                 // Edit/Delete listeners added dynamically in loadTeamMembers

                 // Activity List Buttons
                 viewAllActivity.addEventListener('click', () => loadActivities(true));
                 deleteAllActivity.addEventListener('click', deleteAllActivities);

                 // Confirm Modal Buttons
                 cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                 confirmBtn.addEventListener('click', () => {
                     if (typeof confirmCallback === 'function') {
                         confirmCallback();
                     } else {
                         console.warn("Confirm button clicked but no callback assigned.");
                         hideConfirmModal(); // Hide modal anyway
                     }
                 });
                  console.log("Event listeners set up.");
             }

             // --- Event Handlers ---
             function handleMenuClick(e) {
                e.preventDefault();
                const feature = this.getAttribute('data-feature');
                 if (feature) {
                     setActiveFeature(feature);
                 }
            }

             function handleSearchInput() {
                // Implement search logic here if needed, currently placeholder
                 const searchTerm = searchInput.value.trim().toLowerCase();
                 console.log("Search term:", searchTerm);
                 if (searchTerm.length > 1) {
                     // Simulate finding results
                     searchResults.innerHTML = `<div class="search-result-item">Result for "${searchTerm}" 1</div><div class="search-result-item">Result for "${searchTerm}" 2</div>`;
                     searchResults.classList.add('active');
                 } else {
                     searchResults.classList.remove('active');
                 }
             }

             function handleClickOutside(e) {
                 // Close search results
                 if (!e.target.closest('.search-bar')) {
                     searchResults.classList.remove('active');
                 }
                 // Close user dropdown
                 if (!e.target.closest('.user-profile')) {
                     userDropdown.classList.remove('active');
                 }
                  // Close notification modal if clicking outside container
                  if (notificationsModal.style.display === 'flex' && !e.target.closest('.notifications-container') && !e.target.closest('.notification-icon')) {
                      notificationsModal.style.display = 'none';
                  }
                 // Close confirm modal if clicking outside container
                 if (confirmModal.style.display === 'flex' && !e.target.closest('.confirm-container')) {
                      hideConfirmModal();
                 }
             }

             function handleNotificationIconClick() {
                notificationsModal.style.display = 'flex';
                loadNotifications(); // Refresh list when opening
                 // Optionally mark as read on open - decide based on desired UX
                 // markAllNotificationsRead();
             }

             function handleProfileLinkClick(e) {
                e.preventDefault();
                userDropdown.classList.remove('active');
                setActiveFeature('profile');
            }

             function handleSettingsLinkClick(e) {
                 e.preventDefault();
                 userDropdown.classList.remove('active');
                 setActiveFeature('settings');
                 // Ensure the default/last selected tab is shown
                 const activeTab = document.querySelector(`.settings-tab[data-tab="${currentSettingsTab}"]`);
                 if (activeTab) activeTab.click();
             }

             function handleLogout(e) {
                 e.preventDefault();
                 showConfirmModal(
                     'Logout',
                     'Are you sure you want to log out?',
                     () => {
                         console.log("Logging out...");
                         // Clear sensitive data - keep preferences? Decide based on requirements.
                         localStorage.removeItem('currentUser');
                         localStorage.removeItem('teamMembers');
                         localStorage.removeItem('activities');
                         localStorage.removeItem('notifications');
                         // Redirect to login page
                         // For demo, just show message and reload
                         // window.location.href = 'login.html';
                         hideConfirmModal();
                         showSuccessMessage('Logged out successfully. Redirecting...');
                         setTimeout(() => window.location.reload(), 1500); // Simulate redirect
                     },
                     'Logout', 'danger'
                 );
             }

             function handlePopState(event) {
                 console.log("Popstate event:", event.state);
                 if (event.state && event.state.feature) {
                      currentSettingsTab = event.state.tab || 'preferences'; // Restore tab state too
                      setActiveFeature(event.state.feature, true); // Set feature without pushing history
                      // If it's the settings feature, make sure the correct tab is visually active
                      if (event.state.feature === 'settings') {
                           settingsTabs.forEach(t => t.classList.remove('active'));
                           settingsPanels.forEach(p => p.classList.remove('active'));
                           const tab = document.querySelector(`.settings-tab[data-tab="${currentSettingsTab}"]`);
                           const panel = document.getElementById(`${currentSettingsTab}Panel`);
                           if(tab) tab.classList.add('active');
                           if(panel) panel.classList.add('active');
                      }
                 } else {
                     // If no state, default to dashboard (or initial hash logic)
                     handleInitialNavigation();
                 }
             }

             function handleAvatarChange(e) {
                 const file = e.target.files[0];
                 if (file) {
                     if (!file.type.match('image.*')) {
                         alert('Please select an image file (JPEG, PNG, GIF).');
                         return;
                     }
                     if (file.size > 2 * 1024 * 1024) { // 2MB limit
                         alert('Image size cannot exceed 2MB.');
                         return;
                     }
                     const reader = new FileReader();
                     reader.onload = function(event) {
                         const imageDataUrl = event.target.result;
                          // Show confirmation before applying? Optional.
                         showConfirmModal(
                            'Update Profile Picture',
                             `<img src="${imageDataUrl}" alt="Preview" style="max-width: 100px; max-height: 100px; border-radius: 50%; margin-bottom: 1rem; display: block; margin-left: auto; margin-right: auto;"><p>Use this image as your profile picture?</p>`,
                            () => {
                                currentUser.avatar = imageDataUrl;
                                saveData();
                                updateUserUI(); // Update all avatar displays
                                hideConfirmModal();
                                showSuccessMessage('Profile picture updated.');
                                addActivityLog('fa-camera', 'Changed profile picture.');
                            },
                            'Use Image', 'primary'
                         );
                     }
                     reader.readAsDataURL(file);
                 }
                  // Reset input value so the same file can be selected again if needed
                 e.target.value = null;
             }

             function handleSettingsTabClick() {
                const tabId = this.getAttribute('data-tab');
                 if (tabId === currentSettingsTab) return; // Do nothing if clicking the active tab

                 currentSettingsTab = tabId;
                 console.log(`Settings tab changed to: ${tabId}`);

                 // Update URL hash for settings tab persistence
                 window.history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`);

                 settingsTabs.forEach(t => t.classList.remove('active'));
                 this.classList.add('active');

                 settingsPanels.forEach(panel => panel.classList.remove('active'));
                 const targetPanel = document.getElementById(`${tabId}Panel`);
                 if (targetPanel) {
                     targetPanel.classList.add('active');
                 } else {
                     console.warn(`Settings panel for tab "${tabId}" not found.`);
                 }
             }

             function handleThemeSelection() {
                 const selectedTheme = this.getAttribute('data-theme');
                 selectedThemeInput.value = selectedTheme;
                 // Visually indicate selection
                 themeOptions.forEach(opt => opt.classList.remove('active'));
                 this.classList.add('active');
                 // Apply theme preview (will be saved on form submit)
                 document.body.className = ''; // Clear classes
                 document.body.classList.add(`${selectedTheme}-theme`);
                 document.body.classList.add(layoutDensitySelect.value); // Re-apply density
             }

             function handleLayoutDensityChange() {
                 const newDensity = this.value;
                 // Apply density preview (will be saved on form submit)
                 document.body.classList.remove('compact', 'normal', 'spacious');
                 document.body.classList.add(newDensity);
             }


            // --- Start Application ---
            initDashboard();
        });
    </script>

</body>
</html>

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">

    <style>
        /* --- المتغيرات الأساسية وأنماط CSS (كما هي من الرد السابق) --- */
        :root { /* ... */ }
        * { /* ... */ }
        body { /* ... */ }
        /* ... (جميع أنماط CSS من الرد السابق) ... */
         .sidebar { /* ... */ }
         .sidebar-header { /* ... */ }
         .logo { /* ... */ }
         /* ... إلخ ... */
         .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; /* للمساعدة في عرض رسائل الخطأ الطويلة */ text-align: left; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px;}
         .content-section { display: none; animation: fadeInContent 0.4s ease-in-out; }
         .content-section.active { display: block; }
         @keyframes fadeInContent { from { opacity: 0; } to { opacity: 1; } }
         /* ... (باقي أنماط CSS) ... */
    </style>
</head>
<body class="blue-theme">

    <!-- *** مسار ملف الصوت مُعدّل *** -->
    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- تأكد أن هذا الملف موجود في مجلد assets -->
        Your browser does not support the audio element.
    </audio>

    <!-- ... (باقي HTML: successMessage, sidebar, main-content, top-nav, modals) ... -->
     <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>
     <aside class="sidebar" id="sidebar"> <!-- ... Sidebar HTML ... --> <div class="sidebar-header"> <div class="logo"> <i class="fas fa-users-cog logo-icon"></i> <span>TeamFlow</span> </div> </div> <div class="sidebar-menu"> <div class="menu-title">Navigation</div> <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a> <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a> <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a> <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a> <div class="menu-title">Core Features</div> <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a> <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a> <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a> <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a> <div class="menu-title">Team Tools</div> <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a> <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a> <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a> <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a> <div class="menu-divider"></div> <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a> <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a> </div> <div class="connection-status"> <div class="status-dot"></div> <span>Online</span> </div> </aside>
     <main class="main-content"> <nav class="top-nav"> <!-- ... Top Nav HTML ... --> <div class="search-bar"> <i class="fas fa-search search-icon"></i> <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off"> <div class="search-results" id="searchResults"></div> </div> <div class="user-menu"> <div class="notification-icon" id="notificationIcon"> <i class="fas fa-bell"></i> <span class="notification-badge" style="display: none;">0</span> </div> <div class="user-profile"> <div class="user-avatar" id="userAvatar">ME</div> <div class="user-profile-details"> <span class="user-name" id="userName">Loading...</span> <span class="user-status"> • Connected</span> </div> <div class="user-dropdown" id="userDropdown"> <a href="#profile" class="dropdown-item" id="profileLink" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a> <a href="#settings" class="dropdown-item" id="settingsLink" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a> <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a> </div> </div> </div> </nav>
        <div class="content-area"> <div class="back-button" id="backButton" style="display: none;"> <i class="fas fa-arrow-left"></i> <span>Back</span> </div>
             <div id="dashboardContent" class="content-section active"> <!-- ... Dashboard Content HTML ... --> <div class="welcome-section"> <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2> <p class="welcome-subtitle">Here's what's happening with your team today.</p> <div class="user-info"> <div class="user-info-avatar" id="profileAvatar">U</div> <div class="user-info-details"> <div class="user-info-name">Loading User...</div> <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div> <div class="user-info-email"> <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span> </div> </div> </div> </div> <div class="stats-section"> <div class="stat-card"> <div class="stat-title"><i class="fas fa-users"></i>Team Members</div> <div class="stat-value"> <span id="teamMembersCount">0</span> <span class="stat-trend trend-neutral" id="teamMembersTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-check-circle"></i>Tasks Completed</div> <div class="stat-value"> <span id="tasksCompleted">0</span> <span class="stat-trend trend-neutral" id="tasksCompletedTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-project-diagram"></i>Active Projects</div> <div class="stat-value"> <span id="activeProjects">0</span> <span class="stat-trend trend-neutral" id="activeProjectsTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> <div class="stat-card"> <div class="stat-title"><i class="fas fa-calendar-times"></i>Upcoming Deadlines</div> <div class="stat-value"> <span id="upcomingDeadlines">0</span> <span class="stat-trend trend-neutral" id="upcomingDeadlinesTrend"><i class="fas fa-minus"></i> 0%</span> </div> </div> </div> <div class="activity-section"> <div class="section-header"> <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3> <div> <span class="view-all" id="viewAllActivity" style="display: none;">Show All</span> <span class="delete-all" id="deleteAllActivity" style="display: none;">Delete All</span> </div> </div> <ul class="activity-list" id="activityList"> <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li> </ul> </div> </div>
             <div class="content-section" id="profileContent"> <!-- ... Profile Content HTML ... --> <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div> <p class="profile-header-text">Your personal information and account security settings.</p> <div class="profile-avatar-section"> <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark);">Avatar</label> <div id="profileAvatarLarge">ME</div> <button type="button" class="btn btn-outline btn-sm" id="uploadPhotoButton"> <i class="fas fa-upload"></i> Upload Photo </button> <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;"> </div> <form class="data-form" id="profileForm"> <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div> <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div> <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div> <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div> <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div> <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div> <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button> <button type="submit" class="btn btn-primary">Save Changes</button> </div> </form> </div>
             <div class="content-section" id="settingsContent"> <!-- ... Settings Content HTML ... --> <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div> <div class="settings-tabs"> <div class="settings-tab active" data-tab="preferences">Preferences</div> <div class="settings-tab" data-tab="account">Account</div> <div class="settings-tab" data-tab="security">Security</div> <div class="settings-tab" data-tab="notifications">Notifications</div> <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div> <div class="settings-tab" data-tab="collaboration">Collaboration</div> <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div> </div> <div class="settings-panel active" id="preferencesPanel"> <!-- ... Preferences ... --> <h3 class="section-title">Preferences</h3> <form class="data-form" id="preferencesForm"> <div class="form-group"> <label>Theme</label> <div style="display: flex; gap: 1rem; margin-top: 0.5rem;"> <div class="theme-option" data-theme="light"> <div style="background-color: #f1f5f9;"></div> <span>Light</span> </div> <div class="theme-option" data-theme="dark"> <div style="background-color: #0f172a;"></div> <span>Dark</span> </div> <div class="theme-option selected" data-theme="blue"> <div style="background-color: #dbeafe;"></div> <span>Blue</span> </div> </div> <input type="hidden" id="selectedTheme" value="blue"> </div> <div class="form-group"> <label for="layoutDensity">Layout Density</label> <select id="layoutDensity" class="form-control"> <option value="compact">Compact</option> <option value="normal" selected>Normal</option> <option value="spacious">Spacious</option> </select> </div> <div class="form-group"> <label for="language">Language</label> <select id="language" class="form-control"> <option value="en" selected>English</option> <option value="ar">Arabic (Placeholder)</option> <option value="es">Spanish (Placeholder)</option> </select> </div> <div class="form-group"> <label for="dateFormat">Date Format</label> <select id="dateFormat" class="form-control"> <option value="mm/dd/yyyy">MM/DD/YYYY</option> <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option> <option value="yyyy-mm-dd">YYYY-MM-DD</option> </select> </div> <div class="form-group"> <label for="region">Region</label> <input type="text" id="region" class="form-control" placeholder="Cairo (Placeholder)" disabled> </div> <div class="form-group"> <label for="weekStart">Calendar Week Start</label> <select id="weekStart" class="form-control"> <option value="sun" selected>Sunday</option> </select> </div> <div class="form-group" style="grid-column: span 2;"> <label for="defaultHomepage">Default Homepage (Placeholder)</label> <select id="defaultHomepage" class="form-control" disabled> <option selected>Dashboard</option> <option>Tasks</option> <option>Calendar</option> </select> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelPreferencesBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="savePreferencesBtn"> <span class="btn-text">Save Preferences</span> <div class="spinner" id="preferencesSpinner"></div> <span class="loading-text" id="preferencesLoadingText">Saving...</span> </button> </div> </form> </div> <div class="settings-panel" id="accountPanel"> <!-- ... Account ... --> <h3 class="section-title">Account Settings</h3> <form class="data-form" id="accountForm"> <div class="form-group"> <label for="acc_firstName">First Name</label> <input type="text" id="acc_firstName" class="form-control" readonly> </div> <div class="form-group"> <label for="acc_lastName">Last Name</label> <input type="text" id="acc_lastName" class="form-control" readonly> </div> <div class="form-group"> <label for="acc_email">Email</label> <input type="email" id="acc_email" class="form-control" readonly> </div> <div class="form-group"> <label for="timezone">Timezone</label> <select id="timezone" class="form-control"> <option value="utc">UTC</option> <option value="cairo" selected>Cairo (UTC+2)</option> <option value="new_york">New York (UTC-5)</option> </select> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelAccountBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveAccountBtn"> <span class="btn-text">Save Settings</span> <div class="spinner" id="accountSpinner"></div> <span class="loading-text" id="accountLoadingText">Saving...</span> </button> </div> <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"> <label style="color: var(--danger);">Account Deletion</label> <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 1rem;">Permanently delete your account and all associated data. This action cannot be undone.</p> <button type="button" class="btn btn-danger" id="deleteAccountBtn" disabled>Delete Account (Placeholder)</button> </div> </form> </div> <div class="settings-panel" id="securityPanel"> <!-- ... Security ... --> <h3 class="section-title">Security Settings</h3> <form class="data-form" id="securityForm"> <div class="form-group" style="grid-column: span 2;"> <label>Two-Factor Authentication (2FA)</label> <div style="display: flex; align-items: center; gap: 1rem;"> <label class="switch"> <input type="checkbox" id="twoFactorAuth" checked> <span class="slider round"></span> </label> <span>Enabled</span> </div> <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">Requires authentication code from your app upon login.</p> </div> <div class="form-group"> <label for="currentPassword">Current Password</label> <input type="password" id="currentPassword" class="form-control" autocomplete="current-password"> <div class="password-error" id="currentPasswordError">Current password is incorrect</div> </div> <div class="form-group"> <label for="newPassword">New Password</label> <input type="password" id="newPassword" class="form-control" autocomplete="new-password"> <small style="color: var(--gray);">Minimum 8 characters required.</small> </div> <div class="form-group"> <label for="confirmPassword">Confirm New Password</label> <input type="password" id="confirmPassword" class="form-control" autocomplete="new-password"> <div class="password-error" id="passwordMatchError">Passwords do not match</div> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelSecurityBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveSecurityBtn"> <span class="btn-text">Update Password</span> <div class="spinner" id="securitySpinner"></div> <span class="loading-text" id="securityLoadingText">Updating...</span> </button> </div> <div class="form-group" style="grid-column: span 2; margin-top: 2rem;"> <label>Integrations (Placeholders)</label> <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"> <span>Slack Integration</span> <button class="btn btn-outline" disabled>Connect</button> </div> <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0;"> <span>Single Sign-On (SSO)</span> <button class="btn btn-outline" disabled>Configure</button> </div> </div> </form> </div> <div class="settings-panel" id="notificationsPanel"> <!-- ... Notifications ... --> <h3 class="section-title">Notification Settings</h3> <form class="data-form" id="notificationsForm"> <div class="form-group"> <label>Email Notifications</label> <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>Task Assignments & Updates</span> <label class="switch"> <input type="checkbox" id="emailTasks" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>Deadline Reminders</span> <label class="switch"> <input type="checkbox" id="emailDeadlines" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>System Updates & Announcements</span> <label class="switch"> <input type="checkbox" id="emailUpdates"> <span class="slider round"></span> </label> </div> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>Weekly Summary (Placeholder)</span> <label class="switch"> <input type="checkbox" id="emailSummary" disabled> <span class="slider round"></span> </label> </div> </div> </div> <div class="form-group"> <label>In-App Push Notifications</label> <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;"> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>New Messages & Mentions</span> <label class="switch"> <input type="checkbox" id="pushMessages" checked> <span class="slider round"></span> </label> </div> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>Team & Project Updates</span> <label class="switch"> <input type="checkbox" id="pushTeamUpdates"> <span class="slider round"></span> </label> </div> <div style="display: flex; align-items: center; justify-content: space-between;"> <span>Sound Notifications</span> <label class="switch"> <input type="checkbox" id="soundNotifications" checked> <span class="slider round"></span> </label> </div> </div> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" id="cancelNotificationsBtn">Cancel</button> <button type="submit" class="btn btn-primary" id="saveNotificationsBtn"> <span class="btn-text">Save Settings</span> <div class="spinner" id="notificationsSpinner"></div> <span class="loading-text" id="notificationsLoadingText">Saving...</span> </button> </div> </form> </div> <div class="settings-panel" id="teamPanel"> <!-- ... Team ... --> <div class="team-management"> <h3>Team Members</h3> <div class="team-list" id="teamList"> <div style="text-align: center; padding: 2rem; color: var(--gray);">Loading team members...</div> </div> <div class="add-member-form"> <h4>Invite New Member</h4> <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;"> <div class="form-group" style="margin-bottom: 0;"> <label for="inviteMemberEmail">Email</label> <input type="email" id="inviteMemberEmail" class="form-control" placeholder="user@example.com" required> </div> <div class="form-group" style="margin-bottom: 0;"> <label for="inviteMemberRole">Role</label> <select id="inviteMemberRole" class="form-control" required> <option value="member">Member</option> <option value="senior">Senior</option> <option value="supervisor">Supervisor</option> <option value="admin">Admin</option> </select> </div> <div style="grid-column: 1 / -1; margin-top: 1rem;"> <button type="submit" class="btn btn-primary">Send Invite</button> </div> </form> </div> </div> </div> <div class="settings-panel" id="collaborationPanel"> <!-- ... Collaboration ... --> <h3 class="section-title">Collaboration Settings</h3> <form class="data-form" id="collaborationForm"> <div class="form-group" style="grid-column: span 2;"> <label>Shared Calendar Access (Placeholder)</label> <p style="color: var(--gray); font-size: 0.9rem;">Control who can view or edit the team calendar.</p> <button type="button" class="btn btn-outline" disabled>Manage Permissions</button> </div> <div class="form-group" style="grid-column: span 2;"> <label>Team Chat Integration (Placeholder)</label> <p style="color: var(--gray); font-size: 0.9rem;">Connect to your preferred team chat platform.</p> <button type="button" class="btn btn-outline" disabled>Configure Chat</button> </div> <div class="form-actions"> <button type="button" class="btn btn-outline" disabled>Cancel</button> <button type="submit" class="btn btn-primary" disabled>Save Collaboration Settings</button> </div> </form> </div> <div class="settings-panel" id="dangerPanel"> <!-- ... Danger Zone ... --> <h3 class="section-title" style="color: var(--danger);">Danger Zone</h3> <p style="color: var(--gray);">Actions in this section are permanent and cannot be undone. (Visible to Admins only)</p> <div style="margin-top: 1.5rem; border: 1px solid var(--danger); border-radius: 6px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;"> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color: var(--dark);">Delete Team Data (Placeholder)</strong> <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete all projects, tasks, and files associated with this team.</p> </div> <button class="btn btn-danger" disabled>Delete All Team Data</button> </div> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color: var(--dark);">Transfer Ownership (Placeholder)</strong> <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Transfer administrative control of this workspace to another user.</p> </div> <button class="btn btn-warning" disabled>Transfer Ownership</button> </div> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"> <div> <strong style="color: var(--dark);">Delete Workspace (Placeholder)</strong> <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.25rem;">Permanently delete this entire workspace, including all users and data.</p> </div> <button class="btn btn-danger" disabled>Delete Workspace</button> </div> </div> </div>
            </div>

            <!-- 4. Container for Dynamically Loaded Features -->
            <div id="featureSectionsContainer" class="content-section">
                <!-- Content will be loaded here by JS -->
                <div id="featureSections">
                    <div class="placeholder-content" id="featurePlaceholder">
                         <h2 id="featureTitle">Feature Content Area</h2>
                         <p id="featureDescription">Select a feature from the sidebar to view its content.</p>
                         <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                         <div class="error-message" style="display: none;"> Failed to load content. Please try again later. </div>
                     </div>
                </div>
            </div>

        </div> <!-- End of content-area -->
    </main> <!-- End of main-content -->

    <!-- Modals -->
    <div class="notifications-modal" id="notificationsModal"> <!-- ... Notification Modal HTML ... --> <div class="notifications-container"> <div class="notifications-header"> <h3 class="notifications-title">Notifications</h3> <button class="close-notifications" id="closeNotifications">&times;</button> </div> <div class="notifications-body" id="notificationsBody"> <div class="no-notifications-message">Loading notifications...</div> </div> <div class="notifications-footer"> <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button> <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button> </div> </div> </div>
    <div class="confirm-modal" id="confirmModal"> <!-- ... Confirm Modal HTML ... --> <div class="confirm-container"> <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3> <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div> <div class="confirm-actions"> <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button> <button class="btn btn-danger" id="confirmBtn">Confirm</button> </div> </div> </div>

    <script>
        // --- الجزء الأول: تعريف الدوال (قبل استدعاء initDashboard) ---

        // Define initializeEmployeeSchedule globally
        function initializeEmployeeSchedule(user, members) {
            // ... (الكود الكامل لدالة التهيئة من الرد السابق) ...
             console.log("Running initializeEmployeeSchedule..."); const scheduleContainer = document.getElementById('featureSections'); if (!scheduleContainer) { console.error("Schedule container (#featureSections) not found during initialization."); return; } const empModal = scheduleContainer.querySelector('#employeeModal'); const shftModal = scheduleContainer.querySelector('#shiftModal'); const addEmpBtn = scheduleContainer.querySelector('#addEmployeeBtn'); const sendRemindBtn = scheduleContainer.querySelector('#sendRemindersBtn'); const closeEmpModal = scheduleContainer.querySelector('#closeEmployeeModal'); const closeShftModal = scheduleContainer.querySelector('#closeShiftModal'); const cancelEmpBtn = scheduleContainer.querySelector('#cancelEmployeeBtn'); const cancelShftBtn = scheduleContainer.querySelector('#cancelShiftBtn'); const empForm = scheduleContainer.querySelector('#employeeForm'); const shftForm = scheduleContainer.querySelector('#shiftForm'); const shftTypeSelect = scheduleContainer.querySelector('#shiftType'); const customShftGroup = scheduleContainer.querySelector('#customShiftGroup'); const customShftInput = scheduleContainer.querySelector('#customShift'); const delShiftBtn = scheduleContainer.querySelector('#deleteShiftBtn'); const prevWkBtn = scheduleContainer.querySelector('#prevWeekBtn'); const nextWkBtn = scheduleContainer.querySelector('#nextWeekBtn'); const wkDisplay = scheduleContainer.querySelector('#weekDisplay'); const saveSchedBtn = scheduleContainer.querySelector('#saveScheduleBtn'); const schedTableBody = scheduleContainer.querySelector('.schedule-table tbody'); const shftDateInput = scheduleContainer.querySelector('#shiftDate'); const shftEmployeeInput = scheduleContainer.querySelector('#shiftEmployee'); const shftNotesInput = scheduleContainer.querySelector('#shiftNotes'); const editEmpIdInput = scheduleContainer.querySelector('#editingEmpId'); const editDayIdxInput = scheduleContainer.querySelector('#editingDayIndex'); const toast = document.getElementById('toastNotification'); if (!empModal || !shftModal || !addEmpBtn || !schedTableBody || !wkDisplay || !prevWkBtn || !nextWkBtn || !shftForm || !empForm || !shftTypeSelect || !delShiftBtn) { console.error("One or more essential elements for employee schedule not found within #featureSections."); scheduleContainer.innerHTML = `<div class="placeholder-content error-message" style="display:flex;">Error: Failed to initialize schedule interface. Required elements missing. Reloading the page might help.</div>`; return; } let currentScheduleWeekStart = getStartOfWeek(new Date()); let scheduleViewData = {}; let scheduleTeamMembers = members || []; const scheduleUserRole = user?.role || 'employee'; const canManageSchedule = scheduleUserRole === 'admin' || scheduleUserRole === 'supervisor'; addEmpBtn.style.display = canManageSchedule ? 'flex' : 'none'; if(sendRemindBtn) sendRemindBtn.style.display = canManageSchedule ? 'flex' : 'none'; if(saveSchedBtn) saveSchedBtn.style.display = canManageSchedule ? 'flex' : 'none'; function getStartOfWeek(date) { const dt = new Date(date); const day = dt.getDay(); const diff = dt.getDate() - day + (day === 0 ? -6 : 1); return new Date(dt.setDate(diff)); } function formatDateShort(date) { return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } function openScheduleModal(modalElement) { if(modalElement) { modalElement.style.display = 'flex'; setTimeout(() => modalElement.classList.add('active'), 10); } } function closeScheduleModal(modalElement) { if(modalElement) { modalElement.classList.remove('active'); modalElement.style.display = 'none'; } } function updateScheduleWeekDisplay() { const weekEnd = new Date(currentScheduleWeekStart); weekEnd.setDate(weekEnd.getDate() + 6); const startStr = formatDateShort(currentScheduleWeekStart); const endStr = formatDateShort(weekEnd); const year = currentScheduleWeekStart.getFullYear(); wkDisplay.textContent = `${startStr} - ${endStr}, ${year}`; const dateCells = scheduleContainer.querySelectorAll('.schedule-table thead .day-date'); const tempDate = new Date(currentScheduleWeekStart); dateCells.forEach((cell, index) => { cell.textContent = formatDateShort(tempDate); tempDate.setDate(tempDate.getDate() + 1); }); loadScheduleDataForWeek(currentScheduleWeekStart); } function loadScheduleDataForWeek(startDate) { console.log("Loading schedule data for week starting:", startDate.toDateString()); const newScheduleData = {}; const weekOfMonth = Math.floor(startDate.getDate() / 7); scheduleTeamMembers.forEach(emp => { for (let i = 0; i < 7; i++) { const key = `${emp.id}-${i}`; const dayOfWeek = i; let shiftType = 'morning'; let shiftText = '9AM-5PM'; if ((emp.id + dayOfWeek + weekOfMonth) % 5 === 0) { shiftType = 'day-off'; shiftText = 'OFF'; } else if ((emp.id + dayOfWeek + weekOfMonth) % 4 === 0) { shiftType = 'afternoon'; shiftText = '12PM-8PM'; } else if ((emp.id + dayOfWeek + weekOfMonth) % 7 === 0) { shiftType = 'night'; shiftText = '5PM-1AM'; } else if (dayOfWeek >= 5 && Math.random() < 0.4) { shiftType = 'day-off'; shiftText = 'OFF'; } if (Math.random() < 0.03) { shiftType = 'vacation'; shiftText = 'VAC'; } else if (Math.random() < 0.02) { shiftType = 'sick-leave'; shiftText = 'SICK'; } if (shiftType !== 'none') { newScheduleData[key] = { type: shiftType, text: shiftText, notes: '' }; } } }); scheduleViewData = newScheduleData; renderScheduleTable(); } function renderScheduleTable() { schedTableBody.innerHTML = ''; if (scheduleTeamMembers.length === 0) { schedTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 2rem; color: var(--gray);">No team members found.</td></tr>`; return; } scheduleTeamMembers.forEach(emp => { const row = document.createElement('tr'); row.innerHTML = ` <td class="employee-name">${emp.name || emp.email}</td> ${[0, 1, 2, 3, 4, 5, 6].map(dayIndex => { const scheduleKey = `${emp.id}-${dayIndex}`; const shiftInfo = scheduleViewData[scheduleKey]; let shiftHTML = ''; if (shiftInfo) { const shiftClass = `shift-${shiftInfo.type}`; shiftHTML = `<div class="shift ${shiftClass}">${shiftInfo.text || shiftInfo.type}</div>`; } return `<td class="admin-controls ${canManageSchedule ? 'editable' : ''}" data-emp-id="${emp.id}" data-day-index="${dayIndex}"> ${shiftHTML} ${canManageSchedule ? '<span class="edit-shift">(edit)</span>' : ''} </td>`; }).join('')} `; schedTableBody.appendChild(row); }); attachScheduleEditListeners(); } function attachScheduleEditListeners() { scheduleContainer.querySelectorAll('.edit-shift').forEach(button => { const newButton = button.cloneNode(true); button.parentNode.replaceChild(newButton, button); newButton.addEventListener('click', handleScheduleEditClick); }); } function handleScheduleEditClick(event) { const button = event.target; const cell = button.closest('td'); const empId = parseInt(cell.getAttribute('data-emp-id')); const dayIndex = parseInt(cell.getAttribute('data-day-index')); const employee = scheduleTeamMembers.find(e => e.id === empId); if (employee) { const date = new Date(currentScheduleWeekStart); date.setDate(date.getDate() + dayIndex); if(editEmpIdInput) editEmpIdInput.value = empId; if(editDayIdxInput) editDayIdxInput.value = dayIndex; if(shftEmployeeInput) shftEmployeeInput.value = employee.name || employee.email; if(shftDateInput) shftDateInput.value = date.toISOString().split('T')[0]; const scheduleKey = `${empId}-${dayIndex}`; const shiftInfo = scheduleViewData[scheduleKey]; if (shiftInfo) { if(shftTypeSelect) shftTypeSelect.value = shiftInfo.type || 'none'; if(shftNotesInput) shftNotesInput.value = shiftInfo.notes || ''; if (shiftInfo.type === 'custom') { if(customShftInput) customShftInput.value = shiftInfo.text || ''; if(customShftGroup) customShftGroup.style.display = 'block'; } else { if(customShftInput) customShftInput.value = ''; if(customShftGroup) customShftGroup.style.display = 'none'; } } else { if(shftTypeSelect) shftTypeSelect.value = 'none'; if(shftNotesInput) shftNotesInput.value = ''; if(customShftInput) customShftInput.value = ''; if(customShftGroup) customShftGroup.style.display = 'none'; } openScheduleModal(shftModal); } else { console.error("Could not find employee data for ID:", empId); showToast("Error: Could not load shift details.", "danger"); } } prevWkBtn.addEventListener('click', () => { currentScheduleWeekStart.setDate(currentScheduleWeekStart.getDate() - 7); updateScheduleWeekDisplay(); }); nextWkBtn.addEventListener('click', () => { currentScheduleWeekStart.setDate(currentScheduleWeekStart.getDate() + 7); updateScheduleWeekDisplay(); }); addEmpBtn.addEventListener('click', () => { if(empForm) empForm.reset(); openScheduleModal(empModal); }); closeEmpModal.addEventListener('click', () => closeScheduleModal(empModal)); cancelEmpBtn.addEventListener('click', () => closeScheduleModal(empModal)); closeShftModal.addEventListener('click', () => closeScheduleModal(shftModal)); cancelShftBtn.addEventListener('click', () => closeScheduleModal(shftModal)); if(shftTypeSelect) shftTypeSelect.addEventListener('change', function() { if(customShftGroup) customShftGroup.style.display = this.value === 'custom' ? 'block' : 'none'; }); if(saveSchedBtn) saveSchedBtn.addEventListener('click', () => { console.log("Saving schedule data:", scheduleViewData); addActivity('fa-calendar-check', 'Saved the employee schedule.'); showToast('Schedule saved successfully!'); /* Needs actual save logic */ }); if(sendRemindBtn) sendRemindBtn.addEventListener('click', () => { const subject = encodeURIComponent(`Upcoming Work Schedule: ${wkDisplay.textContent}`); let body = `Dear Team,\n\nPlease find your schedule for the week of ${wkDisplay.textContent}.\n\n`; body += `\nBest regards,\n${user.name || 'Management'}`; const recipientEmails = scheduleTeamMembers.map(e => e.email).filter(Boolean).join(','); if (!recipientEmails) { showToast('No employee emails found.', 'warning'); return; } const mailtoLink = `mailto:?bcc=${recipientEmails}&subject=${subject}&body=${encodeURIComponent(body)}`; if (mailtoLink.length > 2000) { showToast('Email content too long for mailto link.', 'warning'); } else { try { window.open(mailtoLink, '_blank'); showToast('Reminder email prepared.'); } catch (error) { showToast('Could not open email client.', 'danger'); } } }); if(empForm) empForm.addEventListener('submit', (e) => { e.preventDefault(); const nameInput = scheduleContainer.querySelector('#empName'); const emailInput = scheduleContainer.querySelector('#empEmail'); const positionInput = scheduleContainer.querySelector('#empPosition'); const roleInput = scheduleContainer.querySelector('#empRole'); const name = nameInput.value.trim(); const email = emailInput.value.trim(); const position = positionInput.value.trim(); const role = roleInput.value; if (!name || !email || !position) { showToast("Please fill all employee details.", "warning"); return; } const newEmployee = { id: Date.now(), name: name, email: email, role: role, position: position, avatar: '', initials: (name.split(' ').map(n => n[0]).join('') || email.substring(0, 2)).toUpperCase() }; teamMembers.push(newEmployee); scheduleTeamMembers = [...teamMembers]; saveData(); loadTeamMembers(); renderScheduleTable(); closeScheduleModal(empModal); showToast(`Employee ${name} added successfully!`); addActivity('fa-user-plus', `Added new team member: ${name} (${email})`); }); if(shftForm) shftForm.addEventListener('submit', (e) => { e.preventDefault(); const empId = parseInt(editEmpIdInput.value); const dayIndex = parseInt(editDayIdxInput.value); const typeValue = shftTypeSelect.value; const customText = customShftInput.value.trim(); const notes = shftNotesInput.value.trim(); const scheduleKey = `${empId}-${dayIndex}`; if (typeValue === 'none') { delete scheduleViewData[scheduleKey]; showToast('Shift cleared.'); } else { let shiftText = ''; const selectedOption = shftTypeSelect.options[shftTypeSelect.selectedIndex]; shiftText = selectedOption.textContent.split('(')[0].trim(); if (typeValue === 'custom') { if (!customText) { showToast('Please enter custom shift details.', 'warning'); return; } shiftText = customText; } scheduleViewData[scheduleKey] = { type: typeValue, text: shiftText, notes: notes }; showToast('Shift updated successfully!'); } renderScheduleTable(); closeScheduleModal(shftModal); console.log("Updated scheduleViewData (needs saving):", scheduleViewData); }); if(delShiftBtn) delShiftBtn.addEventListener('click', () => { const empId = parseInt(editEmpIdInput.value); const dayIndex = parseInt(editDayIdxInput.value); const scheduleKey = `${empId}-${dayIndex}`; if (scheduleViewData[scheduleKey]) { delete scheduleViewData[scheduleKey]; renderScheduleTable(); closeScheduleModal(shftModal); showToast('Shift deleted successfully!', 'danger'); console.log("Deleted shift (needs saving):", scheduleKey); } else { showToast('No shift to delete.', 'warning'); closeScheduleModal(shftModal); } });
            updateScheduleWeekDisplay(); // Initial render
            console.log("Employee Schedule Initialized Successfully within container.");
        } // --- End of initializeEmployeeSchedule ---


        // --- الجزء الثاني: استدعاء الدوال بعد تعريفها ---
        document.addEventListener('DOMContentLoaded', function() {

            // --- تعريف المتغيرات العامة والعناصر الرئيسية ---
            // (نفس تعريفات العناصر والمتغيرات من الرد السابق)
             const sidebar = document.getElementById('sidebar'); const menuItems = document.querySelectorAll('.menu-item'); const searchInput = document.getElementById('searchInput'); const searchResults = document.getElementById('searchResults'); const notificationIcon = document.getElementById('notificationIcon'); const notificationBadge = document.querySelector('.notification-badge'); const notificationsModal = document.getElementById('notificationsModal'); const notificationsBody = document.getElementById('notificationsBody'); const closeNotifications = document.getElementById('closeNotifications'); const markAllReadBtn = document.getElementById('markAllReadBtn'); const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn'); const userAvatar = document.getElementById('userAvatar'); const userProfileDetails = document.querySelector('.user-profile-details'); const userName = document.getElementById('userName'); const userEmail = document.getElementById('userEmail'); const welcomeName = document.getElementById('welcomeName'); const userDropdown = document.getElementById('userDropdown'); const profileLink = document.getElementById('profileLink'); const settingsLink = document.getElementById('settingsLink'); const logoutLink = document.getElementById('logoutLink'); const contentSections = document.querySelectorAll('.content-section'); const dashboardContent = document.getElementById('dashboardContent'); const profileContent = document.getElementById('profileContent'); const settingsContent = document.getElementById('settingsContent'); const featureSectionsContainer = document.getElementById('featureSectionsContainer'); const featureSections = document.getElementById('featureSections'); const featurePlaceholder = document.getElementById('featurePlaceholder'); const activityList = document.getElementById('activityList'); const viewAllActivity = document.getElementById('viewAllActivity'); const deleteAllActivity = document.getElementById('deleteAllActivity'); const settingsTabs = document.querySelectorAll('.settings-tab'); const settingsPanels = document.querySelectorAll('.settings-panel'); const preferencesForm = document.getElementById('preferencesForm'); const accountForm = document.getElementById('accountForm'); const securityForm = document.getElementById('securityForm'); const notificationsForm = document.getElementById('notificationsForm'); const teamList = document.getElementById('teamList'); const inviteMemberForm = document.getElementById('inviteMemberForm'); const themeOptions = document.querySelectorAll('.theme-option'); const layoutDensitySelect = document.getElementById('layoutDensity'); const weekStartSelect = document.getElementById('weekStart'); const confirmModal = document.getElementById('confirmModal'); const confirmTitle = document.getElementById('confirmTitle'); const confirmMessage = document.getElementById('confirmMessage'); const cancelConfirmBtn = document.getElementById('cancelConfirmBtn'); const confirmBtn = document.getElementById('confirmBtn'); const teamMembersCount = document.getElementById('teamMembersCount'); const tasksCompleted = document.getElementById('tasksCompleted'); const activeProjects = document.getElementById('activeProjects'); const upcomingDeadlines = document.getElementById('upcomingDeadlines'); const userInfoRoleTitle = document.getElementById('userInfoRoleTitle'); const backButton = document.getElementById('backButton'); const notificationSound = document.getElementById('notificationSound'); const successMessage = document.getElementById('successMessage'); const successMessageText = document.getElementById('successMessageText'); const profileForm = document.getElementById('profileForm'); const cancelProfileBtn = document.getElementById('cancelProfileBtn'); const profileAvatarInput = document.getElementById('profileAvatarInput'); const profileAvatar = document.getElementById('profileAvatar'); const profileAvatarLarge = document.getElementById('profileAvatarLarge'); const uploadPhotoButton = document.getElementById('uploadPhotoButton'); const cancelPreferencesBtn = document.getElementById('cancelPreferencesBtn'); const cancelAccountBtn = document.getElementById('cancelAccountBtn'); const cancelSecurityBtn = document.getElementById('cancelSecurityBtn'); const cancelNotificationsBtn = document.getElementById('cancelNotificationsBtn'); const currentPasswordInput = document.getElementById('currentPassword'); const newPasswordInput = document.getElementById('newPassword'); const confirmPasswordInput = document.getElementById('confirmPassword'); const currentPasswordError = document.getElementById('currentPasswordError'); const passwordMatchError = document.getElementById('passwordMatchError'); const teamMembersTrend = document.getElementById('teamMembersTrend'); const tasksCompletedTrend = document.getElementById('tasksCompletedTrend'); const activeProjectsTrend = document.getElementById('activeProjectsTrend'); const upcomingDeadlinesTrend = document.getElementById('upcomingDeadlinesTrend'); const soundNotificationsSwitch = document.getElementById('soundNotifications'); const fullNameDisplay = document.getElementById('fullNameDisplay'); const teamSettingsTab = document.getElementById('teamSettingsTab'); const dangerZoneTab = document.getElementById('dangerZoneTab');
             let currentUser = {}; let teamMembers = []; let activities = []; let notifications = []; let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences'; let activityIntervalId = null; let confirmCallback = null; let cancelCallback = null; const MAX_ACTIVITIES_DISPLAYED = 5; const UPDATE_INTERVAL = 60000; const SIMULATED_DELAY = 500; const NEW_ACTIVITY_HIGHLIGHT_DURATION = 2500; const DEFAULT_USER = { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', password: 'password123', preferences: { language: 'en', timezone: 'cairo', dateFormat: 'dd/mm/yyyy', theme: 'blue', layoutDensity: 'normal', soundNotifications: true, weekStart: 'sun' }, notificationPreferences: { email: { tasks: true, deadlines: true, updates: false }, push: { messages: true, teamUpdates: false } }, security: { twoFactorEnabled: true }, stats: { teamMembers: 0, tasksCompleted: 0, activeProjects: 0, upcomingDeadlines: 0, teamMembersTrend: 'neutral', tasksCompletedTrend: 'neutral', activeProjectsTrend: 'neutral', upcomingDeadlinesTrend: 'neutral' } }; const sectionsToLoad = [ 'projects', 'reports-analytics', 'team-members-view', 'file-sharing', 'data-management', 'project-tracking', 'task-management', 'employee-scheduling', 'team-calendar', 'deadline-tracking', 'innovation-hub' ];


            // --- نسخ الدوال هنا (loadData, saveData, etc.) ---
            // ... (نسخ كل تعريفات الدوال من الرد السابق هنا) ...
            function initDashboard() { /* ... */ console.log("Initializing Dashboard..."); if (!localStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn') !== 'true') { const storedUser = JSON.parse(localStorage.getItem('currentUser')); if (!storedUser || !storedUser.email) { console.log("User not logged in, redirecting..."); /*window.location.href = 'login.html';*/ console.warn("Login check bypassed for testing."); /*return;*/ } } loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); handleInitialNavigation(); startActivityTimeUpdater(); setupEventListeners(); }
            function loadData() { /* ... */ console.log("Loading data..."); const storedUser = JSON.parse(localStorage.getItem('currentUser')); currentUser = { ...DEFAULT_USER, ...storedUser }; currentUser.preferences = { ...DEFAULT_USER.preferences, ...(storedUser?.preferences || {}) }; currentUser.notificationPreferences = { email: {}, push: {}, ...DEFAULT_USER.notificationPreferences, ...(storedUser?.notificationPreferences || {}) }; currentUser.notificationPreferences.email = { ...DEFAULT_USER.notificationPreferences.email, ...(storedUser?.notificationPreferences?.email || {}) }; currentUser.notificationPreferences.push = { ...DEFAULT_USER.notificationPreferences.push, ...(storedUser?.notificationPreferences?.push || {}) }; currentUser.security = { ...DEFAULT_USER.security, ...(storedUser?.security || {}) }; currentUser.stats = { ...DEFAULT_USER.stats, ...(storedUser?.stats || {}) }; teamMembers = JSON.parse(localStorage.getItem('teamMembers')) || [{ id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', role: 'admin', avatar: '', initials: 'ME' },{ id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', role: 'supervisor', avatar: '', initials: 'YA' },{ id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', role: 'member', avatar: '', initials: 'EL' },{ id: 4, name: 'Bassant Badr', email: 'bassant@example.com', role: 'member', avatar: '', initials: 'BB' },]; activities = JSON.parse(localStorage.getItem('activities')) || [{ id: Date.now() - 10000, icon: 'fa-user-plus', message: 'Yousef Ahmed was added to the team.', timestamp: new Date(Date.now() - 10000).toISOString() },{ id: Date.now() - 60000 * 5, icon: 'fa-check-circle', message: 'Project Alpha reached milestone 2.', timestamp: new Date(Date.now() - 60000 * 5).toISOString() },{ id: Date.now() - 3600000 * 2, icon: 'fa-file-upload', message: 'Esraa Lashin uploaded "Design Mockups v3".', timestamp: new Date(Date.now() - 3600000 * 2).toISOString() }]; notifications = JSON.parse(localStorage.getItem('notifications')) || [{ id: Date.now() - 20000, icon: 'fa-tasks', message: 'New task "Review PR #123" assigned to you.', timestamp: new Date(Date.now() - 20000).toISOString(), read: false },{ id: Date.now() - 60000 * 10, icon: 'fa-comment', message: 'Yousef Ahmed mentioned you in "Project Beta".', timestamp: new Date(Date.now() - 60000 * 10).toISOString(), read: false },{ id: Date.now() - 86400000, icon: 'fa-calendar-alt', message: 'Team meeting scheduled for tomorrow.', timestamp: new Date(Date.now() - 86400000).toISOString(), read: true }]; console.log("Data loaded."); }
            function saveData() { /* ... */ localStorage.setItem('currentUser', JSON.stringify(currentUser)); localStorage.setItem('teamMembers', JSON.stringify(teamMembers)); localStorage.setItem('activities', JSON.stringify(activities)); localStorage.setItem('notifications', JSON.stringify(notifications)); console.log("Data saved."); }
            function clearUserData() { /* ... */ localStorage.removeItem('currentUser'); localStorage.removeItem('teamMembers'); localStorage.removeItem('activities'); localStorage.removeItem('notifications'); localStorage.removeItem('isLoggedIn'); console.log("User data cleared."); }
            function updateUserUI() { /* ... (نفس الكود من القسم السابق) ... */ const nameParts = currentUser.name ? currentUser.name.split(' ') : ['User']; const firstName = nameParts[0] || ''; const lastName = nameParts.slice(1).join(' ') || ''; userName.textContent = currentUser.name || 'User'; if(userEmail) userEmail.textContent = currentUser.email || 'No Email'; if(welcomeName) welcomeName.textContent = firstName; if(document.querySelector('.user-info-name')) document.querySelector('.user-info-name').textContent = currentUser.name || 'User Name'; const roleTitles = { 'admin': 'Administrator', 'senior': 'Senior', 'supervisor': 'Supervisor', 'member': 'Member' }; const roleTitle = roleTitles[currentUser.role] || 'Member'; if(userInfoRoleTitle) { userInfoRoleTitle.textContent = roleTitle; userInfoRoleTitle.classList.remove('role-admin'); if (currentUser.role === 'admin') { userInfoRoleTitle.classList.add('role-admin'); } } if(document.getElementById('firstName')) document.getElementById('firstName').value = firstName; if(document.getElementById('lastName')) document.getElementById('lastName').value = lastName; if(document.getElementById('jobTitle')) document.getElementById('jobTitle').value = currentUser.title || ''; if(document.getElementById('phone')) document.getElementById('phone').value = currentUser.phone || ''; if(document.getElementById('department')) document.getElementById('department').value = currentUser.department || ''; if(document.getElementById('email')) document.getElementById('email').value = currentUser.email || ''; if(fullNameDisplay) fullNameDisplay.value = currentUser.name || ''; if(document.getElementById('acc_firstName')) document.getElementById('acc_firstName').value = firstName; if(document.getElementById('acc_lastName')) document.getElementById('acc_lastName').value = lastName; if(document.getElementById('acc_email')) document.getElementById('acc_email').value = currentUser.email || ''; const initials = currentUser.initials || (firstName ? firstName[0] : '') + (lastName ? lastName[0] : ''); [userAvatar, profileAvatar, profileAvatarLarge].forEach(el => { if (!el) return; if (currentUser.avatar) { el.style.backgroundImage = `url(${currentUser.avatar})`; el.textContent = ''; el.style.backgroundColor = ''; } else { el.style.backgroundImage = 'none'; el.textContent = initials.toUpperCase(); el.style.backgroundColor = el === profileAvatarLarge ? 'var(--primary-light)' : 'var(--primary)'; el.style.color = el === profileAvatarLarge ? 'var(--primary-dark)' : 'white'; } }); }
            function applyUserPreferences() { /* ... (نفس الكود من القسم السابق) ... */ currentUser.preferences = currentUser.preferences || {}; document.body.className = ''; document.body.classList.add(`${currentUser.preferences?.theme || 'blue'}-theme`); document.body.classList.add(currentUser.preferences?.layoutDensity || 'normal'); themeOptions.forEach(opt => { opt.classList.toggle('selected', opt.dataset.theme === currentUser.preferences?.theme); }); if(layoutDensitySelect) layoutDensitySelect.value = currentUser.preferences?.layoutDensity || 'normal'; loadSettingsFormData(); }
            function applyRBAC() { /* ... (نفس الكود من القسم السابق) ... */ const isAdmin = currentUser.role === 'admin'; const isSupervisor = currentUser.role === 'supervisor'; const canManageTeam = isAdmin || isSupervisor; if (dangerZoneTab) { dangerZoneTab.style.display = isAdmin ? 'flex' : 'none'; dangerZoneTab.classList.toggle('disabled', !isAdmin); if (document.getElementById('dangerPanel')) { document.getElementById('dangerPanel').style.pointerEvents = isAdmin ? 'auto' : 'none'; document.getElementById('dangerPanel').style.opacity = isAdmin ? '1' : '0.6'; } } const deleteAccountBtn = document.getElementById('deleteAccountBtn'); if (deleteAccountBtn) { deleteAccountBtn.disabled = true; } if(teamSettingsTab) { teamSettingsTab.style.display = canManageTeam ? 'flex' : 'none'; teamSettingsTab.classList.toggle('disabled', !canManageTeam); if (document.getElementById('teamPanel')) { document.getElementById('teamPanel').style.pointerEvents = canManageTeam ? 'auto' : 'none'; document.getElementById('teamPanel').style.opacity = canManageTeam ? '1' : '0.6'; } } if(inviteMemberForm) { inviteMemberForm.style.display = canManageTeam ? 'block' : 'none'; } if (deleteAllActivity) deleteAllActivity.style.display = canManageTeam ? 'inline' : 'none'; if (deleteAllNotificationsBtn) deleteAllNotificationsBtn.style.display = canManageTeam ? 'inline-flex' : 'none'; }
            function loadSettingsFormData() { /* ... (نفس الكود من القسم السابق) ... */ if (!settingsContent) return; currentUser.preferences = currentUser.preferences || {}; currentUser.security = currentUser.security || {}; currentUser.notificationPreferences = currentUser.notificationPreferences || { email: {}, push: {} }; currentUser.notificationPreferences.email = currentUser.notificationPreferences.email || {}; currentUser.notificationPreferences.push = currentUser.notificationPreferences.push || {}; if(document.getElementById('selectedTheme')) document.getElementById('selectedTheme').value = currentUser.preferences.theme || 'blue'; if(layoutDensitySelect) layoutDensitySelect.value = currentUser.preferences.layoutDensity || 'normal'; if(document.getElementById('language')) document.getElementById('language').value = currentUser.preferences.language || 'en'; if(document.getElementById('dateFormat')) document.getElementById('dateFormat').value = currentUser.preferences.dateFormat || 'dd/mm/yyyy'; if(weekStartSelect) weekStartSelect.value = currentUser.preferences.weekStart || 'sun'; if(document.getElementById('timezone')) document.getElementById('timezone').value = currentUser.preferences.timezone || 'cairo'; if(document.getElementById('twoFactorAuth')) document.getElementById('twoFactorAuth').checked = currentUser.security.twoFactorEnabled ?? true; if(currentPasswordInput) currentPasswordInput.value = ''; if(newPasswordInput) newPasswordInput.value = ''; if(confirmPasswordInput) confirmPasswordInput.value = ''; if(currentPasswordError) currentPasswordError.style.display = 'none'; if(passwordMatchError) passwordMatchError.style.display = 'none'; if(document.getElementById('emailTasks')) document.getElementById('emailTasks').checked = currentUser.notificationPreferences.email.tasks ?? true; if(document.getElementById('emailDeadlines')) document.getElementById('emailDeadlines').checked = currentUser.notificationPreferences.email.deadlines ?? true; if(document.getElementById('emailUpdates')) document.getElementById('emailUpdates').checked = currentUser.notificationPreferences.email.updates ?? false; if(document.getElementById('pushMessages')) document.getElementById('pushMessages').checked = currentUser.notificationPreferences.push.messages ?? true; if(document.getElementById('pushTeamUpdates')) document.getElementById('pushTeamUpdates').checked = currentUser.notificationPreferences.push.teamUpdates ?? false; if(soundNotificationsSwitch) soundNotificationsSwitch.checked = currentUser.preferences.soundNotifications ?? true; }
            function updateStats() { /* ... (نفس الكود من القسم السابق) ... */ const stats = currentUser.stats || {}; if(teamMembersCount) teamMembersCount.textContent = teamMembers.length; if(tasksCompleted) tasksCompleted.textContent = stats.tasksCompleted ?? 0; if(activeProjects) activeProjects.textContent = stats.activeProjects ?? 0; if(upcomingDeadlines) upcomingDeadlines.textContent = stats.upcomingDeadlines ?? 0; if (currentUser.stats) currentUser.stats.teamMembers = teamMembers.length; if(teamMembersTrend) updateTrendIndicator(teamMembersTrend, stats.teamMembersTrend || 'neutral'); if(tasksCompletedTrend) updateTrendIndicator(tasksCompletedTrend, stats.tasksCompletedTrend || 'neutral'); if(activeProjectsTrend) updateTrendIndicator(activeProjectsTrend, stats.activeProjectsTrend || 'neutral'); if(upcomingDeadlinesTrend) updateTrendIndicator(upcomingDeadlinesTrend, stats.upcomingDeadlinesTrend || 'neutral'); }
            function updateTrendIndicator(element, trend) { /* ... (نفس الكود من القسم السابق) ... */ if(!element) return; trend = trend || 'neutral'; let iconClass = 'fa-minus'; let trendClass = 'trend-neutral'; let percentageValue = Math.floor(Math.random() * (trend === 'up' ? 50 : trend === 'down' ? 30 : 5)) + (trend === 'neutral' ? 0 : 1); let percentage = `${percentageValue}%`; if (trend === 'up') { iconClass = 'fa-arrow-up'; trendClass = 'trend-up'; } else if (trend === 'down') { iconClass = 'fa-arrow-down'; trendClass = 'trend-down'; } else { percentage = '0%'; } element.innerHTML = `<i class="fas ${iconClass}"></i> ${percentage}`; element.className = `stat-trend ${trendClass}`; }
            function updateNotificationBadge() { /* ... (نفس الكود من القسم السابق) ... */ const unreadCount = notifications.filter(n => !n.read).length; if(notificationBadge){ if (unreadCount > 0) { notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount; notificationBadge.style.display = 'flex'; } else { notificationBadge.style.display = 'none'; } } if(deleteAllNotificationsBtn) deleteAllNotificationsBtn.style.display = notifications.length > 0 && (currentUser.role === 'admin' || currentUser.role === 'supervisor') ? 'inline-flex' : 'none'; }
            function getTimeAgo(timestamp) { /* ... (نفس الكود من القسم السابق) ... */ if (!timestamp) return 'Unknown time'; try { const now = new Date(); const date = new Date(timestamp); if (isNaN(date.getTime())) return 'Invalid date'; const seconds = Math.floor((now - date) / 1000); if (seconds < 0) return 'In the future'; let interval = Math.floor(seconds / 31536000); if (interval >= 1) return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); interval = Math.floor(seconds / 2592000); if (interval >= 1) return `${interval} month${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 604800); if (interval >= 1) return `${interval} week${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 86400); if (interval >= 1) return `${interval} day${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 3600); if (interval >= 1) return `${interval} hour${interval === 1 ? '' : 's'} ago`; interval = Math.floor(seconds / 60); if (interval >= 1) return `${interval} min${interval === 1 ? '' : 's'} ago`; return seconds < 10 ? 'Just now' : `${Math.floor(seconds)} secs ago`; } catch (error) { console.error("Error formatting time:", error); return "Error in time"; } }
            function updateActivityTimes() { /* ... (نفس الكود من القسم السابق) ... */ if(activityList) { activityList.querySelectorAll('.activity-time[data-timestamp]').forEach(timeElement => { const timestamp = timeElement.dataset.timestamp; if (timestamp) { timeElement.textContent = getTimeAgo(timestamp); } }); } if(notificationsBody) { notificationsBody.querySelectorAll('.notification-time').forEach(timeElement => { const notificationItem = timeElement.closest('.notification-list-item'); const notificationId = notificationItem?.dataset.id; if (notificationId) { const notification = notifications.find(n => n.id == notificationId); if (notification && notification.timestamp) { timeElement.textContent = getTimeAgo(notification.timestamp); } } }); } }
            function startActivityTimeUpdater() { /* ... (نفس الكود من القسم السابق) ... */ if (activityIntervalId) clearInterval(activityIntervalId); updateActivityTimes(); activityIntervalId = setInterval(updateActivityTimes, UPDATE_INTERVAL); }
            function loadActivities(showAll = false) { /* ... (نفس الكود من القسم السابق مع التحقق من وجود activityList) ... */ if(!activityList) return; activityList.innerHTML = ''; const canDeleteAny = currentUser.role === 'admin' || currentUser.role === 'supervisor'; if (activities.length === 0) { activityList.innerHTML = `<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>`; if(viewAllActivity) viewAllActivity.style.display = 'none'; if(deleteAllActivity) deleteAllActivity.style.display = 'none'; return; } activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const activitiesToShow = showAll ? activities : activities.slice(0, MAX_ACTIVITIES_DISPLAYED); activitiesToShow.forEach(activity => { const li = document.createElement('li'); li.className = 'activity-item'; if (activity.isNew) { li.classList.add('new-activity'); delete activity.isNew; setTimeout(() => { li.classList.remove('new-activity'); }, NEW_ACTIVITY_HIGHLIGHT_DURATION); } li.dataset.id = activity.id; li.innerHTML = ` <div class="activity-icon"><i class="fas ${activity.icon || 'fa-info-circle'}"></i></div> <div class="activity-content"> <div class="activity-message">${activity.message}</div> <div class="activity-time" data-timestamp="${activity.timestamp}">${getTimeAgo(activity.timestamp)}</div> </div> <div class="activity-actions"> ${canDeleteAny ? `<i class="fas fa-trash delete-activity" title="Delete Activity"></i>` : ''} </div> `; activityList.appendChild(li); }); activityList.querySelectorAll('.delete-activity').forEach(button => { button.addEventListener('click', handleDeleteActivityClick); }); if(viewAllActivity) viewAllActivity.style.display = activities.length > MAX_ACTIVITIES_DISPLAYED && !showAll ? 'inline' : 'none'; if(deleteAllActivity) deleteAllActivity.style.display = activities.length > 0 && canDeleteAny ? 'inline' : 'none'; }
            function loadNotifications() { /* ... (نفس الكود من القسم السابق مع التحقق من وجود notificationsBody) ... */ if(!notificationsBody) return; notificationsBody.innerHTML = ''; updateNotificationBadge(); if (notifications.length === 0) { notificationsBody.innerHTML = `<div class="no-notifications-message">No notifications yet.</div>`; return; } const canDeleteAny = currentUser.role === 'admin' || currentUser.role === 'supervisor'; notifications.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); notifications.forEach(notification => { const item = document.createElement('div'); item.className = `notification-list-item ${notification.read ? '' : 'unread'}`; item.dataset.id = notification.id; item.innerHTML = ` <div class="notification-icon-wrapper"><i class="fas ${notification.icon || 'fa-bell'}"></i></div> <div class="notification-content"> <div class="notification-message">${notification.message}</div> <div class="notification-time">${getTimeAgo(notification.timestamp)}</div> </div> ${canDeleteAny ? `<i class="fas fa-trash delete-notification" title="Delete Notification"></i>` : ''} `; item.addEventListener('click', (e) => { if (!e.target.classList.contains('delete-notification')) { markNotificationAsRead(notification.id, item); console.log("Notification clicked:", notification.message); } }); const deleteBtn = item.querySelector('.delete-notification'); if (deleteBtn) { deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteNotificationClick(notification.id); }); } notificationsBody.appendChild(item); }); }
            function markNotificationAsRead(notificationId, itemElement) { /* ... (نفس الكود من القسم السابق) ... */ const notification = notifications.find(n => n.id == notificationId); if (notification && !notification.read) { notification.read = true; saveData(); itemElement.classList.remove('unread'); updateNotificationBadge(); } }
            function handleMarkAllNotificationsRead() { /* ... (نفس الكود من القسم السابق) ... */ let changed = false; notifications.forEach(n => { if (!n.read) { n.read = true; changed = true; } }); if (changed) { saveData(); loadNotifications(); showSuccessMessage('All notifications marked as read.'); } else { showSuccessMessage('No unread notifications.'); } }
            function handleDeleteNotificationClick(notificationId) { /* ... (نفس الكود من القسم السابق) ... */ if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted.'); return; } showConfirmModal({ title: 'Delete Notification?', message: 'Delete this notification?', confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { notifications = notifications.filter(n => n.id != notificationId); saveData(); loadNotifications(); showSuccessMessage('Notification deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleDeleteAllNotifications() { /* ... (نفس الكود من القسم السابق) ... */ if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted.'); return; } if (notifications.length === 0) { showSuccessMessage('No notifications to delete.'); return; } showConfirmModal({ title: 'Delete ALL Notifications?', message: `Delete ALL ${notifications.length} notifications? This cannot be undone.`, confirmText: 'Delete All', confirmClass: 'btn-danger', onConfirm: () => { notifications = []; saveData(); loadNotifications(); showSuccessMessage('All notifications deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function loadTeamMembers() { /* ... (نفس الكود من القسم السابق مع التحقق من وجود teamList) ... */ if(!teamList) return; teamList.innerHTML = ''; const canManage = currentUser.role === 'admin' || currentUser.role === 'supervisor'; const canDelete = currentUser.role === 'admin'; if (teamMembers.length === 0) { teamList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--gray);">No team members yet. Invite one below.</div>`; } else { teamMembers.sort((a,b) => (a.name || '').localeCompare(b.name || '')); teamMembers.forEach(member => { const memberCard = document.createElement('div'); memberCard.className = 'team-member-card'; memberCard.dataset.id = member.id; const canManageThisMember = (canManage && !['admin', 'supervisor'].includes(member.role)) || (isAdmin && member.id !== currentUser.id); const canDeleteThisMember = canDelete && member.id !== currentUser.id; let avatarContent = member.initials || (member.name ? member.name.split(' ').map(n => n[0]).join('').substring(0,2) : member.email.substring(0, 2)).toUpperCase(); let avatarStyle = ''; if (member.avatar) { avatarStyle = `background-image: url(${member.avatar});`; avatarContent = ''; } memberCard.innerHTML = ` <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div> <div class="member-details"> <div class="member-name">${member.name || 'Unnamed Member'}</div> <div class="member-email">${member.email}</div> </div> <div class="member-role role-${member.role || 'member'}"> ${(member.role || 'member').charAt(0).toUpperCase() + (member.role || 'member').slice(1)} </div> <div class="member-actions"> ${canManageThisMember ? `<button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-edit"></i></button>` : ''} ${canDeleteThisMember ? `<button class="btn btn-danger btn-sm delete-member" title="Delete Member"><i class="fas fa-trash"></i></button>` : ''} </div> `; teamList.appendChild(memberCard); }); teamList.querySelectorAll('.edit-member').forEach(btn => btn.addEventListener('click', handleEditMemberClick)); teamList.querySelectorAll('.delete-member').forEach(btn => btn.addEventListener('click', handleDeleteMemberClick)); } updateStats(); }
            function showConfirmModal(config) { /* ... (نفس الكود من القسم السابق) ... */ if(!confirmModal || !confirmTitle || !confirmMessage || !confirmBtn || !cancelConfirmBtn) return; confirmTitle.textContent = config.title || 'Confirm Action'; confirmMessage.innerHTML = config.message || 'Are you sure?'; confirmBtn.textContent = config.confirmText || 'Confirm'; cancelConfirmBtn.textContent = config.cancelText || 'Cancel'; confirmBtn.className = `btn ${config.confirmClass || 'btn-danger'}`; confirmCallback = config.onConfirm || null; cancelCallback = config.onCancel || null; confirmModal.style.display = 'flex'; confirmBtn.focus(); }
            function hideConfirmModal() { /* ... (نفس الكود من القسم السابق) ... */ if(confirmModal) confirmModal.style.display = 'none'; confirmCallback = null; cancelCallback = null; }
            function handleProfileSave(e) { /* ... (نفس الكود من القسم السابق) ... */ e.preventDefault(); showConfirmModal({ title: 'Save Profile Changes?', message: 'Do you want to save the changes made to your profile?', confirmText: 'Save', confirmClass: 'btn-primary', onConfirm: () => { const firstName = document.getElementById('firstName').value.trim(); const lastName = document.getElementById('lastName').value.trim(); currentUser.name = `${firstName} ${lastName}`; currentUser.initials = (firstName ? firstName[0] : '') + (lastName ? lastName[0] : ''); currentUser.title = document.getElementById('jobTitle').value; currentUser.phone = document.getElementById('phone').value; currentUser.department = document.getElementById('department').value; saveData(); updateUserUI(); addActivity('fa-user-edit', 'Updated profile information.'); showSuccessMessage('Profile updated successfully!'); hideConfirmModal(); }, onCancel: () => hideConfirmModal() }); }
            function handleProfileCancel() { /* ... (نفس الكود من القسم السابق) ... */ const firstName = document.getElementById('firstName').value.trim(); const lastName = document.getElementById('lastName').value.trim(); const name = `${firstName} ${lastName}`; const title = document.getElementById('jobTitle').value; const phone = document.getElementById('phone').value; const department = document.getElementById('department').value; const isDirty = name !== currentUser.name || title !== (currentUser.title || '') || phone !== (currentUser.phone || '') || department !== (currentUser.department || ''); if (!isDirty) { setActiveFeature('dashboard'); return; } showConfirmModal({ title: 'Discard Profile Changes?', message: 'Are you sure? Unsaved edits will be lost.', confirmText: 'Discard', confirmClass: 'btn-danger', onConfirm: () => { updateUserUI(); hideConfirmModal(); setActiveFeature('dashboard'); }, onCancel: () => hideConfirmModal() }); }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... (الكود المُعدّل من الرد السابق موجود هنا، تأكد من عدم وجود أخطاء Syntax) ... */ const form = document.getElementById(formId); if (!form) return; const saveButton = form.querySelector('button[type="submit"]'); const spinner = form.querySelector('.spinner'); const loadingText = form.querySelector('.loading-text'); const btnText = form.querySelector('.btn-text'); if(saveButton) saveButton.disabled = true; if(spinner) spinner.style.display = 'inline-block'; if(loadingText) loadingText.style.display = 'inline'; if(btnText) btnText.style.display = 'none'; setTimeout(() => { try { let activityMessage = ''; let valuesToSave = {}; if (panelId === 'preferencesPanel') { currentUser.preferences.theme = document.getElementById('selectedTheme').value; currentUser.preferences.layoutDensity = layoutDensitySelect.value; currentUser.preferences.language = document.getElementById('language').value; currentUser.preferences.dateFormat = document.getElementById('dateFormat').value; currentUser.preferences.weekStart = weekStartSelect.value; valuesToSave = { theme: currentUser.preferences.theme, layoutDensity: currentUser.preferences.layoutDensity, language: currentUser.preferences.language, dateFormat: currentUser.preferences.dateFormat, weekStart: currentUser.preferences.weekStart }; activityMessage = 'Updated preferences settings.'; } else if (panelId === 'accountPanel') { currentUser.preferences.timezone = document.getElementById('timezone').value; valuesToSave = { timezone: currentUser.preferences.timezone }; activityMessage = 'Updated account settings.'; } else if (panelId === 'securityPanel') { currentUser.security = currentUser.security || {}; const original2FA = currentUser.security.twoFactorEnabled; currentUser.security.twoFactorEnabled = document.getElementById('twoFactorAuth').checked; const currentPass = currentPasswordInput.value; const newPass = newPasswordInput.value; const confirmPass = confirmPasswordInput.value; valuesToSave = { twoFactorEnabled: currentUser.security.twoFactorEnabled }; activityMessage = 'Updated security settings.'; currentPasswordError.style.display = 'none'; passwordMatchError.style.display = 'none'; if (newPass || confirmPass || currentPass) { if (!currentPass) { currentPasswordError.textContent = 'Current password is required to change password'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Current password missing.'); } if (currentPass !== currentUser.password) { currentPasswordError.textContent = 'Current password is incorrect'; currentPasswordError.style.display = 'block'; currentPasswordInput.focus(); throw new Error('Incorrect current password.'); } if (!newPass) { passwordMatchError.textContent = 'New password cannot be empty'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password empty.'); } if (newPass.length < 8) { passwordMatchError.textContent = 'New password must be at least 8 characters.'; passwordMatchError.style.display = 'block'; newPasswordInput.focus(); throw new Error('New password too short.'); } if (newPass !== confirmPass) { passwordMatchError.textContent = 'New passwords do not match'; passwordMatchError.style.display = 'block'; confirmPasswordInput.focus(); throw new Error('New passwords do not match.'); } currentUser.password = newPass; activityMessage = 'Changed password.'; valuesToSave.passwordChanged = true; currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; } else if (original2FA !== currentUser.security.twoFactorEnabled) { activityMessage = 'Updated 2FA setting.'; } } else if (panelId === 'notificationsPanel') { currentUser.notificationPreferences = currentUser.notificationPreferences || { email: {}, push: {} }; currentUser.notificationPreferences.email = currentUser.notificationPreferences.email || {}; currentUser.notificationPreferences.push = currentUser.notificationPreferences.push || {}; currentUser.notificationPreferences.email.tasks = document.getElementById('emailTasks').checked; currentUser.notificationPreferences.email.deadlines = document.getElementById('emailDeadlines').checked; currentUser.notificationPreferences.email.updates = document.getElementById('emailUpdates').checked; currentUser.notificationPreferences.push.messages = document.getElementById('pushMessages').checked; currentUser.notificationPreferences.push.teamUpdates = document.getElementById('pushTeamUpdates').checked; currentUser.preferences.soundNotifications = soundNotificationsSwitch.checked; valuesToSave = { emailTasks: currentUser.notificationPreferences.email.tasks, emailDeadlines: currentUser.notificationPreferences.email.deadlines, emailUpdates: currentUser.notificationPreferences.email.updates, pushMessages: currentUser.notificationPreferences.push.messages, pushTeamUpdates: currentUser.notificationPreferences.push.teamUpdates, soundNotifications: currentUser.preferences.soundNotifications }; activityMessage = 'Updated notification settings.'; } console.log(`Saving settings for ${panelId}. Values captured:`, valuesToSave); saveData(); applyUserPreferences(); if (activityMessage) { addActivity('fa-cogs', activityMessage); } showSuccessMessage(successMsg || 'Settings saved successfully!'); } catch (error) { console.error(`Error saving settings for ${panelId}:`, error.message); if (!error.message.includes('password') && !error.message.includes('Current') && !error.message.includes('empty') && !error.message.includes('match')) { showConfirmModal({ title: "Save Error", message: `Could not save settings: ${error.message}`, confirmText: "OK", confirmClass: "btn-primary", onConfirm: hideConfirmModal }); } } finally { if(saveButton) saveButton.disabled = false; if(spinner) spinner.style.display = 'none'; if(loadingText) loadingText.style.display = 'none'; if(btnText) btnText.style.display = 'inline'; } }, SIMULATED_DELAY); }
            function handleSettingsCancel(panelId) { /* ... (نفس الكود من القسم السابق) ... */ showConfirmModal({ title: `Discard ${panelId.replace('Panel', '')} Settings Changes?`, message: 'Are you sure? Any unsaved changes in this section will be lost.', confirmText: 'Discard', confirmClass: 'btn-danger', onConfirm: () => { loadSettingsFormData(); applyUserPreferences(); hideConfirmModal(); }, onCancel: () => hideConfirmModal() }); }
            function handleInviteMember(e) { /* ... (نفس الكود من القسم السابق) ... */ e.preventDefault(); const emailInput = document.getElementById('inviteMemberEmail'); const roleSelect = document.getElementById('inviteMemberRole'); const email = emailInput.value.trim(); const role = roleSelect.value; if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('Please enter a valid email address.'); emailInput.focus(); return; } if (teamMembers.some(member => member.email.toLowerCase() === email.toLowerCase())) { alert('A team member with this email already exists.'); emailInput.focus(); return; } if (role === 'admin' && currentUser.role !== 'admin') { alert('Only Administrators can invite other Administrators.'); roleSelect.focus(); return; } if (currentUser.role === 'supervisor' && (role === 'admin' || role === 'supervisor')) { alert('Supervisors cannot invite Administrators or other Supervisors.'); roleSelect.focus(); return; } const fakeInviteToken = `sim_token_${Date.now()}`; const fakeInviteLink = `${window.location.origin}/register.html?token=${fakeInviteToken}`; console.log('--- SIMULATING INVITE ---'); console.log('To:', email); console.log('Role:', role); console.log('Invite Link (Fake):', fakeInviteLink); console.log('--- END SIMULATION ---'); addActivity('fa-paper-plane', `${currentUser.name} sent an invite to ${email} as a ${role}.`); const newMember = { id: Date.now(), name: email.split('@')[0], email: email, role: role, avatar: '', initials: email.substring(0, 2).toUpperCase() }; teamMembers.push(newMember); saveData(); loadTeamMembers(); showSuccessMessage(`Invitation sent to ${email}.`); inviteMemberForm.reset(); }
            function handleEditMemberClick(e) { /* ... (نفس الكود من القسم السابق) ... */ const card = e.target.closest('.team-member-card'); if(!card) return; const memberId = parseInt(card.dataset.id); const member = teamMembers.find(m => m.id === memberId); if (!member) return; const newName = prompt(`Enter new name for ${member.email}:`, member.name || ''); let newRole = member.role; const isAdmin = currentUser.role === 'admin'; const isSupervisor = currentUser.role === 'supervisor'; let canChangeRole = false; let allowedRolesPrompt = ''; if (isAdmin && member.id !== currentUser.id) { canChangeRole = true; allowedRolesPrompt = 'member, senior, supervisor, admin'; } else if (isSupervisor && !['admin', 'supervisor'].includes(member.role)) { canChangeRole = true; allowedRolesPrompt = 'member, senior'; } if (canChangeRole) { const promptedRole = prompt(`Enter new role (${allowedRolesPrompt}):`, member.role); if (promptedRole !== null) { const cleanRole = promptedRole.trim().toLowerCase(); if (allowedRolesPrompt.split(', ').includes(cleanRole)) { newRole = cleanRole; } else { alert('Invalid role entered or permission denied. Keeping original role.'); } } } else if (member.id !== currentUser.id) { alert("You don't have permission to change this member's role."); } if (newName !== null) { member.name = newName.trim() || 'Unnamed Member'; member.role = newRole; member.initials = (member.name.split(' ').map(n => n[0]).join('').substring(0, 2) || member.email.substring(0, 2)).toUpperCase(); saveData(); loadTeamMembers(); addActivity('fa-user-edit', `Updated details for team member: ${member.email}`); showSuccessMessage('Team member updated.'); } }
            function handleDeleteMemberClick(e) { /* ... (نفس الكود من القسم السابق) ... */ const card = e.target.closest('.team-member-card'); if(!card) return; const memberId = parseInt(card.dataset.id); const member = teamMembers.find(m => m.id === memberId); if (!member) return; if (currentUser.role !== 'admin') { alert('Only administrators can delete team members.'); return; } if (member.id === currentUser.id) { alert("You cannot delete your own account from the team list."); return; } showConfirmModal({ title: 'Delete Team Member?', message: `Remove <strong>${member.name || member.email}</strong> from the team? This cannot be undone.`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { const memberEmail = member.email; teamMembers = teamMembers.filter(m => m.id !== memberId); saveData(); loadTeamMembers(); addActivity('fa-user-minus', `Removed team member: ${memberEmail}`); addNotification('fa-user-minus', `Team member removed: ${memberEmail}`); showSuccessMessage('Team member deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleDeleteActivityClick(e) { /* ... (نفس الكود من القسم السابق) ... */ const listItem = e.target.closest('.activity-item'); if(!listItem) return; const activityId = parseInt(listItem.dataset.id); if (!activityId) return; if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted to Admins/Supervisors.'); return; } showConfirmModal({ title: 'Delete Activity?', message: `Delete this activity record?`, confirmText: 'Delete', confirmClass: 'btn-danger', onConfirm: () => { activities = activities.filter(a => a.id !== activityId); saveData(); loadActivities(viewAllActivity?.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); showSuccessMessage('Activity deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            function handleDeleteAllActivities() { /* ... (نفس الكود من القسم السابق) ... */ if (currentUser.role !== 'admin' && currentUser.role !== 'supervisor') { alert('Deletion restricted to Admins/Supervisors.'); return; } if (activities.length === 0) { showSuccessMessage('No activities to delete.'); return; } showConfirmModal({ title: 'Delete ALL Activities?', message: `Delete ALL ${activities.length} activity records? This cannot be undone.`, confirmText: 'Delete All', confirmClass: 'btn-danger', onConfirm: () => { activities = []; saveData(); loadActivities(); showSuccessMessage('All activities deleted.'); hideConfirmModal(); }, onCancel: hideConfirmModal }); }
            // *** الدالة المعدلة هنا ***
            function handleAvatarUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { alert('Please select an image file.'); return; }
                if (file.size > 2 * 1024 * 1024) { alert('Image size must be less than 2MB.'); return; }

                const reader = new FileReader(); // تم التأكد من وجودها بشكل صحيح

                reader.onload = function(event) {
                    const imageUrl = event.target.result;
                    showConfirmModal({ // <-- بداية كائن الإعدادات
                        title: 'Update Profile Picture?',
                        message: '<img src="'+imageUrl+'" alt="Preview" style="max-width:100px; max-height:100px; border-radius:50%; margin-bottom:1rem; display:block; margin-left:auto; margin-right:auto;">Set this image as your profile picture?',
                        confirmText: 'Set Picture',
                        confirmClass: 'btn-primary',
                        onConfirm: () => {
                            currentUser.avatar = imageUrl;
                            saveData();
                            updateUserUI();
                            addActivity('fa-camera', 'Changed profile picture.');
                            showSuccessMessage('Profile picture updated.');
                            hideConfirmModal();
                        }, // <-- فاصلة
                        onCancel: () => {
                            if(profileAvatarInput) profileAvatarInput.value = null;
                            hideConfirmModal();
                        } // <-- لا فاصلة
                    }); // <-- نهاية استدعاء showConfirmModal
                }; // *** <-- نهاية دالة reader.onload ***

                reader.onerror = function() {
                    alert('Error reading file.');
                }; // <-- نهاية دالة reader.onerror

                reader.readAsDataURL(file);
            }
            function handleLogout() { /* ... (نفس الكود من القسم السابق) ... */ showConfirmModal({ title: 'Logout?', message: 'Are you sure you want to log out?', confirmText: 'Logout', confirmClass: 'btn-danger', onConfirm: () => { showSuccessMessage("Logging out..."); clearUserData(); setTimeout(() => { window.location.href = 'login.html'; }, 500); }, onCancel: hideConfirmModal }); }
            function addActivity(icon, message) { /* ... (نفس الكود من القسم السابق) ... */ const newActivity = { id: Date.now(), icon: icon, message: message, timestamp: new Date().toISOString(), isNew: true }; activities.push(newActivity); activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); if (currentFeature === 'dashboard') { loadActivities(viewAllActivity?.style.display === 'none' && activities.length > MAX_ACTIVITIES_DISPLAYED); } saveData(); }
            function addNotification(icon, message) { /* ... (نفس الكود من القسم السابق) ... */ const newNotification = { id: Date.now(), icon: icon, message: message, timestamp: new Date().toISOString(), read: false }; notifications.unshift(newNotification); saveData(); updateNotificationBadge(); if (notificationsModal?.style.display === 'flex') { loadNotifications(); } if (currentUser.preferences?.soundNotifications) { playNotificationSound(); } }
            function playNotificationSound() { /* ... (نفس الكود من القسم السابق) ... */ if (notificationSound && typeof notificationSound.play === 'function') { notificationSound.currentTime = 0; notificationSound.play().catch(e => { console.warn('Notification sound play failed (maybe user interaction needed first):', e); }); } }
            function showSuccessMessage(message) { /* ... (نفس الكود من القسم السابق) ... */ if(!successMessage || !successMessageText) return; successMessageText.textContent = message; successMessage.classList.add('show'); setTimeout(() => { successMessage.classList.remove('show'); }, 3000); }
            function handleSearch() { /* ... (نفس الكود من القسم السابق) ... */ if(!searchInput || !searchResults) return; const searchTerm = searchInput.value.toLowerCase().trim(); searchResults.innerHTML = ''; searchResults.classList.remove('active'); if (searchTerm.length < 2) return; const matchingUsers = teamMembers.filter(m => (m.name || '').toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm) ); const matchingActivities = activities.filter(a => a.message.toLowerCase().includes(searchTerm) ); searchResults.classList.add('active'); if (matchingUsers.length === 0 && matchingActivities.length === 0) { searchResults.innerHTML = `<div class="search-result-item" style="color: var(--gray);">No results found for "${searchInput.value}"</div>`; return; } if (matchingUsers.length > 0) { const userHeader = document.createElement('div'); userHeader.innerHTML = '<strong>Team Members</strong>'; userHeader.style.cssText = 'padding: 0.5rem 1rem 0.25rem; font-size: 0.8rem; color: var(--gray);'; searchResults.appendChild(userHeader); matchingUsers.slice(0, 3).forEach(user => { const item = document.createElement('div'); item.className = 'search-result-item'; item.innerHTML = `<i class="fas fa-user" style="margin-right: 0.5rem; color: var(--primary);"></i> ${user.name} (${user.email})`; item.onclick = () => { setActiveFeature('settings', 'team'); const memberCard = teamList.querySelector(`.team-member-card[data-id="${user.id}"]`); if (memberCard) { setTimeout(() => { memberCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); memberCard.style.transition = 'background-color 0.3s ease-out'; memberCard.style.backgroundColor = 'var(--primary-light)'; setTimeout(() => { memberCard.style.backgroundColor = ''; }, 1500); }, 100); } searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(item); }); } if (matchingActivities.length > 0) { const activityHeader = document.createElement('div'); activityHeader.innerHTML = '<strong>Recent Activities</strong>'; activityHeader.style.cssText = 'padding: 0.5rem 1rem 0.25rem; font-size: 0.8rem; color: var(--gray); margin-top: 0.5rem;'; searchResults.appendChild(activityHeader); matchingActivities.slice(0, 3).forEach(activity => { const item = document.createElement('div'); item.className = 'search-result-item'; item.innerHTML = `<i class="fas ${activity.icon || 'fa-info-circle'}" style="margin-right: 0.5rem; color: var(--secondary);"></i> ${activity.message.substring(0, 50)}...`; item.onclick = () => { setActiveFeature('dashboard'); const activityElement = activityList.querySelector(`.activity-item[data-id="${activity.id}"]`); if (activityElement) { setTimeout(() => { activityElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); activityElement.style.transition = 'background-color 0.3s ease-out'; activityElement.style.backgroundColor = 'var(--primary-light)'; setTimeout(() => { activityElement.style.backgroundColor = ''; }, 1500); }, 100); } searchResults.classList.remove('active'); searchInput.value = ''; }; searchResults.appendChild(item); }); } }
            function setActiveFeature(featureId, settingsTab = null) { /* ... (الكود المعدل مع console.log من الرد السابق) ... */ console.clear(); console.log(`%c---> setActiveFeature START | Feature: ${featureId} | Tab: ${settingsTab}`, "color: blue; font-weight: bold;"); if (!featureId) { console.warn("setActiveFeature called with null/empty featureId. Defaulting to 'dashboard'."); featureId = 'dashboard'; } if (featureId === 'settings') { const targetTab = settingsTab || currentSettingsTab || 'preferences'; console.log(`Settings Check: Target Tab = ${targetTab}`); if (targetTab === 'danger' && currentUser.role !== 'admin') { console.warn("Access denied to Danger Zone."); showConfirmModal({ title: "Access Denied", message: "Only administrators can access the Danger Zone.", confirmText: "OK", confirmClass:"btn-primary", onConfirm: hideConfirmModal}); settingsTab = 'preferences'; if (currentFeature === 'settings') { activateSettingsTab(settingsTab); console.log(`%c---> setActiveFeature END (Settings Tab Fallback)`, "color: orange; font-weight: bold;"); return; } } currentSettingsTab = targetTab; } else { currentSettingsTab = null; } currentFeature = featureId; let hash = `#${featureId}`; if (featureId === 'settings' && currentSettingsTab) { hash += `-${currentSettingsTab}`; } console.log(`Updating URL Hash to: ${hash}`); if (window.location.hash !== hash) { if(featureId === 'settings' && window.location.hash.startsWith('#settings-')) { history.replaceState({ feature: featureId, tab: currentSettingsTab }, '', hash); } else { history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash); } console.log("URL Hash updated."); } else { console.log("URL Hash already matches."); } console.log("Updating sidebar active item..."); menuItems.forEach(item => item.classList.remove('active')); const activeMenuItem = document.querySelector(`.menu-item[data-feature="${featureId}"]`); if (activeMenuItem) { activeMenuItem.classList.add('active'); console.log(`Sidebar item for '${featureId}' activated.`); } else { console.warn(`Sidebar item for '${featureId}' not found. Highlighting dashboard.`); const dashboardItem = document.querySelector('.menu-item[data-feature="dashboard"]'); if(dashboardItem) dashboardItem.classList.add('active'); } console.log("Hiding all content sections..."); const allSections = document.querySelectorAll('.content-section'); if (allSections.length === 0) console.warn("No '.content-section' elements found!"); allSections.forEach((section, index) => { section.classList.remove('active'); }); console.log("All sections hidden."); const dashboardSection = document.getElementById('dashboardContent'); const profileSection = document.getElementById('profileContent'); const settingsSection = document.getElementById('settingsContent'); const featureContainer = document.getElementById('featureSectionsContainer'); const featureContentDiv = document.getElementById('featureSections'); const placeholder = document.getElementById('featurePlaceholder'); const loadingIndicator = placeholder?.querySelector('.loading-indicator'); const errorMsg = placeholder?.querySelector('.error-message'); const featureTitleEl = placeholder?.querySelector('#featureTitle'); const featureDescEl = placeholder?.querySelector('#featureDescription'); if (!dashboardSection || !profileSection || !settingsSection || !featureContainer || !featureContentDiv || !placeholder) { console.error("CRITICAL ERROR: One or more main content layout containers are missing from the DOM!"); alert("Layout Error! Cannot display content."); console.log(`%c---> setActiveFeature END (Critical Layout Error)`, "color: red; font-weight: bold;"); return; } if (featureId === 'dashboard') { console.log(`Activating built-in section: dashboard`); dashboardSection.classList.add('active'); updateStats(); loadActivities(); console.log("Dashboard section activated."); } else if (featureId === 'profile') { console.log(`Activating built-in section: profile`); profileSection.classList.add('active'); updateUserUI(); console.log("Profile section activated."); } else if (featureId === 'settings') { console.log(`Activating built-in section: settings (tab: ${currentSettingsTab || 'preferences'})`); settingsSection.classList.add('active'); applyRBAC(); activateSettingsTab(currentSettingsTab || 'preferences'); console.log("Settings section activated."); } else if (sectionsToLoad.includes(featureId)) { console.log(`Activating dynamic section container for: ${featureId}`); featureContainer.classList.add('active'); featureContentDiv.innerHTML = ''; featureContentDiv.appendChild(placeholder); if(featureTitleEl) featureTitleEl.textContent = `Loading ${featureId.replace(/-/g, ' ')}...`; if(featureDescEl) featureDescEl.textContent = 'Fetching content, please wait.'; if(loadingIndicator) loadingIndicator.style.display = 'block'; if(errorMsg) errorMsg.style.display = 'none'; placeholder.style.display = 'flex'; const filePath = `sections/${featureId}.html`; console.log(`Fetching from: ${filePath}`); fetch(filePath) .then(response => { console.log(`Fetch response status for ${featureId}: ${response.status} ${response.statusText}`); if (!response.ok) { if(response.status === 404) { throw new Error(`File not found at '${filePath}'. Check path/filename.`); } else { throw new Error(`Could not load file (${response.status}). Server: ${response.statusText}`); } } return response.text(); }) .then(html => { console.log(`Successfully fetched content for ${featureId}. Length: ${html.length}`); if (!html.trim()) { console.warn("Fetched HTML content is empty!"); throw new Error("Loaded file is empty."); } featureContentDiv.innerHTML = html; placeholder.style.display = 'none'; console.log("HTML injected into #featureSections."); if (featureId === 'employee-scheduling') { if (typeof initializeEmployeeSchedule === 'function') { console.log(`Calling initializeEmployeeSchedule for ${featureId}...`); try { initializeEmployeeSchedule( JSON.parse(JSON.stringify(currentUser || DEFAULT_USER)), JSON.parse(JSON.stringify(teamMembers || [])) ); console.log(`initializeEmployeeSchedule finished successfully for ${featureId}.`); } catch (err) { console.error(`Error executing initializeEmployeeSchedule:`, err); if(featureTitleEl) featureTitleEl.textContent = `Error Initializing ${featureId.replace(/-/g, ' ')}`; if(featureDescEl) featureDescEl.textContent = `Content loaded, but script failed. Check console. Error: ${err.message}`; if(loadingIndicator) loadingIndicator.style.display = 'none'; if(errorMsg) errorMsg.style.display = 'block'; featureContentDiv.innerHTML = ''; featureContentDiv.appendChild(placeholder); placeholder.style.display = 'flex'; } } else { console.warn(`initializeEmployeeSchedule function NOT FOUND for ${featureId}. Content may not be interactive.`); /* Optionally display warning */ } } }) .catch(error => { console.error(`Fetch ERROR for ${featureId}:`, error); if(featureTitleEl) featureTitleEl.textContent = `Error Loading ${featureId.replace(/-/g, ' ')}`; if(featureDescEl) featureDescEl.textContent = `Failed to load content. ${error.message}`; if(loadingIndicator) loadingIndicator.style.display = 'none'; if(errorMsg) errorMsg.style.display = 'block'; featureContentDiv.innerHTML = ''; featureContentDiv.appendChild(placeholder); placeholder.style.display = 'flex'; }); } else { console.warn(`Fallback: Unknown feature or section not defined: '${featureId}'. Activating dashboard.`); dashboardSection.classList.add('active'); if(window.location.hash !== '#dashboard') history.pushState({ feature: 'dashboard', tab: null }, '', '#dashboard'); const activeItem = document.querySelector('.menu-item.active'); if(activeItem) activeItem.classList.remove('active'); const dashboardMenuItem = document.querySelector('.menu-item[data-feature="dashboard"]'); if(dashboardMenuItem) dashboardMenuItem.classList.add('active'); } if(backButton) backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none'; window.scrollTo(0, 0); console.log(`%c---> setActiveFeature END | Feature: ${featureId}`, "color: green; font-weight: bold;"); }
            function activateSettingsTab(tabId) { /* ... (نفس الكود من القسم السابق) ... */ if (!settingsContent || !settingsTabs.length || !settingsPanels.length) return; if (tabId === 'danger' && currentUser.role !== 'admin') { console.warn("Attempted to switch to Danger Zone without admin rights."); activateSettingsTab('preferences'); return; } currentSettingsTab = tabId; settingsTabs.forEach(t => { t.classList.remove('active'); if (!t.classList.contains('disabled') && t.dataset.tab === tabId) { t.classList.add('active'); } }); settingsPanels.forEach(p => { p.classList.toggle('active', p.id === `${tabId}Panel`); }); if (currentFeature === 'settings' && window.location.hash !== `#settings-${tabId}`) { history.replaceState({ feature: 'settings', tab: tabId }, '', `#settings-${tabId}`); } if (tabId === 'team') { loadTeamMembers(); } else if (tabId === 'account') { updateUserUI(); } else if (['preferences', 'security', 'notifications'].includes(tabId)) { loadSettingsFormData(); } }
            function handleInitialNavigation() { /* ... (نفس الكود من القسم السابق) ... */ const hash = window.location.hash.substring(1); let featureId = 'dashboard'; let settingsTab = null; if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; const potentialTab = hash.split('-')[1]; if (document.getElementById(`${potentialTab}Panel`)) { settingsTab = potentialTab; } else { settingsTab = 'preferences'; } } else { const validFeature = [...menuItems].some(item => item.dataset.feature === hash); if (validFeature || hash === 'profile') { featureId = hash; } } } console.log(`Initial navigation check: Feature=${featureId}, Tab=${settingsTab}`); setActiveFeature(featureId, settingsTab); }
            function setupEventListeners() { /* ... (الكود المُعدّل والمبسط من الرد السابق) ... */ console.log("Setting up event listeners..."); document.querySelectorAll('.menu-item').forEach(item => { item.addEventListener('click', (e) => { e.preventDefault(); const feature = item.dataset.feature; if (feature) { console.log(`Menu item clicked: ${feature}`); setActiveFeature(feature); } else { console.warn("Menu item clicked without data-feature:", item); } }); }); if(backButton) backButton.addEventListener('click', () => { console.log("Back button clicked"); setActiveFeature('dashboard'); }); window.addEventListener('popstate', (event) => { console.log("Popstate event triggered:", event.state); if (event.state && event.state.feature) { setActiveFeature(event.state.feature, event.state.tab); } else { handleInitialNavigation(); } }); if(searchInput) { searchInput.addEventListener('input', handleSearch); searchInput.addEventListener('focus', handleSearch); } document.addEventListener('click', (e) => { if (searchResults && !e.target.closest('.search-bar')) { searchResults.classList.remove('active'); searchResults.innerHTML = ''; } if (userDropdown && !e.target.closest('.user-profile')) { userDropdown.classList.remove('active'); } if (notificationsModal && notificationsModal.style.display === 'flex' && !e.target.closest('.notifications-container') && !e.target.closest('.notification-icon')) { closeScheduleModal(notificationsModal); } }); if(userAvatar) userAvatar.addEventListener('click', (e) => { e.stopPropagation(); userDropdown?.classList.toggle('active'); }); if(userProfileDetails) userProfileDetails.addEventListener('click', (e) => { e.stopPropagation(); userDropdown?.classList.toggle('active'); }); if(profileLink) profileLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown?.classList.remove('active'); setActiveFeature('profile'); }); if(settingsLink) settingsLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown?.classList.remove('active'); setActiveFeature('settings'); }); if(logoutLink) logoutLink.addEventListener('click', (e) => { e.preventDefault(); userDropdown?.classList.remove('active'); handleLogout(); }); if(notificationIcon) notificationIcon.addEventListener('click', () => { if(notificationsModal) { notificationsModal.style.display = 'flex'; loadNotifications(); } }); if(closeNotifications) closeNotifications.addEventListener('click', () => closeScheduleModal(notificationsModal)); if(markAllReadBtn) markAllReadBtn.addEventListener('click', handleMarkAllNotificationsRead); if(deleteAllNotificationsBtn) deleteAllNotificationsBtn.addEventListener('click', handleDeleteAllNotifications); if(viewAllActivity) viewAllActivity.addEventListener('click', () => loadActivities(true)); if(deleteAllActivity) deleteAllActivity.addEventListener('click', handleDeleteAllActivities); if(profileForm) profileForm.addEventListener('submit', handleProfileSave); if(cancelProfileBtn) cancelProfileBtn.addEventListener('click', handleProfileCancel); if(uploadPhotoButton) uploadPhotoButton.addEventListener('click', () => profileAvatarInput?.click()); if(profileAvatarInput) profileAvatarInput.addEventListener('change', handleAvatarUpload); if(settingsTabs) { settingsTabs.forEach(tab => { tab.addEventListener('click', () => { if (!tab.classList.contains('disabled')) { activateSettingsTab(tab.dataset.tab); } }); }); } if(preferencesForm) preferencesForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('preferencesForm', 'preferencesPanel', 'Preferences saved.'); }); if(cancelPreferencesBtn) cancelPreferencesBtn.addEventListener('click', () => handleSettingsCancel('preferencesPanel')); if(accountForm) accountForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('accountForm', 'accountPanel', 'Account settings saved.'); }); if(cancelAccountBtn) cancelAccountBtn.addEventListener('click', () => handleSettingsCancel('accountPanel')); if(securityForm) securityForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('securityForm', 'securityPanel', 'Security settings updated.'); }); if(cancelSecurityBtn) cancelSecurityBtn.addEventListener('click', () => handleSettingsCancel('securityPanel')); if(notificationsForm) notificationsForm.addEventListener('submit', (e) => { e.preventDefault(); handleSettingsSave('notificationsForm', 'notificationsPanel', 'Notification settings saved.'); }); if(cancelNotificationsBtn) cancelNotificationsBtn.addEventListener('click', () => handleSettingsCancel('notificationsPanel')); if(themeOptions) { themeOptions.forEach(option => { option.addEventListener('click', function() { const theme = this.dataset.theme; if(document.getElementById('selectedTheme')) document.getElementById('selectedTheme').value = theme; themeOptions.forEach(opt => opt.classList.remove('selected')); this.classList.add('selected'); document.body.className = ''; document.body.classList.add(`${theme}-theme`); const currentDensity = layoutDensitySelect ? layoutDensitySelect.value : 'normal'; document.body.classList.add(currentDensity); applyRBAC(); }); }); } if(layoutDensitySelect) { layoutDensitySelect.addEventListener('change', function() { const density = this.value; document.body.classList.remove('compact', 'normal', 'spacious'); document.body.classList.add(density); const currentTheme = [...themeOptions].find(opt => opt.classList.contains('selected'))?.dataset.theme || 'blue'; document.body.classList.add(`${currentTheme}-theme`); applyRBAC(); }); } if(inviteMemberForm) inviteMemberForm.addEventListener('submit', handleInviteMember); if(confirmBtn) confirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); }); if(cancelConfirmBtn) cancelConfirmBtn.addEventListener('click', () => { if (cancelCallback) cancelCallback(); hideConfirmModal(); }); if(confirmModal) confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideConfirmModal(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && confirmModal?.style.display === 'flex') { hideConfirmModal(); } }); console.log("Event listeners setup completed."); }

            // --- بدء تشغيل الداشبورد ---
            initDashboard();

        }); // End of DOMContentLoaded
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (Head content as before) ... -->
    <title>TeamFlow | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <!-- ... other links ... -->
    <style>
        /* ... (ALL CSS from dash1.html) ... */
    </style>
</head>
<body class="blue-theme">
    <!-- ... (Audio, Success Message, Sidebar HTML, Main Content HTML, Top Nav HTML) ... -->
    <!-- ... (Content Area HTML including static sections and feature container) ... -->
    <!-- ... (Modals HTML) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CORE DASHBOARD ELEMENTS & STATE (Define ALL const first)---
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-section:not(#featureSections)');
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featureSections = document.getElementById('featureSections');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const teamList = document.getElementById('teamList'); // Ensure this exists if used
            const backButton = document.getElementById('backButton');
            // ... Add ALL OTHER dashboard element consts here ...
            let confirmBtn = document.getElementById('confirmBtn'); // Use let for re-assignment
            let cancelConfirmBtn = document.getElementById('cancelConfirmBtn'); // Use let for re-assignment

            // --- State Variables ---
            let currentUser = {}; let teamMembers = []; let activities = []; let notifications = [];
            let currentFeature = 'dashboard'; let currentSettingsTab = 'preferences';
            let scheduleLogicInitialized = false; let scheduleCurrentWeekStart = null; let scheduleSavedData = {};
            const scheduleLocalStorageKey = 'employeeSchedule_May2025_final';
            const DEFAULT_USER = { /* ... */ }; // Keep definition

            // ============================================================
            // === DEFINE ALL FUNCTIONS BEFORE CALLING ANY OF THEM ===
            // ============================================================

            // --- CORE DASHBOARD HELPER FUNCTIONS ---
            function setPlaceholderState(state, title = '', description = '') { /* ... */ }
            function showConfirmModal(config) { /* ... */ }
            function hideConfirmModal() { /* ... */ }
            function showSuccessMessage(message) { /* ... */ }
            function addActivity(icon, message) { /* ... */ }
            const dashboardGlobals = { showConfirmModal, hideConfirmModal, showSuccessMessage, showErrorMessage: (msg) => showConfirmModal({title:"Error", message:msg, confirmText:"OK", confirmClass:"btn-warning", cancelText:""}), addActivity, getCurrentUser: () => JSON.parse(JSON.stringify(currentUser || {})), getTeamMembers: () => JSON.parse(JSON.stringify(teamMembers || [])), updateTeamMembers: (newTeam) => {if(Array.isArray(newTeam)){teamMembers=newTeam; saveData(); loadTeamMembers(); updateStats();}} };
            window.dashboardApp = dashboardGlobals;
            function loadData() { /* ... (Original loadData) ... */ }
            function saveData() { /* ... (Original saveData) ... */ }
            function updateUserUI() { /* ... (Original updateUserUI) ... */ }
            function applyUserPreferences() { /* ... (Original applyUserPreferences) ... */ }
            function applyRBAC() { /* ... (Original applyRBAC) ... */ }
            function loadSettingsFormData() { /* ... (Original loadSettingsFormData) ... */ }
            function updateStats() { /* ... (Original updateStats) ... */ }
            function updateTrendIndicator(element, trend) { /* ... (Original updateTrendIndicator) ... */ }
            function updateNotificationBadge() { /* ... (Original updateNotificationBadge) ... */ }
            function loadActivities(showAll = false) { /* ... (Original loadActivities) ... */ }
            function loadNotifications() { /* ... (Original loadNotifications) ... */ }
            function getTimeAgo(timestamp) { /* ... (Original getTimeAgo) ... */ }
            function updateActivityTimes() { /* ... (Original updateActivityTimes) ... */ }
            function startActivityTimeUpdater() { /* ... (Original startActivityTimeUpdater) ... */ }
            function loadTeamMembers() { /* ... (Original loadTeamMembers, ensure teamList check) ... */ }
            function handleProfileSave(e) { /* ... (Original handleProfileSave) ... */ }
            function handleProfileCancel() { /* ... (Original handleProfileCancel) ... */ }
            function handleSettingsSave(formId, panelId, successMsg) { /* ... (Original handleSettingsSave) ... */ }
            function handleSettingsCancel(panelId) { /* ... (Original handleSettingsCancel) ... */ }
            function handleInviteMember(e) { /* ... (Original handleInviteMember) ... */ }
            function handleEditMemberClick(e) { /* ... (Original handleEditMemberClick) ... */ }
            function handleDeleteMemberClick(e) { /* ... (Original handleDeleteMemberClick) ... */ }
            function handleDeleteActivityClick(e) { /* ... (Original handleDeleteActivityClick) ... */ }
            function handleDeleteAllActivities() { /* ... (Original handleDeleteAllActivities) ... */ }
            function markNotificationAsRead(notificationId, itemElement) { /* ... (Original markNotificationAsRead) ... */ }
            function handleMarkAllNotificationsRead() { /* ... (Original handleMarkAllNotificationsRead) ... */ }
            function handleDeleteNotificationClick(notificationId) { /* ... (Original handleDeleteNotificationClick) ... */ }
            function handleDeleteAllNotifications() { /* ... (Original handleDeleteAllNotifications) ... */ }
            function handleAvatarUpload(e) { /* ... (Original handleAvatarUpload) ... */ }
            function handleLogout() { /* ... (Original handleLogout) ... */ }
            function addNotification(icon, message) { /* ... (Original addNotification) ... */ }
            function playNotificationSound() { /* ... (Original playNotificationSound) ... */ }
            function handleSearch() { /* ... (Original handleSearch) ... */ }
            function activateSettingsTab(tabId) { /* ... (Original activateSettingsTab) ... */ }

            // --- EMPLOYEE SCHEDULING FUNCTIONS (Define them here) ---
            function formatDateKey_schedule(date) { /* ... */ }
            function getLocalDateFromKey_schedule(dateKey) { /* ... */ }
            function updateWeekDisplay_schedule() { /* ... */ }
            function renderScheduleTable_schedule() { /* ... (Ensure it calls setupDynamicScheduleListeners_schedule at the end) ... */ }
            function updateShiftDisplayUI_schedule(/*...*/) { /* ... */ }
            function handleWeekChange_schedule(direction) { /* ... */ }
            function handleAddEmployeeClick_schedule() { /* ... */ }
            function handleSendRemindersClick_schedule() { /* ... */ }
            function handleSaveScheduleClick_schedule() { /* ... */ }
            function handleEmployeeFormSubmit_schedule(e) { /* ... */ }
            function handleEditShiftClick_schedule(event) { /* ... */ }
            function handleShiftFormSubmit_schedule(e) { /* ... */ }
            function handleDeleteShiftClick_schedule() { /* ... */ }
            function setupDynamicScheduleListeners_schedule() { /* ... */ } // Listener for dynamic buttons
            const shiftTypeChangeHandler_schedule = (e) => { /* ... */ }; // Define handler
             const editShiftKeydownHandler_schedule = (e) => { /* ... */ }; // Define handler

            // --- Main Schedule Initializer (Called by setActiveFeature) ---
             function initializeScheduleFeature_integrated() {
                 if (scheduleLogicInitialized) { /* ... re-render only ... */ return; }
                 console.log("--- Initializing Employee Scheduling Feature (Integrated) ---");
                 scheduleLogicInitialized = true;
                 // ... (Set schedule state: currentUserState, employeesState, isAdmin) ...
                 // ... (Load scheduleSavedData from localStorage) ...
                 // ... (Set initial scheduleCurrentWeekStart) ...
                 try {
                     console.log("Running initial schedule UI setup...");
                     updateWeekDisplay_schedule();
                     renderScheduleTable_schedule(); // Renders table and calls setupDynamicScheduleListeners_schedule
                     // Setup *static* listeners for the schedule section ONCE
                     setupScheduleEventListeners_schedule_static();
                     // Show/hide admin buttons
                      const addEmpBtn=document.getElementById('schedule-addEmployeeBtn'); const sendRemBtn=document.getElementById('schedule-sendRemindersBtn'); const saveBtn=document.getElementById('schedule-saveScheduleBtn');
                      const scheduleIsAdminOrSupervisor = currentUser.role === 'admin' || currentUser.role === 'supervisor';
                      if (scheduleIsAdminOrSupervisor) { if(addEmpBtn) addEmpBtn.style.display='inline-flex'; if(sendRemBtn) sendRemBtn.style.display='inline-flex'; if(saveBtn) saveBtn.style.display='inline-flex'; }
                      else { if(addEmpBtn) addEmpBtn.style.display='none'; if(sendRemBtn) sendRemBtn.style.display='none'; if(saveBtn) saveBtn.style.display='none'; }

                     console.log("--- Employee Scheduling Feature Initialized (Integrated) ---");
                 } catch(error) { /* ... error handling ... */ }
            }

            // --- Setup STATIC Schedule Event Listeners (Called only ONCE by initializeScheduleFeature_integrated) ---
             function setupScheduleEventListeners_schedule_static() {
                 console.log("Setting up STATIC schedule listeners (modals, forms, nav)...");
                 // Assign listeners to elements that exist once in the loaded HTML
                 document.getElementById('schedule-prevWeekBtn')?.addEventListener('click', () => handleWeekChange_schedule(-1));
                 document.getElementById('schedule-nextWeekBtn')?.addEventListener('click', () => handleWeekChange_schedule(1));
                 document.getElementById('schedule-addEmployeeBtn')?.addEventListener('click', handleAddEmployeeClick_schedule);
                 document.getElementById('schedule-sendRemindersBtn')?.addEventListener('click', handleSendRemindersClick_schedule);
                 document.getElementById('schedule-saveScheduleBtn')?.addEventListener('click', handleSaveScheduleClick_schedule);
                 // Modals
                 document.getElementById('schedule-closeEmployeeModal')?.addEventListener('click', () => { document.getElementById('schedule-employeeModal').style.display = 'none'; });
                 document.getElementById('schedule-cancelEmployeeBtn')?.addEventListener('click', () => { document.getElementById('schedule-employeeModal').style.display = 'none'; });
                 document.getElementById('schedule-employeeForm')?.addEventListener('submit', handleEmployeeFormSubmit_schedule);
                 document.getElementById('schedule-employeeModal')?.addEventListener('click', (e) => { if (e.target.id === 'schedule-employeeModal') e.target.style.display = 'none'; });
                 document.getElementById('schedule-closeShiftModal')?.addEventListener('click', () => { document.getElementById('schedule-shiftModal').style.display = 'none'; });
                 document.getElementById('schedule-cancelShiftBtn')?.addEventListener('click', () => { document.getElementById('schedule-shiftModal').style.display = 'none'; });
                 document.getElementById('schedule-shiftForm')?.addEventListener('submit', handleShiftFormSubmit_schedule);
                 document.getElementById('schedule-deleteShiftBtn')?.addEventListener('click', handleDeleteShiftClick_schedule);
                 document.getElementById('schedule-shiftType')?.addEventListener('change', shiftTypeChangeHandler_schedule);
                 document.getElementById('schedule-shiftModal')?.addEventListener('click', (e) => { if (e.target.id === 'schedule-shiftModal') e.target.style.display = 'none'; });
                 console.log("STATIC schedule listeners attached.");
             }


            // --- setActiveFeature (Loads HTML, calls initializer) ---
            function setActiveFeature(featureId, settingsTab = null) {
                 console.log(`setActiveFeature: ${featureId}`);
                 if (currentFeature === 'employee-scheduling' && featureId !== 'employee-scheduling') { scheduleLogicInitialized = false; console.log("Reset schedule init flag."); }
                 currentFeature = featureId; currentSettingsTab = settingsTab || (featureId === 'settings' ? currentSettingsTab : null);
                 let hash = `#${featureId}`; if (featureId === 'settings' && currentSettingsTab) hash += `-${currentSettingsTab}`;
                 if (window.location.hash !== hash) history.pushState({ feature: featureId, tab: currentSettingsTab }, '', hash);
                 menuItems.forEach(item => item.classList.remove('active')); document.querySelector(`.menu-item[data-feature="${featureId}"]`)?.classList.add('active');
                 contentSections.forEach(section => section.classList.remove('active')); featureSectionsContainer.style.display = 'none';

                 if (featureId === 'dashboard' || featureId === 'profile' || featureId === 'settings') {
                     const staticSection = document.getElementById(`${featureId}Content`);
                     if (staticSection) { staticSection.classList.add('active'); /* ... updates ... */ } setPlaceholderState('hidden');
                 } else {
                     featureSectionsContainer.style.display = 'block'; featureSections.innerHTML = ''; featureSections.appendChild(featurePlaceholder); setPlaceholderState('loading', `Loading ${featureId}...`);
                     const htmlFilePath = `sections/${featureId}.html`;
                     fetch(htmlFilePath)
                         .then(response => { if (!response.ok) throw new Error(`HTTP ${response.status}`); return response.text(); })
                         .then(html => {
                             featureSections.innerHTML = html; featureSections.classList.add('active'); setPlaceholderState('hidden');
                             // Initialize after loading HTML
                             if (featureId === 'employee-scheduling') {
                                 // **Crucially, pass the CURRENT data from the main scope**
                                 initializeScheduleFeature_integrated(); // Call the integrated function
                             }
                             // else if (featureId === 'other') { initializeOtherFeature(); }
                         })
                         .catch(error => { console.error(`Error loading ${featureId}:`, error); setPlaceholderState('error', `Error Loading ${featureId}`, `Could not load. ${error.message}`); });
                 }
                 backButton.style.display = featureId !== 'dashboard' ? 'inline-flex' : 'none'; window.scrollTo(0, 0);
            }

            // --- handleInitialNavigation (Defined BEFORE initDashboard) ---
            function handleInitialNavigation() {
                 const hash = window.location.hash.substring(1); let featureId = 'dashboard'; let settingsTab = null;
                 if (hash) { if (hash.startsWith('settings-')) { featureId = 'settings'; settingsTab = hash.split('-')[1] || 'preferences'; } else { const vf = [...menuItems].some(i=>i.dataset.feature===hash) || hash === 'profile'; if(vf) featureId=hash; } }
                 console.log(`Initial navigation: feature='${featureId}', tab='${settingsTab}'`);
                 setActiveFeature(featureId, settingsTab); // Load initial content
            }


            // --- INIT DASHBOARD (Defined, calls the now-defined handleInitialNavigation) ---
             function initDashboard() {
                 loadData(); updateUserUI(); loadTeamMembers(); loadActivities(); loadNotifications(); updateStats(); applyUserPreferences(); applyRBAC(); setupEventListeners();
                 handleInitialNavigation(); // CALL handleInitialNavigation HERE
                 startActivityTimeUpdater();
                 console.log("Dashboard Initialized");
             }

             // --- Setup Core Event Listeners (Defined) ---
             function setupEventListeners() {
                  console.log("Setting up CORE dashboard listeners...");
                  menuItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); setActiveFeature(item.dataset.feature); }));
                  backButton.addEventListener('click', () => setActiveFeature('dashboard'));
                  window.addEventListener('popstate', (event) => { if (event.state?.feature) { setActiveFeature(event.state.feature, event.state.tab); } else { handleInitialNavigation(); } });
                  // ... (ALL other original dashboard event listeners MUST BE defined here) ...
                   const profileForm = document.getElementById('profileForm'); if (profileForm) profileForm.addEventListener('submit', handleProfileSave);
                   // ... etc ...
                  console.log("CORE dashboard listeners attached.");
             }

            // ============================================================
            // === RUN INITIALIZATION (At the very end) ===
            // ============================================================
            initDashboard();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

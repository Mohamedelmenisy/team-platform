   <!-- ... (rest of your HTML body remains the same up to the script tag) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = document.getElementById('featureTitle');
            const featureDescEl = document.getElementById('featureDescription');
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const editMemberModal = document.getElementById('editMemberModal');
            const editMemberForm = document.getElementById('editMemberForm');

            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            // --- Schedule Specific State (GLOBAL for persistence) ---
            let currentScheduleWeekOffset = 0; // Will be calculated in initDashboard
            let scheduleMinWeekOffset = 0;     // Will be calculated in initDashboard
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }


            // --- Mock Data ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'YA', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'EL', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', title: 'Junior Designer', department: 'Design', phone: '+20155444333', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Nada Mahmoud', email: 'nada@example.com', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'NM', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            const MOCK_TASKS = [
                { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
            ];

            // --- Initialization ---
            function initDashboard() {
                // Simulate loading current user (using the first mock user)
                currentUser = { ...MOCK_USERS[0] }; // Use a copy
                console.log("Initializing dashboard for:", currentUser.name);

                // Calculate initial schedule offsets *before* first render attempt
                calculateAndSetScheduleOffsets();

                applyStoredPreferences(); // Apply theme, contrast etc. *before* other UI updates
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Navigate based on URL hash first
                startDynamicUpdates(); // Start intervals for data refresh
                setupResponsiveSidebar();
            }

             // --- Schedule Offset Calculation (needs to be global scope) ---
             function calculateAndSetScheduleOffsets() {
                const today = new Date();
                const mayFirst2025 = new Date(2025, 4, 1); // May 1st
                mayFirst2025.setHours(0, 0, 0, 0);

                // Get Sunday of the current week
                const currentDayOfWeek = today.getDay(); // 0=Sun
                const diffToSunday = today.getDate() - currentDayOfWeek;
                const startOfCurrentWeek = new Date(today);
                startOfCurrentWeek.setDate(diffToSunday);
                startOfCurrentWeek.setHours(0, 0, 0, 0);

                // Get Sunday of the week containing May 1st, 2025
                const mayFirstDayOfWeek = mayFirst2025.getDay();
                const diffToMayFirstSunday = mayFirst2025.getDate() - mayFirstDayOfWeek;
                const startOfMayFirstWeek = new Date(mayFirst2025);
                startOfMayFirstWeek.setDate(diffToMayFirstSunday);
                startOfMayFirstWeek.setHours(0, 0, 0, 0);

                const msPerDay = 24 * 60 * 60 * 1000;
                const weeksDifference = Math.round((startOfMayFirstWeek.getTime() - startOfCurrentWeek.getTime()) / (7 * msPerDay));

                console.log(`Current Week Start (Sun): ${startOfCurrentWeek.toDateString()}`);
                console.log(`Target Week Start (Sun of May 1st): ${startOfMayFirstWeek.toDateString()}`);
                console.log(`Calculated initial week offset: ${weeksDifference}`);

                // Store both the initial offset and the minimum allowed offset in GLOBAL state
                currentScheduleWeekOffset = weeksDifference;
                scheduleMinWeekOffset = weeksDifference; // This week is the minimum allowed
            }

            // --- UI Updates ---
            function updateUserUI() {
                if (!currentUser) return;

                // Top Nav User Menu
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.initials;
                 if (currentUser.avatar) {
                    document.getElementById('userAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                    document.getElementById('userAvatar').textContent = ''; // Clear initials if avatar exists
                } else {
                    document.getElementById('userAvatar').style.backgroundImage = 'none';
                    document.getElementById('userAvatar').textContent = currentUser.initials;
                }

                // Welcome Section
                document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('userInfoName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = currentUser.initials;
                if (currentUser.avatar) {
                    document.getElementById('profileAvatar').style.backgroundImage = `url(${currentUser.avatar})`;
                     document.getElementById('profileAvatar').textContent = '';
                } else {
                    document.getElementById('profileAvatar').style.backgroundImage = 'none';
                    document.getElementById('profileAvatar').textContent = currentUser.initials;
                }

                // User Role Title
                const roleTitle = document.getElementById('userInfoRoleTitle');
                roleTitle.textContent = formatRole(currentUser.role);
                roleTitle.className = `user-info-title role-${currentUser.role}`; // Apply role class

                // Profile Page Elements
                updateProfileForm();
                profileAvatarLarge.textContent = currentUser.initials;
                if (currentUser.avatar) {
                    profileAvatarLarge.style.backgroundImage = `url(${currentUser.avatar})`;
                     profileAvatarLarge.textContent = '';
                } else {
                    profileAvatarLarge.style.backgroundImage = 'none';
                    profileAvatarLarge.textContent = currentUser.initials;
                }
                // Update Account panel email display
                if (accountEmailDisplay) accountEmailDisplay.value = currentUser.email;


                // Admin specific elements
                const teamSettingsTab = document.getElementById('teamSettingsTab');
                const dangerZoneTab = document.getElementById('dangerZoneTab');
                 if (currentUser.role === 'admin') {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'flex'; // Use flex for tabs
                    if (dangerZoneTab) dangerZoneTab.style.display = 'flex';
                } else {
                    if (teamSettingsTab) teamSettingsTab.style.display = 'none';
                     if (dangerZoneTab) dangerZoneTab.style.display = 'none';
                     // Hide team panel if not admin and trying to access it directly
                     if (currentFeature === 'settings' && currentSettingsTab === 'team') {
                         activateSettingsTab('preferences'); // Default to preferences
                     }
                     if (currentFeature === 'settings' && currentSettingsTab === 'danger') {
                         activateSettingsTab('preferences');
                     }
                }

                // Update 2FA UI based on current user status
                update2FA_UI();
                userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
            }

            function updateProfileForm() {
                if (!currentUser) return;
                const nameParts = currentUser.name.split(' ');
                firstNameInput.value = nameParts[0] || '';
                lastNameInput.value = nameParts.slice(1).join(' ') || '';
                fullNameDisplay.value = currentUser.name; // Update readonly full name
                jobTitleInput.value = currentUser.title || '';
                emailDisplay.value = currentUser.email || '';
                phoneInput.value = currentUser.phone || '';
                departmentInput.value = currentUser.department || '';
            }

            function formatRole(role) {
                if (!role) return 'Member';
                return role.charAt(0).toUpperCase() + role.slice(1); // Capitalize first letter
            }

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() {
                // Theme
                const storedTheme = localStorage.getItem('theme') || 'system'; // Default to system
                setTheme(storedTheme);

                // Contrast
                const storedContrast = localStorage.getItem('highContrast') === 'true';
                setContrast(storedContrast);
                if (highContrastToggle) highContrastToggle.checked = storedContrast;

                // Language
                const storedLang = localStorage.getItem('language') || 'en';
                if (languageSelect) languageSelect.value = storedLang;
                applyLanguage(storedLang);

                 // Region/Timezone (Just set the dropdown)
                 const storedRegion = localStorage.getItem('region') || 'utc';
                 if (regionSelect) regionSelect.value = storedRegion;

                // Date/Time Format
                const storedTimeFormat = localStorage.getItem('timeFormat') || '12h';
                const storedDateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                if (timeFormatSelect) timeFormatSelect.value = storedTimeFormat;
                if (dateFormatSelect) dateFormatSelect.value = storedDateFormat;
                applyDateTimeFormat(storedTimeFormat, storedDateFormat);

                 // Toast Notifications
                const storedToastPref = localStorage.getItem('showToasts');
                // Default to true if not set
                showToasts = storedToastPref === null ? true : (storedToastPref === 'true');
                if (toastToggle) toastToggle.checked = showToasts;

                // Sound Notifications
                const storedSoundPref = localStorage.getItem('playSounds');
                playSounds = storedSoundPref === null ? true : (storedSoundPref === 'true');
                if (soundToggle) soundToggle.checked = playSounds;

            }

            function setTheme(theme) {
                 console.log("Setting theme:", theme);
                 document.body.classList.remove('light-theme', 'dark-theme'); // Remove existing theme classes

                 if (theme === 'system') {
                    // Use matchMedia to detect system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.classList.add(prefersDark ? 'dark-theme' : 'light-theme');
                 } else {
                     document.body.classList.add(`${theme}-theme`);
                 }

                 // Update selection state in UI
                 themeOptions.forEach(option => {
                     option.classList.toggle('selected', option.dataset.theme === theme);
                 });

                 localStorage.setItem('theme', theme); // Save preference
            }

            function setContrast(enabled) {
                 console.log("Setting high contrast:", enabled);
                 document.body.classList.toggle('high-contrast', enabled);
                 localStorage.setItem('highContrast', enabled);
            }

             function applyLanguage(lang) {
                 console.log("Applying language:", lang);
                 // --- Simulation ---
                 // In a real app, this would trigger loading translation files
                 // and updating all text elements. Here, we just update a few examples.
                 document.documentElement.lang = lang; // Set HTML lang attribute

                 if (lang === 'ar') {
                     document.body.dir = 'rtl'; // Basic RTL support
                     if (document.getElementById('welcomeName')) document.getElementById('welcomeName').textContent = "مستخدم"; // Example
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "لوحة التحكم";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "الإعدادات";
                     // Update more labels as needed for simulation
                 } else {
                     document.body.dir = 'ltr';
                      // Revert to English if needed (assuming English is the base)
                      if (document.getElementById('welcomeName') && currentUser) document.getElementById('welcomeName').textContent = currentUser.name.split(' ')[0];
                     if (document.querySelector('[data-feature="dashboard"] span')) document.querySelector('[data-feature="dashboard"] span').textContent = "Dashboard";
                     if (document.querySelector('[data-feature="settings"] span')) document.querySelector('[data-feature="settings"] span').textContent = "Settings";
                 }
                 localStorage.setItem('language', lang);
                 // --- End Simulation ---
             }

             function applyDateTimeFormat(timeFormat, dateFormat) {
                console.log("Applying DateTime Format:", timeFormat, dateFormat);
                // Store preferences for use by formatting functions
                localStorage.setItem('timeFormat', timeFormat);
                localStorage.setItem('dateFormat', dateFormat);
                // Re-render any visible dates/times if needed (e.g., activity list)
                if (currentFeature === 'dashboard' && activityList.children.length > 0 && activities.length > 0) {
                    loadRecentActivities(showingAllActivities);
                }
                if (currentFeature === 'dashboard' && notifications.length > 0) {
                    renderNotifications(); // Refresh notifications too
                }
                 // Re-render schedule if visible AND its init function exists
                 if (currentFeature === 'employee-scheduling' && typeof initializeEmployeeScheduleLogic === 'function') {
                    // We can't directly call renderSchedule as it might not be loaded.
                    // The best approach is to reload the feature content which will re-initialize.
                    // Or, if the schedule JS is guaranteed to be loaded, call a specific update function.
                    // Let's stick to reloading for simplicity here, although less efficient.
                    console.log("Date/Time format changed, reloading schedule feature if active.");
                    loadFeatureContent('employee-scheduling'); // Reload the feature
                 }
             }

             function applyToastPreference(enabled) {
                 console.log("Applying toast preference:", enabled);
                 showToasts = enabled;
                 localStorage.setItem('showToasts', enabled);
             }

             function applySoundPreference(enabled) {
                 console.log("Applying sound preference:", enabled);
                 playSounds = enabled;
                 localStorage.setItem('playSounds', enabled);
             }


            // --- Navigation & Content Loading ---
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) {
                console.log(`Navigating to: ${featureId}` + (settingsTab ? ` / Tab: ${settingsTab}` : ''));
                currentFeature = featureId;

                // Update Menu Items
                menuItems.forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-feature') === featureId);
                });

                // Hide all top-level content sections first
                contentSections.forEach(section => section.classList.remove('active'));

                // Reset feature container styles and content
                featureSectionsContainer.classList.remove('employee-scheduling'); // Remove specific feature classes
                featureSectionsContainer.innerHTML = ''; // Clear dynamic content
                featurePlaceholder.style.display = 'flex'; // Show placeholder by default
                featureLoadingEl.style.display = 'none';
                featureErrorEl.style.display = 'none';
                // Add placeholder back to the container temporarily
                featureSectionsContainer.appendChild(featurePlaceholder);


                // Show the correct section
                let targetSection = null;
                let isFeatureSection = false;

                if (featureId === 'dashboard') {
                    targetSection = dashboardContent;
                    backButton.style.display = 'none';
                } else if (featureId === 'profile') {
                    targetSection = profileContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                     updateProfileForm(); // Ensure form has latest data when navigating here
                } else if (featureId === 'settings') {
                    targetSection = settingsContent;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';
                    currentSettingsTab = settingsTab || (currentUser.role === 'admin' ? 'preferences' : 'preferences'); // Default tab
                    // Ensure non-admins don't land on restricted tabs
                     if (currentUser.role !== 'admin' && (currentSettingsTab === 'team' || currentSettingsTab === 'danger')) {
                         currentSettingsTab = 'preferences';
                     }
                    activateSettingsTab(currentSettingsTab);
                     update2FA_UI(); // Ensure 2FA UI is correct when settings are shown
                } else {
                    // Handle other features - load into feature container
                    isFeatureSection = true;
                    targetSection = featureSectionsContainer;
                    backButton.style.display = 'flex';
                    backButtonText.textContent = 'Back to Dashboard';

                    // Load content for the feature
                    loadFeatureContent(featureId);
                }

                // Activate the target section (dashboard, profile, settings, or feature container)
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                // If it was a feature section, the placeholder inside might still be visible until content loads
                if (isFeatureSection) {
                    featurePlaceholder.style.display = 'none'; // Hide placeholder now that container is active
                }

                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-active');
                    if(closeSidebar) closeSidebar.style.display = 'none';
                }

                // Close user dropdown if open
                userDropdown.classList.remove('active');
                userDropdownOpen = false;


                if (!skipHistory) {
                    updateBrowserHistory(featureId, featureId === 'settings' ? currentSettingsTab : null);
                }
            }

            function activateSettingsTab(tabId) {
                console.log(`Activating settings tab: ${tabId}`);
                currentSettingsTab = tabId; // Update state

                // Update tabs visual state
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
                });

                // Update panels visibility
                document.querySelectorAll('.settings-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.id === `${tabId}Panel`);
                });

                // Load team list if team tab is activated
                if (tabId === 'team' && currentUser.role === 'admin') {
                     loadTeamMembers();
                }
                 // Update 2FA UI if security tab is activated
                 if (tabId === 'security') {
                     update2FA_UI();
                 }
                 // Update Account panel email if account tab is activated
                 if (tabId === 'account' && accountEmailDisplay) {
                     accountEmailDisplay.value = currentUser.email;
                 }
            }

             // ==================================================
             // MODIFIED: Load Feature Content Dynamically
             // ==================================================
             async function loadFeatureContent(featureId) {
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';

                 // Show loading state immediately
                 featureSectionsContainer.innerHTML = ''; // Clear previous content
                 featureSectionsContainer.appendChild(featurePlaceholder); // Add placeholder back
                 featurePlaceholder.style.display = 'flex';
                 featureTitleEl.textContent = ''; // Clear placeholder title/desc
                 featureDescEl.textContent = '';
                 featureErrorEl.style.display = 'none';
                 featureLoadingEl.style.display = 'block'; // Show loading indicator
                 featureSectionsContainer.classList.remove('employee-scheduling'); // Reset specific classes


                 console.log(`Loading content for: ${featureName}`);

                 try {
                     let htmlPath = '';
                     let jsPath = '';
                     let initFunctionName = '';
                     let needsInit = false;

                     // --- Define paths and init functions for known features ---
                     if (featureId === 'employee-scheduling') {
                         htmlPath = 'employee-scheduling.html';
                         jsPath = 'employee-scheduling.js';
                         initFunctionName = 'initializeEmployeeScheduleLogic';
                         needsInit = true;
                         featureSectionsContainer.classList.add('employee-scheduling'); // Add scope class
                     }
                     // --- Add other features here ---
                     // else if (featureId === 'projects') {
                     //    htmlPath = 'projects.html';
                     //    jsPath = 'projects.js';
                     //    initFunctionName = 'initializeProjects';
                     //    needsInit = true;
                     // }
                     else {
                         // --- Default for unimplemented features ---
                         featureLoadingEl.style.display = 'none';
                         featureTitleEl.textContent = featureName;
                         featureDescEl.textContent = `Content for ${featureName} would be loaded here. This feature is not yet implemented.`;
                         console.log(`Feature ${featureId} is not implemented.`);
                         return; // Stop loading process for unimplemented features
                     }

                     // 1. Fetch HTML Content
                     const response = await fetch(htmlPath);
                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status} fetching ${htmlPath}`);
                     }
                     const htmlContent = await response.text();
                     featureSectionsContainer.innerHTML = htmlContent; // Inject the fetched HTML

                     // 2. Load and Execute JavaScript (if needed)
                     if (needsInit && jsPath && initFunctionName) {
                         const script = document.createElement('script');
                         script.src = jsPath;
                         script.async = true; // Load asynchronously

                         script.onload = () => {
                             console.log(`${jsPath} loaded.`);
                             // Check if the initialization function exists in the global scope
                             if (typeof window[initFunctionName] === 'function') {
                                 console.log(`Calling ${initFunctionName}()`);
                                 try {
                                    window[initFunctionName](); // Execute the initialization function
                                 } catch (initError) {
                                     console.error(`Error executing ${initFunctionName}:`, initError);
                                     featureErrorEl.textContent = `Error initializing ${featureName}. Check console for details.`;
                                     featureErrorEl.style.display = 'block';
                                     featureLoadingEl.style.display = 'none'; // Hide loading on error
                                 }
                             } else {
                                 console.error(`Initialization function "${initFunctionName}" not found after loading ${jsPath}. Make sure it's defined globally or exposed correctly.`);
                                 featureErrorEl.textContent = `Failed to initialize ${featureName}: Initialization function missing.`;
                                 featureErrorEl.style.display = 'block';
                                 featureLoadingEl.style.display = 'none'; // Hide loading on error
                             }
                             // Clean up the script tag after execution
                             // script.remove(); // Let's keep it for easier debugging for now
                         };

                         script.onerror = (err) => {
                             console.error(`Failed to load script: ${jsPath}`, err);
                             featureSectionsContainer.innerHTML = ''; // Clear potentially broken HTML
                             featureSectionsContainer.appendChild(featurePlaceholder); // Show placeholder again
                             featureTitleEl.textContent = featureName;
                             featureDescEl.textContent = ``; // Clear desc
                             featureErrorEl.textContent = `Failed to load script for ${featureName}. Check console or network tab.`;
                             featureErrorEl.style.display = 'block';
                             featureLoadingEl.style.display = 'none';
                         };

                         document.body.appendChild(script); // Append to body to start loading
                     } else {
                         // If no JS needed, hide loading indicator immediately
                         featureLoadingEl.style.display = 'none';
                         featurePlaceholder.style.display = 'none'; // Hide placeholder if content loaded successfully
                     }

                 } catch (error) {
                     console.error(`Error loading feature ${featureId}:`, error);
                     featureSectionsContainer.innerHTML = ''; // Clear container on error
                     featureSectionsContainer.appendChild(featurePlaceholder); // Show placeholder
                     featureTitleEl.textContent = featureName;
                     featureDescEl.textContent = '';
                     featureErrorEl.textContent = `Failed to load content for ${featureName}. ${error.message}`;
                     featureErrorEl.style.display = 'block';
                     featureLoadingEl.style.display = 'none';
                 }
             }
             // ==================================================
             // END MODIFIED Load Feature Content
             // ==================================================


            function updateBrowserHistory(featureId, settingsTab = null) {
                let hash = `#${featureId}`;
                if (featureId === 'settings' && settingsTab) {
                    hash += `-${settingsTab}`;
                }
                // Only push state if the hash is actually changing
                if (window.location.hash !== hash) {
                    // Use pushState for smoother navigation feel without page jumps
                    window.history.pushState({ feature: featureId, tab: settingsTab }, '', hash);
                }
            }

            function handleInitialNavigation() {
                const hash = window.location.hash.substring(1);
                console.log(`Handling navigation for hash: ${hash}`);
                let featureId = 'dashboard';
                let settingsTab = null;

                if (hash) {
                    if (hash.startsWith('settings-')) {
                        const parts = hash.split('-');
                        featureId = parts[0];
                        settingsTab = parts[1];
                    } else {
                        // Check if the hash corresponds to a known feature
                        const knownFeature = Array.from(menuItems).some(item => item.getAttribute('data-feature') === hash);
                        if (knownFeature) {
                            featureId = hash;
                        }
                        // else, default to dashboard
                    }
                }
                setActiveFeature(featureId, settingsTab, true); // Skip history update on initial load
            }

            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                console.log("Popstate event:", event.state, window.location.hash);
                // Re-parse the hash to determine where to navigate
                handleInitialNavigation();
            });


            // --- Data Loading & Simulation ---
            function loadInitialData() {
                loadDashboardStats();
                loadRecentActivities();
                loadNotifications();
                // Load team members only if settings/team tab is initially active and user is admin
                 if (currentFeature === 'settings' && currentSettingsTab === 'team' && currentUser.role === 'admin') {
                     loadTeamMembers();
                 }
            }

            function loadDashboardStats() {
                 console.log("Loading dashboard stats...");
                 // Simulate API call
                 setTimeout(() => {
                     const teamMembersCount = MOCK_USERS.length; // Uses the current MOCK_USERS array length
                     const tasksCompleted = MOCK_TASKS.filter(t => t.status === 'Completed').length + Math.floor(Math.random() * 50); // Add some randomness
                     const activeProjects = MOCK_PROJECTS.filter(p => p.status === 'Active').length;
                     const upcomingDeadlines = Math.floor(Math.random() * 10); // Random deadlines

                     updateStatCard('teamMembersCount', 'Team Members', 'fas fa-users', teamMembersCount, Math.random() * 10 - 5); // Random trend +/- 5%
                     updateStatCard('tasksCompleted', 'Tasks Completed', 'fas fa-check-circle', tasksCompleted, Math.random() * 20); // Random trend 0-20%
                     updateStatCard('activeProjects', 'Active Projects', 'fas fa-project-diagram', activeProjects, Math.random() * 5 - 2); // Random trend +/- 2%
                     updateStatCard('upcomingDeadlines', 'Upcoming Deadlines', 'fas fa-calendar-times', upcomingDeadlines, Math.random() * 15 - 10); // Random trend +/- 10%
                 }, 300);
            }

            function updateStatCard(id, title, iconClass, value, trendPercent) {
                 // Find the card within the stats section - more robust than fixed IDs
                 const cardIndex = ['teamMembersCount', 'tasksCompleted', 'activeProjects', 'upcomingDeadlines'].indexOf(id);
                 if (cardIndex === -1 || !statsSection || !statsSection.children[cardIndex]) return; // Add checks

                 const card = statsSection.children[cardIndex];

                 let trendClass = 'trend-neutral';
                 let trendIcon = 'fas fa-minus';
                 if (trendPercent > 1) {
                     trendClass = 'trend-up';
                     trendIcon = 'fas fa-arrow-up';
                 } else if (trendPercent < -1) {
                     trendClass = 'trend-down';
                     trendIcon = 'fas fa-arrow-down';
                 }

                 card.innerHTML = `
                    <div class="stat-title"><i class="${iconClass}"></i>${title}</div>
                    <div class="stat-value">
                        <span>${value}</span>
                        <span class="stat-trend ${trendClass}">
                            <i class="${trendIcon}"></i> ${trendPercent !== 0 ? Math.abs(trendPercent).toFixed(0) + '%' : ''}
                        </span>
                    </div>
                `;
            }

            function loadRecentActivities(showAll = false) {
                console.log("Loading recent activities...");
                // Simulate fetching activities
                // Generate initial activities only once if needed
                if (activities.length === 0) {
                    const now = Date.now(); // Get current time for generation
                    activities = generateMockActivities(15, now); // Generate sorted initial activities
                }

                showingAllActivities = showAll;
                const activitiesToDisplay = showAll ? activities : activities.slice(0, maxActivitiesToShow);

                activityList.innerHTML = ''; // Clear current list

                if (activitiesToDisplay.length === 0) {
                    activityList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>';
                    deleteAllActivity.style.display = 'none';
                    viewAllActivity.style.display = 'none';
                    return;
                }

                activitiesToDisplay.forEach((activity, index) => {
                    const li = document.createElement('li');
                    li.classList.add('activity-item');
                    li.dataset.id = activity.id;
                    if (activity.isNew) {
                         li.classList.add('new-activity');
                         // Remove the 'new' status after animation
                         setTimeout(() => {
                            activity.isNew = false;
                             // Check if the element still exists before removing class
                            const currentLi = activityList.querySelector(`[data-id='${activity.id}']`);
                            if (currentLi) currentLi.classList.remove('new-activity');
                         }, 2500);
                    }

                    li.innerHTML = `
                        <div class="activity-icon"><i class="fas ${activity.icon}"></i></div>
                        <div class="activity-content">
                            <div class="activity-message">${activity.message}</div>
                            <div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div>
                        </div>
                        <div class="activity-actions">
                            <i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i>
                        </div>
                    `;
                    activityList.appendChild(li);
                });

                 // Show/Hide buttons based on state
                 deleteAllActivity.style.display = activities.length > 0 ? 'inline-block' : 'none';
                 viewAllActivity.textContent = showAll ? 'Show Less' : 'Show All';
                 viewAllActivity.style.display = activities.length > maxActivitiesToShow ? 'inline-block' : 'none';

                 // Add event listeners for delete icons (delegated)
                 // Done in setupEventListeners
            }

            function loadNotifications() {
                 console.log("Loading notifications...");
                 // Simulate fetching notifications
                 if (notifications.length === 0) {
                     const now = Date.now(); // Get current time for generation
                     notifications = generateMockNotifications(8, now); // Generate sorted initial notifications
                 }

                 renderNotifications();
            }

            function renderNotifications() {
                 notificationsBody.innerHTML = ''; // Clear current list
                 const unreadCount = notifications.filter(n => n.unread).length;

                 if (notifications.length === 0) {
                     noNotificationsMessage.textContent = 'You have no notifications.';
                     noNotificationsMessage.style.display = 'block';
                     notificationBadge.style.display = 'none';
                     notificationBadge.textContent = '0';
                     markAllReadBtn.disabled = true;
                     deleteAllNotificationsBtn.disabled = true;
                     return;
                 }

                 noNotificationsMessage.style.display = 'none';
                 markAllReadBtn.disabled = unreadCount === 0;
                 deleteAllNotificationsBtn.disabled = false;

                 notifications.forEach(notification => {
                     const div = document.createElement('div');
                     div.classList.add('notification-list-item');
                     div.dataset.id = notification.id;
                     if (notification.unread) {
                         div.classList.add('unread');
                     }

                     div.innerHTML = `
                        <div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div>
                        </div>
                        <i class="fas fa-times delete-notification" title="Delete Notification"></i>
                    `;
                    notificationsBody.appendChild(div);
                 });

                 // Update badge
                 notificationBadge.textContent = unreadCount;
                 notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

                 // Add event listeners (delegated)
                 // Done in setupEventListeners
            }

             function loadTeamMembers() {
                 const teamListContainer = document.getElementById('teamList');
                 if (!teamListContainer) return;

                 console.log("Loading team members for settings...");
                 teamListContainer.innerHTML = '<p style="color: var(--gray);">Loading...</p>'; // Loading indicator

                 // Simulate API call
                 setTimeout(() => {
                     teamListContainer.innerHTML = ''; // Clear loading
                     if (MOCK_USERS.length === 0) {
                         teamListContainer.innerHTML = '<p style="color: var(--gray);">No team members found.</p>';
                         return;
                     }

                     MOCK_USERS.forEach(member => {
                         const card = document.createElement('div');
                         card.classList.add('team-member-card');
                         card.dataset.id = member.id;

                         const avatarStyle = member.avatar ? `background-image: url('${member.avatar}')` : '';
                         const avatarContent = member.avatar ? '' : member.initials;

                         card.innerHTML = `
                            <div class="member-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div class="member-details">
                                <div class="member-name">${member.name}</div>
                                <div class="member-email">${member.email}</div>
                            </div>
                            <span class="member-role role-${member.role}">${formatRole(member.role)}</span>
                            ${currentUser.id !== member.id ? ` <!-- Don't show actions for self -->
                            <div class="member-actions">
                                <button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            ` : '<div class="member-actions" style="width: 70px;"></div>' /* Placeholder for alignment */}
                        `;
                         teamListContainer.appendChild(card);
                     });

                     // Add event listeners for edit/remove (delegated)
                 }, 500);
             }


            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() {
                // Simulate new activity every 10-20 seconds
                if (activityIntervalId) clearInterval(activityIntervalId);
                activityIntervalId = setInterval(() => {
                    const newActivity = generateMockActivities(1, Date.now())[0]; // Use current time
                    newActivity.isNew = true; // Mark as new
                    activities.unshift(newActivity); // Add to beginning
                    if (activities.length > 50) activities.pop(); // Limit history size
                    if (currentFeature === 'dashboard') { // Only update UI if dashboard is visible
                       loadRecentActivities(showingAllActivities); // Refresh list
                    }
                    showToast(`New Activity: ${newActivity.message.substring(0, 30)}...`);
                    playNotificationSound(); // Play sound for new activity too? Optional.
                }, Math.random() * 10000 + 10000);

                // Simulate new notification every 20-40 seconds
                 if (notificationIntervalId) clearInterval(notificationIntervalId);
                 notificationIntervalId = setInterval(() => {
                    const newNotification = generateMockNotifications(1, Date.now())[0]; // Use current time
                    newNotification.unread = true;
                    notifications.unshift(newNotification); // Add to beginning
                    if (notifications.length > 30) notifications.pop(); // Limit history
                    renderNotifications(); // Always refresh notification list & badge
                    playNotificationSound(); // Play sound for new notification
                 }, Math.random() * 20000 + 20000);

                // Simulate stats changing every 30 seconds
                 if (statsIntervalId) clearInterval(statsIntervalId);
                 statsIntervalId = setInterval(loadDashboardStats, 30000);

                 // Simulate Welcome section background change every 15 seconds
                 if (welcomeBgIntervalId) clearInterval(welcomeBgIntervalId);
                 welcomeBgIntervalId = setInterval(changeWelcomeBackground, 15000);
            }

            function changeWelcomeBackground() {
                const backgrounds = ['--welcome-bg-1', '--welcome-bg-2', '--welcome-bg-3'];
                // Get current background from computed style (more reliable)
                const currentBgVar = getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim();
                let currentIndex = backgrounds.indexOf(currentBgVar);
                if (currentIndex === -1) currentIndex = 0; // Default if not found

                const nextIndex = (currentIndex + 1) % backgrounds.length;
                document.documentElement.style.setProperty('--welcome-bg-current', `var(${backgrounds[nextIndex]})`);
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                // Sidebar Toggle
                 if (sidebarToggle) {
                     sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.add('active');
                         mainContent.classList.add('sidebar-active');
                         if(closeSidebar) closeSidebar.style.display = 'block'; // Show close button inside
                    });
                 }
                 if (closeSidebar) {
                     closeSidebar.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                        mainContent.classList.remove('sidebar-active');
                        closeSidebar.style.display = 'none';
                     });
                 }
                 // Close sidebar if clicking outside on mobile
                 document.addEventListener('click', (event) => {
                    if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                        const isClickInsideSidebar = sidebar.contains(event.target);
                        const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target);
                        if (!isClickInsideSidebar && !isClickOnToggler) {
                            sidebar.classList.remove('active');
                            mainContent.classList.remove('sidebar-active');
                            if(closeSidebar) closeSidebar.style.display = 'none';
                        }
                    }
                 });


                // Menu Items
                menuItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const featureId = this.getAttribute('data-feature');
                        setActiveFeature(featureId);
                    });
                });

                // Settings Tabs & Links within settings panels
                 document.body.addEventListener('click', function(e) { // Delegate to body for links inside panels
                    const target = e.target;
                    // Handle direct tab clicks
                    if (target.closest('.settings-tab') && !target.closest('.settings-tab.active')) {
                        const tabId = target.closest('.settings-tab').getAttribute('data-tab');
                        activateSettingsTab(tabId);
                        updateBrowserHistory('settings', tabId);
                    }
                    // Handle clicks on links that target a settings tab (e.g., from Account to Security)
                    else if (target.closest('.settings-link') && target.closest('.settings-link').dataset.tabTarget) {
                        e.preventDefault();
                        const tabId = target.closest('.settings-link').dataset.tabTarget;
                         setActiveFeature('settings', tabId); // Use setActiveFeature to ensure panel switch
                    }
                 });

                // Back Button
                backButton.addEventListener('click', function() {
                    setActiveFeature('dashboard');
                });

                // User Dropdown Toggle
                userProfileContainer.addEventListener('click', function(e) {
                     // Prevent clicks on links inside dropdown from closing it immediately
                     if (e.target.closest('.dropdown-item')) {
                         // Allow default link behavior or handle navigation
                         const feature = e.target.closest('.dropdown-item').getAttribute('data-feature');
                         if (feature) {
                             setActiveFeature(feature);
                         } else if (e.target.closest('#logoutLink')) {
                            // Logout handled below by its own listener
                         }
                         return; // Let link handlers below work
                     }
                     userDropdownOpen = !userDropdownOpen;
                     userDropdown.classList.toggle('active', userDropdownOpen);
                });

                // Close dropdown if clicking outside
                 document.addEventListener('click', function(event) {
                     if (!userProfileContainer.contains(event.target) && userDropdownOpen) {
                         userDropdown.classList.remove('active');
                         userDropdownOpen = false;
                     }
                 });

                // Search Input & Results
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('focus', handleSearch); // Show results on focus if input exists
                 // Hide search results when clicking outside
                 document.addEventListener('click', (event) => {
                    if (!searchInput.contains(event.target) && !searchResultsContainer.contains(event.target)) {
                        searchResultsContainer.classList.remove('active');
                    }
                 });
                 // Handle clicking on a search result item (Event Delegation)
                 searchResultsContainer.addEventListener('click', (event) => {
                     const targetItem = event.target.closest('.search-result-item');
                     if (targetItem && targetItem.dataset.feature) {
                         const featureId = targetItem.dataset.feature;
                         const itemId = targetItem.dataset.id; // Optional ID for specific item
                         console.log(`Search result clicked: Feature=${featureId}, ID=${itemId}`);
                         // Navigate to the feature/item
                         setActiveFeature(featureId);
                         // Potentially scroll to or highlight the item if ID is present (needs implementation)
                         searchResultsContainer.classList.remove('active');
                         searchInput.value = ''; // Clear search input
                     }
                 });

                // Notifications Modal
                notificationIcon.addEventListener('click', () => {
                     notificationsModal.classList.add('active');
                });
                closeNotifications.addEventListener('click', () => {
                    notificationsModal.classList.remove('active');
                });
                 notificationsModal.addEventListener('click', (event) => { // Close on backdrop click
                    if (event.target === notificationsModal) {
                        notificationsModal.classList.remove('active');
                    }
                 });

                 // Notification Actions (Event Delegation)
                 notificationsBody.addEventListener('click', (event) => {
                     const target = event.target;
                     const notificationItem = target.closest('.notification-list-item');
                     const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null;

                     if (target.classList.contains('delete-notification') && notificationId) {
                         showConfirmModal('Delete Notification', 'Are you sure you want to delete this notification?', () => {
                             notifications = notifications.filter(n => n.id !== notificationId);
                             renderNotifications();
                             showToast('Notification deleted.', 'success');
                         });
                     } else if (notificationItem && notificationId) {
                         const notification = notifications.find(n => n.id === notificationId);
                         if (notification && notification.unread) {
                             notification.unread = false;
                             renderNotifications(); // Update UI immediately
                         }
                         console.log(`Clicked notification ${notificationId}`);
                     }
                 });

                 markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
                 deleteAllNotificationsBtn.addEventListener('click', () => {
                     if (notifications.length === 0) return;
                     showConfirmModal('Delete All Notifications', 'Are you sure you want to delete ALL notifications? This cannot be undone.', () => {
                         notifications = [];
                         renderNotifications();
                         showToast('All notifications deleted.', 'success');
                     });
                 });

                // Activity List Actions (Event Delegation)
                 activityList.addEventListener('click', (event) => {
                     const target = event.target;
                     if (target.classList.contains('delete-activity')) {
                         const activityItem = target.closest('.activity-item');
                         const activityId = activityItem ? parseInt(activityItem.dataset.id) : null;
                         if (activityId) {
                             activities = activities.filter(a => a.id !== activityId);
                             loadRecentActivities(showingAllActivities); // Refresh list
                             showToast('Activity deleted.'); // Use default info toast
                         }
                     }
                 });

                viewAllActivity.addEventListener('click', () => {
                    loadRecentActivities(!showingAllActivities);
                });

                deleteAllActivity.addEventListener('click', () => {
                    if (activities.length === 0) return;
                    showConfirmModal('Delete All Activities', 'Are you sure you want to delete ALL activities? This cannot be undone.', () => {
                        activities = [];
                        loadRecentActivities(false); // Refresh list (will show empty state)
                        showToast('All activities deleted.');
                    });
                });

                // Profile Form Handling
                 profileAvatarLarge.addEventListener('click', () => {
                    profileAvatarInput.click(); // Trigger hidden file input
                 });
                 profileAvatarInput.addEventListener('change', handleAvatarUpload);

                 profileForm.addEventListener('submit', handleProfileSave);
                 cancelProfileBtn.addEventListener('click', handleProfileCancel);

                 // Update full name display when first/last name changes
                 firstNameInput.addEventListener('input', updateFullNameDisplay);
                 lastNameInput.addEventListener('input', updateFullNameDisplay);

                 // Logout Link
                 logoutLink.addEventListener('click', handleLogout);

                 // Team Management Actions (Event Delegation on teamList)
                 const teamListContainer = document.getElementById('teamList');
                 if (teamListContainer) {
                    teamListContainer.addEventListener('click', (event) => {
                        const target = event.target;
                        const memberCard = target.closest('.team-member-card');
                        const memberId = memberCard ? parseInt(memberCard.dataset.id) : null;

                        if (!memberId || memberId === currentUser.id) return; // Ignore clicks not on buttons or on self

                        if (target.closest('.edit-member')) {
                            console.log(`Edit member ${memberId}`);
                            openEditMemberModal(memberId); // Open the edit modal
                        } else if (target.closest('.remove-member')) {
                            console.log(`Remove member ${memberId}`);
                             const memberToRemove = MOCK_USERS.find(u => u.id === memberId);
                             showConfirmModal('Remove Team Member', `Are you sure you want to remove ${memberToRemove?.name || 'this member'}?`, () => {
                                showToast(`Removing ${memberToRemove?.name || 'member'}...`, 'info');
                                setTimeout(() => {
                                    MOCK_USERS = MOCK_USERS.filter(u => u.id !== memberId); // Update mock data
                                    loadTeamMembers(); // Refresh list in settings
                                    loadDashboardStats(); // Update dashboard stats (team count)

                                    // *** FIX: Refresh schedule view if it's currently active ***
                                    if (currentFeature === 'employee-scheduling') {
                                         // Check if the schedule init function is available (meaning the script was loaded)
                                         if (typeof initializeEmployeeScheduleLogic === 'function') {
                                            console.log("Team member removed, reloading schedule feature.");
                                            // Easiest way to ensure update with removed user is reload the feature
                                            loadFeatureContent('employee-scheduling');
                                         }
                                    }
                                    // *** END FIX ***

                                    showToast('Team member removed.', 'success');
                                }, 500); // Simulate delay
                             }, 'btn-danger');
                        }
                    });
                 }

                 // Edit Member Modal Form Submission
                 if (editMemberForm) {
                     editMemberForm.addEventListener('submit', handleEditMemberSave);
                 }
                 // Edit Member Modal Close Buttons
                 if(editMemberModal) {
                     editMemberModal.querySelectorAll('[data-close-modal]').forEach(btn => {
                         btn.addEventListener('click', () => editMemberModal.classList.remove('active'));
                     });
                     editMemberModal.addEventListener('click', (event) => { // Close on backdrop click
                         if (event.target === editMemberModal) {
                             editMemberModal.classList.remove('active');
                         }
                     });
                 }


                 // Invite Member Form
                 const inviteMemberForm = document.getElementById('inviteMemberForm');
                 if (inviteMemberForm) {
                     inviteMemberForm.addEventListener('submit', handleInviteMember);
                 }

                 // Settings Controls Listeners
                 themeOptions.forEach(option => {
                     option.addEventListener('click', () => setTheme(option.dataset.theme));
                 });
                 if (highContrastToggle) {
                     highContrastToggle.addEventListener('change', (e) => setContrast(e.target.checked));
                 }
                 if (languageSelect) {
                     languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value));
                 }
                 if (regionSelect) {
                    regionSelect.addEventListener('change', (e) => localStorage.setItem('region', e.target.value)); // Just save for now
                 }
                 if (timeFormatSelect || dateFormatSelect) {
                    const applyDateTimeListener = () => {
                        applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value);
                    };
                    if (timeFormatSelect) timeFormatSelect.addEventListener('change', applyDateTimeListener);
                    if (dateFormatSelect) dateFormatSelect.addEventListener('change', applyDateTimeListener);
                 }

                 if (toastToggle) {
                    toastToggle.addEventListener('change', (e) => applyToastPreference(e.target.checked));
                 }
                 if (soundToggle) {
                     soundToggle.addEventListener('change', (e) => applySoundPreference(e.target.checked));
                 }

                // Add listeners for enabled Settings buttons
                if(savePreferencesBtn) savePreferencesBtn.addEventListener('click', handleSavePreferences);
                if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
                if(saveAccountSettingsBtn) saveAccountSettingsBtn.addEventListener('click', handleSaveAccountSettings);
                if(saveSessionSettingsBtn) saveSessionSettingsBtn.addEventListener('click', handleSaveSessionSettings);
                if(saveNotificationSettingsBtn) saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);

                // Email change button remains disabled for this demo

                 // 2FA Button Listeners
                 if (enable2faBtn) enable2faBtn.addEventListener('click', handleEnable2FA);
                 if (setupAuthAppBtn) setupAuthAppBtn.addEventListener('click', showAuthAppSetup);
                 if (setupSmsBtn) setupSmsBtn.addEventListener('click', showSmsSetup);
                 if (verifyAuthCodeBtn) verifyAuthCodeBtn.addEventListener('click', handleVerifyAuthCode); // Simulate verification
                 if (sendSmsCodeBtn) sendSmsCodeBtn.addEventListener('click', handleSendSmsCode); // Simulate sending
                 if (verifySmsCodeBtn) verifySmsCodeBtn.addEventListener('click', handleVerifySmsCode); // Simulate verification
                 if (disable2faBtn) disable2faBtn.addEventListener('click', handleDisable2FA);

                 // Danger Zone Button Listeners
                 if(logoutAllDevicesBtn) logoutAllDevicesBtn.addEventListener('click', handleLogoutAllDevices);
                 if(deleteAccountBtn) deleteAccountBtn.addEventListener('click', handleDeleteAccount);


                // Confirm Modal Buttons
                cancelConfirmBtn.addEventListener('click', hideConfirmModal);
                confirmBtn.addEventListener('click', () => {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    hideConfirmModal();
                });
            }

            // --- Specific Feature Logic ---

             function setupResponsiveSidebar() {
                // Logic for toggling sidebar on small screens is handled in setupEventListeners
             }

            // --- Search Logic ---
            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                searchResultsContainer.innerHTML = ''; // Clear previous results

                if (searchTerm.length < 2) { // Only search if 2+ characters
                    searchResultsContainer.classList.remove('active');
                    return;
                }

                console.log(`Searching for: ${searchTerm}`);
                const results = [];

                // Search Users
                MOCK_USERS.forEach(user => {
                    if (user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) {
                         results.push({
                             type: 'User',
                             id: user.id,
                             name: user.name,
                             description: user.email,
                             icon: 'fa-user',
                             feature: 'team-members-view' // Feature to navigate to
                         });
                    }
                });

                // Search Projects
                MOCK_PROJECTS.forEach(project => {
                     if (project.name.toLowerCase().includes(searchTerm)) {
                         results.push({
                             type: 'Project',
                             id: project.id,
                             name: project.name,
                             description: `Status: ${project.status}`,
                             icon: 'fa-briefcase',
                             feature: 'projects'
                         });
                     }
                });

                // Search Tasks
                 MOCK_TASKS.forEach(task => {
                     if (task.name.toLowerCase().includes(searchTerm)) {
                         const projectName = MOCK_PROJECTS.find(p => p.id === task.project)?.name || 'Unknown Project';
                         results.push({
                             type: 'Task',
                             id: task.id,
                             name: task.name,
                             description: `Project: ${projectName} | Status: ${task.status}`,
                             icon: 'fa-tasks',
                             feature: 'task-management'
                         });
                     }
                 });

                 // Search Sidebar Features
                 menuItems.forEach(item => {
                     const featureName = item.querySelector('span')?.textContent;
                     const featureId = item.getAttribute('data-feature');
                     if (featureName && featureId && featureName.toLowerCase().includes(searchTerm)) {
                         // Avoid duplicates if already found via other searches
                         if (!results.some(r => r.feature === featureId && r.type !== 'User' && r.type !== 'Project' && r.type !== 'Task')) {
                             results.push({
                                 type: 'Feature',
                                 id: null,
                                 name: featureName,
                                 description: 'Navigate to section',
                                 icon: item.querySelector('i')?.className.split(' ')[1] || 'fa-compass', // Get icon class
                                 feature: featureId
                             });
                         }
                     }
                 });


                if (results.length > 0) {
                    results.slice(0, 10).forEach(result => { // Limit to 10 results
                        const item = document.createElement('div');
                        item.classList.add('search-result-item');
                        item.dataset.feature = result.feature;
                        if (result.id) item.dataset.id = result.id;
                        item.innerHTML = `
                            <i class="fas ${result.icon}"></i>
                            <div>
                                <strong>${result.name}</strong> <small>(${result.type})</small><br>
                                <span style="font-size: 0.8em; color: var(--gray);">${result.description}</span>
                            </div>
                        `;
                        searchResultsContainer.appendChild(item);
                    });
                    searchResultsContainer.classList.add('active');
                } else {
                    searchResultsContainer.innerHTML = '<div class="search-result-item" style="text-align: center; color: var(--gray); cursor: default;">No results found.</div>';
                    searchResultsContainer.classList.add('active');
                }
            }


            // --- Profile Logic ---
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        // Update UI previews
                        profileAvatarLarge.style.backgroundImage = `url(${imageUrl})`;
                        profileAvatarLarge.textContent = ''; // Hide initials
                        document.getElementById('userAvatar').style.backgroundImage = `url(${imageUrl})`;
                        document.getElementById('userAvatar').textContent = '';
                        document.getElementById('profileAvatar').style.backgroundImage = `url(${imageUrl})`;
                        document.getElementById('profileAvatar').textContent = '';

                        // Simulate saving (update currentUser object)
                        currentUser.avatar = imageUrl;
                        showToast('Avatar preview updated. Save changes to persist.');
                    }
                    reader.readAsDataURL(file);
                } else if (file) {
                    showToast('Please select a valid image file.', 'error');
                }
            }

            function updateFullNameDisplay() {
                fullNameDisplay.value = `${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim();
            }

             function handleProfileSave(event) {
                 event.preventDefault();
                 console.log("Attempting to save profile...");

                 showConfirmModal(
                     'Save Profile Changes',
                     'Are you sure you want to save these changes to your profile?',
                     () => {
                         console.log("Profile save confirmed.");
                         const saveButtonText = saveProfileBtn.querySelector('.btn-text');
                         const spinner = saveProfileBtn.querySelector('.spinner');

                         saveProfileBtn.disabled = true;
                         if (saveButtonText) saveButtonText.textContent = 'Saving...';
                         if (spinner) spinner.style.display = 'inline-block';

                         setTimeout(() => {
                             currentUser.name = fullNameDisplay.value;
                             currentUser.title = jobTitleInput.value;
                             currentUser.phone = phoneInput.value;
                             currentUser.department = departmentInput.value;

                             if (!currentUser.avatar) {
                                 const nameParts = currentUser.name.split(' ');
                                 currentUser.initials = (nameParts[0]?.[0] || '') + (nameParts[1]?.[0] || '');
                             }

                              userPhoneNumberForSms.textContent = currentUser.phone || 'Not Available';
                             updateUserUI();

                             saveProfileBtn.disabled = false;
                             if (saveButtonText) saveButtonText.textContent = 'Save Changes';
                             if (spinner) spinner.style.display = 'none';
                             showSuccessMessage('Profile updated successfully!');
                         }, 1000);
                     },
                     'btn-primary'
                 );
             }

             function handleProfileCancel() {
                 showConfirmModal(
                     'Cancel Changes',
                     'Are you sure you want to discard your changes to the profile?',
                     () => {
                         updateProfileForm();
                         showToast('Changes discarded.');
                     },
                     'btn-warning'
                 );
             }

             // --- Settings Save Logic (with Confirmation) ---
             function handleSavePreferences() {
                 showConfirmModal('Save Preferences', 'Save changes to Appearance and Localization?', () => {
                     console.log("Saving Preferences...");
                     showToast('Preferences saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleSaveAccountSettings() {
                 showConfirmModal('Save Account Settings', 'Save changes to account notifications?', () => {
                     console.log("Saving Account Settings...");
                     const enableNotifications = document.getElementById('accountNotificationsToggle').checked;
                     console.log("Account Notifications Enabled:", enableNotifications);
                     showToast('Account settings saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleChangePassword(event) {
                 event.preventDefault();
                  showConfirmModal('Change Password', 'Are you sure you want to attempt to change your password?', () => {
                     console.log("Changing password...");
                     const currentPass = document.getElementById('currentPassword').value;
                     const newPass = document.getElementById('newPassword').value;
                     const confirmPass = document.getElementById('confirmPassword').value;

                     if (!currentPass || !newPass || !confirmPass) {
                         showToast('Please fill in all password fields.', 'error');
                         return;
                     }
                     if (newPass !== confirmPass) {
                         showToast('New passwords do not match.', 'error');
                         return;
                     }
                     if (newPass.length < 8) {
                         showToast('New password must be at least 8 characters.', 'error');
                         return;
                     }

                     showToast('Attempting password change...', 'info');
                     setTimeout(() => {
                         const success = Math.random() > 0.2;
                         if (success) {
                             showSuccessMessage('Password changed successfully!');
                             document.getElementById('currentPassword').value = '';
                             document.getElementById('newPassword').value = '';
                             document.getElementById('confirmPassword').value = '';
                         } else {
                             showToast('Password change failed. Incorrect current password?', 'error');
                         }
                     }, 1500);
                  }, 'btn-danger');
             }

             function handleSaveSessionSettings() {
                 showConfirmModal('Save Session Settings', 'Save changes to session duration and idle timeout?', () => {
                     console.log("Saving Session Settings...");
                     const sessionDuration = document.getElementById('sessionDuration').value;
                     const idleTimeout = document.getElementById('idleTimeout').value;
                     console.log("Session Duration:", sessionDuration, "Idle Timeout:", idleTimeout);
                     showToast('Session settings saved (simulated).', 'success');
                 }, 'btn-primary');
             }

             function handleSaveNotificationSettings() {
                  showConfirmModal('Save Notification Settings', 'Save changes to notification delivery and types?', () => {
                     console.log("Saving Notification Settings...");
                     const emailEnabled = document.getElementById('emailNotificationsToggle').checked;
                     const inAppEnabled = document.getElementById('inAppNotificationsToggle').checked;
                     const pushEnabled = document.getElementById('pushNotificationsToggle').checked;
                     const selectedTypes = Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb => cb.value);

                     console.log("Email Notifications:", emailEnabled);
                     console.log("In-App Notifications:", inAppEnabled);
                     console.log("Selected Types:", selectedTypes);
                     showToast('Notification settings saved (simulated).', 'success');
                  }, 'btn-primary');
             }


             // --- 2FA Logic (Simulation) ---
             function update2FA_UI() {
                if (!currentUser || !twoFaStatusIndicator || !twoFaStatusText || !twoFaSetupSection || !twoFaManagementSection) return;

                const isEnabled = currentUser.twoFaEnabled;
                twoFaStatusIndicator.className = `status-indicator ${isEnabled ? 'enabled' : 'disabled'}`;
                twoFaStatusText.textContent = `2FA is currently ${isEnabled ? 'Enabled' : 'Disabled'}`;

                twoFaSetupSection.style.display = isEnabled ? 'none' : 'block';
                twoFaManagementSection.style.display = isEnabled ? 'block' : 'none';

                 if (twoFaSetupOptions) twoFaSetupOptions.style.display = 'none';
                 if (authAppSetup) authAppSetup.style.display = 'none';
                 if (smsSetup) smsSetup.style.display = 'none';
             }

             function handleEnable2FA() {
                 if(twoFaSetupOptions) twoFaSetupOptions.style.display = 'block';
                 if(enable2faBtn) enable2faBtn.style.display = 'none';
             }
             function showAuthAppSetup() {
                 if(authAppSetup) authAppSetup.style.display = 'block';
                 if(smsSetup) smsSetup.style.display = 'none';
             }
             function showSmsSetup() {
                 if(authAppSetup) authAppSetup.style.display = 'none';
                 if(smsSetup) smsSetup.style.display = 'block';
                 if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'none';
                 if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'none';
             }

             function handleVerifyAuthCode() {
                 const authCodeInput = document.getElementById('authCode');
                 if (!authCodeInput) return;
                 const code = authCodeInput.value;
                 if (code && code.length === 6 && /^\d+$/.test(code)) {
                     showToast('Verifying code...', 'info');
                     setTimeout(() => {
                         currentUser.twoFaEnabled = true;
                         update2FA_UI();
                         showToast('2FA enabled successfully via Authenticator App!', 'success');
                     }, 1000);
                 } else {
                     showToast('Invalid code. Please enter a 6-digit code.', 'error');
                 }
             }
             function handleSendSmsCode() {
                 showToast('Sending SMS code...', 'info');
                 setTimeout(() => {
                     showToast('SMS code sent (simulated).', 'success');
                     if(smsCodeInputGroup) smsCodeInputGroup.style.display = 'block';
                     if(verifySmsCodeBtn) verifySmsCodeBtn.style.display = 'inline-flex';
                 }, 1500);
             }
              function handleVerifySmsCode() {
                 const smsCodeInput = document.getElementById('smsCode');
                 if (!smsCodeInput) return;
                 const code = smsCodeInput.value;
                 if (code && code.length === 6 && /^\d+$/.test(code)) {
                     showToast('Verifying SMS code...', 'info');
                     setTimeout(() => {
                         currentUser.twoFaEnabled = true;
                         update2FA_UI();
                         showToast('2FA enabled successfully via SMS!', 'success');
                     }, 1000);
                 } else {
                     showToast('Invalid SMS code. Please enter a 6-digit code.', 'error');
                 }
             }

             function handleDisable2FA() {
                 showConfirmModal('Disable 2FA', 'Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.', () => {
                     currentUser.twoFaEnabled = false;
                     update2FA_UI();
                     if(enable2faBtn) enable2faBtn.style.display = 'inline-flex';
                     showToast('2FA disabled.');
                 }, 'btn-danger');
             }

             // --- Danger Zone Logic ---
             function handleLogoutAllDevices() {
                 showConfirmModal('Logout From All Devices', 'Are you sure you want to end all other active sessions?', () => {
                     showToast('Logging out from other devices...', 'info');
                     setTimeout(() => {
                         showSuccessMessage('Successfully logged out from all other devices.');
                     }, 1500);
                 }, 'btn-warning');
             }

             function handleDeleteAccount() {
                 showConfirmModal('Delete Account', 'This action is IRREVERSIBLE. All your data, projects, and settings will be permanently deleted. Are you absolutely sure you want to proceed?', () => {
                     showConfirmModal('Final Confirmation', 'This is your absolute last chance. Are you sure?', () => {
                         console.warn("Account Deletion Confirmed (Simulated)");
                         showToast('Deleting account...', 'error');
                         setTimeout(() => {
                             alert("Account Deleted (Simulated). You would be redirected now.");
                             handleLogout(new Event('click')); // Trigger logout flow
                         }, 2000);
                     }, 'btn-danger');
                 }, 'btn-danger');
             }


             // --- Notification Logic ---
             function markAllNotificationsAsRead() {
                 if (notifications.some(n => n.unread)) {
                     notifications.forEach(n => n.unread = false);
                     renderNotifications();
                     showToast('All notifications marked as read.');
                 }
             }

             function playNotificationSound() {
                if (!playSounds) return;

                try {
                    if (notificationSound && notificationSound.paused) {
                        notificationSound.play().catch(e => console.warn("Audio play failed:", e));
                    }
                 } catch(e) {
                     console.warn("Audio playback error:", e);
                 }
             }

             // --- Activity Logic ---
             // (Handled in loadRecentActivities and event listeners)

             // --- Logout Logic ---
             function handleLogout(event) {
                event.preventDefault();
                 showConfirmModal(
                     'Confirm Logout',
                     'Are you sure you want to log out?',
                     () => {
                         console.log("Logging out...");
                         clearInterval(activityIntervalId);
                         clearInterval(notificationIntervalId);
                         clearInterval(statsIntervalId);
                         clearInterval(welcomeBgIntervalId);
                         showSuccessMessage('Logout successful! Redirecting...');
                         setTimeout(() => {
                             window.location.href = 'login.html'; // Actual redirection
                         }, 1500);
                     },
                     'btn-danger'
                 );
             }

            // --- Team Management Logic ---
             function handleInviteMember(event) {
                 event.preventDefault();
                 const emailInput = document.getElementById('inviteEmail');
                 const roleInput = document.getElementById('inviteRole');
                 const email = emailInput ? emailInput.value : null;
                 const role = roleInput ? roleInput.value : null;
                 const inviteButton = event.target.querySelector('button[type="submit"]');

                 if (!email || !role) {
                     showToast('Please provide both email and role.', 'error');
                     return;
                 }

                 console.log(`Inviting ${email} as ${role}`);
                 if (inviteButton) {
                     inviteButton.disabled = true;
                     inviteButton.innerHTML = '<span class="spinner"></span> Sending...'; // Add spinner
                 }

                 setTimeout(() => {
                    const newId = MOCK_USERS.length > 0 ? Math.max(...MOCK_USERS.map(u => u.id)) + 1 : 1;
                    const nameParts = email.split('@')[0].split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1));
                    const newUser = {
                        id: newId,
                        name: nameParts.join(' ') || 'New User',
                        email: email,
                        title: formatRole(role),
                        department: 'Pending',
                        phone: '',
                        avatar: '',
                        initials: (nameParts[0]?.[0] || 'N') + (nameParts[1]?.[0] || 'U'),
                        role: role,
                        twoFaEnabled: false
                    };
                    MOCK_USERS.push(newUser);
                    loadTeamMembers(); // Refresh list
                    loadDashboardStats(); // Update stats

                    showToast(`Invitation sent to ${email}.`);
                    if (inviteButton) {
                        inviteButton.disabled = false;
                        inviteButton.innerHTML = 'Invite'; // Reset button text
                    }
                    if (emailInput) emailInput.value = ''; // Clear form
                    if (roleInput) roleInput.value = 'member';
                 }, 1000);
             }

            function openEditMemberModal(memberId) {
                 const member = MOCK_USERS.find(u => u.id === memberId);
                 if (!member || !editMemberModal) return;

                 document.getElementById('editMemberId').value = member.id;
                 const nameParts = member.name.split(' ');
                 document.getElementById('editMemberFirstName').value = nameParts[0] || '';
                 document.getElementById('editMemberLastName').value = nameParts.slice(1).join(' ') || '';
                 document.getElementById('editMemberEmail').value = member.email;
                 document.getElementById('editMemberRole').value = member.role;
                 document.getElementById('editMemberTitle').value = member.title || '';
                 document.getElementById('editMemberDepartment').value = member.department || '';
                 document.getElementById('editMemberModalTitle').textContent = `Edit ${member.name}`;


                 editMemberModal.classList.add('active');
             }

             function handleEditMemberSave(event) {
                event.preventDefault();
                const memberId = parseInt(document.getElementById('editMemberId').value);
                const firstName = document.getElementById('editMemberFirstName').value;
                const lastName = document.getElementById('editMemberLastName').value;
                const role = document.getElementById('editMemberRole').value;
                const title = document.getElementById('editMemberTitle').value;
                const department = document.getElementById('editMemberDepartment').value;

                console.log(`Saving changes for member ID: ${memberId}`);
                showToast('Saving member changes...', 'info');

                setTimeout(() => {
                    const memberIndex = MOCK_USERS.findIndex(u => u.id === memberId);
                    if (memberIndex > -1) {
                        MOCK_USERS[memberIndex] = {
                            ...MOCK_USERS[memberIndex],
                            name: `${firstName} ${lastName}`.trim(),
                            role: role,
                            title: title,
                            department: department,
                            initials: !MOCK_USERS[memberIndex].avatar
                                        ? (firstName?.[0] || '') + (lastName?.[0] || '')
                                        : MOCK_USERS[memberIndex].initials
                        };
                        loadTeamMembers();
                        updateUserUI();
                        showToast('Member details updated successfully!', 'success');
                    } else {
                         showToast('Error: Member not found.', 'error');
                    }
                     editMemberModal.classList.remove('active');
                 }, 1000);
             }


             // --- Employee Scheduling ---
             // Logic is now moved to employee-scheduling.js and loaded dynamically
             // Function definitions like getEmployeeScheduleHTML, initializeEmployeeScheduleLogic, etc. are removed from here.


             // --- Utility Functions (Global Scope) ---
             function timeAgo(timestamp) {
                if (!(timestamp instanceof Date)) return '';
                const now = new Date();
                const secondsPast = (now.getTime() - timestamp.getTime()) / 1000;

                if (secondsPast < 10) return 'Just now';
                if (secondsPast < 60) return parseInt(secondsPast) + 's ago';
                if (secondsPast < 3600) return parseInt(secondsPast / 60) + 'm ago';
                 if (secondsPast < 3600 * 24) return parseInt(secondsPast / 3600) + 'h ago';
                 return formatDateForDisplay(timestamp); // Use global formatter
             }

             function formatDateForDisplay(date) {
                 if (!(date instanceof Date)) return '';
                 const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY';
                 const year = date.getFullYear();
                 const month = date.getMonth() + 1;
                 const day = date.getDate();
                 const monthPadded = String(month).padStart(2, '0');
                 const dayPadded = String(day).padStart(2, '0');
                 const monthName = date.toLocaleDateString(undefined, { month: 'short' });

                 try {
                     switch (dateFormat) {
                         case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`;
                         case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`;
                         case 'Month D, YYYY': return `${monthName} ${day}, ${year}`;
                         case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`;
                     }
                 } catch (e) {
                     console.error("Error formatting date:", e);
                     return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`;
                 }
            }

             function formatFullDateTime(date) {
                 if (!(date instanceof Date)) return '';
                 const formattedDate = formatDateForDisplay(date); // Use global formatter
                 const timeFormat = localStorage.getItem('timeFormat') || '12h';
                 const options = { hour: 'numeric', minute: 'numeric', hour12: timeFormat === '12h' };
                 try {
                     const formattedTime = date.toLocaleTimeString(undefined, options);
                     return `${formattedDate}, ${formattedTime}`;
                 } catch (e) {
                      console.error("Error formatting time:", e);
                      return formattedDate;
                 }
             }


            function generateMockActivities(count, baseTimestampMillis) {
                const nowMillis = baseTimestampMillis || Date.now();
                const newActivities = [];
                const users = MOCK_USERS.map(u => u.name.split(' ')[0]);
                 if (users.length === 0) users.push('System');
                const actions = ['updated profile', 'completed task', 'added a new project', 'commented on task', 'uploaded a file', 'joined the team'];
                const icons = ['fa-user-edit', 'fa-check-circle', 'fa-plus-circle', 'fa-comment', 'fa-upload', 'fa-user-plus'];
                const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`);
                const projects = MOCK_PROJECTS.map(p => `'${p.name}'`);
                const files = ['document.pdf', 'image.png', 'spreadsheet.xlsx', 'presentation.pptx'];

                for (let i = 0; i < count; i++) {
                    const user = users[Math.floor(Math.random() * users.length)];
                    const actionIndex = Math.floor(Math.random() * actions.length);
                    let message = `${user} ${actions[actionIndex]}`;
                    if (actions[actionIndex].includes('task') && tasks.length > 0) {
                        message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`;
                    } else if (actions[actionIndex].includes('project') && projects.length > 0) {
                        message += ` ${projects[Math.floor(Math.random() * projects.length)]}`;
                    } else if (actions[actionIndex].includes('file') && files.length > 0) {
                        message += ` ${files[Math.floor(Math.random() * files.length)]}`;
                    }

                    let timestampMillis;
                    if (count === 1) {
                        timestampMillis = nowMillis - Math.random() * 1000 * 10;
                    } else {
                        timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.5 + 300000);
                    }
                     timestampMillis = Math.min(timestampMillis, nowMillis);


                    newActivities.push({
                        id: nowMillis + i + Math.floor(Math.random()*1000),
                        icon: icons[actionIndex],
                        message: message,
                        timestamp: new Date(timestampMillis),
                        isNew: false
                    });
                }
                return count > 1 ? newActivities.sort((a, b) => b.timestamp - a.timestamp) : newActivities;
            }


            function generateMockNotifications(count, baseTimestampMillis) {
                 const nowMillis = baseTimestampMillis || Date.now();
                 const newNotifications = [];
                 const types = [
                     { msg: 'New task assigned:', icon: 'fa-tasks', type: 'task' },
                     { msg: 'Project deadline approaching:', icon: 'fa-clock', type: 'project' },
                     { msg: 'Mentioned you in comment:', icon: 'fa-comment-dots', type: 'comment' },
                     { msg: 'System update scheduled', icon: 'fa-info-circle', type: 'system' },
                     { msg: 'File shared with you:', icon: 'fa-file-alt', type: 'file' },
                 ];
                 const tasks = MOCK_TASKS.map(t => `'${t.name.substring(0, 20)}...'`);
                 const projects = MOCK_PROJECTS.map(p => `'${p.name}'`);
                 const users = MOCK_USERS.map(u => u.name.split(' ')[0]);
                 if (users.length === 0) users.push('System');
                 const files = ['report.docx', 'logo.svg', 'data.csv'];

                 for (let i = 0; i < count; i++) {
                     const typeInfo = types[Math.floor(Math.random() * types.length)];
                     let message = typeInfo.msg;
                     if (typeInfo.type === 'task' && tasks.length > 0) message += ` ${tasks[Math.floor(Math.random() * tasks.length)]}`;
                     else if (typeInfo.type === 'project' && projects.length > 0) message += ` ${projects[Math.floor(Math.random() * projects.length)]}`;
                     else if (typeInfo.type === 'comment' && users.length > 0) message += ` by ${users[Math.floor(Math.random() * users.length)]}`;
                     else if (typeInfo.type === 'file' && files.length > 0 && users.length > 0) message += ` ${files[Math.floor(Math.random() * files.length)]} by ${users[Math.floor(Math.random() * users.length)]}`;

                     let timestampMillis;
                     if (count === 1) {
                         timestampMillis = nowMillis - Math.random() * 1000 * 15;
                     } else {
                         timestampMillis = nowMillis - (Math.random() * 1000 * 3600 * (i + 1) * 1.8 + 180000);
                     }
                      timestampMillis = Math.min(timestampMillis, nowMillis);

                     newNotifications.push({
                         id: nowMillis + i + 10000 + Math.floor(Math.random()*1000),
                         icon: typeInfo.icon,
                         message: message,
                         timestamp: new Date(timestampMillis),
                         unread: count === 1 ? true : Math.random() > 0.3
                     });
                 }
                 return count > 1 ? newNotifications.sort((a, b) => b.timestamp - a.timestamp) : newNotifications;
             }

            function showConfirmModal(title, message, onConfirm, buttonClass = 'btn-danger') {
                confirmTitle.textContent = title;
                confirmMessage.innerHTML = message;
                confirmCallback = onConfirm;
                 confirmBtn.className = 'btn';
                 confirmBtn.classList.add(buttonClass);
                confirmModal.classList.add('active');
            }

            function hideConfirmModal() {
                confirmModal.classList.remove('active');
                confirmCallback = null;
            }

             function showSuccessMessage(message) {
                 successMessageText.textContent = message;
                 successMessage.classList.add('show');
                 setTimeout(() => {
                     successMessage.classList.remove('show');
                 }, 3000);
             }

             function showToast(message, type = 'info') {
                 if (!showToasts && type !== 'error') {
                    console.log("Toast suppressed by preference:", message);
                    return;
                 }
                 toastMessage.textContent = message;
                 toastMessage.className = 'toast'; // Reset classes
                 if (type === 'success') toastMessage.classList.add('success');
                 else if (type === 'error') toastMessage.classList.add('error');
                 toastMessage.classList.add('show');
                 setTimeout(() => {
                     toastMessage.classList.remove('show');
                 }, 3000);
             }

            // --- Start Application ---
            initDashboard();
        });
    </script>
    </body>
    </html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->

    <!-- Bootstrap 5 CSS (Needed for Features) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- SweetAlert2 CSS (for File Sharing) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981; /* Used as Success in some features */
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc; /* Light Background */
            --white: #ffffff; /* True white (e.g., card backgrounds) */
            --gray: #64748b;
            --light-gray: #e2e8f0; /* Borders */
            --info: #0dcaf0; /* Bootstrap cyan for info */
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981; /* Explicit success */
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */
            --dashboard-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%); /* Fancy Header Gradient */

            /* High Contrast Variables */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Base Colors */
            --base-bg-color: var(--light);
            --base-text-color: var(--dark);
            --card-bg-color: var(--white);
            --card-border-color: var(--light-gray);
            --card-shadow-color: rgba(0, 0, 0, 0.05);
            --input-bg-color: var(--white);
            --input-border-color: var(--light-gray);
            --input-focus-border-color: var(--primary);
            --input-focus-shadow-color: rgba(37, 99, 235, 0.1);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6;
             --schedule-weekend-text: #9ca3af;
             --shift-morning-bg: #dbeafe; --shift-morning-text: #1e40af; --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe; --shift-afternoon-text: #0c4a6e; --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe; --shift-night-text: #5b21b6; --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4; --shift-off-text: #166534; --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2; --shift-sick-text: #991b1b; --shift-sick-border: #fecaca;
             --shift-vacation-bg: #ffedd5; --shift-vacation-text: #9a3412; --shift-vacation-border: #fed7aa;

            /* --- Team Members Feature Specific Variables --- */
            /* --feature-team-bg: var(--white); --feature-team-card-bg: var(--white); --feature-team-border-color: var(--light-gray); --feature-team-shadow-color: rgba(0, 0, 0, 0.05); --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); --feature-team-text-primary: var(--dark); --feature-team-text-secondary: var(--gray); --feature-team-title-text: var(--dark); --feature-team-title-bg: var(--light); --feature-team-admin-color: var(--danger); --feature-team-supervisor-color: var(--primary); --feature-team-senior-color: var(--success); --feature-team-member-color: var(--gray); --feature-team-card-border-radius: 12px; --feature-team-section-padding: 1.5rem; --feature-team-card-padding: 1.25rem; --feature-team-grid-gap: 1.5rem; */
            /* Simplified - using base vars now */

            /* --- Projects Feature Specific Variables --- */
            /* --feature-projects-body-bg: var(--primary-light); --feature-projects-card-bg: var(--white); --feature-projects-text-color: var(--text-color); --feature-projects-text-muted: var(--gray); --feature-projects-heading-color: var(--primary-dark); --feature-projects-border-color: var(--light-gray); --feature-projects-shadow-color: rgba(0, 0, 0, 0.08); --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12); --feature-projects-input-bg: var(--white); --feature-projects-input-border: var(--light-gray); --feature-projects-input-focus-border: var(--primary); --feature-projects-input-focus-shadow: rgba(37, 99, 235, 0.1); --feature-projects-primary-color: var(--primary); --feature-projects-primary-hover: var(--primary-dark); --feature-projects-primary-text: var(--white); --feature-projects-success-bg: #dcfce7; --feature-projects-success-text: #15803d; --feature-projects-success-progress: var(--success); --feature-projects-warning-bg: #fef3c7; --feature-projects-warning-text: #a16207; --feature-projects-warning-progress: var(--warning); --feature-projects-warning-btn-text: var(--dark); --feature-projects-info-bg: #e0f2fe; --feature-projects-info-text: #075985; --feature-projects-info-progress: var(--primary); --feature-projects-secondary-bg: var(--light-gray); --feature-projects-secondary-text: var(--gray); --feature-projects-secondary-progress: var(--gray); --feature-projects-danger-color: var(--danger); --feature-projects-danger-hover: #dc2626; --feature-projects-danger-text: var(--white); --feature-projects-progress-bar-bg: var(--light-gray); --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5); */
            /* Simplified - using base vars now */

            /* --- File Sharing Variables --- */
            /* --feature-filesharing-primary: var(--primary); --feature-filesharing-secondary: var(--gray); --feature-filesharing-success: var(--success); --feature-filesharing-danger: var(--danger); --feature-filesharing-warning: var(--warning); --feature-filesharing-info: var(--info); --feature-filesharing-light: var(--light); --feature-filesharing-dark: var(--dark); --feature-filesharing-hover-bg: #eef4ff; --feature-filesharing-header-bg: var(--dashboard-header-bg); */
            /* Simplified - using base vars now */

            /* --- Project Tracking Variables --- */
             --chart-background: #F5F7FA;
             --status-completed-bg: rgba(76, 175, 80, 0.15); --status-completed-text: #388E3C;
             --status-inprogress-bg: rgba(33, 150, 243, 0.15); --status-inprogress-text: #1976D2;
             --status-delayed-bg: rgba(255, 193, 7, 0.15); --status-delayed-text: #FFA000;
             --status-pending-bg: rgba(158, 158, 158, 0.15); --status-pending-text: #616161;
             --priority-high-bg: rgba(244, 67, 54, 0.15); --priority-high-text: #D32F2F;
             --priority-medium-bg: rgba(255, 193, 7, 0.15); --priority-medium-text: #FFA000;
             --priority-low-bg: rgba(76, 175, 80, 0.15); --priority-low-text: #388E3C;
            /* --feature-tracking-primary: var(--primary); --feature-tracking-secondary: var(--gray); --feature-tracking-success: var(--success); --feature-tracking-danger: var(--danger); --feature-tracking-warning: var(--warning); --feature-tracking-info: var(--info); --feature-tracking-purple: #6f42c1; --feature-tracking-orange: #fd7e14; --feature-tracking-teal: #20c997; --feature-tracking-light: var(--light); --feature-tracking-dark: var(--dark); --feature-tracking-hover-bg: #eef4ff; --feature-tracking-header-bg: var(--dashboard-header-bg); --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-gray: #9E9E9E; --chart-purple: #9C27B0; --chart-cyan: #00BCD4; */
            /* Simplified - using base vars now */

            /* --- Reports & Analytics Variables --- */
             --feature-reports-chart-background: #F5F7FA;
             --feature-reports-chart-fill-opacity: 0.7;
             --feature-reports-chart-radar-fill-opacity: 0.15;
             /* Reusing chart colors from Project Tracking */
            /* --feature-reports-primary: var(--primary); --feature-reports-secondary: var(--gray); --feature-reports-success: var(--success); --feature-reports-danger: var(--danger); --feature-reports-warning: var(--warning); --feature-reports-info: var(--info); --feature-reports-purple: #6f42c1; --feature-reports-orange: #fd7e14; --feature-reports-teal: #20c997; --feature-reports-light: var(--light); --feature-reports-dark: var(--dark); --feature-reports-hover-bg: #eef4ff; --feature-reports-header-bg: var(--dashboard-header-bg); */
            /* Simplified - using base vars now */

             /* Innovation Hub Variables (Default Light) */
             --feature-hub-header-bg-start: #6f42c1;
             --feature-hub-header-bg-end: #0d6efd;
             --feature-hub-header-text-color: var(--white);
             --feature-hub-status-review-bg: #cfe2ff;
             --feature-hub-status-review-text: #0a58ca;
             --feature-hub-status-implemented-bg: #d1e7dd;
             --feature-hub-status-implemented-text: #146c43;
             --feature-hub-status-rejected-bg: #f8d7da;
             --feature-hub-status-rejected-text: #842029;
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--base-bg-color); color: var(--base-text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode --- */
        body.high-contrast {
             /* ... existing high contrast styles ... */
             --dark: var(--hc-text); --light: var(--hc-background); --gray: var(--hc-text); --light-gray: var(--hc-border); --white: var(--hc-background); --primary: var(--hc-primary); --primary-dark: var(--hc-primary); --primary-light: #e0e0ff; --secondary: var(--hc-secondary); --success: var(--hc-secondary); --warning: #ffa500; --danger: #ff0000; --info: var(--hc-primary);
             --sidebar-bg: var(--hc-background); --sidebar-text: var(--hc-text); --sidebar-hover: #e0e0e0; --sidebar-active: #c0c0c0; --sidebar-divider: var(--hc-border);
             --base-text-color: var(--hc-text); --base-bg-color: var(--hc-background); --card-bg-color: var(--hc-background); --card-border-color: var(--hc-border); --input-bg-color: var(--hc-background); --input-border-color: var(--hc-border);
             --schedule-weekend-bg: #dddddd; --schedule-weekend-text: var(--hc-text);
             --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border);
             --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border);
             --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border);
             --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border);
             --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border);
             --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border);
              /* Feature Variables HC */
              /* Team, Projects, Files, Tracking, Reports: Use base HC vars */
              --chart-background: var(--hc-background);
              --status-completed-bg: transparent; --status-completed-text: var(--hc-secondary); --status-inprogress-bg: transparent; --status-inprogress-text: var(--hc-primary); --status-delayed-bg: transparent; --status-delayed-text: var(--warning); --status-pending-bg: transparent; --status-pending-text: var(--hc-text);
              --priority-high-bg: transparent; --priority-high-text: var(--danger); --priority-medium-bg: transparent; --priority-medium-text: var(--warning); --priority-low-bg: transparent; --priority-low-text: var(--hc-secondary);
              /* Innovation Hub HC */
              --feature-hub-header-bg-start: var(--hc-primary); --feature-hub-header-bg-end: var(--hc-primary); --feature-hub-header-text-color: var(--hc-background);
              --feature-hub-status-review-bg: transparent; --feature-hub-status-review-text: var(--hc-primary); --feature-hub-status-implemented-bg: transparent; --feature-hub-status-implemented-text: var(--hc-secondary); --feature-hub-status-rejected-bg: transparent; --feature-hub-status-rejected-text: var(--danger);

             color: var(--base-text-color);
             background-color: var(--base-bg-color);
        }
        /* ... other existing HC overrides targeting specific elements ... */
        body.high-contrast .welcome-section,
        body.high-contrast .stat-card,
        body.high-contrast .top-nav,
        body.high-contrast .sidebar,
        body.high-contrast .activity-section,
        body.high-contrast .content-section,
        body.high-contrast .card, /* Generic card for features */
        body.high-contrast .feature-header, /* Generic feature header */
        body.high-contrast .feature-content, /* Generic feature content */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section, /* Specific overrides if needed */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section,
        body.high-contrast #featureSectionsContainer.projects-feature .project-card,
        body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper,
        body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-page-header,
        body.high-contrast #featureSectionsContainer.task-management-feature .controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-list,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card-header,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .filters-section,
        body.high-contrast #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .table,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .card-header,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-filters-section,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-reminders,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .card-header,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-filters-section,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .chart-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .hub-header, /* Innovation Hub HC */
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .submission-form-container,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .suggestion-card,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .admin-controls {
            background: var(--hc-background) !important; /* Override gradients etc */
            border: 1px solid var(--hc-border) !important;
            color: var(--base-text-color) !important;
            box-shadow: none !important; /* Remove shadows in HC */
        }
        body.high-contrast .btn,
        body.high-contrast .form-control,
        body.high-contrast .form-select, /* Include form-select */
        body.high-contrast textarea, /* Include textarea */
        body.high-contrast .search-bar input,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-filter input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-search-input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-filter-select,
        body.high-contrast #featureSectionsContainer.task-management-feature #search-input,
        body.high-contrast #featureSectionsContainer.task-management-feature .filters select,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form input,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form textarea,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form select,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-control, /* HC Inputs for File Sharing */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-select,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .form-select, /* HC Inputs for Project Tracking */
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .form-control, /* HC Inputs for Reports */
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group label,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature select, /* Innovation Hub HC */
        body.high-contrast #featureSectionsContainer.innovation-hub-feature textarea {
            border: 1px solid var(--hc-border) !important;
            background: var(--hc-background) !important;
            color: var(--base-text-color) !important;
        }
        body.high-contrast .btn-primary,
        body.high-contrast #featureSectionsContainer.projects-feature .add-project-btn,
        body.high-contrast #featureSectionsContainer.task-management-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.team-members-feature .add-team-member-btn,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .button-primary {
            background-color: var(--hc-primary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important;
        }
        body.high-contrast .btn-danger,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .button-danger { background-color: var(--danger) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-warning { background-color: var(--warning) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-success { background-color: var(--hc-secondary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-outline,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .btn-outline-secondary, /* HC outline buttons */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-outline-secondary {
             background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important;
        }
        body.high-contrast .btn-outline-danger { background: var(--hc-background) !important; color: var(--danger) !important; border: 1px solid var(--danger) !important;}
        body.high-contrast .btn-outline-success { background: var(--hc-background) !important; color: var(--hc-secondary) !important; border: 1px solid var(--hc-secondary) !important;}
        body.high-contrast .btn-outline-info { background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important;}
        body.high-contrast .logo { color: var(--base-text-color) !important; }
        body.high-contrast .logo-icon { color: var(--hc-primary) !important; }
        body.high-contrast .menu-item { color: var(--base-text-color) !important; border-left-color: transparent !important; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0 !important; border-left-color: var(--hc-primary) !important; color: var(--hc-text) !important; }
        body.high-contrast .stat-card { border-left-width: 3px !important; background: var(--hc-background) !important; } /* Reset gradient */
        body.high-contrast .welcome-section { background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; color: var(--base-text-color) !important;}
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text) !important; } /* Reset role color */
        body.high-contrast .badge, /* Target general badge for simplicity */
        body.high-contrast #featureSectionsContainer.team-members-feature .member-role,
        body.high-contrast #featureSectionsContainer.projects-feature .project-status,
        body.high-contrast #featureSectionsContainer.task-management-feature .status-badge,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .badge, /* HC Badge */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .status-badge, /* HC Tracking Badge */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .priority-badge,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .badge,
        body.high-contrast #featureSectionsContainer.innovation-hub-feature .suggestion-status { /* Innovation Hub HC */
            border: 1px solid var(--hc-border) !important; color: var(--base-text-color) !important; background: none !important; padding: 3px 8px !important;
        }
        body.high-contrast .progress-bar,
        body.high-contrast #featureSectionsContainer.projects-feature .progress-bar,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .progress-bar,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .progress-bar {
             border: 1px solid var(--hc-border) !important; color: var(--base-text-color) !important; background: none !important;
        }
         body.high-contrast .progress,
         body.high-contrast #featureSectionsContainer.projects-feature .progress-bar-container,
         body.high-contrast #featureSectionsContainer.project-tracking-feature .progress,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .progress {
             background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important;
         }
        body.high-contrast #featureSectionsContainer.projects-feature .project-participants span,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .assigned-team span {
             border: 1px solid var(--hc-border) !important; color: var(--base-text-color) !important; background: none !important;
        }
         body.high-contrast .theme-preview { border: 2px solid var(--hc-border) !important; background: var(--hc-background) !important; /* Override inline styles */ }
         body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary) !important; }
         body.high-contrast .switch .slider { background-color: #999 !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary) !important; }
         body.high-contrast .switch .slider:before { background-color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th { background: var(--hc-background) !important; color: var(--base-text-color) !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border: 1px solid var(--hc-border) !important; background: var(--hc-background) !important; /* Override nth-child */ }
         body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name { background: var(--hc-background) !important; border-right: 2px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-name,
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-date { color: var(--base-text-color) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift { border: 1px solid var(--hc-border) !important; background: none !important; color: var(--base-text-color) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift-weekend-off { border: none !important; font-style: normal !important; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
         body.high-contrast #featureSectionsContainer.task-management-feature .modal-content,
         body.high-contrast #featureSectionsContainer.task-management-feature .controls { border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card { border-left-width: 3px !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .file-icon { color: var(--base-text-color) !important; /* Reset specific icon colors */}
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area { border-color: var(--hc-border) !important; background: var(--hc-background) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--base-text-color) !important; }
         body.high-contrast .fancy-header-title, /* Generic */
         body.high-contrast #featureSectionsContainer.file-sharing-feature .fancy-header-title,
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-fancy-title,
         body.high-contrast #featureSectionsContainer.innovation-hub-feature .hub-header h1 { /* Innovation Hub HC */
             background: var(--hc-primary) !important; color: var(--hc-background) !important;
         }
         body.high-contrast .table thead, /* Generic Table */
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table thead,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table thead,
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead {
             background: var(--hc-background) !important; color: var(--base-text-color) !important; border-bottom-color: var(--hc-border) !important;
         }
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-pagination button { background: var(--hc-background) !important; color: var(--base-text-color) !important; border-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group .btn-check + label { border-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group .btn-check:checked + label { background-color: var(--hc-primary) !important; color: var(--hc-background) !important; }
         body.high-contrast canvas { border: 1px dashed var(--hc-border); /* Make charts visible */ }


        /* --- Sidebar Styles --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; text-decoration: none;}
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; color: rgba(16, 185, 129, 0.9); font-size: 0.85rem; flex-shrink: 0; }
        .connection-status span { font-weight: 600; } /* Added bold */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--card-bg-color); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--card-border-color); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--input-border-color); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--input-bg-color); color: var(--base-text-color); } /* Use base-text-color */
        .search-bar input:focus { outline: none; border-color: var(--input-focus-border-color); box-shadow: 0 0 0 3px var(--input-focus-shadow-color); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--base-text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use base-text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--base-text-color); } /* Use base-text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--base-text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use base-text-color */
        .dropdown-item:hover { background-color: var(--base-bg-color); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; /* Smooth background transition */
        }
        /* ... other existing welcome, stats, activity styles ... */
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; color: inherit; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); }
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--secondary); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--card-bg-color); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px var(--card-shadow-color);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary); /* Colored border */
            color: var(--base-text-color); /* Ensure text inside uses appropriate theme color */
        }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--secondary); background: var(--stat-card-bg-2); }
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }

        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-title { font-size: 0.9rem; color: var(--base-text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use base-text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        .stat-card:nth-child(1) .stat-value { color: #1e40af; }
        .stat-card:nth-child(2) .stat-value { color: #15803d; }
        .stat-card:nth-child(3) .stat-value { color: #b45309; }
        .stat-card:nth-child(4) .stat-value { color: #b91c1c; }

        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 1px 3px var(--card-shadow-color); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--base-text-color); } /* Use base-text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--card-border-color); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--base-text-color); } /* Use base-text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .activity-item:hover .delete-activity { opacity: 1; }
        .delete-activity:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }

        /* --- Profile & Settings Sections Styles --- */
        .content-section {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--card-shadow-color);
            padding: 2rem; /* Base padding */
            transition: padding 0.3s ease, background-color 0.3s ease;
            display: none; /* Hidden by default */
            animation: fadeInContent 0.4s ease-in-out;
        }
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }

        /* Remove padding from feature container itself, apply to inner elements if needed */
        #featureSectionsContainer {
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            border-radius: 0;
        }
        /* Style for the optional generic card wrapper within features */
        #featureSectionsContainer > .card {
            border: none; /* Use dashboard standard border */
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--card-shadow-color);
            background-color: var(--card-bg-color);
            margin-bottom: 0; /* Remove margin as it's the main container */
            overflow: hidden; /* Prevents content bleed */
        }
         /* Generic Feature Header */
        .feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1.5rem; /* Match dashboard content padding */
            border-bottom: 1px solid var(--card-border-color);
            background-color: var(--base-bg-color); /* Use lighter background for header area */
            /* No border-radius needed if part of a card */
        }
        .feature-title {
            font-size: 1.5rem; /* Match section title */
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
        }
        .feature-actions { display: flex; gap: 0.75rem; align-items: center; }

        /* Generic Feature Content Area */
        .feature-content {
            padding: 1.5rem; /* Match dashboard content padding */
            /* Background handled by card or main section */
        }


        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem;} /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--base-text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use base-text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        /* Shared input styles */
        .form-control, .form-select, textarea { /* Added textarea */
            width: 100%; padding: 0.75rem; border: 1px solid var(--input-border-color); border-radius: 6px; font-size: 1rem; background-color: var(--input-bg-color); color: var(--base-text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use base-text-color */
        body.compact .form-control, body.compact .form-select, body.compact textarea { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control, body.spacious .form-select, body.spacious textarea { padding: 1rem; }
        .form-control:focus, .form-select:focus, textarea:focus { outline: none; border-color: var(--input-focus-border-color); box-shadow: 0 0 0 3px var(--input-focus-shadow-color); }
        .form-control[readonly] { background-color: var(--base-bg-color); cursor: not-allowed; opacity: 0.7; } /* Use base-bg-color */
        textarea { resize: vertical; min-height: 80px; /* Default textarea height */ }

        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        /* Base Button Styles (Ensure consistency) */
        .btn, button, #featureSectionsContainer button { /* Apply to all buttons */
             padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; /* For link buttons */ line-height: 1.5; /* Standard line height */ vertical-align: middle; /* Align properly */ }
        body.compact .btn, body.compact button { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn, body.spacious button { padding: 1rem 2rem; }
        .btn-primary, button.button-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled), button.button-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-warning { background-color: var(--warning); color: var(--primary-dark); }
        .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger, button.button-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled), button.button-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn-secondary, button.button-secondary { background-color: var(--gray); color: white; }
        .btn-secondary:hover:not(:disabled), button.button-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover:not(:disabled) { background-color: #0a9aaf; }

        .btn:disabled, button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.8rem !important; }
        .btn-outline-secondary { background-color: transparent; border: 1px solid var(--gray); color: var(--gray); }
        .btn-outline-secondary:hover:not(:disabled) { background-color: var(--light-gray); }
        .btn-outline-success { background-color: transparent; border: 1px solid var(--success); color: var(--success); }
        .btn-outline-success:hover:not(:disabled) { background-color: rgba(16, 185, 129, 0.1); }
        .btn-outline-danger { background-color: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-outline-danger:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.1); }
        .btn-outline-info { background-color: transparent; border: 1px solid var(--info); color: var(--info); }
        .btn-outline-info:hover:not(:disabled) { background-color: rgba(13, 202, 240, 0.1); }

        .settings-tabs { display: flex; border-bottom: 1px solid var(--card-border-color); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        /* Settings Sub-section */
        .settings-subsection { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--card-border-color); }
        .settings-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-subsection h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 1rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; /* Default: Label takes full width */ }
        @media (min-width: 768px) { .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; } }
        .setting-item-label { font-weight: 500; color: var(--base-text-color); } /* Use base-text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; } }


        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--base-text-color); margin-bottom: 1rem; } /* Use base-text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        /* Settings Panel Team Member Card Style */
        #settingsContent .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--card-border-color); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--card-bg-color); }
        body.compact #settingsContent .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious #settingsContent .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        #settingsContent .team-member-card:hover { box-shadow: 0 2px 4px var(--card-shadow-color); border-color: var(--primary); }
        #settingsContent .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact #settingsContent .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        #settingsContent .member-details { flex: 1; min-width: 0; }
        #settingsContent .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--base-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use base-text-color */
        body.compact #settingsContent .member-name { font-size: 0.9rem; }
        #settingsContent .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact #settingsContent .member-email { font-size: 0.8rem; }
        #settingsContent .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact #settingsContent .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        #settingsContent .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        #settingsContent .role-senior { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); } /* Changed color to secondary */
        #settingsContent .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        #settingsContent .role-member { background-color: rgba(100, 116, 139, 0.1); color: var(--gray); } /* Changed bg/color */
        #settingsContent .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #settingsContent .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--card-border-color); border-radius: 8px; background-color: var(--base-bg-color); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */

        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }

        /* --- Theme Styles & Dark Mode Overrides --- */
        body.light-theme { /* Light theme uses base :root vars */ }
        body.dark-theme { /* Dark theme overrides */
             --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #1e293b;
             --dark: #e2e8f0; --light: #334155; --white: #0f172a; --gray: #94a3b8; --light-gray: #475569;
             --base-bg-color: #0f172a; --base-text-color: #e2e8f0; --card-bg-color: #1e293b; --card-border-color: #475569; --card-shadow-color: rgba(255, 255, 255, 0.05);
             --input-bg-color: #334155; --input-border-color: #475569;
             --sidebar-bg: #1e293b; --sidebar-divider: #475569; --sidebar-text: rgba(226, 232, 240, 0.9); --sidebar-hover: rgba(59, 130, 246, 0.1); --sidebar-active: rgba(59, 130, 246, 0.2);
             --schedule-weekend-bg: #262f3e; --schedule-weekend-text: #6b7280;
             --shift-morning-bg: #1e3a8a; --shift-morning-text: #dbeafe; --shift-morning-border: #2563eb;
             --shift-afternoon-bg: #0e7490; --shift-afternoon-text: #ecfeff; --shift-afternoon-border: #22d3ee;
             --shift-night-bg: #581c87; --shift-night-text: #f3e8ff; --shift-night-border: #a855f7;
             --shift-off-bg: #064e3b; --shift-off-text: #d1fae5; --shift-off-border: #34d399;
             --shift-sick-bg: #881337; --shift-sick-text: #fecdd3; --shift-sick-border: #fb7185;
             --shift-vacation-bg: #7c2d12; --shift-vacation-text: #ffedd5; --shift-vacation-border: #fb923c;
              /* Feature Dark Variables */
             --chart-background: #1e293b;
             --status-completed-bg: rgba(76, 175, 80, 0.2); --status-completed-text: #86efac;
             --status-inprogress-bg: rgba(59, 130, 246, 0.2); --status-inprogress-text: #93c5fd;
             --status-delayed-bg: rgba(245, 158, 11, 0.2); --status-delayed-text: #fcd34d;
             --status-pending-bg: rgba(158, 158, 158, 0.2); --status-pending-text: #94a3b8;
             --priority-high-bg: rgba(244, 67, 54, 0.2); --priority-high-text: #fca5a5;
             --priority-medium-bg: rgba(245, 158, 11, 0.2); --priority-medium-text: #fcd34d;
             --priority-low-bg: rgba(76, 175, 80, 0.2); --priority-low-text: #86efac;
             /* Innovation Hub Dark */
             --feature-hub-header-bg-start: #5a3b9a;
             --feature-hub-header-bg-end: #0b5ed7;
             --feature-hub-status-review-bg: #0a58ca;
             --feature-hub-status-review-text: #cfe2ff;
             --feature-hub-status-implemented-bg: #146c43;
             --feature-hub-status-implemented-text: #d1e7dd;
             --feature-hub-status-rejected-bg: #842029;
             --feature-hub-status-rejected-text: #f8d7da;
        }
        /* ... other existing dark theme overrides ... */
        body.dark-theme .top-nav { background-color: var(--card-bg-color); border-bottom-color: var(--card-border-color); }
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme #settingsContent .team-member-card, body.dark-theme .add-member-form { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme .search-bar input, body.dark-theme .form-control, body.dark-theme .form-select, body.dark-theme textarea { background-color: var(--input-bg-color); border-color: var(--input-border-color); color: var(--base-text-color); }
        body.dark-theme .form-control[readonly] { background-color: var(--card-bg-color); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme .search-result-item { color: var(--base-text-color); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme .dropdown-item { color: var(--base-text-color); }
        body.dark-theme .dropdown-item:hover { background-color: var(--base-bg-color); }
        body.dark-theme .notifications-container { background-color: var(--card-bg-color); }
        body.dark-theme .notification-list-item:hover { background-color: var(--base-bg-color); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); }
        body.dark-theme .confirm-container, body.dark-theme .modal-content { background-color: var(--card-bg-color); color: var(--base-text-color); }
        body.dark-theme .theme-option .theme-preview { border-color: var(--card-border-color); background: linear-gradient(45deg, var(--card-bg-color) 50%, var(--base-bg-color) 50%); }
        body.dark-theme .theme-option .light-preview { background: var(--light) !important; } /* Use correct dark theme var for light preview */
        body.dark-theme .theme-option .dark-preview { background: var(--base-bg-color) !important; } /* Use correct dark theme var for dark preview */
        body.dark-theme .theme-option .system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--base-bg-color) 50%) !important; color: var(--gray);}
        body.dark-theme .theme-option.selected .theme-preview { border-color: var(--primary); }
        body.dark-theme .theme-option .theme-label { color: var(--base-text-color); }
        body.dark-theme .back-button { color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--card-bg-color); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--card-bg-color); border-top-color: var(--card-border-color); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white); }
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; }
        body.dark-theme .user-info-name { color: inherit; }
        body.dark-theme .user-info-title { color: var(--gray); }
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email span { color: inherit; }
        body.dark-theme .stat-card { background: var(--card-bg-color); color: var(--base-text-color);}
        body.dark-theme .stat-title { color: var(--base-text-color); }
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; }
        body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; }
        body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; }
        body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        body.dark-theme .activity-item { border-bottom-color: var(--card-border-color); }
        body.dark-theme .activity-message { color: var(--base-text-color); }
        body.dark-theme .activity-time { color: var(--gray); }
        body.dark-theme .activity-item.new-activity { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(239, 68, 68, 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--base-text-color); }
        body.dark-theme #profileAvatarLarge { background-color: var(--card-bg-color); color: var(--base-text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); }
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--card-border-color); }
        body.dark-theme .placeholder-content h2 { color: var(--base-text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--base-text-color); }
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--base-text-color); }
        body.dark-theme .settings-subsection h4 { color: #93c5fd; }
        body.dark-theme .setting-item-label { color: var(--base-text-color); }
        body.dark-theme .setting-item-description { color: var(--gray); }
        body.dark-theme .qr-code-placeholder { border-color: var(--card-border-color); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; }
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); }
        body.dark-theme .checkbox-group { border-color: var(--card-border-color); }
        body.dark-theme .checkbox-group label { color: var(--base-text-color); }
        body.dark-theme .confirm-title { color: var(--base-text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: #93c5fd; }
        body.dark-theme #settingsContent .team-member-card .member-name { color: var(--base-text-color); }
        body.dark-theme #settingsContent .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--base-text-color); }
        body.dark-theme .user-name { color: var(--base-text-color); }
        body.dark-theme .toast { background-color: var(--card-bg-color); color: var(--base-text-color); }
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }

        /* Dark Theme: Feature Specific Overrides */
        /* Employee Scheduling */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-container { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-bottom-color: var(--card-border-color);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--base-text-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--base-bg-color); } /* Use base bg for even rows */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--card-bg-color); border-right-color: var(--card-border-color); color: var(--base-text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: var(--base-text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; font-style: italic;}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border);}
        /* Task Management */
        body.dark-theme #featureSectionsContainer.task-management-feature .card { background-color: var(--card-bg-color); border-color: var(--card-border-color); } /* Use card style */
        body.dark-theme #featureSectionsContainer.task-management-feature .task-page-header { background: var(--dashboard-header-bg); color: var(--white); }
        body.dark-theme #featureSectionsContainer.task-management-feature .controls { background-color: var(--base-bg-color); border-bottom-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-list { background-color: var(--card-bg-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-card { background-color: var(--base-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed { background-color: var(--light); border-left-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-card h3 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-card p, body.dark-theme #featureSectionsContainer.task-management-feature .task-card .description, body.dark-theme #featureSectionsContainer.task-management-feature .task-meta { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-card strong { color: var(--base-text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .status-badge { color: var(--base-text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .status-Pending { background-color: var(--warning); color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .status-InProgress { background-color: var(--primary); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .status-Completed { background-color: var(--success); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-actions { border-top-color: var(--card-border-color); }
        /* Team Members */
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section { background-color: var(--card-bg-color); border-color: var(--card-border-color);}
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section-header { background-color: var(--base-bg-color); color: var(--base-text-color); border-bottom-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"] { background-color: var(--input-bg-color); color: var(--base-text-color); border-color: var(--input-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--base-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-name { color: var(--base-text-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-email { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: var(--gray); color: var(--base-bg-color); }
        /* Projects */
        body.dark-theme #featureSectionsContainer.projects-feature #projects-section { /* No bg needed, handled by container */ }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--card-bg-color); border-left-color: var(--primary); }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.projects-feature .project-controls { background-color: var(--card-bg-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-search-input, body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--input-bg-color); color: var(--base-text-color); border-color: var(--input-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-card { background-color: var(--base-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info i { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: color-mix(in srgb, var(--base-bg-color) 80%, var(--gray) 20%); color: var(--base-text-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-actions { border-top-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed ~ .progress-bar-container .progress-bar { background-color: var(--success); color: var(--white); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress ~ .progress-bar-container .progress-bar { background-color: var(--warning); color: var(--dark); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active ~ .progress-bar-container .progress-bar { background-color: var(--primary); color: var(--white); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending ~ .progress-bar-container .progress-bar { background-color: var(--gray); color: var(--white); }
        /* File Sharing, Project Tracking, Reports */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card-header,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card-header { background-color: var(--base-bg-color) !important; border-color: var(--card-border-color) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .fancy-header-title,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--dashboard-header-bg) !important; color: white !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .project-name,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .employee-name { color: var(--base-text-color) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .text-muted,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .text-muted,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .text-muted { color: var(--gray) !important; }
        body.dark-theme .table thead { background-color: var(--base-bg-color) !important; color: var(--gray) !important; border-bottom-color: var(--card-border-color) !important; }
        body.dark-theme .table-hover > tbody > tr:hover > * { background-color: var(--light) !important; } /* Slightly lighter shade for hover */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--base-bg-color) !important; border-color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--card-bg-color) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--chart-background) !important; border-color: var(--card-border-color) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--card-bg-color) !important; border-color: var(--card-border-color) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li { border-bottom-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--light); }
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--chart-background) !important; border-color: var(--card-border-color) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
         /* Innovation Hub Dark */
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .hub-header { background: linear-gradient(90deg, var(--feature-hub-header-bg-start), var(--feature-hub-header-bg-end)); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .submission-form-container,
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-card { background-color: var(--card-bg-color); border-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-meta { border-top-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-status.status-under-review { background-color: var(--feature-hub-status-review-bg); color: var(--feature-hub-status-review-text); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-status.status-implemented { background-color: var(--feature-hub-status-implemented-bg); color: var(--feature-hub-status-implemented-text); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .suggestion-status.status-rejected { background-color: var(--feature-hub-status-rejected-bg); color: var(--feature-hub-status-rejected-text); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section { border-top-color: var(--card-border-color); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .supervisor-reply { background-color: var(--base-bg-color); }
        body.dark-theme #featureSectionsContainer.innovation-hub-feature .admin-controls { border-top-color: var(--card-border-color); }
         body.dark-theme #featureSectionsContainer.innovation-hub-feature select,
         body.dark-theme #featureSectionsContainer.innovation-hub-feature textarea { background-color: var(--input-bg-color); border-color: var(--input-border-color); color: var(--base-text-color); }

        /* --- Notifications Modal, Confirm Modal, Utils --- */
        .notifications-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: flex-end; }
        .notifications-modal.active { display: flex; }
        .notifications-container { width: 400px; max-width: 100%; background-color: var(--card-bg-color); height: 100vh; overflow-y: auto; animation: slideIn 0.3s ease-out; box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notifications-header { padding: 1.5rem; border-bottom: 1px solid var(--card-border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--primary); color: white; flex-shrink: 0; }
        .notifications-title { font-size: 1.25rem; font-weight: 600; }
        .close-notifications { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: white; }
        .notifications-body { flex-grow: 1; overflow-y: auto; }
        .notification-list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--card-border-color); transition: background-color 0.2s; display: flex; gap: 1rem; align-items: flex-start; cursor: pointer; position: relative; }
        .notification-list-item:hover { background-color: var(--base-bg-color); }
        .notification-list-item.unread { background-color: rgba(37, 99, 235, 0.08); font-weight: 500; }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); }
        .notification-list-item:last-child { border-bottom: none; }
        .notification-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        body.dark-theme .notification-icon-wrapper { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa;}
        .notification-content { flex: 1; min-width: 0; }
        .notification-message { margin-bottom: 0.25rem; color: var(--base-text-color); line-height: 1.4; }
        .notification-time { font-size: 0.8rem; color: var(--gray); }
        .delete-notification { color: var(--danger); cursor: pointer; opacity: 0; transition: opacity 0.2s; position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem; background: var(--card-bg-color); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .notification-list-item:hover .delete-notification { opacity: 0.6; }
        .delete-notification:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); }
        body.dark-theme .delete-notification { background: var(--card-bg-color); }
        body.dark-theme .delete-notification:hover { background: rgba(239, 68, 68, 0.2); }
        .no-notifications-message { text-align: center; padding: 2rem; color: var(--gray); }
        .notifications-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--card-border-color); display: flex; justify-content: space-between; flex-shrink: 0; background-color: var(--base-bg-color); flex-wrap: wrap; gap: 0.5rem; }
        .confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .confirm-modal.active { display: flex; }
        .confirm-container { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: 400px; max-width: 90%; padding: 2rem; animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--base-text-color); }
        .confirm-message { margin-bottom: 1.5rem; line-height: 1.5; color: var(--gray); }
        .confirm-actions { display: flex; justify-content: flex-end; gap: 1rem; }
        .success-message { position: fixed; top: 20px; right: 20px; background-color: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 0.75rem; z-index: 1200; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .success-message.show { transform: translateX(0); }
        .success-message i { font-size: 1.25rem; }
        .back-button { display: inline-flex; align-items: center; gap: 0.75rem; color: var(--primary); font-weight: 500; cursor: pointer; margin-bottom: 1.5rem; padding: 0.6rem 1.2rem; border-radius: 6px; transition: background-color 0.2s, border-color 0.2s, color 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .back-button:hover { background-color: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        .back-button i { transition: transform 0.2s; font-size: 0.8rem; }
        .back-button:hover i { transform: translateX(-3px); }
        #notificationSound { display: none; }
        .d-none { display: none !important; }
        .placeholder-content { text-align: center; padding: 4rem 2rem; color: var(--gray); border: 2px dashed var(--card-border-color); border-radius: 8px; margin: 1.5rem; /* Add margin to position it */ min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: border-color 0.3s, color 0.3s; background-color: var(--card-bg-color); }
        .placeholder-content h2 { color: var(--base-text-color); margin-bottom: 1rem; }
        .placeholder-content p { color: var(--gray); }
        .placeholder-content .loading-indicator { font-size: 1.2rem; margin-top: 1rem; }
        .placeholder-content .error-message { color: var(--danger); font-weight: 500; margin-top: 1rem; white-space: pre-wrap; text-align: left; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; max-width: 100%; overflow-wrap: break-word; }


        /* --- Generic Modal Styles (Add/Edit Member, Project, etc.) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1050;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--card-bg-color); width: 100%; max-width: 550px;
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem; max-height: 90vh; overflow-y: auto; animation: zoomIn 0.3s ease-out;
            color: var(--base-text-color);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--card-border-color);
        }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        body.dark-theme .modal-title { color: #93c5fd; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--gray); line-height: 1;}
        .close-modal:hover { color: var(--danger); }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- Checkbox Group --- */
         .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid var(--card-border-color); border-radius: 6px; }
         .checkbox-group label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--base-text-color); }
         .checkbox-group input[type="checkbox"] { width: auto; margin-right: 0.25rem; }
         .settings-link { color: var(--primary); text-decoration: none; cursor: pointer; }
         .settings-link:hover { text-decoration: underline; color: var(--primary-dark); }

        /* --- Toast --- */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--dark); color: var(--white); padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1300; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 0.9rem; }
        .toast.show { opacity: 1; bottom: 30px; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }

        /* --- Employee Scheduling Table Refinements --- */
        #featureSectionsContainer.employee-scheduling .schedule-page-header { border-bottom: 1px solid var(--card-border-color); margin-bottom: 1rem; }
        #featureSectionsContainer.employee-scheduling .schedule-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem; padding: 0 1.5rem; }
        #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; justify-content: center; }
        #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #featureSectionsContainer.employee-scheduling .schedule-container { margin: 0 1.5rem 1.5rem; /* Add horizontal margin */ overflow-x: auto; border: 1px solid var(--card-border-color); border-radius: 8px; background-color: var(--card-bg-color); }
        #featureSectionsContainer.employee-scheduling .schedule-table { width: 100%; min-width: 900px; border-collapse: separate; border-spacing: 0; }
        #featureSectionsContainer.employee-scheduling .schedule-table thead th { padding: 0.8rem 0.75rem; text-align: center; background-color: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark); border-right: 1px solid var(--primary-dark); }
         #featureSectionsContainer.employee-scheduling .schedule-table thead th:last-child { border-right: none; }
         #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { /* Employee Header */ position: sticky; left: 0; z-index: 11 !important; border-right: 2px solid var(--primary-dark); background-color: var(--primary); }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-color: var(--card-border-color); }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary-dark); border-right: 2px solid var(--card-border-color); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--card-border-color); border-right: 1px solid var(--card-border-color); vertical-align: middle; transition: background-color 0.2s; color: var(--base-text-color); white-space: nowrap; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td:last-child { border-right: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:last-child td { border-bottom: none; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td { background-color: var(--base-bg-color); }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td { background-color: var(--primary-light); }
        #featureSectionsContainer.employee-scheduling .employee-name { font-weight: 600; text-align: left; position: sticky; left: 0; z-index: 5; background-color: var(--card-bg-color); border-right: 2px solid var(--card-border-color); /* Match border */ }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--base-bg-color); }
         body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--card-bg-color); border-right-color: var(--card-border-color); } /* Adjusted dark mode sticky */
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--base-bg-color); }
         #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: var(--primary-light); }
         body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
        #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        #featureSectionsContainer.employee-scheduling .shift { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; min-width: 70px; border: 1px solid transparent; cursor: default; }
        #featureSectionsContainer.employee-scheduling .shift.editable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #featureSectionsContainer.employee-scheduling .shift.editable:hover { transform: scale(1.05); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent !important; font-style: italic; border: none; cursor: default; font-weight: normal; }
        #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border); }
        #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border); }
        #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border); }
        #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border); }
        #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border); }
        #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border); }
        #featureSectionsContainer.employee-scheduling .day-header { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; }
        #featureSectionsContainer.employee-scheduling .day-name { font-weight: 600; font-size: 0.9rem; color: inherit; }
        #featureSectionsContainer.employee-scheduling .day-date { font-size: 0.8rem; opacity: 0.8; color: inherit; }

        /* --- START: Appearance & Theme Refinements --- */
        #preferencesPanel .theme-options-container { display: flex; gap: 1.5rem; margin-top: 0.5rem; flex-wrap: wrap; justify-content: flex-start; margin-bottom: 1.5rem; padding: 0.5rem 0; }
        #preferencesPanel .theme-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 8px; transition: background-color 0.2s, box-shadow 0.2s; min-width: 100px; border: 2px solid transparent; background-color: var(--card-bg-color); }
        body.dark-theme #preferencesPanel .theme-option { background-color: var(--card-bg-color); }
        #preferencesPanel .theme-option:hover { background-color: var(--primary-light); box-shadow: 0 2px 5px var(--card-shadow-color); }
        body.dark-theme #preferencesPanel .theme-option:hover { background-color: var(--light-gray); box-shadow: 0 2px 5px var(--card-shadow-color); }
        #preferencesPanel .theme-option.selected { border-color: var(--primary); background-color: var(--primary-light); }
         body.dark-theme #preferencesPanel .theme-option.selected { background-color: var(--primary-dark); border-color: var(--primary); }
        #preferencesPanel .theme-option .theme-preview { width: 60px; height: 40px; border: 1px solid var(--gray); border-radius: 6px; transition: border-color 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 0.75rem; background-color: var(--white); overflow: hidden; }
        #preferencesPanel .theme-option .theme-label { text-align: center; display: block; font-size: 0.9rem; font-weight: 500; color: var(--base-text-color); }
         body.dark-theme #preferencesPanel .theme-option .theme-label { color: var(--base-text-color); }
        #preferencesPanel .theme-preview.light-preview { background-color: var(--light); color: var(--dark); border-color: var(--light-gray);}
        #preferencesPanel .theme-preview.dark-preview { background-color: var(--base-bg-color); color: var(--dark); border-color: var(--gray);}
        #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--base-bg-color) 50%); color: var(--gray); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview { border-color: var(--card-border-color); }
        body.dark-theme #preferencesPanel .theme-preview.light-preview { background: var(--light) !important; color: var(--dark); border-color: var(--light-gray);}
        body.dark-theme #preferencesPanel .theme-preview.dark-preview { background: var(--base-bg-color) !important; color: var(--dark); border-color: var(--gray);}
        body.dark-theme #preferencesPanel .theme-preview.system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--base-bg-color) 50%) !important; color: var(--gray); border-color: var(--gray);}
        /* --- END: Appearance & Theme Refinements --- */

        /* --- Settings: Danger Zone Refinements --- */
        #dangerPanel {
            border: 2px solid var(--danger); /* Add border */
            border-radius: 8px;
            padding: 1.5rem;
            background-color: rgba(239, 68, 68, 0.03); /* Subtle background */
        }
        #dangerPanel h3 {
            color: var(--danger);
            margin-bottom: 0.5rem;
        }
        #dangerPanel p {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }
        .danger-zone-item {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px dashed var(--card-border-color);
            gap: 1rem; /* Space between text and button */
        }
        .danger-zone-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .danger-zone-item div {
            flex-grow: 1; /* Allow text to take available space */
        }
        .danger-zone-item h5 {
            font-weight: 600;
            color: var(--base-text-color);
            margin-bottom: 0.25rem;
        }
        .danger-zone-item p {
            font-size: 0.9rem;
            color: var(--gray);
            margin: 0; /* Reset margin for inner p */
        }
        .danger-zone-item .btn {
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        body.dark-theme #dangerPanel {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }
        body.dark-theme .danger-zone-item h5 { color: var(--base-text-color); }
        body.dark-theme .danger-zone-item p { color: var(--gray); }
        body.dark-theme .danger-zone-item { border-color: var(--card-border-color); }
         /* --- END: Danger Zone Refinements --- */

         /* --- Feature Specific CSS (Simplified) --- */
         /* Team Members Feature View */
         #featureSectionsContainer.team-members-feature .team-members-section { background-color: var(--card-bg-color); border-radius: 8px; max-width: 1200px; margin: 0 auto; box-shadow: 0 1px 3px var(--card-shadow-color); border: 1px solid var(--card-border-color); }
         #featureSectionsContainer.team-members-feature .team-members-section-header { background-color: var(--base-bg-color); border-bottom: 1px solid var(--card-border-color); }
         #featureSectionsContainer.team-members-feature .team-filter input { background-color: var(--input-bg-color); border-color: var(--input-border-color); color: var(--base-text-color); }
         #featureSectionsContainer.team-members-feature .team-filter input:focus { border-color: var(--input-focus-border-color); box-shadow: 0 0 0 3px var(--input-focus-shadow-color); }
         #featureSectionsContainer.team-members-feature .team-members-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
         #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); box-shadow: 0 1px 2px var(--card-shadow-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
         #featureSectionsContainer.team-members-feature .team-member-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px var(--card-shadow-color); }
         #featureSectionsContainer.team-members-feature .member-name { color: var(--base-text-color); }
         #featureSectionsContainer.team-members-feature .member-email { color: var(--gray); }
         #featureSectionsContainer.team-members-feature .member-role { color: #fff; } /* White text on colored bg */
         #featureSectionsContainer.team-members-feature .member-role.role-admin { background-color: var(--danger); }
         #featureSectionsContainer.team-members-feature .member-role.role-supervisor { background-color: var(--primary); }
         #featureSectionsContainer.team-members-feature .member-role.role-senior { background-color: var(--success); }
         #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: var(--gray); }

         /* Projects Feature View */
         #featureSectionsContainer.projects-feature #projects-section { width: 100%; max-width: 1200px; margin: 0 auto; }
         #featureSectionsContainer.projects-feature .projects-header { margin-bottom: 1.5rem; }
         #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--card-bg-color); border-left: 5px solid var(--primary); }
         #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--primary-dark); }
         #featureSectionsContainer.projects-feature .project-controls { background-color: var(--card-bg-color); }
         #featureSectionsContainer.projects-feature .project-search-input, #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--input-bg-color); color: var(--base-text-color); border-color: var(--input-border-color); }
         #featureSectionsContainer.projects-feature .project-search-input:focus, #featureSectionsContainer.projects-feature .project-filter-select:focus { border-color: var(--input-focus-border-color); box-shadow: 0 0 0 3px var(--input-focus-shadow-color); }
         #featureSectionsContainer.projects-feature .projects-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
         #featureSectionsContainer.projects-feature .project-card { background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); box-shadow: 0 2px 4px var(--card-shadow-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
         #featureSectionsContainer.projects-feature .project-card:hover { transform: translateY(-4px); box-shadow: 0 5px 10px var(--card-shadow-color); }
         #featureSectionsContainer.projects-feature .project-name { color: var(--primary-dark); }
         #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--light-gray); }
         #featureSectionsContainer.projects-feature .progress-bar { transition: width 0.4s ease, background-color 0.3s ease; }
         #featureSectionsContainer.projects-feature .project-info { color: var(--gray); }
         #featureSectionsContainer.projects-feature .project-info i { color: var(--gray); }
         #featureSectionsContainer.projects-feature .project-participants span { background-color: var(--base-bg-color); color: var(--base-text-color); border: 1px solid var(--card-border-color); }
         #featureSectionsContainer.projects-feature .project-status { font-weight: 600; text-transform: uppercase; }
         #featureSectionsContainer.projects-feature .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
         #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); } /* Mapping In Progress to Delayed style */
         #featureSectionsContainer.projects-feature .status-active { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); } /* Mapping Active to InProgress style */
         #featureSectionsContainer.projects-feature .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
         #featureSectionsContainer.projects-feature .project-actions { border-top: 1px solid var(--card-border-color); }
         #featureSectionsContainer.projects-feature .status-completed ~ .progress-bar-container .progress-bar { background-color: var(--success); color: white; }
         #featureSectionsContainer.projects-feature .status-in-progress ~ .progress-bar-container .progress-bar { background-color: var(--warning); color: var(--dark); }
         #featureSectionsContainer.projects-feature .status-active ~ .progress-bar-container .progress-bar { background-color: var(--primary); color: white; }
         #featureSectionsContainer.projects-feature .status-pending ~ .progress-bar-container .progress-bar { background-color: var(--gray); color: white; }

          /* Tables - Consistent Alignment & Padding */
         .table { width: 100%; margin-bottom: 1rem; color: var(--base-text-color); border-collapse: collapse; }
         .table td, .table th { padding: 0.85rem 0.75rem; vertical-align: middle; text-align: left; border-top: 1px solid var(--card-border-color); }
         .table thead th { vertical-align: bottom; border-bottom: 2px solid var(--primary-dark); background-color: var(--base-bg-color); color: var(--gray); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
         .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: var(--base-bg-color); }
         .table-hover > tbody > tr:hover > * { background-color: var(--primary-light); }
         .table .text-center { text-align: center !important; }
         .table .text-end { text-align: right !important; }

         /* Responsive */
         @media (max-width: 992px) {
             .sidebar { transform: translateX(-100%); width: 250px; box-shadow: none; }
             .sidebar.active { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
             .main-content { margin-left: 0; }
             .search-bar { width: 250px; }
             .main-content.sidebar-active { margin-left: 250px; }
             .sidebar-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
             .top-nav { padding-left: 60px; }
             #featureSectionsContainer.task-management-feature .task-list { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
             #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
             #featureSectionsContainer.projects-feature .projects-header { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.projects-feature .projects-title-wrapper { width: auto; }
             #featureSectionsContainer.projects-feature .project-controls { justify-content: flex-start; }
         }
         @media (min-width: 993px) { .sidebar-toggle { display: none; } }
         @media (max-width: 768px) {
             .top-nav { flex-direction: column; gap: 1rem; padding: 1rem; padding-left: 1rem; }
             .search-bar { width: 100%; order: 2; }
             .user-menu { width: 100%; justify-content: space-between; order: 1; }
             .content-area { padding: 1.5rem; }
             .data-form { grid-template-columns: 1fr; }
             .form-actions { grid-column: span 1; }
             .user-info { flex-direction: column; text-align: center; }
             .user-info-avatar { margin-bottom: 1rem; }
             .stats-section { grid-template-columns: 1fr; }
             .settings-tabs { flex-wrap: nowrap; overflow-x: auto; }
             .settings-tab { padding: 0.5rem 1rem; flex-shrink: 0; }
             .confirm-container { width: 90%; }
             #settingsContent .team-member-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
             #settingsContent .member-role { margin: 0.5rem 0; }
             #settingsContent .member-actions { margin-top: 0.5rem; width: 100%; justify-content: flex-end; }
             .profile-avatar-section { margin-bottom: 1.5rem; }
             #profileAvatarLarge { width: 100px; height: 100px; font-size: 2.5rem; }
             .add-member-form .data-form { grid-template-columns: 1fr; align-items: stretch; }
             .add-member-form .data-form > div { margin-bottom: 1rem; }
             .add-member-form .data-form > div:last-child { margin-top: 0; }
             #featureSectionsContainer.employee-scheduling .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; padding: 0 1rem; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .week-nav { justify-content: space-between; width: 100%; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions { margin-left: 0; width: 100%; }
             #featureSectionsContainer.employee-scheduling .schedule-controls .admin-actions .btn { width: 100%; justify-content: center; }
             #featureSectionsContainer.employee-scheduling .schedule-page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
             #featureSectionsContainer.employee-scheduling .schedule-container { margin: 0 1rem 1rem; }
             #featureSectionsContainer.employee-scheduling .schedule-table { border-spacing: 0; }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th, #featureSectionsContainer.employee-scheduling .schedule-table tbody td { white-space: nowrap; }
             #featureSectionsContainer.employee-scheduling .employee-name { position: sticky !important; left: 0; z-index: 5 !important; border-right: 1px solid var(--card-border-color); background-color: var(--card-bg-color); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--card-bg-color); border-right-color: var(--card-border-color); }
             #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { position: sticky !important; left: 0; z-index: 11 !important; background-color: var(--primary); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th:first-child { background-color: var(--primary-dark); }
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--base-bg-color); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--base-bg-color); }
             #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: var(--primary-light); }
             body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
             .modal-content { width: 95%; padding: 1.5rem;}
             .notifications-container { width: 100%; max-width: 100%; }
             .sidebar-toggle { top: 10px; left: 10px; }
             .top-nav { padding-top: 60px; }
             #featureSectionsContainer.task-management-feature .controls { flex-direction: column; align-items: stretch; gap: 10px; }
             #featureSectionsContainer.task-management-feature .search-container { margin: 0; }
             #featureSectionsContainer.task-management-feature #add-task-btn { width: 100%; margin-left: 0; order: -1; margin-bottom: 10px; }
             #featureSectionsContainer.task-management-feature .filters { flex-direction: column; width: 100%; gap: 10px; }
             #featureSectionsContainer.task-management-feature .filters select { width: 100%; min-width: unset; }
             #featureSectionsContainer.task-management-feature .task-list { grid-template-columns: 1fr; }
             #featureSectionsContainer.task-management-feature .modal-content { width: 95%; padding: 20px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-row { flex-direction: column; gap: 15px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-row > div { min-width: unset; }
             #featureSectionsContainer.task-management-feature .task-management-content h1 { font-size: 1.8em; }
             #featureSectionsContainer.team-members-feature .team-content-area, #featureSectionsContainer.team-members-feature .team-members-section-header { padding-left: 15px; padding-right: 15px; }
             #featureSectionsContainer.team-members-feature .team-members-section-header h2 { font-size: 1.5rem;}
             #featureSectionsContainer.team-members-feature .team-members-section-header { padding-top: 18px; padding-bottom: 18px; }
             #featureSectionsContainer.team-members-feature .team-filter { max-width: none; }
             #featureSectionsContainer.team-members-feature .team-member-card { flex-direction: column; align-items: flex-start; }
             #featureSectionsContainer.projects-feature .projects-list { grid-template-columns: 1fr; gap: 20px; }
             #featureSectionsContainer.projects-feature .project-controls { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.projects-feature .project-search-input, #featureSectionsContainer.projects-feature .project-filter-select, #featureSectionsContainer.projects-feature .add-project-btn { width: 100%; box-sizing: border-box; }
             #featureSectionsContainer.projects-feature .project-card-image { height: 160px; }
             #featureSectionsContainer.projects-feature .project-name { font-size: 1.25em; }
             #featureSectionsContainer.projects-feature .project-actions .btn { padding: 7px 12px; font-size: 0.8em; }
             #preferencesPanel .theme-options-container { justify-content: center; }
             #featureSectionsContainer.file-sharing-feature .filters-section .col-md-1 { text-align: left !important; margin-top: 0.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 150px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination { justify-content: center; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .row > div { margin-bottom: 0.5rem; }
             #featureSectionsContainer.reports-analytics-feature .ra-export-buttons { text-align: left; margin-top: 0.5rem; }
             /* Innovation Hub Responsive */
             #featureSectionsContainer.innovation-hub-feature .hub-header h1 { font-size: 1.5rem; }
             #featureSectionsContainer.innovation-hub-feature #suggestions-list { grid-template-columns: 1fr; } /* Stack cards */
             #featureSectionsContainer.innovation-hub-feature .hub-controls { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls .form-group, #featureSectionsContainer.innovation-hub-feature .hub-controls button { width: 100%; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form .form-row { flex-direction: column; align-items: stretch; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form .form-row button { margin-top: 0.5rem; width: 100%; }
         }
         @media (max-width: 480px) {
             .section-header > div { justify-content: center; width: 100%; }
             .welcome-section { padding: 1.5rem; }
             .stats-section { gap: 0.75rem; }
             .stat-card { padding: 1rem; }
             .user-menu { gap: 1rem; }
             .user-name { display: none; }
             .user-status { margin-left: 0; }
             .notifications-footer { flex-direction: column; gap: 0.5rem; }
             .notifications-footer .btn { width: 100%; justify-content: center; }
             #featureSectionsContainer.task-management-feature { padding: 10px; }
             #featureSectionsContainer.task-management-feature .feature-content { padding: 15px; }
             #featureSectionsContainer.task-management-feature .btn { font-size: 0.95em; padding: 9px 15px; }
             #featureSectionsContainer.task-management-feature .modal-content .form-actions .btn { padding: 10px 20px; }
             #featureSectionsContainer.task-management-feature .task-card { padding: 15px; }
             #featureSectionsContainer.task-management-feature .task-card h3 { font-size: 1.15em; }
             #featureSectionsContainer.task-management-feature .task-card p, #featureSectionsContainer.task-management-feature .task-card .description, #featureSectionsContainer.task-management-feature .task-meta { font-size: 0.9em; }
             #featureSectionsContainer.task-management-feature .task-actions button { font-size: 1.1em; margin-left: 8px; }
             #featureSectionsContainer.task-management-feature .modal-content { padding: 20px 15px; }
             #featureSectionsContainer.task-management-feature .modal-content #modal-title { font-size: 1.5em; margin-bottom: 20px; }
             #featureSectionsContainer.team-members-feature .team-members-list { grid-template-columns: 1fr; gap: 15px; }
             #featureSectionsContainer.team-members-feature .team-member-card { padding: 18px; }
             #featureSectionsContainer.team-members-feature .member-name { font-size: 1.1rem; }
             #featureSectionsContainer.team-members-feature .member-email { font-size: 0.85rem; margin-bottom: 12px; }
             #featureSectionsContainer.team-members-feature .member-role { font-size: 0.8rem; padding: 3px 8px; }
             #featureSectionsContainer.projects-feature .project-actions .btn { flex-grow: 1; justify-content: center; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn { padding: 0.3rem 0.7rem; font-size: 0.85rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table tbody td { padding: 0.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-badge,
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-badge { padding: 3px 8px; font-size: 0.7rem; }
              /* Innovation Hub Small Screen */
              #featureSectionsContainer.innovation-hub-feature .hub-header { padding: 1rem 1.5rem; }
              #featureSectionsContainer.innovation-hub-feature .hub-header h1 { font-size: 1.3rem; }
              #featureSectionsContainer.innovation-hub-feature .submission-form-container { padding: 1rem; }
              #featureSectionsContainer.innovation-hub-feature .suggestion-card { padding: 1rem; }
              #featureSectionsContainer.innovation-hub-feature .suggestion-text-display { font-size: 0.95rem; }
         }
    </style>
</head>
<body class=""> <!-- JS applies theme -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Toast/Success Messages -->
    <div class="toast" id="toastMessage">Toast message</div>
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#dashboard" class="logo" data-feature="dashboard">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </a>
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>

             <div class="menu-title">Core Features</div>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a> <!-- NEW -->

             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a> <!-- Restored -->
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a> <!-- NEW -->
             <a href="#deadline-tracker" class="menu-item" data-feature="deadline-tracker"><i class="fas fa-stopwatch"></i><span>Deadline Tracker</span></a> <!-- NEW -->

             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span> <!-- Styling adjusted in CSS -->
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults"></div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer">
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status"> • Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--base-text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                      <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light"> <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div> <span class="theme-label">Light</span> </div>
                                 <div class="theme-option" data-theme="dark"> <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div> <span class="theme-label">Dark</span> </div>
                                 <div class="theme-option" data-theme="system"> <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div> <span class="theme-label">System</span> </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div> <span class="setting-item-label">High Contrast Mode</span> <p class="setting-item-description">Increase text visibility for accessibility.</p> </div>
                            <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="highContrastToggle"> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="languageSelect">Language</label> <select id="languageSelect" class="form-select"> <option value="en">English (US)</option> <option value="ar">العربية (Arabic)</option> <option value="es">Español (Spanish)</option> </select> </div>
                             <div class="form-group"> <label for="regionSelect">Region / Timezone</label> <select id="regionSelect" class="form-select"> <option value="utc">UTC</option> <option value="est">EST (UTC-5)</option> <option value="pst">PST (UTC-8)</option> <option value="cet">CET (UTC+1)</option> <option value="eet">EET (UTC+2)</option> <option value="ast">AST (UTC+3) - Riyadh</option> </select> </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="timeFormatSelect">Time Format</label> <select id="timeFormatSelect" class="form-select"> <option value="12h">12-hour (e.g., 3:00 PM)</option> <option value="24h">24-hour (e.g., 15:00)</option> </select> </div>
                              <div class="form-group"> <label for="dateFormatSelect">Date Format</label> <select id="dateFormatSelect" class="form-select"> <option value="MM/DD/YYYY">MM/DD/YYYY</option> <option value="DD/MM/YYYY">DD/MM/YYYY</option> <option value="YYYY-MM-DD">YYYY-MM-DD</option> <option value="Month D, YYYY">Month D, YYYY</option> </select> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Toast Notifications</span> <p class="setting-item-description">Show brief confirmation messages for actions.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="toastToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Sound Notifications</span> <p class="setting-item-description">Play a sound for new notifications and activities.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="soundToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="form-group"> <label for="notificationToneSelect">Notification Tone</label> <select id="notificationToneSelect" class="form-select" disabled> <option value="default">Default</option> <option value="tone1">Tone 1 (Placeholder)</option> <option value="tone2">Tone 2 (Placeholder)</option> </select> <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p> </div>
                         <div class="form-group"> <label class="settings-label">Keyboard Shortcuts</label> <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p> <button class="btn btn-outline btn-sm" disabled>View Shortcuts</button> </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                    <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group"> <label for="accountEmail">Current Email</label> <input type="email" id="accountEmail" class="form-control" value="" readonly> </div>
                             <div class="form-group"> <label for="changeEmail">New Email Address</label> <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <p class="setting-item-description">Changing email requires backend verification.</p> </div>
                             <div class="form-group" style="grid-column: span 2;"> <label for="accountConfirmPassword">Confirm Password (to change email)</label> <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> </div>
                            <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Account Notifications</span> <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="accountNotificationsToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                      <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group"> <label for="currentPassword">Current Password</label> <input type="password" id="currentPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="newPassword">New Password</label> <input type="password" id="newPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="confirmPassword">Confirm New Password</label> <input type="password" id="confirmPassword" class="form-control"> </div>
                             <div class="form-actions"> <button type="submit" class="btn btn-primary">Change Password</button> </div>
                         </form>
                     </div>
                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;"> <span class="status-indicator disabled" id="twoFaStatusIndicator" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; background-color: var(--gray); transition: background-color 0.3s;"></span> <span id="twoFaStatusText" style="font-weight: 500;">2FA is currently Disabled</span> </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>
                         <div id="twoFaSetupSection" style="display: block; margin-top: 1rem;">
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none; margin-top: 1rem;">
                                 <h5 style="margin-bottom: 0.75rem; font-size: 1rem;">Choose Setup Method:</h5>
                                 <div class="two-fa-actions" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;"> <button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button> <button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button> </div>
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;"> <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p> <div class="qr-code-placeholder" style="width: 150px; height: 150px; border: 1px solid var(--card-border-color); display: flex; align-items: center; justify-content: center; color: var(--gray); margin: 1rem auto;">QR Placeholder</div> <p>2. Enter the 6-digit code generated by your app below.</p> <div class="form-group" style="max-width: 200px;"> <label for="authCode">Verification Code</label> <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6"> </div> <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> </div>
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;"> <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p> <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button> <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup"> <label for="smsCode">SMS Verification Code</label> <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6" style="max-width: 200px;"> </div> <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button> </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none; margin-top: 1rem;"> <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p> <div class="two-fa-actions" style="display: flex; gap: 1rem;"> <button class="btn btn-outline" disabled>View Recovery Codes</button> <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"> <label for="sessionDuration">Session Duration (minutes)</label> <input type="number" id="sessionDuration" class="form-control" value="60" min="15"> <p class="setting-item-description">Set how long a login session remains active.</p> </div>
                            <div class="form-group"> <label for="idleTimeout">Idle Timeout (minutes)</label> <input type="number" id="idleTimeout" class="form-control" value="15" min="5"> <p class="setting-item-description">Automatically logout after inactivity.</p> </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> </div>
                     </div>
                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Email Notifications</span> <p class="setting-item-description">Receive summaries and important alerts via email.</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="emailNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable In-App Notifications</span> <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="inAppNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span> <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="pushNotificationsToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group"> <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label> <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label> <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label> <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label> <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label> <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <div class="form-group"> <label for="notificationPriority">Minimum Notification Priority</label> <select id="notificationPriority" class="form-select" disabled> <option value="low">Low</option> <option value="medium">Medium</option> <option value="high">High</option> </select> <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p> </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> </div>
                 </div>

                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                      <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <div class="team-list" id="teamList"> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-select" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                             <!-- Admin Action: Delete All -->
                             <div class="mt-4 pt-3 border-top" id="deleteAllUsersSection" style="display: none;"> <!-- Initially hidden -->
                                 <h5 class="text-danger">Bulk Actions</h5>
                                 <div class="d-flex justify-content-between align-items-center">
                                     <div>
                                         <p class="mb-0">Delete all non-administrator users.</p>
                                         <small class="text-muted">This action cannot be undone.</small>
                                     </div>
                                     <button class="btn btn-danger" id="deleteAllNonAdminUsersBtn"> <i class="fas fa-users-slash"></i> Delete Non-Admins </button>
                                 </div>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                      <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;"> <button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Connect Slack</button> <button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button> <button class="btn btn-outline" disabled><i class="fab fa-github"></i> Connect GitHub</button> </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item"> <div> <span class="setting-item-label">Allow External Sharing Links</span> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="externalSharingToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                         <button class="btn btn-outline" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline" disabled>Set Default Permissions</button>
                     </div>
                 </div>

                 <!-- Danger Zone Panel (Refined) -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger); margin-bottom: 0.5rem;">Danger Zone</h3>
                     <p style="color: var(--gray); margin-bottom: 1.5rem;">These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p>This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Delete Account</h5>
                            <p>Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for dynamically loaded feature sections -->
             <div id="featureSectionsContainer" class="content-section">
                 <!-- Placeholder initially visible -->
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
                 <!-- Feature content will be injected here -->
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications">×</button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button>
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="memberModalTitle">Member Details</h3> <button class="close-modal" data-close-modal>×</button> </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group"> <label for="memberFirstName">First Name</label> <input type="text" id="memberFirstName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberLastName">Last Name</label> <input type="text" id="memberLastName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberEmail">Email</label> <input type="email" id="memberEmail" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberRole">Role</label> <select id="memberRole" class="form-select" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                      <div class="form-group"> <label for="memberTitle">Job Title</label> <input type="text" id="memberTitle" class="form-control"> </div>
                      <div class="form-group"> <label for="memberDepartment">Department</label> <input type="text" id="memberDepartment" class="form-control"> </div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button> </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="projectModalTitle">Project Details</h3> <button class="close-modal" data-close-modal>×</button> </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;">
                    <div class="form-group"> <label for="projectName">Project Name</label> <input type="text" id="projectName" class="form-control" required> </div>
                    <div class="form-group"> <label for="projectDescription">Description</label> <textarea id="projectDescription" class="form-control" rows="3"></textarea> </div>
                     <div class="form-group"> <label for="projectParticipantsInput">Participants (Separate with | )</label> <input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S."> </div>
                    <div class="form-group"> <label for="projectImageInput">Image URL (Optional)</label> <input type="url" id="projectImageInput" class="form-control" placeholder="https://..."> </div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                         <div class="form-group"> <label for="projectStartDate">Start Date</label> <input type="date" id="projectStartDate" class="form-control"> </div>
                        <div class="form-group"> <label for="projectDueDate">Due Date</label> <input type="date" id="projectDueDate" class="form-control"> </div>
                         <div class="form-group"> <label for="projectStatus">Status</label> <select id="projectStatus" class="form-select" required> <option value="pending">Pending</option> <option value="active">Active</option> <option value="in-progress">In Progress</option> <option value="completed">Completed</option> </select> </div>
                        <div class="form-group"> <label for="projectProgress">Progress (%)</label> <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0"> </div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button> </div>
            </form>
        </div>
    </div>

    <!-- Shift Edit Modal (Used by Employee Scheduling) -->
    <div class="modal" id="editShiftModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="editShiftModalTitle">Edit Shift</h3> <button class="close-modal" data-close-modal>×</button> </div>
            <form id="editShiftForm">
                <input type="hidden" id="editShiftEmployeeId"> <input type="hidden" id="editShiftDayIndex"> <input type="hidden" id="editShiftWeekOffset">
                <div class="form-group">
                    <label for="shiftType">Shift Type</label>
                    <select id="shiftType" class="form-select"> <option value="morning">Morning (9AM-5PM)</option> <option value="afternoon">Afternoon (12PM-8PM)</option> <option value="night">Night (8PM-4AM)</option> <option value="off">Day Off</option> <option value="sick">Sick Leave</option> <option value="vacation">Vacation</option> </select>
                </div>
                <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary">Save Shift</button> </div>
            </form>
        </div>
    </div>

    <!-- Task Management Modal (Used by Task Management) -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add New Task</h3>
                <button type="button" class="close-btn close-modal" data-close-modal>&times;</button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-name">Task Name</label>
                    <input type="text" id="task-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="task-links">Relevant Links (comma-separated)</label>
                    <input type="text" id="task-links" class="form-control">
                </div>
                <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                    <div>
                        <label for="task-assigned-by">Assigned By</label>
                        <select id="task-assigned-by" class="form-select">
                            <option value="Self Assigned">Self Assigned</option>
                            <option value="Nada Mahmoud">Nada Mahmoud</option>
                            <option value="Yousef Ahmed">Yousef Ahmed</option>
                            <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-assigned-to">Assigned To</label>
                        <select id="task-assigned-to" class="form-select">
                            <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                            <option value="Esraa Lashin">Esraa Lashin</option>
                            <option value="Yousef Ahmed">Yousef Ahmed</option>
                            <option value="Bassant Badr">Bassant Badr</option>
                            <option value="Nada Mahmoud">Nada Mahmoud</option>
                        </select>
                    </div>
                </div>
                 <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                    <div>
                        <label for="task-start-date">Start Date</label>
                        <input type="date" id="task-start-date" class="form-control">
                    </div>
                    <div>
                        <label for="task-due-date">Due Date</label>
                        <input type="date" id="task-due-date" class="form-control">
                    </div>
                </div>
                <div class="data-form form-row" style="grid-template-columns: 1fr 1fr;">
                     <div>
                        <label for="task-priority">Priority</label>
                        <select id="task-priority" class="form-select" required>
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-status">Status</label>
                        <select id="task-status" class="form-select" required>
                            <option value="Pending" selected>Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancel-btn" data-close-modal>Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-task-btn">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- File Sharing Modals -->
    <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="uploadFileModalLabel"><i class="fas fa-cloud-upload-alt me-2"></i>Upload New File</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <div class="upload-area" id="dropZone"> <p><i class="fas fa-cloud-upload-alt fa-3x mb-2"></i></p> <p>Drag & drop files here or click to select</p> <input type="file" id="fileInputHidden" multiple hidden> </div> <div class="mb-3"> <label for="fileInputManual" class="form-label">Or select file(s):</label> <input class="form-control form-control-sm" type="file" id="fileInputManual" multiple> </div> <div class="mb-3"> <label for="fileTagsInput" class="form-label"><i class="fas fa-tags me-1"></i>Add Tags (comma-separated):</label> <input type="text" class="form-control form-control-sm" id="fileTagsInput" placeholder="e.g., reports, important, 2024"> </div> <div id="uploadProgressContainer" class="mt-3" style="display: none;"> <div class="d-flex justify-content-between"> <small id="uploadFileName" class="text-muted">Uploading file...</small> <small id="uploadPercentage" class="text-muted">0%</small> </div> <div class="progress mt-1" style="height: 10px;"> <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div> </div> <small id="uploadStatus" class="text-muted d-block mt-1"></small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-sm btn-primary" id="startUploadButton">Start Upload</button> </div> </div> </div> </div>
    <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="filePreviewModalLabel">File Preview</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body text-center" style="min-height: 400px; max-height: 80vh; overflow-y: auto;"> <div id="previewContent"> <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"> <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> </div> </div> </div> <div class="modal-footer justify-content-start py-2"> <small class="text-muted me-3" id="previewFileName">File Name: </small> <small class="text-muted" id="previewFileType">Type: </small> </div> </div> </div> </div>



    <!-- ========= Feature Templates ========= -->

    <!-- Placeholder Template -->
    <template id="placeholderAssets">
        <!-- No specific styles needed, uses .placeholder-content -->
        <div class="placeholder-content">
             <h2>Feature Placeholder</h2>
             <p>This feature is not yet implemented.</p>
        </div>
        <script>
             function initializePlaceholderFeature(container) {
                 console.log("Initializing placeholder feature...");
                 const h2 = container.querySelector('h2');
                 const featureId = container.parentElement.dataset.featureId || 'Feature'; // Get from parent
                 const featureName = featureId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                 if (h2) h2.textContent = featureName;
                 const p = container.querySelector('p');
                 if (p) p.textContent = `Content for ${featureName} will be loaded here.`;
                 return { cleanup: () => console.log(`Cleaning up placeholder for ${featureName}`) };
             }
         </script>
    </template>

    <!-- Template for Task Management -->
    <template id="taskManagementAssets">
        <style id="injected-task-management-styles">
            /* Task Management specific styles - Refactored */
            #featureSectionsContainer.task-management-feature .task-page-header {
                 padding: 1.5rem;
                 background: var(--dashboard-header-bg); /* Use dashboard gradient */
                 color: white;
                 border-radius: 8px 8px 0 0;
                 margin-bottom: 0; /* Remove margin */
                 text-align: center;
            }
            #featureSectionsContainer.task-management-feature .task-page-title {
                 font-size: 1.5rem;
                 font-weight: 600;
                 margin: 0;
            }
             #featureSectionsContainer.task-management-feature .controls {
                 padding: 1.5rem;
                 background-color: var(--base-bg-color); /* Use dashboard bg */
                 border-bottom: 1px solid var(--card-border-color);
             }
             #featureSectionsContainer.task-management-feature .task-list {
                 padding: 1.5rem;
                 background-color: var(--card-bg-color); /* Use dashboard card bg */
                 border-radius: 0 0 8px 8px;
             }
            #featureSectionsContainer.task-management-feature .task-card {
                background-color: var(--card-bg-color); /* Use card background */
                border: 1px solid var(--card-border-color);
                border-left-width: 5px;
                border-radius: 6px;
                padding: 1.25rem; /* Slightly more padding */
                box-shadow: 0 2px 4px var(--card-shadow-color);
                transition: box-shadow 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                position: relative;
            }
            body.dark-theme #featureSectionsContainer.task-management-feature .task-card {
                 background-color: var(--base-bg-color); /* Use darker base bg for cards */
                 border-color: var(--card-border-color);
            }
             #featureSectionsContainer.task-management-feature .task-card h3 {
                 font-size: 1.15em; /* Slightly smaller title */
                 margin-bottom: 0.5rem; /* Reduced margin */
                 color: var(--primary-dark);
                 word-break: break-word;
             }
              body.dark-theme #featureSectionsContainer.task-management-feature .task-card h3 {
                  color: #93c5fd; /* Lighter title */
              }
             #featureSectionsContainer.task-management-feature .task-card .description {
                 color: var(--gray);
                 font-size: 0.85em; /* Smaller description */
                 margin-bottom: 1rem; /* Space before meta */
                 max-height: 60px; /* Limit height */
                 overflow-y: auto;
             }
             #featureSectionsContainer.task-management-feature .task-meta {
                 font-size: 0.8em; /* Smaller meta */
                 color: var(--gray);
                 margin-top: 1rem;
                 border-top: 1px solid var(--card-border-color);
                 padding-top: 1rem;
             }
             #featureSectionsContainer.task-management-feature .status-badge {
                 padding: 3px 10px;
                 border-radius: 12px;
                 font-size: 0.75em; /* Smaller badge */
                 font-weight: 600;
                 color: white;
                 white-space: nowrap;
                 text-transform: uppercase;
                 letter-spacing: 0.5px;
                 vertical-align: middle; /* Align better */
             }
             #featureSectionsContainer.task-management-feature .task-card.status-Completed {
                 background-color: var(--base-bg-color); /* Use base bg for completed */
                 border-left-color: var(--gray);
                 opacity: 0.8;
             }
             body.dark-theme #featureSectionsContainer.task-management-feature .task-card.status-Completed {
                  background-color: var(--light); /* Use light bg for completed */
                  border-left-color: var(--gray);
             }
             #featureSectionsContainer.task-management-feature .task-actions {
                 margin-top: 1rem; /* Space above actions */
                 text-align: right;
                 border-top: 1px solid var(--card-border-color);
                 padding-top: 1rem;
             }
             #featureSectionsContainer.task-management-feature .task-actions button {
                 background: none; border: none; font-size: 1.1em; /* Slightly smaller icons */
                 padding: 5px; /* Reduced padding */
                 margin-left: 8px; vertical-align: middle; color: var(--gray);
                 cursor: pointer; transition: color 0.2s ease, transform 0.2s ease;
             }
             #featureSectionsContainer.task-management-feature .task-actions button:hover { transform: scale(1.1); }
             #featureSectionsContainer.task-management-feature .task-actions .edit-btn:hover { color: var(--primary); }
             #featureSectionsContainer.task-management-feature .task-actions .delete-btn { color: var(--danger); }
             #featureSectionsContainer.task-management-feature .task-actions .complete-btn { color: var(--success); }
             #featureSectionsContainer.task-management-feature .task-actions .reopen-btn { color: var(--warning); }
              /* Priority Borders */
             #featureSectionsContainer.task-management-feature .task-card.priority-High { border-left-color: var(--danger); }
             #featureSectionsContainer.task-management-feature .task-card.priority-Medium { border-left-color: var(--warning); }
             #featureSectionsContainer.task-management-feature .task-card.priority-Low { border-left-color: var(--success); }
             #featureSectionsContainer.task-management-feature .status-Pending { background-color: var(--warning); color: var(--dark); }
             #featureSectionsContainer.task-management-feature .status-InProgress { background-color: var(--primary); color: white; }
             #featureSectionsContainer.task-management-feature .status-Completed { background-color: var(--success); color: white; }
        </style>
        <!-- Task Management Content Area - Wrapped in a card for consistency -->
        <div class="card">
            <div class="task-page-header">
                <h1 class="task-page-title">Task Management</h1>
            </div>
            <div class="task-management-content"> <!-- Inner container -->
                <div class="controls d-flex flex-wrap align-items-center gap-2">
                    <div class="search-container flex-grow-1 me-md-3 position-relative">
                        <i class="fas fa-search search-icon position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input type="text" id="search-input" class="form-control form-control-sm ps-5" placeholder="Search tasks by name, description, assignee...">
                    </div>
                    <div class="filters d-flex flex-wrap gap-2">
                        <select id="filter-status" class="form-select form-select-sm" style="min-width: 130px;">
                            <option value="all" selected>All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <select id="filter-priority" class="form-select form-select-sm" style="min-width: 120px;">
                            <option value="all" selected>All Priorities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                         <select id="filter-assigned-to" class="form-select form-select-sm" style="min-width: 150px;">
                            <option value="all" selected>All Assignees</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <button id="add-task-btn" class="btn btn-primary btn-sm ms-md-auto">
                        <i class="fas fa-plus-circle me-1"></i> Add Task
                    </button>
                </div>
                <div class="task-list mt-4" id="task-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                    <!-- Task cards will be rendered here -->
                     <p class="no-tasks" style="grid-column: 1 / -1;">Loading tasks...</p>
                </div>
            </div>
        </div>
        <script>
            function initializeTaskManagementFeature(container) {
                console.log("Initializing Task Management Feature...");
                // --- DOM Elements ---
                const taskContentContainer = container.querySelector('.task-management-content');
                const addTaskBtn = taskContentContainer?.querySelector('#add-task-btn');
                const taskListDiv = taskContentContainer?.querySelector('#task-list');
                const searchInput = taskContentContainer?.querySelector('#search-input');
                const filterStatusSelect = taskContentContainer?.querySelector('#filter-status');
                const filterPrioritySelect = taskContentContainer?.querySelector('#filter-priority');
                const filterAssignedToSelect = taskContentContainer?.querySelector('#filter-assigned-to');
                // Modal elements (outside container)
                const taskModal = document.getElementById('task-modal');
                const closeModalBtns = taskModal?.querySelectorAll('.close-modal, #cancel-btn');
                const taskForm = taskModal?.querySelector('#task-form');
                const modalTitle = taskModal?.querySelector('#modal-title');
                const saveTaskBtn = taskModal?.querySelector('#save-task-btn');
                const taskIdInput = taskModal?.querySelector('#task-id');
                const taskNameInput = taskModal?.querySelector('#task-name');
                const taskDescriptionInput = taskModal?.querySelector('#task-description');
                const taskLinksInput = taskModal?.querySelector('#task-links');
                const taskAssignedBySelect = taskModal?.querySelector('#task-assigned-by');
                const taskAssignedToSelect = taskModal?.querySelector('#task-assigned-to');
                const taskStartDateInput = taskModal?.querySelector('#task-start-date');
                const taskDueDateInput = taskModal?.querySelector('#task-due-date');
                const taskPrioritySelect = taskModal?.querySelector('#task-priority');
                const taskStatusSelect = taskModal?.querySelector('#task-status');

                if (!taskContentContainer || !taskListDiv || !taskModal || !taskForm || !addTaskBtn || !searchInput || !filterStatusSelect || !filterPrioritySelect || !filterAssignedToSelect) {
                    console.error("Essential Task Management elements missing.");
                    if(taskListDiv) taskListDiv.innerHTML = '<p class="no-tasks text-danger">Error loading task components.</p>';
                    return { cleanup: () => {} };
                 }

                let tasks = []; let listeners = [];
                const addListener = (element, event, handler) => { if (!element) return; element.addEventListener(event, handler); listeners.push({ element, event, handler }); };
                const loadTasks = () => { const storedTasks = localStorage.getItem('dashboard_tasks'); if (storedTasks) { try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); } } else { tasks = getDefaultTasks(); } populateAssigneeFilters(); renderTasks(); };
                function getDefaultTasks() { return [ { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure.", links: "https://nodejs.org", assignedBy: "Nada Mahmoud", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null }, { id: 2, name: "Design UI Mockups", description: "Create mockups for main pages using Figma.", links: "https://figma.com", assignedBy: "Yousef Ahmed", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs.", links: "", assignedBy: "Self Assigned", assignedTo: "Yousef Ahmed", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides.", links: "", assignedBy: "Nada Mahmoud", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null }, { id: 5, name: "Review Code Submission", description: "Review 'feature/login' branch.", links: "https://github.com, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" }, { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Special characters issue.", links: "jira-123", assignedBy: "Yousef Ahmed", assignedTo: "Yousef Ahmed", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } ]; }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };
                const formatDate = (dateString) => window.formatDateForDisplay(dateString);
                const getCurrentDate = () => new Date().toLocaleDateString('en-CA');
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T00:00:00Z'); const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); if (isNaN(dueDate.getTime())) return false; return dueDate < todayUTC; } catch(e) { console.error("Error checking overdue:", e); return false; } };

                 // NEW: Populate Assignee Filters dynamically
                 function populateAssigneeFilters() {
                    const assigneeSet = new Set(window.MOCK_USERS.map(user => user.name));
                    if (!filterAssignedToSelect || !taskAssignedToSelect || !taskAssignedBySelect) return;
                    // Clear existing options (except 'All')
                    filterAssignedToSelect.innerHTML = '<option value="all" selected>All Assignees</option>';
                    taskAssignedToSelect.innerHTML = ''; // Clear all for modal
                    taskAssignedBySelect.innerHTML = '<option value="Self Assigned">Self Assigned</option>'; // Keep Self Assigned

                    // Populate filter
                    assigneeSet.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name; option.textContent = name;
                        filterAssignedToSelect.appendChild(option.cloneNode(true));
                        taskAssignedToSelect.appendChild(option.cloneNode(true));
                        if (name !== window.currentUser?.name) { // Don't add self to 'Assigned By'
                            taskAssignedBySelect.appendChild(option.cloneNode(true));
                        }
                    });
                    // Ensure current user is selected if 'Self Assigned' isn't picked
                    if (taskAssignedBySelect.value === 'Self Assigned' && window.currentUser) {
                        const userOption = taskAssignedBySelect.querySelector(`option[value="${window.currentUser.name}"]`);
                        if (!userOption) { // Add current user if not already there
                           const option = document.createElement('option');
                           option.value = window.currentUser.name; option.textContent = window.currentUser.name;
                           taskAssignedBySelect.appendChild(option);
                        }
                    }
                 }


                const renderTasks = () => {
                    taskListDiv.innerHTML = '';
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusFilter = filterStatusSelect.value;
                    const priorityFilter = filterPrioritySelect.value;
                    const assignedToFilter = filterAssignedToSelect.value;
                    let tasksToDisplay = tasks.filter(task => {
                         const taskStatus = task.status || ''; const taskPriority = task.priority || ''; const taskAssignedTo = task.assignedTo || '';
                         const statusMatch = statusFilter === 'all' || taskStatus === statusFilter;
                         const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter;
                         const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter;
                         const searchMatch = !searchTerm || (task.name || '').toLowerCase().includes(searchTerm) || (task.description || '').toLowerCase().includes(searchTerm) || (task.links || '').toLowerCase().includes(searchTerm) || (task.assignedTo || '').toLowerCase().includes(searchTerm) || (task.assignedBy || '').toLowerCase().includes(searchTerm);
                         return statusMatch && priorityMatch && assignedToMatch && searchMatch;
                    });
                     if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks" style="grid-column: 1 / -1;">No tasks found matching your criteria.</p>'; return; }
                    tasksToDisplay.sort((a, b) => { const statusOrder={"Pending":1,"In Progress":1,"Completed":2}; const statusA=statusOrder[a.status]||3; const statusB=statusOrder[b.status]||3; if(statusA!==statusB)return statusA-statusB; const dateA=a.dueDate?new Date(a.dueDate+'T00:00:00Z'):null; const dateB=b.dueDate?new Date(b.dueDate+'T00:00:00Z'):null; const dateValA=dateA&&!isNaN(dateA)?dateA.getTime():Infinity; const dateValB=dateB&&!isNaN(dateB)?dateB.getTime():Infinity; if(dateValA!==dateValB)return dateValA-dateValB; const priorityOrder={High:3,Medium:2,Low:1}; const priorityA=priorityOrder[a.priority]||0; const priorityB=priorityOrder[b.priority]||0; return priorityB-priorityA; });
                    tasksToDisplay.forEach(task => {
                        const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue');
                        const overdue = isOverdue(task); const overdueText = overdue ? `<span class="overdue-indicator">(Overdue!)</span>` : ''; let linksHTML = 'N/A'; if (task.links && task.links.trim()) { linksHTML=task.links.split(',').map(l=>l.trim()).filter(l=>l).map(link=>{let href=link;let isUrl=false;try{const url=new URL(link.startsWith('http')?link:`http://${link}`);if(url.hostname&&(url.hostname.includes('.')||url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))){isUrl=true;href=url.protocol+"//"+url.hostname+url.pathname+url.search+url.hash;}else{href=link;}}catch(_){isUrl=false;href=link;}const displayText=link.length>35?link.substring(0,32)+'...':link;return isUrl?`<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>`:`<span title="${link}">${displayText}</span>`;}).join(' ');}
                        taskCard.innerHTML = `
                            <h3>${task.name || 'Unnamed'}</h3>
                            ${task.description ? `<p class="description">${task.description}</p>` : ''}
                             <div class="task-meta">
                                 <div><span><strong>To:</strong> ${task.assignedTo || 'N/A'}</span> <span><strong>By:</strong> ${task.assignedBy || 'N/A'}</span></div>
                                <div> <span><strong>Start:</strong> ${formatDate(task.startDate)}</span> <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span> </div>
                                <div> <span><strong>Priority:</strong> ${task.priority || 'N/A'}</span> <span><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${task.status || 'N/A'}</span></span> </div>
                                ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''}
                                <div><strong>Links:</strong> <span class="links">${linksHTML}</span></div>
                             </div>
                            <div class="task-actions">
                                <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                                ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`}
                            </div>`;
                        addListener(taskCard.querySelector('.edit-btn'), 'click', (e) => { e.stopPropagation(); openEditModal(task.id); });
                        addListener(taskCard.querySelector('.delete-btn'), 'click', (e) => { e.stopPropagation(); deleteTask(task.id); });
                        const completeOrReopenBtn = taskCard.querySelector('.complete-btn, .reopen-btn');
                        if(completeOrReopenBtn) addListener(completeOrReopenBtn, 'click', (e) => { e.stopPropagation(); toggleTaskStatus(task.id); });
                        taskListDiv.appendChild(taskCard);
                    });
                };
                const showModal = () => { taskModal.classList.add('active'); document.body.style.overflow = 'hidden'; };
                const hideModal = () => { taskModal.classList.remove('active'); taskForm.reset(); taskIdInput.value = ''; modalTitle.textContent = "Add New Task"; saveTaskBtn.textContent = "Save Task"; document.body.style.overflow = ''; };
                const openAddModal = () => { hideModal(); modalTitle.textContent = "Add New Task"; saveTaskBtn.textContent = "Save Task"; taskStatusSelect.value = "Pending"; taskPrioritySelect.value = "Medium"; showModal(); taskNameInput.focus(); };
                const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task) return; hideModal(); modalTitle.textContent = "Edit Task"; saveTaskBtn.textContent = "Update Task"; taskIdInput.value = task.id; taskNameInput.value = task.name; taskDescriptionInput.value = task.description || ''; taskLinksInput.value = task.links || ''; taskAssignedBySelect.value = task.assignedBy; taskAssignedToSelect.value = task.assignedTo; taskStartDateInput.value = task.startDate || ''; taskDueDateInput.value = task.dueDate || ''; taskPrioritySelect.value = task.priority; taskStatusSelect.value = task.status; showModal(); taskNameInput.focus(); };
                const handleFormSubmit = (event) => { event.preventDefault();const taskId=taskIdInput.value?parseInt(taskIdInput.value):Date.now();const currentTask=tasks.find(t=>t.id===taskId);const newStatus=taskStatusSelect.value;let completionDate=currentTask?.completionDate||null;if(newStatus==='Completed'){if(!taskIdInput.value||(currentTask&&currentTask.status!=='Completed')){completionDate=getCurrentDate();}}else{completionDate=null;}const startDate=taskStartDateInput.value;const dueDate=taskDueDateInput.value;if(startDate&&dueDate&&new Date(dueDate)<new Date(startDate)){alert("Due Date cannot be before Start Date.");taskDueDateInput.focus();return;}const taskData={id:taskId,name:taskNameInput.value.trim(),description:taskDescriptionInput.value.trim(),links:taskLinksInput.value.trim(),assignedBy:taskAssignedBySelect.value,assignedTo:taskAssignedToSelect.value,startDate:startDate||null,dueDate:dueDate||null,priority:taskPrioritySelect.value,status:newStatus,completionDate:completionDate};if(!taskData.name){alert("Task Name is required.");taskNameInput.focus();return;}if(taskIdInput.value){const index=tasks.findIndex(task=>task.id===taskData.id);if(index>-1){tasks[index]=taskData;}else{console.warn(`Task ${taskData.id} not found for edit.`);tasks.push(taskData);}}else{tasks.push(taskData);}saveTasks();renderTasks();hideModal(); };
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); window.showConfirmModal(`Delete Task`, `Are you sure you want to delete "${taskToDelete?.name || id}"?`, () => { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); window.showToast('Task deleted.', 'success'); }, 'btn-danger'); };
                const toggleTaskStatus = (id) => { tasks = tasks.map(task => { if (task.id === id) { if (task.status === 'Completed') { return { ...task, status: 'Pending', completionDate: null }; } else { return { ...task, status: 'Completed', completionDate: getCurrentDate() }; } } return task; }); saveTasks(); renderTasks(); window.showToast('Task status updated.', 'success'); };
                addListener(addTaskBtn, 'click', openAddModal);
                closeModalBtns.forEach(btn => addListener(btn, 'click', hideModal));
                addListener(taskForm, 'submit', handleFormSubmit);
                const handleOutsideClick = (event) => { if (event.target === taskModal) { hideModal(); } };
                const handleEscapeKey = (event) => { if (event.key === 'Escape' && taskModal.classList.contains('active')) { hideModal(); } };
                addListener(taskModal, 'click', handleOutsideClick);
                addListener(document, 'keydown', handleEscapeKey);
                addListener(searchInput, 'input', renderTasks);
                addListener(filterStatusSelect, 'change', renderTasks);
                addListener(filterPrioritySelect, 'change', renderTasks);
                addListener(filterAssignedToSelect, 'change', renderTasks);

                loadTasks();

                const cleanup = () => {
                    console.log("Cleaning Task Management...");
                     listeners.forEach(({ element, event, handler }) => { element?.removeEventListener(event, handler); });
                     listeners = [];
                     document.removeEventListener('keydown', handleEscapeKey); // Remove document listener
                     taskModal?.removeEventListener('click', handleOutsideClick); // Remove modal listener
                     document.body.style.overflow = '';
                    console.log("Task Management cleanup complete.");
                };
                return { cleanup };
            }
        </script>
    </template>

    <!-- Template for File Sharing -->
    <template id="fileSharingAssets">
        <style id="injected-file-sharing-styles">
            /* File Sharing Specific Styles - Refactored */
            #featureSectionsContainer.file-sharing-feature .fancy-header-title {
                 background: var(--dashboard-header-bg); /* Use dashboard gradient */
                 color: white;
                 padding: 8px 18px;
                 border-radius: 50px;
                 display: inline-block;
                 font-weight: 600;
                 font-size: 1.0rem;
                 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                 transition: transform 0.2s ease;
                 margin-bottom: 0; /* Remove margin from h5 */
             }
             #featureSectionsContainer.file-sharing-feature .fancy-header-title:hover { transform: scale(1.02); }
             #featureSectionsContainer.file-sharing-feature .card-header { /* Header within the card */
                 background-color: var(--base-bg-color); /* Lighter header */
                 border-bottom: 1px solid var(--card-border-color);
                 padding: 0.75rem 1.25rem;
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
             }
             #featureSectionsContainer.file-sharing-feature .card-body { padding: 1.5rem; } /* Inner padding */
             #featureSectionsContainer.file-sharing-feature .file-icon { font-size: 1.6rem; vertical-align: middle; margin-right: 10px; width: 25px; text-align: center; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-danger { color: var(--danger) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-success { color: var(--success) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-warning { color: var(--warning) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-primary { color: var(--primary) !important; }
             #featureSectionsContainer.file-sharing-feature .file-icon.text-info { color: var(--info) !important; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn { margin: 0 3px; transition: all 0.2s ease-in-out; border-radius: 50px; padding: 0.25rem 0.6rem; font-size: 0.8rem; }
             #featureSectionsContainer.file-sharing-feature .action-buttons .btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
             #featureSectionsContainer.file-sharing-feature .action-btn .loading-spinner { display: none; margin: 0 2px; }
             #featureSectionsContainer.file-sharing-feature .action-btn.loading .original-icon { display: none; }
             #featureSectionsContainer.file-sharing-feature .action-btn.loading .loading-spinner { display: inline-block; }
             #featureSectionsContainer.file-sharing-feature .filters-section { background-color: var(--base-bg-color); padding: 1rem 1.25rem; border-radius: 0.375rem; border: 1px solid var(--card-border-color); margin-bottom: 1.5rem; }
             #featureSectionsContainer.file-sharing-feature .filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection { background-color: var(--base-bg-color); border: 1px solid var(--card-border-color); border-radius: 0.375rem; padding: 1rem 1.25rem; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection h6 { color: var(--primary); margin-bottom: 10px; font-weight: 600; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom: 1px dashed #eee !important; padding: 8px 0 !important; background-color: transparent !important; border-top: none !important; border-left: none !important; border-right: none !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item { border-bottom-color: var(--card-border-color) !important; }
             #featureSectionsContainer.file-sharing-feature #recentUploadsSection .list-group-item:last-child { border-bottom: 0 !important; }
             #featureSectionsContainer.file-sharing-feature .time-ago { font-style: normal; font-size: 0.85em; color: var(--gray); }
             #featureSectionsContainer.file-sharing-feature .table { margin-bottom: 0; /* Table uses default styles now */ }
             #featureSectionsContainer.file-sharing-feature .file-name { font-weight: 500; color: var(--base-text-color); }
             #featureSectionsContainer.file-sharing-feature .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background-color: var(--base-bg-color); border-radius: 8px; transition: background-color 0.2s ease, border-color 0.2s ease; }
             #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--primary-light); border-color: lighten(var(--primary), 10%); }
             #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary); }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--base-bg-color) !important; border-color: var(--primary) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--card-bg-color) !important; }
             body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-success { background-color: var(--success) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar.bg-danger { background-color: var(--danger) !important; }
             #featureSectionsContainer.file-sharing-feature #uploadProgressContainer .progress-bar { background-color: var(--primary); }
             .swal2-popup { font-size: 0.9rem !important; background-color: var(--card-bg-color) !important; color: var(--base-text-color) !important; }
             .swal2-title { color: var(--base-text-color) !important; }
             .swal2-html-container { color: var(--gray) !important; }
             .swal2-confirm { background-color: var(--success) !important; }
             .swal2-cancel { background-color: var(--danger) !important; }
        </style>
        <!-- File Sharing Content Area - Wrapped in card -->
        <div class="card">
            <div class="card-header">
                 <h5 class="fancy-header-title mb-0"><i class="fas fa-folder-open me-2"></i>File Management</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                    <i class="fas fa-upload me-1"></i> Upload New File
                </button>
            </div>
            <div class="card-body pt-3">
                 <!-- Filters Section -->
                 <div class="row filters-section gy-2 align-items-end">
                     <div class="col-md-4">
                          <label for="fileSearchInput" class="form-label">Search by Name</label>
                         <div class="input-group input-group-sm search-input">
                             <input type="text" class="form-control form-control-sm" placeholder="Enter file name..." id="fileSearchInput">
                              <span class="input-group-text"><i class="fas fa-search"></i></span>
                         </div>
                     </div>
                     <div class="col-md-2">
                          <label for="fileTypeFilter" class="form-label">File Type</label>
                          <select class="form-select form-select-sm" id="fileTypeFilter" title="Filter by Type">
                             <option value="" selected>All Types</option>
                             <option value="PDF">PDF</option> <option value="Image">Image</option> <option value="Video">Video</option> <option value="Archive">Archive</option> <option value="Document">Document</option> <option value="Spreadsheet">Spreadsheet</option>
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="uploadDateFilter" class="form-label">Upload Date</label>
                         <input type="date" class="form-control form-control-sm" id="uploadDateFilter" title="Filter by Upload Date">
                     </div>
                     <div class="col-md-2" id="userFilterContainer" style="display: none;">
                         <label for="userFilter" class="form-label">Uploader</label>
                          <select class="form-select form-select-sm" id="userFilter" title="Filter by Uploader">
                             <option value="" selected>All Users</option>
                              <!-- Populated by JS -->
                         </select>
                     </div>
                      <div class="col-md-1 text-end">
                         <button class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt"></i> </button>
                      </div>
                 </div>
                 <!-- Recent Uploads Section -->
                 <div class="mb-4 p-3" id="recentUploadsSection">
                     <h6><i class="fas fa-history me-1"></i> Recent Uploads</h6>
                     <ul class="list-group list-group-flush">
                         <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 5 * 60 * 1000).toISOString()}"> <div><i class="fas fa-file-pdf file-icon text-danger"></i> Quarterly_Report_Q1.pdf</div> <small class="text-muted time-ago">calculating...</small> </li>
                         <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()}"> <div><i class="fas fa-file-image file-icon text-success"></i> New_Company_Logo.png</div> <small class="text-muted time-ago">calculating...</small> </li>
                         <li class="list-group-item d-flex justify-content-between align-items-center" data-timestamp="${new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()}">
                           <div><i class="fas fa-file-zipper file-icon text-warning"></i> Final_Project_Assets.zip</div>
                           <small class="text-muted time-ago">calculating...</small>
                         </li>
                    </ul>
                </div>

            <!-- Files Table -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 5%;">Type</th>
                            <th scope="col" style="width: 30%;">File Name</th>
                            <th scope="col" style="width: 18%;">Upload Date</th>
                            <th scope="col" style="width: 17%;">Tags</th>
                            <th scope="col" style="width: 15%;">Uploader</th>
                            <th scope="col" class="text-center" style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody">
                        <!-- Rows populated by JS -->
                        <tr id="noResultsRow" style="display: none;">
                             <td colspan="6" class="text-center text-muted fst-italic py-4">No files found matching your criteria.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination (Optional) -->
            <nav aria-label="File list navigation" class="mt-3 d-flex justify-content-center">
                 <!-- <ul class="pagination pagination-sm"> --> <!-- Pagination items here --> <!-- </ul> -->
            </nav>
            </div> <!-- End card-body -->
        </div> <!-- End card -->
        <script>
            function initializeFileSharingFeature(container) {
                console.log("Initializing File Sharing Feature...");
                const cardBody = container.querySelector('.card-body');
                if (!cardBody) { console.error("File Sharing card body not found!"); return { cleanup: () => {} }; }
                const fileTableBody = cardBody.querySelector('#fileTableBody');
                const fileSearchInput = cardBody.querySelector('#fileSearchInput');
                const fileTypeFilter = cardBody.querySelector('#fileTypeFilter');
                const uploadDateFilter = cardBody.querySelector('#uploadDateFilter');
                const userFilter = cardBody.querySelector('#userFilter');
                const userFilterContainer = cardBody.querySelector('#userFilterContainer');
                const noResultsRow = cardBody.querySelector('#noResultsRow');
                const resetFiltersBtn = cardBody.querySelector('#resetFiltersBtn');
                const recentUploadsSection = cardBody.querySelector('#recentUploadsSection');
                // Modals are global
                const uploadFileModalEl = document.getElementById('uploadFileModal');
                const filePreviewModalEl = document.getElementById('filePreviewModal');

                if (!fileTableBody || !uploadFileModalEl || !filePreviewModalEl) { console.error("File Sharing essential elements not found!"); return { cleanup: () => {} }; }
                const isAdmin = window.currentUser?.role === 'admin';
                if (isAdmin && userFilterContainer) { userFilterContainer.style.display = 'block'; } else if(userFilterContainer) { userFilterContainer.style.display = 'none'; }

                let listeners = []; let timeUpdateInterval = null;
                const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };

                // NEW: Populate uploader filter
                function populateUploaderFilter() {
                    if (!userFilter) return;
                    const uploaderSet = new Set(window.MOCK_USERS.map(u => u.name)); // Use global user list
                    userFilter.innerHTML = '<option value="" selected>All Users</option>'; // Reset
                    uploaderSet.forEach(name => {
                        const option = document.createElement('option'); option.value = name; option.textContent = name;
                        userFilter.appendChild(option);
                    });
                }

                function applyFilters() {
                     const searchTerm = fileSearchInput.value.toLowerCase().trim();
                     const selectedType = fileTypeFilter.value;
                     const selectedDate = uploadDateFilter.value;
                     const selectedUser = userFilter.value;
                     let hasVisibleRows = false;
                     const rows = fileTableBody.querySelectorAll('tr:not(#noResultsRow)');
                     rows.forEach(row => {
                         const fileNameElement = row.querySelector('.file-name');
                         const uploaderElement = row.querySelector('.uploader-shared');
                         const fileName = fileNameElement ? fileNameElement.textContent.toLowerCase() : '';
                         const fileType = row.dataset.fileType || '';
                         const uploadDate = row.dataset.uploadDate || '';
                         const uploader = row.dataset.uploader || (uploaderElement ? uploaderElement.textContent : '');
                         const nameMatch = searchTerm === '' || fileName.includes(searchTerm);
                         const typeMatch = selectedType === '' || fileType === selectedType;
                         const dateMatch = selectedDate === '' || uploadDate === selectedDate;
                         const userMatch = (!isAdmin || selectedUser === '' || uploader === selectedUser);
                         if (nameMatch && typeMatch && dateMatch && userMatch) { row.style.display = ''; hasVisibleRows = true; } else { row.style.display = 'none'; }
                     });
                     if(noResultsRow) noResultsRow.style.display = hasVisibleRows ? 'none' : '';
                 }
                function resetFilters() { if(fileSearchInput) fileSearchInput.value = ''; if(fileTypeFilter) fileTypeFilter.value = ''; if(uploadDateFilter) uploadDateFilter.value = ''; if(userFilter) userFilter.value = ''; applyFilters(); }
                function updateRelativeTimes() { if (!recentUploadsSection) return; const timeElements = recentUploadsSection.querySelectorAll('.time-ago'); timeElements.forEach(el => { const timestamp = el.closest('li')?.dataset.timestamp; el.textContent = window.timeAgo(timestamp); }); }
                const handleTableClick = (event) => { /* ... (same as before) ... */ const button=event.target.closest('.action-btn');if(!button)return;if(button.classList.contains('loading'))return;const fileId=button.dataset.fileId;const row=button.closest('tr');const fileNameElement=row?.querySelector('.file-name');const fileName=fileNameElement?fileNameElement.textContent:'this file';if(button.classList.contains('download-btn')){const fileUrl=button.dataset.fileUrl;if(!fileUrl||fileUrl==='path/to/...'){console.error(`Download failed: URL missing for file ID ${fileId}.`);Swal.fire({icon:'error',title:'Download Error',text:'Could not download the file. URL is missing.',timer:2500,showConfirmButton:false});return;}button.classList.add('loading');button.disabled=true;console.log(`Download: ID ${fileId}, URL: ${fileUrl}`);try{const link=document.createElement('a');link.href=fileUrl;link.setAttribute('download',fileName);document.body.appendChild(link);link.click();document.body.removeChild(link);console.log(`Download initiated for: ${fileName}`);}catch(error){console.error('Download error:',error);Swal.fire({icon:'error',title:'Download Failed',text:'An error occurred.'});}finally{setTimeout(()=>{button.classList.remove('loading');button.disabled=false;},500);}}else if(button.classList.contains('delete-btn')){Swal.fire({title:'Are you sure?',html:`Delete file: <br><strong>${fileName}</strong>`,icon:'warning',showCancelButton:true,confirmButtonColor:'var(--success)',cancelButtonColor:'var(--danger)',confirmButtonText:'<i class="fas fa-check me-1"></i> Yes, delete it!',cancelButtonText:'<i class="fas fa-times me-1"></i> Cancel'}).then((result)=>{if(result.isConfirmed){button.classList.add('loading');button.disabled=true;console.log(`Delete: ID ${fileId}`);setTimeout(()=>{const deleteSuccess=Math.random()>0.1;if(deleteSuccess){console.log(`Deleted: ${fileId}`);row.style.opacity='0';setTimeout(()=>{row.remove();applyFilters();Swal.fire('Deleted!',`"${fileName}" has been deleted.`,'success');},300);}else{console.error(`Failed delete: ${fileId}`);button.classList.remove('loading');button.disabled=false;Swal.fire('Error!','Could not delete file.','error');}},1000);}});}};

                 // --- File Data Loading ---
                 function loadFileData() {
                    const mockFiles = [ { id: 1, name: "Monthly Performance Report.pdf", type: "PDF", size: "2.5 MB", uploadDate: "2024-05-25T10:30:00Z", tags: ["Reports", "Monthly"], uploader: "Mohamed Elmenisy", url: "path/to/report.pdf" }, { id: 2, name: "New Product Photo.jpg", type: "Image", size: "800 KB", uploadDate: "2024-05-24T15:15:00Z", ags: ["Products", "Design"], uploader: "Nada Mahmoud", url: "path/to/image.jpg" }, { id: 3, name: "Project Resources.zip", type: "Archive", size: "15.2 MB", uploadDate: "2024-05-23T09:00:00Z", tags: ["Project X"], uploader: "Yousef Ahmed", url: "path/to/archive.zip" }, { id: 4, name: "Meeting Agenda.pdf", type: "PDF", size: "150 KB", uploadDate: "2024-05-22T11:00:00Z", tags: ["Meetings"], uploader: "Esraa Lashin", url: "path/to/agenda.pdf" }, { id: 5, name: "Team Photo.png", type: "Image", size: "1.2 MB", uploadDate: "2024-05-26T09:00:00Z", tags: ["Team"], uploader: "Bassant Badr", url: "path/to/team.png" }, ];

                    fileTableBody.innerHTML = ''; // Clear existing rows

                    if (mockFiles.length === 0) {
                        noResultsRow.style.display = '';
                        return;
                    }
                    noResultsRow.style.display = 'none';

                    mockFiles.forEach(file => {
                        const row = document.createElement('tr');
                        row.dataset.fileType = file.type;
                        row.dataset.uploadDate = file.uploadDate.split('T')[0]; // Store YYYY-MM-DD
                        row.dataset.uploader = file.uploader;

                        const getFileIcon = (type) => {
                            switch (type) { case 'PDF': return 'fa-file-pdf text-danger'; case 'Image': return 'fa-file-image text-success'; case 'Video': return 'fa-file-video text-info'; case 'Archive': return 'fa-file-zipper text-warning'; case 'Document': return 'fa-file-word text-primary'; case 'Spreadsheet': return 'fa-file-excel text-success'; default: return 'fa-file text-secondary'; }
                        };

                        const tagsHtml = file.tags.map(tag => `<span class="badge text-bg-secondary me-1">${tag}</span>`).join('');
                        const previewButtonHtml = (file.type === 'PDF' || file.type === 'Image') ? `<button class="btn btn-sm btn-outline-info preview-btn" title="Preview" data-bs-toggle="modal" data-bs-target="#filePreviewModal" data-file-type="${file.type}" data-file-url="${file.url}"> <i class="fas fa-eye"></i> </button>` : '';

                        row.innerHTML = `
                            <td><i class="fas ${getFileIcon(file.type)} file-icon" title="${file.type}"></i></td>
                            <td>
                                <strong class="file-name">${file.name}</strong>
                                <small class="d-block text-muted">Size: ${file.size}</small>
                            </td>
                            <td class="upload-date">${window.formatFullDateTime(file.uploadDate)}</td>
                            <td>${tagsHtml}</td>
                            <td class="uploader-shared">${file.uploader}</td>
                            <td class="text-center action-buttons">
                                <button class="btn btn-sm btn-outline-success action-btn download-btn" title="Download" data-file-id="${file.id}" data-file-url="${file.url}">
                                    <i class="fas fa-download original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                </button>
                                ${previewButtonHtml}
                                <button class="btn btn-sm btn-outline-danger action-btn delete-btn" title="Delete" data-file-id="${file.id}">
                                    <i class="fas fa-trash-alt original-icon"></i><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></span>
                                </button>
                            </td>
                        `;
                        fileTableBody.appendChild(row);
                    });
                    applyFilters(); // Apply initial filters after loading
                 }


                // --- Preview Modal Logic ---
                 const previewModalInstance = new bootstrap.Modal(filePreviewModalEl);
                 const previewContent = filePreviewModalEl.querySelector('#previewContent');
                 const previewFileName = filePreviewModalEl.querySelector('#previewFileName');
                 const previewFileType = filePreviewModalEl.querySelector('#previewFileType');
                 const handlePreviewShow = (event) => {
                    const button = event.relatedTarget; if (!button || !previewContent || !previewFileName || !previewFileType) return;
                    const fileUrl = button.getAttribute('data-file-url'); const fileType = button.getAttribute('data-file-type'); const row = button.closest('tr'); const fileNameElement = row?.querySelector('.file-name'); const fileName = fileNameElement ? fileNameElement.textContent : 'N/A';
                    previewFileName.textContent = `File Name: ${fileName}`; previewFileType.textContent = `Type: ${fileType ? fileType.toUpperCase() : 'N/A'}`;
                    previewContent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    if (fileUrl && fileUrl !== 'path/to/...') {
                         setTimeout(() => {
                            if (fileType === 'Image') { previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" alt="Preview" style="max-height: 75vh;">`; }
                            else if (fileType === 'PDF') { previewContent.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="650px"><p class="text-warning p-4">Preview unavailable. Browser might not support PDF embedding. <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Download PDF</a></p></object>`; }
                            else { previewContent.innerHTML = `<p class="text-warning p-4">Preview not available for file type (${fileType}).</p>`; }
                        }, 300);
                    } else { previewContent.innerHTML = `<p class="text-danger p-4">Could not load preview. URL missing or invalid.</p>`; }
                 };
                 const handlePreviewHidden = () => { if(previewContent) previewContent.innerHTML = ''; };
                 addListener(filePreviewModalEl, 'show.bs.modal', handlePreviewShow);
                 addListener(filePreviewModalEl, 'hidden.bs.modal', handlePreviewHidden);

                 // --- Upload Modal Logic ---
                 const startUploadButton = uploadFileModalEl.querySelector('#startUploadButton');
                 const uploadProgressContainer = uploadFileModalEl.querySelector('#uploadProgressContainer');
                 const uploadProgressBar = uploadFileModalEl.querySelector('#uploadProgressBar');
                 const uploadStatus = uploadFileModalEl.querySelector('#uploadStatus');
                 const uploadFileName = uploadFileModalEl.querySelector('#uploadFileName');
                 const uploadPercentage = uploadFileModalEl.querySelector('#uploadPercentage');
                 const fileInputManual = uploadFileModalEl.querySelector('#fileInputManual');
                 const fileInputHidden = uploadFileModalEl.querySelector('#fileInputHidden');
                 const dropZone = uploadFileModalEl.querySelector('#dropZone');
                 const handleUploadStart = () => {
                     if (!startUploadButton || !uploadProgressContainer || !uploadProgressBar || !uploadStatus || !uploadFileName || !uploadPercentage || !fileInputManual || !fileInputHidden) return;
                     const filesToUpload = fileInputManual.files.length > 0 ? fileInputManual.files : fileInputHidden.files; if (filesToUpload.length === 0) { Swal.fire('No File Selected', 'Please select at least one file.', 'warning'); return; }
                     const firstFile = filesToUpload[0]; console.log("Starting upload for:", firstFile.name);
                     uploadFileName.textContent = `Uploading: ${firstFile.name}`; uploadProgressContainer.style.display = 'block'; uploadProgressBar.style.width = '0%'; uploadProgressBar.classList.remove('bg-success', 'bg-danger'); uploadProgressBar.classList.add('progress-bar-animated'); uploadPercentage.textContent = '0%'; uploadStatus.textContent = 'Initializing...'; uploadStatus.className = 'text-muted d-block mt-1';
                     let progress = 0; const interval = setInterval(() => { progress += Math.random() * 15; progress = Math.min(progress, 100); uploadProgressBar.style.width = progress + '%'; uploadProgressBar.setAttribute('aria-valuenow', progress); uploadPercentage.textContent = Math.round(progress) + '%'; if (progress >= 100) { clearInterval(interval); const uploadSuccess = Math.random() > 0.2; uploadProgressBar.classList.remove('progress-bar-animated'); if(uploadSuccess) { uploadStatus.textContent = 'Upload successful!'; uploadStatus.className = 'text-success d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-success'); setTimeout(() => bootstrap.Modal.getInstance(uploadFileModalEl)?.hide(), 1500); loadFileData(); /* Refresh list */ } else { uploadStatus.textContent = 'Upload failed. Please try again.'; uploadStatus.className = 'text-danger d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-danger'); } fileInputManual.value = ''; fileInputHidden.value = ''; } }, 300);
                 };
                 addListener(startUploadButton, 'click', handleUploadStart);
                // Drag and Drop Listeners
                if (dropZone) {
                     addListener(dropZone, 'dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--success)'; });
                     addListener(dropZone, 'dragleave', () => { dropZone.style.borderColor = 'var(--primary)'; });
                     addListener(dropZone, 'drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; if (e.dataTransfer.files.length > 0 && fileInputHidden) { fileInputHidden.files = e.dataTransfer.files; dropZone.querySelector('p:last-child').textContent = `${e.dataTransfer.files.length} file(s) selected.`; } });
                     addListener(dropZone, 'click', () => fileInputHidden?.click());
                 }
                 if (fileInputHidden) { addListener(fileInputHidden, 'change', () => { if(fileInputHidden.files.length > 0 && dropZone) dropZone.querySelector('p:last-child').textContent = `${fileInputHidden.files.length} file(s) selected.`; }); }
                 if (fileInputManual) { addListener(fileInputManual, 'change', () => { if (fileInputManual.files.length > 0 && dropZone) { dropZone.querySelector('p:last-child').textContent = 'Or drag & drop files here'; if(fileInputHidden) fileInputHidden.value = ''; } }); }

                // Filter Listeners
                addListener(fileSearchInput, 'input', applyFilters);
                addListener(fileTypeFilter, 'change', applyFilters);
                addListener(uploadDateFilter, 'change', applyFilters);
                addListener(userFilter, 'change', applyFilters);
                addListener(resetFiltersBtn, 'click', resetFilters);
                addListener(fileTableBody, 'click', handleTableClick); // Add listener for table actions

                // Initial setup
                populateUploaderFilter(); // Populate filter
                loadFileData(); // Load initial file data
                updateRelativeTimes();
                timeUpdateInterval = setInterval(updateRelativeTimes, 60000);

                const cleanup = () => {
                    console.log("Cleaning up File Sharing...");
                    clearInterval(timeUpdateInterval);
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                    listeners = [];
                    bootstrap.Modal.getInstance(uploadFileModalEl)?.hide(); bootstrap.Modal.getInstance(filePreviewModalEl)?.hide();
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove()); document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = '';
                    console.log("File Sharing cleanup complete.");
                };
                return { cleanup };
            }
        </script>
    </template>

    <!-- Template for Project Tracking -->
    <template id="projectTrackingAssets">
         <style id="injected-project-tracking-styles">
             /* Project Tracking Specific Styles - Refactored */
             #featureSectionsContainer.project-tracking-feature .pt-fancy-title {
                 background: var(--dashboard-header-bg); /* Use dashboard gradient */
                 color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.0rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 0;
             }
             #featureSectionsContainer.project-tracking-feature .pt-fancy-title i { margin-right: 8px; }
             #featureSectionsContainer.project-tracking-feature .card-header { background-color: var(--base-bg-color); border-bottom: 1px solid var(--card-border-color); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
             #featureSectionsContainer.project-tracking-feature .pt-filters-section { background-color: var(--base-bg-color); padding: 1rem 1.25rem; border-radius: 6px; border: 1px solid var(--card-border-color); margin: 1.5rem 0; }
             #featureSectionsContainer.project-tracking-feature .pt-filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; font-weight: 500; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations { padding: 0 1.5rem; margin-bottom: 1.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--card-border-color); height: 300px; display: flex; flex-direction: column; margin-bottom: 1.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
             #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-title { font-weight: 600; color: var(--gray); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders { background-color: var(--card-bg-color); padding: 15px; border-radius: 0.5rem; border: 1px solid var(--card-border-color); height: 300px; display: flex; flex-direction: column; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--primary); font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { border-bottom-color: var(--card-border-color); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li { padding: 8px 5px; border-bottom: 1px dashed #eee; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li { border-bottom-color: var(--card-border-color); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li:last-child { border-bottom: none; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--primary-light); }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders li:hover { background-color: var(--light); }
             #featureSectionsContainer.project-tracking-feature .pt-reminders .deadline { font-size: 0.8em; color: var(--danger); font-weight: 500; }
             #featureSectionsContainer.project-tracking-feature .pt-reminders .days-left { font-size: 0.75em; color: var(--gray); font-style: italic; }
             #featureSectionsContainer.project-tracking-feature .pt-table-container { background-color: var(--card-bg-color); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--card-border-color); margin: 1.5rem; }
             #featureSectionsContainer.project-tracking-feature .pt-table-container h5 { color: var(--primary); margin-bottom: 15px; font-weight: 600; }
             #featureSectionsContainer.project-tracking-feature .pt-table th[data-sort-by] { cursor: pointer; }
             #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon { margin-left: 5px; color: #ccc; font-size: 0.8em; display: inline-block; width: 10px; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-table th .sort-icon.active { color: var(--primary); }
             #featureSectionsContainer.project-tracking-feature .pt-table .project-name { font-weight: 500; color: var(--base-text-color); }
             #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { display: inline-block; background-color: var(--base-bg-color); color: var(--gray); font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-right: 3px; margin-bottom: 2px; white-space: nowrap; }
             body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table .assigned-team span { background-color: var(--light-gray); color: var(--base-text-color); }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-cell { min-width: 120px; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress { height: 14px; background-color: var(--light-gray); border-radius: 7px; overflow: hidden; position: relative; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar { font-size: 0.9rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-high { background-color: var(--success) !important; color: white; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-medium { background-color: var(--warning) !important; color: #212529; }
             #featureSectionsContainer.project-tracking-feature .pt-table .progress-bar.bg-progress-low { background-color: var(--danger) !important; color: white; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-badge,
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; display: inline-block; text-align: center; }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-inprogress { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-delayed { background-color: var(--status-delayed-bg); color: var(--status-delayed-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .status-pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-high { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .priority-low { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
             #featureSectionsContainer.project-tracking-feature .pt-table .notes-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 5px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button,
             #featureSectionsContainer.project-tracking-feature .pt-pagination span { padding: 8px 12px; border: 1px solid var(--card-border-color); background-color: var(--card-bg-color); border-radius: 4px; font-size: 14px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button { cursor: pointer; transition: background-color 0.2s ease; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button:hover:not(:disabled) { background-color: var(--base-bg-color); }
             #featureSectionsContainer.project-tracking-feature .pt-pagination button:disabled { cursor: not-allowed; opacity: 0.6; background-color: var(--base-bg-color); }
             #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-page-info { border: none; background: none; padding: 8px 5px; }
             #featureSectionsContainer.project-tracking-feature .pt-pagination span.pt-current-page { font-weight: bold; }
         </style>
        <!-- Project Tracking Content Area - Wrapped in card -->
        <div class="card">
             <div class="card-header">
                 <h2 class="pt-fancy-title"><i class="fas fa-tasks me-2"></i> Project Tracking</h2>
             </div>
             <div class="card-body">
                 <!-- Filters -->
                 <div class="pt-filters-section">
                     <div class="row gy-2 align-items-end">
                         <div class="col-md-4">
                             <label for="project-status-filter" class="form-label">Filter by Status:</label>
                             <select class="form-select form-select-sm" id="project-status-filter"> <option value="" selected>All Statuses</option> <option value="Completed">Completed</option> <option value="In Progress">In Progress</option> <option value="Delayed">Delayed</option> <option value="Pending">Pending</option> </select>
                         </div>
                         <div class="col-md-4">
                             <label for="project-team-filter" class="form-label">Filter by Team/Member:</label>
                             <select class="form-select form-select-sm" id="project-team-filter">
                                 <option value="" selected>All Teams/Members</option>
                                 <!-- Options populated by JS -->
                             </select>
                         </div>
                         <div class="col-md-2">
                              <label for="project-priority-filter" class="form-label">Filter by Priority:</label>
                             <select class="form-select form-select-sm" id="project-priority-filter"> <option value="" selected>All Priorities</option> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select>
                         </div>
                         <div class="col-md-2 text-end">
                             <button class="btn btn-sm btn-outline-secondary w-100" id="resetProjectFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt me-1"></i> Reset </button>
                         </div>
                     </div>
                 </div>

                 <!-- Visualizations & Reminders -->
                 <div class="row g-3 pt-visualizations">
                      <div class="col-lg-8">
                         <div class="row g-3">
                             <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Project Status Distribution</p> <canvas id="projectStatusPieChart"></canvas> </div> </div>
                             <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Overall Progress Trend (Simulated)</p> <canvas id="projectProgressLineChart"></canvas> </div> </div>
                         </div>
                      </div>
                      <div class="col-lg-4">
                          <div class="pt-reminders"> <h6><i class="fas fa-bell me-1 text-warning"></i> Upcoming Deadlines (Next 7 Days)</h6> <ul id="upcomingDeadlinesList"> <li class="text-muted text-center pt-5">Loading deadlines...</li> </ul> </div>
                      </div>
                 </div>

                 <!-- Project Table -->
                 <div class="mt-4 pt-table-container">
                      <h5><i class="fas fa-list-check me-2"></i> Project Details</h5>
                      <div class="table-responsive">
                         <table class="table table-sm table-hover table-striped align-middle pt-table" id="projectTrackingTable">
                             <thead> <tr> <th data-sort-by="name">Project Name <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="startDate">Start Date <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="endDate">End Date <i class="fas fa-sort sort-icon"></i></th> <th>Assigned Team</th> <th class="text-center progress-cell" data-sort-by="progress">Progress (%) <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="status">Status <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="priority">Priority <i class="fas fa-sort sort-icon"></i></th> <th>Notes</th> </tr> </thead>
                             <tbody id="projectTableBody"> <tr> <td colspan="8" class="text-center p-4 text-muted"> <div class="spinner-border spinner-border-sm text-primary me-2" role="status"> <span class="visually-hidden">Loading...</span> </div> Loading project data... </td> </tr> </tbody>
                         </table>
                      </div>
                      <div class="pt-pagination" id="projectPaginationControls"></div>
                 </div>
            </div>
        </div>
        <script>
            function initializeProjectTrackingFeature(container) {
                console.log("Initializing Project Tracking Feature...");
                // Scoped Selectors
                 const cardBody = container.querySelector('.card-body');
                 if (!cardBody) { console.error("Project Tracking card body not found!"); return { cleanup: () => {} }; }
                 const statusFilter = cardBody.querySelector('#project-status-filter');
                 const teamFilter = cardBody.querySelector('#project-team-filter');
                 const priorityFilter = cardBody.querySelector('#project-priority-filter');
                 const resetFiltersBtn = cardBody.querySelector('#resetProjectFiltersBtn');
                 const tableBody = cardBody.querySelector('#projectTableBody');
                 const paginationControls = cardBody.querySelector('#projectPaginationControls');
                 const deadlinesList = cardBody.querySelector('#upcomingDeadlinesList');
                 const tableHeaders = cardBody.querySelectorAll("#projectTrackingTable th[data-sort-by]");
                 const projectStatusPieChartEl = cardBody.querySelector('#projectStatusPieChart');
                 const projectProgressLineChartEl = cardBody.querySelector('#projectProgressLineChart');

                 if (!tableBody || !projectStatusPieChartEl || !projectProgressLineChartEl || !teamFilter) { /* Add teamFilter check */
                     console.error("Essential Project Tracking elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 let projectData = []; let filteredData = []; let currentPage = 1; const rowsPerPage = 5; let currentSortColumn = 'endDate'; let currentSortDirection = 'asc';
                 let statusPieChartInstance = null; let progressLineChartInstance = null;
                 let listeners = [];

                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 const formatDate = (dateString) => window.formatDateForDisplay(dateString); // Use global
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || '#888'; // Fallback color
                 const rgbaColor = (c, alpha) => { if (!c) c = '#888'; if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; };
                 function getStatusBadgeClass(status) { /* ... (same as before) ... */ switch(status?.toLowerCase()){case 'completed':return 'status-completed';case 'in progress':return 'status-inprogress';case 'delayed':return 'status-delayed';case 'pending':return 'status-pending';default:return '';}}
                 function getPriorityBadgeClass(priority) { /* ... (same as before) ... */ switch(priority?.toLowerCase()){case 'high':return 'priority-high';case 'medium':return 'priority-medium';case 'low':return 'priority-low';default:return '';}}
                 function getProgressBgClass(progress) { /* ... (same as before) ... */ if(progress>=80)return 'bg-progress-high';if(progress>=50)return 'bg-progress-medium';return 'bg-progress-low';}
                 function getProgressTextColor(progress) { /* ... (same as before) ... */ return (progress>=50&&progress<80)?'#212529':'#fff';}

                function renderProjectStatusPieChart(data) { /* ... (same as before) ... */ const ctx=projectStatusPieChartEl.getContext('2d');if(!ctx)return;const statusCounts=data.reduce((acc,project)=>{acc[project.status]=(acc[project.status]||0)+1;return acc;},{});const labels=Object.keys(statusCounts);const chartData=Object.values(statusCounts);const backgroundColors=labels.map(label=>{switch(label.toLowerCase()){case 'completed':return getCssVar('--success');case 'in progress':return getCssVar('--primary');case 'delayed':return getCssVar('--warning');case 'pending':return getCssVar('--gray');default:return getCssVar('--secondary');}});const config={type:'pie',data:{labels:labels,datasets:[{data:chartData,backgroundColor:backgroundColors,borderColor:getCssVar('--card-bg-color'),borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:getCssVar('--base-text-color')}}}}};if(statusPieChartInstance)statusPieChartInstance.destroy();statusPieChartInstance=new Chart(ctx,config);}
                 function renderProjectProgressLineChart() { /* ... (same as before, uses simulated data) ... */ const ctx=projectProgressLineChartEl.getContext('2d');if(!ctx)return;const labels=['Jan','Feb','Mar','Apr','May','Jun'];const data=[20,35,50,60,75,80];const config={type:'line',data:{labels:labels,datasets:[{label:'Overall Progress %',data:data,borderColor:getCssVar('--primary'),backgroundColor:rgbaColor(getCssVar('--primary'),0.1),fill:true,tension:0.3}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100,ticks:{color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}},x:{ticks:{color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}}},plugins:{legend:{display:false}}}};if(progressLineChartInstance)progressLineChartInstance.destroy();progressLineChartInstance=new Chart(ctx,config);}
                 function renderUpcomingDeadlines(data) { /* ... (same as before) ... */ if(!deadlinesList)return;deadlinesList.innerHTML='';const today=new Date();today.setHours(0,0,0,0);const sevenDaysFromNow=new Date(today);sevenDaysFromNow.setDate(today.getDate()+7);const upcoming=data.filter(project=>{if(!project.endDate||project.status==='Completed')return false;const endDate=new Date(project.endDate+'T00:00:00');return endDate>=today&&endDate<=sevenDaysFromNow;}).sort((a,b)=>new Date(a.endDate)-new Date(b.endDate));if(upcoming.length===0){deadlinesList.innerHTML='<li class="text-muted text-center pt-5">No upcoming deadlines found.</li>';return;}upcoming.forEach(project=>{const li=document.createElement('li');const endDate=new Date(project.endDate+'T00:00:00');const diffTime=Math.abs(endDate-today);const diffDays=Math.ceil(diffTime/(1000*60*60*24));const daysLeftText=diffDays===0?'Due Today':`${diffDays} day${diffDays>1?'s':''} left`;li.innerHTML=`<span>${project.name}</span><span class="text-end"><span class="deadline me-2">${formatDate(project.endDate)}</span><span class="days-left">(${daysLeftText})</span></span>`;deadlinesList.appendChild(li);});}
                 function renderTable() { /* ... (same as before) ... */ tableBody.innerHTML='';if(filteredData.length===0){tableBody.innerHTML=`<tr><td colspan="8" class="text-center p-4 text-muted fst-italic">No projects found matching criteria.</td></tr>`;renderPagination();return;}const totalItems=filteredData.length;const totalPages=Math.ceil(totalItems/rowsPerPage);if(currentPage>totalPages&&totalPages>0)currentPage=totalPages;else if(currentPage<1)currentPage=1;const startIndex=(currentPage-1)*rowsPerPage;const endIndex=startIndex+rowsPerPage;const pageData=filteredData.slice(startIndex,endIndex);pageData.forEach(project=>{const row=document.createElement('tr');const statusClass=getStatusBadgeClass(project.status);const priorityClass=getPriorityBadgeClass(project.priority);const progressBg=getProgressBgClass(project.progress);const progressTextClr=getProgressTextColor(project.progress);const teamHtml=project.assignedTeam.map(member=>`<span>${member}</span>`).join('');row.innerHTML=`<td><div class="project-name">${project.name}</div></td><td>${formatDate(project.startDate)}</td><td>${formatDate(project.endDate)}</td><td class="assigned-team">${teamHtml}</td><td class="text-center progress-cell"><div class="progress" role="progressbar" aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar ${progressBg}" style="width: ${project.progress}%; color: ${progressTextClr};">${project.progress}%</div></div></td><td class="text-center"><span class="status-badge ${statusClass}">${project.status}</span></td><td class="text-center"><span class="priority-badge ${priorityClass}">${project.priority}</span></td><td class="notes-cell" title="${project.notes||''}">${project.notes||'-'}</td>`;tableBody.appendChild(row);});renderPagination();updateSortIcons();}
                 function renderPagination() { /* ... (same as before) ... */ if(!paginationControls)return;paginationControls.innerHTML='';const totalItems=filteredData.length;if(totalItems<=rowsPerPage)return;const totalPages=Math.ceil(totalItems/rowsPerPage);const createButton=(text,page,disabled=false)=>{const button=document.createElement('button');button.className='btn btn-sm btn-outline-secondary';button.innerHTML=text;button.disabled=disabled;addListener(button,'click',()=>{currentPage=page;renderTable();});return button;};paginationControls.appendChild(createButton('<i class="fas fa-chevron-left"></i> Prev',currentPage-1,currentPage===1));const pageInfo=document.createElement('span');pageInfo.className='pt-page-info';pageInfo.innerHTML=`Page <span class="pt-current-page">${currentPage}</span> of ${totalPages}`;paginationControls.appendChild(pageInfo);paginationControls.appendChild(createButton('Next <i class="fas fa-chevron-right"></i>',currentPage+1,currentPage===totalPages));}
                 function updateSortIcons() { /* ... (same as before) ... */ tableHeaders.forEach(th=>{const icon=th.querySelector('.sort-icon');if(!icon)return;const columnKey=th.getAttribute('data-sort-by');icon.classList.remove('fa-sort','fa-sort-up','fa-sort-down','active');if(columnKey===currentSortColumn){icon.classList.add(currentSortDirection==='asc'?'fa-sort-up':'fa-sort-down');icon.classList.add('active');}else{icon.classList.add('fa-sort');}}); }
                 function handleSortClick(event) { /* ... (same as before) ... */ const header=event.currentTarget;const columnKey=header.getAttribute('data-sort-by');if(!columnKey)return;if(currentSortColumn===columnKey){currentSortDirection=currentSortDirection==='asc'?'desc':'asc';}else{currentSortColumn=columnKey;currentSortDirection='asc';}applyFiltersAndSort();}
                 function applyFiltersAndSort() { /* ... (same as before, includes team filter) ... */ const statusValue=statusFilter.value;const teamValue=teamFilter.value;const priorityValue=priorityFilter.value;let tempFilteredData=projectData.filter(project=>{const statusMatch=!statusValue||project.status===statusValue;const teamMatch=!teamValue||project.assignedTeam.includes(teamValue);const priorityMatch=!priorityValue||project.priority===priorityValue;return statusMatch&&teamMatch&&priorityMatch;});tempFilteredData.sort((a,b)=>{let valA=a[currentSortColumn];let valB=b[currentSortColumn];if(currentSortColumn==='startDate'||currentSortColumn==='endDate'){valA=new Date(valA||0);valB=new Date(valB||0);}else if(currentSortColumn==='progress'){valA=Number(valA||0);valB=Number(valB||0);}else if(typeof valA==='string'){valA=valA.toLowerCase();}if(typeof valB==='string'){valB=valB.toLowerCase();}else if(currentSortColumn==='priority'){const priorityOrder={'High':3,'Medium':2,'Low':1};valA=priorityOrder[a.priority]||0;valB=priorityOrder[b.priority]||0;}if(valA<valB)return currentSortDirection==='asc'?-1:1;if(valA>valB)return currentSortDirection==='asc'?1:-1;return 0;});filteredData=tempFilteredData;currentPage=1;renderTable();renderProjectStatusPieChart(filteredData);renderUpcomingDeadlines(filteredData);renderProjectProgressLineChart();}
                 function resetFilters() { /* ... (same as before) ... */ statusFilter.value='';teamFilter.value='';priorityFilter.value='';applyFiltersAndSort();}

                 // NEW: Populate Team Filter
                 function populateTeamFilter() {
                    const teamSet = new Set();
                    projectData.forEach(p => p.assignedTeam.forEach(member => teamSet.add(member)));
                    teamFilter.innerHTML = '<option value="" selected>All Teams/Members</option>'; // Reset
                    teamSet.forEach(name => {
                        const option = document.createElement('option'); option.value = name; option.textContent = name;
                        teamFilter.appendChild(option);
                    });
                 }

                 function fetchInitialData() { /* ... (same as before) ... */ setTimeout(()=>{projectData=[{id:1,name:"Website Overhaul",startDate:"2024-03-01",endDate:"2024-07-30",assignedTeam:["Mohamed Elmenisy","Esraa Lashin"],progress:75,status:"In Progress",priority:"High",notes:"Phase 1 complete, focusing on backend."},{id:2,name:"Mobile App Dev",startDate:"2024-04-15",endDate:"2024-09-15",assignedTeam:["Yousef Ahmed","Bassant Badr"],progress:40,status:"In Progress",priority:"High",notes:"Core features implemented."},{id:3,name:"Marketing Campaign Q3",startDate:"2024-07-01",endDate:"2024-09-30",assignedTeam:["Bassant Badr","Nada Mahmoud"],progress:15,status:"Pending",priority:"Medium",notes:"Planning stage."},{id:4,name:"Server Upgrade",startDate:"2024-05-20",endDate:"2024-06-10",assignedTeam:["Yousef Ahmed"],progress:100,status:"Completed",priority:"Medium",notes:"Completed ahead of schedule."},{id:5,name:"UI Kit Development",startDate:"2024-06-01",endDate:"2024-08-15",assignedTeam:["Esraa Lashin"],progress:60,status:"In Progress",priority:"Low",notes:"Delayed due to scope change."},{id:6,name:"API Documentation",startDate:"2024-07-10",endDate:"2024-07-25",assignedTeam:["Mohamed Elmenisy"],progress:90,status:"Delayed",priority:"Medium",notes:"Awaiting final review."}, { id: 7, name: "Onboarding Process", startDate: "2024-08-01", endDate: "2024-08-10", assignedTeam: ["Nada Mahmoud"], progress: 5, status: "Pending", priority: "Low", notes: "Initial draft required." } ];populateTeamFilter();applyFiltersAndSort();console.log("Project Tracking data loaded.");},500);}

                 tableHeaders.forEach(th => addListener(th, 'click', handleSortClick));
                 addListener(statusFilter, 'change', applyFiltersAndSort);
                 addListener(teamFilter, 'change', applyFiltersAndSort);
                 addListener(priorityFilter, 'change', applyFiltersAndSort);
                 addListener(resetFiltersBtn, 'click', resetFilters);

                 fetchInitialData();

                 const cleanup = () => {
                     console.log("Cleaning up Project Tracking...");
                     if (statusPieChartInstance) statusPieChartInstance.destroy(); if (progressLineChartInstance) progressLineChartInstance.destroy();
                     statusPieChartInstance = null; progressLineChartInstance = null;
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                     listeners = [];
                     console.log("Project Tracking cleanup complete.");
                 };
                 return { cleanup };
            }
        </script>
    </template>

    <!-- Template for Reports & Analytics -->
    <template id="reportsAnalyticsAssets">
        <style id="injected-reports-analytics-styles">
            /* Reports Specific Styles - Refactored */
            #featureSectionsContainer.reports-analytics-feature .ra-fancy-title {
                 background: var(--dashboard-header-bg); color: white; padding: 8px 18px; border-radius: 50px; display: inline-block; font-weight: 600; font-size: 1.0rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 0;
             }
             #featureSectionsContainer.reports-analytics-feature .ra-fancy-title i { margin-right: 8px; }
             #featureSectionsContainer.reports-analytics-feature .card-header { background-color: var(--base-bg-color); border-bottom: 1px solid var(--card-border-color); padding: 0.75rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
             #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn { font-size: 0.8rem; padding: 0.375rem 0.75rem; }
             #featureSectionsContainer.reports-analytics-feature .ra-export-buttons .btn i { margin-right: 5px; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section { background-color: var(--base-bg-color); padding: 1rem 1.25rem; border-radius: 6px; border: 1px solid var(--card-border-color); margin: 1.5rem 0; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .btn-group .btn { font-size: 0.85rem; padding: 0.375rem 0.85rem; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section .form-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.25rem; font-weight: 500; }
             #featureSectionsContainer.reports-analytics-feature .ra-filters-section input[type="date"] { font-size: 0.85rem; padding: 0.375rem 0.75rem; max-width: 150px; }
             #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--chart-background); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--card-border-color); height: 350px; display: flex; flex-direction: column; }
             #featureSectionsContainer.reports-analytics-feature .chart-container canvas { max-width: 100%; height: auto; flex-grow: 1; }
             #featureSectionsContainer.reports-analytics-feature .chart-title { font-weight: 600; color: var(--gray); margin-bottom: 15px; font-size: 0.9rem; text-align: center; }
             #featureSectionsContainer.reports-analytics-feature .ra-table-container { background-color: var(--card-bg-color); padding: 20px; border-radius: 0.5rem; border: 1px solid var(--card-border-color); margin: 1.5rem; }
             #featureSectionsContainer.reports-analytics-feature .ra-table-container h5 { color: var(--primary); margin-bottom: 15px; font-weight: 600; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { font-weight: 500; color: var(--base-text-color); padding-left: 5px; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .progress { height: 14px; background-color: var(--light-gray); min-width: 100px; border-radius: 7px; overflow: hidden; position: relative; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar { font-size: 0.9rem; font-weight: bold; line-height: 14px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-high { background-color: var(--success) !important; color: white; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-medium { background-color: var(--warning) !important; color: #212529; } /* Darker text on orange */
             #featureSectionsContainer.reports-analytics-feature .ra-table .progress-bar.bg-progress-low { background-color: var(--danger) !important; color: white; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .metric-value { font-weight: 500; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .text-success { color: var(--success) !important; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .text-danger { color: var(--danger) !important; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .text-info { color: var(--info) !important; }
             #featureSectionsContainer.reports-analytics-feature .ra-table .text-warning { color: var(--warning) !important; }
         </style>
        <!-- Reports Content Area - Wrapped in card -->
        <div class="card">
             <div class="card-header">
                 <h2 class="ra-fancy-title"><i class="fas fa-chart-pie me-2"></i> Reports & Analytics</h2>
                 <div class="ra-export-buttons">
                      <button id="exportPdfBtn" class="btn btn-sm btn-outline-danger"> <i class="fas fa-file-pdf"></i> Export PDF </button>
                      <button id="exportExcelBtn" class="btn btn-sm btn-outline-success"> <i class="fas fa-file-excel"></i> Export Excel </button>
                 </div>
             </div>
             <div class="card-body">
                 <!-- Filters -->
                 <div class="ra-filters-section">
                     <form id="reports-filter-form">
                          <div class="row gy-2 align-items-end">
                             <div class="col-md-auto">
                                 <label class="form-label">Quick Period:</label>
                                 <div class="btn-group w-100" role="group" aria-label="Report Period" id="periodBtnGroup"> <input type="radio" class="btn-check" name="period" id="period-day" autocomplete="off" value="day"> <label class="btn btn-sm btn-outline-secondary" for="period-day">Day</label> <input type="radio" class="btn-check" name="period" id="period-week" autocomplete="off" value="week" checked> <label class="btn btn-sm btn-outline-secondary" for="period-week">Week</label> <input type="radio" class="btn-check" name="period" id="period-month" autocomplete="off" value="month"> <label class="btn btn-sm btn-outline-secondary" for="period-month">Month</label> </div>
                             </div>
                              <div class="col-md"> <label for="report-start-date" class="form-label">Start Date:</label> <input type="date" class="form-control form-control-sm" id="report-start-date" name="startDate" required> </div>
                              <div class="col-md"> <label for="report-end-date" class="form-label">End Date:</label> <input type="date" class="form-control form-control-sm" id="report-end-date" name="endDate" required> </div>
                              <div class="col-md-auto"> <button type="submit" class="btn btn-sm btn-primary w-100"> <i class="fas fa-sync-alt me-1"></i> Update Report </button> </div>
                         </div>
                     </form>
                 </div>

                 <!-- Charts Section -->
                 <div class="row g-4">
                     <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Task Completion Rate (%)</p> <canvas id="taskCompletionChart"></canvas> </div> </div>
                     <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Overdue Tasks Count</p> <canvas id="overdueTasksChart"></canvas> </div> </div>
                     <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Files Uploaded by Employee</p> <canvas id="filesUploadedChart"></canvas> </div> </div>
                     <div class="col-lg-12"> <div class="chart-container" style="height: 400px;"> <p class="chart-title">Employee Performance Comparison</p> <canvas id="performanceComparisonChart"></canvas> </div> </div>
                 </div>

                 <!-- Employee Summary Table Section -->
                 <div class="mt-4 ra-table-container">
                      <h5><i class="fas fa-users me-2"></i> Employee Performance Summary</h5>
                      <div class="table-responsive">
                         <table class="table table-sm table-hover table-striped align-middle ra-table" id="employeeSummaryTable">
                             <thead> <tr> <th>Employee</th> <th class="text-center">Tasks Completed (%)</th> <th class="text-center">Overdue Tasks</th> <th class="text-center">Files Uploaded</th> <th class="text-center">Activity Score</th> </tr> </thead>
                             <tbody id="employeeSummaryTableBody"> <tr><td colspan="5" class="text-center p-4 text-muted"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div><span class="ms-2">Loading employee data...</span></td></tr> </tbody>
                         </table>
                      </div>
                 </div>
            </div>
        </div>
         <script>
             function initializeReportsAnalyticsFeature(container) {
                 console.log("Initializing Reports & Analytics Feature...");
                 // --- Scoped Selectors ---
                 const cardBody = container.querySelector('.card-body');
                 if (!cardBody) { console.error("Reports card body not found!"); return { cleanup: () => {} }; }
                 const filterForm = cardBody.querySelector('#reports-filter-form');
                 const startDateInput = cardBody.querySelector('#report-start-date');
                 const endDateInput = cardBody.querySelector('#report-end-date');
                 const periodBtnGroup = cardBody.querySelector('#periodBtnGroup');
                 const tableBody = cardBody.querySelector('#employeeSummaryTableBody');
                 const exportPdfBtn = container.querySelector('#exportPdfBtn'); // In header
                 const exportExcelBtn = container.querySelector('#exportExcelBtn'); // In header
                 const taskCompletionChartEl = cardBody.querySelector('#taskCompletionChart');
                 const overdueTasksChartEl = cardBody.querySelector('#overdueTasksChart');
                 const filesUploadedChartEl = cardBody.querySelector('#filesUploadedChart');
                 const performanceComparisonChartEl = cardBody.querySelector('#performanceComparisonChart');

                 if (!filterForm || !startDateInput || !endDateInput || !tableBody || !taskCompletionChartEl || !overdueTasksChartEl || !filesUploadedChartEl || !performanceComparisonChartEl || !exportPdfBtn || !exportExcelBtn) {
                     console.error("Essential Reports & Analytics elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 // --- Sample Data & State ---
                 const employeePerformanceData = [ /* ... (same sample data) ... */ {id:1,name:"Mohamed Elmenisy",tasksCompleted:85,tasksOverdue:3,filesUploaded:15,activityScore:9.2,performanceMetrics:[8.5,9,7,9.2,8.4]},{id:3,name:"Yousef Ahmed",tasksCompleted:70,tasksOverdue:8,filesUploaded:8,activityScore:7.5,performanceMetrics:[7,6,6,7.5,6.6]},{id:4,name:"Esraa Lashin",tasksCompleted:45,tasksOverdue:12,filesUploaded:5,activityScore:6.1,performanceMetrics:[4.5,5,5,6.1,5.1]},{id:5,name:"Bassant Badr",tasksCompleted:91,tasksOverdue:2,filesUploaded:18,activityScore:9.5,performanceMetrics:[9.1,9.5,8,9.5,9.0]}, {id:2, name: "Nada Mahmoud", tasksCompleted: 78, tasksOverdue: 5, filesUploaded: 12, activityScore: 8.1, performanceMetrics: [7.8, 8, 6, 8.1, 7.5]} ];
                 let currentFilteredData = [...employeePerformanceData];
                 let taskCompletionChartInstance = null; let overdueTasksChartInstance = null; let filesUploadedChartInstance = null; let performanceComparisonChartInstance = null;
                 let listeners = [];

                 // --- Utility Functions ---
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 function formatDateInput(date) { /* ... */ const d=new Date(date);const month=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');const year=d.getFullYear();return `${year}-${month}-${day}`; }
                 function formatReportDate(dateString) { /* ... */ if(!dateString)return 'N/A';const parts=dateString.split('-');if(parts.length===3){return `${parts[1]}/${parts[2]}/${parts[0]}`;}return dateString;}
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || '#888';
                 const rgbaColor = (c, alpha) => { /* ... */ if(!c)c='#888';if(c.startsWith('rgba'))return c.replace(/[\d\.]+\)$/g,`${alpha})`);if(c.startsWith('#')){const bigint=parseInt(c.slice(1),16);const r=(bigint>>16)&255;const g=(bigint>>8)&255;const b=bigint&255;return `rgba(${r}, ${g}, ${b}, ${alpha})`;}return c;}

                 // --- Chart Rendering ---
                 function renderTaskCompletionChart(data) { /* ... (same as before) ... */ const ctx=taskCompletionChartEl.getContext('2d');if(!ctx)return;const avgCompletion=data.length>0?Math.round(data.reduce((sum,emp)=>sum+emp.tasksCompleted,0)/data.length):0;const chartData={labels:['Completed','Remaining'],datasets:[{data:[avgCompletion,100-avgCompletion],backgroundColor:[getCssVar('--success'),'#e9ecef'],borderColor:[getCssVar('--card-bg-color')],borderWidth:2}]};if(taskCompletionChartInstance)taskCompletionChartInstance.destroy();taskCompletionChartInstance=new Chart(ctx,{type:'doughnut',data:chartData,options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.parsed}%`}}}}});}
                 function renderOverdueTasksChart(data) { /* ... (same as before) ... */ const ctx=overdueTasksChartEl.getContext('2d');if(!ctx)return;const labels=data.map(emp=>emp.name);const overdueData=data.map(emp=>emp.tasksOverdue);if(overdueTasksChartInstance)overdueTasksChartInstance.destroy();overdueTasksChartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Overdue Tasks',data:overdueData,backgroundColor:getCssVar('--danger'),borderWidth:0,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{stepSize:2,color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}},x:{ticks:{color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}}},plugins:{legend:{display:false}}}});}
                 function renderFilesUploadedChart(data) { /* ... (same as before) ... */ const ctx=filesUploadedChartEl.getContext('2d');if(!ctx)return;const labels=data.map(emp=>emp.name);const filesData=data.map(emp=>emp.filesUploaded);if(filesUploadedChartInstance)filesUploadedChartInstance.destroy();filesUploadedChartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Files Uploaded',data:filesData,backgroundColor:getCssVar('--info'),borderWidth:0,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{beginAtZero:true,ticks:{color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}},y:{ticks:{color:getCssVar('--base-text-color')},grid:{color:getCssVar('--card-border-color')}}},plugins:{legend:{display:false}}}});}
                 function renderPerformanceComparisonChart(data) { /* ... (same as before) ... */ const ctx=performanceComparisonChartEl.getContext('2d');if(!ctx)return;const labels=['Completion','Timeliness','Files Mgmt','Activity','Overall Score'];const datasets=data.map((emp,index)=>{const metricsData=emp.performanceMetrics||[emp.tasksCompleted/10,10-(emp.tasksOverdue/2),emp.filesUploaded/2,emp.activityScore,((emp.tasksCompleted/10)+(10-(emp.tasksOverdue/2))+(emp.filesUploaded/2)+emp.activityScore)/4];const clampedData=metricsData.map(score=>Math.max(0,Math.min(10,score||0)));const colors=[getCssVar('--primary'),getCssVar('--success'),getCssVar('--warning'),getCssVar('--danger'),getCssVar('--info'),getCssVar('--secondary')];const color=colors[index%colors.length];const bgFill=rgbaColor(color,getCssVar('--feature-reports-chart-radar-fill-opacity'));return {label:emp.name,data:clampedData,fill:true,backgroundColor:bgFill,borderColor:color,pointBackgroundColor:color,pointBorderColor:getCssVar('--card-bg-color'),pointHoverBackgroundColor:getCssVar('--card-bg-color'),pointHoverBorderColor:color}});if(performanceComparisonChartInstance)performanceComparisonChartInstance.destroy();performanceComparisonChartInstance=new Chart(ctx,{type:'radar',data:{labels:labels,datasets:datasets},options:{responsive:true,maintainAspectRatio:false,elements:{line:{borderWidth:2}},scales:{r:{angleLines:{display:true,color:getCssVar('--card-border-color')},grid:{color:getCssVar('--card-border-color')},suggestedMin:0,suggestedMax:10,pointLabels:{font:{size:10},color:getCssVar('--base-text-color')},ticks:{backdropColor:getCssVar('--card-bg-color'),stepSize:2,color:getCssVar('--base-text-color'),showLabelBackdrop:false}}},plugins:{legend:{position:'top',labels:{color:getCssVar('--base-text-color')}}}}});}

                 // --- Table Rendering ---
                 function renderEmployeeSummaryTable(data) { /* ... (same as before) ... */ tableBody.innerHTML='';if(!data||data.length===0){tableBody.innerHTML=`<tr><td colspan="5" class="text-center p-4 text-muted fst-italic">No employee data found.</td></tr>`;return;}data.forEach((emp)=>{const row=document.createElement('tr');let scoreBadgeClass='text-bg-secondary';let scoreText='Average';if(emp.activityScore>=9){scoreBadgeClass='text-bg-success';scoreText='Excellent';}else if(emp.activityScore>=7.5){scoreBadgeClass='text-bg-warning';scoreText='Good';}else if(emp.activityScore<6.5){scoreBadgeClass='text-bg-danger';scoreText='Needs Improv.';}const completion=emp.tasksCompleted;let progressBgClass='';let progressTextColor='#fff';if(completion>=80){progressBgClass='bg-progress-high';}else if(completion>=50){progressBgClass='bg-progress-medium';progressTextColor='#212529';}else{progressBgClass='bg-progress-low';}row.innerHTML=`<td><div class="employee-name">${emp.name}</div></td><td class="text-center"><div class="progress" role="progressbar" aria-label="Completion rate for ${emp.name}" aria-valuenow="${completion}" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar ${progressBgClass}" style="width: ${completion}%; color: ${progressTextColor};">${completion}%</div></div></td><td class="text-center"><span class="metric-value ${emp.tasksOverdue===0?'text-success':emp.tasksOverdue<=5?'text-warning':'text-danger'}">${emp.tasksOverdue}</span></td><td class="text-center"><span class="metric-value text-info">${emp.filesUploaded}</span></td><td class="text-center"><span class="badge ${scoreBadgeClass}">${scoreText}</span></td>`;tableBody.appendChild(row);});}

                 // --- Filtering & Export ---
                 function applyFilters() { /* ... (same as before) ... */ const startDate=startDateInput.value;const endDate=endDateInput.value;console.log("Reports: Applying filters for period:",startDate,"to",endDate);currentFilteredData=[...employeePerformanceData];renderTaskCompletionChart(currentFilteredData);renderOverdueTasksChart(currentFilteredData);renderFilesUploadedChart(currentFilteredData);renderPerformanceComparisonChart(currentFilteredData);renderEmployeeSummaryTable(currentFilteredData);}
                 function setPeriodDates(period) { /* ... (same as before) ... */ const today=new Date();let startDate,endDate=new Date();switch(period){case 'day':startDate=new Date(today);break;case 'month':startDate=new Date(today.getFullYear(),today.getMonth(),1);break;case 'week':default:const firstDay=today.getDate()-today.getDay()+(today.getDay()===0?-6:1);startDate=new Date(new Date(today).setDate(firstDay));break;}startDateInput.value=formatDateInput(startDate);endDateInput.value=formatDateInput(endDate);applyFilters();}
                 function generateCsv(tableElement, filename = 'report.csv') { /* ... (same as before) ... */ let csv=[];const rows=tableElement.querySelectorAll("thead tr, tbody tr");for(let i=0;i<rows.length;i++){const row=[],cols=rows[i].querySelectorAll("td, th");for(let j=0;j<cols.length;j++){let data=cols[j].innerText.replace(/(\r\n|\n|\r)/gm,"").replace(/(\s\s)/gm," ").trim();if(cols[j].querySelector('.progress')){const progressBar=cols[j].querySelector('.progress-bar');data=progressBar?progressBar.innerText.trim():'0%';}data=data.replace(/"/g,'""');if(data.includes(','))data=`"${data}"`;row.push(data);}csv.push(row.join(","));}const csvFile=new Blob([csv.join("\n")],{type:"text/csv"});const downloadLink=document.createElement("a");downloadLink.download=filename;downloadLink.href=window.URL.createObjectURL(csvFile);downloadLink.style.display="none";document.body.appendChild(downloadLink);downloadLink.click();document.body.removeChild(downloadLink);}
                 function generatePdf(tableElement, filename = 'report.pdf') { /* ... (same as before) ... */ if(typeof jspdf==='undefined'||typeof jspdf.jsPDF==='undefined'){alert('jsPDF library is not loaded.');return;}const{jsPDF}=jspdf;const doc=new jsPDF({orientation:'landscape'});const startDateValue=startDateInput.value;const endDateValue=endDateInput.value;const startDateFormatted=formatReportDate(startDateValue);const endDateFormatted=formatReportDate(endDateValue);const dateRangeText=`Period: ${startDateFormatted} - ${endDateFormatted}`;const reportTitle="Employee Performance Report";doc.setFontSize(16);doc.text(reportTitle,14,16);doc.setFontSize(10);doc.setTextColor(100);doc.text(dateRangeText,14,22);doc.setTextColor(0);if(typeof doc.autoTable!=='function'){alert('jsPDF AutoTable plugin is not loaded.');return;}const head=[['Employee','Completion (%)','Overdue','Files','Score']];const body=[];const rows=tableElement.querySelectorAll("tbody tr");rows.forEach(row=>{const rowData=[];const cells=row.querySelectorAll("td");rowData.push(cells[0]?cells[0].innerText.trim():'');rowData.push(cells[1]?cells[1].querySelector('.progress-bar')?.innerText.trim()||'0%':'0%');rowData.push(cells[2]?cells[2].innerText.trim():'0');rowData.push(cells[3]?cells[3].innerText.trim():'0');rowData.push(cells[4]?cells[4].querySelector('.badge')?.innerText.trim()||'':'');body.push(rowData);});const tableStartY=28;doc.autoTable({head:head,body:body,startY:tableStartY,theme:'grid',styles:{fontSize:8,cellPadding:2},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:'bold'},columnStyles:{0:{cellWidth:60},1:{cellWidth:'auto',halign:'center'},2:{cellWidth:'auto',halign:'center'},3:{cellWidth:'auto',halign:'center'},4:{cellWidth:'auto',halign:'center'}}});doc.save(filename);}

                 // --- Initialization & Listeners ---
                 setPeriodDates('week');
                 addListener(filterForm, 'submit', (event) => { event.preventDefault(); applyFilters(); });
                 addListener(periodBtnGroup, 'change', (event) => { if (event.target.name === 'period') { setPeriodDates(event.target.value); } });
                 addListener(exportPdfBtn, 'click', () => { const table = cardBody.querySelector('#employeeSummaryTable'); if (table) { generatePdf(table, `Employee_Summary_${formatDateInput(new Date())}.pdf`); } else { alert('Summary table not found.'); } });
                 addListener(exportExcelBtn, 'click', () => { const table = cardBody.querySelector('#employeeSummaryTable'); if (table) { generateCsv(table, `Employee_Summary_${formatDateInput(new Date())}.csv`); } else { alert('Summary table not found.'); } });
                 applyFilters(); // Initial Render

                 const cleanup = () => {
                    console.log("Cleaning up Reports & Analytics...");
                    if (taskCompletionChartInstance) taskCompletionChartInstance.destroy(); if (overdueTasksChartInstance) overdueTasksChartInstance.destroy(); if (filesUploadedChartInstance) filesUploadedChartInstance.destroy(); if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy();
                    taskCompletionChartInstance = null; overdueTasksChartInstance = null; filesUploadedChartInstance = null; performanceComparisonChartInstance = null;
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                    listeners = [];
                    console.log("Reports & Analytics cleanup complete.");
                 };
                 return { cleanup };
             }
         </script>
    </template>

    <!-- Template for Employee Scheduling -->
    <template id="employeeSchedulingAssets">
        <style id="injected-employee-scheduling-styles">
            /* Styles are included in the main CSS block */
        </style>
        <!-- HTML structure -->
         <div class="card"> <!-- Wrap in a card -->
            <div class="schedule-page-header section-main-header">
                <h2 class="schedule-page-title section-main-title">Employee Scheduling</h2>
                 <!-- Admin buttons moved inside header -->
                 <div class="admin-actions" id="scheduleAdminActions" style="display: none;">
                    <button class="btn btn-primary btn-sm" id="saveScheduleBtn">
                        <i class="fas fa-save"></i> Save Schedule
                    </button>
                     <button class="btn btn-success btn-sm" id="sendRemindersBtn">
                         <i class="fas fa-envelope"></i> Send Reminders
                     </button>
                 </div>
            </div>
             <div class="card-body"> <!-- Content inside card body -->
                 <div class="schedule-controls">
                    <div class="week-nav">
                        <button class="btn btn-outline btn-sm" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev</button>
                        <span id="weekDisplay" style="margin: 0 1rem; font-weight: 500;">Loading...</span>
                        <button class="btn btn-outline btn-sm" id="nextWeekBtn">Next <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="schedule-container">
                    <table class="schedule-table table table-bordered"> <!-- Added bootstrap classes -->
                        <thead> <tr> <th>Employee</th> <!-- Days headers populated by JS --> </tr> </thead>
                        <tbody id="scheduleTableBody"> <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td></tr> </tbody>
                    </table>
                </div>
            </div>
        </div>
         <script>
            function initializeEmployeeScheduleLogic(container) {
                console.log("Initializing Employee Schedule Logic...");
                 const cardBody = container.querySelector('.card-body');
                 if (!cardBody) { console.error("Scheduling card body not found!"); return { cleanup: () => {} }; }
                 const calculateOffsets = () => { /* ... (Offset calculation - Same as before) ... */ const today=new Date();const mayFirst2025=new Date(2025,4,1);mayFirst2025.setHours(0,0,0,0);const currentDayOfWeek=today.getDay();const diffToSunday=today.getDate()-currentDayOfWeek;const startOfCurrentWeek=new Date(today);startOfCurrentWeek.setDate(diffToSunday);startOfCurrentWeek.setHours(0,0,0,0);const mayFirstDayOfWeek=mayFirst2025.getDay();const diffToMayFirstSunday=mayFirst2025.getDate()-mayFirstDayOfWeek;const startOfMayFirstWeek=new Date(mayFirst2025);startOfMayFirstWeek.setDate(diffToMayFirstSunday);startOfMayFirstWeek.setHours(0,0,0,0);const msPerDay=24*60*60*1000;const weeksDifference=Math.round((startOfMayFirstWeek.getTime()-startOfCurrentWeek.getTime())/(7*msPerDay));console.log(`Current Week Start: ${startOfCurrentWeek.toDateString()}`);console.log(`Target Week Start: ${startOfMayFirstWeek.toDateString()}`);console.log(`Calculated offset: ${weeksDifference}`);currentScheduleWeekOffset=weeksDifference;scheduleMinWeekOffset=weeksDifference; };
                 calculateOffsets();
                 const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                 const weekDisplay = cardBody.querySelector('#weekDisplay');
                 const scheduleTableBody = cardBody.querySelector('#scheduleTableBody');
                 const scheduleThead = cardBody.querySelector('.schedule-table thead tr');
                 const prevWeekBtn = cardBody.querySelector('#prevWeekBtn');
                 const nextWeekBtn = cardBody.querySelector('#nextWeekBtn');
                 const saveScheduleBtn = container.querySelector('#saveScheduleBtn');
                 const sendRemindersBtn = container.querySelector('#sendRemindersBtn');
                 const adminActionsDiv = container.querySelector('#scheduleAdminActions');
                 // Modals are global
                 const editShiftModal = document.getElementById('editShiftModal');
                 const editShiftForm = document.getElementById('editShiftForm');
                 const shiftTypeSelect = document.getElementById('shiftType');
                 const editShiftEmployeeIdInput = document.getElementById('editShiftEmployeeId');
                 const editShiftDayIndexInput = document.getElementById('editShiftDayIndex');
                 const editShiftWeekOffsetInput = document.getElementById('editShiftWeekOffset');
                 const editShiftModalTitle = document.getElementById('editShiftModalTitle');
                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };

                  // Show admin buttons if current user is admin
                  if (window.currentUser?.role === 'admin' && adminActionsDiv) {
                      adminActionsDiv.style.display = 'flex';
                  }

                 function getWeekDates(weekOffset = 0) { /* ... (Same as before) ... */ const baseDate=new Date();const startOfWeek=new Date(baseDate);const dayOfWeek=baseDate.getDay();const diff=baseDate.getDate()-dayOfWeek;startOfWeek.setDate(diff+(weekOffset*7));startOfWeek.setHours(0,0,0,0);const dates=[];for(let i=0;i<7;i++){const date=new Date(startOfWeek);date.setDate(startOfWeek.getDate()+i);dates.push(date);}return dates; }
                 window.renderSchedule = function(weekOffset) { /* ... (Same as before, but uses addListener for shift clicks) ... */ console.log(`Rendering schedule offset: ${weekOffset}`);if(isNaN(weekOffset)){weekOffset=currentScheduleWeekOffset;}const weekDates=getWeekDates(weekOffset);const start=weekDates[0];const end=weekDates[6];if(weekDisplay)weekDisplay.textContent=`${formatDateForDisplay(start)} - ${formatDateForDisplay(end)}`;if(prevWeekBtn){prevWeekBtn.disabled=weekOffset<=scheduleMinWeekOffset;}if(scheduleThead){scheduleThead.innerHTML='<th>Employee</th>';weekDates.forEach((date,index)=>{scheduleThead.innerHTML+=`<th><div class="day-header"><span class="day-name">${days[index]}</span><span class="day-date">${date.toLocaleDateString(undefined,{month:'short',day:'numeric'})}</span></div></th>`;});}if(scheduleTableBody){scheduleTableBody.innerHTML='';if(MOCK_USERS.length===0){scheduleTableBody.innerHTML=`<tr><td colspan="8">No employees found.</td></tr>`;return;}MOCK_USERS.forEach(employee=>{const row=document.createElement('tr');row.innerHTML=`<td class="employee-name">${employee.name}</td>`;for(let dayIndex=0;dayIndex<7;dayIndex++){const cell=document.createElement('td');const scheduleKey=`${employee.id}-${weekOffset}-${dayIndex}`;const isWeekend=dayIndex===5||dayIndex===6;let shiftType;let isEditable=window.currentUser.role==='admin'&&!isWeekend;if(isWeekend){shiftType='off';mockScheduleData[scheduleKey]='off';cell.classList.add('weekend-cell');}else{if(!mockScheduleData[scheduleKey]){const shiftTypes=['morning','afternoon','night','off','sick','vacation'];mockScheduleData[scheduleKey]=shiftTypes[Math.floor(Math.random()*shiftTypes.length)];}shiftType=mockScheduleData[scheduleKey];}const shiftDiv=document.createElement('div');shiftDiv.classList.add('shift');if(isWeekend){shiftDiv.classList.add('shift-weekend-off');}else{shiftDiv.classList.add(`shift-${shiftType.replace('_','-')}`);}shiftDiv.textContent=getShiftText(shiftType);if(isEditable){shiftDiv.classList.add('editable');shiftDiv.dataset.employeeId=employee.id;shiftDiv.dataset.employeeName=employee.name;shiftDiv.dataset.dayIndex=dayIndex;shiftDiv.dataset.weekOffset=weekOffset;shiftDiv.dataset.date=formatDateForDisplay(weekDates[dayIndex]);shiftDiv.title=`Edit ${employee.name}'s shift`;addListener(shiftDiv,'click',handleEditShiftClick);}else if(isWeekend){shiftDiv.title="Weekend Off";}cell.appendChild(shiftDiv);row.appendChild(cell);}scheduleTableBody.appendChild(row);});}}
                 function getShiftText(type) { /* ... (Same as before) ... */ switch(type){case 'morning':return '9AM-5PM';case 'afternoon':return '12PM-8PM';case 'night':return '8PM-4AM';case 'off':return 'OFF';case 'sick':return 'Sick';case 'vacation':return 'Vacation';default:return 'N/A';} }
                 function handleEditShiftClick(event) { /* ... (Same as before) ... */ const target=event.target;if(!target.classList.contains('editable'))return;const employeeId=target.dataset.employeeId;const dayIndex=target.dataset.dayIndex;const weekOffset=target.dataset.weekOffset;const employeeName=target.dataset.employeeName;const dateStr=target.dataset.date;const scheduleKey=`${employeeId}-${weekOffset}-${dayIndex}`;const currentShift=mockScheduleData[scheduleKey]||'morning';if(editShiftEmployeeIdInput)editShiftEmployeeIdInput.value=employeeId;if(editShiftDayIndexInput)editShiftDayIndexInput.value=dayIndex;if(editShiftWeekOffsetInput)editShiftWeekOffsetInput.value=weekOffset;if(shiftTypeSelect)shiftTypeSelect.value=currentShift;if(editShiftModalTitle)editShiftModalTitle.textContent=`Edit ${employeeName}'s Shift on ${days[dayIndex]||dateStr}`;if(editShiftModal)editShiftModal.classList.add('active'); }
                 addListener(prevWeekBtn, 'click', () => { if (currentScheduleWeekOffset > scheduleMinWeekOffset) { currentScheduleWeekOffset--; renderSchedule(currentScheduleWeekOffset); } });
                 addListener(nextWeekBtn, 'click', () => { currentScheduleWeekOffset++; renderSchedule(currentScheduleWeekOffset); });
                 addListener(saveScheduleBtn, 'click', () => { /* ... (Same as before) ... */ showConfirmModal('Save Schedule','Save changes?',()=>{saveScheduleBtn.disabled=true;saveScheduleBtn.innerHTML='<span class="spinner"></span> Saving...';console.log("Saving schedule...",mockScheduleData);setTimeout(()=>{window.showToast("Schedule saved!","success");saveScheduleBtn.disabled=false;saveScheduleBtn.innerHTML='<i class="fas fa-save"></i> Save Schedule';},1000);},'btn-primary');});
                 addListener(sendRemindersBtn, 'click', handleSendReminders);
                 if (editShiftModal) { editShiftModal.querySelectorAll('[data-close-modal]').forEach(btn => { addListener(btn, 'click', () => editShiftModal.classList.remove('active')); }); addListener(editShiftModal, 'click', (event) => { if (event.target === editShiftModal) { editShiftModal.classList.remove('active'); } }); }
                 addListener(editShiftForm, 'submit', (event) => { /* ... (Same as before) ... */ event.preventDefault();const employeeId=editShiftEmployeeIdInput.value;const dayIndex=editShiftDayIndexInput.value;const weekOffset=editShiftWeekOffsetInput.value;const newShiftType=shiftTypeSelect.value;const scheduleKey=`${employeeId}-${weekOffset}-${dayIndex}`;mockScheduleData[scheduleKey]=newShiftType;renderSchedule(parseInt(weekOffset));if(editShiftModal)editShiftModal.classList.remove('active');window.showToast("Shift updated.");});
                 renderSchedule(currentScheduleWeekOffset); // Initial render
                  const cleanup = () => {
                      console.log("Cleaning up Employee Scheduling...");
                      listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                      listeners = [];
                      document.getElementById('editShiftModal')?.classList.remove('active');
                      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove()); document.body.classList.remove('modal-open'); document.body.style.overflow = ''; document.body.style.paddingRight = '';
                      console.log("Employee Scheduling cleanup complete.");
                  };
                  return { cleanup };
             }
         </script>
    </template>

    <!-- Template for Team Members View -->
    <template id="teamMembersAssets">
        <style id="injected-team-members-view-styles">
             /* Team Members View Specific Styles - Refactored */
             #featureSectionsContainer.team-members-view .team-members-section { background-color: transparent; border-radius: 0; max-width: none; margin: 0; box-shadow: none; border: none; }
             #featureSectionsContainer.team-members-view .team-members-section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background-color: var(--base-bg-color); color: var(--base-text-color); margin: 0; padding: 1.1rem 1.5rem; font-weight: 600; text-align: left; border-bottom: 1px solid var(--card-border-color); }
             #featureSectionsContainer.team-members-view .team-members-section-header h2 { font-size: 1.5rem; margin: 0; color: var(--primary-dark); }
             body.dark-theme #featureSectionsContainer.team-members-view .team-members-section-header h2 { color: #93c5fd; }
             #featureSectionsContainer.team-members-view .team-content-area { padding: 1.5rem; background-color: var(--card-bg-color); border-radius: 0 0 8px 8px; }
             #featureSectionsContainer.team-members-view .team-filter { margin-bottom: 1.5rem; max-width: 400px; }
             #featureSectionsContainer.team-members-view .team-filter input[type="text"] { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--input-border-color); border-radius: 6px; background-color: var(--input-bg-color); box-sizing: border-box; font-size: 0.95rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.03); color: var(--base-text-color); }
             #featureSectionsContainer.team-members-view .team-filter input[type="text"]::placeholder { color: var(--gray); }
             #featureSectionsContainer.team-members-view .team-filter input[type="text"]:focus { outline: none; border-color: var(--input-focus-border-color); box-shadow: 0 0 0 3px var(--input-focus-shadow-color); }
             #featureSectionsContainer.team-members-view .team-members-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
             #featureSectionsContainer.team-members-view .team-member-card { display: flex; flex-direction: column; align-items: flex-start; background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); border-radius: 12px; padding: 1.25rem; box-shadow: 0 3px 8px var(--card-shadow-color); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out; overflow: hidden; }
             #featureSectionsContainer.team-members-view .team-member-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--card-shadow-color); border-color: var(--gray); }
             #featureSectionsContainer.team-members-view .member-info { width: 100%; }
             #featureSectionsContainer.team-members-view .member-name { font-size: 1.15rem; font-weight: 600; color: var(--base-text-color); margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
             #featureSectionsContainer.team-members-view .member-email { font-size: 0.88rem; color: var(--gray); margin: 0 0 14px 0; word-break: break-all; line-height: 1.4; }
             #featureSectionsContainer.team-members-view .member-role { font-size: 0.85rem; font-weight: 500; margin: 0; padding: 4px 10px; border-radius: 6px; display: inline-block; line-height: 1.3; color: #fff; }
             #featureSectionsContainer.team-members-view .member-role.role-admin { background-color: var(--danger); }
             #featureSectionsContainer.team-members-view .member-role.role-supervisor { background-color: var(--primary); }
             #featureSectionsContainer.team-members-view .member-role.role-senior { background-color: var(--success); }
             #featureSectionsContainer.team-members-view .member-role.role-member { background-color: var(--gray); }
             #featureSectionsContainer.team-members-view .team-member-card.hidden-by-filter { display: none; }
        </style>
        <!-- Team Members Feature View HTML -->
         <div class="team-members-section card"> <!-- Wrap in card -->
             <div class="team-members-section-header">
                <h2>Team Members</h2>
                <button class="btn btn-primary btn-sm add-team-member-btn" id="addMemberBtnFeature"><i class="fas fa-user-plus"></i> Add Member</button>
             </div>
             <div class="team-content-area card-body"> <!-- Use card-body -->
                 <div class="team-filter">
                     <input type="text" id="teamSearchInputFeature" placeholder="Search team by name, email, or role..." aria-label="Search team members">
                 </div>
                 <div class="team-members-list team-list-display" id="teamListContainerFeature">
                     <p style="color: var(--gray);">Loading team members...</p>
                 </div>
             </div>
         </div>
        <script>
             function initializeTeamMembersFeature(container) {
                 console.log("Initializing Team Members Feature...");
                 const cardBody = container.querySelector('.card-body');
                 if (!cardBody) { console.error("Team Members card body not found!"); return { cleanup: () => {} }; }
                 const searchInput = cardBody.querySelector('#teamSearchInputFeature');
                 const teamListContainer = cardBody.querySelector('#teamListContainerFeature');
                 const addMemberBtn = container.querySelector('#addMemberBtnFeature'); // In header

                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 function filterTeamMembers() { /* ... (Same as before) ... */ const filterText=searchInput.value.toLowerCase().trim();const memberCards=teamListContainer.querySelectorAll('.team-member-card');memberCards.forEach(card=>{const name=(card.dataset.name||'').toLowerCase();const role=(card.dataset.role||'').toLowerCase();const email=(card.dataset.email||'').toLowerCase();const isMatch=name.includes(filterText)||role.includes(filterText)||email.includes(filterText);card.classList.toggle('hidden-by-filter',!isMatch);});}

                 // Use the global loadTeamMembers function, passing the feature's container
                 loadTeamMembers(cardBody); // Load members into the feature view's container

                 addListener(searchInput, 'input', filterTeamMembers);
                 addListener(addMemberBtn, 'click', () => openMemberModal()); // Use global modal function

                 const cleanup = () => {
                     console.log("Cleaning up Team Members feature listeners...");
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                     listeners = [];
                 };
                 return { cleanup };
             }
        </script>
    </template>

     <!-- Template for Projects View -->
    <template id="projectsAssets">
         <style id="injected-projects-view-styles">
             /* Projects View Specific Styles - Refactored */
             #featureSectionsContainer.projects-feature #projects-section { background-color: transparent; }
             #featureSectionsContainer.projects-feature .projects-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; padding: 1rem 1.5rem; background-color: var(--base-bg-color); border-bottom: 1px solid var(--card-border-color); }
             #featureSectionsContainer.projects-feature .projects-title-wrapper { background: none; padding: 0; border: none; box-shadow: none; }
             #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--primary-dark); font-size: 1.5rem; }
             body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: #93c5fd; }
             #featureSectionsContainer.projects-feature .project-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; background: none; padding: 0; box-shadow: none; }
             #featureSectionsContainer.projects-feature .projects-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; padding: 1.5rem; /* Add padding around the list */ }
             #featureSectionsContainer.projects-feature .project-card { background-color: var(--card-bg-color); border-radius: 8px; border: 1px solid var(--card-border-color); box-shadow: 0 2px 4px var(--card-shadow-color); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
             #featureSectionsContainer.projects-feature .project-card:hover { transform: translateY(-4px); box-shadow: 0 5px 10px var(--card-shadow-color); }
             #featureSectionsContainer.projects-feature .project-card-image { height: 180px; background-size: cover; background-position: center; position: relative; }
             #featureSectionsContainer.projects-feature .project-card-body { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; }
             #featureSectionsContainer.projects-feature .project-name { font-size: 1.3em; font-weight: 600; color: var(--primary-dark); margin-top: 0; margin-bottom: 0.5rem; }
             body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: #93c5fd; }
             #featureSectionsContainer.projects-feature .progress-bar-container { width: 100%; height: 8px; background-color: var(--light-gray); border-radius: 4px; overflow: hidden; margin-bottom: 1rem; }
             #featureSectionsContainer.projects-feature .project-status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; margin-bottom: 0.75rem; align-self: flex-start; }
             #featureSectionsContainer.projects-feature .project-info { font-size: 0.85em; color: var(--gray); margin-bottom: 0.6rem; display: flex; align-items: flex-start; }
             #featureSectionsContainer.projects-feature .project-info i { margin-right: 8px; color: var(--gray); width: 16px; text-align: center; margin-top: 2px; }
             #featureSectionsContainer.projects-feature .project-participants span { display: inline-block; background-color: var(--base-bg-color); color: var(--gray); padding: 3px 8px; border-radius: 10px; font-size: 0.75em; margin-right: 4px; margin-bottom: 4px; white-space: nowrap; border: 1px solid var(--card-border-color); }
             body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: var(--light); color: var(--gray); }
             #featureSectionsContainer.projects-feature .project-actions { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--card-border-color); display: flex; gap: 0.5rem; flex-wrap: wrap; }
             #featureSectionsContainer.projects-feature .project-actions .btn { font-size: 0.8em; padding: 0.4rem 0.8rem; }
         </style>
         <!-- Projects View HTML - Wrapped in card -->
          <div class="card">
             <section id="projects-section">
                 <div class="projects-header">
                     <div class="projects-title-wrapper"><h2>Projects</h2></div>
                     <div class="project-controls">
                         <input type="search" placeholder="Search Projects..." class="project-search-input form-control form-control-sm" id="projectSearchInputFeature">
                         <select class="project-filter-select form-select form-select-sm" id="projectFilterSelectFeature">
                             <option value="all">All Statuses</option>
                             <option value="active">Active</option>
                             <option value="in-progress">In Progress</option>
                             <option value="completed">Completed</option>
                             <option value="pending">Pending</option>
                         </select>
                         <button class="btn btn-primary btn-sm add-project-btn" id="addProjectBtnFeature"> <i class="fas fa-plus-circle"></i> Add Project </button>
                     </div>
                 </div>
                 <div class="projects-list" id="projectsListContainerFeature">
                     <p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">Loading projects...</p>
                 </div>
             </section>
          </div>
         <script>
              function initializeProjectsFeature(container) {
                 console.log("Initializing Projects Feature...");
                  const section = container.querySelector('#projects-section');
                  if (!section) { console.error("Projects section not found!"); return { cleanup: () => {} }; }
                  const searchInput = section.querySelector('#projectSearchInputFeature');
                  const filterSelect = section.querySelector('#projectFilterSelectFeature');
                  const projectsListContainer = section.querySelector('#projectsListContainerFeature');
                  const addProjectBtn = section.querySelector('#addProjectBtnFeature');
                  let listeners = [];
                  const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                  const filterHandler = () => renderProjects(section); // Pass section instead of container
                  const actionHandler = (event) => { const target = event.target.closest('.btn'); if (!target) return; const projectId = target.dataset.projectId; if (!projectId) return; if (target.classList.contains('btn-view')) { alert(`Placeholder: View details for Project ID ${projectId}`); } else if (target.classList.contains('btn-edit')) { openProjectModal(projectId); } else if (target.classList.contains('btn-delete')) { handleDeleteProject(projectId); } };
                  const addHandler = () => { openProjectModal(); };

                   // Check permissions for Add button
                   if (window.currentUser?.role !== 'admin' && window.currentUser?.role !== 'supervisor') {
                       if (addProjectBtn) addProjectBtn.style.display = 'none';
                   } else {
                       addListener(addProjectBtn, 'click', addHandler);
                   }

                  // Initial render
                  renderProjects(section); // Pass section
                  addListener(searchInput, 'input', filterHandler);
                  addListener(filterSelect, 'change', filterHandler);
                  addListener(projectsListContainer, 'click', actionHandler);

                  const cleanup = () => {
                      console.log("Cleaning up Projects feature listeners...");
                       listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                       listeners = [];
                  };
                  return { cleanup };
              }
         </script>
    </template>

     <!-- Template for Innovation Hub -->
     <template id="innovationHubAssets">
         <style id="injected-innovation-hub-styles">
             /* Innovation Hub specific styles - Refactored */
             #featureSectionsContainer.innovation-hub-feature .hub-header {
                 background: linear-gradient(90deg, var(--feature-hub-header-bg-start), var(--feature-hub-header-bg-end));
                 color: var(--feature-hub-header-text-color);
                 padding: 1.5rem 2rem; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; /* Added margin */
             }
             #featureSectionsContainer.innovation-hub-feature .hub-header h1 { font-size: 1.8rem; font-weight: 600; margin: 0; letter-spacing: 0.5px; }
             #featureSectionsContainer.innovation-hub-feature .submission-form-container { background-color: var(--card-bg-color); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px var(--card-shadow-color); margin-bottom: 1.5rem; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form { display: flex; flex-direction: column; gap: 1rem; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form .form-row { display: flex; gap: 1rem; align-items: flex-end; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form .form-row .form-group { flex-grow: 1; }
             #featureSectionsContainer.innovation-hub-feature #suggestion-form .form-row button { flex-shrink: 0; height: fit-content; padding: 0.7rem 1.5rem; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls { display: flex; flex-wrap: wrap; gap: 1rem; padding: 0.5rem 0; align-items: flex-end; margin-bottom: 1.5rem; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls .form-group { margin-bottom: 0; }
             #featureSectionsContainer.innovation-hub-feature .hub-controls label { font-size: 0.85rem; color: var(--gray); }
             #featureSectionsContainer.innovation-hub-feature #my-ideas-toggle { padding: 0.6rem 1rem; }
             #featureSectionsContainer.innovation-hub-feature #my-ideas-toggle.active { background-color: var(--primary); color: var(--white); opacity: 1; }
             #featureSectionsContainer.innovation-hub-feature #suggestions-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-card { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: 0 2px 8px var(--card-shadow-color); padding: 1.25rem; display: flex; flex-direction: column; gap: 0.8rem; transition: transform 0.2s ease, box-shadow 0.2s ease; opacity: 0; animation: fadeIn 0.5s ease forwards; border: 1px solid var(--card-border-color); }
             #featureSectionsContainer.innovation-hub-feature .suggestion-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--card-shadow-color); }
             #featureSectionsContainer.innovation-hub-feature .suggestion-text-display { font-size: 1rem; line-height: 1.6; margin-bottom: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta { font-size: 0.8rem; color: var(--gray); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid var(--card-border-color); padding-top: 0.8rem; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta .author::before { content: "👤 "; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-meta .date::before { content: "📅 "; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-status-section { margin-top: 0.5rem; }
             #featureSectionsContainer.innovation-hub-feature .suggestion-status { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 600; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
             #featureSectionsContainer.innovation-hub-feature .status-under-review { background-color: var(--feature-hub-status-review-bg); color: var(--feature-hub-status-review-text); }
             #featureSectionsContainer.innovation-hub-feature .status-implemented { background-color: var(--feature-hub-status-implemented-bg); color: var(--feature-hub-status-implemented-text); }
             #featureSectionsContainer.innovation-hub-feature .status-rejected { background-color: var(--feature-hub-status-rejected-bg); color: var(--feature-hub-status-rejected-text); }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section { margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px dashed var(--card-border-color); }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply-section strong { display: block; font-size: 0.85rem; color: var(--gray); margin-bottom: 0.3rem; }
             #featureSectionsContainer.innovation-hub-feature .supervisor-reply { font-size: 0.9rem; background-color: var(--base-bg-color); padding: 0.5rem 0.8rem; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
             #featureSectionsContainer.innovation-hub-feature .admin-controls { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--card-border-color); display: flex; flex-direction: column; gap: 0.8rem; display: none; }
             #featureSectionsContainer.innovation-hub-feature.admin-view #suggestions-list .admin-controls { display: flex; } /* Show only if admin-view class is added */
             #featureSectionsContainer.innovation-hub-feature .admin-controls .form-group { margin-bottom: 0; }
             #featureSectionsContainer.innovation-hub-feature .admin-controls select { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
             #featureSectionsContainer.innovation-hub-feature .admin-controls textarea { font-size: 0.9rem; min-height: 60px; }
             #featureSectionsContainer.innovation-hub-feature .admin-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
             #featureSectionsContainer.innovation-hub-feature .admin-actions button { font-size: 0.8rem; padding: 0.4em 0.8em; }
             @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
         </style>
         <!-- Innovation Hub HTML - Wrapped in card -->
         <div class="card">
            <div class="card-body"> <!-- Wrap content in card-body -->
                 <div class="innovation-hub-container" id="innovation-hub">
                    <header class="hub-header"> <h1>💡 Innovation Hub</h1> </header>
                    <section class="submission-form-container">
                        <h2>Submit a New Suggestion</h2>
                        <form id="suggestion-form">
                            <div class="form-group"> <label for="suggestion-text">Your Idea / Suggestion:</label> <textarea id="suggestion-text" name="suggestion-text" rows="4" required placeholder="Describe your innovative idea..."></textarea> </div>
                            <div class="form-row">
                                <div class="form-group"> <label for="employee-select">Submitted By:</label> <select id="employee-select" name="employee" required class="form-select"> <option value="" disabled selected>-- Select Your Name --</option> </select> </div>
                                <button type="submit" class="btn btn-primary">Submit Idea</button>
                            </div>
                        </form>
                    </section>
                    <section class="hub-controls">
                        <div class="form-group"> <label for="filter-status">Filter by Status:</label> <select id="filter-status" class="form-select form-select-sm"> <option value="All">All Statuses</option> <option value="Under Review">Under Review</option> <option value="Implemented">Implemented</option> <option value="Rejected">Rejected</option> </select> </div>
                        <div class="form-group"> <label for="filter-author">Filter by Author:</label> <select id="filter-author" class="form-select form-select-sm"> <option value="All">All Authors</option> </select> </div>
                        <button id="my-ideas-toggle" class="btn btn-secondary btn-sm">Show My Ideas Only</button>
                    </section>
                    <section id="suggestions-list"></section>
                </div>
            </div>
        </div>
         <script>
              function initializeInnovationHubFeature(container) {
                 console.log("Initializing Innovation Hub Feature...");
                 const hubContent = container.querySelector('#innovation-hub');
                 if (!hubContent) { console.error("Innovation Hub content container not found!"); return { cleanup: () => {} }; }
                 const employeeNames = window.MOCK_USERS.map(u => u.name); // Use global user list
                 const adminUser = window.MOCK_USERS.find(u => u.role === 'admin')?.name || employeeNames[0]; // Find admin or fallback
                 let currentUser = window.currentUser?.name || employeeNames[0]; // Use global current user
                 const isAdmin = window.currentUser?.role === 'admin';

                 const suggestionForm = hubContent.querySelector('#suggestion-form');
                 const suggestionText = hubContent.querySelector('#suggestion-text');
                 const employeeSelect = hubContent.querySelector('#employee-select');
                 const suggestionsList = hubContent.querySelector('#suggestions-list');
                 const filterStatusSelect = hubContent.querySelector('#filter-status');
                 const filterAuthorSelect = hubContent.querySelector('#filter-author');
                 const myIdeasToggle = hubContent.querySelector('#my-ideas-toggle');
                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };

                 let suggestionsData = JSON.parse(localStorage.getItem('innovationHubSuggestions')) || [ /* ... (default data) ... */ {id:1,text:"Implement a 'quiet hour' policy twice a week for focused work.",author:"Esraa Lashin",date:"2024-05-15",status:"Under Review",reply:""},{id:2,text:"Organize monthly cross-departmental knowledge sharing sessions.",author:"Yousef Ahmed",date:"2024-05-10",status:"Implemented",reply:"Excellent initiative, this is now scheduled!"},{id:3,text:"Upgrade the coffee machine in the break room.",author:"Mohamed Elmenisy",date:"2024-04-28",status:"Rejected",reply:"Budget constraints prevent this at the moment."},{id:4,text:"Create a mentorship program for new hires.",author:"Bassant Badr",date:"2024-05-20",status:"Under Review",reply:""}];
                 const saveData = () => { localStorage.setItem('innovationHubSuggestions', JSON.stringify(suggestionsData)); };
                 const formatDate = (dateString) => { const date = new Date(dateString); return date.toLocaleDateString('en-CA'); };
                 const getStatusClass = (status) => { switch (status) { case "Under Review": return "status-under-review"; case "Implemented": return "status-implemented"; case "Rejected": return "status-rejected"; default: return ""; } };
                 const escapeHTML = (str) => { const div = document.createElement('div'); div.appendChild(document.createTextNode(str || '')); return div.innerHTML; } // Added null check

                 const renderSuggestions = () => {
                      suggestionsList.innerHTML = ''; const statusFilter = filterStatusSelect.value; const authorFilter = filterAuthorSelect.value; const showMyIdeas = myIdeasToggle.classList.contains('active');
                      const filteredSuggestions = suggestionsData.filter(suggestion => { const statusMatch = statusFilter === 'All' || suggestion.status === statusFilter; const authorMatch = authorFilter === 'All' || suggestion.author === authorFilter; const myIdeasMatch = !showMyIdeas || suggestion.author === currentUser; return statusMatch && authorMatch && myIdeasMatch; });
                      if (filteredSuggestions.length === 0) { suggestionsList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--secondary-text-color);">No suggestions match the current filters.</p>'; }
                      else { filteredSuggestions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(suggestion => { /* ... (render card logic - same as before) ... */ const card=document.createElement('div');card.classList.add('suggestion-card');card.dataset.id=suggestion.id;card.innerHTML=`<p class="suggestion-text-display">${escapeHTML(suggestion.text)}</p><div class="suggestion-meta"><span class="author">👤 ${escapeHTML(suggestion.author)}</span><span class="date">📅 ${formatDate(suggestion.date)}</span></div><div class="suggestion-status-section">Status: <span class="suggestion-status ${getStatusClass(suggestion.status)}">${escapeHTML(suggestion.status)}</span></div><div class="supervisor-reply-section ${suggestion.reply?'':'hidden'}"><strong>${escapeHTML(adminUser)}'s Reply:</strong><p class="supervisor-reply">${escapeHTML(suggestion.reply)}</p></div><div class="admin-controls"><div class="form-group"><label for="status-select-${suggestion.id}">Change Status:</label><select id="status-select-${suggestion.id}" class="admin-status-select form-select form-select-sm"><option value="Under Review" ${suggestion.status==='Under Review'?'selected':''}>Under Review</option><option value="Implemented" ${suggestion.status==='Implemented'?'selected':''}>Implemented</option><option value="Rejected" ${suggestion.status==='Rejected'?'selected':''}>Rejected</option></select></div><div class="form-group"><label for="reply-input-${suggestion.id}">Add/Edit Reply:</label><textarea id="reply-input-${suggestion.id}" class="admin-reply-input form-control" rows="2">${escapeHTML(suggestion.reply)}</textarea></div><div class="admin-actions"><button class="btn btn-primary btn-sm admin-save-reply">Save Reply</button><button class="btn btn-danger btn-sm admin-delete">Delete</button></div></div>`;suggestionsList.appendChild(card);}); }
                  };

                 // --- Event Listeners ---
                 addListener(suggestionForm, 'submit', (e) => { /* ... (Form submit logic - same as before) ... */ e.preventDefault();const text=suggestionText.value.trim();const author=employeeSelect.value;if(!text||!author){alert('Please enter your suggestion and select your name.');return;}const newSuggestion={id:Date.now(),text:text,author:author,date:new Date().toISOString(),status:"Under Review",reply:""};suggestionsData.push(newSuggestion);saveData();renderSuggestions();suggestionForm.reset();employeeSelect.value=currentUser;});
                 addListener(filterStatusSelect, 'change', renderSuggestions);
                 addListener(filterAuthorSelect, 'change', renderSuggestions);
                 addListener(myIdeasToggle, 'click', () => { myIdeasToggle.classList.toggle('active'); if (myIdeasToggle.classList.contains('active')) { myIdeasToggle.textContent = 'Show All Ideas'; myIdeasToggle.classList.remove('btn-secondary'); myIdeasToggle.classList.add('btn-primary'); } else { myIdeasToggle.textContent = 'Show My Ideas Only'; myIdeasToggle.classList.remove('btn-primary'); myIdeasToggle.classList.add('btn-secondary'); } renderSuggestions(); });
                 addListener(suggestionsList, 'click', (e) => { /* ... (Admin actions logic - same as before) ... */ if(!isAdmin)return;const card=e.target.closest('.suggestion-card');if(!card)return;const suggestionId=parseInt(card.dataset.id);const suggestionIndex=suggestionsData.findIndex(s=>s.id===suggestionId);if(suggestionIndex===-1)return;if(e.target.classList.contains('admin-status-select')){const newStatus=e.target.value;suggestionsData[suggestionIndex].status=newStatus;saveData();const statusBadge=card.querySelector('.suggestion-status');statusBadge.textContent=newStatus;statusBadge.className=`suggestion-status ${getStatusClass(newStatus)}`;}if(e.target.classList.contains('admin-save-reply')){const replyInput=card.querySelector('.admin-reply-input');const newReply=replyInput.value.trim();suggestionsData[suggestionIndex].reply=newReply;saveData();const replySection=card.querySelector('.supervisor-reply-section');const replyText=card.querySelector('.supervisor-reply');if(newReply){replyText.textContent=newReply;replySection.classList.remove('hidden');}else{replySection.classList.add('hidden');}window.showToast('Reply saved.','success');}if(e.target.classList.contains('admin-delete')){if(confirm(`Are you sure you want to delete the suggestion: "${suggestionsData[suggestionIndex].text.substring(0,50)}..."?`)){suggestionsData.splice(suggestionIndex,1);saveData();renderSuggestions();}}});

                 const setupHub = () => {
                     if (isAdmin) { hubContent.classList.add('admin-view'); } // Apply admin view styling
                     employeeSelect.innerHTML = '<option value="" disabled selected>-- Select Your Name --</option>'; // Reset
                     filterAuthorSelect.innerHTML = '<option value="All">All Authors</option>'; // Reset
                     employeeNames.forEach(name => {
                         const option = document.createElement('option'); option.value = name; option.textContent = name;
                         employeeSelect.appendChild(option.cloneNode(true));
                         filterAuthorSelect.appendChild(option.cloneNode(true));
                     });
                     if (employeeNames.includes(currentUser)) { employeeSelect.value = currentUser; }
                     else { console.warn("Current user not in the employee list for submission."); }
                     renderSuggestions();
                 };
                 setupHub(); // Run initial setup

                 const cleanup = () => {
                     console.log("Cleaning up Innovation Hub...");
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                     listeners = [];
                     console.log("Innovation Hub cleanup complete.");
                 };
                 return { cleanup };
              }
         </script>
     </template>


    <!-- ========= END Feature Templates ========= -->


    <!-- JS Libraries (Bootstrap, Chart.js, SweetAlert2, jsPDF, jsPDF-AutoTable) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = featurePlaceholder.querySelector('#featureTitle'); // Corrected selector
            const featureDescEl = featurePlaceholder.querySelector('#featureDescription'); // Corrected selector
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');

            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModal = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModal = document.getElementById('projectModal'); // NEW: Project Modal
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button

            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = []; // Store all loaded activities
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let currentFeatureCleanup = null; // Stores the cleanup function for the loaded feature
            let MOCK_PROJECTS_DATA = []; // To store projects data
            let MOCK_USERS = []; // Will be loaded
            let MOCK_TASKS = []; // Will be loaded


            // --- Mock Data Loading ---
            function loadMockData() {
                 // Use 'let' so users can be added/removed
                 MOCK_USERS = [
                     { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                     { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                     { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                     { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                     { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
                 ];

                 MOCK_TASKS = [
                    { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                    { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                    { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                    { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
                ];

                 MOCK_PROJECTS_DATA = [
                    { id: 101, name: 'Project Alpha', status: 'active', participants: "Mohamed Elmenisy|Yousef Ahmed", img: "https://images.unsplash.com/photo-1517048676732-d65bc937f952?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 65, startDate: "2023-08-15", updatedDate: "2024-03-10", editable: true, description: "Main company website overhaul." },
                    { id: 102, name: 'Website Redesign', status: 'completed', participants: "Esraa Lashin|Bassant Badr", img: "https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 100, startDate: "2023-05-01", updatedDate: "2024-01-20", editable: false, description: "Redesign of the public marketing site." },
                    { id: 103, name: 'Mobile App V2', status: 'in-progress', participants: "Yousef Ahmed|Mohamed Elmenisy", img: "https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 20, startDate: "2024-02-20", updatedDate: "2024-03-05", editable: true, description: "Version 2 development for iOS and Android." },
                    { id: 104, name: 'Q4 Marketing Plan', status: 'pending', participants: "Bassant Badr|Nada Mahmoud", img: "https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 0, startDate: "2024-09-01", updatedDate: "2024-03-12", editable: true, description: "Planning for the Q4 marketing campaign." },
                    { id: 105, name: 'Server Migration', status: 'in-progress', participants: "Yousef Ahmed", img: "https://images.unsplash.com/photo-1580894742597-87bc8789db3d?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=60", progress: 85, startDate: "2024-01-10", updatedDate: "2024-03-15", editable: true, description: "Migrating servers to new infrastructure." }
                ];
                 console.log("Mock data loaded.");
            }

            // --- Initialization ---
            function initDashboard() {
                loadMockData();
                // Simulate loading current user (using the first mock user)
                currentUser = { ...MOCK_USERS[0] }; // Use a copy
                window.currentUser = currentUser; // Make accessible globally for features
                console.log("Initializing dashboard for:", currentUser.name);

                applyStoredPreferences(); // Apply theme, contrast etc. *before* other UI updates
                updateUserUI();
                setupEventListeners();
                loadInitialData();
                handleInitialNavigation(); // Navigate based on URL hash first
                startDynamicUpdates(); // Start intervals for data refresh
                setupResponsiveSidebar();
            }

            // --- UI Updates ---
            function updateUserUI() { /* ... (Same as before) ... */ if(!currentUser)return;document.getElementById('userName').textContent=currentUser.name;document.getElementById('userAvatar').textContent=currentUser.initials;if(currentUser.avatar){document.getElementById('userAvatar').style.backgroundImage=`url(${currentUser.avatar})`;document.getElementById('userAvatar').textContent='';}else{document.getElementById('userAvatar').style.backgroundImage='none';document.getElementById('userAvatar').textContent=currentUser.initials;}document.getElementById('welcomeName').textContent=currentUser.name.split(' ')[0];document.getElementById('userInfoName').textContent=currentUser.name;document.getElementById('userEmail').textContent=currentUser.email;document.getElementById('profileAvatar').textContent=currentUser.initials;if(currentUser.avatar){document.getElementById('profileAvatar').style.backgroundImage=`url(${currentUser.avatar})`;document.getElementById('profileAvatar').textContent='';}else{document.getElementById('profileAvatar').style.backgroundImage='none';document.getElementById('profileAvatar').textContent=currentUser.initials;}const roleTitle=document.getElementById('userInfoRoleTitle');roleTitle.textContent=formatRole(currentUser.role);roleTitle.className=`user-info-title role-${currentUser.role}`;updateProfileForm();profileAvatarLarge.textContent=currentUser.initials;if(currentUser.avatar){profileAvatarLarge.style.backgroundImage=`url(${currentUser.avatar})`;profileAvatarLarge.textContent='';}else{profileAvatarLarge.style.backgroundImage='none';profileAvatarLarge.textContent=currentUser.initials;}if(accountEmailDisplay)accountEmailDisplay.value=currentUser.email;const teamSettingsTab=document.getElementById('teamSettingsTab');const dangerZoneTab=document.getElementById('dangerZoneTab');const deleteAllUsersSection=document.getElementById('deleteAllUsersSection');if(currentUser.role==='admin'){if(teamSettingsTab)teamSettingsTab.style.display='flex';if(dangerZoneTab)dangerZoneTab.style.display='flex';if(deleteAllUsersSection)deleteAllUsersSection.style.display='block';}else{if(teamSettingsTab)teamSettingsTab.style.display='none';if(dangerZoneTab)dangerZoneTab.style.display='none';if(deleteAllUsersSection)deleteAllUsersSection.style.display='none';if(currentFeature==='settings'&&(currentSettingsTab==='team'||currentSettingsTab==='danger')){activateSettingsTab('preferences');}}update2FA_UI();userPhoneNumberForSms.textContent=currentUser.phone||'Not Available';}
            function updateProfileForm() { /* ... (Same as before) ... */ if(!currentUser)return;const nameParts=currentUser.name.split(' ');firstNameInput.value=nameParts[0]||'';lastNameInput.value=nameParts.slice(1).join(' ')||'';fullNameDisplay.value=currentUser.name;jobTitleInput.value=currentUser.title||'';emailDisplay.value=currentUser.email||'';phoneInput.value=currentUser.phone||'';departmentInput.value=currentUser.department||'';}
            function formatRole(role) { /* ... (Same as before) ... */ if(!role)return 'Member';return role.charAt(0).toUpperCase()+role.slice(1);}

            // --- Preferences & Settings Logic ---
            function applyStoredPreferences() { /* ... (Same as before) ... */ const storedTheme=localStorage.getItem('theme')||'system';setTheme(storedTheme);const storedContrast=localStorage.getItem('highContrast')==='true';setContrast(storedContrast);if(highContrastToggle)highContrastToggle.checked=storedContrast;const storedLang=localStorage.getItem('language')||'en';if(languageSelect)languageSelect.value=storedLang;applyLanguage(storedLang);const storedRegion=localStorage.getItem('region')||'utc';if(regionSelect)regionSelect.value=storedRegion;const storedTimeFormat=localStorage.getItem('timeFormat')||'12h';const storedDateFormat=localStorage.getItem('dateFormat')||'MM/DD/YYYY';if(timeFormatSelect)timeFormatSelect.value=storedTimeFormat;if(dateFormatSelect)dateFormatSelect.value=storedDateFormat;applyDateTimeFormat(storedTimeFormat,storedDateFormat);const storedToastPref=localStorage.getItem('showToasts');showToasts=storedToastPref===null?true:(storedToastPref==='true');if(toastToggle)toastToggle.checked=showToasts;const storedSoundPref=localStorage.getItem('playSounds');playSounds=storedSoundPref===null?true:(storedSoundPref==='true');if(soundToggle)soundToggle.checked=playSounds;}
            function setTheme(theme) { /* ... (Same as before) ... */ console.log("Setting theme:",theme);document.body.classList.remove('light-theme','dark-theme');if(theme==='system'){const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;document.body.classList.add(prefersDark?'dark-theme':'light-theme');console.log("System prefers dark:",prefersDark);}else{document.body.classList.add(`${theme}-theme`);}themeOptions.forEach(option=>{option.classList.toggle('selected',option.dataset.theme===theme);});localStorage.setItem('theme',theme);}
            function setContrast(enabled) { /* ... (Same as before) ... */ console.log("Setting high contrast:",enabled);document.body.classList.toggle('high-contrast',enabled);localStorage.setItem('highContrast',enabled);}
            function applyLanguage(lang) { /* ... (Same as before, including new menu items) ... */ console.log("Applying language:",lang);document.documentElement.lang=lang;if(lang==='ar'){document.body.dir='rtl';if(document.getElementById('welcomeName'))document.getElementById('welcomeName').textContent="مستخدم";if(document.querySelector('[data-feature="dashboard"] span'))document.querySelector('[data-feature="dashboard"] span').textContent="لوحة التحكم";/*...*/if(document.querySelector('[data-feature="innovation-hub"] span'))document.querySelector('[data-feature="innovation-hub"] span').textContent="مركز الابتكار";if(document.querySelector('[data-feature="data-management"] span'))document.querySelector('[data-feature="data-management"] span').textContent="إدارة البيانات";if(document.querySelector('[data-feature="deadline-tracker"] span'))document.querySelector('[data-feature="deadline-tracker"] span').textContent="متتبع المواعيد";}else{document.body.dir='ltr';if(document.getElementById('welcomeName')&&currentUser)document.getElementById('welcomeName').textContent=currentUser.name.split(' ')[0];if(document.querySelector('[data-feature="dashboard"] span'))document.querySelector('[data-feature="dashboard"] span').textContent="Dashboard";/*...*/if(document.querySelector('[data-feature="innovation-hub"] span'))document.querySelector('[data-feature="innovation-hub"] span').textContent="Innovation Hub";if(document.querySelector('[data-feature="data-management"] span'))document.querySelector('[data-feature="data-management"] span').textContent="Data Management";if(document.querySelector('[data-feature="deadline-tracker"] span'))document.querySelector('[data-feature="deadline-tracker"] span').textContent="Deadline Tracker";}localStorage.setItem('language',lang);}
            function applyDateTimeFormat(timeFormat, dateFormat) { /* ... (Same as before, added project tracking refresh) ... */ console.log("Applying DateTime Format:",timeFormat,dateFormat);localStorage.setItem('timeFormat',timeFormat);localStorage.setItem('dateFormat',dateFormat);if(currentFeature==='dashboard'&&activityList.children.length>0&&activities.length>0){loadRecentActivities(showingAllActivities);}if(currentFeature==='dashboard'&&notifications.length>0){renderNotifications();}if(currentFeature==='employee-scheduling'){const scheduleTableBody=document.getElementById('scheduleTableBody');if(scheduleTableBody){renderSchedule(currentScheduleWeekOffset);}}if(currentFeature==='projects'){const container=document.getElementById('featureSectionsContainer');if(container&&container.classList.contains('projects-feature')){renderProjects(container.querySelector('#projects-section'));}}if(currentFeature==='file-sharing'||currentFeature==='project-tracking'){const container=document.getElementById('featureSectionsContainer');if(container.classList.contains('file-sharing-feature')){const fsInstance=window.fileSharingInstance;fsInstance?.updateRelativeTimes();}if(container.classList.contains('project-tracking-feature')){const ptInstance=window.projectTrackingInstance;if(typeof ptInstance?.applyFiltersAndSort==='function'){ptInstance.applyFiltersAndSort();}else{console.warn("Project tracking refresh function not found");}}}}
            function applyToastPreference(enabled) { /* ... (Same as before) ... */ console.log("Applying toast preference:",enabled);showToasts=enabled;localStorage.setItem('showToasts',enabled);}
            function applySoundPreference(enabled) { /* ... (Same as before) ... */ console.log("Applying sound preference:",enabled);playSounds=enabled;localStorage.setItem('playSounds',enabled);}

            // --- Navigation & Content Loading ---
            function setActiveFeature(featureId, settingsTab = null, skipHistory = false) { /* ... (Refactored logic) ... */
                 console.log(`Navigating to: ${featureId}`+(settingsTab?` / Tab: ${settingsTab}`:''));
                 removeInjectedStyles();if(typeof currentFeatureCleanup==='function'){try{currentFeatureCleanup();}catch(e){console.error("Error during feature cleanup:",e);}currentFeatureCleanup=null;}
                 currentFeature=featureId;
                 menuItems.forEach(item=>{item.classList.toggle('active',item.getAttribute('data-feature')===featureId);});
                 contentSections.forEach(section=>section.classList.remove('active'));
                 featureSectionsContainer.className='content-section';featureSectionsContainer.innerHTML='';featureSectionsContainer.dataset.featureId='';featurePlaceholder.style.display='flex';featureLoadingEl.style.display='none';featureErrorEl.style.display='none';featureSectionsContainer.appendChild(featurePlaceholder);
                 let targetSection=null;let isFeatureSection=false;
                 if(featureId==='dashboard'){targetSection=dashboardContent;backButton.style.display='none';}
                 else if(featureId==='profile'){targetSection=profileContent;backButton.style.display='flex';backButtonText.textContent='Back to Dashboard';updateProfileForm();}
                 else if(featureId==='settings'){targetSection=settingsContent;backButton.style.display='flex';backButtonText.textContent='Back to Dashboard';currentSettingsTab=settingsTab||(currentUser.role==='admin'?'preferences':'preferences');if(currentUser.role!=='admin'&&(currentSettingsTab==='team'||currentSettingsTab==='danger')){currentSettingsTab='preferences';}activateSettingsTab(currentSettingsTab);update2FA_UI();}
                 else{isFeatureSection=true;targetSection=featureSectionsContainer;targetSection.dataset.featureId = featureId; /* Store ID for JS */ backButton.style.display='flex';backButtonText.textContent='Back to Dashboard';loadFeatureContent(featureId);}
                 if(targetSection){targetSection.classList.add('active');}
                 if(isFeatureSection){}else{featurePlaceholder.style.display='none';}
                 if(window.innerWidth<=992&&sidebar.classList.contains('active')){sidebar.classList.remove('active');mainContent.classList.remove('sidebar-active');if(closeSidebar)closeSidebar.style.display='none';}
                 userDropdown.classList.remove('active');userDropdownOpen=false;
                 if(!skipHistory){updateBrowserHistory(featureId,featureId==='settings'?currentSettingsTab:null);}window.scrollTo(0,0);
            }
            function activateSettingsTab(tabId) { /* ... (Same as before) ... */ console.log(`Activating settings tab: ${tabId}`);currentSettingsTab=tabId;document.querySelectorAll('.settings-tab').forEach(tab=>tab.classList.toggle('active',tab.getAttribute('data-tab')===tabId));document.querySelectorAll('.settings-panel').forEach(panel=>panel.classList.toggle('active',panel.id===`${tabId}Panel`));if(tabId==='team'&&currentUser.role==='admin'){loadTeamMembers();}if(tabId==='security'){update2FA_UI();}if(tabId==='account'&&accountEmailDisplay){accountEmailDisplay.value=currentUser.email;} }
            function injectStyles(styleContent, styleId) { /* ... (Same as before) ... */ removeInjectedStyles(styleId);const styleTag=document.createElement('style');styleTag.id=styleId;styleTag.textContent=styleContent;document.head.appendChild(styleTag);console.log(`Styles injected: ${styleId}`);}
            function removeInjectedStyles(styleIdPrefix = 'injected-') { /* ... (Same as before) ... */ const styles=document.querySelectorAll(`style[id^="${styleIdPrefix}"]`);styles.forEach(style=>{style.remove();console.log(`Styles removed: ${style.id}`);});}
            function loadFeatureContent(featureId) { /* ... (Refactored logic) ... */
                 const menuItem = Array.from(menuItems).find(item => item.getAttribute('data-feature') === featureId);
                 const featureName = menuItem ? menuItem.querySelector('span').textContent : 'Feature';
                 const templateIdMap = { /* Added innovation-hub, placeholders for new items */
                     'task-management': 'taskManagementAssets',
                     'file-sharing': 'fileSharingAssets',
                     'project-tracking': 'projectTrackingAssets',
                     'reports-analytics': 'reportsAnalyticsAssets',
                     'team-members-view': 'teamMembersAssets',
                     'projects': 'projectsAssets',
                     'employee-scheduling': 'employeeSchedulingAssets',
                     'innovation-hub': 'innovationHubAssets',
                     'team-calendar': 'placeholderAssets',
                     'data-management': 'placeholderAssets',
                     'deadline-tracker': 'placeholderAssets',
                 };
                 const templateId = templateIdMap[featureId] || 'placeholderAssets';

                 featurePlaceholder.style.display = 'none';
                 featureLoadingEl.style.display = 'block'; featureErrorEl.style.display = 'none';
                 featureSectionsContainer.innerHTML = ''; // Clear previous
                 featureSectionsContainer.className = `content-section active ${featureId}-feature`; // Add feature class
                 featureSectionsContainer.appendChild(featurePlaceholder); featurePlaceholder.style.display = 'flex';
                 featureTitleEl.textContent = ''; featureDescEl.textContent = '';
                 console.log(`Loading content for: ${featureName} (${featureId}) from template: ${templateId}`);

                 setTimeout(() => {
                     try {
                         featureLoadingEl.style.display = 'none'; featurePlaceholder.style.display = 'none';
                         featureSectionsContainer.innerHTML = ''; // Clear loading

                         const template = document.getElementById(templateId);
                         if (!template) { throw new Error(`Template not found: ${templateId}`); }

                         const templateContent = template.content.cloneNode(true);

                         // Inject Styles if they exist in template
                         const styleElement = templateContent.querySelector('style');
                         if (styleElement) { injectStyles(styleElement.textContent, `injected-${featureId}-styles`); styleElement.remove(); }

                         // Inject HTML Content
                         while (templateContent.firstChild) { featureSectionsContainer.appendChild(templateContent.firstChild); }

                         // Initialize JS
                         const initFunctionNameMap = { /* Added innovation-hub, placeholders */
                             'task-management': 'initializeTaskManagementFeature',
                             'file-sharing': 'initializeFileSharingFeature',
                             'project-tracking': 'initializeProjectTrackingFeature',
                             'reports-analytics': 'initializeReportsAnalyticsFeature',
                             'team-members-view': 'initializeTeamMembersFeature',
                             'projects': 'initializeProjectsFeature',
                             'employee-scheduling': 'initializeEmployeeScheduleLogic',
                             'innovation-hub': 'initializeInnovationHubFeature',
                             'team-calendar': 'initializePlaceholderFeature',
                             'data-management': 'initializePlaceholderFeature',
                             'deadline-tracker': 'initializePlaceholderFeature',
                         };
                         const initFunctionName = initFunctionNameMap[featureId];

                         if (initFunctionName && typeof window[initFunctionName] === 'function') {
                             const result = window[initFunctionName](featureSectionsContainer); // Pass the container
                             currentFeatureCleanup = result?.cleanup;
                             console.log(`${featureName} JS initialized.`);
                         } else if (initFunctionName) {
                             console.error(`Initialization function ${initFunctionName} not found.`);
                         } else {
                             console.warn(`No specific JS init function mapped for ${featureId}.`);
                         }

                     } catch (error) {
                         console.error(`Error loading feature ${featureId}:`, error);
                         featureLoadingEl.style.display = 'none'; featurePlaceholder.style.display = 'flex';
                         featureErrorEl.textContent = `Failed to load ${featureName}. Error: ${error.message}`; featureErrorEl.style.display = 'block';
                         featureSectionsContainer.innerHTML = ''; // Clear failed load attempt
                         featureSectionsContainer.appendChild(featurePlaceholder);
                     }
                 }, 150);
             }
            function updateBrowserHistory(featureId, settingsTab = null) { /* ... (Same as before) ... */ let hash=`#${featureId}`;if(featureId==='settings'&&settingsTab){hash+=`-${settingsTab}`;}if(window.location.hash!==hash){window.history.pushState({feature:featureId,tab:settingsTab},'',hash);}}
            function handleInitialNavigation() { /* ... (Same as before) ... */ const hash=window.location.hash.substring(1);console.log(`Handling navigation for hash: ${hash}`);let featureId='dashboard';let settingsTab=null;if(hash){if(hash.startsWith('settings-')){const parts=hash.split('-');featureId=parts[0];settingsTab=parts[1];}else{const knownFeature=Array.from(menuItems).some(item=>item.getAttribute('data-feature')===hash);if(knownFeature){featureId=hash;}}}setActiveFeature(featureId,settingsTab,true);}
            window.addEventListener('popstate', function(event) { /* ... (Same as before) ... */ console.log("Popstate event:",event.state,window.location.hash);handleInitialNavigation();});

            // --- Data Loading & Simulation ---
            function loadInitialData() { /* ... (Same as before) ... */ loadDashboardStats();loadRecentActivities();loadNotifications();if(currentFeature==='settings'&&currentSettingsTab==='team'&&currentUser.role==='admin'){loadTeamMembers();} }
            function loadDashboardStats() { /* ... (Same as before) ... */ console.log("Loading dashboard stats...");setTimeout(()=>{const teamMembersCount=MOCK_USERS.length;const tasksCompleted=MOCK_TASKS.filter(t=>t.status==='Completed').length+Math.floor(Math.random()*50);const activeProjects=MOCK_PROJECTS_DATA.filter(p=>p.status==='active'||p.status==='in-progress').length;const upcomingDeadlines=Math.floor(Math.random()*10);updateStatCard('teamMembersCount','Team Members','fas fa-users',teamMembersCount,Math.random()*10-5);updateStatCard('tasksCompleted','Tasks Completed','fas fa-check-circle',tasksCompleted,Math.random()*20);updateStatCard('activeProjects','Active Projects','fas fa-project-diagram',activeProjects,Math.random()*5-2);updateStatCard('upcomingDeadlines','Upcoming Deadlines','fas fa-calendar-times',upcomingDeadlines,Math.random()*15-10);},300);}
            function updateStatCard(id, title, iconClass, value, trendPercent) { /* ... (Same as before) ... */ const cardIndex=['teamMembersCount','tasksCompleted','activeProjects','upcomingDeadlines'].indexOf(id);if(cardIndex===-1||!statsSection||!statsSection.children[cardIndex])return;const card=statsSection.children[cardIndex];let trendClass='trend-neutral';let trendIcon='fas fa-minus';if(trendPercent>1){trendClass='trend-up';trendIcon='fas fa-arrow-up';}else if(trendPercent<-1){trendClass='trend-down';trendIcon='fas fa-arrow-down';}card.innerHTML=`<div class="stat-title"><i class="${iconClass}"></i>${title}</div><div class="stat-value"><span>${value}</span><span class="stat-trend ${trendClass}"><i class="${trendIcon}"></i> ${trendPercent!==0?Math.abs(trendPercent).toFixed(0)+'%':''}</span></div>`;}
            function loadRecentActivities(showAll = false) { /* ... (Same as before) ... */ console.log("Loading recent activities...");if(activities.length===0||!showingAllActivities){const now=Date.now();activities=generateMockActivities(15,now);}showingAllActivities=showAll;const activitiesToDisplay=showAll?activities:activities.slice(0,maxActivitiesToShow);activityList.innerHTML='';if(activitiesToDisplay.length===0){activityList.innerHTML='<li style="text-align: center; padding: 2rem; color: var(--gray);">No recent activity.</li>';deleteAllActivity.style.display='none';viewAllActivity.style.display='none';return;}activitiesToDisplay.sort((a,b)=>b.timestamp-a.timestamp);activitiesToDisplay.forEach((activity,index)=>{const li=document.createElement('li');li.classList.add('activity-item');li.dataset.id=activity.id;if(activity.isNew){li.classList.add('new-activity');setTimeout(()=>{activity.isNew=false;const currentLi=activityList.querySelector(`[data-id='${activity.id}']`);if(currentLi)currentLi.classList.remove('new-activity');},2500);}li.innerHTML=`<div class="activity-icon"><i class="fas ${activity.icon}"></i></div><div class="activity-content"><div class="activity-message">${activity.message}</div><div class="activity-time" title="${formatFullDateTime(activity.timestamp)}">${timeAgo(activity.timestamp)}</div></div><div class="activity-actions"><i class="fas fa-trash-alt delete-activity" title="Delete Activity"></i></div>`;activityList.appendChild(li);});deleteAllActivity.style.display=activities.length>0?'inline-block':'none';viewAllActivity.textContent=showAll?'Show Less':'Show All';viewAllActivity.style.display=activities.length>maxActivitiesToShow?'inline-block':'none';}
            function loadNotifications() { /* ... (Same as before) ... */ console.log("Loading notifications...");if(notifications.length===0){const now=Date.now();notifications=generateMockNotifications(8,now);}renderNotifications();}
            function renderNotifications() { /* ... (Same as before) ... */ notificationsBody.innerHTML='';const unreadCount=notifications.filter(n=>n.unread).length;if(notifications.length===0){noNotificationsMessage.textContent='You have no notifications.';noNotificationsMessage.style.display='block';notificationBadge.style.display='none';notificationBadge.textContent='0';markAllReadBtn.disabled=true;deleteAllNotificationsBtn.disabled=true;return;}noNotificationsMessage.style.display='none';markAllReadBtn.disabled=unreadCount===0;deleteAllNotificationsBtn.disabled=false;notifications.sort((a,b)=>b.timestamp-a.timestamp);notifications.forEach(notification=>{const div=document.createElement('div');div.classList.add('notification-list-item');div.dataset.id=notification.id;if(notification.unread){div.classList.add('unread');}div.innerHTML=`<div class="notification-icon-wrapper"><i class="fas ${notification.icon}"></i></div><div class="notification-content"><div class="notification-message">${notification.message}</div><div class="notification-time" title="${formatFullDateTime(notification.timestamp)}">${timeAgo(notification.timestamp)}</div></div><i class="fas fa-times delete-notification" title="Delete Notification"></i>`;notificationsBody.appendChild(div);});notificationBadge.textContent=unreadCount;notificationBadge.style.display=unreadCount>0?'flex':'none';}
            function loadTeamMembers(container = settingsContent) { /* ... (Refactored - determines list container based on context) ... */ const teamListContainer=container.id==='settingsContent'?container.querySelector('#teamList'):container.querySelector('#teamListContainerFeature');if(!teamListContainer){console.error("Team list container not found in",container);return;}console.log("Loading team members into:",container.id||container.parentElement.dataset.featureId);teamListContainer.innerHTML='<p style="color: var(--gray);">Loading...</p>';setTimeout(()=>{teamListContainer.innerHTML='';if(MOCK_USERS.length===0){teamListContainer.innerHTML='<p style="color: var(--gray);">No team members found.</p>';return;}MOCK_USERS.sort((a,b)=>a.name.localeCompare(b.name));MOCK_USERS.forEach(member=>{const card=document.createElement('div');card.classList.add('team-member-card');card.dataset.id=member.id;card.dataset.name=member.name;card.dataset.role=member.role;card.dataset.email=member.email;const avatarStyle=member.avatar?`background-image: url('${member.avatar}')`:'';const avatarContent=member.avatar?'':member.initials;if(container.id!=='settingsContent'){card.innerHTML=`<div class="member-info"><h4 class="member-name">${member.name}</h4><p class="member-email">${member.email}</p><span class="member-role role-${member.role}">${formatRole(member.role)}</span></div>`;}else{card.innerHTML=`<div class="member-avatar" style="${avatarStyle}">${avatarContent}</div><div class="member-details"><div class="member-name">${member.name}</div><div class="member-email">${member.email}</div></div><span class="member-role role-${member.role}">${formatRole(member.role)}</span>${currentUser.role==='admin'&&currentUser.id!==member.id?`<div class="member-actions"><button class="btn btn-outline btn-sm edit-member" title="Edit Member"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-danger btn-sm remove-member" title="Remove Member"><i class="fas fa-trash-alt"></i></button></div>`:'<div class="member-actions" style="width: 70px;">&nbsp;</div>'}`; }teamListContainer.appendChild(card);});},300);}

            // --- Dynamic Updates Simulation ---
            function startDynamicUpdates() { /* ... (Same as before) ... */ if(activityIntervalId)clearInterval(activityIntervalId);activityIntervalId=setInterval(()=>{const newActivity=generateMockActivities(1,Date.now())[0];newActivity.isNew=true;activities.unshift(newActivity);if(activities.length>50)activities.pop();activities.sort((a,b)=>b.timestamp-a.timestamp);if(currentFeature==='dashboard'){loadRecentActivities(showingAllActivities);}showToast(`New Activity: ${newActivity.message.substring(0,30)}...`);},Math.random()*10000+10000);if(notificationIntervalId)clearInterval(notificationIntervalId);notificationIntervalId=setInterval(()=>{const newNotification=generateMockNotifications(1,Date.now())[0];newNotification.unread=true;notifications.unshift(newNotification);if(notifications.length>30)notifications.pop();renderNotifications();playNotificationSound();},Math.random()*20000+20000);if(statsIntervalId)clearInterval(statsIntervalId);statsIntervalId=setInterval(loadDashboardStats,30000);if(welcomeBgIntervalId)clearInterval(welcomeBgIntervalId);welcomeBgIntervalId=setInterval(changeWelcomeBackground,15000); }
            function changeWelcomeBackground() { /* ... (Same as before) ... */ const backgrounds=['--welcome-bg-1','--welcome-bg-2','--welcome-bg-3'];const currentBgVar=getComputedStyle(document.documentElement).getPropertyValue('--welcome-bg-current').trim();let currentIndex=backgrounds.indexOf(currentBgVar);if(currentIndex===-1)currentIndex=0;const nextIndex=(currentIndex+1)%backgrounds.length;document.documentElement.style.setProperty('--welcome-bg-current',`var(${backgrounds[nextIndex]})`);}

            // --- Event Listeners ---
            function setupEventListeners() { /* ... (Refactored to handle generic modals and feature container) ... */
                 if (sidebarToggle) { addListener(sidebarToggle, 'click', () => { sidebar.classList.add('active'); mainContent.classList.add('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'block'; }); }
                 if (closeSidebar) { addListener(closeSidebar, 'click', () => { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); closeSidebar.style.display = 'none'; }); }
                 addListener(document, 'click', (event) => { if (window.innerWidth <= 992 && sidebar.classList.contains('active')) { const isClickInsideSidebar = sidebar.contains(event.target); const isClickOnToggler = sidebarToggle && sidebarToggle.contains(event.target); if (!isClickInsideSidebar && !isClickOnToggler) { sidebar.classList.remove('active'); mainContent.classList.remove('sidebar-active'); if(closeSidebar) closeSidebar.style.display = 'none'; } } });
                 menuItems.forEach(item => addListener(item, 'click', function(e) { e.preventDefault(); const featureId = this.getAttribute('data-feature'); setActiveFeature(featureId); }));
                 addListener(document.body, 'click', function(e) { const target = e.target; if (target.closest('.settings-tab') && !target.closest('.settings-tab.active')) { const tabId = target.closest('.settings-tab').getAttribute('data-tab'); activateSettingsTab(tabId); updateBrowserHistory('settings', tabId); } else if (target.closest('.settings-link') && target.closest('.settings-link').dataset.tabTarget) { e.preventDefault(); const tabId = target.closest('.settings-link').dataset.tabTarget; setActiveFeature('settings', tabId); } });
                 addListener(backButton, 'click', function() { setActiveFeature('dashboard'); });
                 addListener(userProfileContainer, 'click', function(e) { if (e.target.closest('.dropdown-item')) { const feature = e.target.closest('.dropdown-item').getAttribute('data-feature'); if (feature) { setActiveFeature(feature); } return; } userDropdownOpen = !userDropdownOpen; userDropdown.classList.toggle('active', userDropdownOpen); });
                 addListener(document, 'click', function(event) { if (userProfileContainer && !userProfileContainer.contains(event.target) && userDropdownOpen) { userDropdown.classList.remove('active'); userDropdownOpen = false; } });
                 addListener(searchInput, 'input', handleSearch); addListener(searchInput, 'focus', handleSearch);
                 addListener(document, 'click', (event) => { if (searchInput && !searchInput.contains(event.target) && searchResultsContainer && !searchResultsContainer.contains(event.target)) { searchResultsContainer.classList.remove('active'); } });
                 addListener(searchResultsContainer, 'click', (event) => { const targetItem = event.target.closest('.search-result-item'); if (targetItem && targetItem.dataset.feature) { const featureId = targetItem.dataset.feature; const itemId = targetItem.dataset.id; console.log(`Search result: Feature=${featureId}, ID=${itemId}`); setActiveFeature(featureId); searchResultsContainer.classList.remove('active'); searchInput.value = ''; } });
                 addListener(notificationIcon, 'click', () => { notificationsModal.classList.add('active'); });
                 addListener(closeNotifications, 'click', () => { notificationsModal.classList.remove('active'); });
                 addListener(notificationsModal, 'click', (event) => { if (event.target === notificationsModal) { notificationsModal.classList.remove('active'); } });
                 addListener(notificationsBody, 'click', (event) => { const target = event.target; const notificationItem = target.closest('.notification-list-item'); const notificationId = notificationItem ? parseInt(notificationItem.dataset.id) : null; if (target.classList.contains('delete-notification') && notificationId) { showConfirmModal('Delete Notification', 'Are you sure?', () => { notifications = notifications.filter(n => n.id !== notificationId); renderNotifications(); showToast('Notification deleted.', 'success'); }); } else if (notificationItem && notificationId) { const notification = notifications.find(n => n.id === notificationId); if (notification && notification.unread) { notification.unread = false; renderNotifications(); } console.log(`Clicked notification ${notificationId}`); } });
                 addListener(markAllReadBtn, 'click', markAllNotificationsAsRead);
                 addListener(deleteAllNotificationsBtn, 'click', () => { if (notifications.length === 0) return; showConfirmModal('Delete All Notifications', 'Are you sure?', () => { notifications = []; renderNotifications(); showToast('All notifications deleted.', 'success'); }); });
                 addListener(activityList, 'click', (event) => { const target = event.target; if (target.classList.contains('delete-activity')) { const activityItem = target.closest('.activity-item'); const activityId = activityItem ? parseInt(activityItem.dataset.id) : null; if (activityId) { activities = activities.filter(a => a.id !== activityId); loadRecentActivities(showingAllActivities); showToast('Activity deleted.'); } } });
                 addListener(viewAllActivity, 'click', () => { loadRecentActivities(!showingAllActivities); });
                 addListener(deleteAllActivity, 'click', () => { if (activities.length === 0) return; showConfirmModal('Delete All Activities', 'Are you sure?', () => { activities = []; loadRecentActivities(false); showToast('All activities deleted.'); }); });
                 addListener(profileAvatarLarge, 'click', () => { profileAvatarInput.click(); });
                 addListener(profileAvatarInput, 'change', handleAvatarUpload);
                 addListener(profileForm, 'submit', handleProfileSave);
                 addListener(cancelProfileBtn, 'click', handleProfileCancel);
                 addListener(firstNameInput, 'input', updateFullNameDisplay);
                 addListener(lastNameInput, 'input', updateFullNameDisplay);
                 addListener(logoutLink, 'click', handleLogout);
                 // Team Management Actions (Settings Panel)
                 const teamListContainer = document.getElementById('teamList');
                 if (teamListContainer) { addListener(teamListContainer, 'click', (event) => { const target = event.target; const memberCard = target.closest('.team-member-card'); const memberId = memberCard ? parseInt(memberCard.dataset.id) : null; if (!memberId || memberId === currentUser.id) return; if (target.closest('.edit-member')) { openMemberModal(memberId); } else if (target.closest('.remove-member')) { handleRemoveMember(memberId); } }); }
                 if (memberForm) { addListener(memberForm, 'submit', handleSaveMember); }
                 if (memberModal) { memberModal.querySelectorAll('[data-close-modal]').forEach(btn => { addListener(btn, 'click', () => memberModal.classList.remove('active')); }); addListener(memberModal, 'click', (event) => { if (event.target === memberModal) { memberModal.classList.remove('active'); } }); }
                 const inviteMemberForm = document.getElementById('inviteMemberForm');
                 if (inviteMemberForm) { addListener(inviteMemberForm, 'submit', handleInviteMember); }
                 const deleteAllNonAdminUsersBtn = document.getElementById('deleteAllNonAdminUsersBtn');
                 if (deleteAllNonAdminUsersBtn) { addListener(deleteAllNonAdminUsersBtn, 'click', handleDeleteAllNonAdminUsers); }
                 // Project Modal Listeners
                 if (projectForm) { addListener(projectForm, 'submit', handleSaveProject); }
                 if (projectModal) { projectModal.querySelectorAll('[data-close-modal]').forEach(btn => { addListener(btn, 'click', () => projectModal.classList.remove('active')); }); addListener(projectModal, 'click', (event) => { if (event.target === projectModal) { projectModal.classList.remove('active'); } }); }
                 // Settings Controls Listeners
                 themeOptions.forEach(option => { addListener(option, 'click', () => setTheme(option.dataset.theme)); });
                 if (highContrastToggle) { addListener(highContrastToggle, 'change', (e) => setContrast(e.target.checked)); }
                 if (languageSelect) { addListener(languageSelect, 'change', (e) => applyLanguage(e.target.value)); }
                 if (regionSelect) { addListener(regionSelect, 'change', (e) => localStorage.setItem('region', e.target.value)); }
                 if (timeFormatSelect || dateFormatSelect) { const applyDateTimeListener = () => { applyDateTimeFormat(timeFormatSelect.value, dateFormatSelect.value); }; if (timeFormatSelect) addListener(timeFormatSelect, 'change', applyDateTimeListener); if (dateFormatSelect) addListener(dateFormatSelect, 'change', applyDateTimeListener); }
                 if (toastToggle) { addListener(toastToggle, 'change', (e) => applyToastPreference(e.target.checked)); }
                 if (soundToggle) { addListener(soundToggle, 'change', (e) => applySoundPreference(e.target.checked)); }
                 if (savePreferencesBtn) addListener(savePreferencesBtn, 'click', handleSavePreferences);
                 if (changePasswordForm) addListener(changePasswordForm, 'submit', handleChangePassword);
                 if (saveAccountSettingsBtn) addListener(saveAccountSettingsBtn, 'click', handleSaveAccountSettings);
                 if (saveSessionSettingsBtn) addListener(saveSessionSettingsBtn, 'click', handleSaveSessionSettings);
                 if (saveNotificationSettingsBtn) addListener(saveNotificationSettingsBtn, 'click', handleSaveNotificationSettings);
                 if (enable2faBtn) addListener(enable2faBtn, 'click', handleEnable2FA);
                 if (setupAuthAppBtn) addListener(setupAuthAppBtn, 'click', showAuthAppSetup);
                 if (setupSmsBtn) addListener(setupSmsBtn, 'click', showSmsSetup);
                 if (verifyAuthCodeBtn) addListener(verifyAuthCodeBtn, 'click', handleVerifyAuthCode);
                 if (sendSmsCodeBtn) addListener(sendSmsCodeBtn, 'click', handleSendSmsCode);
                 if (verifySmsCodeBtn) addListener(verifySmsCodeBtn, 'click', handleVerifySmsCode);
                 if (disable2faBtn) addListener(disable2faBtn, 'click', handleDisable2FA);
                 if (logoutAllDevicesBtn) addListener(logoutAllDevicesBtn, 'click', handleLogoutAllDevices);
                 if (deleteAccountBtn) addListener(deleteAccountBtn, 'click', handleDeleteAccount);
                 addListener(cancelConfirmBtn, 'click', hideConfirmModal);
                 addListener(confirmBtn, 'click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmModal(); });
            }

            // --- Specific Feature Logic ---
            function setupResponsiveSidebar() { /* Handled in setupEventListeners */ }
            function handleSearch() { /* ... (Same as before) ... */ const searchTerm=searchInput.value.trim().toLowerCase();searchResultsContainer.innerHTML='';if(searchTerm.length<2){searchResultsContainer.classList.remove('active');return;}console.log(`Searching for: ${searchTerm}`);const results=[];MOCK_USERS.forEach(user=>{if(user.name.toLowerCase().includes(searchTerm)||user.email.toLowerCase().includes(searchTerm)){results.push({type:'User',id:user.id,name:user.name,description:user.email,icon:'fa-user',feature:'team-members-view'});}});MOCK_PROJECTS_DATA.forEach(project=>{if(project.name.toLowerCase().includes(searchTerm)){results.push({type:'Project',id:project.id,name:project.name,description:`Status: ${project.status}`,icon:'fa-briefcase',feature:'projects'});}});MOCK_TASKS.forEach(task=>{if(task.name.toLowerCase().includes(searchTerm)){const projectName=MOCK_PROJECTS_DATA.find(p=>p.id===task.project)?.name||'Unknown Project';results.push({type:'Task',id:task.id,name:task.name,description:`Project: ${projectName} | Status: ${task.status}`,icon:'fa-tasks',feature:'task-management'});}});menuItems.forEach(item=>{const featureName=item.querySelector('span')?.textContent;const featureId=item.getAttribute('data-feature');if(featureName&&featureId&&featureName.toLowerCase().includes(searchTerm)){if(!results.some(r=>r.feature===featureId&&r.type!=='User'&&r.type!=='Project'&&r.type!=='Task')){results.push({type:'Feature',id:null,name:featureName,description:'Navigate to section',icon:item.querySelector('i')?.className.split(' ')[1]||'fa-compass',feature:featureId});}}});if(results.length>0){results.slice(0,10).forEach(result=>{const item=document.createElement('div');item.classList.add('search-result-item');item.dataset.feature=result.feature;if(result.id)item.dataset.id=result.id;item.innerHTML=`<i class="fas ${result.icon}"></i> <div> <strong>${result.name}</strong> <small>(${result.type})</small><br> <span style="font-size: 0.8em; color: var(--gray);">${result.description}</span> </div>`;searchResultsContainer.appendChild(item);});searchResultsContainer.classList.add('active');}else{searchResultsContainer.innerHTML='<div class="search-result-item" style="text-align: center; color: var(--gray); cursor: default;">No results found.</div>';searchResultsContainer.classList.add('active');}}
            function handleAvatarUpload(event) { /* ... (Same as before) ... */ const file=event.target.files[0];if(file&&file.type.startsWith('image/')){const reader=new FileReader();reader.onload=(e)=>{const imageUrl=e.target.result;profileAvatarLarge.style.backgroundImage=`url(${imageUrl})`;profileAvatarLarge.textContent='';document.getElementById('userAvatar').style.backgroundImage=`url(${imageUrl})`;document.getElementById('userAvatar').textContent='';document.getElementById('profileAvatar').style.backgroundImage=`url(${imageUrl})`;document.getElementById('profileAvatar').textContent='';currentUser.avatar=imageUrl;showToast('Avatar preview updated. Save changes to persist.');};reader.readAsDataURL(file);}else if(file){showToast('Please select a valid image file.','error');}}
            function updateFullNameDisplay() { /* ... (Same as before) ... */ fullNameDisplay.value=`${firstNameInput.value.trim()} ${lastNameInput.value.trim()}`.trim(); }
            function handleProfileSave(event) { /* ... (Same as before) ... */ event.preventDefault();console.log("Saving profile...");showConfirmModal('Save Profile Changes','Are you sure?',()=>{console.log("Profile save confirmed.");const saveButtonText=saveProfileBtn.querySelector('.btn-text');const spinner=saveProfileBtn.querySelector('.spinner');saveProfileBtn.disabled=true;if(saveButtonText)saveButtonText.textContent='Saving...';if(spinner)spinner.style.display='inline-block';setTimeout(()=>{currentUser.name=fullNameDisplay.value;currentUser.title=jobTitleInput.value;currentUser.phone=phoneInput.value;currentUser.department=departmentInput.value;if(!currentUser.avatar){const nameParts=currentUser.name.split(' ');currentUser.initials=(nameParts[0]?.[0]||'')+(nameParts[1]?.[0]||'');}userPhoneNumberForSms.textContent=currentUser.phone||'Not Available';updateUserUI();saveProfileBtn.disabled=false;if(saveButtonText)saveButtonText.textContent='Save Changes';if(spinner)spinner.style.display='none';showSuccessMessage('Profile updated successfully!');},1000);},'btn-primary');}
            function handleProfileCancel() { /* ... (Same as before) ... */ showConfirmModal('Cancel Changes','Discard changes?',()=>{updateProfileForm();showToast('Changes discarded.');},'btn-warning');}
            function handleSavePreferences() { /* ... (Same as before) ... */ showConfirmModal('Save Preferences','Save Appearance/Localization?',()=>{console.log("Saving Preferences...");showToast('Preferences saved (simulated).','success');},'btn-primary');}
            function handleSaveAccountSettings() { /* ... (Same as before) ... */ showConfirmModal('Save Account Settings','Save notification settings?',()=>{console.log("Saving Account Settings...");const enableNotifications=document.getElementById('accountNotificationsToggle').checked;console.log("Account Notifications Enabled:",enableNotifications);showToast('Account settings saved (simulated).','success');},'btn-primary');}
            function handleChangePassword(event) { /* ... (Same as before) ... */ event.preventDefault();showConfirmModal('Change Password','Are you sure you want to attempt to change your password?',()=>{console.log("Changing password...");const currentPass=document.getElementById('currentPassword').value;const newPass=document.getElementById('newPassword').value;const confirmPass=document.getElementById('confirmPassword').value;if(!currentPass||!newPass||!confirmPass){showToast('Please fill in all password fields.','error');return;}if(newPass!==confirmPass){showToast('New passwords do not match.','error');return;}if(newPass.length<8){showToast('New password must be at least 8 characters.','error');return;}showToast('Attempting password change...','info');setTimeout(()=>{const success=Math.random()>0.2;if(success){showSuccessMessage('Password changed successfully!');document.getElementById('currentPassword').value='';document.getElementById('newPassword').value='';document.getElementById('confirmPassword').value='';}else{showToast('Password change failed. Incorrect current password?','error');}},1500);},'btn-danger');}
            function handleSaveSessionSettings() { /* ... (Same as before) ... */ showConfirmModal('Save Session Settings','Save session duration and idle timeout?',()=>{console.log("Saving Session Settings...");const sessionDuration=document.getElementById('sessionDuration').value;const idleTimeout=document.getElementById('idleTimeout').value;console.log("Session Duration:",sessionDuration,"Idle Timeout:",idleTimeout);showToast('Session settings saved (simulated).','success');},'btn-primary');}
            function handleSaveNotificationSettings() { /* ... (Same as before) ... */ showConfirmModal('Save Notification Settings','Save notification delivery/types?',()=>{console.log("Saving Notification Settings...");const emailEnabled=document.getElementById('emailNotificationsToggle').checked;const inAppEnabled=document.getElementById('inAppNotificationsToggle').checked;const pushEnabled=document.getElementById('pushNotificationsToggle').checked;const selectedTypes=Array.from(document.querySelectorAll('input[name="notificationType"]:checked')).map(cb=>cb.value);console.log("Email:",emailEnabled,"InApp:",inAppEnabled,"Types:",selectedTypes);showToast('Notification settings saved (simulated).','success');},'btn-primary');}
            function update2FA_UI() { /* ... (Same as before) ... */ if(!currentUser||!twoFaStatusIndicator||!twoFaStatusText||!twoFaSetupSection||!twoFaManagementSection)return;const isEnabled=currentUser.twoFaEnabled;twoFaStatusIndicator.style.backgroundColor=isEnabled?'var(--success)':'var(--gray)';twoFaStatusText.textContent=`2FA is currently ${isEnabled?'Enabled':'Disabled'}`;twoFaSetupSection.style.display=isEnabled?'none':'block';twoFaManagementSection.style.display=isEnabled?'block':'none';if(twoFaSetupOptions)twoFaSetupOptions.style.display='none';if(authAppSetup)authAppSetup.style.display='none';if(smsSetup)smsSetup.style.display='none';}
            function handleEnable2FA() { /* ... (Same as before) ... */ if(twoFaSetupOptions)twoFaSetupOptions.style.display='block';if(enable2faBtn)enable2faBtn.style.display='none';}
            function showAuthAppSetup() { /* ... (Same as before) ... */ if(authAppSetup)authAppSetup.style.display='block';if(smsSetup)smsSetup.style.display='none';}
            function showSmsSetup() { /* ... (Same as before) ... */ if(authAppSetup)authAppSetup.style.display='none';if(smsSetup)smsSetup.style.display='block';if(smsCodeInputGroup)smsCodeInputGroup.style.display='none';if(verifySmsCodeBtn)verifySmsCodeBtn.style.display='none';}
            function handleVerifyAuthCode() { /* ... (Same as before) ... */ const authCodeInput=document.getElementById('authCode');if(!authCodeInput)return;const code=authCodeInput.value;if(code&&code.length===6&&/^\d+$/.test(code)){showToast('Verifying code...','info');setTimeout(()=>{currentUser.twoFaEnabled=true;update2FA_UI();showToast('2FA enabled via Authenticator App!','success');},1000);}else{showToast('Invalid code. Please enter 6 digits.','error');}}
            function handleSendSmsCode() { /* ... (Same as before) ... */ showToast('Sending SMS code...','info');setTimeout(()=>{showToast('SMS code sent (simulated).','success');if(smsCodeInputGroup)smsCodeInputGroup.style.display='block';if(verifySmsCodeBtn)verifySmsCodeBtn.style.display='inline-flex';},1500);}
            function handleVerifySmsCode() { /* ... (Same as before) ... */ const smsCodeInput=document.getElementById('smsCode');if(!smsCodeInput)return;const code=smsCodeInput.value;if(code&&code.length===6&&/^\d+$/.test(code)){showToast('Verifying SMS code...','info');setTimeout(()=>{currentUser.twoFaEnabled=true;update2FA_UI();showToast('2FA enabled via SMS!','success');},1000);}else{showToast('Invalid SMS code. Please enter 6 digits.','error');}}
            function handleDisable2FA() { /* ... (Same as before) ... */ showConfirmModal('Disable 2FA','Are you sure? This reduces security.',()=>{currentUser.twoFaEnabled=false;update2FA_UI();if(enable2faBtn)enable2faBtn.style.display='inline-flex';showToast('2FA disabled.');},'btn-danger');}
            function handleLogoutAllDevices() { /* ... (Same as before) ... */ showConfirmModal('Logout From All Devices','End all other sessions?',()=>{showToast('Logging out from other devices...','info');setTimeout(()=>{showSuccessMessage('Logged out from other devices.');},1500);},'btn-warning');}
            function handleDeleteAccount() { /* ... (Same as before) ... */ showConfirmModal('Delete Account','IRREVERSIBLE! Delete all data?',()=>{showConfirmModal('Final Confirmation','Are you absolutely sure?',()=>{console.warn("Account Deletion Confirmed (Simulated)");showToast('Deleting account...','error');setTimeout(()=>{alert("Account Deleted (Simulated). Redirecting...");handleLogout(new Event('click'));},2000);},'btn-danger');},'btn-danger');}
            function markAllNotificationsAsRead() { /* ... (Same as before) ... */ if(notifications.some(n=>n.unread)){notifications.forEach(n=>n.unread=false);renderNotifications();showToast('All notifications marked as read.');}}
            function playNotificationSound() { /* ... (Same as before) ... */ if(!playSounds)return;try{if(notificationSound&&notificationSound.paused){notificationSound.play().catch(e=>console.warn("Audio play failed:",e));}}catch(e){console.warn("Audio error:",e);}}
            function handleLogout(event) { /* ... (Same as before) ... */ event.preventDefault();showConfirmModal('Confirm Logout','Are you sure?',()=>{console.log("Logging out...");clearInterval(activityIntervalId);clearInterval(notificationIntervalId);clearInterval(statsIntervalId);clearInterval(welcomeBgIntervalId);showSuccessMessage('Logout successful! Redirecting...');setTimeout(()=>{window.location.href='login.html';},1500);},'btn-danger');}
            function handleInviteMember(event) { /* ... (Same as before) ... */ event.preventDefault();const emailInput=document.getElementById('inviteEmail');const roleInput=document.getElementById('inviteRole');const email=emailInput?emailInput.value:null;const role=roleInput?roleInput.value:null;const inviteButton=event.target.querySelector('button[type="submit"]');if(!email||!role||!/\S+@\S+\.\S+/.test(email)){showToast('Please provide a valid email and role.','error');return;}if(MOCK_USERS.some(user=>user.email.toLowerCase()===email.toLowerCase())){showToast('A user with this email already exists.','error');return;}console.log(`Inviting ${email} as ${role}`);if(inviteButton){inviteButton.disabled=true;inviteButton.innerHTML='<span class="spinner"></span> Sending...';}setTimeout(()=>{const newId=MOCK_USERS.length>0?Math.max(...MOCK_USERS.map(u=>u.id))+1:1;const nameParts=email.split('@')[0].split('.').map(part=>part.charAt(0).toUpperCase()+part.slice(1));const newUser={id:newId,name:nameParts.join(' ')||'New User',email:email,title:formatRole(role),department:'Pending',phone:'',avatar:'',initials:(nameParts[0]?.[0]||'N')+(nameParts[1]?.[0]||'U'),role:role,twoFaEnabled:false};MOCK_USERS.push(newUser);loadTeamMembers();loadDashboardStats();if(currentFeature==='team-members-view'){loadTeamMembers(featureSectionsContainer);}showToast(`Invitation sent to ${email}.`,'success');if(inviteButton){inviteButton.disabled=false;inviteButton.innerHTML='Invite';}if(emailInput)emailInput.value='';if(roleInput)roleInput.value='member';},1000);}
            function openMemberModal(memberId = null) { /* ... (Same as before) ... */ const isEditing=memberId!==null;const member=isEditing?MOCK_USERS.find(u=>u.id===memberId):null;if(isEditing&&!member){showToast("Error: Member not found.","error");return;}memberForm.reset();document.getElementById('memberId').value=isEditing?member.id:'';document.getElementById('memberEmail').readOnly=isEditing;if(isEditing){const nameParts=member.name.split(' ');document.getElementById('memberFirstName').value=nameParts[0]||'';document.getElementById('memberLastName').value=nameParts.slice(1).join(' ')||'';document.getElementById('memberEmail').value=member.email;document.getElementById('memberRole').value=member.role;document.getElementById('memberTitle').value=member.title||'';document.getElementById('memberDepartment').value=member.department||'';memberModalTitle.textContent=`Edit ${member.name}`;saveMemberBtn.textContent='Save Changes';}else{memberModalTitle.textContent=`Add New Member`;saveMemberBtn.textContent='Add Member';document.getElementById('memberEmail').readOnly=false;}memberModal.classList.add('active');}
            function handleSaveMember(event) { /* ... (Same as before) ... */ event.preventDefault();const memberId=document.getElementById('memberId').value?parseInt(document.getElementById('memberId').value):null;const firstName=document.getElementById('memberFirstName').value.trim();const lastName=document.getElementById('memberLastName').value.trim();const email=document.getElementById('memberEmail').value.trim();const role=document.getElementById('memberRole').value;const title=document.getElementById('memberTitle').value.trim();const department=document.getElementById('memberDepartment').value.trim();const isEditing=memberId!==null;if(!firstName||!lastName||!email||!role){showToast('Please fill in First Name, Last Name, Email, and Role.','error');return;}if(!/\S+@\S+\.\S+/.test(email)){showToast('Please enter a valid email address.','error');return;}if(!isEditing&&MOCK_USERS.some(user=>user.email.toLowerCase()===email.toLowerCase())){showToast('A user with this email already exists.','error');return;}const memberData={id:isEditing?memberId:Date.now(),name:`${firstName} ${lastName}`,email:email,role:role,title:title,department:department,phone:isEditing?MOCK_USERS.find(u=>u.id===memberId)?.phone||'':'',avatar:isEditing?MOCK_USERS.find(u=>u.id===memberId)?.avatar||'':'',initials:(firstName?.[0]||'')+(lastName?.[0]||''),twoFaEnabled:isEditing?MOCK_USERS.find(u=>u.id===memberId)?.twoFaEnabled||false:false};if(!memberData.avatar){memberData.initials=(firstName?.[0]||'')+(lastName?.[0]||'');}console.log(`${isEditing?'Saving':'Adding'} member:`,memberData);showToast(`${isEditing?'Saving':'Adding'} member...`,'info');setTimeout(()=>{if(isEditing){const memberIndex=MOCK_USERS.findIndex(u=>u.id===memberId);if(memberIndex>-1){MOCK_USERS[memberIndex]=memberData;if(currentUser&&currentUser.id===memberId){currentUser={...memberData};updateUserUI();}}else{console.error("Error finding member to edit");}}else{MOCK_USERS.push(memberData);}loadTeamMembers();if(currentFeature==='team-members-view'){loadTeamMembers(featureSectionsContainer);}loadDashboardStats();showToast(`Member ${isEditing?'updated':'added'} successfully!`,'success');memberModal.classList.remove('active');},1000);}
            function handleRemoveMember(memberId) { /* ... (Same as before) ... */ const memberToRemove=MOCK_USERS.find(u=>u.id===memberId);showConfirmModal('Remove Team Member',`Are you sure you want to remove ${memberToRemove?.name||'this member'}?`,()=>{showToast(`Removing ${memberToRemove?.name||'member'}...`,'info');setTimeout(()=>{MOCK_USERS=MOCK_USERS.filter(u=>u.id!==memberId);loadTeamMembers();if(currentFeature==='team-members-view'){loadTeamMembers(featureSectionsContainer);}loadDashboardStats();if(currentFeature==='employee-scheduling'){const scheduleTableBody=document.getElementById('scheduleTableBody');if(scheduleTableBody){renderSchedule(currentScheduleWeekOffset);}}showToast('Team member removed.','success');},500);},'btn-danger');}
            function handleDeleteAllNonAdminUsers() { /* ... (Same as before) ... */ const nonAdminUsers=MOCK_USERS.filter(u=>u.role!=='admin');if(nonAdminUsers.length===0){showToast('No non-admin users to delete.','info');return;}const userCount=nonAdminUsers.length;const userListHTML=nonAdminUsers.slice(0,5).map(u=>`<li>${u.name} (${u.email})</li>`).join('')+(userCount>5?'<li>... and more</li>':'');showConfirmModal(`Delete ${userCount} Non-Admin Users`,`This will permanently delete ${userCount} user(s) who are not administrators, including:<br><ul>${userListHTML}</ul><strong>This action cannot be undone.</strong> Are you sure?`,()=>{showConfirmModal('Final Confirmation',`Really delete all ${userCount} non-admin users?`,()=>{showToast(`Deleting ${userCount} users...`,'warning');setTimeout(()=>{MOCK_USERS=MOCK_USERS.filter(u=>u.role==='admin');loadTeamMembers();if(currentFeature==='team-members-view'){loadTeamMembers(featureSectionsContainer);}loadDashboardStats();showSuccessMessage(`${userCount} non-admin users deleted successfully.`);},1500);},'btn-danger');},'btn-danger');}
            function handleSendReminders() { /* ... (Same as before) ... */ const btn=document.getElementById('sendRemindersBtn');if(!btn)return;btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Sending...';console.log("Sending reminders...");const weekDates=getWeekDates(currentScheduleWeekOffset);const weekStart=formatDateForDisplay(weekDates[0]);const weekEnd=formatDateForDisplay(weekDates[6]);const emailSubject=`Schedule: ${weekStart} - ${weekEnd}`;const emailFooter="\n\nRegards,\nTeam Management System";const fullDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];let emailsSent=0;let emailsFailed=0;MOCK_USERS.forEach((user,index)=>{let userScheduleInfo=`Your schedule:\n`;for(let dayIndex=0;dayIndex<7;dayIndex++){const scheduleKey=`${user.id}-${currentScheduleWeekOffset}-${dayIndex}`;const shiftType=mockScheduleData[scheduleKey]||'off';userScheduleInfo+=`- ${fullDays[dayIndex]} (${formatDateForDisplay(weekDates[dayIndex])}): ${getShiftText(shiftType)}\n`;}const emailBody=`Hi ${user.name.split(' ')[0]},\n\n${userScheduleInfo}${emailFooter}`;console.log(`--- Sending to: ${user.email} ---\nSubject: ${emailSubject}\nBody:\n${emailBody}\n------`);const success=Math.random()>0.1;if(success){emailsSent++;}else{emailsFailed++;}});setTimeout(()=>{if(emailsFailed>0){showToast(`Sent ${emailsSent} reminders. ${emailsFailed} failed.`,"error");}else{showToast(`Sent ${emailsSent} reminders!`,"success");}btn.disabled=false;btn.innerHTML='<i class="fas fa-envelope"></i> Send Reminders';},1500+MOCK_USERS.length*50);}
            function renderProjects(container) { /* ... (Same as before) ... */ const projectsListContainer=container.querySelector('#projectsListContainerFeature');if(!projectsListContainer)return;const searchInput=container.querySelector('#projectSearchInputFeature');const filterSelect=container.querySelector('#projectFilterSelectFeature');const searchTerm=searchInput?searchInput.value.toLowerCase().trim():'';const selectedStatus=filterSelect?filterSelect.value:'all';projectsListContainer.innerHTML='';let projectsToDisplay=MOCK_PROJECTS_DATA.filter(project=>{const statusMatch=(selectedStatus==='all'||project.status===selectedStatus);const searchMatch=(project.name.toLowerCase().includes(searchTerm)||(project.participants||'').toLowerCase().includes(searchTerm)||project.status.toLowerCase().includes(searchTerm));return statusMatch&&searchMatch;});if(projectsToDisplay.length===0){projectsListContainer.innerHTML='<p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">No projects found matching your criteria.</p>';return;}projectsToDisplay.forEach(project=>{const card=document.createElement('div');card.classList.add('project-card');card.dataset.projectId=project.id;card.dataset.status=project.status;card.dataset.participants=project.participants;const participantsHTML=(project.participants||'').split('|').map(p=>p.trim()).filter(p=>p).map(p=>`<span>${p}</span>`).join(' ');const canEdit=project.editable!==false;const canDelete=currentUser.role==='admin';card.innerHTML=`<div class="project-card-image" style="background-image: url('${project.img||'placeholder.jpg'}');"></div><div class="project-card-body"><h3 class="project-name">${project.name}</h3><span class="project-status status-${project.status}">${project.status.replace('-',' ')}</span><div class="progress-bar-container" title="Progress: ${project.progress}%"><div class="progress-bar" style="width: ${project.progress}%;">${project.progress>5?project.progress+'%':''}</div></div><div class="project-info project-participants"><i class="fas fa-users"></i><div class="participant-list">${participantsHTML||'N/A'}</div></div><div class="project-info project-dates"><i class="fas fa-calendar-alt"></i> Started: ${formatDateForDisplay(project.startDate)} | Updated: ${formatDateForDisplay(project.updatedDate)}</div><div class="project-actions"><button class="btn btn-sm btn-outline-primary btn-view" data-project-id="${project.id}"><i class="fas fa-eye"></i> View</button><button class="btn btn-sm btn-outline-warning btn-edit" data-project-id="${project.id}" ${!canEdit?'disabled':''}><i class="fas fa-pencil-alt"></i> Edit</button><button class="btn btn-sm btn-outline-danger btn-delete" data-project-id="${project.id}" ${!canDelete?'disabled':''}><i class="fas fa-trash-alt"></i> Delete</button></div></div>`;projectsListContainer.appendChild(card);});}
            function handleDeleteProject(projectId) { /* ... (Same as before) ... */ const projectToDelete=MOCK_PROJECTS_DATA.find(p=>p.id===projectId);if(!projectToDelete)return;showConfirmModal('Confirm Project Deletion',`Are you sure you want to delete project: "${projectToDelete.name}"? This action cannot be undone.`,()=>{showToast(`Deleting project ${projectToDelete.name}...`,'info');setTimeout(()=>{MOCK_PROJECTS_DATA=MOCK_PROJECTS_DATA.filter(p=>p.id!==projectId);const container=document.getElementById('featureSectionsContainer');if(container&&container.classList.contains('projects-feature')){renderProjects(container.querySelector('#projects-section'));}loadDashboardStats();showToast('Project deleted successfully!','success');},500);},'btn-danger');}
            function openProjectModal(projectId = null) { /* ... (Same as before) ... */ const isEditing=projectId!==null;const project=isEditing?MOCK_PROJECTS_DATA.find(p=>p.id===projectId):null;if(isEditing&&!project){showToast("Error: Project not found.","error");return;}projectForm.reset();document.getElementById('projectId').value=isEditing?project.id:'';if(isEditing){projectModalTitle.textContent=`Edit Project: ${project.name}`;saveProjectBtn.textContent='Save Changes';document.getElementById('projectName').value=project.name;document.getElementById('projectDescription').value=project.description||'';document.getElementById('projectParticipantsInput').value=project.participants||'';document.getElementById('projectImageInput').value=project.img||'';document.getElementById('projectStartDate').value=project.startDate||'';document.getElementById('projectDueDate').value=project.dueDate||'';document.getElementById('projectStatus').value=project.status||'pending';document.getElementById('projectProgress').value=project.progress||0;}else{projectModalTitle.textContent='Add New Project';saveProjectBtn.textContent='Add Project';document.getElementById('projectStatus').value='pending';document.getElementById('projectProgress').value=0;}projectModal.classList.add('active');}
            function handleSaveProject(event) { /* ... (Same as before) ... */ event.preventDefault();const projectId=document.getElementById('projectId').value;const isEditing=projectId!=='';const projectData={id:isEditing?projectId:`proj-${Date.now()}`,name:document.getElementById('projectName').value.trim(),description:document.getElementById('projectDescription').value.trim(),participants:document.getElementById('projectParticipantsInput').value.trim(),img:document.getElementById('projectImageInput').value.trim(),startDate:document.getElementById('projectStartDate').value||null,dueDate:document.getElementById('projectDueDate').value||null,status:document.getElementById('projectStatus').value,progress:parseInt(document.getElementById('projectProgress').value)||0,updatedDate:getCurrentDate(),editable:true};if(!projectData.name){showToast('Project Name is required.','error');return;}console.log(`${isEditing?'Saving':'Adding'} project:`,projectData);showToast(`${isEditing?'Saving':'Adding'} project...`,'info');setTimeout(()=>{if(isEditing){const index=MOCK_PROJECTS_DATA.findIndex(p=>p.id===projectId);if(index>-1){MOCK_PROJECTS_DATA[index]={...MOCK_PROJECTS_DATA[index],...projectData};}else{console.error("Error finding project to edit");MOCK_PROJECTS_DATA.push(projectData);}}else{MOCK_PROJECTS_DATA.push(projectData);}const container=document.getElementById('featureSectionsContainer');if(container&&container.classList.contains('projects-feature')){renderProjects(container.querySelector('#projects-section'));}loadDashboardStats();showToast(`Project ${isEditing?'updated':'added'} successfully!`,'success');projectModal.classList.remove('active');},500);}

            // --- Utility Functions ---
            window.timeAgo = function(timestamp) { /* ... (Same as before) ... */ if(!(timestamp instanceof Date)){const date=new Date(timestamp);if(isNaN(date.getTime()))return '';timestamp=date;}const now=new Date();const secondsPast=(now.getTime()-timestamp.getTime())/1000;if(secondsPast<10){return 'Just now';}if(secondsPast<60){return parseInt(secondsPast)+'s ago';}if(secondsPast<3600){return parseInt(secondsPast/60)+'m ago';}if(secondsPast<3600*24){return parseInt(secondsPast/3600)+'h ago';}return formatDateForDisplay(timestamp);}
            window.formatDateForDisplay = function(date) { /* ... (Same as before) ... */ if(!date) return 'N/A'; if(!(date instanceof Date)){const parsedDate=new Date(date);if(isNaN(parsedDate.getTime()))return 'N/A';date=parsedDate;}const dateFormat=localStorage.getItem('dateFormat')||'MM/DD/YYYY';const year=date.getFullYear();const month=date.getMonth()+1;const day=date.getDate();const monthPadded=String(month).padStart(2,'0');const dayPadded=String(day).padStart(2,'0');const monthName=date.toLocaleDateString(undefined,{month:'short'});try{switch(dateFormat){case 'DD/MM/YYYY':return `${dayPadded}/${monthPadded}/${year}`;case 'YYYY-MM-DD':return `${year}-${monthPadded}-${dayPadded}`;case 'Month D, YYYY':return `${monthName} ${day}, ${year}`;case 'MM/DD/YYYY':default:return `${monthPadded}/${dayPadded}/${year}`;}}catch(e){console.error("Error formatting date:",e);return `${String(month).padStart(2,'0')}/${String(day).padStart(2,'0')}/${year}`;}}
            window.formatFullDateTime = function(date) { /* ... (Same as before) ... */ if(!date) return 'N/A'; if(!(date instanceof Date)){const parsedDate=new Date(date);if(isNaN(parsedDate.getTime()))return 'N/A';date=parsedDate;}const formattedDate=formatDateForDisplay(date);const timeFormat=localStorage.getItem('timeFormat')||'12h';const options={hour:'numeric',minute:'numeric',hour12:timeFormat==='12h'};try{const formattedTime=date.toLocaleTimeString(undefined,options);return `${formattedDate}, ${formattedTime}`;}catch(e){console.error("Error formatting time:",e);return formattedDate;}}
            window.generateMockActivities = function(count, baseTimestampMillis) { /* ... (Same as before) ... */ const nowMillis=baseTimestampMillis||Date.now();const newActivities=[];let users=MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const actions=['updated profile','completed task','added project','commented on task','uploaded file','joined team'];const icons=['fa-user-edit','fa-check-circle','fa-plus-circle','fa-comment','fa-upload','fa-user-plus'];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);const files=['doc.pdf','img.png','sheet.xlsx','pres.pptx'];for(let i=0;i<count;i++){const user=users[Math.floor(Math.random()*users.length)];const actionIndex=Math.floor(Math.random()*actions.length);let message=`${user} ${actions[actionIndex]}`;if(actions[actionIndex].includes('task')&&tasks.length>0){message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;}else if(actions[actionIndex].includes('project')&&projects.length>0){message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;}else if(actions[actionIndex].includes('file')&&files.length>0){message+=` ${files[Math.floor(Math.random()*files.length)]}`;}let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*10;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.5+300000);}timestampMillis=Math.min(timestampMillis,nowMillis);newActivities.push({id:nowMillis+i+Math.floor(Math.random()*1000),icon:icons[actionIndex],message:message,timestamp:new Date(timestampMillis),isNew:false});}return count>1?newActivities.sort((a,b)=>b.timestamp-a.timestamp):newActivities;}
            window.generateMockNotifications = function(count, baseTimestampMillis) { /* ... (Same as before) ... */ const nowMillis=baseTimestampMillis||Date.now();const newNotifications=[];const types=[{msg:'New task assigned:',icon:'fa-tasks',type:'task'},{msg:'Project deadline approaching:',icon:'fa-clock',type:'project'},{msg:'Mentioned you:',icon:'fa-comment-dots',type:'comment'},{msg:'System update:',icon:'fa-info-circle',type:'system'},{msg:'File shared:',icon:'fa-file-alt',type:'file'},];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);let users=MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const files=['report.docx','logo.svg','data.csv'];for(let i=0;i<count;i++){const typeInfo=types[Math.floor(Math.random()*types.length)];let message=typeInfo.msg;if(typeInfo.type==='task'&&tasks.length>0)message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;else if(typeInfo.type==='project'&&projects.length>0)message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;else if(typeInfo.type==='comment'&&users.length>0)message+=` by ${users[Math.floor(Math.random()*users.length)]}`;else if(typeInfo.type==='file'&&files.length>0&&users.length>0)message+=` ${files[Math.floor(Math.random()*files.length)]} by ${users[Math.floor(Math.random()*users.length)]}`;let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*15;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.8+180000);}timestampMillis=Math.min(timestampMillis,nowMillis);newNotifications.push({id:nowMillis+i+10000+Math.floor(Math.random()*1000),icon:typeInfo.icon,message:message,timestamp:new Date(timestampMillis),unread:count===1?true:Math.random()>0.3});}return count>1?newNotifications.sort((a,b)=>b.timestamp-a.timestamp):newNotifications;}
            window.showConfirmModal = function(title, message, onConfirm, buttonClass = 'btn-danger') { /* ... (Same as before) ... */ confirmTitle.textContent=title;confirmMessage.innerHTML=message;confirmCallback=onConfirm;confirmBtn.className='btn';confirmBtn.classList.add(buttonClass);confirmModal.classList.add('active');}
            function hideConfirmModal() { /* ... (Same as before) ... */ confirmModal.classList.remove('active');confirmCallback=null;}
            window.showSuccessMessage = function(message) { /* ... (Same as before) ... */ successMessageText.textContent=message;successMessage.classList.add('show');setTimeout(()=>{successMessage.classList.remove('show');},3000);}
            window.showToast = function(message, type = 'info') { /* ... (Same as before) ... */ if(!showToasts&&type!=='error'){console.log("Toast suppressed:",message);return;}toastMessage.textContent=message;toastMessage.className='toast';if(type==='success'){toastMessage.classList.add('success');}else if(type==='error'){toastMessage.classList.add('error');}toastMessage.classList.add('show');setTimeout(()=>{toastMessage.classList.remove('show');},3000);}
            function getCurrentDate() { return new Date().toISOString().split('T')[0]; }

            // --- Start Application ---
            initDashboard();
        });
    </script>
</body>
</html>

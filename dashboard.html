<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamFlow | Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/fluency/48/000000/group-task.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/fluency/32/000000/group-task.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/fluency/180/000000/group-task.png">
    <link rel="manifest" href="/site.webmanifest"> <!-- Optional: For PWAs -->
    <meta name="theme-color" content="#1e3a8a"> <!-- Theme color for browser UI -->

    <!-- Bootstrap 5 CSS (Needed for Features) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- SweetAlert2 CSS (for File Sharing & Confirmations) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* --- Base Variables --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --primary-light: #dbeafe;
            --secondary: #10b981; /* Used as Success in some features */
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;  /* Default Text Color (Dark in Light Mode) */
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --info: #0dcaf0; /* Bootstrap cyan for info */
            --sidebar-width: 280px;
            --sidebar-bg: #1e3a8a;
            --sidebar-text: rgba(255,255,255,0.9);
            --sidebar-hover: rgba(255,255,255,0.1);
            --sidebar-active: rgba(255,255,255,0.2);
            --sidebar-divider: rgba(255,255,255,0.1);
            --success: #10b981; /* Explicit success */
            --team-manager: #ef4444; /* Keep for role color */
            --compact-padding: 0.5rem;
            --normal-padding: 1rem;
            --spacious-padding: 1.5rem;
            --stat-card-bg-1: linear-gradient(135deg, #e0f2fe, #bae6fd); /* Light Blue */
            --stat-card-bg-2: linear-gradient(135deg, #dcfce7, #bbf7d0); /* Light Green */
            --stat-card-bg-3: linear-gradient(135deg, #fef3c7, #fde68a); /* Light Yellow */
            --stat-card-bg-4: linear-gradient(135deg, #fee2e2, #fecaca); /* Light Red */
            --welcome-bg-1: linear-gradient(135deg, var(--primary-dark), #172554);
            --welcome-bg-2: linear-gradient(135deg, #064e3b, #065f46);
            --welcome-bg-3: linear-gradient(135deg, #4a044e, #6b21a8);
            --welcome-bg-current: var(--welcome-bg-1); /* Default welcome bg */
            --dashboard-header-bg: linear-gradient(90deg, hsla(217, 91%, 60%, 1) 0%, hsla(245, 100%, 70%, 1) 100%); /* Fancy Header Gradient */

            /* High Contrast Variables */
            --hc-text: #000000;
            --hc-background: #ffffff;
            --hc-primary: #0000ff;
            --hc-secondary: #008000;
            --hc-link: #0000ee;
            --hc-border: #000000;

            /* Text Color Variable */
            --text-color: var(--dark);

             /* Schedule specific */
             --schedule-weekend-bg: #f3f4f6;
             --schedule-weekend-text: #9ca3af;
             --shift-morning-bg: #dbeafe; --shift-morning-text: #1e40af; --shift-morning-border: #bfdbfe;
             --shift-afternoon-bg: #e0f2fe; --shift-afternoon-text: #0c4a6e; --shift-afternoon-border: #bae6fd;
             --shift-night-bg: #ede9fe; --shift-night-text: #5b21b6; --shift-night-border: #ddd6fe;
             --shift-off-bg: #f0fdf4; --shift-off-text: #166534; --shift-off-border: #bbf7d0;
             --shift-sick-bg: #fee2e2; --shift-sick-text: #991b1b; --shift-sick-border: #fecaca;
             --shift-vacation-bg: #ffedd5; --shift-vacation-text: #9a3412; --shift-vacation-border: #fed7aa;

            /* --- Team Members Feature Specific Variables --- */
            --feature-team-bg: var(--white); --feature-team-card-bg: var(--white); --feature-team-border-color: var(--light-gray); --feature-team-shadow-color: rgba(0, 0, 0, 0.05); --feature-team-hover-shadow-color: rgba(0, 0, 0, 0.08); --feature-team-text-primary: var(--dark); --feature-team-text-secondary: var(--gray); --feature-team-title-text: var(--dark); --feature-team-title-bg: var(--light); --feature-team-admin-color: var(--danger); --feature-team-supervisor-color: var(--primary); --feature-team-senior-color: var(--success); --feature-team-member-color: var(--gray); --feature-team-card-border-radius: 12px; --feature-team-section-padding: 1.5rem; --feature-team-card-padding: 1.25rem; --feature-team-grid-gap: 1.5rem;

            /* --- Projects Feature Specific Variables --- */
            --feature-projects-body-bg: var(--primary-light); --feature-projects-card-bg: var(--white); --feature-projects-text-color: var(--text-color); --feature-projects-text-muted: var(--gray); --feature-projects-heading-color: var(--primary-dark); --feature-projects-border-color: var(--light-gray); --feature-projects-shadow-color: rgba(0, 0, 0, 0.08); --feature-projects-shadow-hover-color: rgba(0, 0, 0, 0.12); --feature-projects-input-bg: var(--white); --feature-projects-input-border: var(--light-gray); --feature-projects-input-focus-border: var(--primary); --feature-projects-input-focus-shadow: rgba(37, 99, 235, 0.1); --feature-projects-primary-color: var(--primary); --feature-projects-primary-hover: var(--primary-dark); --feature-projects-primary-text: var(--white); --feature-projects-success-bg: #dcfce7; --feature-projects-success-text: #15803d; --feature-projects-success-progress: var(--success); --feature-projects-warning-bg: #fef3c7; --feature-projects-warning-text: #a16207; --feature-projects-warning-progress: var(--warning); --feature-projects-warning-btn-text: var(--dark); --feature-projects-info-bg: #e0f2fe; --feature-projects-info-text: #075985; --feature-projects-info-progress: var(--primary); --feature-projects-secondary-bg: var(--light-gray); --feature-projects-secondary-text: var(--gray); --feature-projects-secondary-progress: var(--gray); --feature-projects-danger-color: var(--danger); --feature-projects-danger-hover: #dc2626; --feature-projects-danger-text: var(--white); --feature-projects-progress-bar-bg: var(--light-gray); --feature-projects-modal-backdrop-bg: rgba(0, 0, 0, 0.5);

            /* --- File Sharing Variables --- */
            --feature-filesharing-primary: var(--primary);
            --feature-filesharing-secondary: var(--gray);
            --feature-filesharing-success: var(--success);
            --feature-filesharing-danger: var(--danger);
            --feature-filesharing-warning: var(--warning);
            --feature-filesharing-info: var(--info);
            --feature-filesharing-light: var(--light);
            --feature-filesharing-dark: var(--dark);
            --feature-filesharing-hover-bg: #eef4ff;
            --feature-filesharing-header-bg: var(--dashboard-header-bg);

            /* --- Project Tracking Variables --- */
            --feature-tracking-primary: var(--primary);
            --feature-tracking-secondary: var(--gray);
            --feature-tracking-success: var(--success);
            --feature-tracking-danger: var(--danger);
            --feature-tracking-warning: var(--warning);
            --feature-tracking-info: var(--info);
            --feature-tracking-purple: #6f42c1; /* Example - can map to existing */
            --feature-tracking-orange: #fd7e14; /* Example - can map to warning */
            --feature-tracking-teal: #20c997;  /* Example - can map to secondary/success */
            --feature-tracking-light: var(--light);
            --feature-tracking-dark: var(--dark);
            --feature-tracking-hover-bg: #eef4ff;
            --feature-tracking-header-bg: var(--dashboard-header-bg);
            --chart-green: #4CAF50; --chart-blue: #2196F3; --chart-orange: #FFC107; --chart-red: #F44336; --chart-gray: #9E9E9E; --chart-purple: #9C27B0; --chart-cyan: #00BCD4;
            --chart-background: #F5F7FA;
            --status-completed-bg: rgba(76, 175, 80, 0.15); --status-completed-text: #388E3C;
            --status-inprogress-bg: rgba(33, 150, 243, 0.15); --status-inprogress-text: #1976D2;
            --status-delayed-bg: rgba(255, 193, 7, 0.15); --status-delayed-text: #FFA000;
            --status-pending-bg: rgba(158, 158, 158, 0.15); --status-pending-text: #616161;
            --priority-high-bg: rgba(244, 67, 54, 0.15); --priority-high-text: #D32F2F;
            --priority-medium-bg: rgba(255, 193, 7, 0.15); --priority-medium-text: #FFA000;
            --priority-low-bg: rgba(76, 175, 80, 0.15); --priority-low-text: #388E3C;

            /* --- Reports & Analytics Variables --- */
            --feature-reports-primary: var(--primary);
            --feature-reports-secondary: var(--gray);
            --feature-reports-success: var(--success);
            --feature-reports-danger: var(--danger);
            --feature-reports-warning: var(--warning);
            --feature-reports-info: var(--info);
            --feature-reports-purple: #6f42c1;
            --feature-reports-orange: #fd7e14;
            --feature-reports-teal: #20c997;
            --feature-reports-light: var(--light);
            --feature-reports-dark: var(--dark);
            --feature-reports-hover-bg: #eef4ff;
            --feature-reports-header-bg: var(--dashboard-header-bg);
            --feature-reports-chart-background: #F5F7FA;
            --feature-reports-chart-fill-opacity: 0.7;
            --feature-reports-chart-radar-fill-opacity: 0.15;
            /* Reusing chart colors from Project Tracking */
        }
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-light); color: var(--text-color); display: flex; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }

        /* --- High Contrast Mode --- */
        body.high-contrast {
             /* ... existing high contrast styles ... */
             --dark: var(--hc-text); --light: var(--hc-background); --gray: var(--hc-text); --light-gray: var(--hc-border); --white: var(--hc-background); --primary: var(--hc-primary); --primary-dark: var(--hc-primary); --primary-light: #e0e0ff; --secondary: var(--hc-secondary); --success: var(--hc-secondary); --warning: #ffa500; --danger: #ff0000; --info: var(--hc-primary);
             --sidebar-bg: var(--hc-background); --sidebar-text: var(--hc-text); --sidebar-hover: #e0e0e0; --sidebar-active: #c0c0c0; --sidebar-divider: var(--hc-border);
             --text-color: var(--hc-text);
             --schedule-weekend-bg: #dddddd; --schedule-weekend-text: var(--hc-text);
             --shift-morning-bg: var(--hc-background); --shift-morning-text: var(--hc-text); --shift-morning-border: var(--hc-border);
             --shift-afternoon-bg: var(--hc-background); --shift-afternoon-text: var(--hc-text); --shift-afternoon-border: var(--hc-border);
             --shift-night-bg: var(--hc-background); --shift-night-text: var(--hc-text); --shift-night-border: var(--hc-border);
             --shift-off-bg: var(--hc-background); --shift-off-text: var(--hc-text); --shift-off-border: var(--hc-border);
             --shift-sick-bg: var(--hc-background); --shift-sick-text: var(--hc-text); --shift-sick-border: var(--hc-border);
             --shift-vacation-bg: var(--hc-background); --shift-vacation-text: var(--hc-text); --shift-vacation-border: var(--hc-border);
             /* Feature Variables HC */
             --feature-team-bg: var(--hc-background); --feature-team-card-bg: var(--hc-background); --feature-team-border-color: var(--hc-border); --feature-team-shadow-color: transparent; --feature-team-hover-shadow-color: transparent; --feature-team-text-primary: var(--hc-text); --feature-team-text-secondary: var(--hc-text); --feature-team-title-text: var(--hc-text); --feature-team-title-bg: var(--hc-background); --feature-team-admin-color: var(--danger); --feature-team-supervisor-color: var(--hc-primary); --feature-team-senior-color: var(--hc-secondary); --feature-team-member-color: var(--hc-text);
             --feature-projects-card-bg: var(--hc-background); --feature-projects-text-color: var(--hc-text); --feature-projects-text-muted: var(--hc-text); --feature-projects-heading-color: var(--hc-text); --feature-projects-border-color: var(--hc-border); --feature-projects-shadow-color: transparent; --feature-projects-shadow-hover-color: transparent; --feature-projects-input-bg: var(--hc-background); --feature-projects-input-border: var(--hc-border); --feature-projects-primary-color: var(--hc-primary); --feature-projects-primary-text: var(--hc-background); --feature-projects-success-bg: var(--hc-background); --feature-projects-success-text: var(--hc-secondary); --feature-projects-success-progress: var(--hc-secondary); --feature-projects-warning-bg: var(--hc-background); --feature-projects-warning-text: var(--hc-text); --feature-projects-warning-progress: var(--warning); --feature-projects-warning-btn-text: var(--hc-text); --feature-projects-info-bg: var(--hc-background); --feature-projects-info-text: var(--hc-primary); --feature-projects-info-progress: var(--hc-primary); --feature-projects-secondary-bg: var(--hc-background); --feature-projects-secondary-text: var(--hc-text); --feature-projects-secondary-progress: var(--hc-text); --feature-projects-danger-color: var(--danger); --feature-projects-danger-text: var(--hc-background); --feature-projects-progress-bar-bg: var(--hc-background);
             /* File Sharing HC */
             --feature-filesharing-primary: var(--hc-primary); --feature-filesharing-secondary: var(--hc-text); --feature-filesharing-success: var(--hc-secondary); --feature-filesharing-danger: var(--danger); --feature-filesharing-warning: var(--warning); --feature-filesharing-info: var(--hc-primary); --feature-filesharing-light: var(--hc-background); --feature-filesharing-dark: var(--hc-text); --feature-filesharing-hover-bg: #e0e0e0; --feature-filesharing-header-bg: var(--hc-primary);
             /* Project Tracking HC */
             --feature-tracking-primary: var(--hc-primary); --feature-tracking-secondary: var(--hc-text); --feature-tracking-success: var(--hc-secondary); --feature-tracking-danger: var(--danger); --feature-tracking-warning: var(--warning); --feature-tracking-info: var(--hc-primary); --feature-tracking-light: var(--hc-background); --feature-tracking-dark: var(--hc-text); --feature-tracking-hover-bg: #e0e0e0; --feature-tracking-header-bg: var(--hc-primary); --chart-background: var(--hc-background);
             --status-completed-bg: transparent; --status-completed-text: var(--hc-secondary); --status-inprogress-bg: transparent; --status-inprogress-text: var(--hc-primary); --status-delayed-bg: transparent; --status-delayed-text: var(--warning); --status-pending-bg: transparent; --status-pending-text: var(--hc-text);
             --priority-high-bg: transparent; --priority-high-text: var(--danger); --priority-medium-bg: transparent; --priority-medium-text: var(--warning); --priority-low-bg: transparent; --priority-low-text: var(--hc-secondary);
             /* Reports HC */
             --feature-reports-primary: var(--hc-primary); --feature-reports-secondary: var(--hc-text); --feature-reports-success: var(--hc-secondary); --feature-reports-danger: var(--danger); --feature-reports-warning: var(--warning); --feature-reports-info: var(--hc-primary); --feature-reports-light: var(--hc-background); --feature-reports-dark: var(--hc-text); --feature-reports-hover-bg: #e0e0e0; --feature-reports-header-bg: var(--hc-primary); --feature-reports-chart-background: var(--hc-background);

             color: var(--text-color);
             background-color: var(--hc-background);
        }
        /* ... other existing HC overrides targeting specific elements ... */
        body.high-contrast .welcome-section,
        body.high-contrast .stat-card,
        body.high-contrast .top-nav,
        body.high-contrast .sidebar,
        body.high-contrast .activity-section,
        body.high-contrast .content-section,
        body.high-contrast #featureSectionsContainer.team-members-feature .team-members-section, /* HC for Team Members */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-member-card,
        body.high-contrast #featureSectionsContainer.projects-feature #projects-section, /* HC for Projects */
        body.high-contrast #featureSectionsContainer.projects-feature .project-card,
        body.high-contrast #featureSectionsContainer.projects-feature .projects-title-wrapper,
        body.high-contrast #featureSectionsContainer.projects-feature .project-controls,
        body.high-contrast #featureSectionsContainer.task-management-feature .task-management-content, /* HC for Tasks */
        body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .card, /* HC for File Sharing */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .filters-section,
        body.high-contrast #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .table,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .card, /* HC for Project Tracking */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-filters-section,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-reminders,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .card, /* HC for Reports */
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-filters-section,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .chart-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table-container,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table {
            background: var(--hc-background) !important; /* Override gradients etc */
            border: 1px solid var(--hc-border) !important;
            color: var(--text-color) !important;
            box-shadow: none !important; /* Remove shadows in HC */
        }
        body.high-contrast .btn,
        body.high-contrast .form-control,
        body.high-contrast .form-select, /* Added form-select */
        body.high-contrast .search-bar input,
        body.high-contrast #settingsContent .member-select-checkbox, /* New HC for checkbox */
        body.high-contrast #featureSectionsContainer.team-members-feature .team-filter input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-search-input,
        body.high-contrast #featureSectionsContainer.projects-feature .project-filter-select,
        body.high-contrast #featureSectionsContainer.task-management-feature #search-input,
        body.high-contrast #featureSectionsContainer.task-management-feature .filters select,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form input,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form textarea,
        body.high-contrast #featureSectionsContainer.task-management-feature #task-form select,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-control, /* HC Inputs for File Sharing */
        body.high-contrast #featureSectionsContainer.file-sharing-feature .form-select,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .form-select, /* HC Inputs for Project Tracking */
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .form-control, /* HC Inputs for Reports */
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group label {
            border: 1px solid var(--hc-border) !important;
            background: var(--hc-background) !important;
            color: var(--text-color) !important;
        }
        body.high-contrast .btn-primary,
        body.high-contrast #featureSectionsContainer.projects-feature .add-project-btn,
        body.high-contrast #featureSectionsContainer.task-management-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.team-members-feature .add-team-member-btn,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-primary,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-primary {
            background-color: var(--hc-primary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important;
        }
        body.high-contrast .btn-danger { background-color: var(--danger) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-warning { background-color: var(--warning) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-success { background-color: var(--hc-secondary) !important; color: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; }
        body.high-contrast .btn-outline,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .btn-outline-secondary, /* HC outline buttons */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .btn-outline-secondary {
             background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important;
        }
        body.high-contrast .btn-outline-danger { background: var(--hc-background) !important; color: var(--danger) !important; border: 1px solid var(--danger) !important;}
        body.high-contrast .btn-outline-success { background: var(--hc-background) !important; color: var(--hc-secondary) !important; border: 1px solid var(--hc-secondary) !important;}
        body.high-contrast .btn-outline-info { background: var(--hc-background) !important; color: var(--hc-primary) !important; border: 1px solid var(--hc-primary) !important;}
        body.high-contrast .logo { color: var(--text-color) !important; }
        body.high-contrast .logo-icon { color: var(--hc-primary) !important; }
        body.high-contrast .menu-item { color: var(--text-color) !important; border-left-color: transparent !important; }
        body.high-contrast .menu-item.active { background-color: #c0c0c0 !important; border-left-color: var(--hc-primary) !important; color: var(--hc-text) !important; }
        body.high-contrast .stat-card { border-left-width: 3px !important; background: var(--hc-background) !important; } /* Reset gradient */
        body.high-contrast .welcome-section { background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important;}
        body.high-contrast .welcome-section .user-info-title { color: var(--hc-text) !important; } /* Reset role color */
        body.high-contrast #featureSectionsContainer.team-members-feature .member-role,
        body.high-contrast #featureSectionsContainer.projects-feature .project-status,
        body.high-contrast #featureSectionsContainer.task-management-feature .status-badge,
        body.high-contrast #featureSectionsContainer.file-sharing-feature .badge, /* HC Badge */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .status-badge, /* HC Tracking Badge */
        body.high-contrast #featureSectionsContainer.project-tracking-feature .priority-badge,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .badge {
            border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important; background: none !important; padding: 3px 8px !important;
        }
        body.high-contrast #featureSectionsContainer.projects-feature .progress-bar,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .progress-bar,
        body.high-contrast #featureSectionsContainer.reports-analytics-feature .progress-bar {
             border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important; background: none !important;
        }
         body.high-contrast #featureSectionsContainer.projects-feature .progress-bar-container,
         body.high-contrast #featureSectionsContainer.project-tracking-feature .progress,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .progress {
             background: var(--hc-background) !important; border: 1px solid var(--hc-border) !important;
         }
        body.high-contrast #featureSectionsContainer.projects-feature .project-participants span,
        body.high-contrast #featureSectionsContainer.project-tracking-feature .assigned-team span {
             border: 1px solid var(--hc-border) !important; color: var(--hc-text) !important; background: none !important;
        }
         body.high-contrast .theme-preview { border: 2px solid var(--hc-border) !important; background: var(--hc-background) !important; /* Override inline styles */ }
         body.high-contrast .theme-option.selected .theme-preview { border-color: var(--hc-primary) !important; }
         body.high-contrast .switch .slider { background-color: #999 !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast .switch input:checked + .slider { background-color: var(--hc-primary) !important; }
         body.high-contrast .switch .slider:before { background-color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table thead th { background: var(--hc-background) !important; color: var(--hc-text) !important; border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .schedule-table tbody td { border: 1px solid var(--hc-border) !important; background: var(--hc-background) !important; /* Override nth-child */ }
         body.high-contrast #featureSectionsContainer.employee-scheduling .employee-name { background: var(--hc-background) !important; border-right: 2px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-name,
         body.high-contrast #featureSectionsContainer.employee-scheduling .day-date { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift { border: 1px solid var(--hc-border) !important; background: none !important; color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.employee-scheduling .shift-weekend-off { border: none !important; font-style: normal !important; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card,
         body.high-contrast #featureSectionsContainer.task-management-feature .modal-content,
         body.high-contrast #featureSectionsContainer.task-management-feature .controls { border: 1px solid var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.task-management-feature .task-card { border-left-width: 3px !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .file-icon { color: var(--hc-text) !important; /* Reset specific icon colors */}
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area { border-color: var(--hc-border) !important; background: var(--hc-background) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--hc-text) !important; }
         body.high-contrast #featureSectionsContainer.file-sharing-feature .fancy-header-title,
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--hc-primary) !important; color: var(--hc-background) !important; }
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-table thead,
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .ra-table thead { background: var(--hc-background) !important; color: var(--hc-text) !important; border-bottom-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.project-tracking-feature .pt-pagination button { background: var(--hc-background) !important; color: var(--hc-text) !important; border-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group .btn-check + label { border-color: var(--hc-border) !important; }
         body.high-contrast #featureSectionsContainer.reports-analytics-feature .btn-group .btn-check:checked + label { background-color: var(--hc-primary) !important; color: var(--hc-background) !important; }
         body.high-contrast canvas { border: 1px dashed var(--hc-border); /* Make charts visible */ }


        /* --- Sidebar Styles --- */
        .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto; transition: all 0.3s; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--sidebar-divider); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--white); display: flex; align-items: center; gap: 0.75rem; text-decoration: none;}
        .logo-icon { color: var(--white); font-size: 1.5rem; }
        .sidebar-menu { padding: 1rem 0; flex-grow: 1; overflow-y: auto; }
        .menu-title { padding: 0.75rem 1.5rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; margin: 0.25rem 0; cursor: pointer;}
        .menu-item:hover { background-color: var(--sidebar-hover); color: var(--white); }
        .menu-item.active { background-color: var(--sidebar-active); color: var(--white); border-left-color: var(--white); font-weight: 600;}
        .menu-item i { margin-right: 0.75rem; font-size: 1.1rem; width: 24px; text-align: center; }
        .menu-divider { height: 1px; background-color: var(--sidebar-divider); margin: 1rem 1.5rem; }
        .connection-status { padding: 0.75rem 1.5rem; margin-top: auto; border-top: 1px solid var(--sidebar-divider); display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; flex-shrink: 0; }
        .connection-status span { color: var(--success); opacity: 0.95; font-weight: 600; /* Make BOLDER */ }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); animation: pulseStatus 2s infinite; }
        @keyframes pulseStatus { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } }

        /* --- Main Content & Top Nav Styles --- */
        .main-content { flex: 1; margin-left: var(--sidebar-width); transition: all 0.3s; }
        .top-nav { background-color: var(--white); padding: var(--normal-padding) 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); position: sticky; top: 0; z-index: 90; transition: padding 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; }
        body.compact .top-nav { padding: var(--compact-padding) 1rem; }
        body.spacious .top-nav { padding: var(--spacious-padding) 2rem; }
        .search-bar { position: relative; width: 400px; }
        .search-bar input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; background-color: var(--white); color: var(--text-color); } /* Use text-color */
        .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-results { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .search-results.active { display: block; animation: fadeInDropdown 0.2s ease-out; }
        .search-result-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; color: var(--text-color); display: flex; align-items: center; gap: 0.75rem; } /* Use text-color */
        .search-result-item i { color: var(--gray); }
        .search-result-item:hover { background-color: var(--primary-light); }
        .user-menu { display: flex; align-items: center; gap: 1.5rem; }
        .notification-icon { position: relative; color: var(--gray); cursor: pointer; font-size: 1.1rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; animation: pulseBadge 1.5s infinite alternate; }
        @keyframes pulseBadge { from { transform: scale(1); } to { transform: scale(1.1); } }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; background-size: cover; background-position: center; }
        .user-profile-details { display: flex; align-items: center; cursor: pointer; }
        .user-name { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .user-status { font-size: 0.8rem; color: var(--success); margin-left: 0.5rem; font-weight: 600; text-shadow: 0 0 4px rgba(16, 185, 129, 0.4); }
        .user-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--white); border: 1px solid var(--light-gray); border-radius: 6px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; display: none; animation: fadeInDropdown 0.2s ease-out; }
        @keyframes fadeInDropdown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .user-dropdown.active { display: block; }
        .dropdown-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; font-size: 0.9rem; } /* Use text-color */
        .dropdown-item:hover { background-color: var(--light); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--gray); }

        /* --- Content Area & Sections Styles --- */
        .content-area { padding: 2rem; min-height: calc(100vh - 70px); transition: padding 0.3s ease; } /* Adjusted height */
        body.compact .content-area { padding: 1rem; }
        body.spacious .content-area { padding: 3rem; }
        .welcome-section {
            background: var(--welcome-bg-current); /* Use variable */
            color: var(--white); /* Welcome section text is white by design */
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding 0.3s ease, margin-bottom 0.3s ease, background 1s ease-in-out; /* Smooth background transition */
        }
        /* ... other existing welcome, stats, activity styles ... */
        body.compact .welcome-section { padding: 1rem; margin-bottom: 1rem; }
        body.spacious .welcome-section { padding: 3rem; margin-bottom: 3rem; }
        .welcome-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: inherit; }
        body.compact .welcome-title { font-size: 1.25rem; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-top: 0.25rem; margin-bottom: 1.5rem; font-weight: 400; color: inherit; }
        body.compact .welcome-subtitle { font-size: 0.9rem; margin-bottom: 1rem;}
        .user-info { display: flex; align-items: center; gap: 1.5rem; margin-top: 1.5rem; }
        body.compact .user-info { flex-direction: column; text-align: center; gap: 1rem; margin-top: 1rem; }
        .user-info-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.75rem; background-size: cover; background-position: center; position: relative; cursor: default; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        body.compact .user-info-avatar { width: 60px; height: 60px; font-size: 1.25rem; }
        .user-info-details { flex: 1; }
        .user-info-name { font-weight: 600; font-size: 1.25rem; margin-bottom: 0.25rem; color: inherit;}
        body.compact .user-info-name { font-size: 1rem; }
        .user-info-title { opacity: 0.9; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--light-gray); font-weight: 600; text-transform: capitalize; }
        .user-info-title.role-admin { color: var(--team-manager); font-weight: 700; text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); }
        .user-info-title.role-supervisor { color: var(--warning); font-weight: 700; }
        .user-info-title.role-senior { color: var(--secondary); font-weight: 700; }
        body.compact .user-info-title { font-size: 0.8rem; }
        .user-info-email { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.9; color: inherit; }
        .user-info-email span { color: inherit; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; transition: gap 0.3s ease, margin-bottom 0.3s ease; }
        body.compact .stats-section { gap: 1rem; margin-bottom: 1rem; }
        body.spacious .stats-section { gap: 2rem; margin-bottom: 3rem; }
        .stat-card {
            background: var(--white); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s, padding 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid var(--primary); /* Colored border */
            color: var(--dark); /* Ensure text inside uses appropriate theme color */
        }
        .stat-card:nth-child(1) { border-left-color: var(--primary); background: var(--stat-card-bg-1); }
        .stat-card:nth-child(2) { border-left-color: var(--secondary); background: var(--stat-card-bg-2); }
        .stat-card:nth-child(3) { border-left-color: var(--warning); background: var(--stat-card-bg-3); }
        .stat-card:nth-child(4) { border-left-color: var(--danger); background: var(--stat-card-bg-4); }

        body.compact .stat-card { padding: 1rem; }
        body.spacious .stat-card { padding: 2rem; }
        .stat-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .stat-title { font-size: 0.9rem; color: var(--text-color); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; } /* Use text-color */
        body.compact .stat-title { font-size: 0.8rem; }
        .stat-title i { opacity: 0.8; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; justify-content: space-between; }
        .stat-card:nth-child(1) .stat-value { color: #1e40af; }
        .stat-card:nth-child(2) .stat-value { color: #15803d; }
        .stat-card:nth-child(3) .stat-value { color: #b45309; }
        .stat-card:nth-child(4) .stat-value { color: #b91c1c; }

        body.compact .stat-value { font-size: 1.5rem; }
        .stat-trend { display: flex; align-items: center; font-size: 0.9rem; font-weight: 500; }
        body.compact .stat-trend { font-size: 0.8rem; }
        .trend-up { color: var(--secondary); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--gray); }
        .activity-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 1.5rem; transition: padding 0.3s ease, background-color 0.3s ease; }
        body.compact .activity-section { padding: 1rem; }
        body.spacious .activity-section { padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 0.5rem; }
        body.compact .section-header { margin-bottom: 1rem; }
        body.spacious .section-header { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-color); } /* Use text-color */
        body.compact .section-title { font-size: 1.1rem; }
        .live-badge { display: inline-flex; align-items: center; background-color: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .section-header > div { display: flex; align-items: center; gap: 1rem;}
        .view-all, .delete-all { font-weight: 500; cursor: pointer; transition: color 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .view-all { color: var(--primary); }
        .view-all:hover { color: var(--primary-dark); text-decoration: underline; background-color: var(--primary-light); }
        .delete-all { color: var(--danger); }
        .delete-all:hover { color: #dc2626; text-decoration: underline; background-color: rgba(239, 68, 68, 0.1); }
        .activity-list { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; } /* Added max-height and scroll */
        .activity-item { display: flex; padding: 1rem 0; border-bottom: 1px solid var(--light-gray); align-items: center; transition: background-color 0.3s, padding 0.3s ease, border-color 0.3s ease; }
        body.compact .activity-item { padding: 0.75rem 0; }
        body.spacious .activity-item { padding: 1.25rem 0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item.new-activity { background-color: rgba(37, 99, 235, 0.08); animation: highlightNewActivity 2.5s ease-out forwards; }
        @keyframes highlightNewActivity { 0% { background-color: rgba(37, 99, 235, 0.15); } 100% { background-color: transparent; } }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background-color: rgba(37, 99, 235, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; }
        body.compact .activity-icon { width: 32px; height: 32px; margin-right: 0.75rem; font-size: 0.9rem; }
        .activity-content { flex: 1; }
        .activity-message { margin-bottom: 0.25rem; color: var(--text-color); } /* Use text-color */
        body.compact .activity-message { font-size: 0.9rem; }
        .activity-time { font-size: 0.8rem; color: var(--gray); }
        body.compact .activity-time { font-size: 0.7rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-left: auto; padding-left: 1rem; }
        .delete-activity { color: var(--danger); cursor: pointer; opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; }
        .activity-item:hover .delete-activity { opacity: 1; }
        .delete-activity:hover { opacity: 1; background-color: rgba(239, 68, 68, 0.1); }

        /* --- Profile & Settings Sections Styles --- */
        .content-section { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; transition: padding 0.3s ease, background-color 0.3s ease; display: none; animation: fadeInContent 0.4s ease-in-out; } /* Hidden by default */
        .content-section.active { display: block; } /* Shown when active */
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body.compact .content-section { padding: 1rem; }
        body.spacious .content-section { padding: 3rem; }
        .section-main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; transition: margin-bottom 0.3s ease; flex-wrap: wrap; gap: 1rem;} /* Added wrap and gap */
        body.compact .section-main-header { margin-bottom: 1.5rem; }
        body.spacious .section-main-header { margin-bottom: 3rem; }
        .section-main-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
        body.compact .section-main-title { font-size: 1.25rem; }
        .profile-header-text { margin-bottom: 2rem; color: var(--gray); font-size: 0.95rem;}
        .profile-avatar-section { text-align: center; margin-bottom: 2rem; }
        #profileAvatarLarge { width: 120px; height: 120px; border-radius: 50%; background-color: var(--primary-light); color: var(--primary-dark); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 3rem; background-size: cover; background-position: center; margin-bottom: 1rem; border: 3px solid var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; position: relative; overflow: hidden; }
        #profileAvatarLarge::after { content: '\f0ee'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; padding: 5px 0; font-size: 1rem; opacity: 0; transition: opacity 0.3s; }
        #profileAvatarLarge:hover::after { opacity: 1; }
        #uploadPhotoButton { display: none; } /* Hide the button, use avatar click */

        .data-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; transition: gap 0.3s ease; }
        body.compact .data-form { gap: 1rem; }
        body.spacious .data-form { gap: 2rem; }
        .form-group { margin-bottom: 1rem; transition: margin-bottom 0.3s ease; }
        body.compact .form-group { margin-bottom: 0.75rem; }
        body.spacious .form-group { margin-bottom: 1.5rem; }
        .form-group label, .settings-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); transition: margin-bottom 0.3s ease, font-size 0.3s ease; } /* Use text-color */
        body.compact .form-group label, body.compact .settings-label { margin-bottom: 0.25rem; font-size: 0.9rem; }
        .form-control, .form-select { /* Added form-select */
            width: 100%; padding: 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 1rem; background-color: var(--white); color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s, padding 0.3s ease, font-size 0.3s ease, background-color 0.3s ease, color 0.3s ease; } /* Use text-color */
        body.compact .form-control, body.compact .form-select { padding: 0.5rem; font-size: 0.9rem; }
        body.spacious .form-control, body.spacious .form-select { padding: 1rem; }
        .form-control:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; opacity: 0.7; }
        .form-actions { grid-column: span 2; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; transition: margin-top 0.3s ease; }
        body.compact .form-actions { margin-top: 0.5rem; }
        body.spacious .form-actions { margin-top: 2rem; }
        /* Ensure features use dashboard button styles */
        .btn,
        #featureSectionsContainer button.btn,
        #featureSectionsContainer .btn-group label.btn {
             padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none; /* For link buttons */ line-height: 1.5; /* Standard line height */ vertical-align: middle; /* Align properly */ }
        body.compact .btn, body.compact #featureSectionsContainer button.btn, body.compact #featureSectionsContainer .btn-group label.btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .btn, body.spacious #featureSectionsContainer button.btn, body.spacious #featureSectionsContainer .btn-group label.btn { padding: 1rem 2rem; }
        .btn-primary, #featureSectionsContainer .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled), #featureSectionsContainer .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-outline, #featureSectionsContainer .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled), #featureSectionsContainer .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        .btn-warning, #featureSectionsContainer .btn-warning { background-color: var(--warning); color: var(--primary-dark); }
        .btn-warning:hover:not(:disabled), #featureSectionsContainer .btn-warning:hover:not(:disabled) { background-color: #d97706; }
        .btn-danger, #featureSectionsContainer .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled), #featureSectionsContainer .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-success, #featureSectionsContainer .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover:not(:disabled), #featureSectionsContainer .btn-success:hover:not(:disabled) { background-color: #0d9f6e; }
        .btn-secondary, #featureSectionsContainer .btn-secondary { background-color: var(--gray); color: white; }
        .btn-secondary:hover:not(:disabled), #featureSectionsContainer .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-info, #featureSectionsContainer .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover:not(:disabled), #featureSectionsContainer .btn-info:hover:not(:disabled) { background-color: #0a9aaf; }

        .btn:disabled, #featureSectionsContainer button.btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm, #featureSectionsContainer .btn-sm { padding: 0.3rem 0.6rem !important; font-size: 0.8rem !important; }
        #featureSectionsContainer .btn-outline-secondary { background-color: transparent; border: 1px solid var(--gray); color: var(--gray); }
        #featureSectionsContainer .btn-outline-secondary:hover:not(:disabled) { background-color: var(--light-gray); }
        #featureSectionsContainer .btn-outline-success { background-color: transparent; border: 1px solid var(--success); color: var(--success); }
        #featureSectionsContainer .btn-outline-success:hover:not(:disabled) { background-color: rgba(16, 185, 129, 0.1); }
        #featureSectionsContainer .btn-outline-danger { background-color: transparent; border: 1px solid var(--danger); color: var(--danger); }
        #featureSectionsContainer .btn-outline-danger:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.1); }
        #featureSectionsContainer .btn-outline-info { background-color: transparent; border: 1px solid var(--info); color: var(--info); }
        #featureSectionsContainer .btn-outline-info:hover:not(:disabled) { background-color: rgba(13, 202, 240, 0.1); }

        .settings-tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 2rem; transition: margin-bottom 0.3s ease, border-color 0.3s ease; overflow-x: auto; }
        body.compact .settings-tabs { margin-bottom: 1.5rem; }
        body.spacious .settings-tabs { margin-bottom: 3rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--gray); transition: all 0.2s; white-space: nowrap; }
        body.compact .settings-tab { padding: 0.5rem 1rem; font-size: 0.9rem; }
        body.spacious .settings-tab { padding: 1rem 2rem; }
        .settings-tab:hover { color: var(--primary); }
        .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600;}
        .settings-tab.disabled { color: var(--light-gray); cursor: not-allowed; pointer-events: none; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; animation: fadeInPanel 0.5s ease-out; }
        @keyframes fadeInPanel { from { opacity: 0; } to { opacity: 1; } }
        /* Settings Sub-section */
        .settings-subsection { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--light-gray); }
        .settings-subsection:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-subsection h4 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 1rem; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap; } /* Added wrap */
        .setting-item > div:first-child { flex-basis: 100%; margin-bottom: 0.5rem; /* Default: Label takes full width */ }
        @media (min-width: 768px) { .setting-item > div:first-child { flex-basis: auto; margin-bottom: 0; } }
        .setting-item-label { font-weight: 500; color: var(--text-color); } /* Use text-color */
        .setting-item-description { font-size: 0.9rem; color: var(--gray); margin-top: 0.25rem;}
        .setting-item-control { flex-shrink: 0; margin-left: 1rem; }
         @media (max-width: 767px) { .setting-item-control { margin-left: 0; width: 100%; margin-top: 0.5rem; } }


        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        body.compact .switch { width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        body.compact .slider:before { height: 14px; width: 14px; left: 3px; bottom: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        body.compact input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .team-management { margin-top: 1.5rem; }
        body.compact .team-management { margin-top: 1rem; }
        body.spacious .team-management { margin-top: 2rem; }
        .team-management h3, .add-member-form h4 { color: var(--text-color); margin-bottom: 1rem; } /* Use text-color */
        .team-list { margin-top: 1rem; }
        body.compact .team-list { margin-top: 0.75rem; }
        body.spacious .team-list { margin-top: 1.5rem; }
        /* --- Settings Panel Team Member Card Style --- */
        #settingsContent .team-member-card { display: flex; align-items: center; padding: 1rem; border: 1px solid var(--light-gray); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; background-color: var(--white); }
        body.compact #settingsContent .team-member-card { padding: 0.75rem; margin-bottom: 0.75rem; }
        body.spacious #settingsContent .team-member-card { padding: 1.25rem; margin-bottom: 1.25rem; }
        #settingsContent .team-member-card:hover { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        #settingsContent .member-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--light-gray); margin-right: 1rem; display: flex; align-items: center; justify-content: center; font-weight: 600; background-size: cover; background-position: center; color: var(--primary-dark); transition: width 0.3s, height 0.3s, margin-right 0.3s, font-size 0.3s; flex-shrink: 0; }
        body.compact #settingsContent .member-avatar { width: 40px; height: 40px; margin-right: 0.75rem; font-size: 0.9rem; }
        #settingsContent .member-details { flex: 1; min-width: 0; }
        #settingsContent .member-name { font-weight: 500; margin-bottom: 0.25rem; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;} /* Use text-color */
        body.compact #settingsContent .member-name { font-size: 0.9rem; }
        #settingsContent .member-email { font-size: 0.9rem; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        body.compact #settingsContent .member-email { font-size: 0.8rem; }
        #settingsContent .member-role { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; margin: 0 1rem; flex-shrink: 0; text-transform: capitalize; }
        body.compact #settingsContent .member-role { font-size: 0.7rem; margin: 0 0.75rem; }
        #settingsContent .role-admin { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
        #settingsContent .role-senior { background-color: rgba(16, 185, 129, 0.1); color: var(--secondary); } /* Changed color to secondary */
        #settingsContent .role-supervisor { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
        #settingsContent .role-member { background-color: rgba(100, 116, 139, 0.1); color: var(--gray); } /* Changed bg/color */
        #settingsContent .member-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        #settingsContent .member-actions .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        #settingsContent .member-select-checkbox { margin-right: 10px; vertical-align: middle; width: 1.1em; height: 1.1em;} /* Style for checkbox */
        #settingsContent .team-management-actions { margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; } /* Admin delete buttons */


        .add-member-form { margin-top: 2rem; padding: 1.5rem; border: 1px dashed var(--light-gray); border-radius: 8px; background-color: var(--light); }
        body.compact .add-member-form { margin-top: 1.5rem; padding: 1rem; }
        body.spacious .add-member-form { margin-top: 3rem; padding: 2rem; }
        .password-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.25rem; display: none; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn .spinner { display: inline-block; /* Make spinner visible when inside button */ }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading span { margin-left: 0.5rem; } /* Space between spinner and text */

        .btn-outline .spinner { border-color: rgba(37, 99, 235, 0.3); border-top-color: var(--primary); }
        .loading-text { display: none; font-size: 0.9rem; color: var(--gray); margin-left: 0.5rem; }

        /* --- Theme Styles & Dark Mode Overrides --- */
        body.light-theme { /* ... existing light theme overrides ... */ --primary-light: #f1f5f9; --light: #ffffff; --white: #ffffff; --dark: #1e293b; --gray: #64748b; --light-gray: #e2e8f0; --text-color: var(--dark); background-color: var(--primary-light); }
        body.dark-theme { /* ... existing dark theme base ... */
             --primary: #3b82f6; --primary-dark: #1e40af; --primary-light: #1e293b; --light: #334155; --white: #0f172a; --dark: #e2e8f0; --gray: #94a3b8; --light-gray: #475569; --text-color: var(--dark);
             --schedule-weekend-bg: #262f3e; --schedule-weekend-text: #6b7280;
             --shift-morning-bg: #1e3a8a; --shift-morning-text: #dbeafe; --shift-morning-border: #2563eb;
             --shift-afternoon-bg: #0e7490; --shift-afternoon-text: #ecfeff; --shift-afternoon-border: #22d3ee;
             --shift-night-bg: #581c87; --shift-night-text: #f3e8ff; --shift-night-border: #a855f7;
             --shift-off-bg: #064e3b; --shift-off-text: #d1fae5; --shift-off-border: #34d399;
             --shift-sick-bg: #881337; --shift-sick-text: #fecdd3; --shift-sick-border: #fb7185;
             --shift-vacation-bg: #7c2d12; --shift-vacation-text: #ffedd5; --shift-vacation-border: #fb923c;
             background-color: var(--white); color: var(--text-color);
            /* Mapped Team Members Dark Theme Variables */
            --feature-team-bg: var(--white); --feature-team-card-bg: var(--light); --feature-team-border-color: var(--light-gray); --feature-team-text-primary: var(--text-color); --feature-team-text-secondary: var(--gray); --feature-team-title-text: var(--text-color); --feature-team-title-bg: var(--light);
            /* Mapped Projects Dark Theme Variables */
            --feature-projects-body-bg: var(--white); --feature-projects-card-bg: var(--light); --feature-projects-text-color: var(--text-color); --feature-projects-text-muted: var(--gray); --feature-projects-heading-color: #a5b4fc; --feature-projects-border-color: var(--light-gray); --feature-projects-input-bg: var(--primary-light); --feature-projects-input-border: var(--light-gray); --feature-projects-success-bg: #14532d; --feature-projects-success-text: #a7f3d0; --feature-projects-success-progress: #4ade80; --feature-projects-warning-bg: #7f5d11; --feature-projects-warning-text: #fef3c7; --feature-projects-warning-progress: #facc15; --feature-projects-warning-btn-text: #1f2937; --feature-projects-info-bg: #1e40af; --feature-projects-info-text: #dbeafe; --feature-projects-info-progress: #60a5fa; --feature-projects-secondary-bg: #4b5563; --feature-projects-secondary-text: #d1d5db; --feature-projects-secondary-progress: var(--gray); --feature-projects-danger-color: #f87171; --feature-projects-danger-hover: #ef4444; --feature-projects-progress-bar-bg: var(--light-gray);
             /* File Sharing Dark */
             --feature-filesharing-light: var(--light); --feature-filesharing-dark: var(--dark); --feature-filesharing-hover-bg: var(--primary-light);
             /* Project Tracking Dark */
             --feature-tracking-light: var(--light); --feature-tracking-dark: var(--dark); --feature-tracking-hover-bg: var(--primary-light); --chart-background: var(--light);
             /* Reports Dark */
             --feature-reports-light: var(--light); --feature-reports-dark: var(--dark); --feature-reports-hover-bg: var(--primary-light); --feature-reports-chart-background: var(--light);
        }
        /* ... other existing dark theme overrides ... */
        body.dark-theme .top-nav { background-color: var(--light); border-bottom-color: var(--light-gray); }
        body.dark-theme .stat-card, body.dark-theme .activity-section, body.dark-theme .content-section, body.dark-theme #settingsContent .team-member-card, body.dark-theme .add-member-form { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-bar input, body.dark-theme .form-control, body.dark-theme .form-select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme .form-control[readonly] { background-color: var(--light); opacity: 0.6; }
        body.dark-theme .search-results { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .search-result-item { color: var(--text-color); }
        body.dark-theme .search-result-item:hover { background-color: var(--primary-light); }
        body.dark-theme .user-dropdown { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme .dropdown-item { color: var(--text-color); }
        body.dark-theme .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notifications-container { background-color: var(--light); }
        body.dark-theme .notification-list-item:hover { background-color: var(--primary-light); }
        body.dark-theme .notification-list-item.unread { background-color: rgba(59, 130, 246, 0.15); }
        body.dark-theme .confirm-container, body.dark-theme .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme .theme-option .theme-preview { border-color: var(--light-gray); background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%); }
        body.dark-theme .theme-option .light-preview { background: var(--light) !important; }
        body.dark-theme .theme-option .dark-preview { background: var(--white) !important; }
        body.dark-theme .theme-option .system-preview { background: linear-gradient(45deg, var(--light) 50%, var(--white) 50%) !important; color: var(--gray);}
        body.dark-theme .theme-option.selected .theme-preview { border-color: var(--primary); }
        body.dark-theme .theme-option .theme-label { color: var(--text-color); }
        body.dark-theme .back-button { color: var(--primary); }
        body.dark-theme .back-button:hover { background-color: var(--light); color: #60a5fa; border-color: var(--primary); }
        body.dark-theme .notifications-footer { background-color: var(--light); border-top-color: var(--light-gray); }
        body.dark-theme .welcome-section { background: var(--welcome-bg-current); color: var(--white); }
        body.dark-theme .welcome-subtitle { color: inherit; opacity: 0.8; }
        body.dark-theme .user-info-name { color: inherit; }
        body.dark-theme .user-info-title { color: var(--gray); }
        body.dark-theme .user-info-title.role-admin { color: var(--team-manager); }
        body.dark-theme .user-info-email span { color: inherit; }
        body.dark-theme .stat-card { background: var(--light); color: var(--text-color);}
        body.dark-theme .stat-title { color: var(--text-color); }
        body.dark-theme .stat-card:nth-child(1) .stat-value { color: #93c5fd; }
        body.dark-theme .stat-card:nth-child(2) .stat-value { color: #86efac; }
        body.dark-theme .stat-card:nth-child(3) .stat-value { color: #fcd34d; }
        body.dark-theme .stat-card:nth-child(4) .stat-value { color: #fca5a5; }
        body.dark-theme .activity-icon { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; }
        body.dark-theme .activity-item { border-bottom-color: var(--light-gray); }
        body.dark-theme .activity-message { color: var(--text-color); }
        body.dark-theme .activity-time { color: var(--gray); }
        body.dark-theme .activity-item.new-activity { background-color: rgba(59, 130, 246, 0.1); }
        body.dark-theme .delete-activity:hover { background-color: rgba(239, 68, 68, 0.2); }
        body.dark-theme .profile-avatar-section label { color: var(--text-color); }
        body.dark-theme #profileAvatarLarge { background-color: var(--light); color: var(--text-color); border-color: var(--primary-light); }
        body.dark-theme .profile-header-text { color: var(--gray); }
        body.dark-theme .placeholder-content { color: var(--gray); border-color: var(--light-gray); }
        body.dark-theme .placeholder-content h2 { color: var(--text-color); }
        body.dark-theme .placeholder-content p { color: var(--gray); }
        body.dark-theme .placeholder-content .error-message { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--text-color); }
        body.dark-theme .settings-label, body.dark-theme .form-group label { color: var(--text-color); }
        body.dark-theme .settings-subsection h4 { color: #93c5fd; }
        body.dark-theme .setting-item-label { color: var(--text-color); }
        body.dark-theme .setting-item-description { color: var(--gray); }
        body.dark-theme .qr-code-placeholder { border-color: var(--light-gray); color: var(--gray); }
        body.dark-theme .danger-zone-item .btn-danger { background-color: #dc2626; }
        body.dark-theme .danger-zone-item .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        body.dark-theme .danger-zone-item p { color: var(--gray); }
        body.dark-theme .checkbox-group { border-color: var(--light-gray); }
        body.dark-theme .checkbox-group label { color: var(--text-color); }
        body.dark-theme .confirm-title { color: var(--text-color); }
        body.dark-theme .confirm-message { color: var(--gray); }
        body.dark-theme .modal-title { color: #93c5fd; }
        body.dark-theme #settingsContent .team-member-card .member-name { color: var(--text-color); }
        body.dark-theme #settingsContent .team-member-card .member-email { color: var(--gray); }
        body.dark-theme .search-result-item strong { color: var(--text-color); }
        body.dark-theme .user-name { color: var(--text-color); }
        body.dark-theme .toast { background-color: var(--light); color: var(--text-color); }
        body.dark-theme .toast.success { background-color: var(--success); color: white; }
        body.dark-theme .toast.error { background-color: var(--danger); color: white; }
        /* Dark Theme: Feature Specific Overrides */
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table thead th { background-color: var(--primary-dark); color: var(--dark); border-bottom-color: var(--light-gray);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td { color: var(--text-color); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:nth-child(even) td.employee-name { background-color: var(--primary-light); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td, body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody tr:hover td.employee-name { background-color: #475569; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .employee-name { background-color: var(--light); border-right-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-name { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .day-date { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-table tbody td.weekend-cell { background-color: var(--schedule-weekend-bg) !important; }
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-weekend-off { color: var(--schedule-weekend-text); background-color: transparent; border-color: transparent; font-style: italic;}
        body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title { color: #93c5fd; } /* Adjusted */
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-sick { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-border);}
        body.dark-theme #featureSectionsContainer.employee-scheduling .shift-vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-border);}
        body.dark-theme #featureSectionsContainer.task-management-feature { background-color: transparent; } /* Let container handle bg */
        body.dark-theme #featureSectionsContainer.task-management-feature .task-page-header { background: var(--dashboard-header-bg); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content { background-color: transparent; color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content h1 { color: #93c5fd; } /* Already in header, might not be needed */
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .controls { background-color: var(--light); border-bottom-color: var(--light-gray); } /* Match card header */
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content #search-input, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .filters select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .search-icon { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .no-tasks { background-color: transparent; color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card { background-color: var(--light); border-color: var(--light-gray); border-left-color: var(--primary); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-High { border-left-color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Medium { border-left-color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.priority-Low { border-left-color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card h3 { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card p { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .description { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card strong { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card .links a { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-meta { color: var(--gray); border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-badge { color: var(--dark); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Pending { background-color: var(--warning); color: #333; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-InProgress { background-color: #3b82f6; color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .status-Completed { background-color: var(--success); color: white; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed { background-color: var(--primary-light); border-left-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed h3, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed p, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .description, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed .task-meta, body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-card.status-Completed strong { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions button { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .edit-btn:hover { color: #60a5fa; }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .delete-btn { color: var(--danger); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .complete-btn { color: var(--success); }
        body.dark-theme #featureSectionsContainer.task-management-feature .task-management-content .task-actions .reopen-btn { color: var(--warning); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal { background-color: rgba(0, 0, 0, 0.7); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content { background-color: var(--light); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .close-btn:hover { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content #modal-title { color: #93c5fd; }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content label { color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="text"], body.dark-theme #featureSectionsContainer.task-management-feature .modal-content input[type="date"], body.dark-theme #featureSectionsContainer.task-management-feature .modal-content textarea, body.dark-theme #featureSectionsContainer.task-management-feature .modal-content select { background-color: var(--primary-light); border-color: var(--light-gray); color: var(--text-color); }
        body.dark-theme #featureSectionsContainer.task-management-feature .modal-content .form-actions { border-top-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section { background-color: var(--feature-team-bg); border-color: var(--feature-team-border-color);}
        body.dark-theme #featureSectionsContainer.team-members-feature .team-members-section-header { background-color: var(--feature-team-title-bg); color: var(--feature-team-title-text); border-bottom-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"] { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-filter input[type="text"]::placeholder { color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card { background-color: var(--feature-team-card-bg); border-color: var(--feature-team-border-color); }
        body.dark-theme #featureSectionsContainer.team-members-feature .team-member-card:hover { border-color: var(--gray); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-name { color: var(--feature-team-text-primary); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-email { color: var(--feature-team-text-secondary); }
        body.dark-theme #featureSectionsContainer.team-members-feature .member-role.role-member { background-color: #4b5563; color: #d1d5db;} /* Example adjustment */
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper { background-color: var(--feature-projects-card-bg); border-left-color: var(--feature-projects-primary-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .projects-title-wrapper h2 { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-controls { background-color: var(--feature-projects-card-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-search-input, body.dark-theme #featureSectionsContainer.projects-feature .project-filter-select { background-color: var(--feature-projects-input-bg); color: var(--feature-projects-text-color); border-color: var(--feature-projects-input-border); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-card { background-color: var(--feature-projects-card-bg); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-name { color: var(--feature-projects-heading-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .progress-bar-container { background-color: var(--feature-projects-progress-bar-bg); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-info i { color: var(--feature-projects-text-muted); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-participants span { background-color: color-mix(in srgb, var(--feature-projects-card-bg) 80%, var(--feature-projects-text-muted) 20%); color: var(--feature-projects-text-color); border-color: var(--feature-projects-border-color); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-completed { background-color: var(--feature-projects-success-bg); color: var(--feature-projects-success-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-in-progress { background-color: var(--feature-projects-warning-bg); color: var(--feature-projects-warning-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-active { background-color: var(--feature-projects-info-bg); color: var(--feature-projects-info-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .status-pending { background-color: var(--feature-projects-secondary-bg); color: var(--feature-projects-secondary-text); }
        body.dark-theme #featureSectionsContainer.projects-feature .project-actions { border-top-color: var(--feature-projects-border-color); }
        /* Dark theme: File Sharing, Project Tracking, Reports */
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card { background-color: var(--light); border-color: var(--light-gray); }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .card-header,
        body.dark-theme #featureSectionsContainer.file-sharing-feature .filters-section,
        body.dark-theme #featureSectionsContainer.file-sharing-feature #recentUploadsSection,
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .card-header,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-filters-section,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table-container,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .card-header,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-filters-section,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table-container,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table { background-color: var(--light) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .fancy-header-title,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-fancy-title,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-fancy-title { background: var(--dashboard-header-bg) !important; color: white !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .file-name,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .project-name { color: var(--text-color) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .text-muted,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .text-muted,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .text-muted { color: var(--gray) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table thead,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-table thead,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table thead { background-color: var(--primary-light) !important; color: var(--gray) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .table-hover > tbody > tr:hover > *,
        body.dark-theme #featureSectionsContainer.project-tracking-feature .table-hover > tbody > tr:hover > *,
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .table-hover > tbody > tr:hover > * { background-color: var(--primary-light) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area { background-color: var(--primary-light) !important; border-color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area:hover { background-color: var(--light) !important; }
        body.dark-theme #featureSectionsContainer.file-sharing-feature .upload-area i { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-visualizations .chart-container { background-color: var(--feature-tracking-chart-background) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.project-tracking-feature .pt-reminders h6 { color: var(--primary) !important; }
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .chart-container { background-color: var(--feature-reports-chart-background) !important; border-color: var(--light-gray) !important; }
        body.dark-theme #featureSectionsContainer.reports-analytics-feature .ra-table .employee-name { color: var(--text-color) !important; }


    </style>
</head>
<body class=""> <!-- JS applies theme -->

    <audio id="notificationSound" preload="auto">
        <source src="assets/notification.mp3" type="audio/mpeg"> <!-- Check this path -->
        Your browser does not support the audio element.
    </audio>

    <!-- Hamburger Menu Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Toast/Success Messages -->
    <div class="toast" id="toastMessage">Toast message</div>
    <div class="success-message" id="successMessage"> <i class="fas fa-check-circle"></i> <span id="successMessageText">Action successful!</span> </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#dashboard" class="logo" data-feature="dashboard">
                <i class="fas fa-users-cog logo-icon"></i>
                <span>TeamFlow</span>
            </a>
             <button class="sidebar-toggle close-sidebar" id="closeSidebar" aria-label="Close Sidebar" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
             <div class="menu-title">Navigation</div>
             <a href="#dashboard" class="menu-item active" data-feature="dashboard"> <i class="fas fa-tachometer-alt"></i><span>Dashboard</span> </a>
             <a href="#projects" class="menu-item" data-feature="projects"> <i class="fas fa-briefcase"></i><span>Projects</span> </a>
             <a href="#reports-analytics" class="menu-item" data-feature="reports-analytics"> <i class="fas fa-chart-line"></i><span>Reports & Analytics</span> </a>
             <a href="#team-members-view" class="menu-item" data-feature="team-members-view"> <i class="fas fa-users"></i><span>Team Members</span> </a>
             <div class="menu-title">Core Features</div>
             <a href="#file-sharing" class="menu-item" data-feature="file-sharing"><i class="fas fa-file-upload"></i><span>File Sharing</span></a>
             <!-- <a href="#data-management" class="menu-item" data-feature="data-management"><i class="fas fa-database"></i><span>Data Management</span></a> -->
             <a href="#project-tracking" class="menu-item" data-feature="project-tracking"><i class="fas fa-project-diagram"></i><span>Project Tracking</span></a>
             <a href="#task-management" class="menu-item" data-feature="task-management"><i class="fas fa-tasks"></i><span>Task Management</span></a>
             <div class="menu-title">Team Tools</div>
             <a href="#employee-scheduling" class="menu-item" data-feature="employee-scheduling"><i class="fas fa-user-clock"></i><span>Employee Scheduling</span></a>
             <a href="#team-calendar" class="menu-item" data-feature="team-calendar"><i class="fas fa-calendar-alt"></i><span>Team Calendar</span></a> <!-- Restored -->
             <!-- <a href="#deadline-tracking" class="menu-item" data-feature="deadline-tracking"><i class="fas fa-clock"></i><span>Deadline Tracking</span></a> -->
             <a href="#innovation-hub" class="menu-item" data-feature="innovation-hub"><i class="fas fa-lightbulb"></i><span>Innovation Hub</span></a> <!-- Restored -->
             <div class="menu-divider"></div>
             <a href="#settings" class="menu-item" data-feature="settings"> <i class="fas fa-cog"></i><span>Settings</span> </a>
             <a href="#profile" class="menu-item" data-feature="profile"> <i class="fas fa-user-circle"></i><span>Profile</span> </a>
         </div>
         <div class="connection-status">
             <div class="status-dot"></div>
             <span>Online</span>
         </div>
    </aside>

    <main class="main-content" id="mainContent">
         <nav class="top-nav">
             <div class="search-bar">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" placeholder="Search employees, projects, tasks..." id="searchInput" autocomplete="off">
                 <div class="search-results" id="searchResults"></div>
             </div>
             <div class="user-menu">
                 <div class="notification-icon" id="notificationIcon">
                     <i class="fas fa-bell"></i>
                     <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                 </div>
                 <div class="user-profile" id="userProfileContainer">
                     <div class="user-avatar" id="userAvatar">ME</div>
                     <div class="user-profile-details">
                         <span class="user-name" id="userName">Loading...</span>
                         <span class="user-status">  Connected</span>
                     </div>
                     <div class="user-dropdown" id="userDropdown">
                         <a href="#profile" class="dropdown-item" data-feature="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                         <a href="#settings" class="dropdown-item" data-feature="settings"><i class="fas fa-cog"></i><span>Settings</span></a>
                         <a href="#" class="dropdown-item" id="logoutLink"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
                     </div>
                 </div>
             </div>
         </nav>

         <div class="content-area">
             <!-- Back Button -->
             <div class="back-button" id="backButton" style="display: none;">
                 <i class="fas fa-arrow-left"></i> <span id="backButtonText">Back</span>
             </div>

             <!-- Dashboard Content -->
             <div id="dashboardContent" class="content-section active">
                 <div class="welcome-section" id="welcomeSection">
                     <h2 class="welcome-title">Welcome, <span id="welcomeName">User</span>!</h2>
                     <p class="welcome-subtitle">Here's what's happening with your team today.</p>
                     <div class="user-info">
                         <div class="user-info-avatar" id="profileAvatar">U</div>
                         <div class="user-info-details">
                             <div class="user-info-name" id="userInfoName">Loading User...</div>
                             <div class="user-info-title" id="userInfoRoleTitle">Loading Role...</div>
                             <div class="user-info-email">
                                 <i class="fas fa-envelope"></i> <span id="userEmail">loading@email.com</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="stats-section" id="statsSection">
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                     <div class="stat-card"> <div class="stat-title"><i class="fas fa-spinner fa-spin"></i>Loading...</div> <div class="stat-value"><span>-</span></div> </div>
                 </div>
                 <div class="activity-section">
                     <div class="section-header">
                         <h3 class="section-title">Recent Activity <span class="live-badge">LIVE</span></h3>
                         <div>
                             <span class="view-all" id="viewAllActivity">Show All</span>
                             <span class="delete-all" id="deleteAllActivity">Delete All</span>
                         </div>
                     </div>
                     <ul class="activity-list" id="activityList">
                         <li style="text-align: center; padding: 2rem; color: var(--gray);"> Loading activities... </li>
                     </ul>
                 </div>
             </div>

             <!-- Profile Content -->
             <div class="content-section" id="profileContent">
                 <div class="section-main-header"> <h2 class="section-main-title">Profile</h2> </div>
                 <p class="profile-header-text">Your personal information and account security settings.</p>
                 <div class="profile-avatar-section">
                     <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);">Avatar</label>
                     <div id="profileAvatarLarge" title="Click to upload photo">ME</div>
                     <input type="file" id="profileAvatarInput" accept="image/*" style="display: none;">
                 </div>
                 <form class="data-form" id="profileForm">
                     <div class="form-group"> <label for="firstName">First Name</label> <input type="text" id="firstName" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="lastName">Last Name</label> <input type="text" id="lastName" class="form-control" value=""> </div>
                     <div class="form-group" style="grid-column: span 2;"> <label for="fullNameDisplay">Full Name</label> <input type="text" id="fullNameDisplay" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="jobTitle">Job Title</label> <input type="text" id="jobTitle" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="email">Email</label> <input type="email" id="email" class="form-control" value="" readonly> </div>
                     <div class="form-group"> <label for="phone">Phone Number</label> <input type="tel" id="phone" class="form-control" value=""> </div>
                     <div class="form-group"> <label for="department">Department</label> <input type="text" id="department" class="form-control" value=""> </div>
                     <div class="form-actions">
                         <button type="button" class="btn btn-outline" id="cancelProfileBtn">Cancel</button>
                         <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                            <span class="btn-text">Save Changes</span>
                            <span class="spinner" style="display: none;"></span>
                         </button>
                     </div>
                 </form>
             </div>

             <!-- Settings Content -->
             <div class="content-section" id="settingsContent">
                 <div class="section-main-header"> <h2 class="section-main-title">System Settings</h2> </div>
                 <div class="settings-tabs">
                     <div class="settings-tab active" data-tab="preferences">Preferences</div>
                     <div class="settings-tab" data-tab="account">Account</div>
                     <div class="settings-tab" data-tab="security">Security</div>
                     <div class="settings-tab" data-tab="notifications">Notifications</div>
                     <div class="settings-tab" data-tab="team" id="teamSettingsTab">Team Management</div>
                     <div class="settings-tab" data-tab="collaboration">Collaboration</div>
                     <div class="settings-tab" data-tab="danger" id="dangerZoneTab">Danger Zone</div>
                 </div>

                 <!-- Preferences Panel -->
                 <div class="settings-panel active" id="preferencesPanel">
                      <div class="settings-subsection">
                         <h4>Appearance</h4>
                         <div class="form-group">
                             <label class="settings-label">Theme</label>
                             <div class="theme-options-container">
                                 <div class="theme-option" data-theme="light"> <div class="theme-preview light-preview"><i class="fas fa-sun"></i></div> <span class="theme-label">Light</span> </div>
                                 <div class="theme-option" data-theme="dark"> <div class="theme-preview dark-preview"><i class="fas fa-moon"></i></div> <span class="theme-label">Dark</span> </div>
                                 <div class="theme-option" data-theme="system"> <div class="theme-preview system-preview"><i class="fas fa-desktop"></i></div> <span class="theme-label">System</span> </div>
                             </div>
                         </div>
                         <div class="setting-item">
                            <div> <span class="setting-item-label">High Contrast Mode</span> <p class="setting-item-description">Increase text visibility for accessibility.</p> </div>
                            <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="highContrastToggle"> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Localization</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="languageSelect">Language</label> <select id="languageSelect" class="form-control"> <option value="en">English (US)</option> <option value="ar"> (Arabic)</option> <option value="es">Espaol (Spanish)</option> </select> </div>
                             <div class="form-group"> <label for="regionSelect">Region / Timezone</label> <select id="regionSelect" class="form-control"> <option value="utc">UTC</option> <option value="est">EST (UTC-5)</option> <option value="pst">PST (UTC-8)</option> <option value="cet">CET (UTC+1)</option> <option value="eet">EET (UTC+2)</option> <option value="ast">AST (UTC+3) - Riyadh</option> </select> </div>
                         </div>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                             <div class="form-group"> <label for="timeFormatSelect">Time Format</label> <select id="timeFormatSelect" class="form-control"> <option value="12h">12-hour (e.g., 3:00 PM)</option> <option value="24h">24-hour (e.g., 15:00)</option> </select> </div>
                              <div class="form-group"> <label for="dateFormatSelect">Date Format</label> <select id="dateFormatSelect" class="form-control"> <option value="MM/DD/YYYY">MM/DD/YYYY</option> <option value="DD/MM/YYYY">DD/MM/YYYY</option> <option value="YYYY-MM-DD">YYYY-MM-DD</option> <option value="Month D, YYYY">Month D, YYYY</option> </select> </div>
                         </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Messages & Sounds</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Toast Notifications</span> <p class="setting-item-description">Show brief confirmation messages for actions.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="toastToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Sound Notifications</span> <p class="setting-item-description">Play a sound for new notifications and activities.</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="soundToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                         <div class="form-group"> <label for="notificationToneSelect">Notification Tone</label> <select id="notificationToneSelect" class="form-control" disabled> <option value="default">Default</option> <option value="tone1">Tone 1 (Placeholder)</option> <option value="tone2">Tone 2 (Placeholder)</option> </select> <p class="setting-item-description">Select the sound to play for notifications (Requires enabling sound).</p> </div>
                         <div class="form-group"> <label class="settings-label">Keyboard Shortcuts</label> <p class="setting-item-description">View or customize keyboard shortcuts (Feature placeholder).</p> <button class="btn btn-outline btn-sm" disabled>View Shortcuts</button> </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="savePreferencesBtn">Save Preferences</button> </div>
                 </div>

                 <!-- Account Panel -->
                 <div class="settings-panel" id="accountPanel">
                    <div class="settings-subsection">
                         <h4>Account Information</h4>
                         <div class="data-form">
                             <div class="form-group"> <label for="accountEmail">Current Email</label> <input type="email" id="accountEmail" class="form-control" value="" readonly> </div>
                             <div class="form-group"> <label for="changeEmail">New Email Address</label> <input type="email" id="changeEmail" class="form-control" placeholder="Enter new email" disabled> <p class="setting-item-description">Changing email requires backend verification.</p> </div>
                             <div class="form-group" style="grid-column: span 2;"> <label for="accountConfirmPassword">Confirm Password (to change email)</label> <input type="password" id="accountConfirmPassword" class="form-control" placeholder="Enter current password" disabled> </div>
                            <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-primary" id="saveAccountEmailBtn" disabled>Change Email Address</button> </div>
                         </div>
                         <p style="margin-top: 1rem;">Note: Password changes are managed under the <a href="#settings-security" data-feature="settings" data-tab-target="security" class="settings-link">Security Tab</a>.</p>
                     </div>
                     <div class="settings-subsection">
                         <h4>Account Notifications</h4>
                         <div class="setting-item">
                             <div> <span class="setting-item-label">Enable Account Notifications</span> <p class="setting-item-description">Receive email alerts for important account activities (e.g., password changes, new logins).</p> </div>
                             <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="accountNotificationsToggle" checked> <span class="slider round"></span> </label> </div>
                         </div>
                     </div>
                     <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveAccountSettingsBtn">Save Account Settings</button> </div>
                 </div>

                 <!-- Security Panel -->
                 <div class="settings-panel" id="securityPanel">
                      <div class="settings-subsection">
                         <h4>Password</h4>
                         <form class="data-form" id="changePasswordForm">
                             <div class="form-group"> <label for="currentPassword">Current Password</label> <input type="password" id="currentPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="newPassword">New Password</label> <input type="password" id="newPassword" class="form-control"> </div>
                             <div class="form-group"> <label for="confirmPassword">Confirm New Password</label> <input type="password" id="confirmPassword" class="form-control"> </div>
                             <div class="form-actions"> <button type="submit" class="btn btn-primary">Change Password</button> </div>
                         </form>
                     </div>
                     <div class="settings-subsection">
                         <h4>Two-Factor Authentication (2FA)</h4>
                         <div class="two-fa-status" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;"> <span class="status-indicator disabled" id="twoFaStatusIndicator" style="width: 10px; height: 10px; border-radius: 50%; display: inline-block; background-color: var(--gray); transition: background-color 0.3s;"></span> <span id="twoFaStatusText" style="font-weight: 500;">2FA is currently Disabled</span> </div>
                         <p class="setting-item-description">Add an extra layer of security to your account using an authenticator app or SMS.</p>
                         <div id="twoFaSetupSection" style="display: block; margin-top: 1rem;">
                             <button class="btn btn-primary" id="enable2faBtn">Enable 2FA</button>
                             <div class="two-fa-setup" id="twoFaSetupOptions" style="display:none; margin-top: 1rem;">
                                 <h5 style="margin-bottom: 0.75rem; font-size: 1rem;">Choose Setup Method:</h5>
                                 <div class="two-fa-actions" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;"> <button class="btn btn-outline" id="setupAuthAppBtn"><i class="fas fa-mobile-alt"></i> Authenticator App</button> <button class="btn btn-outline" id="setupSmsBtn"><i class="fas fa-sms"></i> SMS Message</button> </div>
                                 <div id="authAppSetup" style="display: none; margin-top: 1.5rem;"> <p>1. Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p> <div class="qr-code-placeholder" style="width: 150px; height: 150px; border: 1px solid var(--light-gray); display: flex; align-items: center; justify-content: center; color: var(--gray); margin: 1rem auto;">QR Placeholder</div> <p>2. Enter the 6-digit code generated by your app below.</p> <div class="form-group" style="max-width: 200px;"> <label for="authCode">Verification Code</label> <input type="text" id="authCode" class="form-control" placeholder="123456" maxlength="6"> </div> <button class="btn btn-primary" id="verifyAuthCodeBtn">Verify & Enable</button> </div>
                                 <div id="smsSetup" style="display: none; margin-top: 1.5rem;"> <p>1. We'll send a verification code via SMS to your registered phone number (<span id="userPhoneNumberForSms"></span>).</p> <button class="btn btn-primary" id="sendSmsCodeBtn">Send Code</button> <div class="form-group" style="margin-top: 1rem; display: none;" id="smsCodeInputGroup"> <label for="smsCode">SMS Verification Code</label> <input type="text" id="smsCode" class="form-control" placeholder="123456" maxlength="6" style="max-width: 200px;"> </div> <button class="btn btn-primary" id="verifySmsCodeBtn" style="display: none;">Verify & Enable</button> </div>
                             </div>
                         </div>
                         <div id="twoFaManagementSection" style="display: none; margin-top: 1rem;"> <p>2FA is enabled. You can manage recovery codes or disable 2FA.</p> <div class="two-fa-actions" style="display: flex; gap: 1rem;"> <button class="btn btn-outline" disabled>View Recovery Codes</button> <button class="btn btn-danger" id="disable2faBtn">Disable 2FA</button> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Session Management</h4>
                         <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"> <label for="sessionDuration">Session Duration (minutes)</label> <input type="number" id="sessionDuration" class="form-control" value="60" min="15"> <p class="setting-item-description">Set how long a login session remains active.</p> </div>
                            <div class="form-group"> <label for="idleTimeout">Idle Timeout (minutes)</label> <input type="number" id="idleTimeout" class="form-control" value="15" min="5"> <p class="setting-item-description">Automatically logout after inactivity.</p> </div>
                         </div>
                         <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveSessionSettingsBtn">Save Session Settings</button> </div>
                     </div>
                 </div>

                 <!-- Notifications Panel -->
                 <div class="settings-panel" id="notificationsPanel">
                     <div class="settings-subsection">
                         <h4>Notification Delivery</h4>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Email Notifications</span> <p class="setting-item-description">Receive summaries and important alerts via email.</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="emailNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable In-App Notifications</span> <p class="setting-item-description">Show notifications within the TeamFlow interface (bell icon).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="inAppNotificationsToggle" checked> <span class="slider round"></span> </label> </div> </div>
                         <div class="setting-item"> <div> <span class="setting-item-label">Enable Push Notifications (Mobile/Desktop)</span> <p class="setting-item-description">Receive notifications even when the app isn't open (Requires browser/OS support & backend).</p> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="pushNotificationsToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Notification Types</h4>
                         <p class="setting-item-description">Choose which types of notifications you want to receive (Settings apply to In-App & Email if enabled). Backend needed to manage these.</p>
                         <div class="checkbox-group"> <label><input type="checkbox" name="notificationType" value="task_assigned" checked> Task Assigned</label> <label><input type="checkbox" name="notificationType" value="task_comment" checked> Task Comment/Mention</label> <label><input type="checkbox" name="notificationType" value="project_update" checked> Project Update</label> <label><input type="checkbox" name="notificationType" value="deadline_reminder" checked> Deadline Reminder</label> <label><input type="checkbox" name="notificationType" value="file_shared"> File Shared</label> <label><input type="checkbox" name="notificationType" value="system_announcement" checked> System Announcement</label> </div>
                     </div>
                     <div class="settings-subsection">
                        <h4>Sound & Priority (Linked to Preferences)</h4>
                         <p class="setting-item-description">Sound settings are managed under the <a href="#settings-preferences" data-feature="settings" data-tab-target="preferences" class="settings-link">Preferences Tab</a>.</p>
                         <div class="form-group"> <label for="notificationPriority">Minimum Notification Priority</label> <select id="notificationPriority" class="form-control" disabled> <option value="low">Low</option> <option value="medium">Medium</option> <option value="high">High</option> </select> <p class="setting-item-description">Only show notifications above a certain priority level (Feature placeholder).</p> </div>
                     </div>
                      <div class="form-actions" style="grid-column: span 1; justify-content: flex-end;"> <button type="button" class="btn btn-primary" id="saveNotificationSettingsBtn">Save Notification Settings</button> </div>
                 </div>

                 <!-- Team Management Panel -->
                 <div class="settings-panel" id="teamPanel">
                      <div class="team-management">
                         <div class="settings-subsection">
                             <h4>Team Members</h4>
                             <!-- Admin Action Buttons -->
                             <div class="team-management-actions" style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-warning btn-sm" id="deleteSelectedMembersBtn" disabled><i class="fas fa-trash-alt"></i> Delete Selected</button>
                                <button class="btn btn-danger btn-sm" id="deleteAllMembersBtn"><i class="fas fa-exclamation-triangle"></i> Delete All Others</button>
                            </div>
                             <div class="team-list" id="teamList"> <p>Loading team members...</p> </div>
                             <div class="add-member-form">
                                 <h4>Invite New Member</h4>
                                 <form id="inviteMemberForm" class="data-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 1rem;">
                                    <div class="form-group"> <label for="inviteEmail">Email</label> <input type="email" id="inviteEmail" class="form-control" required> </div>
                                    <div class="form-group"> <label for="inviteRole">Role</label> <select id="inviteRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                                    <button type="submit" class="btn btn-primary">Invite</button>
                                 </form>
                             </div>
                         </div>
                         <div class="settings-subsection">
                             <h4>Custom Role Permissions</h4>
                             <p class="setting-item-description">Define specific permissions for different roles within your team (Feature placeholder - requires backend).</p>
                             <button class="btn btn-outline" disabled>Manage Permissions</button>
                         </div>
                     </div>
                 </div>

                 <!-- Collaboration Panel -->
                 <div class="settings-panel" id="collaborationPanel">
                      <div class="settings-subsection">
                         <h4>External Integrations</h4>
                         <p class="setting-item-description">Connect TeamFlow with other applications (Requires backend setup).</p>
                         <div class="integration-list" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;"> <button class="btn btn-outline" disabled><i class="fab fa-slack"></i> Connect Slack</button> <button class="btn btn-outline" disabled><i class="fab fa-google-drive"></i> Connect Google Drive</button> <button class="btn btn-outline" disabled><i class="fab fa-github"></i> Connect GitHub</button> </div>
                     </div>
                      <div class="settings-subsection">
                         <h4>Sharing & Invitations</h4>
                         <p class="setting-item-description">Manage how projects and tasks can be shared externally (Feature placeholder).</p>
                         <div class="setting-item"> <div> <span class="setting-item-label">Allow External Sharing Links</span> </div> <div class="setting-item-control"> <label class="switch"> <input type="checkbox" id="externalSharingToggle" disabled> <span class="slider round"></span> </label> </div> </div>
                         <button class="btn btn-outline" disabled>Manage Pending Invites</button>
                      </div>
                      <div class="settings-subsection">
                         <h4>Collaboration Permissions</h4>
                         <p class="setting-item-description">Set default permissions for collaboration features like comments and file sharing (Feature placeholder).</p>
                         <button class="btn btn-outline" disabled>Set Default Permissions</button>
                     </div>
                 </div>


                 <!-- Danger Zone Panel (Refined) -->
                 <div class="settings-panel" id="dangerPanel">
                     <h3 class="section-title" style="color: var(--danger); margin-bottom: 0.5rem;">Danger Zone</h3>
                     <p style="color: var(--gray); margin-bottom: 1.5rem;">These actions are permanent and cannot be undone. Proceed with caution.</p>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Logout From All Devices</h5>
                            <p>This will log you out of all active sessions on other computers and mobile devices.</p>
                         </div>
                         <button class="btn btn-warning" id="logoutAllDevicesBtn">Logout Everywhere</button>
                     </div>

                     <div class="danger-zone-item">
                         <div>
                            <h5>Delete Account</h5>
                            <p>Permanently delete your account and all associated data. This action cannot be reversed.</p>
                         </div>
                         <button class="btn btn-danger" id="deleteAccountBtn">Delete My Account</button>
                     </div>
                 </div>
             </div>

             <!-- Container for other feature sections -->
             <div id="featureSectionsContainer" class="content-section">
                 <div class="placeholder-content" id="featurePlaceholder">
                     <h2 id="featureTitle">Feature Content Area</h2>
                     <p id="featureDescription">Select a feature from the sidebar.</p>
                     <div class="loading-indicator" style="display: none;"> <i class="fas fa-spinner fa-spin"></i> Loading... </div>
                     <div class="error-message" style="display: none;"> Failed to load content. </div>
                 </div>
             </div>
         </div>
    </main>

    <!-- Notification Modal -->
    <div class="notifications-modal" id="notificationsModal">
         <div class="notifications-container">
             <div class="notifications-header">
                 <h3 class="notifications-title">Notifications</h3>
                 <button class="close-notifications" id="closeNotifications" aria-label="Close Notifications"></button>
             </div>
             <div class="notifications-body" id="notificationsBody">
                 <div class="no-notifications-message" id="noNotificationsMessage">Loading notifications...</div>
             </div>
             <div class="notifications-footer">
                 <button class="btn btn-outline btn-sm" id="markAllReadBtn">Mark All as Read</button>
                 <button class="btn btn-danger btn-sm" id="deleteAllNotificationsBtn">Delete All</button>
             </div>
         </div>
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
         <div class="confirm-container">
             <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
             <div class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</div>
             <div class="confirm-actions">
                 <button class="btn btn-outline" id="cancelConfirmBtn">Cancel</button>
                 <button class="btn btn-danger" id="confirmBtn">Confirm</button>
             </div>
         </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="memberModalTitle">Member Details</h3> <button class="close-modal" data-close-modal></button> </div>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                 <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                     <div class="form-group"> <label for="memberFirstName">First Name</label> <input type="text" id="memberFirstName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberLastName">Last Name</label> <input type="text" id="memberLastName" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberEmail">Email</label> <input type="email" id="memberEmail" class="form-control" required> </div>
                     <div class="form-group"> <label for="memberRole">Role</label> <select id="memberRole" class="form-control" required> <option value="member">Member</option> <option value="supervisor">Supervisor</option> <option value="senior">Senior</option> <option value="admin">Admin</option> </select> </div>
                      <div class="form-group"> <label for="memberTitle">Job Title</label> <input type="text" id="memberTitle" class="form-control"> </div>
                      <div class="form-group"> <label for="memberDepartment">Department</label> <input type="text" id="memberDepartment" class="form-control"> </div>
                 </div>
                <div class="form-actions" style="grid-column: span 2;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveMemberBtn">Save Changes</button> </div>
            </form>
        </div>
    </div>

    <!-- Project Add/Edit Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="projectModalTitle">Project Details</h3> <button class="close-modal" data-close-modal></button> </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="data-form" style="grid-template-columns: 1fr;">
                    <div class="form-group"> <label for="projectName">Project Name</label> <input type="text" id="projectName" class="form-control" required> </div>
                    <div class="form-group"> <label for="projectDescription">Description</label> <textarea id="projectDescription" class="form-control" rows="3"></textarea> </div>
                     <div class="form-group"> <label for="projectParticipantsInput">Participants (Separate with | )</label> <input type="text" id="projectParticipantsInput" class="form-control" placeholder="e.g., John D.|Jane S."> </div>
                    <div class="form-group"> <label for="projectImageInput">Image URL (Optional)</label> <input type="url" id="projectImageInput" class="form-control" placeholder="https://..."> </div>
                     <div class="data-form" style="grid-template-columns: 1fr 1fr;">
                         <div class="form-group"> <label for="projectStartDate">Start Date</label> <input type="date" id="projectStartDate" class="form-control"> </div>
                        <div class="form-group"> <label for="projectDueDate">Due Date</label> <input type="date" id="projectDueDate" class="form-control"> </div>
                         <div class="form-group"> <label for="projectStatus">Status</label> <select id="projectStatus" class="form-control" required> <option value="pending">Pending</option> <option value="active">Active</option> <option value="in-progress">In Progress</option> <option value="completed">Completed</option> </select> </div>
                        <div class="form-group"> <label for="projectProgress">Progress (%)</label> <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0"> </div>
                    </div>
                 </div>
                <div class="form-actions" style="grid-column: span 1;"> <button type="button" class="btn btn-outline" data-close-modal>Cancel</button> <button type="submit" class="btn btn-primary" id="saveProjectBtn">Save Project</button> </div>
            </form>
        </div>
    </div>


    <!-- ========= Feature Templates ========= -->

    <!-- Template for Task Management -->
    <template id="taskManagementAssets">
        <style id="injected-task-management-styles">
            /* Styles defined in main CSS */
        </style>
        <!-- HTML Structure -->
        <div class="task-management-content">
            <div class="task-page-header">
                <h1 class="task-page-title">Task Management</h1>
            </div>
            <div class="controls">
                <div class="row gy-2 align-items-center">
                    <div class="col-md-4 search-container">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search search-icon"></i></span>
                            <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search tasks...">
                        </div>
                    </div>
                    <div class="col-md filters">
                        <div class="row gx-2 gy-2">
                            <div class="col-sm-auto col-12">
                                <select id="filter-status" class="form-select form-select-sm">
                                    <option value="all">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-sm-auto col-12">
                                <select id="filter-priority" class="form-select form-select-sm">
                                    <option value="all">All Priorities</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-sm-auto col-12">
                                <select id="filter-assigned-to" class="form-select form-select-sm">
                                    <option value="all">All Assignees</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-auto">
                        <button id="add-task-btn" class="btn btn-primary btn-sm w-100"><i class="fas fa-plus"></i> Add Task</button>
                    </div>
                </div>
            </div>
            <div class="task-list mt-3" id="task-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                <p class="no-tasks" style="grid-column: 1 / -1;">Loading tasks...</p>
            </div>
        </div>
    </template>

    <!-- Template for File Sharing -->
    <template id="fileSharingAssets">
        <style id="injected-file-sharing-styles">
             /* Styles defined in main CSS */
        </style>
        <!-- HTML Structure -->
        <div class="card shadow-sm">
            <div class="card-header">
                 <h5 class="fancy-header-title mb-0"><i class="fas fa-folder-open me-2"></i>File Management</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                    <i class="fas fa-upload me-1"></i> Upload New File
                </button>
            </div>
            <div class="card-body pt-3">
                 <!-- Filters Section -->
                 <div class="row filters-section gy-2 align-items-end">
                     <div class="col-md-4">
                          <label for="fileSearchInput" class="form-label">Search by Name</label>
                         <div class="input-group input-group-sm search-input">
                             <input type="text" class="form-control form-control-sm" placeholder="Enter file name..." id="fileSearchInput">
                              <span class="input-group-text"><i class="fas fa-search"></i></span>
                         </div>
                     </div>
                     <div class="col-md-2">
                          <label for="fileTypeFilter" class="form-label">File Type</label>
                          <select class="form-select form-select-sm" id="fileTypeFilter" title="Filter by Type">
                             <option value="" selected>All Types</option>
                             <option value="PDF">PDF</option> <option value="Image">Image</option> <option value="Video">Video</option> <option value="Archive">Archive</option> <option value="Document">Document</option> <option value="Spreadsheet">Spreadsheet</option>
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="uploadDateFilter" class="form-label">Upload Date</label>
                         <input type="date" class="form-control form-control-sm" id="uploadDateFilter" title="Filter by Upload Date">
                     </div>
                     <div class="col-md-2" id="userFilterContainer" style="display: none;">
                         <label for="userFilter" class="form-label">Uploader</label>
                          <select class="form-select form-select-sm" id="userFilter" title="Filter by Uploader">
                             <option value="" selected>All Users</option>
                             <!-- User options populated by JS -->
                         </select>
                     </div>
                      <div class="col-md-1 text-end">
                         <button class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt"></i> </button>
                      </div>
                 </div>
                 <!-- Recent Uploads Section -->
                 <div class="mb-4 p-3" id="recentUploadsSection">
                     <h6><i class="fas fa-history me-1"></i> Recent Uploads</h6>
                     <ul class="list-group list-group-flush">
                        <!-- Populated by JS -->
                        <li class="list-group-item text-muted">Loading recent files...</li>
                    </ul>
                 </div>

                 <!-- Files Table -->
                 <div class="table-responsive">
                     <table class="table table-hover align-middle">
                         <thead>
                             <tr>
                                 <th scope="col" style="width: 5%;">Type</th>
                                 <th scope="col" style="width: 30%;">File Name</th>
                                 <th scope="col" style="width: 18%;">Upload Date</th>
                                 <th scope="col" style="width: 17%;">Tags</th>
                                 <th scope="col" style="width: 15%;">Uploader</th>
                                 <th scope="col" class="text-center" style="width: 15%;">Actions</th>
                             </tr>
                         </thead>
                         <tbody id="fileTableBody">
                             <!-- Populated by JS -->
                             <tr><td colspan="6" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading files...</td></tr>
                             <tr id="noResultsRow" style="display: none;">
                                  <td colspan="6" class="text-center text-muted fst-italic py-4">No files found matching your criteria.</td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
                 <nav aria-label="File list navigation" class="mt-3 d-flex justify-content-center"></nav>
            </div>
        </div>
    </template>

    <!-- Template for Project Tracking -->
    <template id="projectTrackingAssets">
         <style id="injected-project-tracking-styles">
            /* Styles defined in main CSS */
         </style>
        <div id="project-tracking-section">
             <!-- Section Header -->
             <div class="card-header bg-white border-0 mb-3">
                 <h2 class="pt-fancy-title"><i class="fas fa-tasks me-2"></i> Project Tracking</h2>
             </div>

             <!-- Filters -->
             <div class="pt-filters-section mx-3">
                 <div class="row gy-2 align-items-end">
                     <div class="col-md-4">
                         <label for="project-status-filter" class="form-label">Filter by Status:</label>
                         <select class="form-select form-select-sm" id="project-status-filter"> <option value="" selected>All Statuses</option> <option value="Completed">Completed</option> <option value="In Progress">In Progress</option> <option value="Delayed">Delayed</option> <option value="Pending">Pending</option> </select>
                     </div>
                     <div class="col-md-4">
                         <label for="project-team-filter" class="form-label">Filter by Team/Member:</label>
                         <select class="form-select form-select-sm" id="project-team-filter">
                             <option value="" selected>All Teams/Members</option>
                             <!-- Options populated by JS -->
                        </select>
                     </div>
                     <div class="col-md-2">
                          <label for="project-priority-filter" class="form-label">Filter by Priority:</label>
                         <select class="form-select form-select-sm" id="project-priority-filter"> <option value="" selected>All Priorities</option> <option value="High">High</option> <option value="Medium">Medium</option> <option value="Low">Low</option> </select>
                     </div>
                     <div class="col-md-2 text-end">
                         <button class="btn btn-sm btn-outline-secondary w-100" id="resetProjectFiltersBtn" title="Reset Filters"> <i class="fas fa-sync-alt me-1"></i> Reset </button>
                     </div>
                 </div>
             </div>

             <!-- Visualizations & Reminders -->
             <div class="row g-3 pt-visualizations mx-2">
                  <div class="col-lg-8">
                     <div class="row g-3">
                         <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Project Status Distribution</p> <canvas id="projectStatusPieChart"></canvas> </div> </div>
                         <div class="col-md-6"> <div class="chart-container"> <p class="chart-title">Overall Progress Trend (Simulated)</p> <canvas id="projectProgressLineChart"></canvas> </div> </div>
                     </div>
                  </div>
                  <div class="col-lg-4">
                      <div class="pt-reminders"> <h6><i class="fas fa-bell me-1 text-warning"></i> Upcoming Deadlines (Next 7 Days)</h6> <ul id="upcomingDeadlinesList"> <li class="text-muted text-center pt-5">Loading deadlines...</li> </ul> </div>
                  </div>
             </div>

             <!-- Project Table -->
             <div class="mt-4 pt-table-container mx-3 mb-3">
                  <h5><i class="fas fa-list-check me-2"></i> Project Details</h5>
                  <div class="table-responsive">
                     <table class="table table-sm table-hover table-striped align-middle pt-table" id="projectTrackingTable">
                         <thead> <tr> <th data-sort-by="name">Project Name <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="startDate">Start Date <i class="fas fa-sort sort-icon"></i></th> <th data-sort-by="endDate">End Date <i class="fas fa-sort sort-icon"></i></th> <th>Assigned Team</th> <th class="text-center progress-cell" data-sort-by="progress">Progress (%) <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="status">Status <i class="fas fa-sort sort-icon"></i></th> <th class="text-center" data-sort-by="priority">Priority <i class="fas fa-sort sort-icon"></i></th> <th>Notes</th> </tr> </thead>
                         <tbody id="projectTableBody"> <tr> <td colspan="8" class="text-center p-4 text-muted"> <div class="spinner-border spinner-border-sm text-primary me-2" role="status"> <span class="visually-hidden">Loading...</span> </div> Loading project data... </td> </tr> </tbody>
                     </table>
                  </div>
                  <div class="pt-pagination" id="projectPaginationControls"></div>
             </div>
        </div>
    </template>

    <!-- Template for Reports & Analytics -->
    <template id="reportsAnalyticsAssets">
        <style id="injected-reports-analytics-styles">
            /* Styles defined in main CSS */
        </style>
        <div id="reports-analytics-section">
             <!-- Section Header with Export Buttons -->
             <div class="card-header bg-white border-0 mb-3">
                 <h2 class="ra-fancy-title"><i class="fas fa-chart-pie me-2"></i> Reports & Analytics</h2>
                 <div class="ra-export-buttons">
                      <button id="exportPdfBtn" class="btn btn-sm btn-outline-danger"> <i class="fas fa-file-pdf"></i> Export PDF </button>
                      <button id="exportExcelBtn" class="btn btn-sm btn-outline-success"> <i class="fas fa-file-excel"></i> Export Excel </button>
                 </div>
             </div>

             <!-- Filters -->
             <div class="ra-filters-section mx-3">
                 <form id="reports-filter-form">
                      <div class="row gy-2 align-items-end">
                         <div class="col-md-auto">
                             <label class="form-label">Quick Period:</label>
                             <div class="btn-group w-100" role="group" aria-label="Report Period" id="periodBtnGroup"> <input type="radio" class="btn-check" name="period" id="period-day" autocomplete="off" value="day"> <label class="btn btn-sm btn-outline-secondary" for="period-day">Day</label> <input type="radio" class="btn-check" name="period" id="period-week" autocomplete="off" value="week" checked> <label class="btn btn-sm btn-outline-secondary" for="period-week">Week</label> <input type="radio" class="btn-check" name="period" id="period-month" autocomplete="off" value="month"> <label class="btn btn-sm btn-outline-secondary" for="period-month">Month</label> </div>
                         </div>
                          <div class="col-md"> <label for="report-start-date" class="form-label">Start Date:</label> <input type="date" class="form-control form-control-sm" id="report-start-date" name="startDate" required> </div>
                          <div class="col-md"> <label for="report-end-date" class="form-label">End Date:</label> <input type="date" class="form-control form-control-sm" id="report-end-date" name="endDate" required> </div>
                          <div class="col-md-auto"> <button type="submit" class="btn btn-sm btn-primary w-100"> <i class="fas fa-sync-alt me-1"></i> Update Report </button> </div>
                     </div>
                 </form>
             </div>

             <!-- Charts Section -->
             <div class="row g-4 mx-2">
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Task Completion Rate (%)</p> <canvas id="taskCompletionChart"></canvas> </div> </div>
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Overdue Tasks Count</p> <canvas id="overdueTasksChart"></canvas> </div> </div>
                 <div class="col-lg-4 col-md-6"> <div class="chart-container"> <p class="chart-title">Files Uploaded by Employee</p> <canvas id="filesUploadedChart"></canvas> </div> </div>
                 <div class="col-lg-12"> <div class="chart-container" style="height: 400px;"> <p class="chart-title">Employee Performance Comparison</p> <canvas id="performanceComparisonChart"></canvas> </div> </div>
             </div>

             <!-- Employee Summary Table Section -->
             <div class="mt-4 ra-table-container mx-3 mb-3">
                  <h5><i class="fas fa-users me-2"></i> Employee Performance Summary</h5>
                  <div class="table-responsive">
                     <table class="table table-sm table-hover table-striped align-middle ra-table" id="employeeSummaryTable">
                         <thead> <tr> <th>Employee</th> <th class="text-center">Tasks Completed (%)</th> <th class="text-center">Overdue Tasks</th> <th class="text-center">Files Uploaded</th> <th class="text-center">Activity Score</th> </tr> </thead>
                         <tbody id="employeeSummaryTableBody"> <tr><td colspan="5" class="text-center p-4 text-muted"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div><span class="ms-2">Loading employee data...</span></td></tr> </tbody>
                     </table>
                  </div>
             </div>
        </div>
    </template>

    <!-- Template for Employee Scheduling -->
    <template id="employeeSchedulingAssets">
        <style id="injected-employee-scheduling-styles">
            /* Styles defined in main CSS */
            #featureSectionsContainer.employee-scheduling { padding: 1.5rem; /* Add padding to the container */ }
            #featureSectionsContainer.employee-scheduling .schedule-page-title {
                margin-bottom: 1rem; /* Space below title */
                color: var(--primary-dark);
            }
            body.dark-theme #featureSectionsContainer.employee-scheduling .schedule-page-title {
                 color: #93c5fd;
             }
        </style>
        <!-- HTML generated by JS -->
    </template>

    <!-- Template for Team Members View -->
    <template id="teamMembersAssets">
        <style id="injected-team-members-view-styles">
           /* Styles defined in main CSS */
        </style>
        <!-- HTML generated by JS -->
    </template>

    <!-- Template for Projects View -->
    <template id="projectsAssets">
        <style id="injected-projects-view-styles">
            /* Styles defined in main CSS */
        </style>
        <!-- HTML generated by JS -->
    </template>

    <!-- Placeholder Templates for Missing Features -->
    <template id="teamCalendarAssets">
        <style id="injected-team-calendar-styles"></style>
        <div><h2>Team Calendar</h2><p>Content coming soon...</p></div>
    </template>
    <template id="innovationHubAssets">
        <style id="injected-innovation-hub-styles"></style>
        <div><h2>Innovation Hub</h2><p>Content coming soon...</p></div>
    </template>

    <!-- ========= END Feature Templates ========= -->


    <!-- JS Libraries (Bootstrap, Chart.js, SweetAlert2, jsPDF, jsPDF-AutoTable) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const mainContent = document.getElementById('mainContent');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-area > .content-section'); // Direct children
            const dashboardContent = document.getElementById('dashboardContent');
            const profileContent = document.getElementById('profileContent');
            const settingsContent = document.getElementById('settingsContent');
            const featureSectionsContainer = document.getElementById('featureSectionsContainer');
            const featurePlaceholder = document.getElementById('featurePlaceholder');
            const featureTitleEl = document.getElementById('featureTitle');
            const featureDescEl = document.getElementById('featureDescription');
            const featureLoadingEl = featurePlaceholder.querySelector('.loading-indicator');
            const featureErrorEl = featurePlaceholder.querySelector('.error-message');

            const backButton = document.getElementById('backButton');
            const backButtonText = document.getElementById('backButtonText');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const userDropdown = document.getElementById('userDropdown');
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResults');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationsModal = document.getElementById('notificationsModal');
            const closeNotifications = document.getElementById('closeNotifications');
            const notificationsBody = document.getElementById('notificationsBody');
            const noNotificationsMessage = document.getElementById('noNotificationsMessage');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllNotificationsBtn = document.getElementById('deleteAllNotificationsBtn');
            const notificationSound = document.getElementById('notificationSound');
            const activityList = document.getElementById('activityList');
            const viewAllActivity = document.getElementById('viewAllActivity');
            const deleteAllActivity = document.getElementById('deleteAllActivity');
            const statsSection = document.getElementById('statsSection');
            const welcomeSection = document.getElementById('welcomeSection');

            // Profile Elements
            const profileForm = document.getElementById('profileForm');
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarInput = document.getElementById('profileAvatarInput');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const fullNameDisplay = document.getElementById('fullNameDisplay');
            const jobTitleInput = document.getElementById('jobTitle');
            const emailDisplay = document.getElementById('email'); // Profile email display
            const phoneInput = document.getElementById('phone');
            const departmentInput = document.getElementById('department');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');

            // Settings Elements
            const themeOptions = document.querySelectorAll('.theme-option');
            const highContrastToggle = document.getElementById('highContrastToggle');
            const languageSelect = document.getElementById('languageSelect');
            const regionSelect = document.getElementById('regionSelect');
            const timeFormatSelect = document.getElementById('timeFormatSelect');
            const dateFormatSelect = document.getElementById('dateFormatSelect');
            const toastToggle = document.getElementById('toastToggle');
            const soundToggle = document.getElementById('soundToggle'); // Added sound toggle
            const notificationToneSelect = document.getElementById('notificationToneSelect'); // Added tone select
            const savePreferencesBtn = document.getElementById('savePreferencesBtn');

            // Account Settings
            const accountEmailDisplay = document.getElementById('accountEmail'); // Account panel email display
            const changeEmailInput = document.getElementById('changeEmail');
            const accountConfirmPasswordInput = document.getElementById('accountConfirmPassword');
            const saveAccountEmailBtn = document.getElementById('saveAccountEmailBtn');
            const accountNotificationsToggle = document.getElementById('accountNotificationsToggle');
            const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');


            // Security Settings
            const changePasswordForm = document.getElementById('changePasswordForm'); // Form element
            const enable2faBtn = document.getElementById('enable2faBtn');
            const twoFaSetupSection = document.getElementById('twoFaSetupSection');
            const twoFaManagementSection = document.getElementById('twoFaManagementSection');
            const twoFaStatusIndicator = document.getElementById('twoFaStatusIndicator');
            const twoFaStatusText = document.getElementById('twoFaStatusText');
            const twoFaSetupOptions = document.getElementById('twoFaSetupOptions');
            const setupAuthAppBtn = document.getElementById('setupAuthAppBtn');
            const setupSmsBtn = document.getElementById('setupSmsBtn');
            const authAppSetup = document.getElementById('authAppSetup');
            const smsSetup = document.getElementById('smsSetup');
            const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
            const userPhoneNumberForSms = document.getElementById('userPhoneNumberForSms');
            const sendSmsCodeBtn = document.getElementById('sendSmsCodeBtn');
            const smsCodeInputGroup = document.getElementById('smsCodeInputGroup');
            const verifySmsCodeBtn = document.getElementById('verifySmsCodeBtn');
            const disable2faBtn = document.getElementById('disable2faBtn');
            const saveSessionSettingsBtn = document.getElementById('saveSessionSettingsBtn'); // Added

             // Team Management Settings
             const teamList = document.getElementById('teamList'); // For settings panel
             const deleteSelectedMembersBtn = document.getElementById('deleteSelectedMembersBtn'); // New button
             const deleteAllMembersBtn = document.getElementById('deleteAllMembersBtn'); // New button


            // Danger Zone
            const logoutAllDevicesBtn = document.getElementById('logoutAllDevicesBtn');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');

            // Notification Settings Panel
            const emailNotificationsToggle = document.getElementById('emailNotificationsToggle');
            const inAppNotificationsToggle = document.getElementById('inAppNotificationsToggle');
            const pushNotificationsToggle = document.getElementById('pushNotificationsToggle'); // Placeholder
            const notificationTypeCheckboxes = document.querySelectorAll('input[name="notificationType"]'); // Placeholder
            const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn'); // Placeholder

            // Modals & Messages
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const successMessage = document.getElementById('successMessage');
            const successMessageText = document.getElementById('successMessageText');
            const toastMessage = document.getElementById('toastMessage');
            const memberModal = document.getElementById('memberModal'); // Use generic modal for Add/Edit
            const memberForm = document.getElementById('memberForm');
            const memberModalTitle = document.getElementById('memberModalTitle');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const projectModal = document.getElementById('projectModal'); // NEW: Project Modal
            const projectForm = document.getElementById('projectForm'); // NEW: Project Form
            const projectModalTitle = document.getElementById('projectModalTitle'); // NEW: Project Modal Title
            const saveProjectBtn = document.getElementById('saveProjectBtn'); // NEW: Project Save Button


            // Logout Link
            const logoutLink = document.getElementById('logoutLink');

            // --- State Variables ---
            let currentUser = null; // Will be loaded
            let currentFeature = 'dashboard';
            let currentSettingsTab = 'preferences';
            let notifications = [];
            let activities = [];
            let activityIntervalId = null;
            let notificationIntervalId = null;
            let statsIntervalId = null;
            let welcomeBgIntervalId = null;
            let confirmCallback = null;
            let maxActivitiesToShow = 5;
            let showingAllActivities = false;
            let userDropdownOpen = false; // Track dropdown state
            let showToasts = true; // Default for toast preference
            let playSounds = true; // Default for sound preference
            let currentScheduleWeekOffset = 0; // Updated in init
            let scheduleMinWeekOffset = 0; // Will store offset for May 4, 2025 week start
            let mockScheduleData = {}; // Store schedule data { 'employeeId-weekOffset-dayIndex': 'shiftType' }
            let currentFeatureCleanup = null; // Stores the cleanup function for the loaded feature
            let MOCK_PROJECTS_DATA = []; // To store projects data


            // --- Mock Data ---
            let MOCK_USERS = [ // Use 'let' so users can be added/removed
                 { id: 1, name: 'Mohamed Elmenisy', email: 'm.elsayed@thechefz.co', title: 'Administrator', department: 'Management', phone: '+201234567890', avatar: '', initials: 'ME', role: 'admin', twoFaEnabled: false },
                 { id: 2, name: 'Nada Mahmoud', email: 'n.mahmoud@thechefz.co', title: 'Supervisor', department: 'Operations', phone: '+20111222333', avatar: '', initials: 'NM', role: 'supervisor', twoFaEnabled: false },
                 { id: 3, name: 'Yousef Ahmed', email: 'y.abbas@thechefz.co', title: 'Senior Developer', department: 'Engineering', phone: '+20100999888', avatar: '', initials: 'YA', role: 'senior', twoFaEnabled: true },
                 { id: 4, name: 'Esraa Lashin', email: 'e.lasheen@thechefz.co', title: 'Member', department: 'Design', phone: '+20155444333', avatar: '', initials: 'EL', role: 'member', twoFaEnabled: false },
                 { id: 5, name: 'Bassant Badr', email: 'b.badr@thechefz.co', title: 'Member', department: 'Marketing', phone: '+20101234567', avatar: '', initials: 'BB', role: 'member', twoFaEnabled: false },
            ];

            const MOCK_PROJECTS = [ // Renamed to avoid conflict
                { id: 101, name: 'Project Alpha', status: 'Active' },
                { id: 102, name: 'Project Beta', status: 'Planning' },
                { id: 103, name: 'Project Gamma', status: 'Completed' },
                { id: 104, name: 'Zeus Initiative', status: 'Active' },
            ];

            const MOCK_TASKS = [
                { id: 201, name: 'Design Homepage Mockup', status: 'Completed', project: 101 },
                { id: 202, name: 'Develop API Endpoints', status: 'In Progress', project: 101 },
                { id: 203, name: 'User Testing Phase 1', status: 'Pending', project: 102 },
                { id: 204, name: 'Create Task Management Feature', status: 'Active', project: 104 },
            ];

            // --- ALL FEATURE JS FUNCTIONS DEFINED HERE ---

            // Utility Functions (Globally accessible via window)
            window.timeAgo = function(timestamp) { if (!(timestamp instanceof Date)) { const date = new Date(timestamp); if (isNaN(date.getTime())) return ''; timestamp = date; } const now = new Date(); const secondsPast = (now.getTime() - timestamp.getTime()) / 1000; if (secondsPast < 10) { return 'Just now'; } if (secondsPast < 60) { return parseInt(secondsPast) + 's ago'; } if (secondsPast < 3600) { return parseInt(secondsPast / 60) + 'm ago'; } if (secondsPast < 3600 * 24) { return parseInt(secondsPast / 3600) + 'h ago'; } return formatDateForDisplay(timestamp); }
            window.formatDateForDisplay = function(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const dateFormat = localStorage.getItem('dateFormat') || 'MM/DD/YYYY'; const year = date.getFullYear(); const month = date.getMonth() + 1; const day = date.getDate(); const monthPadded = String(month).padStart(2, '0'); const dayPadded = String(day).padStart(2, '0'); const monthName = date.toLocaleDateString(undefined, { month: 'short' }); try { switch (dateFormat) { case 'DD/MM/YYYY': return `${dayPadded}/${monthPadded}/${year}`; case 'YYYY-MM-DD': return `${year}-${monthPadded}-${dayPadded}`; case 'Month D, YYYY': return `${monthName} ${day}, ${year}`; case 'MM/DD/YYYY': default: return `${monthPadded}/${dayPadded}/${year}`; } } catch (e) { console.error("Error formatting date:", e); return `${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`; } }
            window.formatFullDateTime = function(date) { if (!(date instanceof Date)) { const parsedDate = new Date(date); if (isNaN(parsedDate.getTime())) return ''; date = parsedDate; } const formattedDate = formatDateForDisplay(date); const timeFormat = localStorage.getItem('timeFormat') || '12h'; const options = { hour: 'numeric', minute: 'numeric', hour12: timeFormat === '12h' }; try { const formattedTime = date.toLocaleTimeString(undefined, options); return `${formattedDate}, ${formattedTime}`; } catch (e) { console.error("Error formatting time:", e); return formattedDate; } }
            window.generateMockActivities = function(count, baseTimestampMillis) { /* ... (mock generation, same as before) ... */ const nowMillis=baseTimestampMillis||Date.now();const newActivities=[];let users=MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const actions=['updated profile','completed task','added project','commented on task','uploaded file','joined team'];const icons=['fa-user-edit','fa-check-circle','fa-plus-circle','fa-comment','fa-upload','fa-user-plus'];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);const files=['doc.pdf','img.png','sheet.xlsx','pres.pptx'];for(let i=0;i<count;i++){const user=users[Math.floor(Math.random()*users.length)];const actionIndex=Math.floor(Math.random()*actions.length);let message=`${user} ${actions[actionIndex]}`;if(actions[actionIndex].includes('task')&&tasks.length>0){message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;}else if(actions[actionIndex].includes('project')&&projects.length>0){message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;}else if(actions[actionIndex].includes('file')&&files.length>0){message+=` ${files[Math.floor(Math.random()*files.length)]}`;}let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*10;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.5+300000);}timestampMillis=Math.min(timestampMillis,nowMillis);newActivities.push({id:nowMillis+i+Math.floor(Math.random()*1000),icon:icons[actionIndex],message:message,timestamp:new Date(timestampMillis),isNew:false});}return newActivities; }
            window.generateMockNotifications = function(count, baseTimestampMillis) { /* ... (mock generation, same as before) ... */ const nowMillis=baseTimestampMillis||Date.now();const newNotifications=[];const types=[{msg:'New task assigned:',icon:'fa-tasks',type:'task'},{msg:'Project deadline approaching:',icon:'fa-clock',type:'project'},{msg:'Mentioned you:',icon:'fa-comment-dots',type:'comment'},{msg:'System update:',icon:'fa-info-circle',type:'system'},{msg:'File shared:',icon:'fa-file-alt',type:'file'},];const tasks=MOCK_TASKS.map(t=>`'${t.name.substring(0,20)}...'`);const projects=MOCK_PROJECTS_DATA.map(p=>`'${p.name}'`);let users=MOCK_USERS.map(u=>u.name.split(' ')[0]);if(users.length===0)users.push('System');const files=['report.docx','logo.svg','data.csv'];for(let i=0;i<count;i++){const typeInfo=types[Math.floor(Math.random()*types.length)];let message=typeInfo.msg;if(typeInfo.type==='task'&&tasks.length>0)message+=` ${tasks[Math.floor(Math.random()*tasks.length)]}`;else if(typeInfo.type==='project'&&projects.length>0)message+=` ${projects[Math.floor(Math.random()*projects.length)]}`;else if(typeInfo.type==='comment'&&users.length>0)message+=` by ${users[Math.floor(Math.random()*users.length)]}`;else if(typeInfo.type==='file'&&files.length>0&&users.length>0)message+=` ${files[Math.floor(Math.random()*files.length)]} by ${users[Math.floor(Math.random()*users.length)]}`;let timestampMillis;if(count===1){timestampMillis=nowMillis-Math.random()*1000*15;}else{timestampMillis=nowMillis-(Math.random()*1000*3600*(i+1)*1.8+180000);}timestampMillis=Math.min(timestampMillis,nowMillis);newNotifications.push({id:nowMillis+i+10000+Math.floor(Math.random()*1000),icon:typeInfo.icon,message:message,timestamp:new Date(timestampMillis),unread:count===1?true:Math.random()>0.3});}return newNotifications; }
            window.showConfirmModal = function(title, message, onConfirm, buttonClass = 'btn-danger') { confirmTitle.textContent = title; confirmMessage.innerHTML = message; confirmCallback = onConfirm; confirmBtn.className = 'btn'; confirmBtn.classList.add(buttonClass); confirmModal.classList.add('active'); }
            window.showSuccessMessage = function(message) { successMessageText.textContent = message; successMessage.classList.add('show'); setTimeout(() => { successMessage.classList.remove('show'); }, 3000); }
            window.showToast = function(message, type = 'info') { if (!showToasts && type !== 'error') { console.log("Toast suppressed:", message); return; } toastMessage.textContent = message; toastMessage.className = 'toast'; if (type === 'success') { toastMessage.classList.add('success'); } else if (type === 'error') { toastMessage.classList.add('error'); } toastMessage.classList.add('show'); setTimeout(() => { toastMessage.classList.remove('show'); }, 3000); }

            // Task Management Initialization (Function Definition)
            window.initializeTaskManagementFeature = function(container) {
                 // --- DOM Elements (scoped to container) ---
                const taskContentContainer = container; // Use the passed container directly
                const addTaskBtn = taskContentContainer.querySelector('#add-task-btn');
                const taskModal = document.getElementById('task-modal'); // Modal is outside the container
                const closeModalBtn = taskModal?.querySelector('.close-btn');
                const cancelBtn = taskModal?.querySelector('#cancel-btn');
                const taskForm = taskModal?.querySelector('#task-form');
                const taskListDiv = taskContentContainer.querySelector('#task-list');
                const modalTitle = taskModal?.querySelector('#modal-title');
                const saveTaskBtn = taskModal?.querySelector('#save-task-btn');
                const taskIdInput = taskModal?.querySelector('#task-id');
                const taskNameInput = taskModal?.querySelector('#task-name');
                const taskDescriptionInput = taskModal?.querySelector('#task-description');
                const taskLinksInput = taskModal?.querySelector('#task-links');
                const taskAssignedBySelect = taskModal?.querySelector('#task-assigned-by');
                const taskAssignedToSelect = taskModal?.querySelector('#task-assigned-to');
                const taskStartDateInput = taskModal?.querySelector('#task-start-date');
                const taskDueDateInput = taskModal?.querySelector('#task-due-date');
                const taskPrioritySelect = taskModal?.querySelector('#task-priority');
                const taskStatusSelect = taskModal?.querySelector('#task-status');
                const searchInput = taskContentContainer.querySelector('#search-input');
                const filterStatusSelect = taskContentContainer.querySelector('#filter-status');
                const filterPrioritySelect = taskContentContainer.querySelector('#filter-priority');
                const filterAssignedToSelect = taskContentContainer.querySelector('#filter-assigned-to');

                if (!addTaskBtn || !taskModal || !closeModalBtn || !taskListDiv || !taskForm || !modalTitle || !saveTaskBtn || !taskIdInput || !taskNameInput || !taskDescriptionInput || !taskLinksInput || !taskAssignedBySelect || !taskAssignedToSelect || !taskStartDateInput || !taskDueDateInput || !taskPrioritySelect || !taskStatusSelect || !searchInput || !filterStatusSelect || !filterPrioritySelect || !filterAssignedToSelect) {
                    console.error("Essential Task Management elements missing in container or modal.");
                    if(taskListDiv) taskListDiv.innerHTML = '<p class="no-tasks" style="grid-column: 1 / -1;">Error loading task components.</p>';
                    return { cleanup: () => {} };
                 }

                let tasks = []; let boundCloseOnEscape = null; let boundCloseOnOutsideClick = null; let listeners = []; // Store listeners for cleanup

                const addListener = (element, event, handler) => {
                    if (!element) return;
                    element.addEventListener(event, handler);
                    listeners.push({ element, event, handler });
                };

                 // Populate assignee dropdown
                 const populateAssigneeOptions = (selectElement) => {
                     if (!selectElement) return;
                     selectElement.innerHTML = '<option value="all">All Assignees</option>'; // For filter
                     MOCK_USERS.forEach(user => {
                         const option = document.createElement('option');
                         option.value = user.name;
                         option.textContent = user.name;
                         selectElement.appendChild(option);
                     });
                     const selfAssignedOption = document.createElement('option');
                     selfAssignedOption.value = 'Self Assigned';
                     selfAssignedOption.textContent = 'Self Assigned';
                     selectElement.appendChild(selfAssignedOption);
                 };
                 populateAssigneeOptions(filterAssignedToSelect);
                 populateAssigneeOptions(taskAssignedToSelect); // Populate modal dropdown too
                  // Populate Assigned By dropdown
                 const populateAssignedByOptions = (selectElement) => {
                     if (!selectElement) return;
                     selectElement.innerHTML = ''; // Clear existing
                     MOCK_USERS.forEach(user => {
                         if (user.role === 'admin' || user.role === 'supervisor') { // Example: Only managers assign
                            const option = document.createElement('option');
                            option.value = user.name;
                            option.textContent = user.name;
                            selectElement.appendChild(option);
                         }
                     });
                      const selfAssignedOption = document.createElement('option');
                      selfAssignedOption.value = 'Self Assigned';
                      selfAssignedOption.textContent = 'Self Assigned';
                      selectElement.appendChild(selfAssignedOption);
                 };
                 populateAssignedByOptions(taskAssignedBySelect); // Populate modal dropdown

                const loadTasks = () => { const storedTasks = localStorage.getItem('dashboard_tasks'); if (storedTasks) { try { tasks = JSON.parse(storedTasks); } catch (e) { console.error("Error parsing tasks:", e); tasks = getDefaultTasks(); } } else { tasks = getDefaultTasks(); } renderTasks(); };
                function getDefaultTasks() { return [ { id: 1, name: "Setup Project Environment", description: "Install Node.js, npm packages, and configure.", links: "https://nodejs.org", assignedBy: "Nada Mahmoud", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-20", dueDate: "2024-07-22", priority: "High", status: "In Progress", completionDate: null }, { id: 2, name: "Design UI Mockups", description: "Create mockups for main pages using Figma.", links: "https://figma.com", assignedBy: "Yousef Ahmed", assignedTo: "Esraa Lashin", startDate: "2024-07-21", dueDate: "2024-07-25", priority: "Medium", status: "Pending", completionDate: null }, { id: 3, name: "Develop API Endpoints", description: "Build RESTful APIs.", links: "", assignedBy: "Self Assigned", assignedTo: "Yousef Ahmed", startDate: "2024-07-23", dueDate: "2024-07-30", priority: "High", status: "Pending", completionDate: null }, { id: 4, name: "Client Meeting Prep", description: "Prepare presentation slides.", links: "", assignedBy: "Nada Mahmoud", assignedTo: "Bassant Badr", startDate: "2024-07-28", dueDate: "2024-07-29", priority: "Medium", status: "Pending", completionDate: null }, { id: 5, name: "Review Code Submission", description: "Review 'feature/login' branch.", links: "https://github.com, PR #42", assignedBy: "Self Assigned", assignedTo: "Mohamed Elmenisy", startDate: "2024-07-26", dueDate: "2024-07-26", priority: "Low", status: "Completed", completionDate: "2024-07-25" }, { id: 6, name: "Fix Login Bug (JIRA-123)", description: "Special characters issue.", links: "jira-123", assignedBy: "Yousef Ahmed", assignedTo: "Yousef Ahmed", startDate: "2024-07-15", dueDate: "2024-07-18", priority: "High", status: "In Progress", completionDate: null } ]; }
                const saveTasks = () => { localStorage.setItem('dashboard_tasks', JSON.stringify(tasks)); };
                const formatDate = (dateString) => window.formatDateForDisplay(dateString); // Use global function
                const getCurrentDate = () => { const today = new Date(); return `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`; }; // Format YYYY-MM-DD
                const isOverdue = (task) => { if (task.status === 'Completed' || !task.dueDate) return false; try { const dueDate = new Date(task.dueDate + 'T00:00:00Z'); const today = new Date(); const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate())); if (isNaN(dueDate.getTime())) return false; return dueDate < todayUTC; } catch(e) { console.error("Error checking overdue:", e); return false; } };

                const renderTasks = () => {
                    if (!taskListDiv) return;
                    taskListDiv.innerHTML = '';
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const statusFilter = filterStatusSelect ? filterStatusSelect.value : 'all';
                    const priorityFilter = filterPrioritySelect ? filterPrioritySelect.value : 'all';
                    const assignedToFilter = filterAssignedToSelect ? filterAssignedToSelect.value : 'all';

                    let tasksToDisplay = tasks.filter(task => {
                         const taskStatus = task.status || ''; const taskPriority = task.priority || ''; const taskAssignedTo = task.assignedTo || '';
                         const statusMatch = statusFilter === 'all' || taskStatus === statusFilter;
                         const priorityMatch = priorityFilter === 'all' || taskPriority === priorityFilter;
                         const assignedToMatch = assignedToFilter === 'all' || taskAssignedTo === assignedToFilter;
                         const searchMatch = !searchTerm || (task.name || '').toLowerCase().includes(searchTerm) || (task.description || '').toLowerCase().includes(searchTerm) || (task.links || '').toLowerCase().includes(searchTerm) || (task.assignedTo || '').toLowerCase().includes(searchTerm) || (task.assignedBy || '').toLowerCase().includes(searchTerm);
                         return statusMatch && priorityMatch && assignedToMatch && searchMatch;
                    });

                    // Sort: Pending/In Progress first, then by due date (earliest first), then by priority (High first)
                    tasksToDisplay.sort((a, b) => {
                         const statusOrder = { "Pending": 1, "In Progress": 2, "Completed": 3 };
                         const statusA = statusOrder[a.status] || 4;
                         const statusB = statusOrder[b.status] || 4;
                         if (statusA !== statusB) return statusA - statusB;

                         const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00Z').getTime() : Infinity;
                         const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00Z').getTime() : Infinity;
                         if (isNaN(dateA) && !isNaN(dateB)) return 1; // Put tasks without due dates last
                         if (!isNaN(dateA) && isNaN(dateB)) return -1;
                         if (dateA !== dateB) return dateA - dateB;

                         const priorityOrder = { "High": 3, "Medium": 2, "Low": 1 };
                         const priorityA = priorityOrder[a.priority] || 0;
                         const priorityB = priorityOrder[b.priority] || 0;
                         return priorityB - priorityA; // Higher priority first
                    });

                    if (tasksToDisplay.length === 0) { taskListDiv.innerHTML = '<p class="no-tasks" style="grid-column: 1 / -1;">No tasks found matching your criteria.</p>'; return; }

                    tasksToDisplay.forEach(task => {
                        const taskCard = document.createElement('div'); taskCard.classList.add('task-card'); taskCard.dataset.taskId = task.id; if (task.priority) taskCard.classList.add(`priority-${task.priority}`); if (task.status) taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); if(task.status === 'Completed') taskCard.classList.add('task-completed'); if(isOverdue(task)) taskCard.classList.add('task-overdue');
                        const overdue = isOverdue(task); const overdueText = overdue ? `<span class="overdue-indicator text-danger ms-1">(Overdue!)</span>` : ''; let linksHTML = 'N/A'; if (task.links && task.links.trim()) { /* ... existing links logic ... */ linksHTML=task.links.split(',').map(l=>l.trim()).filter(l=>l).map(link=>{let href=link;let isUrl=false;try{const url=new URL(link.startsWith('http')?link:`http://${link}`);if(url.hostname&&(url.hostname.includes('.')||url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))){isUrl=true;href=url.protocol+"//"+url.hostname+url.pathname+url.search+url.hash;}else{href=link;}}catch(_){isUrl=false;href=link;}const displayText=link.length>35?link.substring(0,32)+'...':link;return isUrl?`<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>`:`<span title="${link}">${displayText}</span>`;}).join(' ');}

                        taskCard.innerHTML = `
                            <h3>${task.name || 'Unnamed'}</h3>
                            ${task.description ? `<p class="description">${task.description}</p>` : ''}
                             <div class="task-meta">
                                 <div><span><strong>To:</strong> ${task.assignedTo || 'N/A'}</span> <span><strong>By:</strong> ${task.assignedBy || 'N/A'}</span></div>
                                <div> <span><strong>Start:</strong> ${formatDate(task.startDate)}</span> <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span> </div>
                                <div> <span><strong>Priority:</strong> ${task.priority || 'N/A'}</span> <span><strong>Status:</strong> <span class="status-badge status-${(task.status || '').replace(/\s+/g, '')}">${task.status || 'N/A'}</span></span> </div>
                                ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''}
                                <div><strong>Links:</strong> <span class="links">${linksHTML}</span></div>
                             </div>
                            <div class="task-actions">
                                <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                                ${task.status === 'Completed' ? `<button class="reopen-btn" title="Reopen"><i class="fas fa-undo"></i></button>` : `<button class="complete-btn" title="Complete"><i class="fas fa-check-circle"></i></button>`}
                            </div>`;

                        const editBtn = taskCard.querySelector('.edit-btn'); if (editBtn) { addListener(editBtn, 'click', (e) => { e.stopPropagation(); openEditModal(task.id); }); }
                        const deleteBtn = taskCard.querySelector('.delete-btn'); if (deleteBtn) { addListener(deleteBtn, 'click', (e) => { e.stopPropagation(); deleteTask(task.id); }); }
                        const completeOrReopenBtn = taskCard.querySelector('.complete-btn, .reopen-btn'); if (completeOrReopenBtn) { addListener(completeOrReopenBtn, 'click', (e) => { e.stopPropagation(); toggleTaskStatus(task.id); }); }
                        taskListDiv.appendChild(taskCard);
                    });
                };

                const showModal = () => { if (!taskModal) return; taskModal.classList.add('active'); document.body.style.overflow = 'hidden'; };
                const hideModal = () => { if (!taskModal) return; taskModal.classList.remove('active'); if (taskForm) taskForm.reset(); if (taskIdInput) taskIdInput.value = ''; if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; document.body.style.overflow = ''; };
                const openAddModal = () => { hideModal(); if (modalTitle) modalTitle.textContent = "Add New Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Save Task"; if (taskStatusSelect) taskStatusSelect.value = "Pending"; if (taskPrioritySelect) taskPrioritySelect.value = "Medium"; showModal(); if (taskNameInput) taskNameInput.focus(); };
                const openEditModal = (id) => { const task = tasks.find(t => t.id === id); if (!task) return; hideModal(); if (modalTitle) modalTitle.textContent = "Edit Task"; if (saveTaskBtn) saveTaskBtn.textContent = "Update Task"; taskIdInput.value = task.id; taskNameInput.value = task.name; taskDescriptionInput.value = task.description || ''; taskLinksInput.value = task.links || ''; taskAssignedBySelect.value = task.assignedBy; taskAssignedToSelect.value = task.assignedTo; taskStartDateInput.value = task.startDate || ''; taskDueDateInput.value = task.dueDate || ''; taskPrioritySelect.value = task.priority; taskStatusSelect.value = task.status; showModal(); taskNameInput.focus(); };
                const handleFormSubmit = (event) => { /* ... existing form submit logic ... */ event.preventDefault();const taskId=taskIdInput.value?parseInt(taskIdInput.value):Date.now();const currentTask=tasks.find(t=>t.id===taskId);const newStatus=taskStatusSelect.value;let completionDate=currentTask?.completionDate||null;if(newStatus==='Completed'){if(!taskIdInput.value||(currentTask&&currentTask.status!=='Completed')){completionDate=getCurrentDate();}}else{completionDate=null;}const startDate=taskStartDateInput.value;const dueDate=taskDueDateInput.value;if(startDate&&dueDate&&new Date(dueDate)<new Date(startDate)){window.showToast("Due Date cannot be before Start Date.","error");taskDueDateInput.focus();return;}const taskData={id:taskId,name:taskNameInput.value.trim(),description:taskDescriptionInput.value.trim(),links:taskLinksInput.value.trim(),assignedBy:taskAssignedBySelect.value,assignedTo:taskAssignedToSelect.value,startDate:startDate||null,dueDate:dueDate||null,priority:taskPrioritySelect.value,status:newStatus,completionDate:completionDate};if(!taskData.name){window.showToast("Task Name is required.","error");taskNameInput.focus();return;}if(taskIdInput.value){const index=tasks.findIndex(task=>task.id===taskData.id);if(index>-1){tasks[index]=taskData;}else{console.warn(`Task ${taskData.id} not found for edit.`);tasks.push(taskData);}}else{tasks.push(taskData);}saveTasks();renderTasks();hideModal(); };
                const deleteTask = (id) => { const taskToDelete = tasks.find(t => t.id === id); window.showConfirmModal(`Delete Task`, `Are you sure you want to delete "${taskToDelete?.name || id}"?`, () => { tasks = tasks.filter(task => task.id !== id); saveTasks(); renderTasks(); window.showToast('Task deleted.', 'success'); }, 'btn-danger'); }; // Use global confirm
                const toggleTaskStatus = (id) => { tasks = tasks.map(task => { if (task.id === id) { if (task.status === 'Completed') { return { ...task, status: 'Pending', completionDate: null }; } else { return { ...task, status: 'Completed', completionDate: getCurrentDate() }; } } return task; }); saveTasks(); renderTasks(); window.showToast('Task status updated.', 'success'); }; // Use global toast

                addListener(addTaskBtn, 'click', openAddModal);
                addListener(closeModalBtn, 'click', hideModal);
                addListener(cancelBtn, 'click', hideModal);
                addListener(taskForm, 'submit', handleFormSubmit);
                const handleOutsideClick = (event) => { if (event.target === taskModal) { hideModal(); } };
                const handleEscapeKey = (event) => { if (event.key === 'Escape' && taskModal && taskModal.classList.contains('active')) { hideModal(); } };
                addListener(taskModal, 'click', handleOutsideClick);
                addListener(document, 'keydown', handleEscapeKey);
                boundCloseOnEscape = handleEscapeKey; // Store for cleanup
                boundCloseOnOutsideClick = handleOutsideClick; // Store for cleanup
                addListener(searchInput, 'input', renderTasks);
                addListener(filterStatusSelect, 'change', renderTasks);
                addListener(filterPrioritySelect, 'change', renderTasks);
                addListener(filterAssignedToSelect, 'change', renderTasks);

                loadTasks();

                const cleanup = () => {
                    console.log("Cleaning Task Management...");
                     // Remove specific listeners added by this feature
                     listeners.forEach(({ element, event, handler }) => {
                         element?.removeEventListener(event, handler);
                     });
                     listeners = [];
                     // Explicitly remove document listeners added by this feature
                      document.removeEventListener('keydown', boundCloseOnEscape);
                      taskModal?.removeEventListener('click', boundCloseOnOutsideClick);
                     // Hide modal if open
                     taskModal?.classList.remove('active');
                    document.body.style.overflow = ''; // Ensure body scroll is restored
                    console.log("Task Management cleanup complete.");
                };
                return { cleanup };
            }

            // --- File Sharing Feature ---
            window.initializeFileSharingFeature = function(container) {
                /* ... (Existing initializeFileSharingFeature content) ... */
                 console.log("Initializing File Sharing Feature...");
                // Scope selectors to the container
                const fileTableBody = container.querySelector('#fileTableBody');
                const fileSearchInput = container.querySelector('#fileSearchInput');
                const fileTypeFilter = container.querySelector('#fileTypeFilter');
                const uploadDateFilter = container.querySelector('#uploadDateFilter');
                const userFilter = container.querySelector('#userFilter');
                const userFilterContainer = container.querySelector('#userFilterContainer');
                const noResultsRow = container.querySelector('#noResultsRow');
                const resetFiltersBtn = container.querySelector('#resetFiltersBtn');
                const recentUploadsSection = container.querySelector('#recentUploadsSection');
                const recentUploadsList = recentUploadsSection?.querySelector('.list-group');

                // Modals are outside the container, use document scope but check existence
                const uploadFileModalEl = document.getElementById('uploadFileModal');
                const filePreviewModalEl = document.getElementById('filePreviewModal');

                if (!fileTableBody || !uploadFileModalEl || !filePreviewModalEl || !recentUploadsList) {
                    console.error("File Sharing essential elements not found!");
                    return { cleanup: () => {} };
                }

                 // Populate user filter dropdown
                 const populateUserFilter = () => {
                     if (!userFilter) return;
                     userFilter.innerHTML = '<option value="" selected>All Users</option>'; // Reset
                     MOCK_USERS.forEach(user => {
                         const option = document.createElement('option');
                         option.value = user.name;
                         option.textContent = user.name;
                         userFilter.appendChild(option);
                     });
                 };
                 populateUserFilter();


                const isAdmin = window.currentUser?.role === 'admin'; // Use global currentUser
                if (isAdmin && userFilterContainer) {
                    userFilterContainer.style.display = 'block';
                } else if(userFilterContainer) {
                    userFilterContainer.style.display = 'none';
                }

                let listeners = []; // Store listeners for cleanup
                 const addListener = (element, event, handler, options = {}) => {
                    if (!element) return;
                    element.addEventListener(event, handler, options);
                    listeners.push({ element, event, handler, options });
                };

                 function applyFilters() {
                     const searchTerm = fileSearchInput.value.toLowerCase().trim();
                     const selectedType = fileTypeFilter.value;
                     const selectedDate = uploadDateFilter.value;
                     const selectedUser = userFilter.value;
                     let hasVisibleRows = false;
                     const rows = fileTableBody.querySelectorAll('tr:not(#noResultsRow)');
                     rows.forEach(row => {
                         const fileNameElement = row.querySelector('.file-name');
                         const uploaderElement = row.querySelector('.uploader-shared');
                         const fileName = fileNameElement ? fileNameElement.textContent.toLowerCase() : '';
                         const fileType = row.dataset.fileType || '';
                         const uploadDate = row.dataset.uploadDate || '';
                         const uploader = row.dataset.uploader || (uploaderElement ? uploaderElement.textContent : '');
                         const nameMatch = searchTerm === '' || fileName.includes(searchTerm);
                         const typeMatch = selectedType === '' || fileType === selectedType;
                         const dateMatch = selectedDate === '' || uploadDate === selectedDate;
                         const userMatch = (!isAdmin || selectedUser === '' || uploader === selectedUser);
                         if (nameMatch && typeMatch && dateMatch && userMatch) { row.style.display = ''; hasVisibleRows = true; } else { row.style.display = 'none'; }
                     });
                     if(noResultsRow) noResultsRow.style.display = hasVisibleRows ? 'none' : '';
                 }

                function resetFilters() {
                     if(fileSearchInput) fileSearchInput.value = '';
                     if(fileTypeFilter) fileTypeFilter.value = '';
                     if(uploadDateFilter) uploadDateFilter.value = '';
                     if(userFilter) userFilter.value = '';
                     applyFilters();
                 }

                function updateRelativeTimes() {
                    if (!recentUploadsSection) return;
                    const timeElements = recentUploadsSection.querySelectorAll('.time-ago');
                    timeElements.forEach(el => {
                        const timestamp = el.closest('li')?.dataset.timestamp;
                        el.textContent = window.timeAgo(timestamp); // Use global timeAgo
                    });
                }

                // Add sample recent uploads dynamically for better time calculation
                const addRecentUploads = () => {
                    recentUploadsList.innerHTML = ''; // Clear existing
                    const uploads = [
                        { name: 'Quarterly_Report_Q1.pdf', type: 'PDF', time: Date.now() - 5 * 60 * 1000 },
                        { name: 'New_Company_Logo.png', type: 'Image', time: Date.now() - 2 * 60 * 60 * 1000 },
                        { name: 'Final_Project_Assets.zip', type: 'Archive', time: Date.now() - 24 * 60 * 60 * 1000 },
                    ];
                    uploads.forEach(upload => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.dataset.timestamp = new Date(upload.time).toISOString();
                        let iconClass = 'fa-file'; let iconColor = 'text-secondary';
                        switch (upload.type) {
                            case 'PDF': iconClass = 'fa-file-pdf'; iconColor = 'text-danger'; break;
                            case 'Image': iconClass = 'fa-file-image'; iconColor = 'text-success'; break;
                            case 'Archive': iconClass = 'fa-file-zipper'; iconColor = 'text-warning'; break;
                        }
                        li.innerHTML = ` <div><i class="fas ${iconClass} file-icon ${iconColor}"></i> ${upload.name}</div> <small class="text-muted time-ago">calculating...</small> `;
                        recentUploadsList.appendChild(li);
                    });
                    updateRelativeTimes(); // Initial update
                };
                addRecentUploads();

                const timeUpdateInterval = setInterval(updateRelativeTimes, 60000); // Update every minute

                // --- Action Button Handler ---
                 const handleTableClick = (event) => {
                    const button = event.target.closest('.action-btn');
                    if (!button) return;
                    if (button.classList.contains('loading')) return;
                    const fileId = button.dataset.fileId;
                    const row = button.closest('tr');
                    const fileNameElement = row?.querySelector('.file-name');
                    const fileName = fileNameElement ? fileNameElement.textContent : 'this file';
                    if (button.classList.contains('download-btn')) {
                        const fileUrl = button.dataset.fileUrl;
                        if (!fileUrl || fileUrl === 'path/to/...') {
                             console.error(`Download failed: URL missing for file ID ${fileId}.`);
                             Swal.fire({ icon: 'error', title: 'Download Error', text: 'Could not download the file. URL is missing.', timer: 2500, showConfirmButton: false }); return;
                        }
                        button.classList.add('loading'); button.disabled = true; console.log(`Download: ID ${fileId}, URL: ${fileUrl}`);
                        try { const link = document.createElement('a'); link.href = fileUrl; link.setAttribute('download', fileName); document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log(`Download initiated for: ${fileName}`); }
                        catch (error) { console.error('Download error:', error); Swal.fire({ icon: 'error', title: 'Download Failed', text: 'An error occurred.' }); }
                        finally { setTimeout(() => { button.classList.remove('loading'); button.disabled = false; }, 500); }
                    } else if (button.classList.contains('delete-btn')) {
                        Swal.fire({ title: 'Are you sure?', html: `Delete file: <br><strong>${fileName}</strong>`, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--success)', cancelButtonColor: 'var(--danger)', confirmButtonText: '<i class="fas fa-check me-1"></i> Yes, delete it!', cancelButtonText: '<i class="fas fa-times me-1"></i> Cancel' }).then((result) => {
                             if (result.isConfirmed) {
                                button.classList.add('loading'); button.disabled = true; console.log(`Delete: ID ${fileId}`);
                                setTimeout(() => {
                                    const deleteSuccess = Math.random() > 0.1;
                                    if (deleteSuccess) { console.log(`Deleted: ${fileId}`); row.style.opacity = '0'; setTimeout(() => { row.remove(); applyFilters(); Swal.fire( 'Deleted!', `"${fileName}" has been deleted.`, 'success' ); }, 300); }
                                    else { console.error(`Failed delete: ${fileId}`); button.classList.remove('loading'); button.disabled = false; Swal.fire( 'Error!', 'Could not delete file.', 'error' ); }
                                }, 1000);
                             }
                         });
                    }
                };
                addListener(fileTableBody, 'click', handleTableClick);

                 // --- Preview Modal Logic ---
                 const previewModalInstance = filePreviewModalEl ? new bootstrap.Modal(filePreviewModalEl) : null;
                 const previewContent = filePreviewModalEl?.querySelector('#previewContent');
                 const previewFileName = filePreviewModalEl?.querySelector('#previewFileName');
                 const previewFileType = filePreviewModalEl?.querySelector('#previewFileType');

                 const handlePreviewShow = (event) => {
                    const button = event.relatedTarget;
                    if (!button || !previewContent || !previewFileName || !previewFileType) return;
                    const fileUrl = button.getAttribute('data-file-url');
                    const fileType = button.getAttribute('data-file-type');
                    const row = button.closest('tr');
                    const fileNameElement = row?.querySelector('.file-name');
                    const fileName = fileNameElement ? fileNameElement.textContent : 'N/A';
                    previewFileName.textContent = `File Name: ${fileName}`;
                    previewFileType.textContent = `Type: ${fileType ? fileType.toUpperCase() : 'N/A'}`;
                    previewContent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; // Spinner
                    if (fileUrl && fileUrl !== 'path/to/...') {
                         setTimeout(() => { // Delay for spinner
                            if (fileType === 'Image') { previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" alt="Preview" style="max-height: 75vh;">`; }
                            else if (fileType === 'PDF') { previewContent.innerHTML = `<object data="${fileUrl}" type="application/pdf" width="100%" height="650px"><p class="text-warning p-4">Preview unavailable. Browser might not support PDF embedding. <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">Download PDF</a></p></object>`; }
                            else { previewContent.innerHTML = `<p class="text-warning p-4">Preview not available for file type (${fileType}).</p>`; }
                        }, 300);
                    } else { previewContent.innerHTML = `<p class="text-danger p-4">Could not load preview. URL missing or invalid.</p>`; }
                 };
                 const handlePreviewHidden = () => { if(previewContent) previewContent.innerHTML = ''; }; // Clear on hide

                addListener(filePreviewModalEl, 'show.bs.modal', handlePreviewShow);
                addListener(filePreviewModalEl, 'hidden.bs.modal', handlePreviewHidden);


                // --- Upload Modal Logic ---
                 const startUploadButton = uploadFileModalEl?.querySelector('#startUploadButton');
                 const uploadProgressContainer = uploadFileModalEl?.querySelector('#uploadProgressContainer');
                 const uploadProgressBar = uploadFileModalEl?.querySelector('#uploadProgressBar');
                 const uploadStatus = uploadFileModalEl?.querySelector('#uploadStatus');
                 const uploadFileName = uploadFileModalEl?.querySelector('#uploadFileName');
                 const uploadPercentage = uploadFileModalEl?.querySelector('#uploadPercentage');
                 const fileInputManual = uploadFileModalEl?.querySelector('#fileInputManual');
                 const fileInputHidden = uploadFileModalEl?.querySelector('#fileInputHidden');
                 const dropZone = uploadFileModalEl?.querySelector('#dropZone');

                const handleUploadStart = () => {
                     if (!startUploadButton || !uploadProgressContainer || !uploadProgressBar || !uploadStatus || !uploadFileName || !uploadPercentage || !fileInputManual || !fileInputHidden) return;
                     const filesToUpload = fileInputManual.files.length > 0 ? fileInputManual.files : fileInputHidden.files;
                     if (filesToUpload.length === 0) { Swal.fire('No File Selected', 'Please select at least one file.', 'warning'); return; }
                     const firstFile = filesToUpload[0];
                     console.log("Starting upload for:", firstFile.name);
                     uploadFileName.textContent = `Uploading: ${firstFile.name}`;
                     uploadProgressContainer.style.display = 'block';
                     uploadProgressBar.style.width = '0%'; uploadProgressBar.classList.remove('bg-success', 'bg-danger'); uploadProgressBar.classList.add('progress-bar-animated');
                     uploadPercentage.textContent = '0%'; uploadStatus.textContent = 'Initializing...'; uploadStatus.className = 'text-muted d-block mt-1';
                     let progress = 0; const interval = setInterval(() => { progress += Math.random() * 15; progress = Math.min(progress, 100); uploadProgressBar.style.width = progress + '%'; uploadProgressBar.setAttribute('aria-valuenow', progress); uploadPercentage.textContent = Math.round(progress) + '%'; if (progress >= 100) { clearInterval(interval); const uploadSuccess = Math.random() > 0.2; uploadProgressBar.classList.remove('progress-bar-animated'); if(uploadSuccess) { uploadStatus.textContent = 'Upload successful!'; uploadStatus.className = 'text-success d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-success'); setTimeout(() => bootstrap.Modal.getInstance(uploadFileModalEl)?.hide(), 1500); } else { uploadStatus.textContent = 'Upload failed. Please try again.'; uploadStatus.className = 'text-danger d-block mt-1 fw-bold'; uploadProgressBar.classList.add('bg-danger'); } fileInputManual.value = ''; fileInputHidden.value = ''; } }, 300);
                 };
                addListener(startUploadButton, 'click', handleUploadStart);

                // Drag and Drop Listeners
                if (dropZone) {
                     addListener(dropZone, 'dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--app-success)'; });
                     addListener(dropZone, 'dragleave', () => { dropZone.style.borderColor = 'var(--app-primary)'; });
                     addListener(dropZone, 'drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--app-primary)'; if (e.dataTransfer.files.length > 0 && fileInputHidden) { fileInputHidden.files = e.dataTransfer.files; dropZone.querySelector('p:last-child').textContent = `${e.dataTransfer.files.length} file(s) selected.`; } });
                     addListener(dropZone, 'click', () => fileInputHidden?.click());
                 }
                 if (fileInputHidden) {
                     addListener(fileInputHidden, 'change', () => { if(fileInputHidden.files.length > 0 && dropZone) dropZone.querySelector('p:last-child').textContent = `${fileInputHidden.files.length} file(s) selected.`; });
                 }
                 if (fileInputManual) {
                     addListener(fileInputManual, 'change', () => { if (fileInputManual.files.length > 0 && dropZone) { dropZone.querySelector('p:last-child').textContent = 'Or drag & drop files here'; if(fileInputHidden) fileInputHidden.value = ''; } });
                 }

                // Filter Listeners
                addListener(fileSearchInput, 'input', applyFilters);
                addListener(fileTypeFilter, 'change', applyFilters);
                addListener(uploadDateFilter, 'change', applyFilters);
                addListener(userFilter, 'change', applyFilters);
                addListener(resetFiltersBtn, 'click', resetFilters);

                // Initial call for filters if needed
                applyFilters();

                const cleanup = () => {
                    console.log("Cleaning up File Sharing...");
                    clearInterval(timeUpdateInterval);
                    listeners.forEach(({ element, event, handler, options }) => {
                         element?.removeEventListener(event, handler, options);
                     });
                    listeners = [];
                    // Close modals if open
                    bootstrap.Modal.getInstance(uploadFileModalEl)?.hide();
                    bootstrap.Modal.getInstance(filePreviewModalEl)?.hide();
                    // Remove modal backdrops if they linger
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    console.log("File Sharing cleanup complete.");
                };
                return { cleanup };
            }

             // --- Project Tracking Feature ---
             window.initializeProjectTrackingFeature = function(container) {
                /* ... (Existing initializeProjectTrackingFeature content) ... */
                 console.log("Initializing Project Tracking Feature...");
                 // Scoped Selectors
                 const sectionContainer = container.querySelector('#project-tracking-section');
                 if (!sectionContainer) return { cleanup: () => {} }; // Essential container
                 const statusFilter = sectionContainer.querySelector('#project-status-filter');
                 const teamFilter = sectionContainer.querySelector('#project-team-filter');
                 const priorityFilter = sectionContainer.querySelector('#project-priority-filter');
                 const resetFiltersBtn = sectionContainer.querySelector('#resetProjectFiltersBtn');
                 const tableBody = sectionContainer.querySelector('#projectTableBody');
                 const paginationControls = sectionContainer.querySelector('#projectPaginationControls');
                 const deadlinesList = sectionContainer.querySelector('#upcomingDeadlinesList');
                 const tableHeaders = sectionContainer.querySelectorAll("#projectTrackingTable th[data-sort-by]");
                 const projectStatusPieChartEl = sectionContainer.querySelector('#projectStatusPieChart');
                 const projectProgressLineChartEl = sectionContainer.querySelector('#projectProgressLineChart');

                 if (!tableBody || !projectStatusPieChartEl || !projectProgressLineChartEl) {
                     console.error("Essential Project Tracking elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 // Populate team filter dropdown
                 const populateTeamFilter = () => {
                     if (!teamFilter) return;
                     teamFilter.innerHTML = '<option value="" selected>All Teams/Members</option>'; // Reset
                     MOCK_USERS.forEach(user => {
                         const option = document.createElement('option');
                         option.value = user.name;
                         option.textContent = user.name;
                         teamFilter.appendChild(option);
                     });
                 };
                 populateTeamFilter();

                 let projectData = []; let filteredData = []; let currentPage = 1; const rowsPerPage = 5; let currentSortColumn = 'endDate'; let currentSortDirection = 'asc';
                 let statusPieChartInstance = null; let progressLineChartInstance = null;
                 let listeners = [];

                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 const formatDate = (dateString) => window.formatDateForDisplay(dateString); // Use global
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                 const rgbaColor = (c, alpha) => { if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; };
                 function getStatusBadgeClass(status) { switch (status?.toLowerCase()) { case 'completed': return 'status-completed'; case 'in progress': return 'status-inprogress'; case 'delayed': return 'status-delayed'; case 'pending': return 'status-pending'; default: return ''; } }
                 function getPriorityBadgeClass(priority) { switch (priority?.toLowerCase()) { case 'high': return 'priority-high'; case 'medium': return 'priority-medium'; case 'low': return 'priority-low'; default: return ''; } }
                 function getProgressBgClass(progress) { if (progress >= 80) return 'bg-progress-high'; if (progress >= 50) return 'bg-progress-medium'; return 'bg-progress-low'; }
                 function getProgressTextColor(progress) { return (progress >= 50 && progress < 80) ? '#212529' : '#fff'; }

                function renderProjectStatusPieChart(data) {
                     const ctx = projectStatusPieChartEl.getContext('2d');
                     if (!ctx) return;
                     const statusCounts = data.reduce((acc, project) => { acc[project.status] = (acc[project.status] || 0) + 1; return acc; }, {});
                     const labels = Object.keys(statusCounts);
                     const chartData = Object.values(statusCounts);
                     const backgroundColors = labels.map(label => { switch (label.toLowerCase()) { case 'completed': return getCssVar('--chart-green'); case 'in progress': return getCssVar('--chart-blue'); case 'delayed': return getCssVar('--chart-orange'); case 'pending': return getCssVar('--chart-gray'); default: return getCssVar('--app-secondary'); } });
                     const config = { type: 'pie', data: { labels: labels, datasets: [{ data: chartData, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } };
                     if (statusPieChartInstance) statusPieChartInstance.destroy();
                     statusPieChartInstance = new Chart(ctx, config);
                 }
                 function renderProjectProgressLineChart() { // Keeps simulated data
                      const ctx = projectProgressLineChartEl.getContext('2d'); if (!ctx) return;
                      const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']; const data = [20, 35, 50, 60, 75, 80]; // SIMULATED
                      const config = { type: 'line', data: { labels: labels, datasets: [{ label: 'Overall Progress %', data: data, borderColor: getCssVar('--chart-blue'), backgroundColor: rgbaColor(getCssVar('--chart-blue'), 0.1), fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } };
                      if (progressLineChartInstance) progressLineChartInstance.destroy(); progressLineChartInstance = new Chart(ctx, config);
                 }
                 function renderUpcomingDeadlines(data) {
                     if (!deadlinesList) return;
                     deadlinesList.innerHTML = ''; const today = new Date(); today.setHours(0, 0, 0, 0); const sevenDaysFromNow = new Date(today); sevenDaysFromNow.setDate(today.getDate() + 7);
                     const upcoming = data.filter(project => { if (!project.endDate || project.status === 'Completed') return false; const endDate = new Date(project.endDate + 'T00:00:00'); return endDate >= today && endDate <= sevenDaysFromNow; }).sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
                     if (upcoming.length === 0) { deadlinesList.innerHTML = '<li class="text-muted text-center pt-5">No upcoming deadlines found.</li>'; return; }
                     upcoming.forEach(project => { const li = document.createElement('li'); const endDate = new Date(project.endDate + 'T00:00:00'); const diffTime = Math.abs(endDate - today); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const daysLeftText = diffDays === 0 ? 'Due Today' : `${diffDays} day${diffDays > 1 ? 's' : ''} left`; li.innerHTML = `<span>${project.name}</span><span class="text-end"><span class="deadline me-2">${formatDate(project.endDate)}</span><span class="days-left">(${daysLeftText})</span></span>`; deadlinesList.appendChild(li); });
                 }
                 function renderTable() {
                     tableBody.innerHTML = '';
                      if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-muted fst-italic">No projects found matching criteria.</td></tr>`; renderPagination(); return; }
                     const totalItems = filteredData.length; const totalPages = Math.ceil(totalItems / rowsPerPage); if (currentPage > totalPages && totalPages > 0) currentPage = totalPages; else if (currentPage < 1) currentPage = 1; const startIndex = (currentPage - 1) * rowsPerPage; const endIndex = startIndex + rowsPerPage; const pageData = filteredData.slice(startIndex, endIndex);
                     pageData.forEach(project => {
                         const row = document.createElement('tr');
                         const statusClass = getStatusBadgeClass(project.status); const priorityClass = getPriorityBadgeClass(project.priority); const progressBg = getProgressBgClass(project.progress); const progressTextClr = getProgressTextColor(project.progress);
                         const teamHtml = project.assignedTeam.map(member => `<span>${member}</span>`).join('');
                         row.innerHTML = ` <td><div class="project-name">${project.name}</div></td> <td>${formatDate(project.startDate)}</td> <td>${formatDate(project.endDate)}</td> <td class="assigned-team">${teamHtml}</td> <td class="text-center progress-cell"> <div class="progress" role="progressbar" aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100"> <div class="progress-bar ${progressBg}" style="width: ${project.progress}%; color: ${progressTextClr};">${project.progress}%</div> </div> </td> <td class="text-center"><span class="status-badge ${statusClass}">${project.status}</span></td> <td class="text-center"><span class="priority-badge ${priorityClass}">${project.priority}</span></td> <td class="notes-cell" title="${project.notes || ''}">${project.notes || '-'}</td> `;
                         tableBody.appendChild(row);
                     });
                     renderPagination(); updateSortIcons();
                 }
                 function renderPagination() { if(!paginationControls) return; paginationControls.innerHTML = ''; const totalItems = filteredData.length; if (totalItems <= rowsPerPage) return; const totalPages = Math.ceil(totalItems / rowsPerPage); const createButton = (text, page, disabled = false) => { const button = document.createElement('button'); button.className = 'btn btn-sm btn-outline-secondary'; button.innerHTML = text; button.disabled = disabled; addListener(button, 'click', () => { currentPage = page; renderTable(); }); return button; }; paginationControls.appendChild(createButton('<i class="fas fa-chevron-left"></i> Prev', currentPage - 1, currentPage === 1)); const pageInfo = document.createElement('span'); pageInfo.className = 'pt-page-info'; pageInfo.innerHTML = `Page <span class="pt-current-page">${currentPage}</span> of ${totalPages}`; paginationControls.appendChild(pageInfo); paginationControls.appendChild(createButton('Next <i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages)); }
                 function updateSortIcons() { tableHeaders.forEach(th => { const icon = th.querySelector('.sort-icon'); if (!icon) return; const columnKey = th.getAttribute('data-sort-by'); icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down', 'active'); if (columnKey === currentSortColumn) { icon.classList.add(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'); icon.classList.add('active'); } else { icon.classList.add('fa-sort'); } }); }
                 function handleSortClick(event) { const header = event.currentTarget; const columnKey = header.getAttribute('data-sort-by'); if (!columnKey) return; if (currentSortColumn === columnKey) { currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc'; } else { currentSortColumn = columnKey; currentSortDirection = 'asc'; } applyFiltersAndSort(); }
                 function applyFiltersAndSort() {
                     const statusValue = statusFilter.value; const teamValue = teamFilter.value; const priorityValue = priorityFilter.value;
                     let tempFilteredData = projectData.filter(project => { const statusMatch = !statusValue || project.status === statusValue; const teamMatch = !teamValue || project.assignedTeam.includes(teamValue); const priorityMatch = !priorityValue || project.priority === priorityValue; return statusMatch && teamMatch && priorityMatch; });
                     tempFilteredData.sort((a, b) => { let valA = a[currentSortColumn]; let valB = b[currentSortColumn]; if (currentSortColumn === 'startDate' || currentSortColumn === 'endDate') { valA = new Date(valA); valB = new Date(valB); } else if (currentSortColumn === 'progress') { valA = Number(valA); valB = Number(valB); } else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } else if (currentSortColumn === 'priority') { const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 }; valA = priorityOrder[a.priority] || 0; valB = priorityOrder[b.priority] || 0; } if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1; if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1; return 0; });
                     filteredData = tempFilteredData;
                     currentPage = 1;
                     renderTable(); renderProjectStatusPieChart(filteredData); renderUpcomingDeadlines(filteredData); renderProjectProgressLineChart();
                 }
                 function resetFilters() { statusFilter.value = ''; teamFilter.value = ''; priorityFilter.value = ''; applyFiltersAndSort(); }

                 function fetchInitialData() {
                     setTimeout(() => {
                         // Simulate API response
                         projectData = [
                             { id: 1, name: "Website Overhaul", startDate: "2024-03-01", endDate: "2024-07-30", assignedTeam: ["Mohamed Elmenisy", "Esraa Lashin"], progress: 75, status: "In Progress", priority: "High", notes: "Phase 1 complete, focusing on backend." },
                             { id: 2, name: "Mobile App Dev", startDate: "2024-04-15", endDate: "2024-09-15", assignedTeam: ["Yousef Ahmed", "Bassant Badr"], progress: 40, status: "In Progress", priority: "High", notes: "Core features implemented." },
                             { id: 3, name: "Marketing Campaign Q3", startDate: "2024-07-01", endDate: "2024-09-30", assignedTeam: ["Bassant Badr", "Nada Mahmoud"], progress: 15, status: "Pending", priority: "Medium", notes: "Planning stage." },
                             { id: 4, name: "Server Upgrade", startDate: "2024-05-20", endDate: "2024-06-10", assignedTeam: ["Yousef Ahmed"], progress: 100, status: "Completed", priority: "Medium", notes: "Completed ahead of schedule." },
                             { id: 5, name: "UI Kit Development", startDate: "2024-06-01", endDate: "2024-08-15", assignedTeam: ["Esraa Lashin"], progress: 60, status: "In Progress", priority: "Low", notes: "Delayed due to scope change." },
                             { id: 6, name: "API Documentation", startDate: "2024-07-10", endDate: "2024-07-25", assignedTeam: ["Mohamed Elmenisy"], progress: 90, status: "Delayed", priority: "Medium", notes: "Awaiting final review." },
                         ];
                         applyFiltersAndSort();
                         console.log("Project Tracking data loaded.");
                     }, 500);
                 }

                 tableHeaders.forEach(th => addListener(th, 'click', handleSortClick));
                 addListener(statusFilter, 'change', applyFiltersAndSort);
                 addListener(teamFilter, 'change', applyFiltersAndSort);
                 addListener(priorityFilter, 'change', applyFiltersAndSort);
                 addListener(resetFiltersBtn, 'click', resetFilters);

                 fetchInitialData();

                 const cleanup = () => {
                     console.log("Cleaning up Project Tracking...");
                     if (statusPieChartInstance) statusPieChartInstance.destroy();
                     if (progressLineChartInstance) progressLineChartInstance.destroy();
                     statusPieChartInstance = null; progressLineChartInstance = null;
                     listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                     listeners = [];
                     delete window.projectTrackingInstance; // Remove global instance
                     console.log("Project Tracking cleanup complete.");
                 };
                  // Store instance globally for date format updates (optional, better pattern exists)
                 window.projectTrackingInstance = { renderTable, renderUpcomingDeadlines, filteredData };
                 return { cleanup };
            }

             // --- Reports & Analytics Feature ---
             window.initializeReportsAnalyticsFeature = function(container) {
                 /* ... (Existing initializeReportsAnalyticsFeature content) ... */
                console.log("Initializing Reports & Analytics Feature...");
                 // --- Scoped Selectors ---
                 const sectionContainer = container.querySelector('#reports-analytics-section');
                 if (!sectionContainer) return { cleanup: () => {} };
                 const filterForm = sectionContainer.querySelector('#reports-filter-form');
                 const startDateInput = sectionContainer.querySelector('#report-start-date');
                 const endDateInput = sectionContainer.querySelector('#report-end-date');
                 const periodBtnGroup = sectionContainer.querySelector('#periodBtnGroup');
                 const tableBody = sectionContainer.querySelector('#employeeSummaryTableBody');
                 const exportPdfBtn = sectionContainer.querySelector('#exportPdfBtn');
                 const exportExcelBtn = sectionContainer.querySelector('#exportExcelBtn');
                 const taskCompletionChartEl = sectionContainer.querySelector('#taskCompletionChart');
                 const overdueTasksChartEl = sectionContainer.querySelector('#overdueTasksChart');
                 const filesUploadedChartEl = sectionContainer.querySelector('#filesUploadedChart');
                 const performanceComparisonChartEl = sectionContainer.querySelector('#performanceComparisonChart');

                 if (!filterForm || !startDateInput || !endDateInput || !tableBody || !taskCompletionChartEl || !overdueTasksChartEl || !filesUploadedChartEl || !performanceComparisonChartEl) {
                     console.error("Essential Reports & Analytics elements missing!");
                     if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-danger">Error loading components.</td></tr>`;
                     return { cleanup: () => {} };
                 }

                 // --- Sample Data & State ---
                 const employeePerformanceData = [ { id: 1, name: "Mohamed Elmenisy", tasksCompleted: 85, tasksOverdue: 3, filesUploaded: 15, activityScore: 9.2, performanceMetrics: [8.5, 9, 7, 9.2, 8.4] }, { id: 3, name: "Yousef Ahmed", tasksCompleted: 70, tasksOverdue: 8, filesUploaded: 8, activityScore: 7.5, performanceMetrics: [7, 6, 6, 7.5, 6.6] }, { id: 4, name: "Esraa Lashin", tasksCompleted: 45, tasksOverdue: 12, filesUploaded: 5, activityScore: 6.1, performanceMetrics: [4.5, 5, 5, 6.1, 5.1] }, { id: 5, name: "Bassant Badr", tasksCompleted: 91, tasksOverdue: 2, filesUploaded: 18, activityScore: 9.5, performanceMetrics: [9.1, 9.5, 8, 9.5, 9.0] }, ];
                 let currentFilteredData = [...employeePerformanceData];
                 let taskCompletionChartInstance = null; let overdueTasksChartInstance = null; let filesUploadedChartInstance = null; let performanceComparisonChartInstance = null;
                 let listeners = [];

                 // --- Utility Functions ---
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };
                 function formatDateInput(date) { const d = new Date(date); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const year = d.getFullYear(); return `${year}-${month}-${day}`; }
                 function formatReportDate(dateString) { if (!dateString) return 'N/A'; const parts = dateString.split('-'); if (parts.length === 3) { return `${parts[1]}/${parts[2]}/${parts[0]}`; } return dateString; }
                 const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
                 const rgbaColor = (c, alpha) => { if (c.startsWith('rgba')) return c.replace(/[\d\.]+\)$/g, `${alpha})`); if (c.startsWith('#')) { const bigint = parseInt(c.slice(1), 16); const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } return c; };

                 // --- Chart Rendering ---
                 function renderTaskCompletionChart(data) { const ctx = taskCompletionChartEl.getContext('2d'); if (!ctx) return; const avgCompletion = data.length > 0 ? Math.round(data.reduce((sum, emp) => sum + emp.tasksCompleted, 0) / data.length) : 0; const chartData = { labels: ['Completed', 'Remaining'], datasets: [{ data: [avgCompletion, 100 - avgCompletion], backgroundColor: [ getCssVar('--chart-green'), '#e9ecef'], borderColor: ['#ffffff'], borderWidth: 2 }] }; if (taskCompletionChartInstance) taskCompletionChartInstance.destroy(); taskCompletionChartInstance = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` } } } } }); }
                 function renderOverdueTasksChart(data) { const ctx = overdueTasksChartEl.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const overdueData = data.map(emp => emp.tasksOverdue); if (overdueTasksChartInstance) overdueTasksChartInstance.destroy(); overdueTasksChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Overdue Tasks', data: overdueData, backgroundColor: getCssVar('--chart-red'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 2 } } }, plugins: { legend: { display: false } } } }); }
                 function renderFilesUploadedChart(data) { const ctx = filesUploadedChartEl.getContext('2d'); if (!ctx) return; const labels = data.map(emp => emp.name); const filesData = data.map(emp => emp.filesUploaded); if (filesUploadedChartInstance) filesUploadedChartInstance.destroy(); filesUploadedChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Files Uploaded', data: filesData, backgroundColor: getCssVar('--chart-blue'), borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } } }); }
                 function renderPerformanceComparisonChart(data) { const ctx = performanceComparisonChartEl.getContext('2d'); if (!ctx) return; const labels = ['Completion', 'Timeliness', 'Files Mgmt', 'Activity', 'Overall Score']; const datasets = data.map((emp, index) => { const metricsData = emp.performanceMetrics || [ emp.tasksCompleted / 10, 10 - (emp.tasksOverdue / 2), emp.filesUploaded / 2, emp.activityScore, ((emp.tasksCompleted / 10) + (10 - (emp.tasksOverdue / 2)) + (emp.filesUploaded / 2) + emp.activityScore) / 4]; const clampedData = metricsData.map(score => Math.max(0, Math.min(10, score || 0))); const colors = [getCssVar('--chart-blue'), getCssVar('--chart-green'), getCssVar('--chart-purple'), getCssVar('--chart-orange'), getCssVar('--chart-cyan'), getCssVar('--chart-red')]; const color = colors[index % colors.length]; const bgFill = rgbaColor(color, getCssVar('--chart-radar-fill-opacity')); return { label: emp.name, data: clampedData, fill: true, backgroundColor: bgFill, borderColor: color, pointBackgroundColor: color, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: color } }); if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy(); performanceComparisonChartInstance = new Chart(ctx, { type: 'radar', data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, elements: { line: { borderWidth: 2 } }, scales: { r: { angleLines: { display: true, color: '#efefef'}, grid: { color: '#efefef'}, suggestedMin: 0, suggestedMax: 10, pointLabels: { font: { size: 10 } }, ticks: { backdropColor: 'white', stepSize: 2 } } }, plugins: { legend: { position: 'top' } } } }); }

                 // --- Table Rendering ---
                 function renderEmployeeSummaryTable(data) {
                     tableBody.innerHTML = ''; if (!data || data.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted fst-italic">No employee data found.</td></tr>`; return; }
                     data.forEach((emp) => {
                         const row = document.createElement('tr'); let scoreBadgeClass = 'text-bg-secondary'; let scoreText = 'Average'; if (emp.activityScore >= 9) { scoreBadgeClass = 'text-bg-success'; scoreText = 'Excellent'; } else if (emp.activityScore >= 7.5) { scoreBadgeClass = 'text-bg-warning'; scoreText = 'Good'; } else if (emp.activityScore < 6.5) { scoreBadgeClass = 'text-bg-danger'; scoreText = 'Needs Improv.'; }
                         const completion = emp.tasksCompleted; let progressBgClass = ''; let progressTextColor = '#fff'; if (completion >= 80) { progressBgClass = 'bg-progress-high'; } else if (completion >= 50) { progressBgClass = 'bg-progress-medium'; progressTextColor = '#212529'; } else { progressBgClass = 'bg-progress-low'; }
                         row.innerHTML = ` <td><div class="employee-name">${emp.name}</div></td> <td class="text-center"> <div class="progress" role="progressbar" aria-label="Completion rate for ${emp.name}" aria-valuenow="${completion}" aria-valuemin="0" aria-valuemax="100"> <div class="progress-bar ${progressBgClass}" style="width: ${completion}%; color: ${progressTextColor};"> ${completion}% </div> </div> </td> <td class="text-center"><span class="metric-value ${emp.tasksOverdue === 0 ? 'text-success' : emp.tasksOverdue <= 5 ? 'text-warning' : 'text-danger'}">${emp.tasksOverdue}</span></td> <td class="text-center"><span class="metric-value text-info">${emp.filesUploaded}</span></td> <td class="text-center"><span class="badge ${scoreBadgeClass}">${scoreText}</span></td> `;
                         tableBody.appendChild(row);
                     });
                 }

                 // --- Filtering & Export ---
                 function applyFilters() { const startDate = startDateInput.value; const endDate = endDateInput.value; console.log("Reports: Applying filters for period:", startDate, "to", endDate); currentFilteredData = [...employeePerformanceData]; renderTaskCompletionChart(currentFilteredData); renderOverdueTasksChart(currentFilteredData); renderFilesUploadedChart(currentFilteredData); renderPerformanceComparisonChart(currentFilteredData); renderEmployeeSummaryTable(currentFilteredData); }
                 function setPeriodDates(period) { const today = new Date(); let startDate, endDate = new Date(); switch (period) { case 'day': startDate = new Date(today); break; case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break; case 'week': default: const firstDayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ...
                    const diff = today.getDate() - firstDayOfWeek + (firstDayOfWeek === 0 ? -6 : 1); // Adjust when Sunday is the first day
                    startDate = new Date(new Date(today).setDate(diff)); break; } startDateInput.value = formatDateInput(startDate); endDateInput.value = formatDateInput(endDate); applyFilters(); }
                 function generateCsv(tableElement, filename = 'report.csv') { let csv = []; const rows = tableElement.querySelectorAll("thead tr, tbody tr"); for (let i = 0; i < rows.length; i++) { const row = [], cols = rows[i].querySelectorAll("td, th"); for (let j = 0; j < cols.length; j++) { let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/(\s\s)/gm, " ").trim(); if (cols[j].querySelector('.progress')) { const progressBar = cols[j].querySelector('.progress-bar'); data = progressBar ? progressBar.innerText.trim() : '0%'; } data = data.replace(/"/g, '""'); if (data.includes(',')) data = `"${data}"`; row.push(data); } csv.push(row.join(",")); } const csvFile = new Blob([csv.join("\n")], { type: "text/csv" }); const downloadLink = document.createElement("a"); downloadLink.download = filename; downloadLink.href = window.URL.createObjectURL(csvFile); downloadLink.style.display = "none"; document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink); }
                 function generatePdf(tableElement, filename = 'report.pdf') { if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') { alert('jsPDF library is not loaded.'); return; } const { jsPDF } = jspdf; const doc = new jsPDF({ orientation: 'landscape' }); const startDateValue = startDateInput.value; const endDateValue = endDateInput.value; const startDateFormatted = formatReportDate(startDateValue); const endDateFormatted = formatReportDate(endDateValue); const dateRangeText = `Period: ${startDateFormatted} - ${endDateFormatted}`; const reportTitle = "Employee Performance Report"; doc.setFontSize(16); doc.text(reportTitle, 14, 16); doc.setFontSize(10); doc.setTextColor(100); doc.text(dateRangeText, 14, 22); doc.setTextColor(0); if (typeof doc.autoTable !== 'function') { alert('jsPDF AutoTable plugin is not loaded.'); return; } const head = [['Employee', 'Completion (%)', 'Overdue', 'Files', 'Score']]; const body = []; const rows = tableElement.querySelectorAll("tbody tr"); rows.forEach(row => { const rowData = []; const cells = row.querySelectorAll("td"); rowData.push(cells[0] ? cells[0].innerText.trim() : ''); rowData.push(cells[1] ? cells[1].querySelector('.progress-bar')?.innerText.trim() || '0%' : '0%'); rowData.push(cells[2] ? cells[2].innerText.trim() : '0'); rowData.push(cells[3] ? cells[3].innerText.trim() : '0'); rowData.push(cells[4] ? cells[4].querySelector('.badge')?.innerText.trim() || '' : ''); body.push(rowData); }); const tableStartY = 28; doc.autoTable({ head: head, body: body, startY: tableStartY, theme: 'grid', styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' }, columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 'auto', halign: 'center'}, 2: { cellWidth: 'auto', halign: 'center'}, 3: { cellWidth: 'auto', halign: 'center'}, 4: { cellWidth: 'auto', halign: 'center'} } }); doc.save(filename); }

                 // --- Initialization & Listeners ---
                 setPeriodDates('week');
                 addListener(filterForm, 'submit', (event) => { event.preventDefault(); applyFilters(); });
                 addListener(periodBtnGroup, 'change', (event) => { if (event.target.name === 'period') { setPeriodDates(event.target.value); } });
                 addListener(exportPdfBtn, 'click', () => { const table = sectionContainer.querySelector('#employeeSummaryTable'); if (table) { generatePdf(table, `Employee_Summary_${formatDateInput(new Date())}.pdf`); } else { alert('Summary table not found.'); } });
                 addListener(exportExcelBtn, 'click', () => { const table = sectionContainer.querySelector('#employeeSummaryTable'); if (table) { generateCsv(table, `Employee_Summary_${formatDateInput(new Date())}.csv`); } else { alert('Summary table not found.'); } });
                 applyFilters(); // Initial Render

                 const cleanup = () => {
                    console.log("Cleaning up Reports & Analytics...");
                    // Destroy charts
                    if (taskCompletionChartInstance) taskCompletionChartInstance.destroy();
                    if (overdueTasksChartInstance) overdueTasksChartInstance.destroy();
                    if (filesUploadedChartInstance) filesUploadedChartInstance.destroy();
                    if (performanceComparisonChartInstance) performanceComparisonChartInstance.destroy();
                    taskCompletionChartInstance = null; overdueTasksChartInstance = null; filesUploadedChartInstance = null; performanceComparisonChartInstance = null;
                    // Remove listeners
                    listeners.forEach(({ element, event, handler, options }) => { element?.removeEventListener(event, handler, options); });
                    listeners = [];
                    console.log("Reports & Analytics cleanup complete.");
                 };
                 return { cleanup };
             }

            // --- Team Members Feature (Defined globally) ---
            window.getTeamMembersHTML = function() {
                 const addMemberBtnHTML = currentUser.role === 'admin' ? `<button class="btn btn-primary add-team-member-btn"><i class="fas fa-user-plus"></i> Add Member</button>` : '';
                 const container = document.createElement('div');
                 container.innerHTML = `
                 <div class="team-members-section">
                     <div class="team-members-section-header">
                        <h2>Team Members</h2>
                        ${addMemberBtnHTML}
                     </div>
                     <div class="team-content-area">
                         <div class="team-filter">
                             <input type="text" id="teamSearchInputFeature" placeholder="Search team by name, email, or role..." aria-label="Search team members">
                         </div>
                         <div class="team-members-list team-list-display" id="teamListContainerFeature">
                             <p style="color: var(--gray);">Loading team members...</p>
                         </div>
                     </div>
                 </div>
                 `;
                 return container; // Return the container element
             }
            window.initializeTeamMembersFeature = function(container) {
                 /* ... (Existing initializeTeamMembersFeature content) ... */
                 console.log("Initializing Team Members Feature...");
                 const searchInput = container.querySelector('#teamSearchInputFeature');
                 const teamListContainer = container.querySelector('#teamListContainerFeature');
                 const addMemberBtn = container.querySelector('.add-team-member-btn');

                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };


                 function filterTeamMembers() {
                     const filterText = searchInput.value.toLowerCase().trim();
                     const memberCards = teamListContainer.querySelectorAll('.team-member-card');

                     memberCards.forEach(card => {
                         const name = (card.dataset.name || '').toLowerCase();
                         const role = (card.dataset.role || '').toLowerCase();
                         const email = (card.dataset.email || '').toLowerCase();
                         const isMatch = name.includes(filterText) || role.includes(filterText) || email.includes(filterText);
                         card.classList.toggle('hidden-by-filter', !isMatch);
                     });
                 }

                 window.loadTeamMembers(container); // Load members into the feature view

                 addListener(searchInput, 'input', filterTeamMembers);
                 if (addMemberBtn) addListener(addMemberBtn, 'click', () => openMemberModal()); // Use global function


                 const cleanup = () => {
                     console.log("Cleaning up Team Members feature listeners...");
                     listeners.forEach(({ element, event, handler, options }) => {
                         element?.removeEventListener(event, handler, options);
                     });
                     listeners = [];
                 };

                 return { cleanup };
             }

            // --- Projects Feature (Defined globally) ---
            window.getProjectsHTML = function() {
                 const addProjectBtnHTML = (currentUser.role === 'admin' || currentUser.role === 'supervisor')
                    ? `<button class="btn add-project-btn" id="addProjectBtnFeature"> <i class="fas fa-plus-circle"></i> Add Project </button>`
                    : '';

                 const container = document.createElement('div');
                 container.innerHTML = `
                 <section id="projects-section">
                     <div class="projects-header">
                         <div class="projects-title-wrapper"><h2>Projects</h2></div>
                         <div class="project-controls">
                             <input type="search" placeholder="Search Projects..." class="project-search-input" id="projectSearchInputFeature">
                             <select class="project-filter-select" id="projectFilterSelectFeature">
                                 <option value="all">All Statuses</option>
                                 <option value="active">Active</option>
                                 <option value="in-progress">In Progress</option>
                                 <option value="completed">Completed</option>
                                 <option value="pending">Pending</option>
                             </select>
                             ${addProjectBtnHTML}
                         </div>
                     </div>
                     <div class="projects-list" id="projectsListContainerFeature">
                         <p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">Loading projects...</p>
                     </div>
                 </section>
                 `;
                 return container; // Return container element
             }
             window.renderProjects = function(container) { // Made global
                 const projectsListContainer = container.querySelector('#projectsListContainerFeature');
                 if (!projectsListContainer) return;

                 const searchInput = container.querySelector('#projectSearchInputFeature');
                 const filterSelect = container.querySelector('#projectFilterSelectFeature');
                 const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                 const selectedStatus = filterSelect ? filterSelect.value : 'all';

                 projectsListContainer.innerHTML = ''; // Clear previous list

                 let projectsToDisplay = MOCK_PROJECTS_DATA.filter(project => {
                     const statusMatch = (selectedStatus === 'all' || project.status === selectedStatus);
                     const searchMatch = (
                         project.name.toLowerCase().includes(searchTerm) ||
                         (project.participants || '').toLowerCase().includes(searchTerm) ||
                         project.status.toLowerCase().includes(searchTerm)
                     );
                     return statusMatch && searchMatch;
                 });

                  if (projectsToDisplay.length === 0) {
                     projectsListContainer.innerHTML = '<p style="color: var(--gray); grid-column: 1 / -1; text-align: center; padding: 2rem;">No projects found matching your criteria.</p>';
                     return;
                  }

                 projectsToDisplay.forEach(project => {
                     const card = document.createElement('div');
                     card.classList.add('project-card');
                     card.dataset.projectId = project.id;
                     card.dataset.status = project.status;
                     card.dataset.participants = project.participants;

                     const participantsHTML = (project.participants || '').split('|')
                        .map(p => p.trim())
                        .filter(p => p)
                        .map(p => `<span>${p}</span>`).join(' ');

                     const canEdit = project.editable !== false; // Default to true if undefined
                     const canDelete = currentUser.role === 'admin'; // Only admin can delete (example permission)

                     card.innerHTML = `
                         <div class="project-card-image" style="background-image: url('${project.img || 'placeholder.jpg'}');"></div>
                         <div class="project-card-body">
                             <h3 class="project-name">${project.name}</h3>
                              <span class="project-status status-${project.status}">${project.status.replace('-', ' ')}</span>
                              <div class="progress-bar-container" title="Progress: ${project.progress}%">
                                 <div class="progress-bar" style="width: ${project.progress}%;">${project.progress > 5 ? project.progress + '%' : ''}</div>
                             </div>
                             <div class="project-info project-participants">
                                 <i class="fas fa-users"></i>
                                 <div class="participant-list">${participantsHTML || 'N/A'}</div>
                             </div>
                             <div class="project-info project-dates">
                                 <i class="fas fa-calendar-alt"></i> Started: ${formatDateForDisplay(project.startDate)} | Updated: ${formatDateForDisplay(project.updatedDate)}
                             </div>
                             <div class="project-actions">
                                 <button class="btn btn-view" data-project-id="${project.id}"><i class="fas fa-eye"></i> View</button>
                                 <button class="btn btn-edit" data-project-id="${project.id}" ${!canEdit ? 'disabled' : ''}><i class="fas fa-pencil-alt"></i> Edit</button>
                                 <button class="btn btn-delete" data-project-id="${project.id}" ${!canDelete ? 'disabled' : ''}><i class="fas fa-trash-alt"></i> Delete</button>
                             </div>
                         </div>
                     `;
                     projectsListContainer.appendChild(card);
                 });
             }
             window.initializeProjectsFeature = function(container) { // Made global
                 console.log("Initializing Projects Feature...");
                 const searchInput = container.querySelector('#projectSearchInputFeature');
                 const filterSelect = container.querySelector('#projectFilterSelectFeature');
                 const projectsListContainer = container.querySelector('#projectsListContainerFeature');
                 const addProjectBtn = container.querySelector('#addProjectBtnFeature');

                 let listeners = [];
                 const addListener = (element, event, handler, options = {}) => { if (!element) return; element.addEventListener(event, handler, options); listeners.push({ element, event, handler, options }); };


                 // Initial render
                 renderProjects(container);

                 const filterHandler = () => renderProjects(container);
                 const actionHandler = (event) => {
                     const target = event.target.closest('.btn'); if (!target) return;
                     const projectId = target.dataset.projectId; if (!projectId) return;
                     if (target.classList.contains('btn-view')) { alert(`Placeholder: View details for Project ID ${projectId}`); }
                     else if (target.classList.contains('btn-edit')) { openProjectModal(projectId); }
                     else if (target.classList.contains('btn-delete')) { handleDeleteProject(projectId); }
                 };
                 const addHandler = () => { openProjectModal(); };


                 // Add event listeners
                 addListener(searchInput, 'input', filterHandler);
                 addListener(filterSelect, 'change', filterHandler);
                 addListener(projectsListContainer, 'click', actionHandler);
                 if (addProjectBtn) addListener(addProjectBtn, 'click', addHandler);


                 // Cleanup function
                 const cleanup = () => {
                     console.log("Cleaning up Projects feature listeners...");
                      listeners.forEach(({ element, event, handler, options }) => {
                         element?.removeEventListener(event, handler, options);
                     });
                     listeners = [];
                      // No specific styles injected for this feature in this setup
                 };
                 return { cleanup };
             }
             // --- END: Projects Feature ---

            // --- Start Application ---
            initDashboard();
        });
    </script>

</body>
</html>

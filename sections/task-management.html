<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Styles --- */
        /* Basic Reset & Body Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fc; /* Light blue-grey background */
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-left: 5px; /* Spacing between buttons */
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 5px; /* Space between icon and text */
        }

        .btn i { /* Style for icons inside buttons */
             font-size: 0.9em;
        }

        .btn-primary {
            background-color: #007bff; /* Primary blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: #6c757d; /* Grey */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107; /* Yellow */
            color: #333;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-success {
             background-color: #28a745; /* Green */
             color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }

        .btn-info {
            background-color: #17a2b8; /* Teal */
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }

        /* Controls Area: Add, Search, Filters */
        .controls {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef; /* Light grey background for controls */
            border-radius: 6px;
            gap: 15px; /* Add gap between control groups */
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            flex-grow: 1; /* Allow search to take available space */
            min-width: 200px; /* Ensure search has some minimum width */
        }

        #search-input {
            padding: 10px 35px 10px 15px; /* Space for icon */
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
            width: 100%; /* Take full width of its container */
        }

        .search-icon {
            position: absolute;
            right: 12px;
            color: #6c757d;
            pointer-events: none; /* Make icon non-interactive */
        }

        .filters {
            display: flex;
            flex-wrap: wrap; /* Allow filters to wrap too */
            gap: 10px; /* Space between filters */
        }

        .filters select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            min-width: 150px; /* Give selects a minimum width */
        }

        /* Task List */
        .task-list {
            margin-top: 20px;
            display: grid;
            gap: 20px;
            /* Responsive grid: start with 1 column, increase as space allows */
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Slightly wider min */
        }

        .no-tasks {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-size: 1.1em;
            background-color: #f8f9fa;
            border-radius: 6px;
            grid-column: 1 / -1; /* Span all columns if grid is active */
        }

        /* Task Card Styling */
        .task-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #007bff; /* Default border color (can be overridden by priority) */
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push actions to bottom */
            position: relative; /* For potential absolute positioning inside */
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px); /* Slight lift effect */
        }

        .task-card h3 {
            font-size: 1.25em; /* Slightly smaller */
            margin-bottom: 10px;
            color: #0056b3; /* Darker blue for title */
            word-break: break-word; /* Prevent long titles from overflowing */
        }

        .task-card p {
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
            word-break: break-word;
            line-height: 1.5;
        }

        .task-card .description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
            max-height: 80px; /* Limit description height */
            overflow-y: auto; /* Add scroll if needed */
        }

        .task-card strong {
            color: #333;
            min-width: 90px; /* Align labels slightly better */
            display: inline-block;
            margin-right: 5px;
        }

        .task-card .links {
            font-size: 0.9em;
        }
        .task-card .links a, .task-card .links span {
            display: inline-block; /* Prevent breaking mid-link */
            margin-right: 5px;
            margin-bottom: 3px; /* Space between wrapped links */
            word-break: break-all; /* Break long URLs/text */
        }
        .task-card .links a {
            color: #007bff;
            text-decoration: none;
        }
        .task-card .links a:hover {
            text-decoration: underline;
        }

        .task-meta {
            font-size: 0.85em;
            color: #777;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
         /* Display meta info more compactly */
        .task-meta > div {
            display: flex;
            flex-wrap: wrap;
            gap: 5px 15px; /* Row gap, column gap */
            margin-bottom: 5px;
        }
        .task-meta span {
            white-space: nowrap; /* Prevent labels/values from breaking */
        }

        /* Priority Styling */
        .task-card.priority-High { border-left-color: #dc3545; } /* Red */
        .task-card.priority-Medium { border-left-color: #ffc107; } /* Yellow */
        .task-card.priority-Low { border-left-color: #28a745; } /* Green */

        /* Status Styling */
        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-Pending { background-color: #ffc107; color: #333;} /* Yellow */
        .status-InProgress { background-color: #17a2b8; } /* Teal */
        .status-Completed { background-color: #28a745; } /* Green */

        /* Overdue Styling */
        .overdue-indicator {
            color: #dc3545; /* Red */
            font-weight: bold;
            margin-left: 5px;
            font-size: 0.9em;
        }

        .task-card.status-Completed {
            background-color: #f8f9fa; /* Slightly greyed out when completed */
            border-left-color: #6c757d; /* Grey border for completed */
        }
        .task-card.status-Completed h3 {
            color: #6c757d;
            text-decoration: line-through;
        }
        .task-card.status-Completed p,
        .task-card.status-Completed .description,
        .task-card.status-Completed .task-meta {
             color: #6c757d; /* Grey out text */
        }
        .task-card.status-Completed strong {
             color: #5a6268;
        }


        /* Task Actions */
        .task-actions {
            margin-top: 15px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .task-actions button {
            background: none;
            border: none;
            color: #6c757d; /* Default greyish color */
            cursor: pointer;
            font-size: 1.2em; /* Make icons slightly larger */
            padding: 5px 8px;
            margin-left: 10px;
            transition: color 0.2s ease, transform 0.2s ease;
            vertical-align: middle; /* Align icons better */
        }
         .task-actions button:hover {
            transform: scale(1.1); /* Slightly enlarge icon on hover */
        }

        .task-actions .edit-btn:hover { color: #007bff; } /* Blue */
        .task-actions .delete-btn { color: #dc3545; } /* Red */
        .task-actions .delete-btn:hover { color: #a71d2a; }
        .task-actions .complete-btn { color: #28a745; } /* Green */
        .task-actions .complete-btn:hover { color: #1e7e34; }
        .task-actions .reopen-btn { color: #ffc107; } /* Yellow */
        .task-actions .reopen-btn:hover { color: #d39e00; }


        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            padding-top: 50px; /* Location of the box */
            backdrop-filter: blur(3px); /* Optional blur effect */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto 10% auto; /* Add more bottom margin */
            padding: 30px 40px; /* More padding */
            border: none; /* Remove default border */
            width: 90%;
            max-width: 650px; /* Slightly wider modal */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            animation: slideDown 0.4s ease-out; /* Slide down animation */
        }

        @keyframes slideDown {
            from {opacity: 0; transform: translateY(-30px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #333; /* Darker on hover */
            text-decoration: none;
            cursor: pointer;
        }

        /* Modal Form Styling */
         #modal-title {
             margin-bottom: 25px;
             font-weight: 600;
             color: #333;
             text-align: left;
         }

        #task-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 18px; /* Slightly more space */
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px; /* More padding */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .form-group input:focus,
         .form-group textarea:focus,
         .form-group select:focus {
             border-color: #007bff;
             box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
             outline: none;
         }

        .form-group textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px; /* Minimum height */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 20px; /* More space between items in a row */
        }
        .form-row > div {
            flex: 1; /* Each item takes equal space */
            min-width: 200px; /* Prevent extreme squishing */
        }

        .form-actions {
            text-align: right;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .form-actions .btn {
            padding: 12px 25px; /* Larger save/cancel buttons */
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .task-list {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
             .container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .search-container {
                 margin: 0; /* Remove side margin */
            }
             #add-task-btn {
                 width: 100%;
                 margin-left: 0; /* Remove left margin */
                 order: -1; /* Move button to top on mobile */
                 margin-bottom: 10px;
            }
            .filters {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .filters select {
                width: 100%;
                min-width: unset; /* Remove min-width */
            }
            .task-list {
                grid-template-columns: 1fr; /* Stack tasks vertically */
            }
             .modal-content {
                width: 95%;
                padding: 20px;
            }
             .form-row {
                 flex-direction: column;
                 gap: 15px; /* Keep gap consistent */
             }
             .form-row > div {
                 min-width: unset; /* Remove min-width */
             }
             h1 {
                 font-size: 1.8em;
             }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
             .container {
                 padding: 15px;
             }
             .btn {
                 font-size: 0.95em;
                 padding: 9px 15px;
             }
             .form-actions .btn {
                padding: 10px 20px;
             }
             .task-card {
                 padding: 15px;
             }
             .task-card h3 {
                 font-size: 1.15em;
             }
             .task-card p, .task-card .description, .task-meta {
                font-size: 0.9em;
             }
              .task-actions button {
                 font-size: 1.1em;
                 margin-left: 8px;
             }
             .modal-content {
                 padding: 20px 15px;
             }
              #modal-title {
                 font-size: 1.5em;
                 margin-bottom: 20px;
             }
        }

        /* --- End of CSS --- */
    </style>

</head>
<body>

    <div class="container">
        <h1>Task Management</h1>

        <!-- Controls: Add Task, Search, Filters -->
        <div class="controls">
            <button id="add-task-btn" class="btn btn-primary"><i class="fas fa-plus"></i> New Task</button>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search tasks...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="filters">
                <select id="filter-status">
                    <option value="all">Status: All</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
                <select id="filter-priority">
                    <option value="all">Priority: All</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <select id="filter-assigned-to">
                    <option value="all">Assigned To: All</option>
                    <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                    <option value="Yousef">Yousef</option>
                    <option value="Esraa Lashin">Esraa Lashin</option>
                    <option value="Bassant Badr">Bassant Badr</option>
                    <!-- Add more assignees as needed -->
                </select>
            </div>
        </div>

        <!-- Task List Area -->
        <div id="task-list" class="task-list">
            <!-- Tasks will be loaded here by JavaScript -->
            <p class="no-tasks">Loading tasks...</p>
        </div>
    </div>

    <!-- Add/Edit Task Modal (Hidden by default) -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h2 id="modal-title">Add New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id"> <!-- For editing -->

                <div class="form-group">
                    <label for="task-name">Task Name:</label>
                    <input type="text" id="task-name" required>
                </div>

                <div class="form-group">
                    <label for="task-description">Description:</label>
                    <textarea id="task-description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="task-links">Links (comma-separated URLs or identifiers):</label>
                    <input type="text" id="task-links" placeholder="e.g., https://example.com, jira-123">
                </div>

                 <div class="form-group form-row">
                    <div>
                         <label for="task-assigned-by">Assigned By:</label>
                        <select id="task-assigned-by" required>
                            <option value="Nada">Nada</option>
                            <option value="Yousef">Yousef</option>
                            <option value="Self Assigned">Self Assigned</option>
                        </select>
                    </div>
                     <div>
                         <label for="task-assigned-to">Assigned To:</label>
                        <select id="task-assigned-to" required>
                            <option value="Mohamed Elmenisy">Mohamed Elmenisy</option>
                            <option value="Yousef">Yousef</option>
                            <option value="Esraa Lashin">Esraa Lashin</option>
                            <option value="Bassant Badr">Bassant Badr</option>
                        </select>
                    </div>
                 </div>

                <div class="form-group form-row">
                    <div>
                        <label for="task-start-date">Start Date:</label>
                        <input type="date" id="task-start-date">
                    </div>
                    <div>
                        <label for="task-due-date">Due Date:</label>
                        <input type="date" id="task-due-date">
                    </div>
                </div>

                 <div class="form-group form-row">
                    <div>
                        <label for="task-priority">Priority:</label>
                        <select id="task-priority" required>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-status">Status:</label>
                        <select id="task-status" required>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                     </div>
                 </div>

                <div class="form-actions">
                    <button type="submit" id="save-task-btn" class="btn btn-primary">Save Task</button>
                    <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- JavaScript Functionality ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const closeModalBtn = taskModal.querySelector('.close-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const taskForm = document.getElementById('task-form');
            const taskListDiv = document.getElementById('task-list');
            const modalTitle = document.getElementById('modal-title');
            const saveTaskBtn = document.getElementById('save-task-btn');

            // Form Fields
            const taskIdInput = document.getElementById('task-id');
            const taskNameInput = document.getElementById('task-name');
            const taskDescriptionInput = document.getElementById('task-description');
            const taskLinksInput = document.getElementById('task-links');
            const taskAssignedBySelect = document.getElementById('task-assigned-by');
            const taskAssignedToSelect = document.getElementById('task-assigned-to');
            const taskStartDateInput = document.getElementById('task-start-date');
            const taskDueDateInput = document.getElementById('task-due-date');
            const taskPrioritySelect = document.getElementById('task-priority');
            const taskStatusSelect = document.getElementById('task-status');

            // Filters & Search
            const searchInput = document.getElementById('search-input');
            const filterStatusSelect = document.getElementById('filter-status');
            const filterPrioritySelect = document.getElementById('filter-priority');
            const filterAssignedToSelect = document.getElementById('filter-assigned-to');

            // --- Data Storage ---
            let tasks = []; // Initialize empty, load from storage

            // Load tasks from localStorage
            const loadTasks = () => {
                 tasks = JSON.parse(localStorage.getItem('tasks')) || [
                    // --- Sample Tasks (Provide initial data if localStorage is empty) ---
                    {
                        id: 1,
                        name: "Setup Project Environment",
                        description: "Install Node.js, npm packages, and configure the basic project structure.",
                        links: "https://nodejs.org, https://npmjs.com",
                        assignedBy: "Nada",
                        assignedTo: "Mohamed Elmenisy",
                        startDate: "2024-07-20",
                        dueDate: "2024-07-22",
                        priority: "High",
                        status: "In Progress",
                        completionDate: null
                    },
                    {
                        id: 2,
                        name: "Design UI Mockups",
                        description: "Create wireframes and high-fidelity mockups for the main pages using Figma.",
                        links: "https://figma.com",
                        assignedBy: "Yousef",
                        assignedTo: "Esraa Lashin",
                        startDate: "2024-07-21",
                        dueDate: "2024-07-25",
                        priority: "Medium",
                        status: "Pending",
                        completionDate: null
                    },
                    {
                        id: 3,
                        name: "Develop API Endpoints",
                        description: "Build RESTful APIs for user authentication and task management. Focus on security and scalability.",
                        links: "",
                        assignedBy: "Self Assigned",
                        assignedTo: "Yousef",
                        startDate: "2024-07-23",
                        dueDate: "2024-07-30",
                        priority: "High",
                        status: "Pending",
                        completionDate: null
                    },
                    {
                        id: 4,
                        name: "Client Meeting Prep",
                        description: "Prepare presentation slides and demo for the upcoming client meeting. Ensure all key features are covered.",
                        links: "",
                        assignedBy: "Nada",
                        assignedTo: "Bassant Badr",
                        startDate: "2024-07-28",
                        dueDate: "2024-07-29",
                        priority: "Medium",
                        status: "Pending",
                        completionDate: null
                    },
                    {
                        id: 5,
                        name: "Review Code Submission",
                        description: "Review the latest code pushed to the 'feature/login' branch on GitHub by Yousef.",
                        links: "https://github.com, PR #42",
                        assignedBy: "Self Assigned",
                        assignedTo: "Mohamed Elmenisy",
                        startDate: "2024-07-26",
                        dueDate: "2024-07-26",
                        priority: "Low",
                        status: "Completed",
                        completionDate: "2024-07-25"
                    },
                    {
                        id: 6,
                        name: "Fix Login Bug (JIRA-123)",
                        description: "Users reporting issues logging in with special characters (#, &) in password. Found in production logs.",
                        links: "jira-123",
                        assignedBy: "Yousef",
                        assignedTo: "Yousef",
                        startDate: "2024-07-15",
                        dueDate: "2024-07-18", // Overdue
                        priority: "High",
                        status: "In Progress",
                        completionDate: null
                    }
                    // --- End Sample Tasks ---
                ];
                renderTasks(); // Render after loading
            };

            // Save tasks to localStorage
            const saveTasks = () => {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            };

            // Format Date for display (e.g., Jul 26, 2024 or N/A)
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString + 'T00:00:00'); // Treat as local date
                    if (isNaN(date.getTime())) return 'Invalid Date'; // Check for invalid dates
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) {
                    return 'Invalid Date';
                }
            };

             // Get current date in YYYY-MM-DD format for storage
            const getCurrentDate = () => {
                return new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
            };

             // Check if task is overdue
            const isOverdue = (task) => {
                if (task.status === 'Completed' || !task.dueDate) return false;
                 try {
                    // Compare dates in UTC to avoid timezone issues with just date comparison
                    const dueDate = new Date(task.dueDate + 'T00:00:00Z'); // Assume input is UTC date if just YYYY-MM-DD
                    const today = new Date();
                    // Set today to UTC midnight for fair comparison
                    const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));

                    if (isNaN(dueDate.getTime())) return false; // Handle invalid due date

                    return dueDate < todayUTC;
                } catch(e) {
                    return false; // Error parsing date
                }
            };

            // Render Tasks
            const renderTasks = () => {
                taskListDiv.innerHTML = ''; // Clear current list
                const searchTerm = searchInput.value.toLowerCase();
                const statusFilter = filterStatusSelect.value;
                const priorityFilter = filterPrioritySelect.value;
                const assignedToFilter = filterAssignedToSelect.value;

                let tasksToDisplay = tasks;

                // Apply Filters
                 tasksToDisplay = tasksToDisplay.filter(task => {
                    const statusMatch = statusFilter === 'all' || task.status === statusFilter;
                    const priorityMatch = priorityFilter === 'all' || task.priority === priorityFilter;
                    const assignedToMatch = assignedToFilter === 'all' || task.assignedTo === assignedToFilter;
                    return statusMatch && priorityMatch && assignedToMatch;
                });

                 // Apply Search (after filtering for performance on large lists)
                 if (searchTerm) {
                     tasksToDisplay = tasksToDisplay.filter(task => {
                         const nameMatch = task.name.toLowerCase().includes(searchTerm);
                         const descMatch = task.description.toLowerCase().includes(searchTerm);
                         const linksMatch = task.links.toLowerCase().includes(searchTerm);
                         const assignedToMatch = task.assignedTo.toLowerCase().includes(searchTerm);
                         const assignedByMatch = task.assignedBy.toLowerCase().includes(searchTerm);
                         return nameMatch || descMatch || linksMatch || assignedToMatch || assignedByMatch;
                     });
                 }


                if (tasksToDisplay.length === 0) {
                    taskListDiv.innerHTML = '<p class="no-tasks">No tasks found matching your criteria.</p>';
                    return;
                }

                 // Sort tasks: Pending/In Progress first, then Completed. Within those groups, sort by due date (earliest first, nulls last), then priority (High > Medium > Low)
                tasksToDisplay.sort((a, b) => {
                    // Group by status: Active (Pending, In Progress) before Completed
                    const statusOrder = { "Pending": 1, "In Progress": 1, "Completed": 2 };
                    const statusA = statusOrder[a.status] || 3; // Default to last if unknown status
                    const statusB = statusOrder[b.status] || 3;
                    if (statusA !== statusB) return statusA - statusB;

                    // Sort by due date (earliest first, nulls last)
                    const dateA = a.dueDate ? new Date(a.dueDate + 'T00:00:00Z') : null;
                    const dateB = b.dueDate ? new Date(b.dueDate + 'T00:00:00Z') : null;

                    const dateValA = dateA && !isNaN(dateA) ? dateA.getTime() : Infinity;
                    const dateValB = dateB && !isNaN(dateB) ? dateB.getTime() : Infinity;

                    if (dateValA !== dateValB) return dateValA - dateValB;

                    // If due dates are same/both null, sort by priority (High > Medium > Low)
                    const priorityOrder = { High: 3, Medium: 2, Low: 1 };
                    const priorityA = priorityOrder[a.priority] || 0;
                    const priorityB = priorityOrder[b.priority] || 0;
                    return priorityB - priorityA; // Descending priority
                });


                tasksToDisplay.forEach(task => {
                    const taskCard = document.createElement('div');
                     // Add base class and dataset
                    taskCard.classList.add('task-card');
                    taskCard.dataset.taskId = task.id;
                    // Add dynamic classes based on task properties
                    taskCard.classList.add(`priority-${task.priority}`);
                    taskCard.classList.add(`status-${task.status.replace(/\s+/g, '')}`); // e.g., status-InProgress
                    if(task.status === 'Completed') taskCard.classList.add('task-completed'); // Generic completed class if needed
                    if(isOverdue(task)) taskCard.classList.add('task-overdue'); // Overdue class


                    const overdue = isOverdue(task);
                    const overdueText = overdue ? `<span class="overdue-indicator">(Overdue!)</span>` : '';

                    // Format links - make URLs clickable, show others as text
                    let linksHTML = 'N/A';
                    if (task.links && task.links.trim()) {
                         linksHTML = task.links.split(',')
                            .map(link => link.trim())
                            .filter(link => link) // Remove empty strings
                            .map(link => {
                                let href = link;
                                let isUrl = false;
                                try {
                                    // More robust URL check
                                    const url = new URL(link.startsWith('http') ? link : `http://${link}`);
                                    // Basic check if it looks like a domain name or IP
                                    if(url.hostname && (url.hostname.includes('.') || url.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))) {
                                         isUrl = true;
                                         // Ensure protocol for display link
                                         href = url.protocol + "//" + url.hostname + url.pathname + url.search + url.hash;
                                    } else {
                                        href = link; // Keep original if not URL-like
                                    }
                                } catch (_) {
                                    isUrl = false; // Invalid URL construction
                                    href = link;
                                }

                                const displayText = link.length > 35 ? link.substring(0, 32) + '...' : link;
                                return isUrl ? `<a href="${href}" target="_blank" rel="noopener noreferrer" title="${link}">${displayText}</a>` : `<span title="${link}">${displayText}</span>`;
                            })
                            .join(' '); // Display links separated by space
                    }


                    taskCard.innerHTML = `
                        <h3>${task.name}</h3>
                        ${task.description ? `<p class="description">${task.description}</p>` : ''}
                        <p><strong>Links:</strong> <span class="links">${linksHTML}</span></p>
                        <p><strong>Assigned By:</strong> ${task.assignedBy}</p>
                        <p><strong>Assigned To:</strong> ${task.assignedTo}</p>

                        <div class="task-meta">
                            <div> <!-- Row 1: Dates -->
                                 <span><strong>Start:</strong> ${formatDate(task.startDate)}</span>
                                 <span><strong>Due:</strong> ${formatDate(task.dueDate)} ${overdueText}</span>
                             </div>
                             <div> <!-- Row 2: Priority & Status -->
                                 <span><strong>Priority:</strong> ${task.priority}</span>
                                 <span><strong>Status:</strong> <span class="status-badge status-${task.status.replace(/\s+/g, '')}">${task.status}</span></span>
                             </div>
                             ${task.status === 'Completed' ? `<div><span><strong>Completed:</strong> ${formatDate(task.completionDate)}</span></div>` : ''}
                        </div>

                        <div class="task-actions">
                            <button class="edit-btn" title="Edit Task"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" title="Delete Task"><i class="fas fa-trash-alt"></i></button>
                            ${task.status === 'Completed'
                                ? `<button class="reopen-btn" title="Reopen Task"><i class="fas fa-undo"></i></button>`
                                : `<button class="complete-btn" title="Mark as Completed"><i class="fas fa-check-circle"></i></button>`
                            }
                        </div>
                    `;

                    // Add event listeners for action buttons within the card
                    taskCard.querySelector('.edit-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click if needed
                        openEditModal(task.id);
                    });
                    taskCard.querySelector('.delete-btn').addEventListener('click', (e) => {
                         e.stopPropagation();
                         deleteTask(task.id);
                    });

                    const completeOrReopenBtn = taskCard.querySelector('.complete-btn, .reopen-btn');
                    if (completeOrReopenBtn) {
                         completeOrReopenBtn.addEventListener('click', (e) => {
                             e.stopPropagation();
                             toggleTaskStatus(task.id);
                         });
                     }

                    taskListDiv.appendChild(taskCard);
                });
            };

            // Show Modal
            const showModal = () => {
                taskModal.style.display = 'block';
                 document.body.style.overflow = 'hidden'; // Prevent background scrolling
            };

            // Hide Modal
            const hideModal = () => {
                taskModal.style.display = 'none';
                taskForm.reset(); // Clear form fields
                taskIdInput.value = ''; // Clear hidden ID field
                modalTitle.textContent = "Add New Task"; // Reset title
                saveTaskBtn.textContent = "Save Task";
                document.body.style.overflow = ''; // Restore background scrolling
            };

            // Open Modal for Adding Task
            const openAddModal = () => {
                hideModal(); // Reset form first
                modalTitle.textContent = "Add New Task";
                saveTaskBtn.textContent = "Save Task";
                // Set default values
                taskStatusSelect.value = "Pending";
                taskPrioritySelect.value = "Medium";
                 // Optionally set default assigned to/by if applicable
                 // taskAssignedToSelect.value = "Mohamed Elmenisy";
                showModal();
                taskNameInput.focus(); // Focus the first field
            };

            // Open Modal for Editing Task
            const openEditModal = (id) => {
                const task = tasks.find(t => t.id === id);
                if (!task) return;

                hideModal(); // Reset form first
                modalTitle.textContent = "Edit Task";
                saveTaskBtn.textContent = "Update Task";

                // Populate form
                taskIdInput.value = task.id;
                taskNameInput.value = task.name;
                taskDescriptionInput.value = task.description || ''; // Handle null/undefined
                taskLinksInput.value = task.links || '';
                taskAssignedBySelect.value = task.assignedBy;
                taskAssignedToSelect.value = task.assignedTo;
                taskStartDateInput.value = task.startDate || ''; // Handle cases where dates might be null
                taskDueDateInput.value = task.dueDate || '';
                taskPrioritySelect.value = task.priority;
                taskStatusSelect.value = task.status;

                showModal();
                 taskNameInput.focus(); // Focus the first field
            };

            // Handle Form Submission (Add/Edit)
            const handleFormSubmit = (event) => {
                event.preventDefault();

                 const taskId = taskIdInput.value ? parseInt(taskIdInput.value) : Date.now(); // Use existing ID or generate a new one
                 const currentTask = tasks.find(t => t.id === taskId);
                 const newStatus = taskStatusSelect.value;

                 let completionDate = currentTask?.completionDate || null; // Keep existing completion date by default

                 // Update completion date logic based on status change
                 if (newStatus === 'Completed') {
                     if (!taskIdInput.value || (currentTask && currentTask.status !== 'Completed')) {
                         // New task added as completed OR existing task changing TO completed
                         completionDate = getCurrentDate();
                     }
                     // If it was already completed and remains completed, keep the original date
                 } else {
                     // If status is not 'Completed' (or changes away from it), clear the date
                     completionDate = null;
                 }

                // Validate dates if necessary (e.g., due date not before start date)
                const startDate = taskStartDateInput.value;
                const dueDate = taskDueDateInput.value;
                if (startDate && dueDate && new Date(dueDate) < new Date(startDate)) {
                    alert("Due Date cannot be before Start Date.");
                    taskDueDateInput.focus();
                    return; // Stop submission
                }

                const taskData = {
                    id: taskId,
                    name: taskNameInput.value.trim(),
                    description: taskDescriptionInput.value.trim(),
                    links: taskLinksInput.value.trim(),
                    assignedBy: taskAssignedBySelect.value,
                    assignedTo: taskAssignedToSelect.value,
                    startDate: startDate || null, // Store as null if empty
                    dueDate: dueDate || null,     // Store as null if empty
                    priority: taskPrioritySelect.value,
                    status: newStatus,
                    completionDate: completionDate
                };

                if (!taskData.name) {
                    alert("Task Name is required.");
                    taskNameInput.focus();
                    return;
                }

                if (taskIdInput.value) {
                    // Editing existing task: Find index and replace
                     const index = tasks.findIndex(task => task.id === taskData.id);
                     if (index > -1) {
                         tasks[index] = taskData;
                     }
                } else {
                    // Adding new task
                    tasks.push(taskData);
                }

                saveTasks();    // Save to localStorage
                renderTasks();  // Update the UI
                hideModal();    // Close the modal
            };

            // Delete Task
            const deleteTask = (id) => {
                const taskToDelete = tasks.find(t => t.id === id);
                 if (confirm(`Are you sure you want to delete task: "${taskToDelete?.name || id}"?`)) {
                    tasks = tasks.filter(task => task.id !== id);
                    saveTasks();
                    renderTasks();
                }
            };

            // Toggle Task Status (Complete/Reopen) via buttons on card
            const toggleTaskStatus = (id) => {
                 tasks = tasks.map(task => {
                    if (task.id === id) {
                        if (task.status === 'Completed') {
                            // Reopen: Change status, clear completion date
                            return { ...task, status: 'Pending', completionDate: null }; // Default to Pending on reopen
                        } else {
                            // Complete: Change status, set completion date to now
                            return { ...task, status: 'Completed', completionDate: getCurrentDate() };
                        }
                    }
                    return task;
                });
                saveTasks();
                renderTasks();
            };

            // --- Event Listeners Setup ---
            addTaskBtn.addEventListener('click', openAddModal);
            closeModalBtn.addEventListener('click', hideModal);
            cancelBtn.addEventListener('click', hideModal);
            taskForm.addEventListener('submit', handleFormSubmit);

            // Close modal if clicking outside the content area
            taskModal.addEventListener('click', (event) => {
                if (event.target === taskModal) { // Check if the click is directly on the modal background
                    hideModal();
                }
            });

             // Close modal on Escape key press
             document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && taskModal.style.display === 'block') {
                    hideModal();
                }
            });

            // Filters and Search listeners - trigger re-render on change/input
            searchInput.addEventListener('input', renderTasks);
            filterStatusSelect.addEventListener('change', renderTasks);
            filterPrioritySelect.addEventListener('change', renderTasks);
            filterAssignedToSelect.addEventListener('change', renderTasks);

            // --- Initial Load ---
            loadTasks(); // Load tasks from storage and render them initially

        });
        // --- End of JavaScript ---
    </script>

</body>
</html>

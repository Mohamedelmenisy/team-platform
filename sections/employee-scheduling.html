<!-- Note: Removed DOCTYPE, html, head, body tags -->
<!-- Note: Removed <header> section as it's provided by dash.html -->

<!-- Styles specific to Employee Scheduling -->
<style>
    /* Styles specific to this section (employee schedule) */
    .employee-schedule-body {
        /* Styles inherited from dash.html */
    }

    /* Main Content Styling Adjustments */
    .employee-schedule-body .main-container {
        max-width: 100%; margin: 0; padding: 0;
    }
    .employee-schedule-body .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;
    }
    .employee-schedule-body .page-title {
        font-size: 1.5rem; color: var(--primary-dark); font-weight: 600;
    }
    /* Schedule Controls */
    .employee-schedule-body .schedule-controls {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; background-color: var(--white); padding: 1rem;
        border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap; gap: 1rem;
    }
    .employee-schedule-body .week-navigation { display: flex; align-items: center; gap: 0.75rem; }
    .employee-schedule-body .week-display { font-weight: 600; min-width: 180px; text-align: center; color: var(--dark); }

    /* Schedule Table */
    .employee-schedule-body .schedule-container {
        background-color: var(--white); border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); overflow-x: auto;
    }
    .employee-schedule-body .schedule-table {
        width: 100%; border-collapse: separate; border-spacing: 0 0px; margin-top: 0px;
    }
    .employee-schedule-body .schedule-table thead th {
        padding: 0.8rem 0.5rem; text-align: center; background-color: var(--primary);
        color: white; font-weight: 600; position: sticky; top: 0; z-index: 10;
        border-bottom: 2px solid var(--primary-dark);
    }
    .employee-schedule-body .schedule-table thead tr:first-child th:first-child { border-top-left-radius: 8px; }
    .employee-schedule-body .schedule-table thead tr:first-child th:last-child { border-top-right-radius: 8px; }
    .employee-schedule-body .schedule-table tbody td {
        padding: 0.75rem 0.5rem; text-align: center; background-color: var(--white);
        border: none; border-bottom: 1px solid var(--light-gray); color: var(--dark);
        vertical-align: middle;
    }
    .employee-schedule-body .schedule-table tbody tr:last-child td { border-bottom: none; }
    .employee-schedule-body .schedule-table tbody td:first-child { border-left: 1px solid var(--light-gray); }
    .employee-schedule-body .schedule-table tbody td:last-child { border-right: 1px solid var(--light-gray); }
    .employee-schedule-body .schedule-table tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; }
    .employee-schedule-body .schedule-table tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; }
    .employee-schedule-body .employee-name {
        font-weight: 500; text-align: left; position: sticky; left: 0;
        background-color: var(--white); padding: 0.75rem 1rem; white-space: nowrap;
        z-index: 5; border-right: 1px solid var(--light-gray);
    }
    /* Employee name colors */
    .employee-schedule-body .employee-1 { color: #3b82f6; } .employee-schedule-body .employee-2 { color: #10b981; }
    .employee-schedule-body .employee-3 { color: #8b5cf6; } .employee-schedule-body .employee-4 { color: #ec4899; }
    .employee-schedule-body .employee-5 { color: #f59e0b; } .employee-schedule-body .employee-6 { color: #14b8a6; }
    /* Shift Styles */
    .employee-schedule-body .shift {
        padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;
        font-weight: 500; white-space: nowrap; display: inline-block;
    }
    .employee-schedule-body .shift-morning { background-color: #dbeafe; color: #1e40af; }
    .employee-schedule-body .shift-afternoon { background-color: #e0f2fe; color: #0c4a6e; }
    .employee-schedule-body .shift-night { background-color: #ede9fe; color: #5b21b6; }
    .employee-schedule-body .day-off { background-color: #f0fdf4; color: #166534; }
    .employee-schedule-body .sick-leave { background-color: #fee2e2; color: #991b1b; }
    .employee-schedule-body .vacation { background-color: #ffedd5; color: #9a3412; }
    /* Day headers */
    .employee-schedule-body .day-header { display: flex; flex-direction: column; gap: 0.15rem; align-items: center; }
    .employee-schedule-body .day-name { font-weight: 600; font-size: 0.85rem; }
    .employee-schedule-body .day-date { font-size: 0.75rem; opacity: 0.8; }
    /* Modals (Using dashboard's modals is preferred) */
    .employee-schedule-body .modal { display: none; /* Kept for structure, but dashboard modals used */ }
    .employee-schedule-body .modal-content { /* Basic styling if needed */ }
    .employee-schedule-body .modal-header { /* Basic styling if needed */ }
    .employee-schedule-body .modal-title { /* Basic styling if needed */ }
    .employee-schedule-body .close-modal { /* Basic styling if needed */ }
    .employee-schedule-body .form-group { margin-bottom: 1rem; }
    .employee-schedule-body .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); font-size: 0.9rem; }
    .employee-schedule-body .form-control { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.95rem; background-color: var(--white); color: var(--dark); }
    .employee-schedule-body .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .employee-schedule-body .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }
    .employee-schedule-body textarea.form-control { min-height: 80px; }
    .employee-schedule-body .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--light-gray); }
    /* Admin Controls */
    .employee-schedule-body .admin-controls { position: relative; padding: 0.75rem 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px; }
    .employee-schedule-body .edit-shift { cursor: pointer; color: var(--primary); font-size: 0.75rem; display: none; margin-top: 0.25rem; opacity: 0.7; transition: opacity 0.2s; }
    .employee-schedule-body .edit-shift:hover { opacity: 1; text-decoration: underline; }
    .employee-schedule-body .admin-controls:hover .edit-shift.admin-visible { display: inline; }
    /* Responsive */
    @media (max-width: 768px) {
        .employee-schedule-body .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
        .employee-schedule-body .week-navigation { justify-content: space-between; width: 100%; }
        .employee-schedule-body .schedule-controls > .btn-primary { width: 100%; justify-content: center; }
        .employee-schedule-body .page-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; margin-bottom: 1.5rem; }
        .employee-schedule-body .page-header > div { width: 100%; display: flex; gap: 0.5rem; }
        .employee-schedule-body .page-header > div > .btn { flex-grow: 1; justify-content: center; }
        .employee-schedule-body .employee-name { position: static; border-right: none; border-bottom: 1px solid var(--light-gray); text-align: center; font-weight: 600; background-color: #f8fafc; }
        .employee-schedule-body .schedule-table tbody td:first-child { border-left: none; }
        .employee-schedule-body .schedule-table tbody td { display: block; width: 100%; text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid var(--light-gray); }
        .employee-schedule-body .schedule-table tbody td:last-child { border-bottom: 2px solid var(--dark); }
        .employee-schedule-body .schedule-table tbody td::before { content: attr(data-label); position: absolute; left: 10px; width: calc(50% - 20px); padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--gray); }
        .employee-schedule-body .schedule-table tbody td.employee-name { display: table-cell; width: auto; text-align: left; padding-left: 1rem; position: sticky; left: 0; background-color: var(--light); z-index: 5; }
        .employee-schedule-body .schedule-table tbody td.employee-name::before { content: none; }
        .employee-schedule-body .schedule-table thead { display: none; }
        .employee-schedule-body .admin-controls { min-height: auto; padding: 0.5rem 10px 0.5rem 50%; flex-direction: row; justify-content: flex-end; align-items: center; gap: 0.5rem; }
        .employee-schedule-body .edit-shift { margin-top: 0; }
    }
    @media (max-width: 480px) {
        .employee-schedule-body .page-title { font-size: 1.3rem; }
        .employee-schedule-body .shift { font-size: 0.75rem; padding: 0.2rem 0.4rem; }
        .employee-schedule-body .edit-shift { font-size: 0.7rem; }
        .employee-schedule-body .modal-content { padding: 1rem; }
        .employee-schedule-body .form-actions { flex-direction: column; gap: 0.5rem; }
        .employee-schedule-body .form-actions .btn { width: 100%; justify-content: center; }
    }
</style>

<!-- This container will be inserted into dash.html's #featureSections -->
<div class="employee-schedule-body">
    <!-- Main Content (Removed header) -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">Employee Schedule</h1>
            <div>
                <button class="btn btn-primary" id="schedule-addEmployeeBtn">
                    <i class="fas fa-plus"></i> Add Employee
                </button>
                <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="background-color: var(--secondary);">
                    <i class="fas fa-envelope"></i> Send Reminders
                </button>
            </div>
        </div>

        <!-- Schedule Controls -->
        <div class="schedule-controls">
            <div class="week-navigation">
                <button class="btn btn-outline" id="schedule-prevWeekBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="week-display" id="schedule-weekDisplay">Loading...</div>
                <button class="btn btn-outline" id="schedule-nextWeekBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="btn btn-primary" id="schedule-saveScheduleBtn">
                <i class="fas fa-save"></i> Save Schedule
            </button>
        </div>

        <!-- Schedule Table -->
        <div class="schedule-container">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <!-- Headers populated by JS -->
                        <th>Employee</th> <th>Mon</th> <th>Tue</th> <th>Wed</th> <th>Thu</th> <th>Fri</th> <th>Sat</th> <th>Sun</th>
                    </tr>
                </thead>
                <tbody id="schedule-table-body">
                    <!-- Initial loading message -->
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Employee Modal (Structure only) -->
    <div class="modal" id="schedule-employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Employee</h2>
                <button class="close-modal" id="schedule-closeEmployeeModal">×</button>
            </div>
            <form id="schedule-employeeForm">
                <div class="form-group">
                    <label for="schedule-empName">Full Name</label>
                    <input type="text" id="schedule-empName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="schedule-empEmail">Email</label>
                    <input type="email" id="schedule-empEmail" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="schedule-cancelEmployeeBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Shift Modal (Structure only) -->
    <div class="modal" id="schedule-shiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Shift</h2>
                <button class="close-modal" id="schedule-closeShiftModal">×</button>
            </div>
            <form id="schedule-shiftForm">
                <div class="form-group">
                    <label for="schedule-shiftEmployee">Employee</label>
                    <input type="text" id="schedule-shiftEmployee" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="schedule-shiftDate">Date</label>
                    <input type="date" id="schedule-shiftDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="schedule-shiftType">Shift Type</label>
                    <select id="schedule-shiftType" class="form-control" required>
                        <option value="morning">Morning (9AM-5PM)</option>
                        <option value="afternoon">Afternoon (12PM-8PM)</option>
                        <option value="night">Night (5PM-1AM)</option>
                        <option value="day-off">Day Off</option>
                        <option value="sick-leave">Sick Leave</option>
                        <option value="vacation">Vacation</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group" id="schedule-customShiftGroup" style="display: none;">
                    <label for="schedule-customShift">Custom Shift Times</label>
                    <input type="text" id="schedule-customShift" class="form-control" placeholder="e.g., 10AM-6PM">
                </div>
                <div class="form-group">
                    <label for="schedule-shiftNotes">Notes</label>
                    <textarea id="schedule-shiftNotes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="schedule-deleteShiftBtn">Delete Shift</button>
                    <button type="button" class="btn btn-outline" id="schedule-cancelShiftBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

</div> <!-- End of .employee-schedule-body -->


<script>
    // **** START OF SCRIPT ****

    // Ensure this script doesn't run until called by dash.html
    function initializeEmployeeSchedule(dashboardCurrentUser, dashboardTeamMembers) {
        console.log("Initializing Employee Schedule Section with passed data...");
        // console.log("Received User:", dashboardCurrentUser); // Avoid logging potentially sensitive info in production
        // console.log("Received Team Members:", dashboardTeamMembers);

        const scheduleContainer = document.querySelector('.employee-schedule-body');
        if (!scheduleContainer) { console.error("Schedule container '.employee-schedule-body' not found!"); return; }

        // --- DOM Element Selection (Scoped to scheduleContainer) ---
        const employeeModal = scheduleContainer.querySelector('#schedule-employeeModal');
        const shiftModal = scheduleContainer.querySelector('#schedule-shiftModal');
        // Get main dashboard modal functions (ensure they are available globally)
        const showConfirmModalFromDash = window.showConfirmModal;
        const hideConfirmModalFromDash = window.hideConfirmModal;
        const showSuccessMessageFromDash = window.showSuccessMessage;

        const addEmployeeBtn = scheduleContainer.querySelector('#schedule-addEmployeeBtn');
        const sendRemindersBtn = scheduleContainer.querySelector('#schedule-sendRemindersBtn');
        const closeEmployeeModal = scheduleContainer.querySelector('#schedule-closeEmployeeModal');
        const closeShiftModal = scheduleContainer.querySelector('#schedule-closeShiftModal');
        const cancelEmployeeBtn = scheduleContainer.querySelector('#schedule-cancelEmployeeBtn');
        const cancelShiftBtn = scheduleContainer.querySelector('#schedule-cancelShiftBtn');
        const employeeForm = scheduleContainer.querySelector('#schedule-employeeForm');
        const shiftForm = scheduleContainer.querySelector('#schedule-shiftForm');
        const shiftTypeSelect = scheduleContainer.querySelector('#schedule-shiftType');
        const customShiftGroup = scheduleContainer.querySelector('#schedule-customShiftGroup');
        const customShiftInput = scheduleContainer.querySelector('#schedule-customShift');
        const deleteShiftBtn = scheduleContainer.querySelector('#schedule-deleteShiftBtn');
        const prevWeekBtn = scheduleContainer.querySelector('#schedule-prevWeekBtn');
        const nextWeekBtn = scheduleContainer.querySelector('#schedule-nextWeekBtn');
        const weekDisplay = scheduleContainer.querySelector('#schedule-weekDisplay');
        const saveScheduleBtn = scheduleContainer.querySelector('#schedule-saveScheduleBtn');
        const scheduleTableBody = scheduleContainer.querySelector('#schedule-table-body');
        const shiftEmployeeInput = scheduleContainer.querySelector('#schedule-shiftEmployee');
        const shiftDateInput = scheduleContainer.querySelector('#schedule-shiftDate');
        const shiftNotesInput = scheduleContainer.querySelector('#schedule-shiftNotes');

        // --- State Variables (Initialized with passed data) ---
        let scheduleCurrentUser = dashboardCurrentUser || { role: 'employee' };
        let scheduleEmployees = Array.isArray(dashboardTeamMembers) ? dashboardTeamMembers : [];
        let scheduleCurrentWeekStart = new Date();
        let scheduleSavedData = {};

        // --- Constants ---
        const scheduleMinDate = new Date(2025, 4, 1); // May 1, 2025 (Month is 0-indexed)
        const scheduleMaxDate = new Date(2025, 4, 31); // May 31, 2025
        const DAYS_OF_WEEK = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // --- Helper Functions ---
        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') return unsafe;
             return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
        }
        function formatDateKey(date) {
             if (!(date instanceof Date)) { date = new Date(date); }
             if (isNaN(date.getTime())) { console.error("Invalid date passed to formatDateKey:", date); return null; }
             const year = date.getFullYear();
             const month = (date.getMonth() + 1).toString().padStart(2, '0');
             const day = date.getDate().toString().padStart(2, '0');
             return `${year}-${month}-${day}`;
        }
        function showScheduleConfirmation(config) {
            if (typeof showConfirmModalFromDash === 'function') { showConfirmModalFromDash(config); }
            else { console.warn("Dashboard confirm modal function not found."); if (confirm(config.message)) { if (config.onConfirm) config.onConfirm(); } else { if (config.onCancel) config.onCancel(); } }
        }
        function showScheduleSuccess(message) {
              if (typeof showSuccessMessageFromDash === 'function') { showSuccessMessageFromDash(message); }
              else { alert(message); }
         }

        // --- UI Update Functions ---
        function updateWeekDisplayUI() {
            const weekEnd = new Date(scheduleCurrentWeekStart); weekEnd.setDate(weekEnd.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            const startStr = scheduleCurrentWeekStart.toLocaleDateString('en-US', options);
            const endStr = weekEnd.toLocaleDateString('en-US', options);
            const year = scheduleCurrentWeekStart.getFullYear();
            if (weekDisplay) weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;
            const headerRow = scheduleContainer.querySelector('.schedule-table thead tr');
            if (!headerRow) { console.error("Schedule header row not found!"); return; }
            headerRow.innerHTML = '<th>Employee</th>';
            const tempDate = new Date(scheduleCurrentWeekStart);
            DAYS_OF_WEEK.forEach(dayName => {
                const th = document.createElement('th');
                const dateStr = tempDate.toLocaleDateString('en-US', { day: 'numeric' });
                const monthStr = tempDate.toLocaleDateString('en-US', { month: 'short' });
                th.innerHTML = `<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${monthStr} ${dateStr}</span></div>`;
                headerRow.appendChild(th); tempDate.setDate(tempDate.getDate() + 1);
            });
            const prevWeek = new Date(scheduleCurrentWeekStart); prevWeek.setDate(prevWeek.getDate() - 7);
            if (prevWeekBtn) prevWeekBtn.disabled = prevWeek < scheduleMinDate;
            const nextWeekStart = new Date(scheduleCurrentWeekStart); nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            if (nextWeekBtn) nextWeekBtn.disabled = nextWeekStart > scheduleMaxDate;
        }

        function renderScheduleTable() {
            if (!scheduleTableBody) { console.error("scheduleTableBody element not found!"); return; }
            scheduleTableBody.innerHTML = ''; // Clear previous rows

            console.log(`Rendering schedule for ${scheduleEmployees.length} employees.`);

            if (scheduleEmployees.length === 0) {
                 scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">No employees found. Add team members first.</td></tr>`;
                 return;
            }

            const isAdminOrSupervisor = scheduleCurrentUser.role === 'admin' || scheduleCurrentUser.role === 'supervisor';

            scheduleEmployees.forEach((employee, index) => {
                if (!employee?.id || !employee?.name) { console.warn("Skipping invalid employee data:", employee); return; }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="employee-name employee-${(index % 6) + 1}">${escapeHtml(employee.name)}</td>`;
                const tempDate = new Date(scheduleCurrentWeekStart);
                DAYS_OF_WEEK.forEach((day, dayIndex) => {
                    const td = document.createElement('td'); td.classList.add('admin-controls');
                    const dateKey = formatDateKey(tempDate);
                    if (!dateKey) { td.textContent = 'Err'; tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1); return; }
                    td.dataset.label = `${day.toUpperCase()} (${tempDate.toLocaleDateString('en-us', {month:'short', day:'numeric'})})`;
                    const empKey = `emp-${employee.id}`;
                    let shiftText = ''; let shiftClass = ''; let notes = '';

                    // Check saved data
                    if (scheduleSavedData[empKey]?.[dateKey]) {
                        const shiftData = scheduleSavedData[empKey][dateKey];
                        shiftText = shiftData.text; shiftClass = shiftData.class; notes = shiftData.notes || '';
                    }
                    // ** Apply default shifts only for the specific first week (May 5th, 2025) if no saved data exists **
                    else if (scheduleCurrentWeekStart.getFullYear() === 2025 && scheduleCurrentWeekStart.getMonth() === 4 && scheduleCurrentWeekStart.getDate() === 5) {
                        const defaultShifts = {
                             1: ["9AM-5PM", "9AM-5PM", "12PM-8PM", "9AM-5PM", "OFF", "5PM-1AM", "5PM-1AM"], // Mohamed
                             2: ["12PM-8PM", "9AM-5PM", "9AM-5PM", "12PM-8PM", "9AM-5PM", "OFF", "OFF"], // Yousef
                             3: ["5PM-1AM", "5PM-1AM", "OFF", "9AM-5PM", "12PM-8PM", "9AM-5PM", "SICK"], // Esraa
                             4: ["VAC", "VAC", "9AM-5PM", "5PM-1AM", "5PM-1AM", "OFF", "9AM-5PM"] // Bassant
                         };
                         const defaultClasses = { "9AM-5PM": "shift-morning", "12PM-8PM": "shift-afternoon", "5PM-1AM": "shift-night", "OFF": "day-off", "SICK": "sick-leave", "VAC": "vacation" };
                         if (defaultShifts[employee.id]?.[dayIndex]) {
                             shiftText = defaultShifts[employee.id][dayIndex];
                             shiftClass = defaultClasses[shiftText] || 'shift-morning';
                         }
                    }

                    if (shiftText && shiftClass) {
                        const shiftDiv = document.createElement('div');
                        shiftDiv.className = `shift ${escapeHtml(shiftClass)}`;
                        shiftDiv.textContent = escapeHtml(shiftText); shiftDiv.title = escapeHtml(notes);
                        td.appendChild(shiftDiv);
                    }
                    if (isAdminOrSupervisor) {
                        const editSpan = document.createElement('span'); editSpan.className = 'edit-shift admin-visible';
                        editSpan.dataset.emp = employee.id; editSpan.dataset.dayIndex = dayIndex;
                        editSpan.textContent = '(edit)'; editSpan.onclick = handleEditShiftClick;
                        td.appendChild(editSpan);
                    }
                    tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1);
                });
                scheduleTableBody.appendChild(tr);
            });
        }

        function updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes = '') {
            if (!dateKey || typeof dateKey !== 'string' || !dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) { console.error("Invalid dateKey:", dateKey); return; }
            const dateObj = new Date(dateKey + 'T00:00:00Z'); // Use Z for UTC to avoid timezone issues in calculation
            if (isNaN(dateObj.getTime())) { console.error("Invalid date object:", dateKey); return; }
            const weekStart = new Date(scheduleCurrentWeekStart); weekStart.setUTCHours(0,0,0,0); // Compare in UTC
            const diffTime = dateObj.getTime() - weekStart.getTime();
            const dayIndex = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (dayIndex >= 0 && dayIndex <= 6) {
                 const employeeRow = Array.from(scheduleTableBody.querySelectorAll('tr')).find(row => row.querySelector(`.edit-shift[data-emp="${empId}"]`));
                 if (employeeRow) {
                     const shiftCell = employeeRow.cells[dayIndex + 1];
                     const editButton = shiftCell?.querySelector(`.edit-shift[data-emp="${empId}"][data-day-index="${dayIndex}"]`);
                     if (shiftCell && editButton) {
                         const existingShift = shiftCell.querySelector('.shift');
                         if (existingShift) existingShift.remove();
                         if (shiftText && shiftClass) {
                             const shiftDiv = document.createElement('div'); shiftDiv.className = `shift ${escapeHtml(shiftClass)}`;
                             shiftDiv.textContent = escapeHtml(shiftText); shiftDiv.title = escapeHtml(notes);
                             shiftCell.insertBefore(shiftDiv, editButton);
                         }
                     } else { console.warn(`Shift cell/edit button not found: emp ${empId}, day ${dayIndex}.`); }
                 } else { console.warn(`Employee row not found: emp ${empId}.`); }
             }
        }

        function loadShiftsForCurrentWeekUI() {
            console.log("Running loadShiftsForCurrentWeekUI()...");
            renderScheduleTable(); // Re-renders the entire table based on current state
        }

        // --- Event Handlers ---
        function handleWeekChange(direction) {
            const newWeekStart = new Date(scheduleCurrentWeekStart); newWeekStart.setDate(newWeekStart.getDate() + (direction * 7));
            if (newWeekStart < scheduleMinDate || newWeekStart > scheduleMaxDate) { console.log("Navigation blocked: Out of range."); return; }
            scheduleCurrentWeekStart = newWeekStart; updateWeekDisplayUI(); loadShiftsForCurrentWeekUI();
        }
        function handleAddEmployeeClick() { if (employeeModal) { employeeForm?.reset(); employeeModal.style.display = 'flex'; } }
        function handleSendRemindersClick() {
            const subject = encodeURIComponent('Upcoming Work Schedule Reminder');
            let body = `Dear Team Member,\n\nThis is a reminder for the week of ${weekDisplay ? weekDisplay.textContent : 'this week'}.\nPlease review your shifts.\n\nBest regards,\nManagement`;
            const encodedBody = encodeURIComponent(body); let emails = scheduleEmployees.map(e => e.email).filter(Boolean).join(',');
            if (emails) {
                const mailtoLink = `mailto:${emails}?subject=${subject}&body=${encodedBody}`;
                if (mailtoLink.length > 2000) { showScheduleConfirmation({ title: "Too Many Recipients", message: "Cannot open email for all employees at once.", confirmText: "OK", confirmClass: "btn-primary" }); return; }
                try {
                    const newWindow = window.open(mailtoLink, '_blank');
                    if(!newWindow || newWindow.closed || typeof newWindow.closed=='undefined') { showScheduleConfirmation({ title: "Email Client Blocked?", message: "Could not open email client.", confirmText: "OK", confirmClass: "btn-warning" }); }
                    else { showScheduleSuccess("Email client opened."); }
                } catch (e) { console.error("Mailto error:", e); showScheduleConfirmation({ title: "Email Error", message: "Error opening email client.", confirmText: "OK", confirmClass: "btn-danger" }); }
            } else { showScheduleSuccess("No employee emails found."); }
        }
        function handleSaveScheduleClick() { showScheduleSuccess("Schedule auto-saved."); }
        function handleEmployeeFormSubmit(e) {
            e.preventDefault(); if (!employeeModal || !employeeForm) return;
            const name = scheduleContainer.querySelector('#schedule-empName')?.value.trim();
            const email = scheduleContainer.querySelector('#schedule-empEmail')?.value.trim();
            if (!name || !email) { alert("Please fill name and email."); return; }
            const newEmployee = { id: Date.now(), name: name, email: email }; scheduleEmployees.push(newEmployee);
            if (typeof teamMembers !== 'undefined' && Array.isArray(teamMembers)) { teamMembers.push(newEmployee); if (typeof window.saveData === 'function') window.saveData(); }
            loadShiftsForCurrentWeekUI(); employeeModal.style.display = 'none'; showScheduleSuccess(`Employee ${name} added.`);
        }
        function handleEditShiftClick(event) {
            const target = event.target; const empId = parseInt(target.dataset.emp); const dayIndex = parseInt(target.dataset.dayIndex);
            const employee = scheduleEmployees.find(e => e.id === empId);
            if (employee && dayIndex >= 0 && dayIndex <= 6 && shiftModal) {
                const shiftDate = new Date(scheduleCurrentWeekStart); shiftDate.setDate(shiftDate.getDate() + dayIndex); const dateKey = formatDateKey(shiftDate);
                if (!dateKey) { console.error("Invalid date for edit:", shiftDate); return; }
                if(shiftEmployeeInput) shiftEmployeeInput.value = employee.name;
                if(shiftDateInput) { shiftDateInput.value = dateKey; shiftDateInput.min = formatDateKey(scheduleMinDate); shiftDateInput.max = formatDateKey(scheduleMaxDate); }
                const empKey = `emp-${employee.id}`; const savedShift = scheduleSavedData[empKey]?.[dateKey];
                if (savedShift) {
                    if(shiftTypeSelect) shiftTypeSelect.value = savedShift.type;
                    if(customShiftGroup) customShiftGroup.style.display = savedShift.type === 'custom' ? 'block' : 'none';
                    if(customShiftInput) { customShiftInput.value = savedShift.type === 'custom' ? savedShift.text : ''; customShiftInput.required = (savedShift.type === 'custom'); }
                    if(shiftNotesInput) shiftNotesInput.value = savedShift.notes || '';
                } else {
                    if(shiftTypeSelect) shiftTypeSelect.value = 'day-off';
                    if(customShiftGroup) customShiftGroup.style.display = 'none';
                    if(customShiftInput) { customShiftInput.value = ''; customShiftInput.required = false; }
                    if(shiftNotesInput) shiftNotesInput.value = '';
                }
                if(shiftForm) { shiftForm.dataset.empId = empId; shiftForm.dataset.dateKey = dateKey; }
                shiftModal.style.display = 'flex';
            } else { console.error("Data/Elements missing for edit modal."); }
        }
        function handleShiftFormSubmit(e) {
            e.preventDefault(); if (!shiftModal || !shiftForm) return;
            const empId = parseInt(shiftForm.dataset.empId); const dateKey = shiftForm.dataset.dateKey;
            const employee = scheduleEmployees.find(e => e.id === empId);
            if (!employee || !dateKey || !shiftTypeSelect || !customShiftInput || !shiftNotesInput) { console.error("Missing data/elements for shift form submit."); shiftModal.style.display = 'none'; return; }
            const shiftTypeValue = shiftTypeSelect.value; const customShiftText = customShiftInput.value.trim(); const notes = shiftNotesInput.value.trim();
            let shiftText = '', shiftClass = '';
            switch(shiftTypeValue) {
                 case 'morning': shiftText = '9AM-5PM'; shiftClass = 'shift-morning'; break; case 'afternoon': shiftText = '12PM-8PM'; shiftClass = 'shift-afternoon'; break;
                 case 'night': shiftText = '5PM-1AM'; shiftClass = 'shift-night'; break; case 'day-off': shiftText = 'OFF'; shiftClass = 'day-off'; break;
                 case 'sick-leave': shiftText = 'SICK'; shiftClass = 'sick-leave'; break; case 'vacation': shiftText = 'VAC'; shiftClass = 'vacation'; break;
                 case 'custom': if (!customShiftText) { alert('Please enter custom shift times.'); customShiftInput.focus(); return; } shiftText = customShiftText; shiftClass = 'shift-morning'; break;
                 default: console.warn("Unknown shift type:", shiftTypeValue); shiftModal.style.display = 'none'; return;
            }
            const empKey = `emp-${empId}`; if (!scheduleSavedData[empKey]) { scheduleSavedData[empKey] = {}; }
            scheduleSavedData[empKey][dateKey] = { type: shiftTypeValue, text: shiftText, class: shiftClass, notes: notes };
            localStorage.setItem('employeeSchedule', JSON.stringify(scheduleSavedData));
            updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes);
            shiftModal.style.display = 'none';
            const displayDate = new Date(dateKey + 'T00:00:00Z'); // Use Z for UTC
            showScheduleSuccess(`Shift updated for ${employee.name} on ${displayDate.toLocaleDateString()}.`);
        }
        function handleDeleteShiftClick() {
            if (!shiftModal || !shiftForm) return;
            const empId = parseInt(shiftForm.dataset.empId); const dateKey = shiftForm.dataset.dateKey; const employee = scheduleEmployees.find(e => e.id === empId);
            if (!employee || !dateKey) { console.error("Missing data for delete."); shiftModal.style.display = 'none'; return; }
            const displayDate = new Date(dateKey + 'T00:00:00Z'); // Use Z for UTC
            if (isNaN(displayDate.getTime())) { console.error("Invalid dateKey for delete:", dateKey); shiftModal.style.display = 'none'; return; }
            const formattedDate = displayDate.toLocaleDateString();
            showScheduleConfirmation({ title: 'Delete Shift?', message: `Delete shift for <strong>${escapeHtml(employee.name)}</strong> on ${formattedDate}?`, confirmText: 'Delete', confirmClass: 'btn-danger',
                onConfirm: () => {
                    const empKey = `emp-${empId}`;
                    if (scheduleSavedData[empKey]?.[dateKey]) {
                        delete scheduleSavedData[empKey][dateKey]; localStorage.setItem('employeeSchedule', JSON.stringify(scheduleSavedData));
                        updateShiftDisplayUI(empId, dateKey, '', ''); showScheduleSuccess(`Shift deleted for ${employee.name} on ${formattedDate}.`);
                    } else { showScheduleSuccess(`No shift found to delete for ${employee.name} on ${formattedDate}.`); }
                    // Don't hide shift modal, let confirm modal handle hiding itself
                }
            });
        }

        // --- Event Listener Setup ---
        function setupScheduleEventListeners() {
            console.log("Setting up schedule event listeners...");
             if (!prevWeekBtn || !nextWeekBtn || !addEmployeeBtn || !sendRemindersBtn || !saveScheduleBtn || !employeeModal || !shiftModal) { console.error("One or more essential elements missing!"); return; }
             prevWeekBtn.addEventListener('click', () => handleWeekChange(-1)); nextWeekBtn.addEventListener('click', () => handleWeekChange(1));
             if (scheduleCurrentUser.role === 'admin' || scheduleCurrentUser.role === 'supervisor') {
                 addEmployeeBtn.style.display = 'inline-flex'; sendRemindersBtn.style.display = 'inline-flex'; saveScheduleBtn.style.display = 'inline-flex';
                 addEmployeeBtn.addEventListener('click', handleAddEmployeeClick); sendRemindersBtn.addEventListener('click', handleSendRemindersClick); saveScheduleBtn.addEventListener('click', handleSaveScheduleClick);
             } else { addEmployeeBtn.style.display = 'none'; sendRemindersBtn.style.display = 'none'; saveScheduleBtn.style.display = 'none'; }
             // Modals
             if (closeEmployeeModal) closeEmployeeModal.addEventListener('click', () => employeeModal.style.display = 'none');
             if (cancelEmployeeBtn) cancelEmployeeBtn.addEventListener('click', () => employeeModal.style.display = 'none');
             if (employeeForm) employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
             employeeModal?.addEventListener('click', (event) => { if (event.target === employeeModal) employeeModal.style.display = 'none'; });
             if (closeShiftModal) closeShiftModal.addEventListener('click', () => shiftModal.style.display = 'none');
             if (cancelShiftBtn) cancelShiftBtn.addEventListener('click', () => shiftModal.style.display = 'none');
             if (shiftForm) shiftForm.addEventListener('submit', handleShiftFormSubmit);
             if (deleteShiftBtn) deleteShiftBtn.addEventListener('click', handleDeleteShiftClick);
             if (shiftTypeSelect) shiftTypeSelect.addEventListener('change', function() {
                 if(customShiftGroup) customShiftGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                 if(customShiftInput) customShiftInput.required = (this.value === 'custom');
             });
             shiftModal?.addEventListener('click', (event) => { if (event.target === shiftModal) shiftModal.style.display = 'none'; });
             console.log("Schedule event listeners attached.");
        }


        // --- Main Initialization Logic for this Section ---
        try {
            // 1. Load saved schedule data
            scheduleSavedData = JSON.parse(localStorage.getItem('employeeSchedule')) || {};
            console.log("Loaded saved schedule data:", Object.keys(scheduleSavedData).length, "employees with data.");

            // 2. Set initial week (Clamped to May 2025)
            const today = new Date(); const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            let potentialWeekStart = new Date(new Date().setDate(diff)); potentialWeekStart.setHours(0,0,0,0); // Normalize time

            if (potentialWeekStart < scheduleMinDate) {
                let may1Date = new Date(scheduleMinDate); let may1Day = may1Date.getDay();
                let may1Diff = may1Date.getDate() - may1Day + (may1Day === 0 ? -6 : 1);
                scheduleCurrentWeekStart = new Date(may1Date.setDate(may1Diff)); scheduleCurrentWeekStart.setHours(0,0,0,0);
                if(scheduleCurrentWeekStart < scheduleMinDate) { scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate() + 7); }
            } else if (potentialWeekStart > scheduleMaxDate) {
                let may31Date = new Date(scheduleMaxDate); let may31Day = may31Date.getDay();
                let may31Diff = may31Date.getDate() - may31Day + (may31Day === 0 ? -6 : 1);
                scheduleCurrentWeekStart = new Date(may31Date.setDate(may31Diff)); scheduleCurrentWeekStart.setHours(0,0,0,0);
            } else { scheduleCurrentWeekStart = potentialWeekStart; }
            console.log("Initial week start date set to:", scheduleCurrentWeekStart.toDateString());

            // 3. Initial UI setup
            updateWeekDisplayUI();
            loadShiftsForCurrentWeekUI(); // This calls renderScheduleTable
            setupScheduleEventListeners();

            console.log("Employee Schedule Section Initialized Successfully.");

        } catch (error) {
             console.error("Error during employee schedule initialization:", error);
             if(scheduleTableBody) { scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--danger);">Error initializing schedule. See console.</td></tr>`; }
        }

    } // **** END of initializeEmployeeSchedule function ****
</script>

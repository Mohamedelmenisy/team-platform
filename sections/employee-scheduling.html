<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Schedule | Team Management Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS Styles remain the same as your previous correct version --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e3a8a;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;

            /* Shift colors */
            --shift-morning-bg: #dbeafe; --shift-morning-text: #1e40af;
            --shift-afternoon-bg: #e0f2fe; --shift-afternoon-text: #0c4a6e;
            --shift-night-bg: #ede9fe; --shift-night-text: #5b21b6;
            --shift-off-bg: #f0fdf4; --shift-off-text: #166534;
            --shift-sick-bg: #fee2e2; --shift-sick-text: #991b1b;
            --shift-vacation-bg: #ffedd5; --shift-vacation-text: #9a3412;
            --shift-custom-bg: var(--light-gray); --shift-custom-text: var(--dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            opacity: 0; /* Start hidden, fade in with JS */
            transition: opacity 0.5s ease-in-out;
        }

        body.loaded {
            opacity: 1;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem; /* Adjust if initials are long */
        }

        /* Main Content */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem; /* Reduced padding */
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Add gap for wrapped items */
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
        }

        .page-header > div { /* Button container */
             display: flex;
             gap: 0.75rem;
             flex-wrap: wrap;
        }

        /* Schedule Controls */
        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            background-color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap; /* Allow wrapping */
            gap: 1rem; /* Gap for wrapped items */
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-grow: 1; /* Allow taking space */
            justify-content: center; /* Center on smaller screens when wrapped */
        }

        .week-display {
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .btn {
            padding: 0.6rem 1.2rem; /* Slightly larger padding */
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex; /* Use inline-flex */
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap; /* Prevent wrapping text */
        }
         .btn:disabled {
            background-color: var(--light-gray) !important; /* Use important to override */
            color: var(--gray) !important;
            cursor: not-allowed !important;
            border-color: var(--light-gray) !important;
            box-shadow: none !important;
            transform: none !important;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .btn-primary.btn-warning { /* Style for unsaved changes */
             background-color: var(--warning);
             color: var(--dark);
        }
        .btn-primary.btn-warning:hover:not(:disabled) {
             background-color: #d97706; /* Darker warning */
        }


        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--light-gray);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .btn-secondary {
             background-color: var(--secondary);
             color: white;
        }
         .btn-secondary:hover:not(:disabled) {
             background-color: #059669; /* Darker green */
             transform: translateY(-1px);
        }
        .btn-cancel {
             background-color: var(--white);
             color: var(--gray);
             border: 1px solid var(--light-gray);
        }
         .btn-cancel:hover:not(:disabled) {
             background-color: var(--light-gray);
             border-color: var(--gray);
         }


        /* Schedule Table */
        .schedule-container {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Keep horizontal scroll */
            width: 100%;
        }

        .schedule-table {
            width: 100%;
            min-width: 800px; /* Minimum width before scrolling starts */
            border-collapse: separate;
            border-spacing: 0 8px; /* Spacing between rows */
            table-layout: fixed; /* Helps with sticky columns */
        }

        .schedule-table thead th {
            padding: 1rem 0.5rem;
            text-align: center;
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10; /* Ensure header stays above content */
            border-bottom: 2px solid var(--primary-dark); /* Stronger bottom border */
        }
        /* Style first header cell specifically */
        .schedule-table thead th:first-child {
            text-align: left;
            padding-left: 1rem;
             position: sticky;
             left: 0;
             z-index: 11; /* Above other headers */
             background-color: var(--primary); /* Ensure background continuity */
             width: 180px; /* Fixed width for employee name column */
        }

        .schedule-table tbody td {
            padding: 0.5rem;
            text-align: center;
            background-color: var(--white);
            border: 1px solid var(--light-gray);
            border-left: none; /* Remove individual left borders */
            border-right: none; /* Remove individual right borders */
            height: 70px; /* Give cells a bit more height */
            vertical-align: top; /* Align content to top */
        }
         /* Add borders only to the start and end of the row */
        .schedule-table tbody tr td:first-child {
             border-left: 1px solid var(--light-gray);
        }
         .schedule-table tbody tr td:last-child {
             border-right: 1px solid var(--light-gray);
        }

        .schedule-table tbody tr:hover td {
            background-color: #f0f9ff; /* Slight hover effect for rows */
        }

        .employee-name {
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            background-color: inherit; /* Inherit from row hover */
            padding: 0.75rem 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 180px; /* Match header width */
            border-right: 1px solid var(--light-gray); /* Add right border */
            vertical-align: middle; /* Center name vertically */
        }

        /* Shift Styles */
        .shift {
            padding: 0.35rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            display: inline-block;
            margin-bottom: 0.25rem;
            border: 1px solid transparent; /* Base border */
            line-height: 1.3;
        }

        .shift-morning { background-color: var(--shift-morning-bg); color: var(--shift-morning-text); border-color: var(--shift-morning-text); }
        .shift-afternoon { background-color: var(--shift-afternoon-bg); color: var(--shift-afternoon-text); border-color: var(--shift-afternoon-text);}
        .shift-night { background-color: var(--shift-night-bg); color: var(--shift-night-text); border-color: var(--shift-night-text); }
        .day-off { background-color: var(--shift-off-bg); color: var(--shift-off-text); border-color: var(--shift-off-text);}
        .sick-leave { background-color: var(--shift-sick-bg); color: var(--shift-sick-text); border-color: var(--shift-sick-text);}
        .vacation { background-color: var(--shift-vacation-bg); color: var(--shift-vacation-text); border-color: var(--shift-vacation-text);}
        .shift-custom { background-color: var(--shift-custom-bg); color: var(--shift-custom-text); border-color: var(--gray);}


        /* Compact day headers */
        .day-header {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .day-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .day-date {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 41, 59, 0.6); /* Use --dark with alpha */
            z-index: 1000;
            display: flex; /* Use flex for centering */
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(3px); /* Subtle blur effect */
            opacity: 0; /* Start hidden for fade */
            transition: opacity 0.3s ease-in-out;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: var(--white);
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95); /* Start slightly smaller for animation */
            transition: transform 0.3s ease-in-out;
        }

        .modal.show .modal-content {
             transform: scale(1);
        }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
            padding: 0.25rem 0.5rem; /* Make it easier to click */
        }
        .close-modal:hover {
             color: var(--dark);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); /* var(--primary) with alpha */
        }
        .form-control[readonly] {
            background-color: var(--light-gray);
            cursor: not-allowed;
            opacity: 0.7;
        }
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-gray);
        }

        /* Admin Controls within cells */
        .admin-controls {
            position: relative;
             min-height: 55px; /* Ensure cell has consistent height */
             padding: 0.5rem;
        }

        .edit-shift-link {
            cursor: pointer;
            color: var(--primary);
            font-size: 0.8rem;
            text-decoration: none; /* Remove underline */
            display: block;
            margin-top: 0.35rem;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s;
            border: 1px dashed var(--light-gray);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            text-align: center;
        }
        .edit-shift-link:hover {
            background-color: var(--light-gray);
            color: var(--primary-dark);
            border-style: solid;
        }

        /* Show edit link only on hover IF user is NOT admin/supervisor */
        .admin-controls:hover .edit-shift-link {
            opacity: 1;
        }
        /* Always show edit link if user IS admin/supervisor */
        body.is-admin .edit-shift-link,
        body.is-supervisor .edit-shift-link {
             opacity: 1;
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            /* Uses same base styles as .modal */
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(30, 41, 59, 0.6);
            z-index: 1050; /* Above regular modals */
            display: flex;
            justify-content: center; align-items: center;
            padding: 1rem;
             backdrop-filter: blur(3px);
             opacity: 0;
             transition: opacity 0.3s ease-in-out;
        }
        .confirmation-dialog.show {
            opacity: 1;
        }

        .dialog-content {
            /* Uses same base styles as .modal-content */
            background-color: var(--white);
            width: 90%;
            max-width: 400px; /* Smaller */
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
             transform: scale(0.95);
             transition: transform 0.3s ease-in-out;
        }
        .confirmation-dialog.show .dialog-content {
             transform: scale(1);
        }

        .dialog-icon {
             font-size: 2.8rem; /* Larger icon */
             margin-bottom: 1rem;
        }
        /* Icon specific colors */
        .dialog-icon .fa-check-circle { color: var(--secondary); }
        .dialog-icon .fa-exclamation-triangle { color: var(--warning); }
        .dialog-icon .fa-times-circle { color: var(--danger); }
        .dialog-icon .fa-info-circle { color: var(--primary); }
        .dialog-icon .fa-question-circle { color: var(--gray); } /* For confirmation */


        .dialog-message {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--dark);
            line-height: 1.6;
        }

        .dialog-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
         .btn-confirm {
             min-width: 80px;
         }
         .btn-cancel {
             min-width: 80px;
         }

        /* Responsive Design */
        @media (max-width: 992px) {
             .employee-name, .schedule-table thead th:first-child {
                 position: static; /* Unstick employee name on smaller screens */
                 width: auto; /* Allow width to adjust */
                 border-right: none;
             }
             .schedule-table thead th {
                 position: static; /* Unstick header */
             }
             .schedule-table {
                 table-layout: auto; /* Switch layout for better wrapping */
                 min-width: 0; /* Remove min-width */
             }
             .schedule-table tbody td {
                  white-space: normal; /* Allow text wrapping */
                  height: auto; /* Allow height to adjust */
                  min-height: 60px;
             }
              .shift {
                  font-size: 0.75rem;
                   padding: 0.25rem 0.4rem;
              }
              .edit-shift-link {
                  font-size: 0.7rem;
                  padding: 0.15rem 0.3rem;
              }
        }

        @media (max-width: 768px) {
            .header-container {
                 flex-direction: column;
                 gap: 1rem;
                 align-items: flex-start;
            }
             .user-menu {
                 align-self: flex-end;
             }
            .schedule-controls {
                /* Already wraps, adjust gap */
                gap: 0.75rem;
            }
            .week-navigation {
                width: 100%; /* Take full width when wrapped */
                justify-content: space-between; /* Space out nav buttons */
            }
             .week-display {
                 min-width: 150px; /* Allow shrinking */
                 flex-grow: 1;
             }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
             .page-header > div { /* Button container */
                 gap: 0.5rem;
             }
             .btn {
                 padding: 0.6rem 0.8rem; /* Keep touch-friendly */
             }
             .modal-content {
                 padding: 1.5rem;
             }
             .modal-title {
                 font-size: 1.3rem;
             }
             .form-actions {
                 flex-direction: column; /* Stack buttons */
                 gap: 0.75rem;
             }
             .form-actions .btn {
                 width: 100%; /* Full width buttons */
             }
             .dialog-content {
                 padding: 1.5rem;
             }
        }
         @media (max-width: 480px) {
              header { padding: 1rem 1.5rem; }
              .logo { font-size: 1.3rem; }
              /* Removed user-email specific style, rely on general user-menu gap */
              .user-avatar { width: 35px; height: 35px; font-size: 0.8rem;}
              .main-container { padding: 0 0.5rem; }
              .page-title { font-size: 1.5rem; }
              .day-name { font-size: 0.8rem; }
              .day-date { font-size: 0.7rem; }
              .schedule-table thead th { padding: 0.75rem 0.25rem; font-size: 0.85rem; }
              .shift { font-size: 0.7rem; padding: 0.2rem 0.3rem; }
              .edit-shift-link { font-size: 0.7rem; padding: 0.1rem 0.2rem;}
              .schedule-table tbody td { padding: 0.3rem; }
              .btn { padding: 0.5rem 0.7rem; font-size: 0.9rem; }
              .week-display { font-size: 0.9rem; min-width: 120px; }
         }

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">TeamSchedule</div>
            <div class="user-menu">
                <span id="userEmail">loading...</span>
                <div class="user-avatar" id="userInitials">??</div>
            </div>
        </div>
    </header>

    <!-- Main Content Wrapper (Added for better modal interaction if needed later) -->
    <div id="mainContentWrapper">
        <div class="main-container">
            <div class="page-header">
                <h1 class="page-title">Employee Schedule</h1>
                <div>
                    <button class="btn btn-primary" id="addEmployeeBtn" style="display: none;">
                        <i class="fas fa-user-plus"></i> Add Employee
                    </button>
                    <button class="btn btn-secondary" id="sendRemindersBtn" style="display: none;">
                        <i class="fas fa-envelope"></i> Send Reminders
                    </button>
                </div>
            </div>

            <!-- Schedule Controls -->
            <div class="schedule-controls">
                <div class="week-navigation">
                    <button class="btn btn-outline" id="prevWeekBtn">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <div class="week-display" id="weekDisplay">Loading...</div>
                    <button class="btn btn-outline" id="nextWeekBtn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <button class="btn btn-primary" id="saveScheduleBtn" style="display: none;">
                    <i class="fas fa-save"></i> Publish Changes
                </button>
            </div>

            <!-- Schedule Table -->
            <div class="schedule-container">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th><div class="day-header"><span class="day-name">Sun</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Mon</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Tue</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Wed</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Thu</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Fri</span><span class="day-date"></span></div></th>
                            <th><div class="day-header"><span class="day-name">Sat</span><span class="day-date"></span></div></th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <!-- Employee rows will be generated dynamically by JS -->
                        <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div><!-- End #mainContentWrapper -->


    <!-- Add Employee Modal -->
    <div class="modal" id="employeeModal" aria-labelledby="employeeModalTitle" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeModalTitle">Add New Employee</h2>
                <button class="close-modal" data-close="employeeModal" aria-label="Close">×</button>
            </div>
            <form id="employeeForm">
                <div class="form-group">
                    <label for="empName">Full Name</label>
                    <input type="text" id="empName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="empEmail">Email</label>
                    <input type="email" id="empEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="empPosition">Position</label>
                    <input type="text" id="empPosition" class="form-control"> <!-- Made optional -->
                </div>
                <div class="form-group">
                    <label for="empRole">Role</label>
                    <select id="empRole" class="form-control" required>
                        <option value="employee">Employee</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" data-close="employeeModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Shift Modal -->
    <div class="modal" id="shiftModal" aria-labelledby="shiftModalTitle" aria-modal="true" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="shiftModalTitle">Edit Shift</h2>
                <button class="close-modal" data-close="shiftModal" aria-label="Close">×</button>
            </div>
            <form id="shiftForm">
                 <input type="hidden" id="shiftEmpId">
                 <input type="hidden" id="originalShiftDate"> <!-- To track date changes -->
                <div class="form-group">
                    <label for="shiftEmployeeName">Employee</label>
                    <input type="text" id="shiftEmployeeName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="shiftDate">Date</label>
                    <input type="date" id="shiftDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="shiftType">Shift Type</label>
                    <select id="shiftType" class="form-control" required>
                        <option value="9-5">9AM - 5PM</option>
                        <option value="10-6">10AM - 6PM</option>
                        <option value="11-7">11AM - 7PM</option>
                        <option value="12-8">12PM - 8PM</option>
                        <option value="night">Night (5PM - 1AM)</option> <!-- Kept night shift -->
                        <option value="day-off">Day Off</option>
                        <option value="sick-leave">Sick Leave</option>
                        <option value="vacation">Vacation</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group" id="customShiftGroup" style="display: none;">
                    <label for="customShift">Custom Shift Times/Text</label>
                    <input type="text" id="customShift" class="form-control" placeholder="e.g., 10AM-2PM Training">
                </div>
                <div class="form-group">
                    <label for="shiftNotes">Notes (optional)</label>
                    <textarea id="shiftNotes" class="form-control" rows="3" placeholder="Add any relevant notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="deleteShiftBtn">Delete Shift</button>
                    <button type="button" class="btn btn-cancel" data-close="shiftModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog" aria-labelledby="dialogMessage" aria-modal="true" role="alertdialog">
        <div class="dialog-content">
             <div id="dialogIconContainer"></div>
             <div class="dialog-message" id="dialogMessage"></div>
             <div class="dialog-actions">
                 <button class="btn btn-cancel" id="confirmCancelBtn" style="display: none;">Cancel</button>
                 <button class="btn btn-primary btn-confirm" id="confirmOkBtn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- Robust way to get data from localStorage ---
        function getLocalStorageItem(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                // Check if item is null, undefined, or the string "undefined" which sometimes happens
                if (item === null || item === undefined || item === 'undefined') {
                    console.warn(`LocalStorage item "${key}" not found or invalid, returning default.`);
                    return defaultValue;
                }
                return JSON.parse(item);
            } catch (e) {
                console.error(`Error parsing localStorage item "${key}":`, e);
                // Optionally clear the corrupted item: localStorage.removeItem(key);
                return defaultValue; // Return default value if parsing fails
            }
        }

        // --- Login Check ---
        let currentUser = getLocalStorageItem('currentUser', null);
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true'; // Simple flag check is okay

        if (!isLoggedIn || !currentUser) {
            console.warn("User not logged in or currentUser data missing/invalid. Redirecting...");
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            // Stop script execution here if redirecting
            // Using throw new Error() can sometimes help ensure nothing else runs,
            // but redirect should generally be enough.
            // throw new Error("Redirecting to login.");
        } else {
            // --- Start Schedule Page Logic ONLY if logged in ---
            document.addEventListener('DOMContentLoaded', function() {

                try { // Wrap the entire DOMContentLoaded logic in a try...catch

                    // --- Configuration ---
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Normalize
                    const currentDayOfWeek = today.getDay();
                    const START_DATE = new Date(today);
                    START_DATE.setDate(today.getDate() - currentDayOfWeek);

                    const DAYS_IN_WEEK = 7;
                    const DAY_KEYS = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

                    // --- DOM Elements ---
                    const body = document.body;
                    const mainContentWrapper = document.getElementById('mainContentWrapper'); // Get the wrapper
                    const employeeModal = document.getElementById('employeeModal');
                    const shiftModal = document.getElementById('shiftModal');
                    const confirmationDialog = document.getElementById('confirmationDialog');
                    const dialogMessage = document.getElementById('dialogMessage');
                    const dialogIconContainer = document.getElementById('dialogIconContainer');
                    const confirmOkBtn = document.getElementById('confirmOkBtn');
                    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
                    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
                    const sendRemindersBtn = document.getElementById('sendRemindersBtn');
                    const employeeForm = document.getElementById('employeeForm');
                    const shiftForm = document.getElementById('shiftForm');
                    const shiftType = document.getElementById('shiftType');
                    const customShiftGroup = document.getElementById('customShiftGroup');
                    const customShiftInput = document.getElementById('customShift');
                    const deleteShiftBtn = document.getElementById('deleteShiftBtn');
                    const prevWeekBtn = document.getElementById('prevWeekBtn');
                    const nextWeekBtn = document.getElementById('nextWeekBtn');
                    const weekDisplay = document.getElementById('weekDisplay');
                    const saveScheduleBtn = document.getElementById('saveScheduleBtn');
                    const userEmail = document.getElementById('userEmail');
                    const userInitials = document.getElementById('userInitials');
                    const scheduleBody = document.getElementById('scheduleBody');
                    const shiftDateInput = document.getElementById('shiftDate');
                    const shiftEmpIdInput = document.getElementById('shiftEmpId');
                    const shiftEmployeeNameInput = document.getElementById('shiftEmployeeName');
                    const shiftNotesInput = document.getElementById('shiftNotes');
                    const originalShiftDateInput = document.getElementById('originalShiftDate');

                    // --- State ---
                    let currentWeekStart = new Date(START_DATE);
                    // Use the robust getter function for localStorage
                    let savedSchedule = getLocalStorageItem('employeeSchedule', {}); // Default to empty object
                    let employees = getLocalStorageItem('employees', [ // Default employees if none/invalid
                        { id: 1, name: 'Mohamed Elmenisy', email: 'mohamed@example.com', position: 'Developer', role: 'employee' },
                        { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', position: 'Designer', role: 'employee' },
                        { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', position: 'QA Tester', role: 'employee' },
                        { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', position: 'Manager', role: 'supervisor' }
                    ]);
                    // Ensure employees is always an array
                    if (!Array.isArray(employees)) {
                        console.warn("'employees' from localStorage was not an array, using default.");
                        employees = [
                             { id: 1, name: 'Mohamed Elmenisy', email: 'mohamed@example.com', position: 'Developer', role: 'employee' },
                             { id: 2, name: 'Yousef Ahmed', email: 'yousef@example.com', position: 'Designer', role: 'employee' },
                             { id: 3, name: 'Esraa Lashin', email: 'esraa@example.com', position: 'QA Tester', role: 'employee' },
                             { id: 4, name: 'Bassant Badr', email: 'bassant@example.com', position: 'Manager', role: 'supervisor' }
                         ];
                    }

                    let nextEmployeeId = employees.length > 0 ? Math.max(0, ...employees.map(e => e.id)) + 1 : 1; // Added Math.max(0, ...) for safety


                    // --- Initialization ---
                    init();

                    // --- Functions ---

                    function init() {
                        console.log("Initializing schedule page...");
                        console.log("Current User:", currentUser); // Logged already outside, but good to see here too
                        setupCurrentUser();
                        renderEmployeeRows();
                        updateWeekDisplay();
                        loadShiftsForCurrentWeek();
                        setupEventListeners();
                        body.classList.add('loaded'); // Fade in the body *after* setup
                        console.log("Initialization complete.");
                    }

                    function setupCurrentUser() {
                        // Already checked currentUser exists before DOMContentLoaded
                        userEmail.textContent = currentUser.email || 'No Email';
                        userInitials.textContent = (currentUser.name || currentUser.email?.split('@')[0] || '??')
                            .split(' ')
                            .map(n => n ? n[0] : '') // Add check for empty name parts
                            .join('')
                            .toUpperCase()
                            .substring(0, 2);

                        body.classList.remove('is-admin', 'is-supervisor', 'is-employee');
                        if (currentUser.role === 'admin') body.classList.add('is-admin');
                        else if (currentUser.role === 'supervisor') body.classList.add('is-supervisor');
                        else body.classList.add('is-employee'); // Default to employee if role is missing/invalid

                        const isAdminOrSupervisor = currentUser.role === 'admin' || currentUser.role === 'supervisor';
                        // Ensure buttons exist before trying to style them
                        if (addEmployeeBtn) addEmployeeBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';
                        if (sendRemindersBtn) sendRemindersBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';
                        if (saveScheduleBtn) saveScheduleBtn.style.display = isAdminOrSupervisor ? 'inline-flex' : 'none';
                    }

                    function renderEmployeeRows() {
                         if (!scheduleBody) {
                             console.error("Schedule table body not found!");
                             return;
                         }
                         scheduleBody.innerHTML = ''; // Clear existing rows/loading message
                         if (!employees || employees.length === 0) {
                             scheduleBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">No employees added yet.</td></tr>';
                             return;
                         }
                         console.log(`Rendering ${employees.length} employee rows.`);
                         employees.forEach(emp => {
                             // Basic check for valid employee object
                             if (emp && typeof emp === 'object' && emp.id !== undefined && emp.name !== undefined) {
                                  addEmployeeRowToTable(emp);
                             } else {
                                 console.warn("Skipping invalid employee data:", emp);
                             }
                         });
                    }

                    function addEmployeeRowToTable(employee) {
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-employee-row-id', employee.id);

                        let cellsHtml = `<td class="employee-name">${employee.name || 'Unnamed Employee'}</td>`;

                        for (let i = 0; i < DAYS_IN_WEEK; i++) {
                            const dayKey = DAY_KEYS[i];
                            cellsHtml += `
                                <td class="admin-controls" data-emp-id="${employee.id}" data-day-index="${i}" data-day-key="${dayKey}">
                                    <span class="edit-shift-link" role="button" tabindex="0" data-emp="${employee.id}" data-day="${dayKey}">(add)</span>
                                </td>`;
                        }
                        newRow.innerHTML = cellsHtml;
                        if (scheduleBody) { // Check again just in case
                            scheduleBody.appendChild(newRow);
                        }
                    }

                    function formatDateKey(date) {
                        const year = date.getUTCFullYear();
                        const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                        const day = date.getUTCDate().toString().padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }

                    function getDateFromKey(dateKey) {
                        try {
                             const parts = dateKey.split('-');
                             return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        } catch (e) {
                            console.error("Error parsing date key:", dateKey, e);
                            return new Date(); // Return today as fallback
                        }
                    }

                    function showModal(modalElement) {
                         if (!modalElement) return;
                         // Optional: Hide main content for screen readers
                         // if (mainContentWrapper) mainContentWrapper.setAttribute('aria-hidden', 'true');
                         modalElement.style.display = 'flex';
                         setTimeout(() => {
                             modalElement.classList.add('show');
                             // Focus first focusable element in modal? (Advanced)
                         }, 10);
                    }

                    function hideModal(modalElement) {
                         if (!modalElement) return;
                          // Optional: Restore main content visibility
                         // if (mainContentWrapper) mainContentWrapper.removeAttribute('aria-hidden');
                         modalElement.classList.remove('show');
                         setTimeout(() => {
                             modalElement.style.display = 'none';
                         }, 300);
                    }

                    // showDialog function remains largely the same, ensure it uses hideModal
                    function showDialog(message, type = 'info', showCancel = false) {
                        if (!confirmationDialog || !dialogMessage || !confirmOkBtn || !confirmCancelBtn || !dialogIconContainer) {
                            console.error("Confirmation dialog elements not found!");
                            alert(message); // Fallback to alert
                            return Promise.reject("Dialog elements missing");
                        }
                        dialogMessage.textContent = message;
                        confirmCancelBtn.style.display = showCancel ? 'inline-flex' : 'none';

                        let iconClass = 'fas fa-info-circle'; // Default
                        if (type === 'success') iconClass = 'fas fa-check-circle';
                        else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
                        else if (type === 'error') iconClass = 'fas fa-times-circle';
                        else if (type === 'confirm') iconClass = 'fas fa-question-circle';

                        dialogIconContainer.innerHTML = `<div class="dialog-icon"><i class="${iconClass}"></i></div>`;

                        confirmationDialog.style.display = 'flex';
                        setTimeout(() => confirmationDialog.classList.add('show'), 10);


                        return new Promise((resolve, reject) => {
                            // Remove previous listeners before adding new ones
                            const newOkBtn = confirmOkBtn.cloneNode(true);
                            confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
                            confirmOkBtn = newOkBtn; // Update reference

                            const newCancelBtn = confirmCancelBtn.cloneNode(true);
                            confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);
                            confirmCancelBtn = newCancelBtn; // Update reference

                            confirmOkBtn.onclick = () => {
                                hideModal(confirmationDialog);
                                resolve(true);
                            };
                            if (showCancel) { // Only add listener if button is shown
                                confirmCancelBtn.onclick = () => {
                                    hideModal(confirmationDialog);
                                    reject(false);
                                };
                            }

                            const backdropHandler = (event) => {
                                if (event.target === confirmationDialog) {
                                    hideModal(confirmationDialog);
                                    confirmationDialog.removeEventListener('click', backdropHandler); // Clean up listener
                                    reject(false);
                                }
                            };
                             // Add backdrop listener (ensure it's cleaned up)
                             confirmationDialog.removeEventListener('click', backdropHandler); // Remove old one first
                             confirmationDialog.addEventListener('click', backdropHandler);
                        });
                    }


                    function updateWeekDisplay() {
                        const weekEnd = new Date(currentWeekStart);
                        weekEnd.setDate(weekEnd.getDate() + DAYS_IN_WEEK - 1);

                        const options = { month: 'short', day: 'numeric' };
                        const startStr = currentWeekStart.toLocaleDateString('en-US', options);
                        const endStr = weekEnd.toLocaleDateString('en-US', options);
                        const year = currentWeekStart.getFullYear();

                        if (weekDisplay) weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;

                        const dayNameCells = document.querySelectorAll('.day-name');
                        const dateCells = document.querySelectorAll('.day-date');
                        const tempDate = new Date(currentWeekStart);

                        DAY_KEYS.forEach((dayKey, index) => {
                            const currentTempDate = new Date(tempDate); // Use a copy for each iteration
                            if (dayNameCells[index]) dayNameCells[index].textContent = currentTempDate.toLocaleDateString('en-US', { weekday: 'short' });
                            if (dateCells[index]) {
                                dateCells[index].textContent = currentTempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const headerCell = dateCells[index].closest('th');
                                if(headerCell) headerCell.setAttribute('data-date', formatDateKey(currentTempDate));
                            }
                             tempDate.setDate(tempDate.getDate() + 1); // Increment original tempDate for next loop
                        });
                    }


                    if (shiftType) { // Add check for element existence
                        shiftType.addEventListener('change', function() {
                            if (customShiftGroup) {
                                customShiftGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                            }
                             if(customShiftInput) { // Add check
                                 customShiftInput.required = (this.value === 'custom');
                             }
                        });
                    }

                    function setupEventListeners() {
                        console.log("Setting up event listeners...");
                        if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
                        if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => navigateWeek(1));
                        if (addEmployeeBtn) addEmployeeBtn.addEventListener('click', openAddEmployeeModal);

                        document.addEventListener('click', (event) => {
                            if (event.target.matches('.close-modal, [data-close]')) {
                                const modalId = event.target.getAttribute('data-close') || event.target.closest('.modal')?.id;
                                if (modalId) {
                                    const modalToClose = document.getElementById(modalId);
                                    if (modalToClose) hideModal(modalToClose);
                                }
                            }
                            if (event.target.matches('.modal:not(.confirmation-dialog)')) {
                                hideModal(event.target);
                            }
                        });

                        if (employeeForm) employeeForm.addEventListener('submit', handleAddEmployee);
                        if (shiftForm) shiftForm.addEventListener('submit', handleSaveShift);
                        if (deleteShiftBtn) deleteShiftBtn.addEventListener('click', handleDeleteShift);
                        if (saveScheduleBtn) saveScheduleBtn.addEventListener('click', handlePublishSchedule);
                        if (sendRemindersBtn) sendRemindersBtn.addEventListener('click', handleSendReminders);

                        if (scheduleBody) {
                            scheduleBody.addEventListener('click', function(event) {
                                const link = event.target.closest('.edit-shift-link');
                                if (link) {
                                     event.preventDefault();
                                    if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                                         openEditShiftModal(link);
                                    } else {
                                        showDialog("You do not have permission to edit shifts.", "warning");
                                    }
                                }
                            });
                        } else {
                            console.error("Cannot add schedule body listener: Element not found.");
                        }
                        console.log("Event listeners setup complete.");
                    }

                    // --- Event Handlers ---

                    function navigateWeek(direction) {
                         console.log(`Navigating week by ${direction}`);
                         currentWeekStart.setDate(currentWeekStart.getDate() + (direction * DAYS_IN_WEEK));
                         updateWeekDisplay();
                         loadShiftsForCurrentWeek();
                    }

                    function openAddEmployeeModal() {
                         if(employeeForm) employeeForm.reset();
                         showModal(employeeModal);
                         if (document.getElementById('empName')) document.getElementById('empName').focus();
                    }

                    function handleAddEmployee(e) {
                        e.preventDefault();
                         const nameInput = document.getElementById('empName');
                         const emailInput = document.getElementById('empEmail');
                         const positionInput = document.getElementById('empPosition');
                         const roleInput = document.getElementById('empRole');

                         // Ensure inputs exist before getting value
                         const name = nameInput ? nameInput.value.trim() : '';
                         const email = emailInput ? emailInput.value.trim() : '';
                         const position = positionInput ? positionInput.value.trim() : '';
                         const role = roleInput ? roleInput.value : 'employee';

                         if (!name || !email) {
                             showDialog("Please fill in Name and Email.", "warning"); return;
                         }
                         if (!/\S+@\S+\.\S+/.test(email)) {
                             showDialog("Please enter a valid email address.", "warning"); return;
                         }
                         if (employees.some(emp => emp.email.toLowerCase() === email.toLowerCase())) {
                             showDialog(`An employee with the email ${email} already exists.`, "warning"); return;
                         }

                        const newEmployee = { id: nextEmployeeId++, name, email, position, role };
                        employees.push(newEmployee);
                        try {
                            localStorage.setItem('employees', JSON.stringify(employees));
                        } catch (storageError) {
                             console.error("Error saving employees to localStorage:", storageError);
                             showDialog("Could not save employee list. Storage might be full.", "error");
                        }

                        addEmployeeRowToTable(newEmployee);
                        loadShiftsForCurrentWeek(); // Apply defaults/shifts for the new row

                         if(employeeForm) employeeForm.reset();
                        hideModal(employeeModal);
                        showDialog(`Employee "${name}" added successfully.`, "success");
                    }

                    function openEditShiftModal(linkElement) {
                        if (!linkElement) return;
                        console.log("Opening edit shift modal for link:", linkElement);

                        const empId = parseInt(linkElement.getAttribute('data-emp'));
                        const cell = linkElement.closest('td');
                        if (!cell) { console.error("Parent cell not found for edit link."); return; }
                        const dayIndex = parseInt(cell.getAttribute('data-day-index'));

                        const employee = employees.find(e => e.id === empId);

                        if (!employee || isNaN(dayIndex)) {
                             console.error("Could not find employee or day index for shift modal.", empId, dayIndex);
                             showDialog("Error opening shift editor: Invalid data.", "error"); return;
                        }

                        const date = new Date(currentWeekStart);
                        date.setDate(date.getDate() + dayIndex);
                        const dateKey = formatDateKey(date);

                        console.log(`Editing shift for EmpID: ${empId}, Name: ${employee.name}, Date: ${dateKey}`);

                        // Ensure modal elements exist before setting values
                        if (shiftEmpIdInput) shiftEmpIdInput.value = empId;
                        if (shiftEmployeeNameInput) shiftEmployeeNameInput.value = employee.name;
                        if (shiftDateInput) shiftDateInput.value = dateKey;
                        if (originalShiftDateInput) originalShiftDateInput.value = dateKey;


                        const empSchedule = savedSchedule[`emp-${empId}`] || {};
                        const savedShift = empSchedule[dateKey];

                        if (savedShift) {
                            console.log("Found saved shift:", savedShift);
                            if (shiftType) shiftType.value = savedShift.type || '9-5'; // Fallback type
                            if (shiftNotesInput) shiftNotesInput.value = savedShift.notes || '';
                            if (customShiftInput) customShiftInput.value = savedShift.type === 'custom' ? (savedShift.text || '') : '';
                            if (customShiftGroup) customShiftGroup.style.display = savedShift.type === 'custom' ? 'block' : 'none';
                            if (customShiftInput) customShiftInput.required = savedShift.type === 'custom';
                        } else {
                            console.log("No saved shift found, setting defaults.");
                             const defaultType = (dayIndex === 5 || dayIndex === 6) ? 'day-off' : '9-5';
                            if (shiftType) shiftType.value = defaultType;
                            if (shiftNotesInput) shiftNotesInput.value = '';
                            if (customShiftInput) customShiftInput.value = '';
                            if (customShiftGroup) customShiftGroup.style.display = 'none';
                            if (customShiftInput) customShiftInput.required = false;
                        }

                        showModal(shiftModal);
                    }

                    function handleSaveShift(e) {
                        e.preventDefault();
                        console.log("Saving shift...");

                        // Ensure elements exist
                         if (!shiftEmpIdInput || !shiftType || !customShiftInput || !shiftDateInput || !originalShiftDateInput || !shiftNotesInput) {
                             console.error("Shift form elements missing!");
                             showDialog("Error: Shift form elements are missing.", "error");
                             return;
                         }


                        const empId = parseInt(shiftEmpIdInput.value);
                        const shiftTypeValue = shiftType.value;
                        const customShiftText = customShiftInput.value.trim();
                        const shiftDateKey = shiftDateInput.value;
                        const originalDateKey = originalShiftDateInput.value;
                        const notes = shiftNotesInput.value.trim();

                        const employee = employees.find(e => e.id === empId);
                        if (!employee || !shiftDateKey) {
                            showDialog("Error saving shift: Invalid employee or date.", "error"); return;
                        }
                        if (shiftTypeValue === 'custom' && !customShiftText) {
                             showDialog("Please enter the custom shift times or description.", "warning"); return;
                        }

                        let shiftText = ''; let shiftClass = '';
                        // Switch case remains the same...
                         switch (shiftTypeValue) {
                            case '9-5': shiftText = '9AM-5PM'; shiftClass = 'shift-morning'; break;
                            case '10-6': shiftText = '10AM-6PM'; shiftClass = 'shift-morning'; break;
                            case '11-7': shiftText = '11AM-7PM'; shiftClass = 'shift-afternoon'; break;
                            case '12-8': shiftText = '12PM-8PM'; shiftClass = 'shift-afternoon'; break;
                            case 'night': shiftText = '5PM-1AM'; shiftClass = 'shift-night'; break;
                            case 'day-off': shiftText = 'OFF'; shiftClass = 'day-off'; break;
                            case 'sick-leave': shiftText = 'SICK'; shiftClass = 'sick-leave'; break;
                            case 'vacation': shiftText = 'VAC'; shiftClass = 'vacation'; break;
                            case 'custom': shiftText = customShiftText; shiftClass = 'shift-custom'; break;
                            default: console.error("Invalid shift type:", shiftTypeValue); showDialog("Invalid shift type.", "error"); return;
                        }

                        const empKey = `emp-${empId}`;
                        if (!savedSchedule[empKey]) savedSchedule[empKey] = {};

                        if (shiftDateKey !== originalDateKey && savedSchedule[empKey]?.[originalDateKey]) {
                            console.log(`Date changed. Removing shift from original date: ${originalDateKey}`);
                            delete savedSchedule[empKey][originalDateKey];
                            clearShiftDisplay(empId, originalDateKey); // Update UI for original cell
                        }

                        savedSchedule[empKey][shiftDateKey] = { type: shiftTypeValue, text: shiftText, class: shiftClass, notes: notes };
                        console.log(`Shift saved for ${empKey} on ${shiftDateKey}:`, savedSchedule[empKey][shiftDateKey]);

                        updateShiftDisplay(empId, shiftDateKey, shiftText, shiftClass);
                        hideModal(shiftModal);

                         if (saveScheduleBtn) { // Indicate unsaved changes
                             saveScheduleBtn.classList.remove('btn-primary');
                             saveScheduleBtn.classList.add('btn-warning');
                             saveScheduleBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Publish Changes';
                         }

                        const displayDate = getDateFromKey(shiftDateKey).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        showDialog(`Shift updated for ${employee.name} on ${displayDate}. Click 'Publish Changes' to save.`, "success");
                    }

                     async function handleDeleteShift() {
                        if (!shiftEmpIdInput || !shiftDateInput) {
                             console.error("Shift form elements missing for delete!"); return;
                         }

                         const empId = parseInt(shiftEmpIdInput.value);
                         const shiftDateKey = shiftDateInput.value;
                         const employee = employees.find(e => e.id === empId);

                         if (!employee || !shiftDateKey) {
                             showDialog("Cannot delete shift: Invalid data.", "error"); return;
                         }

                         const displayDate = getDateFromKey(shiftDateKey).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                         try {
                            await showDialog(`Are you sure you want to delete the shift for ${employee.name} on ${displayDate}?`, 'confirm', true);

                            const empKey = `emp-${empId}`;
                            if (savedSchedule[empKey]?.[shiftDateKey]) {
                                delete savedSchedule[empKey][shiftDateKey];
                                if (Object.keys(savedSchedule[empKey]).length === 0) {
                                    delete savedSchedule[empKey];
                                }
                                console.log(`Shift deleted for ${empKey} on ${shiftDateKey}`);

                                clearShiftDisplay(empId, shiftDateKey);
                                const dateObj = getDateFromKey(shiftDateKey);
                                const dayIndex = dateObj.getDay();
                                if (dayIndex === 5 || dayIndex === 6) { // Apply default OFF for Fri/Sat
                                    updateShiftDisplay(emp.id, dateKey, 'OFF', 'day-off');
                                }


                                if (saveScheduleBtn) { // Indicate unsaved changes
                                     saveScheduleBtn.classList.remove('btn-primary');
                                     saveScheduleBtn.classList.add('btn-warning');
                                     saveScheduleBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Publish Changes';
                                 }
                                showDialog(`Shift for ${employee.name} on ${displayDate} deleted. Remember to 'Publish Changes'.`, "success");
                            } else {
                                 showDialog(`No specific shift was assigned to ${employee.name} on ${displayDate} to delete.`, "info");
                            }
                              hideModal(shiftModal);

                         } catch (wasCancelled) {
                             console.log("Shift deletion cancelled.");
                         }
                     }

                     function clearShiftDisplay(empId, dateKey) {
                         updateShiftDisplay(empId, dateKey, null, null);
                     }

                    function updateShiftDisplay(empId, dateKey, text, className) {
                         try { // Add try-catch here as it involves DOM manipulation
                             const dateObj = getDateFromKey(dateKey);
                             const timeDiff = dateObj.getTime() - currentWeekStart.getTime();
                             const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                             if (dayDiff >= 0 && dayDiff < DAYS_IN_WEEK) {
                                 const dayIndex = dayDiff;
                                 // Make selector more specific
                                 const shiftCell = scheduleBody?.querySelector(`tr[data-employee-row-id="${empId}"] > td[data-day-index="${dayIndex}"]`);

                                 if (!shiftCell) {
                                     // console.warn(`Cell not found for update: empId ${empId}, dayIndex ${dayIndex} (Date: ${dateKey})`);
                                     return; // Don't throw error, just exit if cell isn't visible/found
                                 }

                                 const editLink = shiftCell.querySelector('.edit-shift-link');

                                 // Clear previous shifts safely
                                 shiftCell.querySelectorAll('.shift').forEach(el => el.remove());

                                 if (text && className) {
                                     const shiftDiv = document.createElement('div');
                                     shiftDiv.className = `shift ${className}`;
                                     shiftDiv.textContent = text;
                                     // Insert before edit link if it exists, otherwise append
                                     if (editLink) {
                                          shiftCell.insertBefore(shiftDiv, editLink);
                                          editLink.textContent = '(edit)';
                                     } else {
                                         shiftCell.appendChild(shiftDiv); // Fallback if link is missing
                                     }
                                 } else {
                                     if(editLink) editLink.textContent = '(add)';
                                 }
                             }
                         } catch (e) {
                              console.error(`Error in updateShiftDisplay for empId ${empId}, dateKey ${dateKey}:`, e);
                              // Optionally show a generic error message to the user
                         }
                    }

                    function loadShiftsForCurrentWeek() {
                         console.log("Loading shifts for week starting:", currentWeekStart.toDateString());
                          if (!employees || !scheduleBody) {
                             console.error("Cannot load shifts: Employees array or schedule body is missing.");
                             return;
                         }

                         employees.forEach(emp => {
                             // Add check for valid employee ID
                             if (emp === null || typeof emp !== 'object' || emp.id === undefined) {
                                 console.warn("Skipping shift loading for invalid employee data:", emp);
                                 return; // Skip this employee
                             }

                             const empKey = `emp-${emp.id}`;
                             const empSchedule = savedSchedule[empKey] || {};

                             for (let i = 0; i < DAYS_IN_WEEK; i++) {
                                 const currentDate = new Date(currentWeekStart);
                                 currentDate.setDate(currentDate.getDate() + i);
                                 const dateKey = formatDateKey(currentDate);
                                 const dayIndex = i;

                                 const savedShift = empSchedule[dateKey];

                                 if (savedShift && typeof savedShift === 'object') { // Check if savedShift is valid object
                                     updateShiftDisplay(emp.id, dateKey, savedShift.text, savedShift.class);
                                 } else {
                                     if (savedShift) { // Log if data exists but is invalid
                                         console.warn(`Invalid saved shift data for emp-${emp.id} on ${dateKey}:`, savedShift);
                                     }
                                     // Apply defaults
                                     if (dayIndex === 5 || dayIndex === 6) {
                                         updateShiftDisplay(emp.id, dateKey, 'OFF', 'day-off');
                                     } else {
                                         updateShiftDisplay(emp.id, dateKey, '', ''); // Clear other days
                                     }
                                 }
                             }
                         });
                          console.log("Shift loading complete.");
                    }

                    function handlePublishSchedule() {
                        console.log("Publishing schedule changes...");
                        try {
                             localStorage.setItem('employeeSchedule', JSON.stringify(savedSchedule));
                             localStorage.setItem('employees', JSON.stringify(employees));

                             if (saveScheduleBtn) {
                                 saveScheduleBtn.classList.remove('btn-warning');
                                 saveScheduleBtn.classList.add('btn-primary');
                                 saveScheduleBtn.innerHTML = '<i class="fas fa-save"></i> Publish Changes';
                             }
                            showDialog("Schedule changes published successfully.", "success");
                        } catch (storageError) {
                             console.error("Error publishing schedule to localStorage:", storageError);
                             showDialog("Could not publish schedule. Storage might be full or data invalid.", "error");
                        }
                    }

                    function handleSendReminders() {
                         // Same logic as before...
                         const subject = encodeURIComponent(`Work Schedule: ${weekDisplay?.textContent || 'This Week'}`);
                         let emailsOpened = 0;
                         let mailtoLinks = [];

                         employees.forEach(employee => {
                             if (employee && employee.email && employee.name) { // Check employee data
                                 const body = encodeURIComponent(`Hi ${employee.name.split(' ')[0]},\n\nThis is your schedule reminder for the week: ${weekDisplay?.textContent || 'This Week'}.\n\nPlease check the online platform for full details.\n\nThanks`);
                                 const mailtoLink = `mailto:${employee.email}?subject=${subject}&body=${body}`;
                                 mailtoLinks.push({name: employee.name, email: employee.email, link: mailtoLink}); // Include email for display
                                 emailsOpened++;
                             }
                         });

                         if (emailsOpened > 0) {
                              let linkHtml = mailtoLinks.map(item => `<p style="margin-bottom: 5px;"><a href="${item.link}" target="_blank" style="color: var(--primary);">Send to ${item.name} (${item.email})</a></p>`).join('');
                              // Use a more structured approach for the message content if needed
                             showDialog(`<div>Generated ${emailsOpened} reminder email link(s). Click to open in your email client:</div><div style="margin-top: 10px; text-align: left;">${linkHtml}</div>`, "info");
                         } else {
                             showDialog("No employees with valid names and email addresses found to send reminders.", "warning");
                         }
                    }

                // --- End of Functions ---

                } catch (error) {
                     // --- Catch errors during initialization ---
                     console.error("!!! CRITICAL ERROR DURING PAGE INITIALIZATION !!!", error);
                     // Display a user-friendly error message on the page itself
                     document.body.innerHTML = `
                         <div style="padding: 30px; text-align: center; color: var(--danger); background-color: var(--light); height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                             <h1 style="color: var(--primary-dark); margin-bottom: 15px;">Oops! Something went wrong.</h1>
                             <p style="margin-bottom: 20px;">We encountered an error while loading the schedule page.</p>
                             <p style="font-size: 0.9em; color: var(--gray);">Please try refreshing the page. If the problem persists, contact support.</p>
                             <pre style="margin-top: 20px; font-size: 0.7em; color: var(--dark); background-color: var(--light-gray); padding: 10px; border-radius: 5px; max-width: 80%; overflow: auto; text-align: left;">Error details (for support):\n${error.name}: ${error.message}\n${error.stack ? error.stack.split('\n').slice(0, 5).join('\n') : ''}</pre>
                             <button class="btn btn-primary" style="margin-top:20px;" onclick="window.location.reload();">Refresh Page</button>
                         </div>`;
                     document.body.style.opacity = 1; // Make sure error message is visible
                 }

            }); // End DOMContentLoaded
        } // End else block for isLoggedIn check
    </script>
</body>
</html>

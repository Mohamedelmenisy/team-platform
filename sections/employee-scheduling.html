<!-- Note: Removed DOCTYPE, html, head, body tags -->
<!-- Note: Removed <header> section as it's provided by dash.html -->

<!-- Styles specific to Employee Scheduling -->
<style>
    /* Styles specific to this section (employee schedule) */
    .employee-schedule-body { /* Use a more specific class or ID for the container if needed */
    }
    .employee-schedule-body .main-container { max-width: 100%; margin: 0; padding: 0; }
    .employee-schedule-body .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .employee-schedule-body .page-title { font-size: 1.5rem; color: var(--primary-dark); font-weight: 600; }
    .employee-schedule-body .page-header > div { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .employee-schedule-body .schedule-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; background-color: var(--white); padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); flex-wrap: wrap; gap: 1rem; }
    .employee-schedule-body .week-navigation { display: flex; align-items: center; gap: 0.75rem; }
    .employee-schedule-body .week-display { font-weight: 600; min-width: 180px; text-align: center; color: var(--dark); }
    .employee-schedule-body .schedule-container { background-color: var(--white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); overflow-x: auto; border: 1px solid var(--light-gray); }
    .employee-schedule-body .schedule-table { width: 100%; min-width: 700px; border-collapse: collapse; }
    .employee-schedule-body .schedule-table thead th { padding: 0.8rem 0.5rem; text-align: center; background-color: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary-dark); border-left: 1px solid var(--primary-light); }
    .employee-schedule-body .schedule-table thead th:first-child { border-left: none; min-width: 150px; text-align: left; padding-left: 1rem; position: sticky; left: 0; z-index: 11; border-right: 1px solid var(--primary-dark); }
    .employee-schedule-body .schedule-table tbody td { padding: 0.75rem 0.5rem; text-align: center; background-color: var(--white); border-bottom: 1px solid var(--light-gray); border-left: 1px solid var(--light-gray); color: var(--dark); vertical-align: middle; height: 60px; }
    .employee-schedule-body .schedule-table tbody tr:last-child td { border-bottom: none; }
     .employee-schedule-body .schedule-table tbody td:first-child { position: sticky; left: 0; background-color: var(--white); border-right: 1px solid var(--dark-gray, #6b7280); z-index: 5; font-weight: 500; text-align: left; padding-left: 1rem; white-space: nowrap; border-left: none; }
    .employee-schedule-body .employee-name {} /* Handled by td:first-child */
    .employee-schedule-body .employee-1 { color: #3b82f6; }
    .employee-schedule-body .employee-2 { color: #10b981; }
    .employee-schedule-body .employee-3 { color: #8b5cf6; }
    .employee-schedule-body .employee-4 { color: #ec4899; }
    .employee-schedule-body .employee-5 { color: #f59e0b; }
    .employee-schedule-body .employee-6 { color: #14b8a6; }
    .employee-schedule-body .shift { padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; display: inline-block; margin-bottom: 0.25rem; }
    .employee-schedule-body .shift-morning { background-color: #dbeafe; color: #1e40af; }
    .employee-schedule-body .shift-afternoon { background-color: #e0f2fe; color: #0c4a6e; }
    .employee-schedule-body .shift-night { background-color: #ede9fe; color: #5b21b6; }
    .employee-schedule-body .day-off { background-color: #f0fdf4; color: #166534; }
    .employee-schedule-body .sick-leave { background-color: #fee2e2; color: #991b1b; }
    .employee-schedule-body .vacation { background-color: #ffedd5; color: #9a3412; }
    .employee-schedule-body .day-header { display: flex; flex-direction: column; gap: 0.15rem; align-items: center; }
    .employee-schedule-body .day-name { font-weight: 600; font-size: 0.85rem; }
    .employee-schedule-body .day-date { font-size: 0.75rem; opacity: 0.8; }
    .employee-schedule-body .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; padding: 1rem; }
    .employee-schedule-body .modal-content { background-color: var(--white); width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); padding: 1.5rem; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
    .employee-schedule-body .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-gray); flex-shrink: 0; }
    .employee-schedule-body .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--dark); }
    .employee-schedule-body .close-modal { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--gray); line-height: 1; padding: 0; }
    .employee-schedule-body .close-modal:hover { color: var(--dark); }
    .employee-schedule-body .modal-body { flex-grow: 1; overflow-y: auto; }
    .employee-schedule-body .form-group { margin-bottom: 1rem; }
    .employee-schedule-body .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark); font-size: 0.9rem; }
    .employee-schedule-body .form-control { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--light-gray); border-radius: 6px; font-size: 0.95rem; background-color: var(--white); color: var(--dark); box-sizing: border-box; }
    .employee-schedule-body .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 59, 130, 246), 0.2); }
    .employee-schedule-body .form-control[readonly] { background-color: var(--light-gray); cursor: not-allowed; }
    .employee-schedule-body textarea.form-control { min-height: 80px; }
    .employee-schedule-body .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--light-gray); flex-shrink: 0; }
    .employee-schedule-body .admin-controls {}
    .employee-schedule-body .edit-shift { cursor: pointer; color: var(--primary); font-size: 0.75rem; display: block; text-align: center; margin-top: 0.25rem; opacity: 0; transition: opacity 0.2s; height: 0; overflow: hidden; }
     .employee-schedule-body td.admin-controls:hover .edit-shift.admin-visible { opacity: 0.7; height: auto; }
    .employee-schedule-body .edit-shift.admin-visible:hover { opacity: 1; text-decoration: underline; }
    @media (max-width: 768px) {
        .employee-schedule-body .schedule-controls { flex-direction: column; gap: 1rem; align-items: stretch; }
        .employee-schedule-body .week-navigation { justify-content: space-between; width: 100%; }
        .employee-schedule-body .schedule-controls > .btn-primary { width: 100%; justify-content: center; }
        .employee-schedule-body .page-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; margin-bottom: 1.5rem; }
        .employee-schedule-body .page-header > div { width: 100%; display: flex; gap: 0.5rem; }
        .employee-schedule-body .page-header > div > .btn { flex-grow: 1; justify-content: center; }
        .employee-schedule-body .schedule-table thead { display: none; }
        .employee-schedule-body .schedule-table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid var(--light-gray); border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .employee-schedule-body .schedule-table tbody td { display: block; width: 100%; text-align: right; padding-left: 50%; position: relative; border-bottom: 1px dashed var(--light-gray); border-left: none; height: auto; min-height: 45px; box-sizing: border-box; padding-top: 0.6rem; padding-bottom: 0.6rem; }
        .employee-schedule-body .schedule-table tbody tr td:last-child { border-bottom: none; }
        .employee-schedule-body .schedule-table tbody td::before { content: attr(data-label); position: absolute; left: 10px; width: calc(50% - 20px); padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--gray); font-size: 0.8rem; top: 50%; transform: translateY(-50%); }
         .employee-schedule-body .schedule-table tbody td:first-child { position: static; display: block; width: 100%; background-color: var(--light); font-weight: 600; text-align: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--dark-gray, #6b7280); border-right: none; z-index: auto; white-space: normal; }
         .employee-schedule-body .schedule-table tbody td:first-child::before { content: none; }
         .employee-schedule-body .edit-shift.admin-visible { opacity: 1; height: auto; text-align: right; padding-right: 10px; margin-top: 0.1rem; }
    }
    @media (max-width: 480px) {
         .employee-schedule-body .page-title { font-size: 1.3rem; }
         .employee-schedule-body .shift { font-size: 0.75rem; padding: 0.2rem 0.4rem; }
          .employee-schedule-body .edit-shift { font-size: 0.7rem; }
          .employee-schedule-body .modal-content { padding: 1rem; }
           .employee-schedule-body .form-actions { flex-direction: column; gap: 0.5rem; }
            .employee-schedule-body .form-actions .btn { width: 100%; justify-content: center; }
         .employee-schedule-body .schedule-table tbody td::before { font-size: 0.75rem; }
    }
</style>

<!-- This container will be inserted into dash.html's #featureSections -->
<div class="employee-schedule-body">
    <!-- Main Content -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">Employee Schedule</h1>
            <div>
                <button class="btn btn-primary" id="schedule-addEmployeeBtn" style="display: none;">
                    <i class="fas fa-plus"></i> Add Employee
                </button>
                <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="display: none; background-color: var(--secondary);">
                    <i class="fas fa-envelope"></i> Send Reminders
                </button>
            </div>
        </div>

        <!-- Schedule Controls -->
        <div class="schedule-controls">
            <div class="week-navigation">
                <button class="btn btn-outline" id="schedule-prevWeekBtn" title="Previous Week">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="week-display" id="schedule-weekDisplay">Loading...</div>
                <button class="btn btn-outline" id="schedule-nextWeekBtn" title="Next Week">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="btn btn-primary" id="schedule-saveScheduleBtn" style="display: none;">
                <i class="fas fa-save"></i> Save Schedule
            </button>
        </div>

        <!-- Schedule Table -->
        <div class="schedule-container">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                        <th>Sun</th>
                    </tr>
                </thead>
                <tbody id="schedule-table-body">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal" id="schedule-employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Employee</h2>
                <button class="close-modal" id="schedule-closeEmployeeModal" title="Close">×</button>
            </div>
            <div class="modal-body">
                <form id="schedule-employeeForm">
                    <div class="form-group">
                        <label for="schedule-empName">Full Name</label>
                        <input type="text" id="schedule-empName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="schedule-empEmail">Email</label>
                        <input type="email" id="schedule-empEmail" class="form-control" required>
                    </div>
                     <button type="submit" style="display: none;" aria-hidden="true"></button>
                </form>
            </div>
             <div class="form-actions">
                 <button type="button" class="btn btn-outline" id="schedule-cancelEmployeeBtn">Cancel</button>
                 <button type="submit" class="btn btn-primary" form="schedule-employeeForm">Add Employee</button>
             </div>
        </div>
    </div>

    <!-- Edit Shift Modal -->
    <div class="modal" id="schedule-shiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Shift</h2>
                <button class="close-modal" id="schedule-closeShiftModal" title="Close">×</button>
            </div>
            <div class="modal-body">
                <form id="schedule-shiftForm">
                    <input type="hidden" id="schedule-shiftEmpId">
                    <input type="hidden" id="schedule-shiftDateKey">
                    <div class="form-group">
                        <label for="schedule-shiftEmployee">Employee</label>
                        <input type="text" id="schedule-shiftEmployee" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftDate">Date</label>
                        <input type="text" id="schedule-shiftDateDisplay" class="form-control" readonly>
                        <input type="date" id="schedule-shiftDate" class="form-control" required style="display:none;">
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftType">Shift Type</label>
                        <select id="schedule-shiftType" class="form-control" required>
                            <option value="day-off">Day Off</option>
                            <option value="morning">Morning (9AM-5PM)</option>
                            <option value="afternoon">Afternoon (12PM-8PM)</option>
                            <option value="night">Night (5PM-1AM)</option>
                            <option value="sick-leave">Sick Leave</option>
                            <option value="vacation">Vacation</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group" id="schedule-customShiftGroup" style="display: none;">
                        <label for="schedule-customShift">Custom Shift Times</label>
                        <input type="text" id="schedule-customShift" class="form-control" placeholder="e.g., 10AM-6PM">
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftNotes">Notes (Optional)</label>
                        <textarea id="schedule-shiftNotes" class="form-control" rows="3"></textarea>
                    </div>
                     <button type="submit" style="display: none;" aria-hidden="true"></button>
                </form>
            </div>
             <div class="form-actions">
                 <button type="button" class="btn btn-danger" id="schedule-deleteShiftBtn">Delete Shift</button>
                 <button type="button" class="btn btn-outline" id="schedule-cancelShiftBtn">Cancel</button>
                 <button type="submit" class="btn btn-primary" form="schedule-shiftForm">Save Changes</button>
             </div>
        </div>
    </div>

</div> <!-- End of .employee-schedule-body -->

<script>
    // This function definition needs to be globally accessible when the script runs.
    function initializeEmployeeSchedule(dashboardCurrentUser, dashboardTeamMembers) {
        console.log("--- initializeEmployeeSchedule from HTML's script tag ---");

        // Ensure dashboardApp and necessary functions/data are available
        if (typeof window.dashboardApp === 'undefined' ||
             typeof window.dashboardApp.showConfirmModal !== 'function' ||
             typeof window.dashboardApp.showSuccessMessage !== 'function' ||
             typeof window.dashboardApp.showErrorMessage !== 'function' ||
             typeof window.dashboardApp.addActivity !== 'function' ||
             !dashboardCurrentUser || !dashboardTeamMembers ) { // Also check passed data

            console.error("FATAL: dashboardApp or required functions/data not found or invalid.");
            const container = document.querySelector('.employee-schedule-body');
            if(container) container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--danger);">Error: Dashboard connection or data lost. Cannot initialize schedule.</div>';
            return; // Stop execution if dependencies are missing
        }
        console.log("Dashboard connection and data seem OK.");

        // Use functions from dashboardApp safely
        const showConfirmModal = window.dashboardApp.showConfirmModal;
        const hideConfirmModal = window.dashboardApp.hideConfirmModal || function(){};
        const showSuccessMessage = window.dashboardApp.showSuccessMessage;
        const showErrorMessage = window.dashboardApp.showErrorMessage;
        const addActivity = window.dashboardApp.addActivity;

        const scheduleContainer = document.querySelector('.employee-schedule-body');
        if (!scheduleContainer) {
            console.error("Employee Schedule container not found inside JS!");
            return; // Stop if container isn't there when JS runs
        }
         console.log("Schedule container found.");

        // --- DOM Elements ---
        console.log("Querying DOM elements...");
        const employeeModal = scheduleContainer.querySelector('#schedule-employeeModal');
        const shiftModal = scheduleContainer.querySelector('#schedule-shiftModal');
        const addEmployeeBtn = scheduleContainer.querySelector('#schedule-addEmployeeBtn');
        const sendRemindersBtn = scheduleContainer.querySelector('#schedule-sendRemindersBtn');
        const saveScheduleBtn = scheduleContainer.querySelector('#schedule-saveScheduleBtn');
        const closeEmployeeModal = scheduleContainer.querySelector('#schedule-closeEmployeeModal');
        const closeShiftModal = scheduleContainer.querySelector('#schedule-closeShiftModal');
        const cancelEmployeeBtn = scheduleContainer.querySelector('#schedule-cancelEmployeeBtn');
        const cancelShiftBtn = scheduleContainer.querySelector('#schedule-cancelShiftBtn');
        const employeeForm = scheduleContainer.querySelector('#schedule-employeeForm');
        const shiftForm = scheduleContainer.querySelector('#schedule-shiftForm');
        const shiftTypeSelect = scheduleContainer.querySelector('#schedule-shiftType');
        const customShiftGroup = scheduleContainer.querySelector('#schedule-customShiftGroup');
        const customShiftInput = scheduleContainer.querySelector('#schedule-customShift');
        const deleteShiftBtn = scheduleContainer.querySelector('#schedule-deleteShiftBtn');
        const prevWeekBtn = scheduleContainer.querySelector('#schedule-prevWeekBtn');
        const nextWeekBtn = scheduleContainer.querySelector('#schedule-nextWeekBtn');
        const weekDisplay = scheduleContainer.querySelector('#schedule-weekDisplay');
        const scheduleTableBody = scheduleContainer.querySelector('#schedule-table-body');
        const shiftEmployeeInput = scheduleContainer.querySelector('#schedule-shiftEmployee');
        const shiftDateInput = scheduleContainer.querySelector('#schedule-shiftDate');
        const shiftDateDisplayInput = scheduleContainer.querySelector('#schedule-shiftDateDisplay');
        const shiftNotesInput = scheduleContainer.querySelector('#schedule-shiftNotes');
        const shiftEmpIdInput = scheduleContainer.querySelector('#schedule-shiftEmpId');
        const shiftDateKeyInput = scheduleContainer.querySelector('#schedule-shiftDateKey');
         // Check if essential elements were found
         if (!weekDisplay || !scheduleTableBody || !prevWeekBtn || !nextWeekBtn) {
             console.error("FATAL: Essential schedule elements (week display, table body, nav buttons) not found!");
             showErrorMessage("Error initializing schedule UI components.");
             return;
         }
        console.log("DOM elements queried.");

        // --- State Variables ---
        console.log("Setting up state variables...");
        let scheduleCurrentUser = dashboardCurrentUser;
        let scheduleEmployees = Array.isArray(dashboardTeamMembers) ? dashboardTeamMembers : [];
        let scheduleCurrentWeekStart = new Date(); // Will be adjusted
        let scheduleSavedData = {};
        let isAdminOrSupervisor = false;

        const scheduleMinDate = new Date(2025, 4, 1); // May 1, 2025
        const scheduleMaxDate = new Date(2025, 4, 31); // May 31, 2025
        const localStorageKey = 'employeeSchedule_May2025';
        console.log("State variables set.");

        // --- Helper Functions ---
        function formatDateKey(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) return null;
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getLocalDateFromKey(dateKey) {
            if (!dateKey || typeof dateKey !== 'string' || !dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) return null;
            const parts = dateKey.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        // --- UI Update Functions ---
        function updateWeekDisplayUI() {
            console.log("Updating week display UI...");
            const weekEnd = new Date(scheduleCurrentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            const startStr = scheduleCurrentWeekStart.toLocaleDateString('en-US', options);
            const endStr = weekEnd.toLocaleDateString('en-US', options);
            const year = scheduleCurrentWeekStart.getFullYear();
            weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const headerRow = scheduleContainer.querySelector('.schedule-table thead tr');
            if (!headerRow) { console.error("Schedule header row not found!"); return; }
            headerRow.innerHTML = '<th>Employee</th>'; // Clear existing day headers
            const tempDate = new Date(scheduleCurrentWeekStart);
            days.forEach(dayName => {
                const th = document.createElement('th');
                const dateStr = tempDate.toLocaleDateString('en-US', { day: 'numeric' });
                const monthStr = tempDate.toLocaleDateString('en-US', { month: 'short' });
                th.innerHTML = `<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${monthStr} ${dateStr}</span></div>`;
                headerRow.appendChild(th);
                tempDate.setDate(tempDate.getDate() + 1);
            });

            const prevWeekTest = new Date(scheduleCurrentWeekStart); prevWeekTest.setDate(prevWeekTest.getDate() - 1);
            prevWeekBtn.disabled = prevWeekTest < scheduleMinDate;
            const nextWeekTest = new Date(scheduleCurrentWeekStart); nextWeekTest.setDate(nextWeekTest.getDate() + 7);
            nextWeekBtn.disabled = nextWeekTest > scheduleMaxDate;
            console.log("Week display UI updated.");
        }

        function renderScheduleTable() {
            console.log("Rendering schedule table...");
            scheduleTableBody.innerHTML = '';

            if (!Array.isArray(scheduleEmployees) || scheduleEmployees.length === 0) {
                scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">No employees found. Add them via Team Management or the button above.</td></tr>`;
                console.log("No employees to render.");
                return;
            }
            console.log(`Rendering table for ${scheduleEmployees.length} employees.`);

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            scheduleEmployees.forEach((employee, index) => {
                if (!employee || typeof employee !== 'object' || !employee.id || !employee.name) { console.warn("Skipping rendering invalid employee:", employee); return; }
                const tr = document.createElement('tr');
                tr.dataset.empId = employee.id;
                const nameTd = document.createElement('td');
                nameTd.className = `employee-name employee-${(index % 6) + 1}`;
                nameTd.textContent = employee.name;
                tr.appendChild(nameTd);
                const tempDate = new Date(scheduleCurrentWeekStart);
                days.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.classList.add('admin-controls');
                    const dateKey = formatDateKey(tempDate);
                    if (!dateKey) { td.innerHTML = '<span style="color:red;">Err</span>'; tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1); return; }
                    const mobileLabel = `${days[dayIndex]} (${tempDate.toLocaleDateString('en-us', {month:'short', day:'numeric'})})`;
                    td.dataset.label = mobileLabel; td.dataset.dateKey = dateKey;
                    const empKey = `emp-${employee.id}`;
                    const shiftData = scheduleSavedData[empKey]?.[dateKey];
                    if (shiftData && shiftData.text && shiftData.class) {
                        const shiftDiv = document.createElement('div');
                        shiftDiv.className = `shift ${shiftData.class}`; shiftDiv.textContent = shiftData.text;
                        shiftDiv.title = shiftData.notes || `Shift: ${shiftData.text}`; td.appendChild(shiftDiv);
                    }
                    if (isAdminOrSupervisor) {
                        const editSpan = document.createElement('span');
                        editSpan.className = 'edit-shift admin-visible'; editSpan.dataset.empId = employee.id;
                        editSpan.dataset.dayIndex = dayIndex; editSpan.dataset.dateKey = dateKey;
                        editSpan.textContent = shiftData ? '(edit)' : '(add)'; editSpan.setAttribute('role', 'button');
                        editSpan.setAttribute('tabindex', '0'); editSpan.onclick = handleEditShiftClick;
                        editSpan.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') handleEditShiftClick(e); };
                        td.appendChild(editSpan);
                    }
                    tr.appendChild(td); tempDate.setDate(tempDate.getDate() + 1);
                });
                scheduleTableBody.appendChild(tr);
            });
            console.log("Schedule table rendered.");
        }

        function updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes = '') {
            const cellSelector = `tr[data-emp-id="${empId}"] td[data-date-key="${dateKey}"]`;
            const shiftCell = scheduleTableBody?.querySelector(cellSelector);
            if (!shiftCell) { console.warn(`Shift cell not found in UI for emp ${empId}, date ${dateKey}.`); return; }
            let editSpan = shiftCell.querySelector('.edit-shift');
            const shiftDataExists = shiftText && shiftClass;
            const existingShift = shiftCell.querySelector('.shift');
            if (existingShift) existingShift.remove();
            if (shiftDataExists) {
                const shiftDiv = document.createElement('div');
                shiftDiv.className = `shift ${shiftClass}`; shiftDiv.textContent = shiftText;
                shiftDiv.title = notes || `Shift: ${shiftText}`;
                if (editSpan) shiftCell.insertBefore(shiftDiv, editSpan); else shiftCell.appendChild(shiftDiv);
            }
            if (editSpan) editSpan.textContent = shiftDataExists ? '(edit)' : '(add)';
        }

        function loadShiftsForCurrentWeekUI() {
            console.log("Loading shifts for current week UI...");
            renderScheduleTable();
        }

        // --- Event Handlers ---
        function handleWeekChange(direction) {
             const newWeekStart = new Date(scheduleCurrentWeekStart);
             newWeekStart.setDate(newWeekStart.getDate() + (direction * 7));
             if (newWeekStart < scheduleMinDate || newWeekStart > scheduleMaxDate) return;
             scheduleCurrentWeekStart = newWeekStart; updateWeekDisplayUI(); loadShiftsForCurrentWeekUI();
        }
        function handleAddEmployeeClick() {
            if (!employeeModal || !employeeForm) return; employeeForm.reset();
            employeeModal.style.display = 'flex'; scheduleContainer.querySelector('#schedule-empName')?.focus();
        }
        function handleSendRemindersClick() {
              const weekText = weekDisplay?.textContent || "Current Week";
              const subject = encodeURIComponent(`Upcoming Work Schedule Reminder: ${weekText}`);
              let body = `Hi Team,\n\nThis is a reminder of your work schedule for the week of ${weekText}.\n\n`;
              // ...(rest of the body generation)...
              let emails = scheduleEmployees.map(e => e.email).filter(Boolean).join(',');
              if (!emails) { showErrorMessage("No employee emails found."); return; }
              const mailtoLink = `mailto:${emails}?subject=${subject}&body=${encodeURIComponent(body)}`;
              tryOpenMailto(mailtoLink); // Simplified - removed length check for brevity
        }
        function tryOpenMailto(mailtoLink) {
             try { window.open(mailtoLink, '_blank'); showSuccessMessage("Attempting to open email client..."); }
             catch (e) { console.error("Mailto error:", e); showErrorMessage("Could not open email client."); }
        }
        function handleSaveScheduleClick() {
            localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData));
            showSuccessMessage("Schedule changes saved."); addActivity('fa-calendar-check', `Schedule saved for week: ${weekDisplay?.textContent}`);
        }
        function handleEmployeeFormSubmit(e) {
             e.preventDefault(); if (!employeeModal || !employeeForm) return;
             const nameInput = scheduleContainer?.querySelector('#schedule-empName');
             const emailInput = scheduleContainer?.querySelector('#schedule-empEmail');
             const name = nameInput?.value.trim(); const email = emailInput?.value.trim();
             if (!name || !email || !/^\S+@\S+\.\S+$/.test(email)) { showErrorMessage("Valid name and email required."); return; }
             const currentTeam = window.dashboardApp.getTeamMembers();
             if (currentTeam.some(emp => emp.email.toLowerCase() === email.toLowerCase())) { showErrorMessage(`Employee ${email} already exists.`); return; }
             const newEmployee = { id: Date.now(), name: name, email: email, role: 'member', initials: name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase(), avatar: '' };
             const updatedTeam = [...currentTeam, newEmployee]; window.dashboardApp.updateTeamMembers(updatedTeam);
             scheduleEmployees.push(newEmployee); loadShiftsForCurrentWeekUI();
             employeeModal.style.display = 'none'; addActivity('fa-user-plus', `Added employee: ${name}`); showSuccessMessage(`Employee ${name} added.`);
        }
        function handleEditShiftClick(event) {
            const target = event.currentTarget || event.target;
            const empId = parseInt(target?.dataset.empId); const dateKey = target?.dataset.dateKey;
            if (!empId || !dateKey || !shiftModal || !shiftForm) { showErrorMessage("Cannot edit shift: data missing."); return; }
            const employee = scheduleEmployees.find(e => e.id === empId); const shiftDate = getLocalDateFromKey(dateKey);
            if (!employee || !shiftDate) { showErrorMessage("Cannot edit shift: invalid employee or date."); return; }
            shiftForm.reset();
            if(shiftEmpIdInput) shiftEmpIdInput.value = empId; if(shiftDateKeyInput) shiftDateKeyInput.value = dateKey;
            shiftForm.dataset.empId = empId; shiftForm.dataset.dateKey = dateKey;
            if(shiftEmployeeInput) shiftEmployeeInput.value = employee.name;
            const dateFormatOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            if(shiftDateDisplayInput) shiftDateDisplayInput.value = shiftDate.toLocaleDateString(scheduleCurrentUser?.preferences?.language || 'en-US', dateFormatOptions);
            if(shiftDateInput) { shiftDateInput.value = dateKey; shiftDateInput.min = formatDateKey(scheduleMinDate); shiftDateInput.max = formatDateKey(scheduleMaxDate); }
            const empKey = `emp-${empId}`; const savedShift = scheduleSavedData[empKey]?.[dateKey];
            if (savedShift) {
                if(shiftTypeSelect) shiftTypeSelect.value = savedShift.type || 'day-off';
                if(customShiftInput) customShiftInput.value = savedShift.type === 'custom' ? savedShift.text : '';
                if(shiftNotesInput) shiftNotesInput.value = savedShift.notes || '';
            } else {
                 if(shiftTypeSelect) shiftTypeSelect.value = 'day-off'; if(customShiftInput) customShiftInput.value = ''; if(shiftNotesInput) shiftNotesInput.value = '';
            }
            if(shiftTypeSelect) shiftTypeSelect.dispatchEvent(new Event('change'));
            shiftModal.style.display = 'flex'; shiftTypeSelect?.focus();
        }
        function handleShiftFormSubmit(e) {
             e.preventDefault(); if (!shiftModal || !shiftForm) return;
             const empId = parseInt(shiftEmpIdInput?.value || shiftForm.dataset.empId);
             const dateKey = shiftDateKeyInput?.value || shiftForm.dataset.dateKey;
             const employee = scheduleEmployees.find(e => e.id === empId);
             if (!employee || !dateKey) { showErrorMessage("Error saving shift: Invalid data."); shiftModal.style.display = 'none'; return; }
             const shiftTypeValue = shiftTypeSelect?.value; const customShiftText = customShiftInput?.value.trim();
             const notes = shiftNotesInput?.value.trim(); let shiftText = '', shiftClass = '';
             switch(shiftTypeValue) {
                case 'morning': shiftText = '9AM-5PM'; shiftClass = 'shift-morning'; break; case 'afternoon': shiftText = '12PM-8PM'; shiftClass = 'shift-afternoon'; break; case 'night': shiftText = '5PM-1AM'; shiftClass = 'shift-night'; break;
                case 'day-off': shiftText = 'OFF'; shiftClass = 'day-off'; break; case 'sick-leave': shiftText = 'SICK'; shiftClass = 'sick-leave'; break; case 'vacation': shiftText = 'VAC'; shiftClass = 'vacation'; break;
                case 'custom': if (!customShiftText) { showErrorMessage('Enter custom shift times.'); customShiftInput?.focus(); return; } shiftText = customShiftText; shiftClass = 'shift-morning'; break;
                default: showErrorMessage("Invalid shift type."); shiftModal.style.display = 'none'; return;
             }
             const empKey = `emp-${empId}`; if (!scheduleSavedData[empKey]) scheduleSavedData[empKey] = {};
             scheduleSavedData[empKey][dateKey] = { type: shiftTypeValue, text: shiftText, class: shiftClass, notes: notes };
             localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData));
             updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes);
             shiftModal.style.display = 'none'; const displayDate = getLocalDateFromKey(dateKey);
             addActivity('fa-clock', `Updated shift for ${employee.name} on ${displayDate?.toLocaleDateString()}`); showSuccessMessage(`Shift updated for ${employee.name}.`);
        }
        function handleDeleteShiftClick() {
             if (!shiftModal || !shiftForm) return;
             const empId = parseInt(shiftEmpIdInput?.value || shiftForm.dataset.empId); const dateKey = shiftDateKeyInput?.value || shiftForm.dataset.dateKey;
             const employee = scheduleEmployees.find(e => e.id === empId); const displayDate = getLocalDateFromKey(dateKey);
             if (!employee || !displayDate || !dateKey) { showErrorMessage("Cannot delete shift: Invalid data."); shiftModal.style.display = 'none'; return; }
             const formattedDate = displayDate.toLocaleDateString();
             showConfirmModal({
                 title: 'Delete Shift?', message: `Delete shift for <strong>${employee.name}</strong> on ${formattedDate}?`, confirmText: 'Delete', confirmClass: 'btn-danger',
                 onConfirm: () => {
                     const empKey = `emp-${empId}`; let deleted = false; if (scheduleSavedData[empKey]?.[dateKey]) { delete scheduleSavedData[empKey][dateKey]; deleted = true; }
                     if (deleted) { localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData)); updateShiftDisplayUI(empId, dateKey, '', '', ''); addActivity('fa-calendar-minus', `Deleted shift for ${employee.name} on ${formattedDate}`); showSuccessMessage(`Shift deleted.`); }
                     else { showSuccessMessage(`No shift found to delete.`); } shiftModal.style.display = 'none';
                 }
             });
        }

        // --- Event Listener Setup ---
        function setupScheduleEventListeners() {
            console.log("Setting up schedule event listeners...");
            prevWeekBtn?.addEventListener('click', () => handleWeekChange(-1)); nextWeekBtn?.addEventListener('click', () => handleWeekChange(1));
            if (isAdminOrSupervisor) {
                addEmployeeBtn?.addEventListener('click', handleAddEmployeeClick); sendRemindersBtn?.addEventListener('click', handleSendRemindersClick); saveScheduleBtn?.addEventListener('click', handleSaveScheduleClick);
                if(addEmployeeBtn) addEmployeeBtn.style.display = 'inline-flex'; if(sendRemindersBtn) sendRemindersBtn.style.display = 'inline-flex'; if(saveScheduleBtn) saveScheduleBtn.style.display = 'inline-flex';
            } else {
                 if(addEmployeeBtn) addEmployeeBtn.style.display = 'none'; if(sendRemindersBtn) sendRemindersBtn.style.display = 'none'; if(saveScheduleBtn) saveScheduleBtn.style.display = 'none';
            }
            closeEmployeeModal?.addEventListener('click', () => employeeModal.style.display = 'none'); cancelEmployeeBtn?.addEventListener('click', () => employeeModal.style.display = 'none');
            employeeForm?.addEventListener('submit', handleEmployeeFormSubmit); employeeModal?.addEventListener('click', (event) => { if (event.target === employeeModal) employeeModal.style.display = 'none'; });
            closeShiftModal?.addEventListener('click', () => shiftModal.style.display = 'none'); cancelShiftBtn?.addEventListener('click', () => shiftModal.style.display = 'none');
            shiftForm?.addEventListener('submit', handleShiftFormSubmit); deleteShiftBtn?.addEventListener('click', handleDeleteShiftClick);
            shiftTypeSelect?.addEventListener('change', function() {
                 const isCustom = this.value === 'custom'; if(customShiftGroup) customShiftGroup.style.display = isCustom ? 'block' : 'none';
                 if(customShiftInput) { customShiftInput.required = isCustom; if(isCustom) customShiftInput.focus(); }
            });
            shiftModal?.addEventListener('click', (event) => { if (event.target === shiftModal) shiftModal.style.display = 'none'; });
            console.log("Schedule event listeners attached.");
        }


        // --- Main Initialization Logic for this Section ---
function initialize() {
    // **** START TRY BLOCK ****
    try {
        console.log("Running initialize() inside employee-scheduling script...");

        // 1. Determine Role
        console.log("Step 1: Determining role...");
        // Add null check for scheduleCurrentUser
        if (!scheduleCurrentUser || typeof scheduleCurrentUser.role === 'undefined') {
             throw new Error("Cannot determine user role - scheduleCurrentUser is invalid or missing role property.");
        }
        isAdminOrSupervisor = scheduleCurrentUser.role === 'admin' || scheduleCurrentUser.role === 'supervisor';
        console.log(`Role: ${scheduleCurrentUser.role}, IsAdmin: ${isAdminOrSupervisor}`);

        // 2. Validate Employees
        console.log("Step 2: Validating employee data...");
        if (!Array.isArray(scheduleEmployees)) {
             console.warn("Employee data is not an array, using empty.", scheduleEmployees);
             scheduleEmployees = [];
        } else {
             // Ensure basic structure for filtering
             scheduleEmployees = scheduleEmployees.filter(emp => emp && typeof emp === 'object' && emp.id && emp.name);
        }
        console.log(`Initializing with ${scheduleEmployees.length} valid employees.`);


        // 3. Load Saved Data
        console.log("Step 3: Loading data from localStorage...");
        const savedDataString = localStorage.getItem(localStorageKey);
        if (savedDataString) {
            try {
                scheduleSavedData = JSON.parse(savedDataString);
                if (typeof scheduleSavedData !== 'object' || scheduleSavedData === null) {
                    console.warn("Invalid data format in localStorage, resetting.");
                    scheduleSavedData = {};
                }
            } catch (e) {
                console.error("Parsing localStorage error:", e);
                scheduleSavedData = {};
                showErrorMessage("Could not load saved schedule. Starting fresh."); // Inform user
            }
        } else {
            scheduleSavedData = {};
        }
         console.log("Loaded schedule data:", scheduleSavedData);


        // 4. Set Initial Week
         console.log("Step 4: Setting initial week...");
         const today = new Date();
         // Add null check for preferences
         const weekStartPref = scheduleCurrentUser?.preferences?.weekStart;
         const weekStartDay = weekStartPref === 'sun' ? 0 : 1; // Default to Mon if preference missing
         const dayOfWeek = today.getDay();
         let diff = today.getDate() - dayOfWeek + (dayOfWeek === weekStartDay ? 0 : (dayOfWeek < weekStartDay ? weekStartDay - 7 : weekStartDay));
         let potentialWeekStart = new Date(today.getFullYear(), today.getMonth(), diff);
         // Clamping logic...
         if (potentialWeekStart < scheduleMinDate) { /* ...clamping logic as before ... */ scheduleCurrentWeekStart=new Date(scheduleMinDate.getFullYear(), scheduleMinDate.getMonth(), scheduleMinDate.getDate()); /* Simplified fallback */ }
          else if (potentialWeekStart > scheduleMaxDate) { /* ...clamping logic as before ... */ scheduleCurrentWeekStart = new Date(scheduleMaxDate.getFullYear(), scheduleMaxDate.getMonth(), scheduleMaxDate.getDate() - 6); /* Simplified fallback */}
          else { scheduleCurrentWeekStart = potentialWeekStart; }
         console.log("Initial week start calculated:", scheduleCurrentWeekStart.toDateString());

        // 5. Initial UI Setup
        console.log("Step 5: Performing initial UI setup...");
        if (typeof updateWeekDisplayUI !== 'function') throw new Error("updateWeekDisplayUI is not defined");
        updateWeekDisplayUI();

        if (typeof loadShiftsForCurrentWeekUI !== 'function') throw new Error("loadShiftsForCurrentWeekUI is not defined");
        loadShiftsForCurrentWeekUI(); // This calls renderScheduleTable

        if (typeof setupScheduleEventListeners !== 'function') throw new Error("setupScheduleEventListeners is not defined");
        setupScheduleEventListeners();

        console.log("Employee Schedule Section Initialized Successfully.");

    // **** END TRY BLOCK / START CATCH BLOCK ****
    } catch (error) {
         console.error("<<<<< CAUGHT ERROR during schedule initialization >>>>>", error); // Log the specific error
         // Display a user-friendly error message within the schedule section
         if(scheduleContainer) {
              scheduleContainer.innerHTML = `<div style='padding:2rem;text-align:center;color:var(--danger);border:1px solid var(--danger); border-radius: 8px;'>
                  <h2>Initialization Error</h2>
                  <p>Failed to initialize the schedule module.</p>
                  <p><small>Details: ${error.message}. Check console for more info.</small></p>
                  </div>`;
         }
         // Also use dashboard error message system if available
          if (typeof showErrorMessage === 'function') {
               showErrorMessage(`Schedule Init Error: ${error.message}`);
          }
    }
} // End of initialize function

// --- Execute Initialization ---
console.log("Calling internal initialize() function...");
initialize(); // Call the internal initialize function

console.log("--- employee-scheduling.html script tag finished parsing ---"); // Should still appear

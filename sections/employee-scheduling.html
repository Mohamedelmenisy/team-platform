<!-- Note: Removed DOCTYPE, html, head, body tags -->
<!-- Note: Removed <header> section as it's provided by dash.html -->

<!-- Styles specific to Employee Scheduling -->
<!-- Note: Removed :root and potentially conflicting global styles. -->
<!-- Consider scoping these styles further if needed (e.g., using a parent class) -->
<style>
    /* Styles specific to this section (employee schedule) */
    .employee-schedule-body { /* Use a more specific class or ID for the container if needed */
        /* background-color: var(--light); Applied by dash.html */
        /* color: var(--dark); Applied by dash.html */
        /* Add padding if needed, though dash.html's .content-section likely provides it */
    }

    /* Main Content Styling Adjustments */
    .employee-schedule-body .main-container {
        max-width: 100%; /* Take full width within the dashboard content area */
        margin: 0; /* Reset margin */
        padding: 0; /* Reset padding, rely on dash.html's .content-section */
    }

    .employee-schedule-body .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem; /* Adjusted margin */
        flex-wrap: wrap;
        gap: 1rem;
    }

    .employee-schedule-body .page-title {
        font-size: 1.5rem; /* Adjusted size */
        color: var(--primary-dark);
        font-weight: 600; /* Adjusted weight */
    }

     /* Container for header buttons */
     .employee-schedule-body .page-header > div {
         display: flex;
         gap: 0.75rem;
         flex-wrap: wrap; /* Allow buttons to wrap on small screens */
     }

    /* Schedule Controls */
    .employee-schedule-body .schedule-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        background-color: var(--white);
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .employee-schedule-body .week-navigation {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Adjusted gap */
    }

    .employee-schedule-body .week-display {
        font-weight: 600;
        min-width: 180px;
        text-align: center;
        color: var(--dark); /* Ensure text color matches theme */
    }

    /* Use button styles from main dashboard (.btn, .btn-primary, etc.) */
    /* No need to redefine .btn styles here if dash.html defines them globally */

    /* Schedule Table */
    .employee-schedule-body .schedule-container {
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow-x: auto; /* Enable horizontal scrolling for the table */
        border: 1px solid var(--light-gray); /* Add subtle border to container */
    }

    .employee-schedule-body .schedule-table {
        width: 100%;
        min-width: 700px; /* Minimum width before scrollbar appears */
        border-collapse: collapse; /* Use collapse for cleaner lines */
        /* border-spacing: 0; Removed */
        /* margin-top: 0px; */
    }

    .employee-schedule-body .schedule-table thead th {
        padding: 0.8rem 0.5rem; /* Adjusted padding */
        text-align: center;
        background-color: var(--primary); /* Use dashboard variable */
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0; /* Make header sticky */
        z-index: 10; /* Ensure header stays above content */
        border-bottom: 2px solid var(--primary-dark); /* Add bottom border */
        border-left: 1px solid var(--primary-light); /* Add subtle vertical separators */
    }
    .employee-schedule-body .schedule-table thead th:first-child {
        border-left: none; /* Remove left border on first header cell */
        min-width: 150px; /* Give employee name more space */
        text-align: left;
        padding-left: 1rem;
        position: sticky; /* Make employee header cell sticky too */
        left: 0;
        z-index: 11; /* Above other header cells */
         border-right: 1px solid var(--primary-dark); /* Separator line */
    }
    /* Add top borders to first row headers if radius needed on container instead */
    /* .employee-schedule-body .schedule-table thead tr:first-child th:first-child { border-top-left-radius: 8px; } */
    /* .employee-schedule-body .schedule-table thead tr:first-child th:last-child { border-top-right-radius: 8px; } */


    .employee-schedule-body .schedule-table tbody td {
        padding: 0.75rem 0.5rem; /* Adjusted padding */
        text-align: center;
        background-color: var(--white); /* Use variable */
        border-bottom: 1px solid var(--light-gray); /* Horizontal row separation */
        border-left: 1px solid var(--light-gray); /* Vertical cell separation */
        color: var(--dark); /* Ensure text color */
        vertical-align: middle; /* Align content vertically */
        height: 60px; /* Ensure consistent row height */
    }

    .employee-schedule-body .schedule-table tbody tr:last-child td {
        border-bottom: none; /* Remove bottom border for last row */
    }
     .employee-schedule-body .schedule-table tbody td:first-child {
        /* Styles for the sticky employee name cell */
        position: sticky;
        left: 0;
        background-color: var(--white); /* Match row background */
        border-right: 1px solid var(--dark-gray); /* Stronger separator */
        z-index: 5; /* Lower than header */
        font-weight: 500;
        text-align: left;
        padding-left: 1rem;
        white-space: nowrap;
        border-left: none; /* Remove default left border */
    }
     /* Add left/right borders to first/last cell - Handled by td style now */
     /* Round corners for first/last cell of last row */
     /* .employee-schedule-body .schedule-table tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; } */
     /* .employee-schedule-body .schedule-table tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; } */


    .employee-schedule-body .employee-name {
        /* Mostly handled by td:first-child styles now */
        /* font-weight: 500; Adjusted weight */
        /* text-align: left; */
        /* padding: 0.75rem 1rem; Adjusted padding */
        /* white-space: nowrap; */
    }

    /* Employee name colors - These can stay as they are specific */
    .employee-schedule-body .employee-1 { color: #3b82f6; }
    .employee-schedule-body .employee-2 { color: #10b981; }
    .employee-schedule-body .employee-3 { color: #8b5cf6; }
    .employee-schedule-body .employee-4 { color: #ec4899; }
    .employee-schedule-body .employee-5 { color: #f59e0b; }
    .employee-schedule-body .employee-6 { color: #14b8a6; }
    /* Add more as needed */

    /* Shift Styles */
    .employee-schedule-body .shift {
        padding: 0.3rem 0.6rem; /* Adjusted padding */
        border-radius: 4px;
        font-size: 0.8rem; /* Adjusted size */
        font-weight: 500;
        white-space: nowrap;
        display: inline-block; /* Ensure it takes space */
        margin-bottom: 0.25rem; /* Space between shift and edit link */
    }

    .employee-schedule-body .shift-morning { background-color: #dbeafe; color: #1e40af; }
    .employee-schedule-body .shift-afternoon { background-color: #e0f2fe; color: #0c4a6e; }
    .employee-schedule-body .shift-night { background-color: #ede9fe; color: #5b21b6; }
    .employee-schedule-body .day-off { background-color: #f0fdf4; color: #166534; }
    .employee-schedule-body .sick-leave { background-color: #fee2e2; color: #991b1b; }
    .employee-schedule-body .vacation { background-color: #ffedd5; color: #9a3412; }

    /* Compact day headers */
    .employee-schedule-body .day-header {
        display: flex;
        flex-direction: column;
        gap: 0.15rem; /* Adjusted gap */
        align-items: center; /* Center header content */
    }

    .employee-schedule-body .day-name {
        font-weight: 600;
        font-size: 0.85rem; /* Adjusted size */
    }

    .employee-schedule-body .day-date {
        font-size: 0.75rem; /* Adjusted size */
        opacity: 0.8; /* Adjusted opacity */
    }

    /* Modal Styles (Rely on dash.html modals if possible, otherwise prefix IDs) */
    /* Example prefixing: #schedule-employeeModal, #schedule-shiftModal */
    .employee-schedule-body .modal { /* If using separate modals */
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Darker backdrop */
        z-index: 1050; /* Ensure above dashboard content */
        justify-content: center;
        align-items: center;
        padding: 1rem; /* Add padding for smaller screens */
    }

    .employee-schedule-body .modal-content {
        background-color: var(--white);
        width: 90%;
        max-width: 500px; /* Slightly smaller max-width */
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        padding: 1.5rem; /* Adjusted padding */
        max-height: 90vh;
        overflow-y: auto;
         display: flex; /* Use flex for layout */
         flex-direction: column;
    }

    .employee-schedule-body .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem; /* Add padding */
        border-bottom: 1px solid var(--light-gray); /* Add separator */
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .employee-schedule-body .modal-title {
        font-size: 1.25rem; /* Adjusted size */
        font-weight: 600;
        color: var(--dark); /* Use theme color */
    }

    .employee-schedule-body .close-modal {
        background: none;
        border: none;
        font-size: 1.75rem; /* Larger close button */
        cursor: pointer;
        color: var(--gray);
        line-height: 1;
        padding: 0;
    }
     .employee-schedule-body .close-modal:hover {
         color: var(--dark);
     }

      .employee-schedule-body .modal-body {
         flex-grow: 1; /* Allow body to take up space */
         overflow-y: auto; /* Scroll only body if needed */
         /* padding removed, handled by modal-content */
      }

    .employee-schedule-body .form-group {
        margin-bottom: 1rem; /* Adjusted margin */
    }

    .employee-schedule-body .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--dark);
        font-size: 0.9rem; /* Smaller label */
    }

    .employee-schedule-body .form-control {
        width: 100%;
        padding: 0.6rem 0.75rem; /* Adjusted padding */
        border: 1px solid var(--light-gray);
        border-radius: 6px;
        font-size: 0.95rem; /* Adjusted size */
        background-color: var(--white); /* Theme support */
        color: var(--dark); /* Theme support */
        box-sizing: border-box; /* Include padding in width */
    }
    .employee-schedule-body .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 59, 130, 246), 0.2); /* Use RGB version if defined */
    }
     .employee-schedule-body .form-control[readonly] {
         background-color: var(--light-gray);
         cursor: not-allowed;
     }
     .employee-schedule-body textarea.form-control {
         min-height: 80px;
     }

    .employee-schedule-body .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem; /* Adjusted gap */
        margin-top: 1.5rem; /* Adjusted margin */
        padding-top: 1rem; /* Add padding */
        border-top: 1px solid var(--light-gray); /* Add separator */
        flex-shrink: 0; /* Prevent footer from shrinking */
    }

    /* Admin Controls within table cells */
    .employee-schedule-body .admin-controls {
        /* Padding/alignment handled by td */
        /* min-height: 50px; /* Set by TD style */
    }

    .employee-schedule-body .edit-shift {
        cursor: pointer;
        color: var(--primary);
        font-size: 0.75rem; /* Smaller edit text */
        display: none; /* Hide by default, shown on hover by JS if admin */
        margin-top: 0.25rem;
        opacity: 0.7;
        transition: opacity 0.2s;
        display: block; /* Make it block to appear below shift */
        text-align: center; /* Center align */
    }
     .employee-schedule-body .edit-shift:hover {
         opacity: 1;
         text-decoration: underline;
     }

    /* Show edit button on cell hover if admin */
    .employee-schedule-body td.admin-controls:hover .edit-shift.admin-visible {
        display: block; /* Use block display */
    }


    /* Confirmation Dialog (Rely on dash.html's #confirmModal) - No styles needed here */

    /* Responsive Design Adjustments */
    @media (max-width: 768px) {
        .employee-schedule-body .schedule-controls {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch; /* Stretch items */
        }
         .employee-schedule-body .week-navigation {
             justify-content: space-between; /* Space out nav buttons */
             width: 100%;
         }
         .employee-schedule-body .schedule-controls > .btn-primary {
             width: 100%; /* Full width save button */
             justify-content: center;
         }

        .employee-schedule-body .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem; /* Reduced gap */
            margin-bottom: 1.5rem;
        }
         .employee-schedule-body .page-header > div { /* Button container */
             width: 100%;
             display: flex;
             gap: 0.5rem;
         }
          .employee-schedule-body .page-header > div > .btn {
              flex-grow: 1; /* Make buttons share space */
              justify-content: center;
          }

        /* Mobile Table: Stack cells vertically */
        .employee-schedule-body .schedule-table thead {
            display: none; /* Hide header on mobile */
        }

        .employee-schedule-body .schedule-table tbody tr {
            display: block; /* Make rows stack */
            margin-bottom: 1rem; /* Space between employee blocks */
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .employee-schedule-body .schedule-table tbody td {
            display: block; /* Stack cells */
            width: 100%;
            text-align: right; /* Align content (shift) to the right */
            padding-left: 50%; /* Create space for label */
            position: relative;
            border-bottom: 1px dashed var(--light-gray); /* Lighter separator */
            border-left: none; /* Remove vertical table borders */
            height: auto; /* Reset height */
            min-height: 40px; /* Ensure minimum height */
            box-sizing: border-box;
        }
        .employee-schedule-body .schedule-table tbody tr td:last-child {
            border-bottom: none; /* Remove border on last cell of the block */
        }

        .employee-schedule-body .schedule-table tbody td::before {
            content: attr(data-label); /* Use data-label for day/date */
            position: absolute;
            left: 10px; /* Padding from left edge */
            width: calc(50% - 20px); /* Width of the label area */
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: bold;
            color: var(--gray);
            font-size: 0.8rem;
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust vertical centering */
        }

         /* Special handling for Employee Name cell */
         .employee-schedule-body .schedule-table tbody td:first-child {
             position: static; /* Unstick */
             display: block;
             width: 100%;
             background-color: var(--light); /* Different background */
             font-weight: 600;
             text-align: center; /* Center name */
             padding: 0.75rem 1rem; /* Adjust padding */
             border-bottom: 1px solid var(--dark-gray); /* Stronger separator */
             border-right: none; /* Remove right border */
             z-index: auto;
             white-space: normal;
         }
         .employee-schedule-body .schedule-table tbody td:first-child::before {
             content: none; /* Remove the "data-label" pseudo element */
         }

         /* Adjust admin controls for stacked view */
         .employee-schedule-body .admin-controls {
             /* TD styles handle most of it */
         }
         .employee-schedule-body .edit-shift {
             /* Edit link appears below shift */
             display: block; /* Ensure it's block */
             text-align: right; /* Align edit link to the right */
             padding-right: 10px; /* Add padding to align with shift */
             margin-top: 0; /* Reset margin */
              opacity: 1; /* Make it always visible on mobile? Or keep hover? */
         }
         /* Always show edit shift on mobile if admin */
         .employee-schedule-body .edit-shift.admin-visible {
             display: block; /* Override hover display */
         }

    }
    @media (max-width: 480px) {
         .employee-schedule-body .page-title {
             font-size: 1.3rem;
         }
         .employee-schedule-body .shift {
             font-size: 0.75rem;
             padding: 0.2rem 0.4rem;
         }
          .employee-schedule-body .edit-shift {
              font-size: 0.7rem;
          }
          .employee-schedule-body .modal-content {
              padding: 1rem;
          }
           .employee-schedule-body .form-actions {
               flex-direction: column;
               gap: 0.5rem;
           }
            .employee-schedule-body .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
         /* Further reduce label size on smallest screens */
         .employee-schedule-body .schedule-table tbody td::before {
             font-size: 0.75rem;
         }
    }
</style>

<!-- This container will be inserted into dash.html's #featureSections -->
<div class="employee-schedule-body">
    <!-- Main Content (Removed header) -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">Employee Schedule</h1>
            <div>
                <!-- Buttons might be controlled by dash.html permissions -->
                <button class="btn btn-primary" id="schedule-addEmployeeBtn" style="display: none;"> <!-- Prefixed ID, hidden initially -->
                    <i class="fas fa-plus"></i> Add Employee
                </button>
                <button class="btn btn-secondary" id="schedule-sendRemindersBtn" style="display: none; background-color: var(--secondary);"> <!-- Prefixed ID, hidden initially -->
                    <i class="fas fa-envelope"></i> Send Reminders
                </button>
            </div>
        </div>

        <!-- Schedule Controls -->
        <div class="schedule-controls">
            <div class="week-navigation">
                <button class="btn btn-outline" id="schedule-prevWeekBtn" title="Previous Week"> <!-- Prefixed ID -->
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="week-display" id="schedule-weekDisplay">Loading...</div> <!-- Prefixed ID -->
                <button class="btn btn-outline" id="schedule-nextWeekBtn" title="Next Week"> <!-- Prefixed ID -->
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="btn btn-primary" id="schedule-saveScheduleBtn" style="display: none;"> <!-- Prefixed ID, hidden initially -->
                <i class="fas fa-save"></i> Save Schedule
            </button>
        </div>

        <!-- Schedule Table -->
        <div class="schedule-container">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <!-- Headers will be populated by JS -->
                        <th>Employee</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                        <th>Sun</th>
                    </tr>
                </thead>
                <tbody id="schedule-table-body"> <!-- Added ID for JS targeting -->
                    <!-- Employee rows will be populated by JS -->
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">Loading schedule...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <!-- Consider using the main dashboard's modal system if possible -->
    <div class="modal" id="schedule-employeeModal"> <!-- Prefixed ID -->
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Employee</h2>
                <button class="close-modal" id="schedule-closeEmployeeModal" title="Close">×</button> <!-- Prefixed ID -->
            </div>
            <div class="modal-body">
                <form id="schedule-employeeForm"> <!-- Prefixed ID -->
                    <div class="form-group">
                        <label for="schedule-empName">Full Name</label>
                        <input type="text" id="schedule-empName" class="form-control" required> <!-- Prefixed ID -->
                    </div>
                    <div class="form-group">
                        <label for="schedule-empEmail">Email</label>
                        <input type="email" id="schedule-empEmail" class="form-control" required> <!-- Prefixed ID -->
                    </div>
                    <!-- Removed Position and Role as these might come from main user data -->
                    <!-- Hidden submit button to allow form submission via Enter key -->
                     <button type="submit" style="display: none;" aria-hidden="true"></button>
                </form>
            </div>
             <div class="form-actions">
                 <button type="button" class="btn btn-outline" id="schedule-cancelEmployeeBtn">Cancel</button> <!-- Prefixed ID -->
                 <!-- Link submit button to the form -->
                 <button type="submit" class="btn btn-primary" form="schedule-employeeForm">Add Employee</button>
             </div>
        </div>
    </div>

    <!-- Edit Shift Modal -->
    <div class="modal" id="schedule-shiftModal"> <!-- Prefixed ID -->
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Shift</h2>
                <button class="close-modal" id="schedule-closeShiftModal" title="Close">×</button> <!-- Prefixed ID -->
            </div>
            <div class="modal-body">
                <form id="schedule-shiftForm"> <!-- Prefixed ID -->
                    <input type="hidden" id="schedule-shiftEmpId"> <!-- Store employee ID -->
                    <input type="hidden" id="schedule-shiftDateKey"> <!-- Store date key -->
                    <div class="form-group">
                        <label for="schedule-shiftEmployee">Employee</label>
                        <input type="text" id="schedule-shiftEmployee" class="form-control" readonly> <!-- Prefixed ID -->
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftDate">Date</label>
                         <!-- Change type to text and display formatted date, store YYYY-MM-DD in hidden input or dataset -->
                        <input type="text" id="schedule-shiftDateDisplay" class="form-control" readonly>
                        <input type="date" id="schedule-shiftDate" class="form-control" required style="display:none;"> <!-- Keep for potential editing/validation, but hide -->
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftType">Shift Type</label>
                        <select id="schedule-shiftType" class="form-control" required> <!-- Prefixed ID -->
                            <option value="day-off">Day Off</option>
                            <option value="morning">Morning (9AM-5PM)</option>
                            <option value="afternoon">Afternoon (12PM-8PM)</option>
                            <option value="night">Night (5PM-1AM)</option>
                            <option value="sick-leave">Sick Leave</option>
                            <option value="vacation">Vacation</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group" id="schedule-customShiftGroup" style="display: none;"> <!-- Prefixed ID -->
                        <label for="schedule-customShift">Custom Shift Times</label>
                        <input type="text" id="schedule-customShift" class="form-control" placeholder="e.g., 10AM-6PM"> <!-- Prefixed ID -->
                    </div>
                    <div class="form-group">
                        <label for="schedule-shiftNotes">Notes (Optional)</label>
                        <textarea id="schedule-shiftNotes" class="form-control" rows="3"></textarea> <!-- Prefixed ID -->
                    </div>
                     <!-- Hidden submit button -->
                     <button type="submit" style="display: none;" aria-hidden="true"></button>
                </form>
            </div>
             <div class="form-actions">
                 <button type="button" class="btn btn-danger" id="schedule-deleteShiftBtn">Delete Shift</button> <!-- Prefixed ID -->
                 <button type="button" class="btn btn-outline" id="schedule-cancelShiftBtn">Cancel</button> <!-- Prefixed ID -->
                 <button type="submit" class="btn btn-primary" form="schedule-shiftForm">Save Changes</button>
             </div>
        </div>
    </div>

    <!-- Confirmation Dialog is expected to be provided by dash.html -->
    <!-- Example ID: #confirmModal -->

</div> <!-- End of .employee-schedule-body -->


<script>
    // Wrap all code in an initialization function
    // NOW ACCEPTS ARGUMENTS: dashboardCurrentUser, dashboardTeamMembers
    function initializeEmployeeSchedule(dashboardCurrentUser, dashboardTeamMembers) {
        console.log("Initializing Employee Schedule Section with passed data...");
        // console.log("Received User:", dashboardCurrentUser); // Log user data if needed
        // console.log("Received Team Members:", dashboardTeamMembers); // Log team data if needed

        const scheduleContainer = document.querySelector('.employee-schedule-body');
        if (!scheduleContainer) {
            console.error("Employee Schedule container not found!");
            return;
        }

        // --- DOM Elements ---
        const employeeModal = scheduleContainer.querySelector('#schedule-employeeModal');
        const shiftModal = scheduleContainer.querySelector('#schedule-shiftModal');
        // Use the main dashboard's confirmation modal (ensure these IDs match dash.html)
        const confirmationDialog = document.getElementById('confirmModal');
        const dialogTitle = document.getElementById('confirmTitle');
        const dialogMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');

        // Schedule specific elements
        const addEmployeeBtn = scheduleContainer.querySelector('#schedule-addEmployeeBtn');
        const sendRemindersBtn = scheduleContainer.querySelector('#schedule-sendRemindersBtn');
        const saveScheduleBtn = scheduleContainer.querySelector('#schedule-saveScheduleBtn');
        const closeEmployeeModal = scheduleContainer.querySelector('#schedule-closeEmployeeModal');
        const closeShiftModal = scheduleContainer.querySelector('#schedule-closeShiftModal');
        const cancelEmployeeBtn = scheduleContainer.querySelector('#schedule-cancelEmployeeBtn');
        const cancelShiftBtn = scheduleContainer.querySelector('#schedule-cancelShiftBtn');
        const employeeForm = scheduleContainer.querySelector('#schedule-employeeForm');
        const shiftForm = scheduleContainer.querySelector('#schedule-shiftForm');
        const shiftTypeSelect = scheduleContainer.querySelector('#schedule-shiftType');
        const customShiftGroup = scheduleContainer.querySelector('#schedule-customShiftGroup');
        const customShiftInput = scheduleContainer.querySelector('#schedule-customShift');
        const deleteShiftBtn = scheduleContainer.querySelector('#schedule-deleteShiftBtn');
        const prevWeekBtn = scheduleContainer.querySelector('#schedule-prevWeekBtn');
        const nextWeekBtn = scheduleContainer.querySelector('#schedule-nextWeekBtn');
        const weekDisplay = scheduleContainer.querySelector('#schedule-weekDisplay');
        const scheduleTableBody = scheduleContainer.querySelector('#schedule-table-body');
        const shiftEmployeeInput = scheduleContainer.querySelector('#schedule-shiftEmployee');
        const shiftDateInput = scheduleContainer.querySelector('#schedule-shiftDate'); // Hidden input YYYY-MM-DD
        const shiftDateDisplayInput = scheduleContainer.querySelector('#schedule-shiftDateDisplay'); // Visible input
        const shiftNotesInput = scheduleContainer.querySelector('#schedule-shiftNotes');
        // Hidden fields in shift modal form for easier access
        const shiftEmpIdInput = scheduleContainer.querySelector('#schedule-shiftEmpId');
        const shiftDateKeyInput = scheduleContainer.querySelector('#schedule-shiftDateKey');


        // --- State Variables ---
        // ** Use the passed arguments directly **
        let scheduleCurrentUser = dashboardCurrentUser || { role: 'employee', id: null, name: 'Guest' }; // Provide default structure
        // Ensure teamMembers is an array and deep copy it to avoid modifying original
        let scheduleEmployees = Array.isArray(dashboardTeamMembers)
                                ? JSON.parse(JSON.stringify(dashboardTeamMembers))
                                : [];
        let scheduleCurrentWeekStart = new Date(); // Will be adjusted in initialize()
        let scheduleSavedData = {}; // Loaded from localStorage
        let isAdminOrSupervisor = false; // Determined in initialize()

        const scheduleMinDate = new Date(2025, 4, 1); // May 1, 2025 (Month is 0-indexed)
        const scheduleMaxDate = new Date(2025, 4, 31); // May 31, 2025
        const localStorageKey = 'employeeSchedule_May2025'; // Specific key for this schedule period

        // --- Helper Functions ---

        function formatDateKey(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.error("Invalid date passed to formatDateKey:", date);
                try { // Attempt conversion if string
                    const d = new Date(date);
                    if (isNaN(d.getTime())) return null;
                    date = d;
                } catch (e) {
                    return null;
                }
            }
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getLocalDateFromKey(dateKey) {
            if (!dateKey || typeof dateKey !== 'string' || !dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) {
                 return null;
            }
             // Creates date object in local timezone corresponding to the key's date components
            const parts = dateKey.split('-');
            // Note: Month is 0-indexed in JS Date constructor
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }


        // Use main dashboard's confirmation modal system
        function showScheduleConfirmation(config) {
            // Check if main modal and its functions/elements exist
            if(confirmationDialog && typeof showConfirmModal === 'function' && typeof hideConfirmModal === 'function' && dialogTitle && dialogMessage && confirmBtn && cancelConfirmBtn) {
                 dialogTitle.textContent = config.title || 'Confirm';
                 dialogMessage.innerHTML = config.message || 'Are you sure?'; // Use innerHTML for potential bolding
                 confirmBtn.textContent = config.confirmText || 'Confirm';
                 cancelConfirmBtn.textContent = config.cancelText || 'Cancel';
                 // Set button classes using main dashboard's scheme (adjust if needed)
                 confirmBtn.className = `btn ${config.confirmClass || 'btn-danger'}`; // Default danger for confirmations
                 cancelConfirmBtn.className = 'btn btn-outline'; // Default outline for cancel

                 // Assign temporary handlers
                 const confirmHandler = () => {
                     hideConfirmModal(); // Assumes this function exists in dash.html
                     confirmBtn.removeEventListener('click', confirmHandler); // Clean up listener
                     cancelConfirmBtn.removeEventListener('click', cancelHandler); // Clean up listener
                     if (config.onConfirm) config.onConfirm();
                 };
                 const cancelHandler = () => {
                     hideConfirmModal(); // Assumes this function exists in dash.html
                     confirmBtn.removeEventListener('click', confirmHandler); // Clean up listener
                     cancelConfirmBtn.removeEventListener('click', cancelHandler); // Clean up listener
                      if (config.onCancel) config.onCancel();
                 };

                 confirmBtn.addEventListener('click', confirmHandler);
                 cancelConfirmBtn.addEventListener('click', cancelHandler);

                 // Show the main modal using its own function from dash.html
                 showConfirmModal(); // Assumes this function exists
            } else {
                 // Fallback to simple browser confirm if main modal system isn't available
                 console.warn("Main dashboard confirmation modal system not found or incomplete. Using browser confirm().");
                 if (confirm(`${config.title}\n${config.message.replace(/<[^>]*>/g, '')}`)) { // Strip HTML for basic confirm
                     if (config.onConfirm) config.onConfirm();
                 } else {
                     if (config.onCancel) config.onCancel();
                 }
            }
        }

        // Use main dashboard's success/error message system if available
        function showScheduleSuccess(message) {
            if (typeof showSuccessMessage === 'function') {
                showSuccessMessage(message);
            } else {
                console.log("Success:", message); // Log as fallback
                // alert(message); // Avoid disruptive alerts if possible
            }
        }
        function showScheduleError(message) {
             if (typeof showErrorMessage === 'function') {
                 showErrorMessage(message);
             } else {
                  console.error("Error:", message); // Log as fallback
                 // alert(`Error: ${message}`); // Avoid disruptive alerts
             }
        }

        // --- UI Update Functions ---

        function updateWeekDisplayUI() {
            const weekEnd = new Date(scheduleCurrentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            const options = { month: 'short', day: 'numeric' };
            const startStr = scheduleCurrentWeekStart.toLocaleDateString('en-US', options);
            const endStr = weekEnd.toLocaleDateString('en-US', options);
            const year = scheduleCurrentWeekStart.getFullYear();

            weekDisplay.textContent = `${startStr} - ${endStr}, ${year}`;

            // Update table headers
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const headerRow = scheduleContainer.querySelector('.schedule-table thead tr');
            if (!headerRow) { console.error("Schedule header row not found!"); return; }
            headerRow.innerHTML = '<th>Employee</th>'; // Clear existing day headers

            const tempDate = new Date(scheduleCurrentWeekStart);
            days.forEach(dayName => {
                const th = document.createElement('th');
                const dateStr = tempDate.toLocaleDateString('en-US', { day: 'numeric' });
                const monthStr = tempDate.toLocaleDateString('en-US', { month: 'short' });
                th.innerHTML = `
                    <div class="day-header">
                        <span class="day-name">${dayName}</span>
                        <span class="day-date">${monthStr} ${dateStr}</span>
                    </div>
                `;
                headerRow.appendChild(th);
                tempDate.setDate(tempDate.getDate() + 1);
            });

            // Enable/disable navigation buttons based on min/max dates
            const prevWeekTest = new Date(scheduleCurrentWeekStart);
            prevWeekTest.setDate(prevWeekTest.getDate() - 1); // Test end of previous week
            prevWeekBtn.disabled = prevWeekTest < scheduleMinDate;

            const nextWeekTest = new Date(scheduleCurrentWeekStart);
            nextWeekTest.setDate(nextWeekTest.getDate() + 7); // Test start of next week
            nextWeekBtn.disabled = nextWeekTest > scheduleMaxDate;
        }

        function renderScheduleTable() {
            if (!scheduleTableBody) { console.error("scheduleTableBody not found!"); return; }
            scheduleTableBody.innerHTML = ''; // Clear existing rows

            console.log("Rendering table with employees:", scheduleEmployees.length);

            if (!Array.isArray(scheduleEmployees) || scheduleEmployees.length === 0) {
                 scheduleTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray);">No employees found. Please add employees via Team Management.</td></tr>`;
                 return;
            }

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            scheduleEmployees.forEach((employee, index) => {
                 // Basic validation for employee data
                 if (!employee || typeof employee !== 'object' || !employee.id || !employee.name) {
                    console.warn("Skipping rendering of invalid employee data:", employee);
                    return;
                 }

                const tr = document.createElement('tr');
                // Add employee ID to row for potential easier selection later if needed
                tr.dataset.empId = employee.id;

                // Employee Name Cell (Sticky)
                const nameTd = document.createElement('td');
                nameTd.className = `employee-name employee-${(index % 6) + 1}`; // Cycle through 6 colors
                nameTd.textContent = employee.name;
                tr.appendChild(nameTd);

                const tempDate = new Date(scheduleCurrentWeekStart);
                days.forEach((day, dayIndex) => {
                    const td = document.createElement('td');
                    td.classList.add('admin-controls'); // Add class for hover effect
                    const dateKey = formatDateKey(tempDate);

                    if (!dateKey) {
                         console.error("Failed to generate dateKey for date:", tempDate);
                         td.innerHTML = '<span style="color:red;">Error</span>'; // Indicate error in cell
                         tr.appendChild(td);
                         tempDate.setDate(tempDate.getDate() + 1);
                         return; // Skip processing for this cell
                    }

                     // For mobile view label
                    const mobileLabel = `${days[dayIndex]} (${tempDate.toLocaleDateString('en-us', {month:'short', day:'numeric'})})`;
                    td.dataset.label = mobileLabel;
                    td.dataset.dateKey = dateKey; // Store date key on cell for easier access

                    const empKey = `emp-${employee.id}`;
                    const shiftData = scheduleSavedData[empKey]?.[dateKey];

                    // Create shift div if data exists
                    if (shiftData && shiftData.text && shiftData.class) {
                        const shiftDiv = document.createElement('div');
                        shiftDiv.className = `shift ${shiftData.class}`;
                        shiftDiv.textContent = shiftData.text;
                        shiftDiv.title = shiftData.notes || `Shift: ${shiftData.text}`; // Add notes or text as tooltip
                        td.appendChild(shiftDiv);
                    }

                    // Add edit span (button) only if admin/supervisor
                    if (isAdminOrSupervisor) {
                        const editSpan = document.createElement('span');
                        editSpan.className = 'edit-shift admin-visible'; // Class controls visibility via CSS hover
                        editSpan.dataset.empId = employee.id;
                        editSpan.dataset.dayIndex = dayIndex; // Index relative to week start (0=Mon)
                        editSpan.dataset.dateKey = dateKey; // Include date key for handler
                        editSpan.textContent = shiftData ? '(edit)' : '(add)'; // Change text based on existing shift
                        editSpan.setAttribute('role', 'button'); // Accessibility
                        editSpan.setAttribute('tabindex', '0'); // Make focusable
                        editSpan.onclick = handleEditShiftClick; // Attach listener directly
                         editSpan.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') handleEditShiftClick(e); }; // Keyboard activation
                        td.appendChild(editSpan);
                    }

                    tr.appendChild(td);
                    tempDate.setDate(tempDate.getDate() + 1); // Move to next day
                });
                scheduleTableBody.appendChild(tr);
            });
        }

        // Updates a single cell's shift display after save/delete
        function updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes = '') {
             const cellSelector = `tr[data-emp-id="${empId}"] td[data-date-key="${dateKey}"]`;
             const shiftCell = scheduleTableBody.querySelector(cellSelector);

             if (!shiftCell) {
                 console.warn(`Shift cell not found in UI for emp ${empId}, date ${dateKey}. Might be off-screen week.`);
                 return;
             }

             // Find or create the edit span
             let editSpan = shiftCell.querySelector('.edit-shift');
              const shiftDataExists = shiftText && shiftClass;

             // Remove existing shift div
             const existingShift = shiftCell.querySelector('.shift');
             if (existingShift) {
                 existingShift.remove();
             }

             // Add new shift div if text/class provided
             if (shiftDataExists) {
                 const shiftDiv = document.createElement('div');
                 shiftDiv.className = `shift ${shiftClass}`;
                 shiftDiv.textContent = shiftText;
                 shiftDiv.title = notes || `Shift: ${shiftText}`;
                 // Insert shift div *before* the edit span if it exists, otherwise just append
                 if (editSpan) {
                     shiftCell.insertBefore(shiftDiv, editSpan);
                 } else {
                     shiftCell.appendChild(shiftDiv);
                 }
             }

              // Update edit span text if it exists
              if (editSpan) {
                 editSpan.textContent = shiftDataExists ? '(edit)' : '(add)';
              }
        }

        // Re-renders the table for the currently selected week
        function loadShiftsForCurrentWeekUI() {
            console.log("Loading shifts for week starting:", scheduleCurrentWeekStart.toDateString());
            renderScheduleTable();
        }

        // --- Event Handlers ---

        function handleWeekChange(direction) {
             const newWeekStart = new Date(scheduleCurrentWeekStart);
             newWeekStart.setDate(newWeekStart.getDate() + (direction * 7));

             // Prevent going out of bounds (check start date of the target week)
             if (newWeekStart < scheduleMinDate || newWeekStart > scheduleMaxDate) {
                 console.log("Navigation blocked: Target week start date is outside allowed range.");
                 // Optionally provide user feedback (e.g., disable button visually)
                 return;
             }

             scheduleCurrentWeekStart = newWeekStart;
             updateWeekDisplayUI();
             loadShiftsForCurrentWeekUI();
        }

        function handleAddEmployeeClick() {
            if (!employeeModal || !employeeForm) return;
            employeeForm.reset();
            // Clear any previous validation states if applicable
            employeeModal.style.display = 'flex';
            scheduleContainer.querySelector('#schedule-empName').focus(); // Focus first field
        }

        function handleSendRemindersClick() {
             const weekText = weekDisplay.textContent;
             const subject = encodeURIComponent(`Upcoming Work Schedule Reminder: ${weekText}`);
             let body = `Hi Team,\n\nThis is a reminder of your work schedule for the week of ${weekText}.\n\n`;

             // --- Example: Include individual schedules (Optional, can be complex) ---
             body += "Your schedule details:\n";
             scheduleEmployees.forEach(emp => {
                body += `\n${emp.name}:\n`;
                let hasShifts = false;
                const tempDate = new Date(scheduleCurrentWeekStart);
                for (let i = 0; i < 7; i++) {
                    const dateKey = formatDateKey(tempDate);
                    const empKey = `emp-${emp.id}`;
                    const shiftData = scheduleSavedData[empKey]?.[dateKey];
                    if (shiftData && shiftData.type !== 'day-off') {
                         const dayName = tempDate.toLocaleDateString('en-US', { weekday: 'short' });
                         const dateNum = tempDate.getDate();
                         body += `  ${dayName} ${dateNum}: ${shiftData.text}\n`;
                         hasShifts = true;
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                if (!hasShifts) {
                    body += "  (No shifts scheduled this week)\n";
                }
             });
             // --- End Optional Section ---

             body += `\nPlease review your shifts. Contact management if you have any questions or conflicts.\n\nBest regards,\nManagement`;
             const encodedBody = encodeURIComponent(body);

             let emails = scheduleEmployees.map(e => e.email).filter(Boolean).join(',');

             if (emails) {
                 const mailtoLink = `mailto:${emails}?subject=${subject}&body=${encodedBody}`;
                  const MAX_MAILTO_LEN = 2000; // Common limit, but varies

                 if (mailtoLink.length > MAX_MAILTO_LEN) {
                    // Option 1: Warn user
                    showScheduleConfirmation({
                        title: "Too Many Recipients/Data",
                        message: `The generated email link might be too long (${mailtoLink.length} chars) for your email client. Sending reminders individually or reducing included details might be necessary.`,
                        confirmText: "Try Anyway",
                        confirmClass: "btn-warning",
                        cancelText: "Cancel",
                        onConfirm: () => tryOpenMailto(mailtoLink)
                    });
                    // Option 2: Generate multiple links (more complex)
                    // Option 3: Use a backend service to send emails
                    return;
                 }
                 tryOpenMailto(mailtoLink); // Try opening the link
             } else {
                  showScheduleError("No employee emails found to send reminders.");
             }
        }

        function tryOpenMailto(mailtoLink) {
            try {
                const newWindow = window.open(mailtoLink, '_blank');
                // Simple check if window failed to open (often due to popup blockers)
                if(!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                     // Might indicate popup blocker or other issue
                    showScheduleConfirmation({
                         title: "Open Email Client?",
                         message: "Could not automatically open your email client. This might be due to browser settings or popup blockers. Please check your settings.",
                         confirmText: "OK",
                         confirmClass: "btn-warning",
                         // Hide cancel button if only OK is needed
                         cancelText: "" // Hide cancel button
                    });
                 } else {
                     showScheduleSuccess("Attempting to open email client with reminders...");
                 }
            } catch (e) {
                 console.error("Error opening mailto link:", e);
                 showScheduleError("An error occurred while trying to open your email client.");
            }
        }


        function handleSaveScheduleClick() {
            // Data is saved on each shift edit via localStorage using localStorageKey
            localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData));
            showScheduleSuccess("Schedule changes saved successfully.");
            // Optional: Add visual feedback like button disabling/enabling
        }

        function handleEmployeeFormSubmit(e) {
            e.preventDefault();
            if (!employeeModal || !employeeForm) return;

            const nameInput = scheduleContainer.querySelector('#schedule-empName');
            const emailInput = scheduleContainer.querySelector('#schedule-empEmail');
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();

             // Basic validation
             if (!name || !email || !/^\S+@\S+\.\S+$/.test(email)) { // Simple email format check
                 showScheduleError("Please enter a valid name and email address.");
                 return;
             }

            // IMPORTANT: In a real app, this should interact with a backend or
            // the main dashboard's data management system to add the employee persistently.
            // This implementation only adds to the local view for this session.
            const newEmployee = {
                // Generate a temporary ID (negative to avoid collisions with real IDs?)
                id: -Math.floor(Math.random() * 1000000),
                name: name,
                email: email,
                role: 'employee' // Default role, adjust if needed
                // Add other necessary fields matching the main teamMembers structure
            };

            // Add to the local array for immediate display
            scheduleEmployees.push(newEmployee);

            // Re-render the table to show the new employee
            loadShiftsForCurrentWeekUI();

            employeeModal.style.display = 'none';
            showScheduleSuccess(`Employee ${name} added to the schedule view (Temporary). Please use Team Management for permanent additions.`);

             // Optional: Update the main dashboard's teamMembers if possible
             // if (typeof teamMembers !== 'undefined' && Array.isArray(teamMembers)) {
             //     teamMembers.push(newEmployee); // Reflect change globally (might need deep copy)
             //     if(typeof saveData === 'function') saveData(); // Trigger global save if exists
             // }
        }

        function handleEditShiftClick(event) {
             // Use currentTarget if listener is on parent, or target if directly on span
             const target = event.currentTarget || event.target;
             const empId = parseInt(target.dataset.empId);
             const dateKey = target.dataset.dateKey;

             if (!empId || !dateKey || !shiftModal || !shiftForm) {
                 console.error("Missing data or modal elements for edit shift.", { empId, dateKey, shiftModal, shiftForm });
                 showScheduleError("Could not open shift editor. Data missing.");
                 return;
             }

             const employee = scheduleEmployees.find(e => e.id === empId);
             const shiftDate = getLocalDateFromKey(dateKey); // Get Date object from key

             if (!employee || !shiftDate) {
                 console.error("Could not find employee or parse date for edit.", { empId, dateKey });
                 showScheduleError("Could not open shift editor. Invalid employee or date.");
                 return;
             }

            // --- Populate Modal ---
            shiftForm.reset(); // Clear previous values

            shiftEmpIdInput.value = empId; // Store ID in hidden input
            shiftDateKeyInput.value = dateKey; // Store date key in hidden input
            // Use dataset as fallback or primary store as well
            shiftForm.dataset.empId = empId;
            shiftForm.dataset.dateKey = dateKey;

            shiftEmployeeInput.value = employee.name;
             // Display formatted date, store YYYY-MM-DD in hidden input
            shiftDateDisplayInput.value = shiftDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            shiftDateInput.value = dateKey; // Keep hidden input updated
             // Set min/max on hidden date input for potential future use/validation
             shiftDateInput.min = formatDateKey(scheduleMinDate);
             shiftDateInput.max = formatDateKey(scheduleMaxDate);


            // Load existing data for this shift
            const empKey = `emp-${empId}`;
            const savedShift = scheduleSavedData[empKey]?.[dateKey];

            if (savedShift) {
                shiftTypeSelect.value = savedShift.type || 'day-off'; // Default if type missing
                customShiftInput.value = savedShift.type === 'custom' ? savedShift.text : '';
                shiftNotesInput.value = savedShift.notes || '';
            } else {
                // Defaults for adding a new shift
                shiftTypeSelect.value = 'day-off'; // Default to Day Off
                customShiftInput.value = '';
                shiftNotesInput.value = '';
            }

             // Trigger change event on select to show/hide custom input correctly
            shiftTypeSelect.dispatchEvent(new Event('change'));

            shiftModal.style.display = 'flex';
             shiftTypeSelect.focus(); // Focus the type dropdown
        }

        function handleShiftFormSubmit(e) {
            e.preventDefault();
            if (!shiftModal || !shiftForm) return;

            // Get data from hidden inputs or dataset
            const empId = parseInt(shiftEmpIdInput.value || shiftForm.dataset.empId);
            const dateKey = shiftDateKeyInput.value || shiftForm.dataset.dateKey;

            const employee = scheduleEmployees.find(e => e.id === empId);

            if (!employee || !dateKey) {
                console.error("Missing employee ID or date key on shift form submission.", { empId, dateKey });
                showScheduleError("Error saving shift: Invalid data.");
                shiftModal.style.display = 'none';
                return;
            }

            const shiftTypeValue = shiftTypeSelect.value;
            const customShiftText = customShiftInput.value.trim();
            const notes = shiftNotesInput.value.trim();

            let shiftText = '';
            let shiftClass = '';

            // Determine shift text and class based on selected type
             switch(shiftTypeValue) {
                 case 'morning': shiftText = '9AM-5PM'; shiftClass = 'shift-morning'; break;
                 case 'afternoon': shiftText = '12PM-8PM'; shiftClass = 'shift-afternoon'; break;
                 case 'night': shiftText = '5PM-1AM'; shiftClass = 'shift-night'; break;
                 case 'day-off': shiftText = 'OFF'; shiftClass = 'day-off'; break;
                 case 'sick-leave': shiftText = 'SICK'; shiftClass = 'sick-leave'; break;
                 case 'vacation': shiftText = 'VAC'; shiftClass = 'vacation'; break;
                 case 'custom':
                     if (!customShiftText) {
                         showScheduleError('Please enter the custom shift times.');
                         customShiftInput.focus();
                         return; // Stop submission
                     }
                     shiftText = customShiftText;
                     // Use a consistent class for custom or a specific one if styled
                     shiftClass = 'shift-morning'; // Example: Use morning style as base
                     break;
                 default:
                     console.warn("Unknown shift type selected:", shiftTypeValue);
                     showScheduleError("Invalid shift type selected.");
                      shiftModal.style.display = 'none';
                     return; // Don't save unknown type
            }

            // --- Save Data ---
            const empKey = `emp-${empId}`;
            if (!scheduleSavedData[empKey]) {
                scheduleSavedData[empKey] = {};
            }
             const shiftData = {
                type: shiftTypeValue,
                text: shiftText,
                class: shiftClass,
                notes: notes
            };

             // Store in memory
            scheduleSavedData[empKey][dateKey] = shiftData;

             // Persist to localStorage immediately
             localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData));

            // --- Update UI ---
            updateShiftDisplayUI(empId, dateKey, shiftText, shiftClass, notes);

            shiftModal.style.display = 'none';
            const displayDate = getLocalDateFromKey(dateKey);
            showScheduleSuccess(`Shift updated for ${employee.name} on ${displayDate.toLocaleDateString()}.`);
        }


        function handleDeleteShiftClick() {
            if (!shiftModal || !shiftForm) return;

            // Get data from hidden inputs or dataset
            const empId = parseInt(shiftEmpIdInput.value || shiftForm.dataset.empId);
            const dateKey = shiftDateKeyInput.value || shiftForm.dataset.dateKey;

            const employee = scheduleEmployees.find(e => e.id === empId);
            const displayDate = getLocalDateFromKey(dateKey);

            if (!employee || !displayDate || !dateKey) {
                console.error("Missing employee ID or date key for delete.", { empId, dateKey });
                 showScheduleError("Could not delete shift: Invalid data.");
                shiftModal.style.display = 'none';
                return;
            }

            const formattedDate = displayDate.toLocaleDateString();

            // Confirm deletion
            showScheduleConfirmation({
                title: 'Delete Shift?',
                message: `Are you sure you want to delete the shift for <strong>${employee.name}</strong> on ${formattedDate}? This cannot be undone.`,
                confirmText: 'Delete Shift',
                confirmClass: 'btn-danger', // Use danger style for delete confirmation
                onConfirm: () => {
                    const empKey = `emp-${empId}`;
                    let deleted = false;
                    if (scheduleSavedData[empKey] && scheduleSavedData[empKey][dateKey]) {
                        delete scheduleSavedData[empKey][dateKey]; // Remove from memory
                        // If employee has no more shifts for this month, maybe remove the empKey? (optional)
                        // if (Object.keys(scheduleSavedData[empKey]).length === 0) {
                        //     delete scheduleSavedData[empKey];
                        // }
                        deleted = true;
                    }

                    if (deleted) {
                         // Persist deletion to localStorage
                         localStorage.setItem(localStorageKey, JSON.stringify(scheduleSavedData));

                         // Update the UI (remove the shift div visually)
                         updateShiftDisplayUI(empId, dateKey, '', '', ''); // Pass empty values

                         showScheduleSuccess(`Shift deleted for ${employee.name} on ${formattedDate}.`);
                    } else {
                         showScheduleSuccess(`No shift found to delete for ${employee.name} on ${formattedDate}.`);
                    }

                    shiftModal.style.display = 'none'; // Close modal after action
                    // Confirmation modal is hidden by the showScheduleConfirmation handler
                }
                // onCancel is handled implicitly by the confirmation modal closing
            });
        }

        // --- Event Listener Setup ---
        function setupScheduleEventListeners() {
            console.log("Setting up schedule event listeners...");

            // Week Navigation (check if elements exist)
            if(prevWeekBtn) prevWeekBtn.addEventListener('click', () => handleWeekChange(-1));
            if(nextWeekBtn) nextWeekBtn.addEventListener('click', () => handleWeekChange(1));

            // Admin Buttons (visibility and listeners based on role)
            if (isAdminOrSupervisor) {
                if(addEmployeeBtn) {
                    addEmployeeBtn.style.display = 'inline-flex'; // Show button
                    addEmployeeBtn.addEventListener('click', handleAddEmployeeClick);
                }
                 if(sendRemindersBtn) {
                    sendRemindersBtn.style.display = 'inline-flex'; // Show button
                    sendRemindersBtn.addEventListener('click', handleSendRemindersClick);
                }
                 if(saveScheduleBtn) {
                    saveScheduleBtn.style.display = 'inline-flex'; // Show button
                    saveScheduleBtn.addEventListener('click', handleSaveScheduleClick);
                 }
                 // Edit shift listeners are added dynamically in renderScheduleTable
            } else {
                // Ensure buttons are hidden if not admin/supervisor
                if(addEmployeeBtn) addEmployeeBtn.style.display = 'none';
                if(sendRemindersBtn) sendRemindersBtn.style.display = 'none';
                if(saveScheduleBtn) saveScheduleBtn.style.display = 'none';
            }


            // --- Modals ---
            // Employee Modal
            if (employeeModal) {
                if(closeEmployeeModal) closeEmployeeModal.addEventListener('click', () => employeeModal.style.display = 'none');
                if(cancelEmployeeBtn) cancelEmployeeBtn.addEventListener('click', () => employeeModal.style.display = 'none');
                if(employeeForm) employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
                // Close on backdrop click
                employeeModal.addEventListener('click', (event) => {
                    if (event.target === employeeModal) employeeModal.style.display = 'none';
                });
            } else { console.warn("Employee Modal not found"); }

            // Shift Modal
             if (shiftModal) {
                 if(closeShiftModal) closeShiftModal.addEventListener('click', () => shiftModal.style.display = 'none');
                 if(cancelShiftBtn) cancelShiftBtn.addEventListener('click', () => shiftModal.style.display = 'none');
                 if(shiftForm) shiftForm.addEventListener('submit', handleShiftFormSubmit);
                 if(deleteShiftBtn) deleteShiftBtn.addEventListener('click', handleDeleteShiftClick);
                 // Show/hide custom shift input based on select change
                 if(shiftTypeSelect) shiftTypeSelect.addEventListener('change', function() {
                     const isCustom = this.value === 'custom';
                     if(customShiftGroup) customShiftGroup.style.display = isCustom ? 'block' : 'none';
                     if(customShiftInput) {
                          customShiftInput.required = isCustom; // Set required attribute
                          if(isCustom) customShiftInput.focus(); // Focus input when shown
                     }
                 });
                 // Close on backdrop click
                 shiftModal.addEventListener('click', (event) => {
                     if (event.target === shiftModal) shiftModal.style.display = 'none';
                 });
             } else { console.warn("Shift Modal not found"); }

             // Note: Escape key listener is likely handled by dash.html globally for modals

            console.log("Schedule event listeners attached.");
        }


        // --- Main Initialization Logic for this Section ---
        function initialize() {
            try {
                console.log("Running Employee Schedule Initialization...");

                // 1. Determine User Role
                isAdminOrSupervisor = scheduleCurrentUser.role === 'admin' || scheduleCurrentUser.role === 'supervisor';
                console.log(`User Role: ${scheduleCurrentUser.role}, IsAdminOrSupervisor: ${isAdminOrSupervisor}`);

                 // 2. Validate Employee Data (basic check)
                 if (!Array.isArray(scheduleEmployees)) {
                     console.error("Passed teamMembers data is not an array!");
                     scheduleEmployees = []; // Reset to empty array
                     showScheduleError("Failed to load employee data.");
                 }
                 // Filter out any invalid employee entries before proceeding
                 scheduleEmployees = scheduleEmployees.filter(emp => emp && emp.id && emp.name);


                // 3. Load saved schedule data from localStorage
                const savedDataString = localStorage.getItem(localStorageKey);
                if (savedDataString) {
                    try {
                        scheduleSavedData = JSON.parse(savedDataString);
                         // Basic validation of loaded data structure (optional)
                         if (typeof scheduleSavedData !== 'object' || scheduleSavedData === null) {
                             console.warn("Invalid data format in localStorage, resetting.");
                             scheduleSavedData = {};
                         }
                        console.log(`Loaded saved schedule data from ${localStorageKey}.`);
                    } catch (e) {
                        console.error(`Error parsing schedule data from localStorage (${localStorageKey}):`, e);
                        scheduleSavedData = {}; // Reset if parsing fails
                        showScheduleError("Could not load previously saved schedule data.");
                    }
                } else {
                    console.log(`No saved schedule data found for key ${localStorageKey}. Starting fresh.`);
                    scheduleSavedData = {};
                }

                // 4. Set initial week (Clamped to May 2025)
                const today = new Date();
                // Calculate the Monday of the current week
                const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
                let potentialWeekStart = new Date(today.getFullYear(), today.getMonth(), diff);

                 // Clamp to the allowed month (May 2025)
                 if (potentialWeekStart < scheduleMinDate) {
                     // If current week is before May, start at the first week of May
                     let may1st = new Date(scheduleMinDate);
                     let may1stDay = may1st.getDay();
                     let may1stDiff = may1st.getDate() - may1stDay + (may1stDay === 0 ? -6 : 1);
                     scheduleCurrentWeekStart = new Date(may1st.getFullYear(), may1st.getMonth(), may1stDiff);
                      // Ensure calculated start isn't before May 1st if May 1st isn't a Monday
                      if (scheduleCurrentWeekStart < scheduleMinDate) {
                          scheduleCurrentWeekStart.setDate(scheduleCurrentWeekStart.getDate() + 7);
                      }
                 } else if (potentialWeekStart > scheduleMaxDate) {
                     // If current week is after May, start at the last week containing May dates
                     let may31st = new Date(scheduleMaxDate);
                     let may31stDay = may31st.getDay();
                     let may31stDiff = may31st.getDate() - may31stDay + (may31stDay === 0 ? -6 : 1);
                     scheduleCurrentWeekStart = new Date(may31st.getFullYear(), may31st.getMonth(), may31stDiff);
                 } else {
                     // Current week is within May
                     scheduleCurrentWeekStart = potentialWeekStart;
                 }
                console.log("Initial week start date set to:", scheduleCurrentWeekStart.toDateString());


                // 5. Initial UI setup
                updateWeekDisplayUI();
                loadShiftsForCurrentWeekUI(); // This calls renderScheduleTable
                setupScheduleEventListeners();

                console.log("Employee Schedule Section Initialized Successfully.");

            } catch (error) {
                 console.error("FATAL ERROR during employee schedule initialization:", error);
                 // Display error message within the schedule section container
                 if(scheduleContainer) {
                      scheduleContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger); border: 1px solid var(--danger); border-radius: 8px;">
                          <h2>Error Initializing Schedule</h2>
                          <p>Could not load the employee schedule section. Please try refreshing the page or contact support.</p>
                          <p><small>Error details logged to console.</small></p>
                          </div>`;
                 }
            }
        }

        // --- Execute Initialization ---
        initialize();

    } // End of initializeEmployeeSchedule function
</script>
